import"./modulepreload-polyfill.c7c6310f.js";import{V as D,P,S as W,C as T,ah as O,D as G,E as L,ai as A,aj as j,ak as k,W as q}from"./three.module.8e9ca1de.js";import{O as E}from"./OrbitControls.8141c166.js";import{S as H}from"./stats.module.9f3638b7.js";async function F(){if(!("Ammo"in window)){console.error("AmmoPhysics: Couldn't find Ammo.js");return}const t=await Ammo(),d=60,o=new t.btDefaultCollisionConfiguration,i=new t.btCollisionDispatcher(o),h=new t.btDbvtBroadphase,M=new t.btSequentialImpulseConstraintSolver,m=new t.btDiscreteDynamicsWorld(i,h,M,o);m.setGravity(new t.btVector3(0,-9.8,0));const c=new t.btTransform;function y(n){const e=n.parameters;if(n.type==="BoxGeometry"){const a=e.width!==void 0?e.width/2:.5,r=e.height!==void 0?e.height/2:.5,s=e.depth!==void 0?e.depth/2:.5,l=new t.btBoxShape(new t.btVector3(a,r,s));return l.setMargin(.05),l}else if(n.type==="SphereGeometry"||n.type==="IcosahedronGeometry"){const a=e.radius!==void 0?e.radius:1,r=new t.btSphereShape(a);return r.setMargin(.05),r}return null}const f=[],u=new WeakMap;function I(n){n.traverse(function(e){if(e.isMesh){const a=e.userData.physics;a&&b(e,a.mass)}})}function b(n,e=0){const a=y(n.geometry);a!==null&&(n.isInstancedMesh?p(n,e,a):n.isMesh&&z(n,e,a))}function z(n,e,a){const r=n.position,s=n.quaternion,l=new t.btTransform;l.setIdentity(),l.setOrigin(new t.btVector3(r.x,r.y,r.z)),l.setRotation(new t.btQuaternion(s.x,s.y,s.z,s.w));const S=new t.btDefaultMotionState(l),w=new t.btVector3(0,0,0);a.calculateLocalInertia(e,w);const g=new t.btRigidBodyConstructionInfo(e,S,a,w),v=new t.btRigidBody(g);m.addRigidBody(v),e>0&&(f.push(n),u.set(n,v))}function p(n,e,a){const r=n.instanceMatrix.array,s=[];for(let l=0;l<n.count;l++){const S=l*16,w=new t.btTransform;w.setFromOpenGLMatrix(r.slice(S,S+16));const g=new t.btDefaultMotionState(w),v=new t.btVector3(0,0,0);a.calculateLocalInertia(e,v);const R=new t.btRigidBodyConstructionInfo(e,g,a,v),B=new t.btRigidBody(R);m.addRigidBody(B),s.push(B)}e>0&&(f.push(n),u.set(n,s))}function C(n,e,a=0){if(n.isInstancedMesh){const s=u.get(n)[a];s.setAngularVelocity(new t.btVector3(0,0,0)),s.setLinearVelocity(new t.btVector3(0,0,0)),c.setIdentity(),c.setOrigin(new t.btVector3(e.x,e.y,e.z)),s.setWorldTransform(c)}else if(n.isMesh){const r=u.get(n);r.setAngularVelocity(new t.btVector3(0,0,0)),r.setLinearVelocity(new t.btVector3(0,0,0)),c.setIdentity(),c.setOrigin(new t.btVector3(e.x,e.y,e.z)),r.setWorldTransform(c)}}let V=0;function x(){const n=performance.now();if(V>0){const e=(n-V)/1e3;m.stepSimulation(e,10);for(let a=0,r=f.length;a<r;a++){const s=f[a];if(s.isInstancedMesh){const l=s.instanceMatrix.array,S=u.get(s);for(let w=0;w<S.length;w++){S[w].getMotionState().getWorldTransform(c);const R=c.getOrigin(),B=c.getRotation();Q(R,B,l,w*16)}s.instanceMatrix.needsUpdate=!0,s.computeBoundingSphere()}else if(s.isMesh){u.get(s).getMotionState().getWorldTransform(c);const w=c.getOrigin(),g=c.getRotation();s.position.set(w.x(),w.y(),w.z()),s.quaternion.set(g.x(),g.y(),g.z(),g.w())}}}V=n}return setInterval(x,1e3/d),{addScene:I,addMesh:b,setMeshPosition:C}}function Q(t,d,o,i){const h=d.x(),M=d.y(),m=d.z(),c=d.w(),y=h+h,f=M+M,u=m+m,I=h*y,b=h*f,z=h*u,p=M*f,C=M*u,V=m*u,x=c*y,n=c*f,e=c*u;o[i+0]=1-(p+V),o[i+1]=b+e,o[i+2]=z-n,o[i+3]=0,o[i+4]=b-e,o[i+5]=1-(I+V),o[i+6]=C+x,o[i+7]=0,o[i+8]=z+n,o[i+9]=C-x,o[i+10]=1-(I+p),o[i+11]=0,o[i+12]=t.x(),o[i+13]=t.y(),o[i+14]=t.z(),o[i+15]=1}const U=new Promise((t,d)=>{const o=document.createElement("script");document.body.appendChild(o),o.async=!0,o.onload=t,o.onerror=d,o.src="./public/ammo.wasm.js"});U.then(()=>{let t,d,o,i,h;M();async function M(){h=await F(),new D,t=new P(50,window.innerWidth/window.innerHeight,.1,100),t.position.set(-1,1.5,2),t.lookAt(0,.5,0),d=new W,d.background=new T(6710886);const c=new O;c.intensity=.3,d.add(c);const y=new G;y.position.set(5,5,5),y.castShadow=!0,y.shadow.camera.zoom=2,d.add(y);const f=new L(new A(10,5,10),new j({color:4473924}));f.position.y=-2.5,f.receiveShadow=!1,d.add(f),h.addMesh(f);const u=new A(.075,.075,.075);var I=0;setInterval(()=>{if(I>700)return;let p=new L(u,new k({color:16777215*Math.random()}));p.castShadow=!1,p.receiveShadow=!1,d.add(p),p.position.set(Math.random()-.5,Math.random()*2,Math.random()-.5),h.addMesh(p,1),I++},16);const b=document.getElementById("canvas");b.width=b.clientWidth*window.devicePixelRatio,b.height=b.clientHeight*window.devicePixelRatio,o=new q({canvas:b,antialias:!0}),o.shadowMap.enabled=!1,i=new H,document.body.appendChild(i.dom);const z=new E(t,o.domElement);z.target.y=.5,z.update(),m()}function m(){requestAnimationFrame(m),o.render(d,t),i.update()}});
