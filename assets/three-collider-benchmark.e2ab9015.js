import"./modulepreload-polyfill.c7c6310f.js";import{V as A,P as L,S as T,C as O,D as G,E as D,ah as P,v as W,W as q}from"./three.module.9055bead.js";import{O as E}from"./OrbitControls.409c941a.js";import{S as j}from"./stats.module.9f3638b7.js";async function k(){if(!("Ammo"in window)){console.error("AmmoPhysics: Couldn't find Ammo.js");return}const t=await Ammo(),d=60,o=new t.btDefaultCollisionConfiguration,i=new t.btCollisionDispatcher(o),u=new t.btDbvtBroadphase,M=new t.btSequentialImpulseConstraintSolver,h=new t.btDiscreteDynamicsWorld(i,u,M,o);h.setGravity(new t.btVector3(0,-9.8,0));const c=new t.btTransform;function y(n){const e=n.parameters;if(n.type==="BoxGeometry"){const a=e.width!==void 0?e.width/2:.5,r=e.height!==void 0?e.height/2:.5,s=e.depth!==void 0?e.depth/2:.5,w=new t.btBoxShape(new t.btVector3(a,r,s));return w.setMargin(.05),w}else if(n.type==="SphereGeometry"||n.type==="IcosahedronGeometry"){const a=e.radius!==void 0?e.radius:1,r=new t.btSphereShape(a);return r.setMargin(.05),r}return null}const b=[],l=new WeakMap;function V(n){n.traverse(function(e){if(e.isMesh){const a=e.userData.physics;a&&m(e,a.mass)}})}function m(n,e=0){const a=y(n.geometry);a!==null&&(n.isInstancedMesh?S(n,e,a):n.isMesh&&z(n,e,a))}function z(n,e,a){const r=n.position,s=n.quaternion,w=new t.btTransform;w.setIdentity(),w.setOrigin(new t.btVector3(r.x,r.y,r.z)),w.setRotation(new t.btQuaternion(s.x,s.y,s.z,s.w));const I=new t.btDefaultMotionState(w),f=new t.btVector3(0,0,0);a.calculateLocalInertia(e,f);const g=new t.btRigidBodyConstructionInfo(e,I,a,f),x=new t.btRigidBody(g);h.addRigidBody(x),e>0&&(b.push(n),l.set(n,x))}function S(n,e,a){const r=n.instanceMatrix.array,s=[];for(let w=0;w<n.count;w++){const I=w*16,f=new t.btTransform;f.setFromOpenGLMatrix(r.slice(I,I+16));const g=new t.btDefaultMotionState(f),x=new t.btVector3(0,0,0);a.calculateLocalInertia(e,x);const R=new t.btRigidBodyConstructionInfo(e,g,a,x),B=new t.btRigidBody(R);h.addRigidBody(B),s.push(B)}e>0&&(b.push(n),l.set(n,s))}function p(n,e,a=0){if(n.isInstancedMesh){const s=l.get(n)[a];s.setAngularVelocity(new t.btVector3(0,0,0)),s.setLinearVelocity(new t.btVector3(0,0,0)),c.setIdentity(),c.setOrigin(new t.btVector3(e.x,e.y,e.z)),s.setWorldTransform(c)}else if(n.isMesh){const r=l.get(n);r.setAngularVelocity(new t.btVector3(0,0,0)),r.setLinearVelocity(new t.btVector3(0,0,0)),c.setIdentity(),c.setOrigin(new t.btVector3(e.x,e.y,e.z)),r.setWorldTransform(c)}}let v=0;function C(){const n=performance.now();if(v>0){const e=(n-v)/1e3;h.stepSimulation(e,10);for(let a=0,r=b.length;a<r;a++){const s=b[a];if(s.isInstancedMesh){const w=s.instanceMatrix.array,I=l.get(s);for(let f=0;f<I.length;f++){I[f].getMotionState().getWorldTransform(c);const R=c.getOrigin(),B=c.getRotation();F(R,B,w,f*16)}s.instanceMatrix.needsUpdate=!0,s.computeBoundingSphere()}else if(s.isMesh){l.get(s).getMotionState().getWorldTransform(c);const f=c.getOrigin(),g=c.getRotation();s.position.set(f.x(),f.y(),f.z()),s.quaternion.set(g.x(),g.y(),g.z(),g.w())}}}v=n}return setInterval(C,1e3/d),{addScene:V,addMesh:m,setMeshPosition:p}}function F(t,d,o,i){const u=d.x(),M=d.y(),h=d.z(),c=d.w(),y=u+u,b=M+M,l=h+h,V=u*y,m=u*b,z=u*l,S=M*b,p=M*l,v=h*l,C=c*y,n=c*b,e=c*l;o[i+0]=1-(S+v),o[i+1]=m+e,o[i+2]=z-n,o[i+3]=0,o[i+4]=m-e,o[i+5]=1-(V+v),o[i+6]=p+C,o[i+7]=0,o[i+8]=z+n,o[i+9]=p-C,o[i+10]=1-(V+S),o[i+11]=0,o[i+12]=t.x(),o[i+13]=t.y(),o[i+14]=t.z(),o[i+15]=1}const H=new Promise((t,d)=>{const o=document.createElement("script");document.body.appendChild(o),o.async=!0,o.onload=t,o.onerror=d,o.src="./public/ammo.wasm.js"});H.then(()=>{let t,d,o,i,u;M();async function M(){u=await k(),new A,t=new L(45,window.innerWidth/window.innerHeight,.1,100),t.position.set(-1,1.5,2),t.lookAt(0,0,0),d=new T,d.background=new O(6710886);const c=new G;c.position.set(-.3,1,.4),c.castShadow=!1,d.add(c);const y=new D(new P(30,1,30),new W({color:3623503}));y.position.y=-.5,y.receiveShadow=!1,d.add(y),u.addMesh(y);const b=new P(.075,.075,.075);var l=0;setInterval(()=>{l>850||(V(new A(Math.random()-.5,Math.random()*2+2.5,Math.random()-.5)),l++)},16);function V(S){let p=new D(b,new W({color:16777215*Math.random()}));p.castShadow=!1,p.receiveShadow=!1,d.add(p),p.position.set(S.x,S.y,S.z),u.addMesh(p,1)}const m=document.getElementById("canvas");m.width=m.clientWidth*window.devicePixelRatio,m.height=m.clientHeight*window.devicePixelRatio,o=new q({canvas:m,antialias:!0}),o.shadowMap.enabled=!1,i=new j,document.body.appendChild(i.dom);const z=new E(t,o.domElement);z.target.y=.5,z.update(),h()}function h(){requestAnimationFrame(h),o.render(d,t),i.update()}});
