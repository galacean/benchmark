var et;(function(n){n[n.Disjoint=0]="Disjoint",n[n.Contains=1]="Contains",n[n.Intersects=2]="Intersects"})(et||(et={}));var Lt;(function(n){n[n.Back=0]="Back",n[n.Front=1]="Front",n[n.Intersecting=2]="Intersecting"})(Lt||(Lt={}));var me;(function(n){n[n.Near=0]="Near",n[n.Far=1]="Far",n[n.Left=2]="Left",n[n.Right=3]="Right",n[n.Bottom=4]="Bottom",n[n.Top=5]="Top"})(me||(me={}));function al(n,s){for(var i=0;i<s.length;i++){var t=s[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function pa(n,s,i){return s&&al(n.prototype,s),n}var k=function(){function n(){}return n.clamp=function(i,t,e){return Math.max(t,Math.min(e,i))},n.equals=function(i,t){return Math.abs(i-t)<=n.zeroTolerance},n.isPowerOf2=function(i){return(i&i-1)===0},n.radianToDegree=function(i){return i*n.radToDegreeFactor},n.degreeToRadian=function(i){return i*n.degreeToRadFactor},n}();(function(){k.zeroTolerance=1e-6})();(function(){k.radToDegreeFactor=180/Math.PI})();(function(){k.degreeToRadFactor=Math.PI/180})();var R=function(){function n(i,t,e){i===void 0&&(i=0),t===void 0&&(t=0),e===void 0&&(e=0),this._onValueChanged=null,this._x=i,this._y=t,this._z=e}var s=n.prototype;return s.set=function(t,e,r){return this._x=t,this._y=e,this._z=r,this._onValueChanged&&this._onValueChanged(),this},s.add=function(t){return this._x+=t._x,this._y+=t._y,this._z+=t._z,this._onValueChanged&&this._onValueChanged(),this},s.subtract=function(t){return this._x-=t._x,this._y-=t._y,this._z-=t._z,this._onValueChanged&&this._onValueChanged(),this},s.multiply=function(t){return this._x*=t._x,this._y*=t._y,this._z*=t._z,this._onValueChanged&&this._onValueChanged(),this},s.divide=function(t){return this._x/=t._x,this._y/=t._y,this._z/=t._z,this._onValueChanged&&this._onValueChanged(),this},s.length=function(){var t=this,e=t._x,r=t._y,a=t._z;return Math.sqrt(e*e+r*r+a*a)},s.lengthSquared=function(){var t=this,e=t._x,r=t._y,a=t._z;return e*e+r*r+a*a},s.negate=function(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._onValueChanged&&this._onValueChanged(),this},s.normalize=function(){return n.normalize(this,this),this},s.scale=function(t){return this._x*=t,this._y*=t,this._z*=t,this._onValueChanged&&this._onValueChanged(),this},s.transformNormal=function(t){return n.transformNormal(this,t,this),this},s.transformToVec3=function(t){return n.transformToVec3(this,t,this),this},s.transformCoordinate=function(t){return n.transformCoordinate(this,t,this),this},s.transformByQuat=function(t){return n.transformByQuat(this,t,this),this},s.clone=function(){return new n(this._x,this._y,this._z)},s.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._onValueChanged&&this._onValueChanged(),this},s.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._onValueChanged&&this._onValueChanged(),this},s.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z},s.toJSON=function(){return{x:this._x,y:this._y,z:this._z}},n.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._z=t._z+e._z,r._onValueChanged&&r._onValueChanged()},n.subtract=function(t,e,r){r._x=t._x-e._x,r._y=t._y-e._y,r._z=t._z-e._z,r._onValueChanged&&r._onValueChanged()},n.multiply=function(t,e,r){r._x=t._x*e._x,r._y=t._y*e._y,r._z=t._z*e._z,r._onValueChanged&&r._onValueChanged()},n.divide=function(t,e,r){r._x=t._x/e._x,r._y=t._y/e._y,r._z=t._z/e._z,r._onValueChanged&&r._onValueChanged()},n.dot=function(t,e){return t._x*e._x+t._y*e._y+t._z*e._z},n.cross=function(t,e,r){var a=t._x,o=t._y,c=t._z,l=e._x,_=e._y,u=e._z;r.set(o*u-c*_,c*l-a*u,a*_-o*l)},n.distance=function(t,e){var r=e._x-t._x,a=e._y-t._y,o=e._z-t._z;return Math.sqrt(r*r+a*a+o*o)},n.distanceSquared=function(t,e){var r=e._x-t._x,a=e._y-t._y,o=e._z-t._z;return r*r+a*a+o*o},n.equals=function(t,e){return k.equals(t._x,e._x)&&k.equals(t._y,e._y)&&k.equals(t._z,e._z)},n.lerp=function(t,e,r,a){var o=t._x,c=t._y,l=t._z;a._x=o+(e._x-o)*r,a._y=c+(e._y-c)*r,a._z=l+(e._z-l)*r,a._onValueChanged&&a._onValueChanged()},n.max=function(t,e,r){r._x=Math.max(t._x,e._x),r._y=Math.max(t._y,e._y),r._z=Math.max(t._z,e._z),r._onValueChanged&&r._onValueChanged()},n.min=function(t,e,r){r._x=Math.min(t._x,e._x),r._y=Math.min(t._y,e._y),r._z=Math.min(t._z,e._z),r._onValueChanged&&r._onValueChanged()},n.negate=function(t,e){e._x=-t._x,e._y=-t._y,e._z=-t._z,e._onValueChanged&&e._onValueChanged()},n.normalize=function(t,e){var r=t._x,a=t._y,o=t._z,c=Math.sqrt(r*r+a*a+o*o);c>k.zeroTolerance&&(c=1/c,e.set(r*c,a*c,o*c))},n.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._z=t._z*e,r._onValueChanged&&r._onValueChanged()},n.transformNormal=function(t,e,r){var a=t._x,o=t._y,c=t._z,l=e.elements;r._x=a*l[0]+o*l[4]+c*l[8],r._y=a*l[1]+o*l[5]+c*l[9],r._z=a*l[2]+o*l[6]+c*l[10],r._onValueChanged&&r._onValueChanged()},n.transformToVec3=function(t,e,r){var a=t._x,o=t._y,c=t._z,l=e.elements;r._x=a*l[0]+o*l[4]+c*l[8]+l[12],r._y=a*l[1]+o*l[5]+c*l[9]+l[13],r._z=a*l[2]+o*l[6]+c*l[10]+l[14],r._onValueChanged&&r._onValueChanged()},n.transformToVec4=function(t,e,r){var a=t._x,o=t._y,c=t._z,l=e.elements;r._x=a*l[0]+o*l[4]+c*l[8]+l[12],r._y=a*l[1]+o*l[5]+c*l[9]+l[13],r._z=a*l[2]+o*l[6]+c*l[10]+l[14],r._w=a*l[3]+o*l[7]+c*l[11]+l[15],r._onValueChanged&&r._onValueChanged()},n.transformCoordinate=function(t,e,r){var a=t._x,o=t._y,c=t._z,l=e.elements,_=a*l[3]+o*l[7]+c*l[11]+l[15];_=1/_,r._x=(a*l[0]+o*l[4]+c*l[8]+l[12])*_,r._y=(a*l[1]+o*l[5]+c*l[9]+l[13])*_,r._z=(a*l[2]+o*l[6]+c*l[10]+l[14])*_,r._onValueChanged&&r._onValueChanged()},n.transformByQuat=function(t,e,r){var a=t._x,o=t._y,c=t._z,l=e._x,_=e._y,u=e._z,h=e._w,d=h*a+_*c-u*o,f=h*o+u*a-l*c,v=h*c+l*o-_*a,p=-l*a-_*o-u*c;r._x=d*h-p*l-f*u+v*_,r._y=f*h-p*_-v*l+d*u,r._z=v*h-p*u-d*_+f*l,r._onValueChanged&&r._onValueChanged()},pa(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this._onValueChanged&&this._onValueChanged()}}]),n}();(function(){R._zero=new R(0,0,0)})();(function(){R._one=new R(1,1,1)})();var xc=function(){function n(i,t){i===void 0&&(i=null),t===void 0&&(t=0),this.center=new R,this.radius=0,i&&this.center.copyFrom(i),this.radius=t}var s=n.prototype;return s.clone=function(){return new n(this.center,this.radius)},s.copyFrom=function(t){return this.center.copyFrom(t.center),this.radius=t.radius,this},n.fromPoints=function(t,e){if(!t||t.length===0)throw new Error("points must be array and length must > 0");var r=t.length,a=n._tempVec30;a.x=a.y=a.z=0;for(var o=0;o<r;++o)R.add(t[o],a,a);R.scale(a,1/r,e.center);for(var c=0,l=0;l<r;++l){var _=R.distanceSquared(a,t[l]);_>c&&(c=_)}e.radius=Math.sqrt(c)},n.fromBox=function(t,e){var r=e.center,a=t.min,o=t.max;r.x=(a.x+o.x)*.5,r.y=(a.y+o.y)*.5,r.z=(a.z+o.z)*.5,e.radius=R.distance(r,o)},n}();(function(){xc._tempVec30=new R})();var lr=function(){function n(i,t){i===void 0&&(i=null),t===void 0&&(t=null),this.min=new R,this.max=new R,i&&this.min.copyFrom(i),t&&this.max.copyFrom(t)}var s=n.prototype;return s.getCenter=function(t){var e=this,r=e.min,a=e.max,o=a._x+r._x,c=a._y+r._y,l=a._z+r._z;return t.set(isNaN(o)?0:o*.5,isNaN(c)?0:c*.5,isNaN(l)?0:l*.5),t},s.getExtent=function(t){var e=this,r=e.min,a=e.max,o=a._x-r._x,c=a._y-r._y,l=a._z-r._z;return t.set(isNaN(o)?0:o*.5,isNaN(c)?0:c*.5,isNaN(l)?0:l*.5),t},s.getCorners=function(t){t===void 0&&(t=[]);var e=this,r=e.min,a=e.max,o=r.x,c=r.y,l=r.z,_=a.x,u=a.y,h=a.z,d=t.length;if(d<8)for(var f=0,v=8-d;f<v;++f)t[d+f]=new R;return t[0].set(o,u,h),t[1].set(_,u,h),t[2].set(_,c,h),t[3].set(o,c,h),t[4].set(o,u,l),t[5].set(_,u,l),t[6].set(_,c,l),t[7].set(o,c,l),t},s.transform=function(t){return n.transform(this,t,this),this},s.clone=function(){return new n(this.min,this.max)},s.copyFrom=function(t){return this.min.copyFrom(t.min),this.max.copyFrom(t.max),this},n.fromCenterAndExtent=function(t,e,r){R.subtract(t,e,r.min),R.add(t,e,r.max)},n.fromPoints=function(t,e){if(!t||t.length===0)throw new Error("points must be array and length must > 0");var r=e.min,a=e.max;r.x=r.y=r.z=Number.MAX_VALUE,a.x=a.y=a.z=-Number.MAX_VALUE;for(var o=0,c=t.length;o<c;++o){var l=t[o];R.min(r,l,r),R.max(a,l,a)}},n.fromSphere=function(t,e){var r=t.center,a=t.radius,o=e.min,c=e.max;o.x=r.x-a,o.y=r.y-a,o.z=r.z-a,c.x=r.x+a,c.y=r.y+a,c.z=r.z+a},n.transform=function(t,e,r){var a=n._tempVec30,o=n._tempVec31;t.getCenter(a),t.getExtent(o),R.transformCoordinate(a,e,a);var c=o.x,l=o.y,_=o.z,u=e.elements,h=u[0],d=u[1],f=u[2],v=u[4],p=u[5],g=u[6],y=u[8],m=u[9],x=u[10];o.set((h===0?0:Math.abs(c*h))+(v===0?0:Math.abs(l*v))+(y===0?0:Math.abs(_*y)),(d===0?0:Math.abs(c*d))+(p===0?0:Math.abs(l*p))+(m===0?0:Math.abs(_*m)),(f===0?0:Math.abs(c*f))+(g===0?0:Math.abs(l*g))+(x===0?0:Math.abs(_*x))),R.subtract(a,o,r.min),R.add(a,o,r.max)},n.merge=function(t,e,r){return R.min(t.min,e.min,r.min),R.max(t.max,e.max,r.max),r},n}();(function(){lr._tempVec30=new R})();(function(){lr._tempVec31=new R})();var wt=function(){function n(){}return n.intersectionPointThreePlanes=function(i,t,e,r){var a=i.normal,o=t.normal,c=e.normal;R.cross(o,c,n._tempVec30),R.cross(c,a,n._tempVec31),R.cross(a,o,n._tempVec32);var l=-R.dot(a,n._tempVec30),_=-R.dot(o,n._tempVec31),u=-R.dot(c,n._tempVec32);R.scale(n._tempVec30,i.distance/l,n._tempVec30),R.scale(n._tempVec31,t.distance/_,n._tempVec31),R.scale(n._tempVec32,e.distance/u,n._tempVec32),R.add(n._tempVec30,n._tempVec31,r),R.add(r,n._tempVec32,r)},n.distancePlaneAndPoint=function(i,t){return R.dot(i.normal,t)+i.distance},n.intersectsPlaneAndPoint=function(i,t){var e=n.distancePlaneAndPoint(i,t);return e>0?Lt.Front:e<0?Lt.Back:Lt.Intersecting},n.intersectsPlaneAndBox=function(i,t){var e=t.min,r=t.max,a=i.normal,o=n._tempVec30,c=n._tempVec31;return a.x>=0?(o.x=r.x,c.x=e.x):(o.x=e.x,c.x=r.x),a.y>=0?(o.y=r.y,c.y=e.y):(o.y=e.y,c.y=r.y),a.z>=0?(o.z=r.z,c.z=e.z):(o.z=e.z,c.z=r.z),n.distancePlaneAndPoint(i,o)<0?Lt.Back:n.distancePlaneAndPoint(i,c)>0?Lt.Front:Lt.Intersecting},n.intersectsPlaneAndSphere=function(i,t){var e=t.center,r=t.radius,a=n.distancePlaneAndPoint(i,e);return a>r?Lt.Front:a<-r?Lt.Back:Lt.Intersecting},n.intersectsRayAndPlane=function(i,t){var e=t.normal,r=k.zeroTolerance,a=R.dot(e,i.direction);if(Math.abs(a)<r)return-1;var o=R.dot(e,i.origin),c=(-t.distance-o)/a;if(c<0){if(c<-r)return-1;c=0}return c},n.intersectsRayAndBox=function(i,t){var e=k.zeroTolerance,r=i.origin,a=i.direction,o=t.min,c=t.max,l=a.x,_=a.y,u=a.z,h=r.x,d=r.y,f=r.z,v=0,p=Number.MAX_VALUE;if(Math.abs(l)<e){if(h<o.x||h>c.x)return-1}else{var g=1/l,y=(o.x-h)*g,m=(c.x-h)*g;if(y>m){var x=y;y=m,m=x}if(v=Math.max(y,v),p=Math.min(m,p),v>p)return-1}if(Math.abs(_)<e){if(d<o.y||d>c.y)return-1}else{var C=1/_,b=(o.y-d)*C,A=(c.y-d)*C;if(b>A){var S=b;b=A,A=S}if(v=Math.max(b,v),p=Math.min(A,p),v>p)return-1}if(Math.abs(u)<e){if(f<o.z||f>c.z)return-1}else{var w=1/u,E=(o.z-f)*w,P=(c.z-f)*w;if(E>P){var M=E;E=P,P=M}if(v=Math.max(E,v),p=Math.min(P,p),v>p)return-1}return v},n.intersectsRayAndSphere=function(i,t){var e=i.origin,r=i.direction,a=t.center,o=t.radius,c=n._tempVec30;R.subtract(e,a,c);var l=R.dot(c,r),_=R.dot(c,c)-o*o;if(l>0&&_>0)return-1;var u=l*l-_;if(u<0)return-1;var h=-l-Math.sqrt(u);return h<0&&(h=0),h},n.intersectsBoxAndBox=function(i,t){return i.min.x>t.max.x||t.min.x>i.max.x||i.min.y>t.max.y||t.min.y>i.max.y?!1:!(i.min.z>t.max.z||t.min.z>i.max.z)},n.intersectsSphereAndSphere=function(i,t){var e=i.radius+t.radius;return R.distanceSquared(i.center,t.center)<e*e},n.intersectsSphereAndBox=function(i,t){var e=i.center,r=t.max,a=t.min,o=n._tempVec30;o.set(Math.max(a.x,Math.min(e.x,r.x)),Math.max(a.y,Math.min(e.y,r.y)),Math.max(a.z,Math.min(e.z,r.z)));var c=R.distanceSquared(e,o);return c<=i.radius*i.radius},n.intersectsFrustumAndBox=function(i,t){for(var e=t.min,r=t.max,a=n._tempVec30,o=0;o<6;++o){var c=i.getPlane(o),l=c.normal;if(a.set(l.x>=0?r.x:e.x,l.y>=0?r.y:e.y,l.z>=0?r.z:e.z),R.dot(l,a)<-c.distance)return!1}return!0},n.frustumContainsPoint=function(i,t){var e=n.distancePlaneAndPoint(i.near,t);return Math.abs(e)<k.zeroTolerance?et.Intersects:e<0?et.Disjoint:(e=n.distancePlaneAndPoint(i.far,t),Math.abs(e)<k.zeroTolerance?et.Intersects:e<0?et.Disjoint:(e=n.distancePlaneAndPoint(i.left,t),Math.abs(e)<k.zeroTolerance?et.Intersects:e<0?et.Disjoint:(e=n.distancePlaneAndPoint(i.right,t),Math.abs(e)<k.zeroTolerance?et.Intersects:e<0?et.Disjoint:(e=n.distancePlaneAndPoint(i.top,t),Math.abs(e)<k.zeroTolerance?et.Intersects:e<0?et.Disjoint:(e=n.distancePlaneAndPoint(i.bottom,t),Math.abs(e)<k.zeroTolerance?et.Intersects:e<0?et.Disjoint:et.Contains)))))},n.frustumContainsBox=function(i,t){for(var e=t.min,r=t.max,a=n._tempVec30,o=n._tempVec31,c=et.Contains,l=0;l<6;++l){var _=i.getPlane(l),u=_.normal;if(u.x>=0?(a.x=r.x,o.x=e.x):(a.x=e.x,o.x=r.x),u.y>=0?(a.y=r.y,o.y=e.y):(a.y=e.y,o.y=r.y),u.z>=0?(a.z=r.z,o.z=e.z):(a.z=e.z,o.z=r.z),n.intersectsPlaneAndPoint(_,a)===Lt.Back)return et.Disjoint;n.intersectsPlaneAndPoint(_,o)===Lt.Back&&(c=et.Intersects)}return c},n.frustumContainsSphere=function(i,t){for(var e=et.Contains,r=0;r<6;++r){var a=i.getPlane(r),o=n.intersectsPlaneAndSphere(a,t);if(o===Lt.Back)return et.Disjoint;if(o===Lt.Intersecting){e=et.Intersects;break}}return e},n}();(function(){wt._tempVec30=new R})();(function(){wt._tempVec31=new R})();(function(){wt._tempVec32=new R})();var ht=function(){function n(i,t){i===void 0&&(i=null),t===void 0&&(t=0),this.normal=new R,this.distance=0,i&&this.normal.copyFrom(i),this.distance=t}var s=n.prototype;return s.normalize=function(){return n.normalize(this,this),this},s.clone=function(){var t=new n;return t.copyFrom(this),t},s.copyFrom=function(t){return this.normal.copyFrom(t.normal),this.distance=t.distance,this},n.normalize=function(t,e){var r=t.normal,a=1/r.length();R.scale(r,a,e.normal),e.distance=t.distance*a},n.fromPoints=function(t,e,r,a){var o=t.x,c=t.y,l=t.z,_=e.x-o,u=e.y-c,h=e.z-l,d=r.x-o,f=r.y-c,v=r.z-l,p=u*v-h*f,g=h*d-_*v,y=_*f-u*d,m=1/Math.sqrt(p*p+g*g+y*y),x=p*m,C=g*m,b=y*m,A=a.normal;A.x=x,A.y=C,A.z=b,a.distance=-(x*o+C*c+b*l)},n}(),il=function(){function n(i){i===void 0&&(i=null),this.near=new ht,this.far=new ht,this.left=new ht,this.right=new ht,this.top=new ht,this.bottom=new ht,i&&this.calculateFromMatrix(i)}var s=n.prototype;return s.getPlane=function(t){switch(t){case me.Near:return this.near;case me.Far:return this.far;case me.Left:return this.left;case me.Right:return this.right;case me.Bottom:return this.bottom;case me.Top:return this.top;default:return null}},s.calculateFromMatrix=function(t){var e=t.elements,r=e[0],a=e[1],o=e[2],c=e[3],l=e[4],_=e[5],u=e[6],h=e[7],d=e[8],f=e[9],v=e[10],p=e[11],g=e[12],y=e[13],m=e[14],x=e[15],C=this.near.normal;C.set(c+o,h+u,p+v),this.near.distance=x+m,this.near.normalize();var b=this.far.normal;b.set(c-o,h-u,p-v),this.far.distance=x-m,this.far.normalize();var A=this.left.normal;A.set(c+r,h+l,p+d),this.left.distance=x+g,this.left.normalize();var S=this.right.normal;S.set(c-r,h-l,p-d),this.right.distance=x-g,this.right.normalize();var w=this.bottom.normal;w.set(c+a,h+_,p+f),this.bottom.distance=x+y,this.bottom.normalize();var E=this.top.normal;E.set(c-a,h-_,p-f),this.top.distance=x-y,this.top.normalize()},s.intersectsBox=function(t){return wt.intersectsFrustumAndBox(this,t)},s.intersectsSphere=function(t){return wt.frustumContainsSphere(this,t)!==et.Disjoint},s.clone=function(){var t=new n;return t.copyFrom(this),t},s.copyFrom=function(t){return this.near.copyFrom(t.near),this.far.copyFrom(t.far),this.left.copyFrom(t.left),this.right.copyFrom(t.right),this.bottom.copyFrom(t.bottom),this.top.copyFrom(t.top),this},n}(),oa=function(){function n(i,t,e,r,a,o,c,l,_){i===void 0&&(i=1),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),a===void 0&&(a=1),o===void 0&&(o=0),c===void 0&&(c=0),l===void 0&&(l=0),_===void 0&&(_=1),this.elements=new Float32Array(9);var u=this.elements;u[0]=i,u[1]=t,u[2]=e,u[3]=r,u[4]=a,u[5]=o,u[6]=c,u[7]=l,u[8]=_}var s=n.prototype;return s.set=function(t,e,r,a,o,c,l,_,u){var h=this.elements;return h[0]=t,h[1]=e,h[2]=r,h[3]=a,h[4]=o,h[5]=c,h[6]=l,h[7]=_,h[8]=u,this},s.add=function(t){return n.add(this,t,this),this},s.subtract=function(t){return n.subtract(this,t,this),this},s.multiply=function(t){return n.multiply(this,t,this),this},s.determinant=function(){var t=this.elements,e=t[0],r=t[1],a=t[2],o=t[3],c=t[4],l=t[5],_=t[6],u=t[7],h=t[8],d=h*c-l*u,f=-h*o+l*_,v=u*o-c*_;return e*d+r*f+a*v},s.identity=function(){var t=this.elements;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this},s.invert=function(){return n.invert(this,this),this},s.rotate=function(t){return n.rotate(this,t,this),this},s.scale=function(t){return n.scale(this,t,this),this},s.translate=function(t){return n.translate(this,t,this),this},s.transpose=function(){return n.transpose(this,this),this},s.clone=function(){var t=this.elements,e=new n(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]);return e},s.copyFrom=function(t){var e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],this},s.copyFromArray=function(t,e){e===void 0&&(e=0);for(var r=this.elements,a=0;a<12;a++)r[a]=t[a+e];return this},s.copyToArray=function(t,e){e===void 0&&(e=0);var r=this.elements;t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8]},s.copyFromMatrix=function(t){var e=t.elements,r=this.elements;return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[4],r[4]=e[5],r[5]=e[6],r[6]=e[8],r[7]=e[9],r[8]=e[10],this},n.add=function(t,e,r){var a=t.elements,o=e.elements,c=r.elements;c[0]=a[0]+o[0],c[1]=a[1]+o[1],c[2]=a[2]+o[2],c[3]=a[3]+o[3],c[4]=a[4]+o[4],c[5]=a[5]+o[5],c[6]=a[6]+o[6],c[7]=a[7]+o[7],c[8]=a[8]+o[8]},n.subtract=function(t,e,r){var a=t.elements,o=e.elements,c=r.elements;c[0]=a[0]-o[0],c[1]=a[1]-o[1],c[2]=a[2]-o[2],c[3]=a[3]-o[3],c[4]=a[4]-o[4],c[5]=a[5]-o[5],c[6]=a[6]-o[6],c[7]=a[7]-o[7],c[8]=a[8]-o[8]},n.multiply=function(t,e,r){var a=t.elements,o=e.elements,c=r.elements,l=a[0],_=a[1],u=a[2],h=a[3],d=a[4],f=a[5],v=a[6],p=a[7],g=a[8],y=o[0],m=o[1],x=o[2],C=o[3],b=o[4],A=o[5],S=o[6],w=o[7],E=o[8];c[0]=l*y+h*m+v*x,c[1]=_*y+d*m+p*x,c[2]=u*y+f*m+g*x,c[3]=l*C+h*b+v*A,c[4]=_*C+d*b+p*A,c[5]=u*C+f*b+g*A,c[6]=l*S+h*w+v*E,c[7]=_*S+d*w+p*E,c[8]=u*S+f*w+g*E},n.equals=function(t,e){var r=t.elements,a=e.elements;return k.equals(r[0],a[0])&&k.equals(r[1],a[1])&&k.equals(r[2],a[2])&&k.equals(r[3],a[3])&&k.equals(r[4],a[4])&&k.equals(r[5],a[5])&&k.equals(r[6],a[6])&&k.equals(r[7],a[7])&&k.equals(r[8],a[8])},n.lerp=function(t,e,r,a){var o=t.elements,c=e.elements,l=a.elements,_=1-r;l[0]=o[0]*_+c[0]*r,l[1]=o[1]*_+c[1]*r,l[2]=o[2]*_+c[2]*r,l[3]=o[3]*_+c[3]*r,l[4]=o[4]*_+c[4]*r,l[5]=o[5]*_+c[5]*r,l[6]=o[6]*_+c[6]*r,l[7]=o[7]*_+c[7]*r,l[8]=o[8]*_+c[8]*r},n.rotationQuaternion=function(t,e){var r=e.elements,a=t._x,o=t._y,c=t._z,l=t._w,_=a+a,u=o+o,h=c+c,d=a*_,f=o*_,v=o*u,p=c*_,g=c*u,y=c*h,m=l*_,x=l*u,C=l*h;r[0]=1-v-y,r[3]=f-C,r[6]=p+x,r[1]=f+C,r[4]=1-d-y,r[7]=g-m,r[2]=p-x,r[5]=g+m,r[8]=1-d-v},n.scaling=function(t,e){var r=e.elements;r[0]=t._x,r[1]=0,r[2]=0,r[3]=0,r[4]=t._y,r[5]=0,r[6]=0,r[7]=0,r[8]=1},n.translation=function(i,t){var e=t.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=i._x,e[7]=i._y,e[8]=1},n.invert=function(t,e){var r=t.elements,a=e.elements,o=r[0],c=r[1],l=r[2],_=r[3],u=r[4],h=r[5],d=r[6],f=r[7],v=r[8],p=v*u-h*f,g=-v*_+h*d,y=f*_-u*d,m=o*p+c*g+l*y;m&&(m=1/m,a[0]=p*m,a[1]=(-v*c+l*f)*m,a[2]=(h*c-l*u)*m,a[3]=g*m,a[4]=(v*o-l*d)*m,a[5]=(-h*o+l*_)*m,a[6]=y*m,a[7]=(-f*o+c*d)*m,a[8]=(u*o-c*_)*m)},n.normalMatrix=function(t,e){var r=t.elements,a=e.elements,o=r[0],c=r[1],l=r[2],_=r[3],u=r[4],h=r[5],d=r[6],f=r[7],v=r[8],p=r[9],g=r[10],y=r[11],m=r[12],x=r[13],C=r[14],b=r[15],A=o*h-c*u,S=o*d-l*u,w=o*f-_*u,E=c*d-l*h,P=c*f-_*h,M=l*f-_*d,D=v*x-p*m,L=v*C-g*m,V=v*b-y*m,N=p*C-g*x,I=p*b-y*x,B=g*b-y*C,z=A*B-S*I+w*N+E*V-P*L+M*D;if(!z)return null;z=1/z,a[0]=(h*B-d*I+f*N)*z,a[1]=(d*V-u*B-f*L)*z,a[2]=(u*I-h*V+f*D)*z,a[3]=(l*I-c*B-_*N)*z,a[4]=(o*B-l*V+_*L)*z,a[5]=(c*V-o*I-_*D)*z,a[6]=(x*M-C*P+b*E)*z,a[7]=(C*w-m*M-b*S)*z,a[8]=(m*P-x*w+b*A)*z},n.rotate=function(t,e,r){var a=t.elements,o=r.elements,c=Math.sin(e),l=Math.cos(e),_=a[0],u=a[1],h=a[2],d=a[3],f=a[4],v=a[5],p=a[6],g=a[7],y=a[8];o[0]=l*_+c*d,o[1]=l*u+c*f,o[2]=l*h+c*v,o[3]=l*d-c*_,o[4]=l*f-c*u,o[5]=l*v-c*h,o[6]=p,o[7]=g,o[8]=y},n.scale=function(t,e,r){var a=e._x,o=e._y,c=t.elements,l=r.elements;l[0]=a*c[0],l[1]=a*c[1],l[2]=a*c[2],l[3]=o*c[3],l[4]=o*c[4],l[5]=o*c[5],l[6]=c[6],l[7]=c[7],l[8]=c[8]},n.translate=function(t,e,r){var a=e._x,o=e._y,c=t.elements,l=r.elements,_=c[0],u=c[1],h=c[2],d=c[3],f=c[4],v=c[5],p=c[6],g=c[7],y=c[8];l[0]=_,l[1]=u,l[2]=h,l[3]=d,l[4]=f,l[5]=v,l[6]=a*_+o*d+p,l[7]=a*u+o*f+g,l[8]=a*h+o*v+y},n.transpose=function(t,e){var r=t.elements,a=e.elements;if(e===t){var o=r[1],c=r[2],l=r[5];a[1]=r[3],a[2]=r[6],a[3]=o,a[5]=r[7],a[6]=c,a[7]=l}else a[0]=r[0],a[1]=r[3],a[2]=r[6],a[3]=r[1],a[4]=r[4],a[5]=r[7],a[6]=r[2],a[7]=r[5],a[8]=r[8]},n}(),Re=function(){function n(i,t,e,r){i===void 0&&(i=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=1),this._onValueChanged=null,this._x=i,this._y=t,this._z=e,this._w=r}var s=n.prototype;return s.set=function(t,e,r,a){return this._x=t,this._y=e,this._z=r,this._w=a,this._onValueChanged&&this._onValueChanged(),this},s.conjugate=function(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onValueChanged&&this._onValueChanged(),this},s.getAxisAngle=function(t){var e=this,r=e._x,a=e._y,o=e._z,c=r*r+a*a+o*o;if(c<k.zeroTolerance)return t._x=1,t._y=0,t._z=0,0;var l=1/c;return t._x=this._x*l,t._y=this._y*l,t._z=this._z*l,Math.acos(this._w)*2},s.identity=function(){return this._x=0,this._y=0,this._z=0,this._w=1,this._onValueChanged&&this._onValueChanged(),this},s.length=function(){var t=this,e=t._x,r=t._y,a=t._z,o=t._w;return Math.sqrt(e*e+r*r+a*a+o*o)},s.lengthSquared=function(){var t=this,e=t._x,r=t._y,a=t._z,o=t._w;return e*e+r*r+a*a+o*o},s.normalize=function(){return n.normalize(this,this),this},s.toEuler=function(t){this._toYawPitchRoll(t);var e=t._x;return t._x=t._y,t._y=e,t._onValueChanged&&t._onValueChanged(),t},s.toYawPitchRoll=function(t){return this._toYawPitchRoll(t),t._onValueChanged&&t._onValueChanged(),t},s.rotateX=function(t){return n.rotateX(this,t,this),this},s.rotateY=function(t){return n.rotateY(this,t,this),this},s.rotateZ=function(t){return n.rotateZ(this,t,this),this},s.rotationAxisAngle=function(t,e){return n.rotationAxisAngle(t,e,this),this},s.multiply=function(t){return n.multiply(this,t,this),this},s.invert=function(){return n.invert(this,this),this},s.dot=function(t){return n.dot(this,t)},s.lerp=function(t,e){return n.lerp(this,t,e,this),this},s.rotateAxisAngle=function(t,e){return n._tempQuat1.rotationAxisAngle(t,e),this.multiply(n._tempQuat1),this},s.clone=function(){return new n(this._x,this._y,this._z,this._w)},s.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onValueChanged&&this._onValueChanged(),this},s.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onValueChanged&&this._onValueChanged(),this},s.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w},s.toJSON=function(){return{x:this._x,y:this._y,z:this._z,w:this._w}},s._toYawPitchRoll=function(t){var e=this,r=e._x,a=e._y,o=e._z,c=e._w,l=r*r,_=a*a,u=o*o,h=c*c,d=l+_+u+h,f=2*(r*c-a*o);f>(1-k.zeroTolerance)*d?(t._x=Math.atan2(2*(c*a-r*o),l+h-_-u),t._y=Math.PI/2,t._z=0):f<-(1-k.zeroTolerance)*d?(t._x=Math.atan2(2*(c*a-r*o),l+h-_-u),t._y=-Math.PI/2,t._z=0):(t._x=Math.atan2(2*(o*r+a*c),u+h-_-l),t._y=Math.asin(f/d),t._z=Math.atan2(2*(r*a+o*c),_+h-u-l))},n.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._z=t._z+e._z,r._w=t._w+e._w,r._onValueChanged&&r._onValueChanged()},n.multiply=function(t,e,r){var a=t._x,o=t._y,c=t._z,l=t._w,_=e._x,u=e._y,h=e._z,d=e._w;r._x=a*d+l*_+o*h-c*u,r._y=o*d+l*u+c*_-a*h,r._z=c*d+l*h+a*u-o*_,r._w=l*d-a*_-o*u-c*h,r._onValueChanged&&r._onValueChanged()},n.conjugate=function(t,e){e._x=-t._x,e._y=-t._y,e._z=-t._z,e._w=t._w,e._onValueChanged&&e._onValueChanged()},n.dot=function(t,e){return t._x*e._x+t._y*e._y+t._z*e._z+t._w*e._w},n.equals=function(t,e){return k.equals(t._x,e._x)&&k.equals(t._y,e._y)&&k.equals(t._z,e._z)&&k.equals(t._w,e._w)},n.rotationAxisAngle=function(t,e,r){var a=n._tempVector3;R.normalize(t,a),e*=.5;var o=Math.sin(e);r._x=a._x*o,r._y=a._y*o,r._z=a._z*o,r._w=Math.cos(e),r._onValueChanged&&r._onValueChanged()},n.rotationEuler=function(t,e,r,a){n.rotationYawPitchRoll(e,t,r,a)},n.rotationYawPitchRoll=function(t,e,r,a){var o=r*.5,c=e*.5,l=t*.5,_=Math.sin(o),u=Math.cos(o),h=Math.sin(c),d=Math.cos(c),f=Math.sin(l),v=Math.cos(l),p=v*d,g=f*h;a._x=v*h*u+f*d*_,a._y=f*d*u-v*h*_,a._z=p*_-g*u,a._w=p*u+g*_,a._onValueChanged&&a._onValueChanged()},n.rotationMatrix3x3=function(t,e){var r=t.elements,a=r[0],o=r[1],c=r[2],l=r[3],_=r[4],u=r[5],h=r[6],d=r[7],f=r[8],v=a+_+f,p,g;v>0?(p=Math.sqrt(v+1),e._w=p*.5,p=.5/p,e._x=(u-d)*p,e._y=(h-c)*p,e._z=(o-l)*p):a>=_&&a>=f?(p=Math.sqrt(1+a-_-f),g=.5/p,e._x=.5*p,e._y=(o+l)*g,e._z=(c+h)*g,e._w=(u-d)*g):_>f?(p=Math.sqrt(1+_-a-f),g=.5/p,e._x=(l+o)*g,e._y=.5*p,e._z=(d+u)*g,e._w=(h-c)*g):(p=Math.sqrt(1+f-a-_),g=.5/p,e._x=(c+h)*g,e._y=(u+d)*g,e._z=.5*p,e._w=(o-l)*g),e._onValueChanged&&e._onValueChanged()},n.invert=function(t,e){var r=t._x,a=t._y,o=t._z,c=t._w,l=r*r+a*a+o*o+c*c;if(l>k.zeroTolerance){var _=1/l;e._x=-r*_,e._y=-a*_,e._z=-o*_,e._w=c*_,e._onValueChanged&&e._onValueChanged()}},n.lerp=function(t,e,r,a){var o=1-r;n.dot(t,e)>=0?(a._x=t._x*o+e._x*r,a._y=t._y*o+e._y*r,a._z=t._z*o+e._z*r,a._w=t._w*o+e._w*r):(a._x=t._x*o-e._x*r,a._y=t._y*o-e._y*r,a._z=t._z*o-e._z*r,a._w=t._w*o-e._w*r),a.normalize()},n.slerp=function(t,e,r,a){var o,c,l=n.dot(t,e);if(Math.abs(l)>1-k.zeroTolerance)c=1-r,o=r*Math.sign(l);else{var _=Math.acos(Math.abs(l)),u=1/Math.sin(_);c=Math.sin((1-r)*_)*u,o=Math.sin(r*_)*u*Math.sign(l)}a.x=c*t.x+o*e.x,a.y=c*t.y+o*e.y,a.z=c*t.z+o*e.z,a.w=c*t.w+o*e.w,a._onValueChanged&&a._onValueChanged()},n.normalize=function(t,e){var r=t._x,a=t._y,o=t._z,c=t._w,l=Math.sqrt(r*r+a*a+o*o+c*c);l>k.zeroTolerance&&(l=1/l,e._x=r*l,e._y=a*l,e._z=o*l,e._w=c*l,e._onValueChanged&&e._onValueChanged())},n.rotationX=function(t,e){t*=.5;var r=Math.sin(t),a=Math.cos(t);e._x=r,e._y=0,e._z=0,e._w=a,e._onValueChanged&&e._onValueChanged()},n.rotationY=function(t,e){t*=.5;var r=Math.sin(t),a=Math.cos(t);e._x=0,e._y=r,e._z=0,e._w=a,e._onValueChanged&&e._onValueChanged()},n.rotationZ=function(t,e){t*=.5;var r=Math.sin(t),a=Math.cos(t);e._x=0,e._y=0,e._z=r,e._w=a,e._onValueChanged&&e._onValueChanged()},n.rotateX=function(t,e,r){var a=t._x,o=t._y,c=t._z,l=t._w;e*=.5;var _=Math.sin(e),u=Math.cos(e);r._x=a*u+l*_,r._y=o*u+c*_,r._z=c*u-o*_,r._w=l*u-a*_,r._onValueChanged&&r._onValueChanged()},n.rotateY=function(t,e,r){var a=t._x,o=t._y,c=t._z,l=t._w;e*=.5;var _=Math.sin(e),u=Math.cos(e);r._x=a*u-c*_,r._y=o*u+l*_,r._z=c*u+a*_,r._w=l*u-o*_,r._onValueChanged&&r._onValueChanged()},n.rotateZ=function(t,e,r){var a=t._x,o=t._y,c=t._z,l=t._w;e*=.5;var _=Math.sin(e),u=Math.cos(e);r._x=a*u+o*_,r._y=o*u-a*_,r._z=c*u+l*_,r._w=l*u-c*_,r._onValueChanged&&r._onValueChanged()},n.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._z=t._z*e,r._w=t._w*e,r._onValueChanged&&r._onValueChanged()},pa(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this._onValueChanged&&this._onValueChanged()}},{key:"normalized",get:function(){return Math.abs(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w-1)<k.zeroTolerance}},{key:"w",get:function(){return this._w},set:function(t){this._w=t,this._onValueChanged&&this._onValueChanged()}}]),n}();(function(){Re._tempVector3=new R})();(function(){Re._tempQuat1=new Re})();var Z=function(){function n(i,t,e,r,a,o,c,l,_,u,h,d,f,v,p,g){i===void 0&&(i=1),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),a===void 0&&(a=0),o===void 0&&(o=1),c===void 0&&(c=0),l===void 0&&(l=0),_===void 0&&(_=0),u===void 0&&(u=0),h===void 0&&(h=1),d===void 0&&(d=0),f===void 0&&(f=0),v===void 0&&(v=0),p===void 0&&(p=0),g===void 0&&(g=1),this.elements=new Float32Array(16);var y=this.elements;y[0]=i,y[1]=t,y[2]=e,y[3]=r,y[4]=a,y[5]=o,y[6]=c,y[7]=l,y[8]=_,y[9]=u,y[10]=h,y[11]=d,y[12]=f,y[13]=v,y[14]=p,y[15]=g}var s=n.prototype;return s.set=function(t,e,r,a,o,c,l,_,u,h,d,f,v,p,g,y){var m=this.elements;return m[0]=t,m[1]=e,m[2]=r,m[3]=a,m[4]=o,m[5]=c,m[6]=l,m[7]=_,m[8]=u,m[9]=h,m[10]=d,m[11]=f,m[12]=v,m[13]=p,m[14]=g,m[15]=y,this},s.multiply=function(t){return n.multiply(this,t,this),this},s.determinant=function(){var t=this.elements,e=t[0],r=t[1],a=t[2],o=t[3],c=t[4],l=t[5],_=t[6],u=t[7],h=t[8],d=t[9],f=t[10],v=t[11],p=t[12],g=t[13],y=t[14],m=t[15],x=e*l-r*c,C=e*_-a*c,b=e*u-o*c,A=r*_-a*l,S=r*u-o*l,w=a*u-o*_,E=h*g-d*p,P=h*y-f*p,M=h*m-v*p,D=d*y-f*g,L=d*m-v*g,V=f*m-v*y;return x*V-C*L+b*D+A*M-S*P+w*E},s.decompose=function(t,e,r){var a=n._tempMat30,o=this.elements,c=a.elements,l=o[0],_=o[1],u=o[2],h=o[4],d=o[5],f=o[6],v=o[8],p=o[9],g=o[10];t.set(o[12],o[13],o[14]);var y=Math.sqrt(l*l+_*_+u*u),m=Math.sqrt(h*h+d*d+f*f),x=Math.sqrt(v*v+p*p+g*g);if(this.determinant()<0&&(y=-y),r.set(y,m,x),Math.abs(y)<k.zeroTolerance||Math.abs(m)<k.zeroTolerance||Math.abs(x)<k.zeroTolerance)return e.identity(),!1;var C=1/y,b=1/m,A=1/x;return c[0]=l*C,c[1]=_*C,c[2]=u*C,c[3]=h*b,c[4]=d*b,c[5]=f*b,c[6]=v*A,c[7]=p*A,c[8]=g*A,Re.rotationMatrix3x3(a,e),!0},s.getRotation=function(t){var e=this.elements,r=e[0]+e[5]+e[10];if(r>k.zeroTolerance){var a=Math.sqrt(r+1)*2;t._w=.25*a,t._x=(e[6]-e[9])/a,t._y=(e[8]-e[2])/a,t._z=(e[1]-e[4])/a}else if(e[0]>e[5]&&e[0]>e[10]){var o=Math.sqrt(1+e[0]-e[5]-e[10])*2;t._w=(e[6]-e[9])/o,t._x=.25*o,t._y=(e[1]+e[4])/o,t._z=(e[8]+e[2])/o}else if(e[5]>e[10]){var c=Math.sqrt(1+e[5]-e[0]-e[10])*2;t._w=(e[8]-e[2])/c,t._x=(e[1]+e[4])/c,t._y=.25*c,t._z=(e[6]+e[9])/c}else{var l=Math.sqrt(1+e[10]-e[0]-e[5])*2;t._w=(e[1]-e[4])/l,t._x=(e[8]+e[2])/l,t._y=(e[6]+e[9])/l,t._z=.25*l}return t._onValueChanged&&t._onValueChanged(),t},s.getScaling=function(t){var e=this.elements,r=e[0],a=e[1],o=e[2],c=e[4],l=e[5],_=e[6],u=e[8],h=e[9],d=e[10];return t.set(Math.sqrt(r*r+a*a+o*o),Math.sqrt(c*c+l*l+_*_),Math.sqrt(u*u+h*h+d*d)),t},s.getTranslation=function(t){var e=this.elements;return t.set(e[12],e[13],e[14]),t},s.identity=function(){var t=this.elements;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},s.invert=function(){return n.invert(this,this),this},s.rotateAxisAngle=function(t,e){return n.rotateAxisAngle(this,t,e,this),this},s.scale=function(t){return n.scale(this,t,this),this},s.translate=function(t){return n.translate(this,t,this),this},s.transpose=function(){return n.transpose(this,this),this},s.clone=function(){var t=this.elements,e=new n(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]);return e},s.copyFrom=function(t){var e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],this},s.copyFromArray=function(t,e){e===void 0&&(e=0);for(var r=this.elements,a=0;a<16;a++)r[a]=t[a+e];return this},s.copyToArray=function(t,e){e===void 0&&(e=0);var r=this.elements;t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t[e+9]=r[9],t[e+10]=r[10],t[e+11]=r[11],t[e+12]=r[12],t[e+13]=r[13],t[e+14]=r[14],t[e+15]=r[15]},n.multiply=function(t,e,r){var a=t.elements,o=e.elements,c=r.elements,l=a[0],_=a[1],u=a[2],h=a[3],d=a[4],f=a[5],v=a[6],p=a[7],g=a[8],y=a[9],m=a[10],x=a[11],C=a[12],b=a[13],A=a[14],S=a[15],w=o[0],E=o[1],P=o[2],M=o[3],D=o[4],L=o[5],V=o[6],N=o[7],I=o[8],B=o[9],z=o[10],U=o[11],Y=o[12],Q=o[13],H=o[14],te=o[15];c[0]=l*w+d*E+g*P+C*M,c[1]=_*w+f*E+y*P+b*M,c[2]=u*w+v*E+m*P+A*M,c[3]=h*w+p*E+x*P+S*M,c[4]=l*D+d*L+g*V+C*N,c[5]=_*D+f*L+y*V+b*N,c[6]=u*D+v*L+m*V+A*N,c[7]=h*D+p*L+x*V+S*N,c[8]=l*I+d*B+g*z+C*U,c[9]=_*I+f*B+y*z+b*U,c[10]=u*I+v*B+m*z+A*U,c[11]=h*I+p*B+x*z+S*U,c[12]=l*Y+d*Q+g*H+C*te,c[13]=_*Y+f*Q+y*H+b*te,c[14]=u*Y+v*Q+m*H+A*te,c[15]=h*Y+p*Q+x*H+S*te},n.equals=function(t,e){var r=t.elements,a=e.elements;return k.equals(r[0],a[0])&&k.equals(r[1],a[1])&&k.equals(r[2],a[2])&&k.equals(r[3],a[3])&&k.equals(r[4],a[4])&&k.equals(r[5],a[5])&&k.equals(r[6],a[6])&&k.equals(r[7],a[7])&&k.equals(r[8],a[8])&&k.equals(r[9],a[9])&&k.equals(r[10],a[10])&&k.equals(r[11],a[11])&&k.equals(r[12],a[12])&&k.equals(r[13],a[13])&&k.equals(r[14],a[14])&&k.equals(r[15],a[15])},n.lerp=function(t,e,r,a){var o=t.elements,c=e.elements,l=a.elements,_=1-r;l[0]=o[0]*_+c[0]*r,l[1]=o[1]*_+c[1]*r,l[2]=o[2]*_+c[2]*r,l[3]=o[3]*_+c[3]*r,l[4]=o[4]*_+c[4]*r,l[5]=o[5]*_+c[5]*r,l[6]=o[6]*_+c[6]*r,l[7]=o[7]*_+c[7]*r,l[8]=o[8]*_+c[8]*r,l[9]=o[9]*_+c[9]*r,l[10]=o[10]*_+c[10]*r,l[11]=o[11]*_+c[11]*r,l[12]=o[12]*_+c[12]*r,l[13]=o[13]*_+c[13]*r,l[14]=o[14]*_+c[14]*r,l[15]=o[15]*_+c[15]*r},n.add=function(t,e,r){var a=t.elements,o=e.elements,c=r.elements;c[0]=a[0]+o[0],c[1]=a[1]+o[1],c[2]=a[2]+o[2],c[3]=a[3]+o[3],c[4]=a[4]+o[4],c[5]=a[5]+o[5],c[6]=a[6]+o[6],c[7]=a[7]+o[7],c[8]=a[8]+o[8],c[9]=a[9]+o[9],c[10]=a[10]+o[10],c[11]=a[11]+o[11],c[12]=a[12]+o[12],c[13]=a[13]+o[13],c[14]=a[14]+o[14],c[15]=a[15]+o[15]},n.multiplyScalar=function(t,e,r){var a=t.elements,o=r.elements;o[0]=a[0]*e,o[1]=a[1]*e,o[2]=a[2]*e,o[3]=a[3]*e,o[4]=a[4]*e,o[5]=a[5]*e,o[6]=a[6]*e,o[7]=a[7]*e,o[8]=a[8]*e,o[9]=a[9]*e,o[10]=a[10]*e,o[11]=a[11]*e,o[12]=a[12]*e,o[13]=a[13]*e,o[14]=a[14]*e,o[15]=a[15]*e},n.rotationQuaternion=function(t,e){var r=e.elements,a=t._x,o=t._y,c=t._z,l=t._w,_=a+a,u=o+o,h=c+c,d=a*_,f=o*_,v=o*u,p=c*_,g=c*u,y=c*h,m=l*_,x=l*u,C=l*h;r[0]=1-v-y,r[1]=f+C,r[2]=p-x,r[3]=0,r[4]=f-C,r[5]=1-d-y,r[6]=g+m,r[7]=0,r[8]=p+x,r[9]=g-m,r[10]=1-d-v,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},n.rotationAxisAngle=function(t,e,r){var a=r.elements,o=t._x,c=t._y,l=t._z,_=Math.sqrt(o*o+c*c+l*l),u,h,d;Math.abs(_)<k.zeroTolerance||(_=1/_,o*=_,c*=_,l*=_,u=Math.sin(e),h=Math.cos(e),d=1-h,a[0]=o*o*d+h,a[1]=c*o*d+l*u,a[2]=l*o*d-c*u,a[3]=0,a[4]=o*c*d-l*u,a[5]=c*c*d+h,a[6]=l*c*d+o*u,a[7]=0,a[8]=o*l*d+c*u,a[9]=c*l*d-o*u,a[10]=l*l*d+h,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1)},n.rotationTranslation=function(t,e,r){n.rotationQuaternion(t,r);var a=r.elements;a[12]=e._x,a[13]=e._y,a[14]=e._z},n.affineTransformation=function(t,e,r,a){var o=a.elements,c=e._x,l=e._y,_=e._z,u=e._w,h=c+c,d=l+l,f=_+_,v=c*h,p=c*d,g=c*f,y=l*d,m=l*f,x=_*f,C=u*h,b=u*d,A=u*f,S=t._x,w=t._y,E=t._z;o[0]=(1-(y+x))*S,o[1]=(p+A)*S,o[2]=(g-b)*S,o[3]=0,o[4]=(p-A)*w,o[5]=(1-(v+x))*w,o[6]=(m+C)*w,o[7]=0,o[8]=(g+b)*E,o[9]=(m-C)*E,o[10]=(1-(v+y))*E,o[11]=0,o[12]=r._x,o[13]=r._y,o[14]=r._z,o[15]=1},n.scaling=function(t,e){var r=e.elements;r[0]=t._x,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t._y,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=t._z,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},n.translation=function(i,t){var e=t.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=i._x,e[13]=i._y,e[14]=i._z,e[15]=1},n.invert=function(t,e){var r=t.elements,a=e.elements,o=r[0],c=r[1],l=r[2],_=r[3],u=r[4],h=r[5],d=r[6],f=r[7],v=r[8],p=r[9],g=r[10],y=r[11],m=r[12],x=r[13],C=r[14],b=r[15],A=o*h-c*u,S=o*d-l*u,w=o*f-_*u,E=c*d-l*h,P=c*f-_*h,M=l*f-_*d,D=v*x-p*m,L=v*C-g*m,V=v*b-y*m,N=p*C-g*x,I=p*b-y*x,B=g*b-y*C,z=A*B-S*I+w*N+E*V-P*L+M*D;if(!z)return null;z=1/z,a[0]=(h*B-d*I+f*N)*z,a[1]=(l*I-c*B-_*N)*z,a[2]=(x*M-C*P+b*E)*z,a[3]=(g*P-p*M-y*E)*z,a[4]=(d*V-u*B-f*L)*z,a[5]=(o*B-l*V+_*L)*z,a[6]=(C*w-m*M-b*S)*z,a[7]=(v*M-g*w+y*S)*z,a[8]=(u*I-h*V+f*D)*z,a[9]=(c*V-o*I-_*D)*z,a[10]=(m*P-x*w+b*A)*z,a[11]=(p*w-v*P-y*A)*z,a[12]=(h*L-u*N-d*D)*z,a[13]=(o*N-c*L+l*D)*z,a[14]=(x*S-m*E-C*A)*z,a[15]=(v*E-p*S+g*A)*z},n.lookAt=function(t,e,r,a){var o=a.elements,c=n._tempVec30,l=n._tempVec31,_=n._tempVec32;R.subtract(t,e,_),_.normalize(),R.cross(r,_,c),c.normalize(),R.cross(_,c,l),o[0]=c._x,o[1]=l._x,o[2]=_._x,o[3]=0,o[4]=c._y,o[5]=l._y,o[6]=_._y,o[7]=0,o[8]=c._z,o[9]=l._z,o[10]=_._z,o[11]=0,o[12]=-R.dot(c,t),o[13]=-R.dot(l,t),o[14]=-R.dot(_,t),o[15]=1},n.ortho=function(t,e,r,a,o,c,l){var _=l.elements,u=1/(t-e),h=1/(r-a),d=1/(o-c);_[0]=-2*u,_[1]=0,_[2]=0,_[3]=0,_[4]=0,_[5]=-2*h,_[6]=0,_[7]=0,_[8]=0,_[9]=0,_[10]=2*d,_[11]=0,_[12]=(t+e)*u,_[13]=(a+r)*h,_[14]=(c+o)*d,_[15]=1},n.perspective=function(t,e,r,a,o){var c=o.elements,l=1/Math.tan(t/2),_=1/(r-a);c[0]=l/e,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=l,c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[10]=(a+r)*_,c[11]=-1,c[12]=0,c[13]=0,c[14]=2*a*r*_,c[15]=0},n.rotateAxisAngle=function(t,e,r,a){var o=e._x,c=e._y,l=e._z,_=Math.sqrt(o*o+c*c+l*l);if(!(Math.abs(_)<k.zeroTolerance)){var u=t.elements,h=a.elements,d,f,v;_=1/_,o*=_,c*=_,l*=_,d=Math.sin(r),f=Math.cos(r),v=1-f;var p=u[0],g=u[1],y=u[2],m=u[3],x=u[4],C=u[5],b=u[6],A=u[7],S=u[8],w=u[9],E=u[10],P=u[11],M=o*o*v+f,D=c*o*v+l*d,L=l*o*v-c*d,V=o*c*v-l*d,N=c*c*v+f,I=l*c*v+o*d,B=o*l*v+c*d,z=c*l*v-o*d,U=l*l*v+f;h[0]=p*M+x*D+S*L,h[1]=g*M+C*D+w*L,h[2]=y*M+b*D+E*L,h[3]=m*M+A*D+P*L,h[4]=p*V+x*N+S*I,h[5]=g*V+C*N+w*I,h[6]=y*V+b*N+E*I,h[7]=m*V+A*N+P*I,h[8]=p*B+x*z+S*U,h[9]=g*B+C*z+w*U,h[10]=y*B+b*z+E*U,h[11]=m*B+A*z+P*U,t!==a&&(h[12]=u[12],h[13]=u[13],h[14]=u[14],h[15]=u[15])}},n.scale=function(t,e,r){var a=t.elements,o=r.elements,c=e._x,l=e._y,_=e._z;o[0]=a[0]*c,o[1]=a[1]*c,o[2]=a[2]*c,o[3]=a[3]*c,o[4]=a[4]*l,o[5]=a[5]*l,o[6]=a[6]*l,o[7]=a[7]*l,o[8]=a[8]*_,o[9]=a[9]*_,o[10]=a[10]*_,o[11]=a[11]*_,o[12]=a[12],o[13]=a[13],o[14]=a[14],o[15]=a[15]},n.translate=function(t,e,r){var a=t.elements,o=r.elements,c=e._x,l=e._y,_=e._z;if(t===r)o[12]=a[0]*c+a[4]*l+a[8]*_+a[12],o[13]=a[1]*c+a[5]*l+a[9]*_+a[13],o[14]=a[2]*c+a[6]*l+a[10]*_+a[14],o[15]=a[3]*c+a[7]*l+a[11]*_+a[15];else{var u=a[0],h=a[1],d=a[2],f=a[3],v=a[4],p=a[5],g=a[6],y=a[7],m=a[8],x=a[9],C=a[10],b=a[11];o[0]=u,o[1]=h,o[2]=d,o[3]=f,o[4]=v,o[5]=p,o[6]=g,o[7]=y,o[8]=m,o[9]=x,o[10]=C,o[11]=b,o[12]=u*c+v*l+m*_+a[12],o[13]=h*c+p*l+x*_+a[13],o[14]=d*c+g*l+C*_+a[14],o[15]=f*c+y*l+b*_+a[15]}},n.transpose=function(t,e){var r=t.elements,a=e.elements;if(e===t){var o=r[1],c=r[2],l=r[3],_=r[6],u=r[7],h=r[11];a[1]=r[4],a[2]=r[8],a[3]=r[12],a[4]=o,a[6]=r[9],a[7]=r[13],a[8]=c,a[9]=_,a[11]=r[14],a[12]=l,a[13]=u,a[14]=h}else a[0]=r[0],a[1]=r[4],a[2]=r[8],a[3]=r[12],a[4]=r[1],a[5]=r[5],a[6]=r[9],a[7]=r[13],a[8]=r[2],a[9]=r[6],a[10]=r[10],a[11]=r[14],a[12]=r[3],a[13]=r[7],a[14]=r[11],a[15]=r[15]},n}();(function(){Z._tempVec30=new R})();(function(){Z._tempVec31=new R})();(function(){Z._tempVec32=new R})();(function(){Z._tempMat30=new oa})();(function(){Z._identity=new Z(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)})();var ol=function(){function n(i,t){i===void 0&&(i=null),t===void 0&&(t=null),this.origin=new R,this.direction=new R,i&&this.origin.copyFrom(i),t&&this.direction.copyFrom(t)}var s=n.prototype;return s.intersectPlane=function(t){return wt.intersectsRayAndPlane(this,t)},s.intersectSphere=function(t){return wt.intersectsRayAndSphere(this,t)},s.intersectBox=function(t){return wt.intersectsRayAndBox(this,t)},s.getPoint=function(t,e){return R.scale(this.direction,t,e),e.add(this.origin)},n}(),ee=function(){function n(i,t){i===void 0&&(i=0),t===void 0&&(t=0),this._onValueChanged=null,this._x=i,this._y=t}var s=n.prototype;return s.set=function(t,e){return this._x=t,this._y=e,this._onValueChanged&&this._onValueChanged(),this},s.add=function(t){return this._x+=t._x,this._y+=t._y,this._onValueChanged&&this._onValueChanged(),this},s.subtract=function(t){return this._x-=t._x,this._y-=t._y,this._onValueChanged&&this._onValueChanged(),this},s.multiply=function(t){return this._x*=t._x,this._y*=t._y,this._onValueChanged&&this._onValueChanged(),this},s.divide=function(t){return this._x/=t._x,this._y/=t._y,this._onValueChanged&&this._onValueChanged(),this},s.length=function(){var t=this,e=t._x,r=t._y;return Math.sqrt(e*e+r*r)},s.lengthSquared=function(){var t=this,e=t._x,r=t._y;return e*e+r*r},s.negate=function(){return this._x=-this._x,this._y=-this._y,this._onValueChanged&&this._onValueChanged(),this},s.normalize=function(){return n.normalize(this,this),this},s.scale=function(t){return this._x*=t,this._y*=t,this._onValueChanged&&this._onValueChanged(),this},s.clone=function(){return new n(this._x,this._y)},s.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._onValueChanged&&this._onValueChanged(),this},s.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._onValueChanged&&this._onValueChanged(),this},s.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y},s.toJSON=function(){return{x:this._x,y:this._y}},n.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._onValueChanged&&r._onValueChanged()},n.subtract=function(t,e,r){r._x=t._x-e._x,r._y=t._y-e._y,r._onValueChanged&&r._onValueChanged()},n.multiply=function(t,e,r){r._x=t._x*e._x,r._y=t._y*e._y,r._onValueChanged&&r._onValueChanged()},n.divide=function(t,e,r){r._x=t._x/e._x,r._y=t._y/e._y,r._onValueChanged&&r._onValueChanged()},n.dot=function(t,e){return t._x*e._x+t._y*e._y},n.distance=function(t,e){var r=e._x-t._x,a=e._y-t._y;return Math.sqrt(r*r+a*a)},n.distanceSquared=function(t,e){var r=e._x-t._x,a=e._y-t._y;return r*r+a*a},n.equals=function(t,e){return k.equals(t._x,e._x)&&k.equals(t._y,e._y)},n.lerp=function(t,e,r,a){var o=t._x,c=t._y;a._x=o+(e._x-o)*r,a._y=c+(e._y-c)*r,a._onValueChanged&&a._onValueChanged()},n.max=function(t,e,r){r._x=Math.max(t._x,e._x),r._y=Math.max(t._y,e._y),r._onValueChanged&&r._onValueChanged()},n.min=function(t,e,r){r._x=Math.min(t._x,e._x),r._y=Math.min(t._y,e._y),r._onValueChanged&&r._onValueChanged()},n.negate=function(t,e){e._x=-t._x,e._y=-t._y,e._onValueChanged&&e._onValueChanged()},n.normalize=function(t,e){var r=t._x,a=t._y,o=Math.sqrt(r*r+a*a);o>k.zeroTolerance&&(o=1/o,e._x=r*o,e._y=a*o,e._onValueChanged&&e._onValueChanged())},n.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._onValueChanged&&r._onValueChanged()},pa(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}}]),n}();(function(){ee._zero=new ee(0,0)})();(function(){ee._one=new ee(1,1)})();var ie=function(){function n(i,t,e,r){i===void 0&&(i=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),this._onValueChanged=null,this._x=i,this._y=t,this._z=e,this._w=r}var s=n.prototype;return s.set=function(t,e,r,a){return this._x=t,this._y=e,this._z=r,this._w=a,this._onValueChanged&&this._onValueChanged(),this},s.add=function(t){return this._x+=t._x,this._y+=t._y,this._z+=t._z,this._w+=t._w,this._onValueChanged&&this._onValueChanged(),this},s.subtract=function(t){return this._x-=t._x,this._y-=t._y,this._z-=t._z,this._w-=t._w,this._onValueChanged&&this._onValueChanged(),this},s.multiply=function(t){return this._x*=t._x,this._y*=t._y,this._z*=t._z,this._w*=t._w,this._onValueChanged&&this._onValueChanged(),this},s.divide=function(t){return this._x/=t._x,this._y/=t._y,this._z/=t._z,this._w/=t._w,this._onValueChanged&&this._onValueChanged(),this},s.length=function(){var t=this,e=t._x,r=t._y,a=t._z,o=t._w;return Math.sqrt(e*e+r*r+a*a+o*o)},s.lengthSquared=function(){var t=this,e=t._x,r=t._y,a=t._z,o=t._w;return e*e+r*r+a*a+o*o},s.negate=function(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._w=-this._w,this._onValueChanged&&this._onValueChanged(),this},s.normalize=function(){return n.normalize(this,this),this},s.scale=function(t){return this._x*=t,this._y*=t,this._z*=t,this._w*=t,this._onValueChanged&&this._onValueChanged(),this},s.clone=function(){var t=new n(this._x,this._y,this._z,this._w);return t},s.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onValueChanged&&this._onValueChanged(),this},s.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onValueChanged&&this._onValueChanged(),this},s.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w},s.toJSON=function(){return{x:this._x,y:this._y,z:this._z,w:this._w}},n.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._z=t._z+e._z,r._w=t._w+e._w,r._onValueChanged&&r._onValueChanged()},n.subtract=function(t,e,r){r._x=t._x-e._x,r._y=t._y-e._y,r._z=t._z-e._z,r._w=t._w-e._w,r._onValueChanged&&r._onValueChanged()},n.multiply=function(t,e,r){r._x=t._x*e._x,r._y=t._y*e._y,r._z=t._z*e._z,r._w=t._w*e._w,r._onValueChanged&&r._onValueChanged()},n.divide=function(t,e,r){r._x=t._x/e._x,r._y=t._y/e._y,r._z=t._z/e._z,r._w=t._w/e._w,r._onValueChanged&&r._onValueChanged()},n.dot=function(t,e){return t._x*e._x+t._y*e._y+t._z*e._z+t._w*e._w},n.distance=function(t,e){var r=e._x-t._x,a=e._y-t._y,o=e._z-t._z,c=e._w-t._w;return Math.sqrt(r*r+a*a+o*o+c*c)},n.distanceSquared=function(t,e){var r=e._x-t._x,a=e._y-t._y,o=e._z-t._z,c=e._w-t._w;return r*r+a*a+o*o+c*c},n.equals=function(t,e){return k.equals(t._x,e._x)&&k.equals(t._y,e._y)&&k.equals(t._z,e._z)&&k.equals(t._w,e._w)},n.lerp=function(t,e,r,a){var o=t._x,c=t._y,l=t._z,_=t._w;a._x=o+(e._x-o)*r,a._y=c+(e._y-c)*r,a._z=l+(e._z-l)*r,a._w=_+(e._w-_)*r,a._onValueChanged&&a._onValueChanged()},n.max=function(t,e,r){r._x=Math.max(t._x,e._x),r._y=Math.max(t._y,e._y),r._z=Math.max(t._z,e._z),r._w=Math.max(t._w,e._w),r._onValueChanged&&r._onValueChanged()},n.min=function(t,e,r){r._x=Math.min(t._x,e._x),r._y=Math.min(t._y,e._y),r._z=Math.min(t._z,e._z),r._w=Math.min(t._w,e._w),r._onValueChanged&&r._onValueChanged()},n.negate=function(t,e){e._x=-t._x,e._y=-t._y,e._z=-t._z,e._w=-t._w,e._onValueChanged&&e._onValueChanged()},n.normalize=function(t,e){var r=t._x,a=t._y,o=t._z,c=t._w,l=Math.sqrt(r*r+a*a+o*o+c*c);l>k.zeroTolerance&&(l=1/l,e._x=r*l,e._y=a*l,e._z=o*l,e._w=c*l,e._onValueChanged&&e._onValueChanged())},n.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._z=t._z*e,r._w=t._w*e,r._onValueChanged&&r._onValueChanged()},n.transform=function(t,e,r){var a=t._x,o=t._y,c=t._z,l=t._w,_=e.elements;r._x=a*_[0]+o*_[4]+c*_[8]+l*_[12],r._y=a*_[1]+o*_[5]+c*_[9]+l*_[13],r._z=a*_[2]+o*_[6]+c*_[10]+l*_[14],r._w=a*_[3]+o*_[7]+c*_[11]+l*_[15],r._onValueChanged&&r._onValueChanged()},n.transformByQuat=function(t,e,r){var a=t._x,o=t._y,c=t._z,l=t._w,_=e._x,u=e._y,h=e._z,d=e._w,f=d*a+u*c-h*o,v=d*o+h*a-_*c,p=d*c+_*o-u*a,g=-_*a-u*o-h*c;r._x=f*d-g*_-v*h+p*u,r._y=v*d-g*u-p*_+f*h,r._z=p*d-g*h-f*u+v*_,r._w=l,r._onValueChanged&&r._onValueChanged()},pa(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this._onValueChanged&&this._onValueChanged()}},{key:"w",get:function(){return this._w},set:function(t){this._w=t,this._onValueChanged&&this._onValueChanged()}}]),n}();(function(){ie._zero=new ie(0,0,0,0)})();(function(){ie._one=new ie(1,1,1,1)})();var q=function(){function n(i,t,e,r){i===void 0&&(i=1),t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),this._onValueChanged=null,this._r=i,this._g=t,this._b=e,this._a=r}var s=n.prototype;return s.set=function(t,e,r,a){return this._r=t,this._g=e,this._b=r,this._a=a,this._onValueChanged&&this._onValueChanged(),this},s.add=function(t){return this._r+=t._r,this._g+=t._g,this._b+=t._b,this._a+=t._a,this._onValueChanged&&this._onValueChanged(),this},s.scale=function(t){return this._r*=t,this._g*=t,this._b*=t,this._a*=t,this._onValueChanged&&this._onValueChanged(),this},s.clone=function(){var t=new n(this._r,this._g,this._b,this._a);return t},s.copyFrom=function(t){return this._r=t.r,this._g=t.g,this._b=t.b,this._a=t.a,this._onValueChanged&&this._onValueChanged(),this},s.copyFromArray=function(t,e){return e===void 0&&(e=0),this._r=t[e],this._g=t[e+1],this._b=t[e+2],this._a=t[e+3],this._onValueChanged&&this._onValueChanged(),this},s.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._r,t[e+1]=this._g,t[e+2]=this._b,t[e+3]=this._a},s.toLinear=function(t){return t._r=n.gammaToLinearSpace(this._r),t._g=n.gammaToLinearSpace(this._g),t._b=n.gammaToLinearSpace(this._b),this._onValueChanged&&this._onValueChanged(),t},s.toGamma=function(t){return t._r=n.linearToGammaSpace(this._r),t._g=n.linearToGammaSpace(this._g),t._b=n.linearToGammaSpace(this._b),this._onValueChanged&&this._onValueChanged(),t},s.getBrightness=function(){var t=this.r,e=this.g,r=this.b,a=t,o=t;return e>a&&(a=e),r>a&&(a=r),e<o&&(o=e),r<o&&(o=r),(a+o)/2},s.toJSON=function(){return{r:this._r,g:this._g,b:this._b,a:this._a}},n.gammaToLinearSpace=function(t){return t<=0?0:t<=.04045?t/12.92:t<1?Math.pow((t+.055)/1.055,2.4):Math.pow(t,2.4)},n.linearToGammaSpace=function(t){return t<=0?0:t<.0031308?12.92*t:t<1?1.055*Math.pow(t,.41666)-.055:Math.pow(t,.41666)},n.equals=function(t,e){return k.equals(t._r,e._r)&&k.equals(t._g,e._g)&&k.equals(t._b,e._b)&&k.equals(t._a,e._a)},n.add=function(t,e,r){return r._r=t._r+e._r,r._g=t._g+e._g,r._b=t._b+e._b,r._a=t._a+e._a,r._onValueChanged&&r._onValueChanged(),r},n.subtract=function(t,e,r){r._r=t._r-e._r,r._g=t._g-e._g,r._b=t._b-e._b,r._a=t._a-e._a,r._onValueChanged&&r._onValueChanged()},n.scale=function(t,e,r){return r._r=t._r*e,r._g=t._g*e,r._b=t._b*e,r._a=t._a*e,r._onValueChanged&&r._onValueChanged(),r},n.lerp=function(t,e,r,a){var o=t._r,c=t._g,l=t._b,_=t._a;return a._r=o+(e._r-o)*r,a._g=c+(e._g-c)*r,a._b=l+(e._b-l)*r,a._a=_+(e._a-_)*r,a._onValueChanged&&a._onValueChanged(),a},pa(n,[{key:"r",get:function(){return this._r},set:function(t){this._r=t,this._onValueChanged&&this._onValueChanged()}},{key:"g",get:function(){return this._g},set:function(t){this._g=t,this._onValueChanged&&this._onValueChanged()}},{key:"b",get:function(){return this._b},set:function(t){this._b=t,this._onValueChanged&&this._onValueChanged()}},{key:"a",get:function(){return this._a},set:function(t){this._a=t,this._onValueChanged&&this._onValueChanged()}}]),n}(),Gr=function(){function n(i,t,e,r){i===void 0&&(i=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),this._onValueChanged=null,this._x=i,this._y=t,this._width=e,this._height=r}var s=n.prototype;return s.set=function(t,e,r,a){return this._x=t,this._y=e,this._width=r,this._height=a,this._onValueChanged&&this._onValueChanged(),this},s.clone=function(){return new n(this.x,this.y,this.width,this.height)},s.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._width=t.width,this._height=t.height,this._onValueChanged&&this._onValueChanged(),this},pa(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._onValueChanged&&this._onValueChanged()}},{key:"height",get:function(){return this._height},set:function(t){this._height=t,this._onValueChanged&&this._onValueChanged()}}]),n}(),sl=function(){function n(){this.coefficients=new Float32Array(27)}var s=n.prototype;return s.addLight=function(t,e,r){e.scale(r);var a=this.coefficients,o=t._x,c=t._y,l=t._z,_=e.r,u=e.g,h=e.b,d=.282095,f=-.488603*c,v=.488603*l,p=-.488603*o,g=1.092548*(o*c),y=-1.092548*(c*l),m=.315392*(3*l*l-1),x=-1.092548*(o*l),C=.546274*(o*o-c*c);a[0]+=_*d,a[1]+=u*d,a[2]+=h*d,a[3]+=_*f,a[4]+=u*f,a[5]+=h*f,a[6]+=_*v,a[7]+=u*v,a[8]+=h*v,a[9]+=_*p,a[10]+=u*p,a[11]+=h*p,a[12]+=_*g,a[13]+=u*g,a[14]+=h*g,a[15]+=_*y,a[16]+=u*y,a[17]+=h*y,a[18]+=_*m,a[19]+=u*m,a[20]+=h*m,a[21]+=_*x,a[22]+=u*x,a[23]+=h*x,a[24]+=_*C,a[25]+=u*C,a[26]+=h*C},s.evaluate=function(t,e){var r=this.coefficients,a=t._x,o=t._y,c=t._z,l=.886227,_=-1.023327*o,u=1.023327*c,h=-1.023327*a,d=.858086*o*a,f=-.858086*o*c,v=.247708*(3*c*c-1),p=-.858086*c*a,g=.429042*(a*a-o*o),y=r[0]*l,m=r[1]*l,x=r[2]*l;return y+=r[3]*_+r[6]*u+r[9]*h,m+=r[4]*_+r[7]*u+r[10]*h,x+=r[5]*_+r[8]*u+r[11]*h,y+=r[12]*d+r[15]*f+r[18]*v+r[21]*p+r[24]*g,m+=r[13]*d+r[16]*f+r[19]*v+r[22]*p+r[25]*g,x+=r[14]*d+r[17]*f+r[20]*v+r[23]*p+r[26]*g,e.set(y,m,x,1),e},s.scale=function(t){var e=this.coefficients;e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e[4]*=t,e[5]*=t,e[6]*=t,e[7]*=t,e[8]*=t,e[9]*=t,e[10]*=t,e[11]*=t,e[12]*=t,e[13]*=t,e[14]*=t,e[15]*=t,e[16]*=t,e[17]*=t,e[18]*=t,e[19]*=t,e[20]*=t,e[21]*=t,e[22]*=t,e[23]*=t,e[24]*=t,e[25]*=t,e[26]*=t},s.clone=function(){var t=new n;return t.copyFrom(this),t},s.copyFrom=function(t){return t.copyToArray(this.coefficients),this},s.copyFromArray=function(t,e){e===void 0&&(e=0);var r=this.coefficients;r[0]=t[e],r[1]=t[1+e],r[2]=t[2+e],r[3]=t[3+e],r[4]=t[4+e],r[5]=t[5+e],r[6]=t[6+e],r[7]=t[7+e],r[8]=t[8+e],r[9]=t[9+e],r[10]=t[10+e],r[11]=t[11+e],r[12]=t[12+e],r[13]=t[13+e],r[14]=t[14+e],r[15]=t[15+e],r[16]=t[16+e],r[17]=t[17+e],r[18]=t[18+e],r[19]=t[19+e],r[20]=t[20+e],r[21]=t[21+e],r[22]=t[22+e],r[23]=t[23+e],r[24]=t[24+e],r[25]=t[25+e],r[26]=t[26+e]},s.copyToArray=function(t,e){e===void 0&&(e=0);var r=this.coefficients;t[0+e]=r[0],t[1+e]=r[1],t[2+e]=r[2],t[3+e]=r[3],t[4+e]=r[4],t[5+e]=r[5],t[6+e]=r[6],t[7+e]=r[7],t[8+e]=r[8],t[9+e]=r[9],t[10+e]=r[10],t[11+e]=r[11],t[12+e]=r[12],t[13+e]=r[13],t[14+e]=r[14],t[15+e]=r[15],t[16+e]=r[16],t[17+e]=r[17],t[18+e]=r[18],t[19+e]=r[19],t[20+e]=r[20],t[21+e]=r[21],t[22+e]=r[22],t[23+e]=r[23],t[24+e]=r[24],t[25+e]=r[25],t[26+e]=r[26]},n}(),mr=function(){function n(i,t){this.reset(i,t)}var s=n.prototype;return s.randomInt32=function(){var t=this._state0,e=this._state1;return this._state0=e,t^=t<<23,t^=t>>>17,t^=e^e>>>26,this._state1=t,this._state0+this._state1>>>0},s.random=function(){return this.randomInt32()/4294967295},s.reset=function(t,e){this._state0=t>>>0,this._state1=e>>>0},n}(),Nt;(function(n){n[n.Android=0]="Android",n[n.IPhone=1]="IPhone",n[n.IPad=2]="IPad",n[n.Mac=3]="Mac",n[n.Unknown=4]="Unknown"})(Nt||(Nt={}));function ce(n){if(n===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}function jo(n,s){for(var i=0;i<s.length;i++){var t=s[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function j(n,s,i){return s&&jo(n.prototype,s),i&&jo(n,i),n}function ao(n,s){return ao=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},ao(n,s)}function W(n,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(s&&s.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),s&&ao(n,s)}var ct;(function(n){n[n.None=0]="None",n[n.VisibleInsideMask=1]="VisibleInsideMask",n[n.VisibleOutsideMask=2]="VisibleOutsideMask"})(ct||(ct={}));var sa;(function(n){n[n.Layer0=1]="Layer0",n[n.Layer1=2]="Layer1",n[n.Layer2=4]="Layer2",n[n.Layer3=8]="Layer3",n[n.Layer4=16]="Layer4",n[n.Layer5=32]="Layer5",n[n.Layer6=64]="Layer6",n[n.Layer7=128]="Layer7",n[n.Layer8=256]="Layer8",n[n.Layer9=512]="Layer9",n[n.Layer10=1024]="Layer10",n[n.Layer11=2048]="Layer11",n[n.Layer12=4096]="Layer12",n[n.Layer13=8192]="Layer13",n[n.Layer14=16384]="Layer14",n[n.Layer15=32768]="Layer15",n[n.Layer16=65536]="Layer16",n[n.Layer17=131072]="Layer17",n[n.Layer18=262144]="Layer18",n[n.Layer19=524288]="Layer19",n[n.Layer20=1048576]="Layer20",n[n.Layer21=2097152]="Layer21",n[n.Layer22=4194304]="Layer22",n[n.Layer23=8388608]="Layer23",n[n.Layer24=16777216]="Layer24",n[n.Layer25=33554432]="Layer25",n[n.Layer26=67108864]="Layer26",n[n.Layer27=134217728]="Layer27",n[n.Layer28=268435456]="Layer28",n[n.Layer29=536870912]="Layer29",n[n.Layer30=1073741824]="Layer30",n[n.Layer31=2147483648]="Layer31",n[n.Everything=4294967295]="Everything"})(sa||(sa={}));var Nn;(function(n){n[n.Left=0]="Left",n[n.Center=1]="Center",n[n.Right=2]="Right"})(Nn||(Nn={}));var In;(function(n){n[n.Top=0]="Top",n[n.Center=1]="Center",n[n.Bottom=2]="Bottom"})(In||(In={}));var Gn;(function(n){n[n.Overflow=0]="Overflow",n[n.Truncate=1]="Truncate"})(Gn||(Gn={}));var xn;(function(n){n[n.None=0]="None",n[n.Bold=1]="Bold",n[n.Italic=2]="Italic"})(xn||(xn={}));function T(n,s,i,t){var e=arguments.length,r=e<3?s:t===null?t=Object.getOwnPropertyDescriptor(s,i):t,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(n,s,i,t);else for(var o=n.length-1;o>=0;o--)(a=n[o])&&(r=(e<3?a(r):e>3?a(s,i,r):a(s,i))||r);return e>3&&r&&Object.defineProperty(s,i,r),r}function lt(n,s){return s!=null&&typeof Symbol<"u"&&s[Symbol.hasInstance]?!!s[Symbol.hasInstance](n):n instanceof s}var on;(function(n){n[n.Ignore=0]="Ignore",n[n.Assignment=1]="Assignment",n[n.Shallow=2]="Shallow",n[n.Deep=3]="Deep"})(on||(on={}));function F(n,s){Ar.registerCloneMode(n,s,on.Ignore)}function Me(n,s){Ar.registerCloneMode(n,s,on.Assignment)}function Eo(n,s){Ar.registerCloneMode(n,s,on.Shallow)}function J(n,s){Ar.registerCloneMode(n,s,on.Deep)}var Ar=function(){function n(){}return n.registerCloneMode=function(i,t,e){var r=n._subCloneModeMap.get(i.constructor);r||(r=Object.create(null),n._subCloneModeMap.set(i.constructor,r)),r[t]=e},n.getCloneMode=function(i){var t=n._cloneModeMap.get(i);if(!t){t=Object.create(null),n._cloneModeMap.set(i,t);for(var e=n._objectType,r=n._subCloneModeMap;i!==e;){var a=r.get(i);a&&Object.assign(t,a),i=Object.getPrototypeOf(i)}}return t},n.cloneProperty=function(i,t,e,r,a,o,c){if(r!==on.Ignore){var l=i[e];if(lt(l,Object)){if(r===void 0||r===on.Assignment){t[e]=l;return}var _=l.constructor;switch(_){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:var u=t[e];u==null||u.length!==l.length?t[e]=l.slice():u.set(l);break;case Array:var h=t[e],d=l.length;h==null?t[e]=h=new Array(d):h.length=d;for(var f=0;f<d;f++)n.cloneProperty(l,h,f,r,a,o,c);break;default:var v=t[e];if(v||(v=c.get(l),v||(v=new l.constructor,c.set(l,v)),t[e]=v),l.copyFrom)v.copyFrom(l);else{var p=n.getCloneMode(l.constructor);for(var g in l)n.cloneProperty(l,v,g,p[g],a,o,c);l._cloneTo&&l._cloneTo(v,a,o)}break}}else t[e]=l}},n.deepCloneObject=function(i,t,e){for(var r in i)n.cloneProperty(i,t,r,on.Deep,null,null,e)},n}();(function(){Ar._subCloneModeMap=new Map})();(function(){Ar._cloneModeMap=new Map})();(function(){Ar._objectType=Object.getPrototypeOf(Object)})();var Yr=function(){function n(i){this.instanceId=++n._instanceIdCounter,this._destroyed=!1,this._engine=i}var s=n.prototype;return s.destroy=function(){this._destroyed||(this._onDestroy(),this._destroyed=!0)},s._onDestroy=function(){var t=this._engine.resourceManager;t._deleteAsset(this),t._deleteContentRestorer(this)},j(n,[{key:"engine",get:function(){return this._engine}},{key:"destroyed",get:function(){return this._destroyed}}]),n}();(function(){Yr._instanceIdCounter=0})();T([F],Yr.prototype,"instanceId",void 0);T([F],Yr.prototype,"_engine",void 0);var Qr=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e.isGCIgnored=!1,e._refCount=0,e._superResources=null,t.resourceManager._addReferResource(ce(e)),e}var i=s.prototype;return i.destroy=function(e,r){if(e===void 0&&(e=!1),!e){var a;if(this._refCount!==0)return!1;var o=this._superResources;if((a=o)!=null&&a.length)if(r){for(var c=0,l=o.length;c<l;c++)if(o[c].refCount>0)return!1}else return!1}return n.prototype.destroy.call(this),!0},i._associationSuperResource=function(e){(this._superResources||(this._superResources=[])).push(e)},i._disassociationSuperResource=function(e){var r=this._superResources,a=r.indexOf(e);r.splice(a,1)},i._getReferCount=function(){return this._refCount},i._addReferCount=function(e){this._refCount+=e},i._addToResourceManager=function(e){this._engine.resourceManager._addAsset(e,this)},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._engine.resourceManager._deleteReferResource(this);var e=this._getReferCount();e>0&&this._addReferCount(-e)},j(s,[{key:"refCount",get:function(){return this._refCount}}]),s}(Yr),bc=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._sprites=new Array,e._spriteNamesToIndex={},e}var i=s.prototype;return i.getSprite=function(e){var r=this._sprites[this._spriteNamesToIndex[e]];return r||console.warn("There is no sprite named "+e+" in the atlas."),r},i.getSprites=function(e,r){r.length=0;var a=this._spriteNamesToIndex[e];if(a!==void 0)for(var o=this._sprites;a>=0;a--){var c=o[a];c.name===e&&r.push(c)}else console.warn("The name of the sprite you want to find is not exit in SpriteAtlas.");return r},i._addSprite=function(e){this._spriteNamesToIndex[e.name]=this._sprites.push(e)-1,e._atlas=this,e.isGCIgnored=!0},i._onDestroy=function(){n.prototype._onDestroy.call(this);for(var e=this,r=e._sprites,a=0,o=r.length;a<o;a++)r[a].destroy();r.length=0,this._sprites=null,this._spriteNamesToIndex=null},j(s,[{key:"sprites",get:function(){return this._sprites}}]),s}(Qr),fr;(function(n){n[n.Simple=0]="Simple",n[n.Sliced=1]="Sliced",n[n.Tiled=2]="Tiled"})(fr||(fr={}));var Ra;(function(n){n[n.Continuous=0]="Continuous",n[n.Adaptive=1]="Adaptive"})(Ra||(Ra={}));var Ue=function(){function n(){}return n.removeFromArray=function(i,t){var e=i.indexOf(t);if(e<0)return!1;var r=i.length-1;if(e!==r){var a=i[r];i[e]=a}return i.length--,!0},n.decodeText=function(i){if(typeof TextDecoder<"u")return new TextDecoder().decode(i);for(var t="",e=0,r=i.length;e<r;e++)t+=String.fromCharCode(i[e]);return decodeURIComponent(encodeURIComponent(t))},n.isAbsoluteUrl=function(i){return/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(i)},n.isBase64Url=function(i){return/^data:.*,.*$/i.test(i)},n.objectValues=function(i){return Object.keys(i).map(function(t){return i[t]})},n.resolveAbsoluteUrl=function(i,t){return n.isAbsoluteUrl(t)||n.isBase64Url(t)?t:t?new URL(t,i).href:i},n._floatMatrixMultiply=function(i,t,e,r,a){var o=i.elements,c=o[0],l=o[1],_=o[2],u=o[3],h=o[4],d=o[5],f=o[6],v=o[7],p=o[8],g=o[9],y=o[10],m=o[11],x=o[12],C=o[13],b=o[14],A=o[15],S=t[e],w=t[e+1],E=t[e+2],P=t[e+3],M=t[e+4],D=t[e+5],L=t[e+6],V=t[e+7],N=t[e+8],I=t[e+9],B=t[e+10],z=t[e+11],U=t[e+12],Y=t[e+13],Q=t[e+14],H=t[e+15];r[a]=c*S+h*w+p*E+x*P,r[a+1]=l*S+d*w+g*E+C*P,r[a+2]=_*S+f*w+y*E+b*P,r[a+3]=u*S+v*w+m*E+A*P,r[a+4]=c*M+h*D+p*L+x*V,r[a+5]=l*M+d*D+g*L+C*V,r[a+6]=_*M+f*D+y*L+b*V,r[a+7]=u*M+v*D+m*L+A*V,r[a+8]=c*N+h*I+p*B+x*z,r[a+9]=l*N+d*I+g*B+C*z,r[a+10]=_*N+f*I+y*B+b*z,r[a+11]=u*N+v*I+m*B+A*z,r[a+12]=c*U+h*Y+p*Q+x*H,r[a+13]=l*U+d*Y+g*Q+C*H,r[a+14]=_*U+f*Y+y*Q+b*H,r[a+15]=u*U+v*Y+m*Q+A*H},n._reflectGet=function(i,t){for(var e=this._stringToPath(t),r=i,a=0,o=e.length;r!=null&&a<o;)r=r[e[a++]];return a&&a==o?r:void 0},n._quickSort=function(i,t,e,r){for(;;){if(e-t<=10){this._insertionSort(i,t,e,r);return}var a=t+e>>1,o=i[t],c=i[e-1],l=i[a],_=r(o,c);if(_>0){var u=o;o=c,c=u}var h=r(o,l);if(h>=0){var d=o;o=l,l=c,c=d}else{var f=r(c,l);if(f>0){var v=c;c=l,l=v}}i[t]=o,i[e-1]=l;var p=c,g=t+1,y=e-1;i[a]=i[g],i[g]=p;e:for(var m=g+1;m<y;m++){var x=i[m],C=r(x,p);if(C<0)i[m]=i[g],i[g]=x,g++;else if(C>0){do{if(y--,y==m)break e;var b=i[y];C=r(b,p)}while(C>0);i[m]=i[y],i[y]=x,C<0&&(x=i[m],i[m]=i[g],i[g]=x,g++)}}e-y<g-t?(this._quickSort(i,y,e,r),e=g):(this._quickSort(i,t,g,r),t=y)}},n._stringToPath=function(i){var t=[];return i.charCodeAt(0)===cl&&t.push(""),i.replace(_l,function(e,r,a,o){var c=e;a?c=o.replace(ll,"$1"):r&&(c=r.trim()),t.push(c)}),t},n._insertionSort=function(i,t,e,r){for(var a=t+1;a<e;a++){var o=void 0,c=i[a];for(o=a-1;o>=t;o--){var l=i[o],_=r(l,c);if(_>0)i[o+1]=l;else break}i[o+1]=c}},n}(),cl=46,ll=/\\(\\)?/g,_l=RegExp(`[^.[\\]]+|\\[(?:([^"'][^[]*)|(["'])((?:(?!\\2)[^\\\\]|\\\\.)*?)\\2)\\]|(?=(?:\\.|\\[\\])(?:\\.|\\[\\]|$))`,"g"),Er=function(){function n(){this._updateFlags=[],this._listeners=[]}var s=n.prototype;return s.createFlag=function(t){var e=new t;return this.addFlag(e),e},s.addFlag=function(t){this._updateFlags.push(t),t._flagManagers.push(this)},s.removeFlag=function(t){var e=Ue.removeFromArray(this._updateFlags,t);e&&Ue.removeFromArray(t._flagManagers,this)},s.addListener=function(t){this._listeners.push(t)},s.removeListener=function(t){Ue.removeFromArray(this._listeners,t)},s.dispatch=function(t,e){for(var r=this._updateFlags,a=r.length-1;a>=0;a--)r[a].dispatch(t,e);for(var o=this._listeners,c=o.length-1;c>=0;c--)o[c](t,e)},n}(),we;(function(n){n[n.texture=1]="texture",n[n.size=2]="size",n[n.atlasRotate=4]="atlasRotate",n[n.atlasRegion=8]="atlasRegion",n[n.atlasRegionOffset=16]="atlasRegionOffset",n[n.region=32]="region",n[n.pivot=64]="pivot",n[n.border=128]="border",n[n.destroy=256]="destroy"})(we||(we={}));var vi=function(n){W(s,n);function s(t,e,r,a,o,c){e===void 0&&(e=null),r===void 0&&(r=null),a===void 0&&(a=null),o===void 0&&(o=null),c===void 0&&(c=null);var l;return l=n.call(this,t)||this,l._automaticWidth=0,l._automaticHeight=0,l._customWidth=void 0,l._customHeight=void 0,l._positions=[new ee,new ee,new ee,new ee],l._uvs=[new ee,new ee,new ee,new ee],l._bounds=new lr,l._texture=null,l._atlasRotated=!1,l._atlasRegion=new Gr(0,0,1,1),l._atlasRegionOffset=new ie(0,0,0,0),l._region=new Gr(0,0,1,1),l._pivot=new ee(.5,.5),l._border=new ie(0,0,0,0),l._dirtyUpdateFlag=7,l._updateFlagManager=new Er,l._texture=e,l._onRegionChange=l._onRegionChange.bind(ce(l)),l._onPivotChange=l._onPivotChange.bind(ce(l)),l._onBorderChange=l._onBorderChange.bind(ce(l)),l._region._onValueChanged=l._onRegionChange,l._pivot._onValueChanged=l._onPivotChange,l._border._onValueChanged=l._onBorderChange,r&&l._region.copyFrom(r),a&&l._pivot.copyFrom(a),o&&l._border.copyFrom(o),l.name=c,l}var i=s.prototype;return i.clone=function(){var e=new s(this._engine,this._texture,this._region,this._pivot,this._border,this.name);return e._atlasRotated=this._atlasRotated,e._atlasRegion.copyFrom(this._atlasRegion),e._atlasRegionOffset.copyFrom(this._atlasRegionOffset),e},i._getPositions=function(){return this._dirtyUpdateFlag&1&&this._updatePositions(),this._positions},i._getUVs=function(){return this._dirtyUpdateFlag&2&&this._updateUVs(),this._uvs},i._getBounds=function(){return this._dirtyUpdateFlag&1&&this._updatePositions(),this._bounds},i._addReferCount=function(e){var r;n.prototype._addReferCount.call(this,e),(r=this._atlas)==null||r._addReferCount(e)},i._onDestroy=function(){this._dispatchSpriteChange(we.destroy),n.prototype._onDestroy.call(this),this._positions.length=0,this._positions=null,this._uvs.length=0,this._uvs=null,this._atlasRegion=null,this._atlasRegionOffset=null,this._region=null,this._pivot=null,this._border=null,this._bounds=null,this._atlas=null,this._texture=null,this._updateFlagManager=null},i._calDefaultSize=function(){if(this._texture){var e=this,r=e._texture,a=e._atlasRegion,o=e._atlasRegionOffset,c=e._region,l=1/hn._pixelsPerUnit;this._automaticWidth=r.width*a.width/(1-o.x-o.z)*c.width*l,this._automaticHeight=r.height*a.height/(1-o.y-o.w)*c.height*l}else this._automaticWidth=this._automaticHeight=0;this._dirtyUpdateFlag&=-5},i._updatePositions=function(){var e=this._atlasRegionOffset,r=this._region,a=r.x,o=r.y,c=r.width,l=r.height,_=1-a-c,u=1-o-l,h=Math.max(e.x-a,0)/c,d=Math.max(e.w-o,0)/l,f=1-Math.max(e.z-_,0)/c,v=1-Math.max(e.y-u,0)/l,p=this._positions;p[0].set(h,d),p[1].set(f,d),p[2].set(h,v),p[3].set(f,v);var g=this._bounds,y=g.min,m=g.max;y.set(h,d,0),m.set(f,v,0),this._dirtyUpdateFlag&=-2},i._updateUVs=function(){var e=this,r=e._uvs,a=e._atlasRegionOffset,o=this._region,c=o.x,l=o.y,_=o.width,u=o.height,h=1-c-_,d=1-l-u,f=this._atlasRegion,v=f.x,p=f.y,g=f.width,y=f.height,m=a.x,x=a.y,C=a.z,b=a.w,A=g/(1-m-C),S=y/(1-x-b),w=Math.max(c-m,0)*A+v,E=Math.max(d-x,0)*S+p,P=g+v-Math.max(h-C,0)*A,M=y+p-Math.max(l-b,0)*S,D=this._border,L=D.x,V=D.y,N=D.z,I=D.w;r[0].set(w,M),r[1].set((c-m+L*_)*A+v,y+p-(l-b+V*u)*S),r[2].set(g+v-(h-C+N*_)*A,(d-x+I*u)*S+p),r[3].set(P,E),this._dirtyUpdateFlag&=-3},i._dispatchSpriteChange=function(e){switch(e){case we.texture:this._dirtyUpdateFlag|=4;break;case we.atlasRegionOffset:case we.region:this._dirtyUpdateFlag|=7;break;case we.atlasRegion:this._dirtyUpdateFlag|=6;break;case we.border:this._dirtyUpdateFlag|=2;break}this._updateFlagManager.dispatch(e)},i._onRegionChange=function(){var e=this,r=e._region;r._onValueChanged=null;var a=k.clamp(r.x,0,1),o=k.clamp(r.y,0,1);r.set(a,o,k.clamp(r.width,0,1-a),k.clamp(r.height,0,1-o)),this._dispatchSpriteChange(we.region),(this._customWidth===void 0||this._customHeight===void 0)&&this._dispatchSpriteChange(we.size),r._onValueChanged=this._onRegionChange},i._onPivotChange=function(){this._dispatchSpriteChange(we.pivot)},i._onBorderChange=function(){var e=this,r=e._border;r._onValueChanged=null;var a=k.clamp(r.x,0,1),o=k.clamp(r.y,0,1);r.set(a,o,k.clamp(r.z,0,1-a),k.clamp(r.w,0,1-o)),this._dispatchSpriteChange(we.border),r._onValueChanged=this._onBorderChange},j(s,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture!==e&&(this._texture=e,this._dispatchSpriteChange(we.texture),(this._customWidth===void 0||this._customHeight===void 0)&&this._dispatchSpriteChange(we.size))}},{key:"width",get:function(){return this._customWidth!==void 0?this._customWidth:(this._dirtyUpdateFlag&4&&this._calDefaultSize(),this._automaticWidth)},set:function(e){this._customWidth!==e&&(this._customWidth=e,this._dispatchSpriteChange(we.size))}},{key:"height",get:function(){return this._customHeight!==void 0?this._customHeight:(this._dirtyUpdateFlag&4&&this._calDefaultSize(),this._automaticHeight)},set:function(e){this._customHeight!==e&&(this._customHeight=e,this._dispatchSpriteChange(we.size))}},{key:"atlasRotated",get:function(){return this._atlasRotated},set:function(e){this._atlasRotated!=e&&(this._atlasRotated=e)}},{key:"atlasRegion",get:function(){return this._atlasRegion},set:function(e){var r=k.clamp(e.x,0,1),a=k.clamp(e.y,0,1);this._atlasRegion.set(r,a,k.clamp(e.width,0,1-r),k.clamp(e.height,0,1-a)),this._dispatchSpriteChange(we.atlasRegion),(this._customWidth===void 0||this._customHeight===void 0)&&this._dispatchSpriteChange(we.size)}},{key:"atlasRegionOffset",get:function(){return this._atlasRegionOffset},set:function(e){var r=k.clamp(e.x,0,1),a=k.clamp(e.y,0,1);this._atlasRegionOffset.set(r,a,k.clamp(e.z,0,1-r),k.clamp(e.w,0,1-a)),this._dispatchSpriteChange(we.atlasRegionOffset),(this._customWidth===void 0||this._customHeight===void 0)&&this._dispatchSpriteChange(we.size)}},{key:"region",get:function(){return this._region},set:function(e){this._region!==e&&this._region.copyFrom(e)}},{key:"pivot",get:function(){return this._pivot},set:function(e){this._pivot!==e&&this._pivot.copyFrom(e)}},{key:"border",get:function(){return this._border},set:function(e){this._border!==e&&this._border.copyFrom(e)}}]),s}(Qr),qo;(function(n){n[n.positions=1]="positions",n[n.uvs=2]="uvs",n[n.automaticSize=4]="automaticSize",n[n.all=7]="all"})(qo||(qo={}));var wo=function(){function n(){this._events=Object.create(null),this._eventCount=0}var s=n.prototype;return s.hasEvent=function(t){return this._events[t]!=null},s.eventNames=function(){return this._eventCount===0?[]:Object.keys(this._events)},s.listenerCount=function(t){var e=this._events[t];return e?Array.isArray(e)?e.length:1:0},s.dispatch=function(t,e){if(!this._events[t])return!1;var r=this._events[t];if(Array.isArray(r)){var a=r.length,o=n._dispatchingListenersPool,c=o.length>0?o.pop():[];c.length=a;for(var l=0;l<a;l++)c[l]=r[l];for(var _=0;_<a;_++){var u=c[_];u.destroyed||(u.once&&this.off(t,u.fn),u.fn(e))}c.length=0,o.push(c)}else r.once&&this.off(t,r.fn),r.fn(e);return!0},s.on=function(t,e){return this._addEventListener(t,e)},s.once=function(t,e){return this._addEventListener(t,e,!0)},s.off=function(t,e){if(!this._events[t])return this;if(!e)return this._clearEvent(t),this;var r=this._events[t],a=Array.isArray(r);if(!a&&r.fn===e)this._clearEvent(t);else if(a){for(var o=r.length-1;o>=0;o--)r[o].fn===e&&(r[o].destroyed=!0,r.splice(o,1));r.length===0?this._clearEvent(t):r.length===1&&(this._events[t]=r[0])}return this},s.removeEventListener=function(t,e){return this.off(t,e)},s.removeAllEventListeners=function(t){t?this._events[t]&&this._clearEvent(t):(this._events=Object.create(null),this._eventCount=0)},s._addEventListener=function(t,e,r){var a={fn:e,once:r},o=this._events,c=o[t];return c?Array.isArray(c)?c.push(a):o[t]=[c,a]:(o[t]=a,this._eventCount++),this},s._clearEvent=function(t){--this._eventCount===0?this._events=Object.create(null):delete this._events[t]},n}();(function(){wo._dispatchingListenersPool=[]})();var gn=function(n){for(var s=arguments.length,i=new Array(s>1?s-1:0),t=1;t<s;t++)i[t-1]=arguments[t]},ul=console.log.bind(console),hl=console.info.bind(console),dl=console.warn.bind(console),fl=console.error.bind(console),ve={debug:gn,info:gn,warn:gn,error:gn,isEnabled:!1,enable:function(){this.debug=ul,this.info=hl,this.warn=dl,this.error=fl,this.isEnabled=!0},disable:function(){this.debug=gn,this.info=gn,this.warn=gn,this.error=gn,this.isEnabled=!1}},O=function(){function n(s){this.name=s,this._uniqueId=n._propertyNameCounter++}return n.getByName=function(i){var t=n._propertyNameMap;if(t[i]!=null)return t[i];var e=new n(i);return t[i]=e,n._propertyIdMap[e._uniqueId]=e,e},n._getShaderPropertyGroup=function(i){var t,e=n._propertyNameMap[i];return(t=e)==null?void 0:t._group},j(n,[{key:"type",get:function(){return this._type}}]),n}();(function(){O._propertyIdMap=Object.create(null)})();(function(){O._propertyNameCounter=0})();(function(){O._propertyNameMap=Object.create(null)})();var Oi=function(){function n(){this._frameCount=0,this._deltaTime=0,this._actualDeltaTime=0,this._elapsedTime=0,this._actualElapsedTime=0,this._elapsedTimeValue=new ie,this._deltaTimeValue=new ie,this.maximumDeltaTime=.333333,this.timeScale=1,this._lastSystemTime=performance.now()/1e3}var s=n.prototype;return s._reset=function(){this._lastSystemTime=performance.now()/1e3},s._update=function(){var t=performance.now()/1e3,e=t-this._lastSystemTime;this._actualDeltaTime=e,this._actualElapsedTime+=e;var r=Math.min(e,this.maximumDeltaTime)*this.timeScale;this._deltaTime=r,this._elapsedTime+=r,this._frameCount++,this._lastSystemTime=t},s._updateSceneShaderData=function(t){var e=this,r=e._elapsedTimeValue,a=e._deltaTimeValue,o=this._elapsedTime;r.set(o,Math.sin(o),Math.cos(o),0),t.setVector4(n._elapsedTimeProperty,r),a.set(this._deltaTime,0,0,0),t.setVector4(n._deltaTimeProperty,a)},j(n,[{key:"frameCount",get:function(){return this._frameCount}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"elapsedTime",get:function(){return this._elapsedTime}},{key:"actualDeltaTime",get:function(){return this._actualDeltaTime}},{key:"actualElapsedTime",get:function(){return this._actualElapsedTime}}]),n}();(function(){Oi._elapsedTimeProperty=O.getByName("scene_ElapsedTime")})();(function(){Oi._deltaTimeProperty=O.getByName("scene_DeltaTime")})();var Ie;(function(n){n[n.FLOAT=5126]="FLOAT",n[n.FLOAT_VEC2=35664]="FLOAT_VEC2",n[n.FLOAT_VEC3=35665]="FLOAT_VEC3",n[n.FLOAT_VEC4=35666]="FLOAT_VEC4",n[n.INT=5124]="INT",n[n.INT_VEC2=35667]="INT_VEC2",n[n.INT_VEC3=35668]="INT_VEC3",n[n.INT_VEC4=35669]="INT_VEC4",n[n.BOOL=35670]="BOOL",n[n.BOOL_VEC2=35671]="BOOL_VEC2",n[n.BOOL_VEC3=35672]="BOOL_VEC3",n[n.BOOL_VEC4=35673]="BOOL_VEC4",n[n.FLOAT_MAT2=35674]="FLOAT_MAT2",n[n.FLOAT_MAT3=35675]="FLOAT_MAT3",n[n.FLOAT_MAT4=35676]="FLOAT_MAT4",n[n.FLOAT_ARRAY=35677]="FLOAT_ARRAY",n[n.FLOAT_VEC2_ARRAY=1e5]="FLOAT_VEC2_ARRAY",n[n.FLOAT_VEC3_ARRAY=100001]="FLOAT_VEC3_ARRAY",n[n.FLOAT_VEC4_ARRAY=100002]="FLOAT_VEC4_ARRAY",n[n.INT_ARRAY=100003]="INT_ARRAY",n[n.INT_VEC2_ARRAY=100004]="INT_VEC2_ARRAY",n[n.INT_VEC3_ARRAY=100005]="INT_VEC3_ARRAY",n[n.INT_VEC4_ARRAY=100006]="INT_VEC4_ARRAY",n[n.FLOAT_MAT2_ARRAY=100007]="FLOAT_MAT2_ARRAY",n[n.FLOAT_MAT3_ARRAY=100008]="FLOAT_MAT3_ARRAY",n[n.FLOAT_MAT4_ARRAY=100009]="FLOAT_MAT4_ARRAY",n[n.SAMPLER_2D_ARRAY=100010]="SAMPLER_2D_ARRAY",n[n.SAMPLER_CUBE_ARRAY=100011]="SAMPLER_CUBE_ARRAY",n[n.SAMPLER_2D=35678]="SAMPLER_2D",n[n.SAMPLER_CUBE=35680]="SAMPLER_CUBE",n[n.BYTE=5120]="BYTE",n[n.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",n[n.SHORT=5122]="SHORT",n[n.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",n[n.UNSIGNED_INT=5125]="UNSIGNED_INT"})(Ie||(Ie={}));var K;(function(n){n.shaderVertexID="shaderVertexID",n.standardDerivatives="OES_standard_derivatives",n.shaderTextureLod="EXT_shader_texture_lod",n.elementIndexUint="OES_element_index_uint",n.depthTexture="WEBGL_depth_texture",n.drawBuffers="WEBGL_draw_buffers",n.vertexArrayObject="OES_vertex_array_object",n.instancedArrays="ANGLE_instanced_arrays",n.multipleSample="multipleSampleOnlySupportedInWebGL2",n.textureFloat="OES_texture_float",n.textureFloatLinear="OES_texture_float_linear",n.textureHalfFloat="OES_texture_half_float",n.textureHalfFloatLinear="OES_texture_half_float_linear",n.WEBGL_colorBufferFloat="WEBGL_color_buffer_float",n.colorBufferFloat="EXT_color_buffer_float",n.colorBufferHalfFloat="EXT_color_buffer_half_float",n.textureFilterAnisotropic="EXT_texture_filter_anisotropic",n.blendMinMax="EXT_blend_minmax",n.fragDepth="EXT_frag_depth",n.astc="WEBGL_compressed_texture_astc",n.astc_webkit="WEBKIT_WEBGL_compressed_texture_astc",n.etc="WEBGL_compressed_texture_etc",n.etc_webkit="WEBKIT_WEBGL_compressed_texture_etc",n.etc1="WEBGL_compressed_texture_etc1",n.etc1_webkit="WEBKIT_WEBGL_compressed_texture_etc1",n.pvrtc="WEBGL_compressed_texture_pvrtc",n.pvrtc_webkit="WEBKIT_WEBGL_compressed_texture_pvrtc",n.s3tc="WEBGL_compressed_texture_s3tc",n.s3tc_webkit="WEBKIT_WEBGL_compressed_texture_s3tc",n.bptc="EXT_texture_compression_bptc",n.WEBGL_lose_context="WEBGL_lose_context"})(K||(K={}));var ue;(function(n){n[n.None=0]="None",n[n.Scene=1]="Scene",n[n.Hierarchy=2]="Hierarchy",n[n.All=3]="All"})(ue||(ue={}));var Rt=function(n){W(s,n);function s(t){var e;return e=n.call(this,t.engine)||this,e._awoken=!1,e._phasedActiveInScene=!1,e._phasedActive=!1,e._enabled=!0,e._entity=t,e}var i=s.prototype;return i._onAwake=function(){},i._onEnable=function(){},i._onDisable=function(){},i._onEnableInScene=function(){},i._onDisableInScene=function(){},i._setActive=function(e,r){var a=this._entity;r&ue.Scene&&(e?!this._phasedActiveInScene&&a._isActiveInScene&&this._enabled&&(this._phasedActiveInScene=!0,this._onEnableInScene()):this._phasedActiveInScene&&!(a._isActiveInScene&&this._enabled)&&(this._phasedActiveInScene=!1,this._onDisableInScene())),r&ue.Hierarchy&&(e?(!this._awoken&&a._isActiveInHierarchy&&(this._awoken=!0,this._onAwake()),!this._phasedActive&&a._isActiveInHierarchy&&this._enabled&&(this._phasedActive=!0,this._onEnable())):this._phasedActive&&!(a._isActiveInHierarchy&&this._enabled)&&(this._phasedActive=!1,this._onDisable()))},i._addResourceReferCount=function(e,r){this._entity._isTemplate||e._addReferCount(r)},i._onDestroy=function(){n.prototype._onDestroy.call(this);var e=this._entity;e._removeComponent(this),this._enabled&&(e._isActiveInScene&&this._onDisableInScene(),e._isActiveInHierarchy&&this._onDisable())},j(s,[{key:"enabled",get:function(){return this._enabled},set:function(e){e!==this._enabled&&(this._enabled=e,this._entity._isActiveInScene&&(e?this._phasedActiveInScene||(this._phasedActiveInScene=!0,this._onEnableInScene()):this._phasedActiveInScene&&(this._phasedActiveInScene=!1,this._onDisableInScene())),this._entity.isActiveInHierarchy&&(e?this._phasedActive||(this._phasedActive=!0,this._onEnable()):this._phasedActive&&(this._phasedActive=!1,this._onDisable())))}},{key:"entity",get:function(){return this._entity}},{key:"scene",get:function(){return this._entity.scene}}]),s}(Yr);T([F],Rt.prototype,"_entity",void 0);T([F],Rt.prototype,"_awoken",void 0);T([F],Rt.prototype,"_phasedActiveInScene",void 0);T([F],Rt.prototype,"_phasedActive",void 0);T([Me],Rt.prototype,"_enabled",void 0);var ca=function(){function n(){}return n._addCheck=function(i,t){for(;t!==Rt;){var e=n._dependenciesMap.get(t);if(e)for(var r=e.components,a=e.mode,o=0,c=r.length;o<c;o++){var l=r[o];if(!i.getComponent(l))if(a===1)i.addComponent(l);else throw"Should add "+l.name+" before adding "+t.name}t=Object.getPrototypeOf(t)}},n._removeCheck=function(i,t){for(;t!==Rt;){var e=n._invDependenciesMap.get(t);if(e){for(var r=0,a=e.length;r<a;r++)if(i.getComponent(e[r]))throw"Should remove "+e[r].name+" before adding "+t.name}t=Object.getPrototypeOf(t)}},n._addDependency=function(i,t,e){var r=e.get(i);r?r.includes(t)||r.push(t):e.set(i,[t])},n._addInvDependency=function(i,t){var e=this._invDependenciesMap,r=e.get(i);r?r.includes(t)||r.push(t):e.set(i,[t])},n}();(function(){ca._invDependenciesMap=new Map})();(function(){ca._dependenciesMap=new Map})();function ka(n,s){s===void 0&&(s=0);var i=Array.isArray(n)?n:[n];return function(t){ca._dependenciesMap.set(t,{mode:s,components:i}),i.forEach(function(e){return ca._addInvDependency(e,t)})}}var Hn;(function(n){n[n.CheckOnly=0]="CheckOnly",n[n.AutoAdd=1]="AutoAdd"})(Hn||(Hn={}));var vl=function(){function n(){this._flagManagers=[]}var s=n.prototype;return s.clearFromManagers=function(){this._removeFromManagers(),this._flagManagers.length=0},s.destroy=function(){this._removeFromManagers(),this._flagManagers=null},s._removeFromManagers=function(){for(var t=this._flagManagers,e=0,r=t.length;e<r;e++)Ue.removeFromArray(t[e]._updateFlags,this)},n}(),zi=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.flag=!0,t}var i=s.prototype;return i.dispatch=function(){this.flag=!0},s}(vl),ge=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._position=new R,e._rotation=new R,e._rotationQuaternion=new Re,e._scale=new R(1,1,1),e._worldPosition=new R,e._worldRotation=new R,e._worldRotationQuaternion=new Re,e._lossyWorldScale=new R(1,1,1),e._localMatrix=new Z,e._worldMatrix=new Z,e._worldForward=null,e._worldRight=null,e._worldUp=null,e._isParentDirty=!0,e._parentTransformCache=null,e._dirtyFlag=188,e._updateFlagManager=new Er,e._onPositionChanged=e._onPositionChanged.bind(ce(e)),e._onWorldPositionChanged=e._onWorldPositionChanged.bind(ce(e)),e._onRotationChanged=e._onRotationChanged.bind(ce(e)),e._onWorldRotationChanged=e._onWorldRotationChanged.bind(ce(e)),e._onRotationQuaternionChanged=e._onRotationQuaternionChanged.bind(ce(e)),e._onWorldRotationQuaternionChanged=e._onWorldRotationQuaternionChanged.bind(ce(e)),e._onScaleChanged=e._onScaleChanged.bind(ce(e)),e._position._onValueChanged=e._onPositionChanged,e._worldPosition._onValueChanged=e._onWorldPositionChanged,e._rotation._onValueChanged=e._onRotationChanged,e._worldRotation._onValueChanged=e._onWorldRotationChanged,e._rotationQuaternion._onValueChanged=e._onRotationQuaternionChanged,e._worldRotationQuaternion._onValueChanged=e._onWorldRotationQuaternionChanged,e._scale._onValueChanged=e._onScaleChanged,e}var i=s.prototype;return i.setPosition=function(e,r,a){this._position.set(e,r,a)},i.setRotation=function(e,r,a){this._rotation.set(e,r,a)},i.setRotationQuaternion=function(e,r,a,o){this._rotationQuaternion.set(e,r,a,o)},i.setScale=function(e,r,a){this._scale.set(e,r,a)},i.setWorldPosition=function(e,r,a){this._worldPosition.set(e,r,a)},i.setWorldRotation=function(e,r,a){this._worldRotation.set(e,r,a)},i.setWorldRotationQuaternion=function(e,r,a,o){this._worldRotationQuaternion.set(e,r,a,o)},i.translate=function(e,r,a,o){if(typeof e=="number"){var c=s._tempVec30;c.set(e,r,a),this._translate(c,o)}else this._translate(e,r)},i.rotate=function(e,r,a,o){typeof e=="number"?this._rotateXYZ(e,r,a,o):this._rotateXYZ(e.x,e.y,e.z,r)},i.rotateByAxis=function(e,r,a){a===void 0&&(a=!0);var o=r*k.degreeToRadFactor;Re.rotationAxisAngle(e,o,s._tempQuat0),this._rotateByQuat(s._tempQuat0,a)},i.lookAt=function(e,r){var a=s._tempVec30;R.subtract(this.worldPosition,e,a);var o=a.length();if(!(o<=k.zeroTolerance)){a.scale(1/o);var c=s._tempVec31;if(r?R.cross(r,a,c):c.set(a.z,0,-a.x),o=c.length(),!(o<=k.zeroTolerance)){c.scale(1/o);var l=s._tempVec32;R.cross(a,c,l);var _=s._tempMat41,u=_.elements;u[0]=c.x,u[1]=c.y,u[2]=c.z,u[4]=l.x,u[5]=l.y,u[6]=l.z,u[8]=a.x,u[9]=a.y,u[10]=a.z,_.getRotation(this._worldRotationQuaternion)}}},i.registerWorldChangeFlag=function(){return this._updateFlagManager.createFlag(zi)},i._parentChange=function(){this._isParentDirty=!0,this._updateAllWorldFlag()},i._isFrontFaceInvert=function(){var e=this.lossyWorldScale,r=e.x<0;return e.y<0&&(r=!r),e.z<0&&(r=!r),r},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._worldPosition._onValueChanged=null,this._rotation._onValueChanged=null,this._worldRotation._onValueChanged=null,this._rotationQuaternion._onValueChanged=null,this._worldRotationQuaternion._onValueChanged=null,this._position._onValueChanged=null,this._scale._onValueChanged=null},i._updateWorldPositionFlag=function(){if(!this._isContainDirtyFlags(132)){this._worldAssociatedChange(132);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var o;(o=e[r].transform)==null||o._updateWorldPositionFlag()}}},i._updateWorldRotationFlag=function(){if(!this._isContainDirtyFlags(152)){this._worldAssociatedChange(152);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var o;(o=e[r].transform)==null||o._updateWorldPositionAndRotationFlag()}}},i._updateWorldPositionAndRotationFlag=function(){if(!this._isContainDirtyFlags(156)){this._worldAssociatedChange(156);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var o;(o=e[r].transform)==null||o._updateWorldPositionAndRotationFlag()}}},i._updateWorldScaleFlag=function(){if(!this._isContainDirtyFlags(160)){this._worldAssociatedChange(160);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var o;(o=e[r].transform)==null||o._updateWorldPositionAndScaleFlag()}}},i._updateWorldPositionAndScaleFlag=function(){if(!this._isContainDirtyFlags(164)){this._worldAssociatedChange(164);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var o;(o=e[r].transform)==null||o._updateWorldPositionAndScaleFlag()}}},i._updateAllWorldFlag=function(){if(!this._isContainDirtyFlags(188)){this._worldAssociatedChange(188);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var o;(o=e[r].transform)==null||o._updateAllWorldFlag()}}},i._getParentTransform=function(){if(!this._isParentDirty)return this._parentTransformCache;for(var e=null,r=this._entity.parent;r;){var a=r.transform;if(a){e=a;break}else r=r.parent}return this._parentTransformCache=e,this._isParentDirty=!1,e},i._getScaleMatrix=function(){var e=s._tempQuat0,r=s._tempMat30,a=s._tempMat31,o=s._tempMat32;return a.copyFromMatrix(this.worldMatrix),Re.invert(this.worldRotationQuaternion,e),oa.rotationQuaternion(e,r),oa.multiply(r,a,o),o},i._isContainDirtyFlags=function(e){return(this._dirtyFlag&e)===e},i._isContainDirtyFlag=function(e){return(this._dirtyFlag&e)!=0},i._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},i._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},i._worldAssociatedChange=function(e){this._dirtyFlag|=e,this._updateFlagManager.dispatch(128)},i._rotateByQuat=function(e,r){r?Re.multiply(this.rotationQuaternion,e,this._rotationQuaternion):Re.multiply(e,this.worldRotationQuaternion,this._worldRotationQuaternion)},i._translate=function(e,r){if(r===void 0&&(r=!0),r){var a=s._tempVec30;R.transformByQuat(e,this.worldRotationQuaternion,a),this.worldPosition.add(a)}else this.worldPosition.add(e)},i._rotateXYZ=function(e,r,a,o){o===void 0&&(o=!0);var c=k.degreeToRadFactor,l=s._tempQuat0;Re.rotationEuler(e*c,r*c,a*c,l),this._rotateByQuat(l,o)},i._onPositionChanged=function(){this._setDirtyFlagTrue(64),this._updateWorldPositionFlag()},i._onWorldPositionChanged=function(){var e=this._worldPosition,r=this._getParentTransform();r?(Z.invert(r.worldMatrix,s._tempMat41),R.transformCoordinate(e,s._tempMat41,this._position)):this._position.copyFrom(e),this._setDirtyFlagFalse(4)},i._onRotationChanged=function(){this._setDirtyFlagTrue(66),this._setDirtyFlagFalse(1),this._updateWorldRotationFlag()},i._onWorldRotationChanged=function(){var e=this._worldRotation;Re.rotationEuler(k.degreeToRadian(e.x),k.degreeToRadian(e.y),k.degreeToRadian(e.z),this._worldRotationQuaternion),this._setDirtyFlagFalse(8)},i._onRotationQuaternionChanged=function(){this._setDirtyFlagTrue(65),this._setDirtyFlagFalse(2),this._updateWorldRotationFlag()},i._onWorldRotationQuaternionChanged=function(){var e=this._worldRotationQuaternion,r=this._getParentTransform();if(r){var a=s._tempQuat0;Re.invert(r.worldRotationQuaternion,a),Re.multiply(a,e,this._rotationQuaternion)}else this._rotationQuaternion.copyFrom(e);this._setDirtyFlagFalse(16)},i._onScaleChanged=function(){this._setDirtyFlagTrue(64),this._updateWorldScaleFlag()},j(s,[{key:"position",get:function(){return this._position},set:function(e){this._position!==e&&this._position.copyFrom(e)}},{key:"worldPosition",get:function(){var e=this._worldPosition;return this._isContainDirtyFlag(4)&&(e._onValueChanged=null,this._getParentTransform()?this.worldMatrix.getTranslation(e):e.copyFrom(this._position),e._onValueChanged=this._onWorldPositionChanged,this._setDirtyFlagFalse(4)),e},set:function(e){this._worldPosition!==e&&this._worldPosition.copyFrom(e)}},{key:"rotation",get:function(){var e=this._rotation;return this._isContainDirtyFlag(1)&&(e._onValueChanged=null,this._rotationQuaternion.toEuler(e),e.scale(k.radToDegreeFactor),e._onValueChanged=this._onRotationChanged,this._setDirtyFlagFalse(1)),e},set:function(e){this._rotation!==e&&this._rotation.copyFrom(e)}},{key:"worldRotation",get:function(){var e=this._worldRotation;return this._isContainDirtyFlag(8)&&(e._onValueChanged=null,this.worldRotationQuaternion.toEuler(e),e.scale(k.radToDegreeFactor),e._onValueChanged=this._onWorldRotationChanged,this._setDirtyFlagFalse(8)),e},set:function(e){this._worldRotation!==e&&this._worldRotation.copyFrom(e)}},{key:"rotationQuaternion",get:function(){var e=this._rotationQuaternion;return this._isContainDirtyFlag(2)&&(e._onValueChanged=null,Re.rotationEuler(k.degreeToRadian(this._rotation.x),k.degreeToRadian(this._rotation.y),k.degreeToRadian(this._rotation.z),e),e._onValueChanged=this._onRotationQuaternionChanged,this._setDirtyFlagFalse(2)),e},set:function(e){this._rotationQuaternion!==e?e.normalized?this._rotationQuaternion.copyFrom(e):Re.normalize(e,this._rotationQuaternion):e.normalized||e.normalize()}},{key:"worldRotationQuaternion",get:function(){var e=this._worldRotationQuaternion;if(this._isContainDirtyFlag(16)){e._onValueChanged=null;var r=this._getParentTransform();r!=null?Re.multiply(r.worldRotationQuaternion,this.rotationQuaternion,e):e.copyFrom(this.rotationQuaternion),e._onValueChanged=this._onWorldRotationQuaternionChanged,this._setDirtyFlagFalse(16)}return e},set:function(e){this._worldRotationQuaternion!==e&&(e.normalized?this._worldRotationQuaternion.copyFrom(e):Re.normalize(e,this._worldRotationQuaternion)),e.normalized||e.normalize()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale!==e&&this._scale.copyFrom(e)}},{key:"lossyWorldScale",get:function(){if(this._isContainDirtyFlag(32)){if(this._getParentTransform()){var e=this._getScaleMatrix(),r=e.elements;this._lossyWorldScale.set(r[0],r[4],r[8])}else this._lossyWorldScale.copyFrom(this._scale);this._setDirtyFlagFalse(32)}return this._lossyWorldScale}},{key:"localMatrix",get:function(){return this._isContainDirtyFlag(64)&&(Z.affineTransformation(this._scale,this.rotationQuaternion,this._position,this._localMatrix),this._setDirtyFlagFalse(64)),this._localMatrix},set:function(e){this._localMatrix!==e&&this._localMatrix.copyFrom(e),this._position._onValueChanged=this._rotationQuaternion._onValueChanged=this._scale._onValueChanged=null,this._localMatrix.decompose(this._position,this._rotationQuaternion,this._scale),this._position._onValueChanged=this._onPositionChanged,this._rotationQuaternion._onValueChanged=this._onRotationQuaternionChanged,this._scale._onValueChanged=this._onScaleChanged,this._setDirtyFlagTrue(1),this._setDirtyFlagFalse(66),this._updateAllWorldFlag()}},{key:"worldMatrix",get:function(){if(this._isContainDirtyFlag(128)){var e=this._getParentTransform();e?Z.multiply(e.worldMatrix,this.localMatrix,this._worldMatrix):this._worldMatrix.copyFrom(this.localMatrix),this._setDirtyFlagFalse(128)}return this._worldMatrix},set:function(e){this._worldMatrix!==e&&this._worldMatrix.copyFrom(e);var r=this._getParentTransform();r?(Z.invert(r.worldMatrix,s._tempMat42),Z.multiply(s._tempMat42,e,this._localMatrix)):this._localMatrix.copyFrom(e),this.localMatrix=this._localMatrix,this._setDirtyFlagFalse(128)}},{key:"worldForward",get:function(){var e=this._worldForward||(this._worldForward=new R),r=this.worldMatrix.elements;return e.set(-r[8],-r[9],-r[10]),e.normalize()}},{key:"worldRight",get:function(){var e=this._worldRight||(this._worldRight=new R),r=this.worldMatrix.elements;return e.set(r[0],r[1],r[2]),e.normalize()}},{key:"worldUp",get:function(){var e=this._worldUp||(this._worldUp=new R),r=this.worldMatrix.elements;return e.set(r[4],r[5],r[6]),e.normalize()}}]),s}(Rt);(function(){ge._tempQuat0=new Re})();(function(){ge._tempVec30=new R})();(function(){ge._tempVec31=new R})();(function(){ge._tempVec32=new R})();(function(){ge._tempMat30=new oa})();(function(){ge._tempMat31=new oa})();(function(){ge._tempMat32=new oa})();(function(){ge._tempMat41=new Z})();(function(){ge._tempMat42=new Z})();T([J],ge.prototype,"_position",void 0);T([J],ge.prototype,"_rotation",void 0);T([J],ge.prototype,"_rotationQuaternion",void 0);T([J],ge.prototype,"_scale",void 0);T([J],ge.prototype,"_worldPosition",void 0);T([J],ge.prototype,"_worldRotation",void 0);T([J],ge.prototype,"_worldRotationQuaternion",void 0);T([J],ge.prototype,"_lossyWorldScale",void 0);T([J],ge.prototype,"_localMatrix",void 0);T([J],ge.prototype,"_worldMatrix",void 0);T([F],ge.prototype,"_worldForward",void 0);T([F],ge.prototype,"_worldRight",void 0);T([F],ge.prototype,"_worldUp",void 0);T([F],ge.prototype,"_isParentDirty",void 0);T([F],ge.prototype,"_parentTransformCache",void 0);T([F],ge.prototype,"_updateFlagManager",void 0);T([F],ge.prototype,"_onPositionChanged",null);T([F],ge.prototype,"_onWorldPositionChanged",null);T([F],ge.prototype,"_onRotationChanged",null);T([F],ge.prototype,"_onWorldRotationChanged",null);T([F],ge.prototype,"_onRotationQuaternionChanged",null);T([F],ge.prototype,"_onWorldRotationQuaternionChanged",null);T([F],ge.prototype,"_onScaleChanged",null);var Yo;(function(n){n[n.LocalEuler=1]="LocalEuler",n[n.LocalQuat=2]="LocalQuat",n[n.WorldPosition=4]="WorldPosition",n[n.WorldEuler=8]="WorldEuler",n[n.WorldQuat=16]="WorldQuat",n[n.WorldScale=32]="WorldScale",n[n.LocalMatrix=64]="LocalMatrix",n[n.WorldMatrix=128]="WorldMatrix",n[n.WmWp=132]="WmWp",n[n.WmWeWq=152]="WmWeWq",n[n.WmWpWeWq=156]="WmWpWeWq",n[n.WmWs=160]="WmWs",n[n.WmWpWs=164]="WmWpWs",n[n.WmWpWeWqWs=188]="WmWpWeWqWs"})(Yo||(Yo={}));var be;(function(n){n[n.Zero=0]="Zero",n[n.One=1]="One",n[n.SourceColor=2]="SourceColor",n[n.OneMinusSourceColor=3]="OneMinusSourceColor",n[n.DestinationColor=4]="DestinationColor",n[n.OneMinusDestinationColor=5]="OneMinusDestinationColor",n[n.SourceAlpha=6]="SourceAlpha",n[n.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",n[n.DestinationAlpha=8]="DestinationAlpha",n[n.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",n[n.SourceAlphaSaturate=10]="SourceAlphaSaturate",n[n.BlendColor=11]="BlendColor",n[n.OneMinusBlendColor=12]="OneMinusBlendColor"})(be||(be={}));var It;(function(n){n[n.Add=0]="Add",n[n.Subtract=1]="Subtract",n[n.ReverseSubtract=2]="ReverseSubtract",n[n.Min=3]="Min",n[n.Max=4]="Max"})(It||(It={}));var yr;(function(n){n[n.None=0]="None",n[n.Red=1]="Red",n[n.Green=2]="Green",n[n.Blue=4]="Blue",n[n.Alpha=8]="Alpha",n[n.All=15]="All"})(yr||(yr={}));var Ee;(function(n){n[n.Never=0]="Never",n[n.Less=1]="Less",n[n.Equal=2]="Equal",n[n.LessEqual=3]="LessEqual",n[n.Greater=4]="Greater",n[n.NotEqual=5]="NotEqual",n[n.GreaterEqual=6]="GreaterEqual",n[n.Always=7]="Always"})(Ee||(Ee={}));var qt;(function(n){n[n.Off=0]="Off",n[n.Front=1]="Front",n[n.Back=2]="Back"})(qt||(qt={}));var re;(function(n){n[n.BlendStateEnabled0=0]="BlendStateEnabled0",n[n.BlendStateColorBlendOperation0=1]="BlendStateColorBlendOperation0",n[n.BlendStateAlphaBlendOperation0=2]="BlendStateAlphaBlendOperation0",n[n.BlendStateSourceColorBlendFactor0=3]="BlendStateSourceColorBlendFactor0",n[n.BlendStateSourceAlphaBlendFactor0=4]="BlendStateSourceAlphaBlendFactor0",n[n.BlendStateDestinationColorBlendFactor0=5]="BlendStateDestinationColorBlendFactor0",n[n.BlendStateDestinationAlphaBlendFactor0=6]="BlendStateDestinationAlphaBlendFactor0",n[n.BlendStateColorWriteMask0=7]="BlendStateColorWriteMask0",n[n.BlendStateBlendColor=8]="BlendStateBlendColor",n[n.BlendStateAlphaToCoverage=9]="BlendStateAlphaToCoverage",n[n.DepthStateEnabled=10]="DepthStateEnabled",n[n.DepthStateWriteEnabled=11]="DepthStateWriteEnabled",n[n.DepthStateCompareFunction=12]="DepthStateCompareFunction",n[n.StencilStateEnabled=13]="StencilStateEnabled",n[n.StencilStateReferenceValue=14]="StencilStateReferenceValue",n[n.StencilStateMask=15]="StencilStateMask",n[n.StencilStateWriteMask=16]="StencilStateWriteMask",n[n.StencilStateCompareFunctionFront=17]="StencilStateCompareFunctionFront",n[n.StencilStateCompareFunctionBack=18]="StencilStateCompareFunctionBack",n[n.StencilStatePassOperationFront=19]="StencilStatePassOperationFront",n[n.StencilStatePassOperationBack=20]="StencilStatePassOperationBack",n[n.StencilStateFailOperationFront=21]="StencilStateFailOperationFront",n[n.StencilStateFailOperationBack=22]="StencilStateFailOperationBack",n[n.StencilStateZFailOperationFront=23]="StencilStateZFailOperationFront",n[n.StencilStateZFailOperationBack=24]="StencilStateZFailOperationBack",n[n.RasterStateCullMode=25]="RasterStateCullMode",n[n.RasterStateDepthBias=26]="RasterStateDepthBias",n[n.RasterStateSlopeScaledDepthBias=27]="RasterStateSlopeScaledDepthBias",n[n.RenderQueueType=28]="RenderQueueType"})(re||(re={}));var ft;(function(n){n[n.Opaque=0]="Opaque",n[n.AlphaTest=1]="AlphaTest",n[n.Transparent=2]="Transparent"})(ft||(ft={}));var Vt;(function(n){n[n.Float=0]="Float",n[n.Int=1]="Int",n[n.Vector2=2]="Vector2",n[n.Vector3=3]="Vector3",n[n.Vector4=4]="Vector4",n[n.Matrix=5]="Matrix",n[n.Color=6]="Color",n[n.Texture=7]="Texture",n[n.FloatArray=8]="FloatArray",n[n.IntArray=9]="IntArray",n[n.TextureArray=10]="TextureArray"})(Vt||(Vt={}));var ke;(function(n){n[n.Keep=0]="Keep",n[n.Zero=1]="Zero",n[n.Replace=2]="Replace",n[n.IncrementSaturate=3]="IncrementSaturate",n[n.DecrementSaturate=4]="DecrementSaturate",n[n.Invert=5]="Invert",n[n.IncrementWrap=6]="IncrementWrap",n[n.DecrementWrap=7]="DecrementWrap"})(ke||(ke={}));var oe=function(){function n(s,i,t,e){this.name=s,this._maskIndex=t,this._maskValue=e,this.value=i;var r=n._macroNameIdMap,a=r[s];r[s]===void 0&&(r[s]=a=n._macroNameCounter++),this._nameId=a}return n.getByName=function(i,t){var e=t?i+" "+t:i,r=n._macroMap[e];if(!r){var a=n._macroMaskMap,o=n._macroCounter,c=Math.floor(o/32),l=o%32;r=new n(i,t,c,1<<l),n._macroMap[e]=r,c==a.length&&(a.length++,a[c]=new Array(32)),a[c][l]=e,n._macroCounter++}return r},n._getNamesByMacros=function(i,t){var e=n._macroMaskMap,r=i._mask;t.length=0;for(var a=0,o=i._length;a<o;a++)for(var c=e[a],l=r[a],_=l<0?32:Math.floor(Math.log2(l))+1,u=0;u<_;u++)l&1<<u&&t.push(c[u])},n}();(function(){oe._macroMaskMap=[]})();(function(){oe._macroNameIdMap=Object.create(null)})();(function(){oe._macroNameCounter=0})();(function(){oe._macroCounter=0})();(function(){oe._macroMap=Object.create(null)})();var Kt=function(){function n(){this._mask=[],this._length=0}var s=n.prototype;return s.enable=function(t){var e=t._maskIndex,r=e+1,a=this._mask,o=this._length;if(o<r){for(a.length<r&&(a.length=r);o<e;o++)a[o]=0;a[e]=t._maskValue,this._length=r}else a[e]|=t._maskValue},s.disable=function(t){var e=t._maskIndex,r=this._mask,a=this._length-1;if(!(e>a)){var o=r[e]&~t._maskValue;e==a&&o===0?this._length--:r[e]=o}},s.unionCollection=function(t){var e=t._mask,r=t._length,a=this._mask,o=this._length;if(o<r){a.length<r&&(a.length=r);for(var c=0;c<o;c++)a[c]|=e[c];for(;c<r;c++)a[c]=e[c];this._length=r}else for(var l=0;l<r;l++)a[l]|=e[l]},s.complementaryCollection=function(t){for(var e=t._mask,r=this._mask,a=this._length-1,o=Math.min(t._length-1,a);o>=0;o--){var c=r[o]&~e[o];o==a&&c===0?(a--,this._length--):r[o]=c}},s.intersectionCollection=function(t){for(var e=t._mask,r=this._mask,a=this._length-1;a>=0;a--){var o=r[a]&e[a];o==0&&a==this._length-1?this._length--:r[a]=o}},s.isEnable=function(t){var e=t._maskIndex;return e>=this._length?!1:(this._mask[e]&t._maskValue)!==0},s.clear=function(){this._length=0},n.unionCollection=function(t,e,r){var a=r._mask,o,c,l,_;t._length<e._length?(o=t._length,c=e._length,l=t._mask,_=e._mask):(o=e._length,c=t._length,l=e._mask,_=t._mask);var u=0;for(a.length<c&&(a.length=c);u<o;u++)a[u]=l[u]|_[u];for(;u<c;u++)a[u]=_[u];r._length=c},n}(),Ot;(function(n){n.DepthOnly="DepthOnly",n.ShadowCaster="ShadowCaster",n.Forward="Forward"})(Ot||(Ot={}));function io(){return io=Object.assign||function(s){for(var i=1;i<arguments.length;i++){var t=arguments[i];for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(s[e]=t[e])}return s},io.apply(this,arguments)}var pl=`#define GLSLIFY 1
uniform vec3 camera_Position;uniform vec3 camera_Forward;uniform vec4 camera_ProjectionParams;`,gl=`#define GLSLIFY 1
#define PI 3.14159265359
#define RECIPROCAL_PI 0.31830988618
#define EPSILON 1e-6
#define LOG2 1.442695
#define saturate( a ) clamp( a, 0.0, 1.0 )
float pow2(float x){return x*x;}vec4 RGBMToLinear(vec4 value,float maxRange){return vec4(value.rgb*value.a*maxRange,1.0);}vec4 gammaToLinear(vec4 srgbIn){return vec4(pow(srgbIn.rgb,vec3(2.2)),srgbIn.a);}vec4 linearToGamma(vec4 linearIn){return vec4(pow(linearIn.rgb,vec3(1.0/2.2)),linearIn.a);}uniform vec4 camera_DepthBufferParams;float remapDepthBufferLinear01(float z){return 1.0/(camera_DepthBufferParams.x*z+camera_DepthBufferParams.y);}
#ifdef GRAPHICS_API_WEBGL2
#define INVERSE_MAT(mat) inverse(mat)
#else
mat2 inverseMat(mat2 m){return mat2(m[1][1],-m[0][1],-m[1][0],m[0][0])/(m[0][0]*m[1][1]-m[0][1]*m[1][0]);}mat3 inverseMat(mat3 m){float a00=m[0][0],a01=m[0][1],a02=m[0][2];float a10=m[1][0],a11=m[1][1],a12=m[1][2];float a20=m[2][0],a21=m[2][1],a22=m[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}mat4 inverseMat(mat4 m){float a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;return mat4(a11*b11-a12*b10+a13*b09,a02*b10-a01*b11-a03*b09,a31*b05-a32*b04+a33*b03,a22*b04-a21*b05-a23*b03,a12*b08-a10*b11-a13*b07,a00*b11-a02*b08+a03*b07,a32*b02-a30*b05-a33*b01,a20*b05-a22*b02+a23*b01,a10*b10-a11*b08+a13*b06,a01*b08-a00*b10-a03*b06,a30*b04-a31*b02+a33*b00,a21*b02-a20*b04-a23*b00,a11*b07-a10*b09-a12*b06,a00*b09-a01*b07+a02*b06,a31*b01-a30*b03-a32*b00,a20*b03-a21*b01+a22*b00)/det;}
#define INVERSE_MAT(mat) inverseMat(mat)
#endif
`,ml=`#define GLSLIFY 1
attribute vec3 POSITION;
#ifdef RENDERER_HAS_UV
attribute vec2 TEXCOORD_0;
#endif
#ifdef RENDERER_HAS_UV1
attribute vec2 TEXCOORD_1;
#endif
#ifdef RENDERER_HAS_SKIN
attribute vec4 JOINTS_0;attribute vec4 WEIGHTS_0;
#ifdef RENDERER_USE_JOINT_TEXTURE
uniform sampler2D renderer_JointSampler;uniform float renderer_JointCount;mat4 getJointMatrix(sampler2D smp,float index){float base=index/renderer_JointCount;float hf=0.5/renderer_JointCount;float v=base+hf;vec4 m0=texture2D(smp,vec2(0.125,v));vec4 m1=texture2D(smp,vec2(0.375,v));vec4 m2=texture2D(smp,vec2(0.625,v));vec4 m3=texture2D(smp,vec2(0.875,v));return mat4(m0,m1,m2,m3);}
#else
uniform mat4 renderer_JointMatrix[RENDERER_JOINTS_NUM];
#endif
#endif
#ifdef RENDERER_ENABLE_VERTEXCOLOR
attribute vec4 COLOR_0;
#endif
#include <transform_declare>
#include <camera_declare>
uniform vec4 material_TilingOffset;
#ifndef MATERIAL_OMIT_NORMAL
#ifdef RENDERER_HAS_NORMAL
attribute vec3 NORMAL;
#endif
#ifdef RENDERER_HAS_TANGENT
attribute vec4 TANGENT;
#endif
#endif
`,yl=`#define GLSLIFY 1
uniform mat4 renderer_LocalMat;uniform mat4 renderer_ModelMat;uniform mat4 camera_ViewMat;uniform mat4 camera_ProjMat;uniform mat4 renderer_MVMat;uniform mat4 renderer_MVPMat;uniform mat4 renderer_NormalMat;`,xl=`#define GLSLIFY 1
#ifdef RENDERER_ENABLE_VERTEXCOLOR
varying vec4 v_color;
#endif
`,bl=`#define GLSLIFY 1
#if SCENE_FOG_MODE != 0
varying vec3 v_positionVS;uniform vec4 scene_FogColor;uniform vec4 scene_FogParams;float ComputeFogIntensity(float fogDepth){
#if SCENE_FOG_MODE == 1
return clamp(fogDepth*scene_FogParams.x+scene_FogParams.y,0.0,1.0);
#elif SCENE_FOG_MODE == 2
return clamp(exp2(-fogDepth*scene_FogParams.z),0.0,1.0);
#elif SCENE_FOG_MODE == 3
float factor=fogDepth*scene_FogParams.w;return clamp(exp2(-factor*factor),0.0,1.0);
#endif
}
#endif
`,Sl=`#define GLSLIFY 1
#if SCENE_FOG_MODE != 0
varying vec3 v_positionVS;
#endif
`,Cl=`#define GLSLIFY 1
#ifndef MATERIAL_OMIT_NORMAL
#ifdef RENDERER_HAS_NORMAL
varying vec3 v_normal;
#if defined(RENDERER_HAS_TANGENT) && ( defined(MATERIAL_HAS_NORMALTEXTURE) || defined(MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE) || defined(MATERIAL_ENABLE_ANISOTROPY) )
varying mat3 v_TBN;
#endif
#endif
#endif
`,Al=`#define GLSLIFY 1
varying vec2 v_uv;
#ifdef RENDERER_HAS_UV1
varying vec2 v_uv1;
#endif
`,El=`#define GLSLIFY 1
#ifdef MATERIAL_NEED_WORLD_POS
varying vec3 v_pos;
#endif
`,wl=`#define GLSLIFY 1
#ifndef MATERIAL_OMIT_NORMAL
#ifdef RENDERER_HAS_NORMAL
vec3 normal=vec3(NORMAL);
#endif
#ifdef RENDERER_HAS_TANGENT
vec4 tangent=vec4(TANGENT);
#endif
#endif
`,Tl=`#define GLSLIFY 1
vec4 position=vec4(POSITION,1.0);`,Rl=`#define GLSLIFY 1
#ifdef RENDERER_HAS_BLENDSHAPE
#ifdef RENDERER_BLENDSHAPE_USE_TEXTURE
uniform mediump sampler2DArray renderer_BlendShapeTexture;uniform ivec3 renderer_BlendShapeTextureInfo;uniform float renderer_BlendShapeWeights[RENDERER_BLENDSHAPE_COUNT];
#else
attribute vec3 POSITION_BS0;attribute vec3 POSITION_BS1;
#if defined( RENDERER_BLENDSHAPE_HAS_NORMAL ) && defined( RENDERER_BLENDSHAPE_HAS_TANGENT )
attribute vec3 NORMAL_BS0;attribute vec3 NORMAL_BS1;attribute vec3 TANGENT_BS0;attribute vec3 TANGENT_BS1;uniform float renderer_BlendShapeWeights[2];
#else
#if defined( RENDERER_BLENDSHAPE_HAS_NORMAL ) || defined( RENDERER_BLENDSHAPE_HAS_TANGENT )
attribute vec3 POSITION_BS2;attribute vec3 POSITION_BS3;
#ifdef RENDERER_BLENDSHAPE_HAS_NORMAL
attribute vec3 NORMAL_BS0;attribute vec3 NORMAL_BS1;attribute vec3 NORMAL_BS2;attribute vec3 NORMAL_BS3;
#endif
#ifdef RENDERER_BLENDSHAPE_HAS_TANGENT
attribute vec3 TANGENT_BS0;attribute vec3 TANGENT_BS1;attribute vec3 TANGENT_BS2;attribute vec3 TANGENT_BS3;
#endif
uniform float renderer_BlendShapeWeights[4];
#else
attribute vec3 POSITION_BS2;attribute vec3 POSITION_BS3;attribute vec3 POSITION_BS4;attribute vec3 POSITION_BS5;attribute vec3 POSITION_BS6;attribute vec3 POSITION_BS7;uniform float renderer_BlendShapeWeights[8];
#endif
#endif
#endif
#ifdef RENDERER_BLENDSHAPE_USE_TEXTURE
vec3 getBlendShapeVertexElement(int blendShapeIndex,int vertexElementIndex){int y=vertexElementIndex/renderer_BlendShapeTextureInfo.y;int x=vertexElementIndex-y*renderer_BlendShapeTextureInfo.y;ivec3 uv=ivec3(x,y,blendShapeIndex);return texelFetch(renderer_BlendShapeTexture,uv,0).xyz;}
#endif
#endif
`,Ml=`#define GLSLIFY 1
#ifdef RENDERER_HAS_BLENDSHAPE
#ifdef RENDERER_BLENDSHAPE_USE_TEXTURE
int vertexOffset=gl_VertexID*renderer_BlendShapeTextureInfo.x;for(int i=0;i<RENDERER_BLENDSHAPE_COUNT;i++){int vertexElementOffset=vertexOffset;float weight=renderer_BlendShapeWeights[i];if(weight!=0.0){position.xyz+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;
#ifndef MATERIAL_OMIT_NORMAL
#if defined( RENDERER_HAS_NORMAL ) && defined( RENDERER_BLENDSHAPE_HAS_NORMAL )
vertexElementOffset+=1;normal+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;
#endif
#if defined( RENDERER_HAS_TANGENT ) && defined(RENDERER_BLENDSHAPE_HAS_TANGENT) && ( defined(MATERIAL_HAS_NORMALTEXTURE) || defined(MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE) )
vertexElementOffset+=1;tangent.xyz+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;
#endif
#endif
}}
#else
position.xyz+=POSITION_BS0*renderer_BlendShapeWeights[0];position.xyz+=POSITION_BS1*renderer_BlendShapeWeights[1];
#if defined( RENDERER_BLENDSHAPE_HAS_NORMAL ) && defined( RENDERER_BLENDSHAPE_HAS_TANGENT )
#ifndef MATERIAL_OMIT_NORMAL
#ifdef RENDERER_HAS_NORMAL
normal+=NORMAL_BS0*renderer_BlendShapeWeights[0];normal+=NORMAL_BS1*renderer_BlendShapeWeights[1];
#endif
#if defined( RENDERER_HAS_TANGENT ) && ( defined(MATERIAL_HAS_NORMALTEXTURE) || defined(MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE) )
tangent.xyz+=TANGENT_BS0*renderer_BlendShapeWeights[0];tangent.xyz+=TANGENT_BS1*renderer_BlendShapeWeights[1];
#endif
#endif
#else
#if defined( RENDERER_BLENDSHAPE_HAS_NORMAL ) || defined( RENDERER_BLENDSHAPE_HAS_TANGENT )
#ifndef MATERIAL_OMIT_NORMAL
position.xyz+=POSITION_BS2*renderer_BlendShapeWeights[2];position.xyz+=POSITION_BS3*renderer_BlendShapeWeights[3];
#if defined( RENDERER_BLENDSHAPE_HAS_NORMAL ) && defined( RENDERER_HAS_NORMAL )
normal+=NORMAL_BS0*renderer_BlendShapeWeights[0];normal+=NORMAL_BS1*renderer_BlendShapeWeights[1];normal+=NORMAL_BS2*renderer_BlendShapeWeights[2];normal+=NORMAL_BS3*renderer_BlendShapeWeights[3];
#endif
#if defined(RENDERER_BLENDSHAPE_HAS_TANGENT) && defined( RENDERER_HAS_TANGENT ) && ( defined(MATERIAL_HAS_NORMALTEXTURE) || defined(MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE) )
tangent.xyz+=TANGENT_BS0*renderer_BlendShapeWeights[0];tangent.xyz+=TANGENT_BS1*renderer_BlendShapeWeights[1];tangent.xyz+=TANGENT_BS2*renderer_BlendShapeWeights[2];tangent.xyz+=TANGENT_BS3*renderer_BlendShapeWeights[3];
#endif
#endif
#else
position.xyz+=POSITION_BS2*renderer_BlendShapeWeights[2];position.xyz+=POSITION_BS3*renderer_BlendShapeWeights[3];position.xyz+=POSITION_BS4*renderer_BlendShapeWeights[4];position.xyz+=POSITION_BS5*renderer_BlendShapeWeights[5];position.xyz+=POSITION_BS6*renderer_BlendShapeWeights[6];position.xyz+=POSITION_BS7*renderer_BlendShapeWeights[7];
#endif
#endif
#endif
#endif
`,Pl=`#define GLSLIFY 1
#ifdef RENDERER_ENABLE_VERTEXCOLOR
v_color=COLOR_0;
#endif
`,Bl=`#define GLSLIFY 1
#if SCENE_FOG_MODE != 0
vec4 positionVS=renderer_MVMat*position;v_positionVS=positionVS.xyz/positionVS.w;
#endif
`,Dl=`#define GLSLIFY 1
#ifndef MATERIAL_OMIT_NORMAL
#ifdef RENDERER_HAS_NORMAL
v_normal=normalize(mat3(renderer_NormalMat)*normal);
#if defined(RENDERER_HAS_TANGENT) && ( defined(MATERIAL_HAS_NORMALTEXTURE) || defined(MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE) || defined(MATERIAL_ENABLE_ANISOTROPY) )
vec3 tangentW=normalize(mat3(renderer_NormalMat)*tangent.xyz);vec3 bitangentW=cross(v_normal,tangentW)*tangent.w;v_TBN=mat3(tangentW,bitangentW,v_normal);
#endif
#endif
#endif
`,Ll=`#define GLSLIFY 1
gl_Position=renderer_MVPMat*position;`,Vl=`#define GLSLIFY 1
#ifdef RENDERER_HAS_SKIN
#ifdef RENDERER_USE_JOINT_TEXTURE
mat4 skinMatrix=WEIGHTS_0.x*getJointMatrix(renderer_JointSampler,JOINTS_0.x)+WEIGHTS_0.y*getJointMatrix(renderer_JointSampler,JOINTS_0.y)+WEIGHTS_0.z*getJointMatrix(renderer_JointSampler,JOINTS_0.z)+WEIGHTS_0.w*getJointMatrix(renderer_JointSampler,JOINTS_0.w);
#else
mat4 skinMatrix=WEIGHTS_0.x*renderer_JointMatrix[int(JOINTS_0.x)]+WEIGHTS_0.y*renderer_JointMatrix[int(JOINTS_0.y)]+WEIGHTS_0.z*renderer_JointMatrix[int(JOINTS_0.z)]+WEIGHTS_0.w*renderer_JointMatrix[int(JOINTS_0.w)];
#endif
position=skinMatrix*position;
#if defined(RENDERER_HAS_NORMAL) && !defined(MATERIAL_OMIT_NORMAL)
mat3 skinNormalMatrix=INVERSE_MAT(mat3(skinMatrix));normal=normal*skinNormalMatrix;
#if defined(RENDERER_HAS_TANGENT) && ( defined(MATERIAL_HAS_NORMALTEXTURE) || defined(MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE) )
tangent.xyz=tangent.xyz*skinNormalMatrix;
#endif
#endif
#endif
`,Fl=`#define GLSLIFY 1
#ifdef RENDERER_HAS_UV
v_uv=TEXCOORD_0;
#else
v_uv=vec2(0.,0.);
#endif
#ifdef RENDERER_HAS_UV1
v_uv1=TEXCOORD_1;
#endif
#ifdef MATERIAL_NEED_TILING_OFFSET
v_uv=v_uv*material_TilingOffset.xy+material_TilingOffset.zw;
#endif
`,Nl=`#define GLSLIFY 1
#ifdef MATERIAL_NEED_WORLD_POS
vec4 temp_pos=renderer_ModelMat*position;v_pos=temp_pos.xyz/temp_pos.w;
#endif
`,Il=`#define GLSLIFY 1
#if SCENE_FOG_MODE != 0
float fogIntensity=ComputeFogIntensity(length(v_positionVS));gl_FragColor.rgb=mix(scene_FogColor.rgb,gl_FragColor.rgb,fogIntensity);
#endif
`,Ol=`#define GLSLIFY 1
#ifdef SCENE_DIRECT_LIGHT_COUNT
struct DirectLight{vec3 color;vec3 direction;};uniform ivec2 scene_DirectLightCullingMask[SCENE_DIRECT_LIGHT_COUNT];uniform vec3 scene_DirectLightColor[SCENE_DIRECT_LIGHT_COUNT];uniform vec3 scene_DirectLightDirection[SCENE_DIRECT_LIGHT_COUNT];
#endif
#ifdef SCENE_POINT_LIGHT_COUNT
struct PointLight{vec3 color;vec3 position;float distance;};uniform ivec2 scene_PointLightCullingMask[SCENE_POINT_LIGHT_COUNT];uniform vec3 scene_PointLightColor[SCENE_POINT_LIGHT_COUNT];uniform vec3 scene_PointLightPosition[SCENE_POINT_LIGHT_COUNT];uniform float scene_PointLightDistance[SCENE_POINT_LIGHT_COUNT];
#endif
#ifdef SCENE_SPOT_LIGHT_COUNT
struct SpotLight{vec3 color;vec3 position;vec3 direction;float distance;float angleCos;float penumbraCos;};uniform ivec2 scene_SpotLightCullingMask[SCENE_SPOT_LIGHT_COUNT];uniform vec3 scene_SpotLightColor[SCENE_SPOT_LIGHT_COUNT];uniform vec3 scene_SpotLightPosition[SCENE_SPOT_LIGHT_COUNT];uniform vec3 scene_SpotLightDirection[SCENE_SPOT_LIGHT_COUNT];uniform float scene_SpotLightDistance[SCENE_SPOT_LIGHT_COUNT];uniform float scene_SpotLightAngleCos[SCENE_SPOT_LIGHT_COUNT];uniform float scene_SpotLightPenumbraCos[SCENE_SPOT_LIGHT_COUNT];
#endif
struct EnvMapLight{vec3 diffuse;float mipMapLevel;float diffuseIntensity;float specularIntensity;};uniform EnvMapLight scene_EnvMapLight;uniform ivec4 renderer_Layer;
#ifdef SCENE_USE_SH
uniform vec3 scene_EnvSH[9];
#endif
#ifdef SCENE_USE_SPECULAR_ENV
uniform samplerCube scene_EnvSpecularSampler;
#endif
#ifndef GRAPHICS_API_WEBGL2
bool isBitSet(float value,float mask,float bitIndex){return mod(floor(value/pow(2.0,bitIndex)),2.0)==1.0&&mod(floor(mask/pow(2.0,bitIndex)),2.0)==1.0;}
#endif
bool isRendererCulledByLight(ivec2 rendererLayer,ivec2 lightCullingMask){
#ifdef GRAPHICS_API_WEBGL2
return!((rendererLayer.x&lightCullingMask.x)!=0||(rendererLayer.y&lightCullingMask.y)!=0);
#else
for(int i=0;i<16;i++){if(isBitSet(float(rendererLayer.x),float(lightCullingMask.x),float(i))||isBitSet(float(rendererLayer.y),float(lightCullingMask.y),float(i))){return false;}}return true;
#endif
}`,zl=`#define GLSLIFY 1
uniform vec4 material_EmissiveColor;uniform vec4 material_BaseColor;uniform vec4 material_SpecularColor;uniform float material_Shininess;uniform float material_NormalIntensity;uniform float material_AlphaCutoff;
#ifdef MATERIAL_HAS_EMISSIVETEXTURE
uniform sampler2D material_EmissiveTexture;
#endif
#ifdef MATERIAL_HAS_BASETEXTURE
uniform sampler2D material_BaseTexture;
#endif
#ifdef MATERIAL_HAS_SPECULAR_TEXTURE
uniform sampler2D material_SpecularTexture;
#endif
#ifdef MATERIAL_HAS_NORMALTEXTURE
uniform sampler2D material_NormalTexture;
#endif
`,Ul=`#define GLSLIFY 1
vec4 ambient=vec4(0.0);vec4 emission=material_EmissiveColor;vec4 diffuse=material_BaseColor;vec4 specular=material_SpecularColor;
#ifdef MATERIAL_HAS_EMISSIVETEXTURE
vec4 emissiveTextureColor=texture2D(material_EmissiveTexture,v_uv);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
emissiveTextureColor=gammaToLinear(emissiveTextureColor);
#endif
emission*=emissiveTextureColor;
#endif
#ifdef MATERIAL_HAS_BASETEXTURE
vec4 diffuseTextureColor=texture2D(material_BaseTexture,v_uv);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
diffuseTextureColor=gammaToLinear(diffuseTextureColor);
#endif
diffuse*=diffuseTextureColor;
#endif
#ifdef RENDERER_ENABLE_VERTEXCOLOR
diffuse*=v_color;
#endif
#ifdef MATERIAL_HAS_SPECULAR_TEXTURE
vec4 specularTextureColor=texture2D(material_SpecularTexture,v_uv);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
specularTextureColor=gammaToLinear(specularTextureColor);
#endif
specular*=specularTextureColor;
#endif
ambient=vec4(scene_EnvMapLight.diffuse*scene_EnvMapLight.diffuseIntensity,1.0)*diffuse;`,kl=`#define GLSLIFY 1
#ifdef CAMERA_ORTHOGRAPHIC
vec3 V=-camera_Forward;
#else
#ifdef MATERIAL_NEED_WORLD_POS
vec3 V=normalize(camera_Position-v_pos);
#endif
#endif
`,Gl=`#define GLSLIFY 1
#ifdef MATERIAL_HAS_NORMALTEXTURE
mat3 tbn=getTBN(gl_FrontFacing);vec3 N=getNormalByNormalTexture(tbn,material_NormalTexture,material_NormalIntensity,v_uv,gl_FrontFacing);
#else
vec3 N=getNormal(gl_FrontFacing);
#endif
vec3 lightDiffuse=vec3(0.0,0.0,0.0);vec3 lightSpecular=vec3(0.0,0.0,0.0);float shadowAttenuation=1.0;
#ifdef SCENE_DIRECT_LIGHT_COUNT
shadowAttenuation=1.0;
#ifdef SCENE_IS_CALCULATE_SHADOWS
shadowAttenuation*=sampleShadowMap();
#endif
DirectLight directionalLight;for(int i=0;i<SCENE_DIRECT_LIGHT_COUNT;i++){if(!isRendererCulledByLight(renderer_Layer.xy,scene_DirectLightCullingMask[i])){directionalLight.color=scene_DirectLightColor[i];
#ifdef SCENE_IS_CALCULATE_SHADOWS
if(i==0){directionalLight.color*=shadowAttenuation;}
#endif
directionalLight.direction=scene_DirectLightDirection[i];float d=max(dot(N,-directionalLight.direction),0.0);lightDiffuse+=directionalLight.color*d;vec3 halfDir=normalize(V-directionalLight.direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),material_Shininess);lightSpecular+=directionalLight.color*s;}}
#endif
#ifdef SCENE_POINT_LIGHT_COUNT
PointLight pointLight;for(int i=0;i<SCENE_POINT_LIGHT_COUNT;i++){if(!isRendererCulledByLight(renderer_Layer.xy,scene_PointLightCullingMask[i])){pointLight.color=scene_PointLightColor[i];pointLight.position=scene_PointLightPosition[i];pointLight.distance=scene_PointLightDistance[i];vec3 direction=v_pos-pointLight.position;float dist=length(direction);direction/=dist;float decay=clamp(1.0-pow(dist/pointLight.distance,4.0),0.0,1.0);float d=max(dot(N,-direction),0.0)*decay;lightDiffuse+=pointLight.color*d;vec3 halfDir=normalize(V-direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),material_Shininess)*decay;lightSpecular+=pointLight.color*s;}}
#endif
#ifdef SCENE_SPOT_LIGHT_COUNT
SpotLight spotLight;for(int i=0;i<SCENE_SPOT_LIGHT_COUNT;i++){if(!isRendererCulledByLight(renderer_Layer.xy,scene_SpotLightCullingMask[i])){spotLight.color=scene_SpotLightColor[i];spotLight.position=scene_SpotLightPosition[i];spotLight.direction=scene_SpotLightDirection[i];spotLight.distance=scene_SpotLightDistance[i];spotLight.angleCos=scene_SpotLightAngleCos[i];spotLight.penumbraCos=scene_SpotLightPenumbraCos[i];vec3 direction=spotLight.position-v_pos;float lightDistance=length(direction);direction/=lightDistance;float angleCos=dot(direction,-spotLight.direction);float decay=clamp(1.0-pow(lightDistance/spotLight.distance,4.0),0.0,1.0);float spotEffect=smoothstep(spotLight.penumbraCos,spotLight.angleCos,angleCos);float decayTotal=decay*spotEffect;float d=max(dot(N,direction),0.0)*decayTotal;lightDiffuse+=spotLight.color*d;vec3 halfDir=normalize(V+direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),material_Shininess)*decayTotal;lightSpecular+=spotLight.color*s;}}
#endif
diffuse*=vec4(lightDiffuse,1.0);specular*=vec4(lightSpecular,1.0);
#ifdef MATERIAL_IS_ALPHA_CUTOFF
if(diffuse.a<material_AlphaCutoff){discard;}
#endif
`,Hl=`#define GLSLIFY 1
#include <noise_cellular_2D>
#include <noise_cellular_3D>
#include <noise_cellular_2x2>
#include <noise_cellular_2x2x2>
`,Wl=`#define GLSLIFY 1
vec2 cellular(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec3 oi=vec3(-1.0,0.0,1.0);vec3 of=vec3(-0.5,0.5,1.5);vec3 px=permute(Pi.x+oi);vec3 p=permute(px.x+Pi.y+oi);vec3 ox=fract(p*K)-Ko;vec3 oy=mod7(floor(p*K))*K-Ko;vec3 dx=Pf.x+0.5+jitter*ox;vec3 dy=Pf.y-of+jitter*oy;vec3 d1=dx*dx+dy*dy;p=permute(px.y+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-0.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d2=dx*dx+dy*dy;p=permute(px.z+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-1.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d3=dx*dx+dy*dy;vec3 d1a=min(d1,d2);d2=max(d1,d2);d2=min(d2,d3);d1=min(d1a,d2);d2=max(d1a,d2);d1.xy=(d1.x<d1.y)? d1.xy : d1.yx;d1.xz=(d1.x<d1.z)? d1.xz : d1.zx;d1.yz=min(d1.yz,d2.yz);d1.y=min(d1.y,d1.z);d1.y=min(d1.y,d2.x);return sqrt(d1.xy);}`,Xl=`#define GLSLIFY 1
vec2 cellular2x2(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec4 Pfx=Pf.x+vec4(-0.5,-1.5,-0.5,-1.5);vec4 Pfy=Pf.y+vec4(-0.5,-0.5,-1.5,-1.5);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 ox=mod7(p)*K+Kd2;vec4 oy=mod7(floor(p*K))*K+Kd2;vec4 dx=Pfx+jitter1*ox;vec4 dy=Pfy+jitter1*oy;vec4 d=dx*dx+dy*dy;d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.y=min(d.y,d.z);d.y=min(d.y,d.w);return sqrt(d.xy);}`,jl=`#define GLSLIFY 1
vec2 cellular2x2x2(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P);vec4 Pfx=Pf.x+vec4(0.0,-1.0,0.0,-1.0);vec4 Pfy=Pf.y+vec4(0.0,0.0,-1.0,-1.0);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 p1=permute(p+Pi.z);vec4 p2=permute(p+Pi.z+vec4(1.0));vec4 ox1=fract(p1*K)-Ko;vec4 oy1=mod7(floor(p1*K))*K-Ko;vec4 oz1=floor(p1*K2)*Kz-Kzo;vec4 ox2=fract(p2*K)-Ko;vec4 oy2=mod7(floor(p2*K))*K-Ko;vec4 oz2=floor(p2*K2)*Kz-Kzo;vec4 dx1=Pfx+jitter1*ox1;vec4 dy1=Pfy+jitter1*oy1;vec4 dz1=Pf.z+jitter1*oz1;vec4 dx2=Pfx+jitter1*ox2;vec4 dy2=Pfy+jitter1*oy2;vec4 dz2=Pf.z-1.0+jitter1*oz2;vec4 d1=dx1*dx1+dy1*dy1+dz1*dz1;vec4 d2=dx2*dx2+dy2*dy2+dz2*dz2;vec4 d=min(d1,d2);d2=max(d1,d2);d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.yzw=min(d.yzw,d2.yzw);d.y=min(d.y,d.z);d.y=min(d.y,d.w);d.y=min(d.y,d2.x);return sqrt(d.xy);}`,ql=`#define GLSLIFY 1
vec2 cellular(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P)-0.5;vec3 Pfx=Pf.x+vec3(1.0,0.0,-1.0);vec3 Pfy=Pf.y+vec3(1.0,0.0,-1.0);vec3 Pfz=Pf.z+vec3(1.0,0.0,-1.0);vec3 p=permute(Pi.x+vec3(-1.0,0.0,1.0));vec3 p1=permute(p+Pi.y-1.0);vec3 p2=permute(p+Pi.y);vec3 p3=permute(p+Pi.y+1.0);vec3 p11=permute(p1+Pi.z-1.0);vec3 p12=permute(p1+Pi.z);vec3 p13=permute(p1+Pi.z+1.0);vec3 p21=permute(p2+Pi.z-1.0);vec3 p22=permute(p2+Pi.z);vec3 p23=permute(p2+Pi.z+1.0);vec3 p31=permute(p3+Pi.z-1.0);vec3 p32=permute(p3+Pi.z);vec3 p33=permute(p3+Pi.z+1.0);vec3 ox11=fract(p11*K)-Ko;vec3 oy11=mod7(floor(p11*K))*K-Ko;vec3 oz11=floor(p11*K2)*Kz-Kzo;vec3 ox12=fract(p12*K)-Ko;vec3 oy12=mod7(floor(p12*K))*K-Ko;vec3 oz12=floor(p12*K2)*Kz-Kzo;vec3 ox13=fract(p13*K)-Ko;vec3 oy13=mod7(floor(p13*K))*K-Ko;vec3 oz13=floor(p13*K2)*Kz-Kzo;vec3 ox21=fract(p21*K)-Ko;vec3 oy21=mod7(floor(p21*K))*K-Ko;vec3 oz21=floor(p21*K2)*Kz-Kzo;vec3 ox22=fract(p22*K)-Ko;vec3 oy22=mod7(floor(p22*K))*K-Ko;vec3 oz22=floor(p22*K2)*Kz-Kzo;vec3 ox23=fract(p23*K)-Ko;vec3 oy23=mod7(floor(p23*K))*K-Ko;vec3 oz23=floor(p23*K2)*Kz-Kzo;vec3 ox31=fract(p31*K)-Ko;vec3 oy31=mod7(floor(p31*K))*K-Ko;vec3 oz31=floor(p31*K2)*Kz-Kzo;vec3 ox32=fract(p32*K)-Ko;vec3 oy32=mod7(floor(p32*K))*K-Ko;vec3 oz32=floor(p32*K2)*Kz-Kzo;vec3 ox33=fract(p33*K)-Ko;vec3 oy33=mod7(floor(p33*K))*K-Ko;vec3 oz33=floor(p33*K2)*Kz-Kzo;vec3 dx11=Pfx+jitter*ox11;vec3 dy11=Pfy.x+jitter*oy11;vec3 dz11=Pfz.x+jitter*oz11;vec3 dx12=Pfx+jitter*ox12;vec3 dy12=Pfy.x+jitter*oy12;vec3 dz12=Pfz.y+jitter*oz12;vec3 dx13=Pfx+jitter*ox13;vec3 dy13=Pfy.x+jitter*oy13;vec3 dz13=Pfz.z+jitter*oz13;vec3 dx21=Pfx+jitter*ox21;vec3 dy21=Pfy.y+jitter*oy21;vec3 dz21=Pfz.x+jitter*oz21;vec3 dx22=Pfx+jitter*ox22;vec3 dy22=Pfy.y+jitter*oy22;vec3 dz22=Pfz.y+jitter*oz22;vec3 dx23=Pfx+jitter*ox23;vec3 dy23=Pfy.y+jitter*oy23;vec3 dz23=Pfz.z+jitter*oz23;vec3 dx31=Pfx+jitter*ox31;vec3 dy31=Pfy.z+jitter*oy31;vec3 dz31=Pfz.x+jitter*oz31;vec3 dx32=Pfx+jitter*ox32;vec3 dy32=Pfy.z+jitter*oy32;vec3 dz32=Pfz.y+jitter*oz32;vec3 dx33=Pfx+jitter*ox33;vec3 dy33=Pfy.z+jitter*oy33;vec3 dz33=Pfz.z+jitter*oz33;vec3 d11=dx11*dx11+dy11*dy11+dz11*dz11;vec3 d12=dx12*dx12+dy12*dy12+dz12*dz12;vec3 d13=dx13*dx13+dy13*dy13+dz13*dz13;vec3 d21=dx21*dx21+dy21*dy21+dz21*dz21;vec3 d22=dx22*dx22+dy22*dy22+dz22*dz22;vec3 d23=dx23*dx23+dy23*dy23+dz23*dz23;vec3 d31=dx31*dx31+dy31*dy31+dz31*dz31;vec3 d32=dx32*dx32+dy32*dy32+dz32*dz32;vec3 d33=dx33*dx33+dy33*dy33+dz33*dz33;vec3 d1a=min(d11,d12);d12=max(d11,d12);d11=min(d1a,d13);d13=max(d1a,d13);d12=min(d12,d13);vec3 d2a=min(d21,d22);d22=max(d21,d22);d21=min(d2a,d23);d23=max(d2a,d23);d22=min(d22,d23);vec3 d3a=min(d31,d32);d32=max(d31,d32);d31=min(d3a,d33);d33=max(d3a,d33);d32=min(d32,d33);vec3 da=min(d11,d21);d21=max(d11,d21);d11=min(da,d31);d31=max(da,d31);d11.xy=(d11.x<d11.y)? d11.xy : d11.yx;d11.xz=(d11.x<d11.z)? d11.xz : d11.zx;d12=min(d12,d21);d12=min(d12,d22);d12=min(d12,d31);d12=min(d12,d32);d11.yz=min(d11.yz,d12.xy);d11.y=min(d11.y,d12.z);d11.y=min(d11.y,d11.z);return sqrt(d11.xy);}`,Yl=`#define GLSLIFY 1
vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec2 mod289(vec2 x){return x-floor(x*(1.0/289.0))*289.0;}float mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod7(vec4 x){return x-floor(x*(1.0/7.0))*7.0;}vec3 mod7(vec3 x){return x-floor(x*(1.0/7.0))*7.0;}vec4 permute(vec4 x){return mod289((34.0*x+1.0)*x);}vec3 permute(vec3 x){return mod289((34.0*x+1.0)*x);}float permute(float x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float taylorInvSqrt(float r){return 1.79284291400159-0.85373472095314*r;}vec4 fade(vec4 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec3 fade(vec3 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec2 fade(vec2 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}
#define K 0.142857142857
#define Ko 0.428571428571
#define K2 0.020408163265306
#define Kd2 0.0714285714285
#define Kz 0.166666666667
#define Kzo 0.416666666667
#define jitter 1.0
#define jitter1 0.8
`,Ql=`#define GLSLIFY 1
#include <noise_perlin_2D>
#include <noise_perlin_3D>
#include <noise_perlin_4D>
`,Kl=`#define GLSLIFY 1
float perlin(vec2 P){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}float perlin(vec2 P,vec2 rep){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod(Pi,rep.xyxy);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}`,Jl=`#define GLSLIFY 1
float perlin(vec3 P){vec3 Pi0=floor(P);vec3 Pi1=Pi0+vec3(1.0);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}float perlin(vec3 P,vec3 rep){vec3 Pi0=mod(floor(P),rep);vec3 Pi1=mod(Pi0+vec3(1.0),rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}`,Zl=`#define GLSLIFY 1
float perlin(vec4 P){vec4 Pi0=floor(P);vec4 Pi1=Pi0+1.0;Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}float perlin(vec4 P,vec4 rep){vec4 Pi0=mod(floor(P),rep);vec4 Pi1=mod(Pi0+1.0,rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}`,$l=`#define GLSLIFY 1
vec2 rgrad2(vec2 p,float rot){float u=permute(permute(p.x)+p.y)*0.0243902439+rot;u=fract(u)*6.28318530718;return vec2(cos(u),sin(u));}vec3 psrdnoise(vec2 pos,vec2 per,float rot){pos.y+=0.01;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 psdnoise(vec2 pos,vec2 per){return psrdnoise(pos,per,0.0);}float psrnoise(vec2 pos,vec2 per,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float psnoise(vec2 pos,vec2 per){return psrnoise(pos,per,0.0);}vec3 srdnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 sdnoise(vec2 pos){return srdnoise(pos,0.0);}float srnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float snoise(vec2 pos){return srnoise(pos,0.0);}`,e_=`#define GLSLIFY 1
#include <noise_simplex_2D>
#include <noise_simplex_3D>
#include <noise_simplex_3D_grad>
#include <noise_simplex_4D>
`,t_=`#define GLSLIFY 1
float simplex(vec2 v){const vec4 C=vec4(0.211324865405187,0.366025403784439,-0.577350269189626,0.024390243902439);vec2 i=floor(v+dot(v,C.yy));vec2 x0=v-i+dot(i,C.xx);vec2 i1;i1=(x0.x>x0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec4 x12=x0.xyxy+C.xxzz;x12.xy-=i1;i=mod289(i);vec3 p=permute(permute(i.y+vec3(0.0,i1.y,1.0))+i.x+vec3(0.0,i1.x,1.0));vec3 m=max(0.5-vec3(dot(x0,x0),dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)),0.0);m=m*m;m=m*m;vec3 x=2.0*fract(p*C.www)-1.0;vec3 h=abs(x)-0.5;vec3 ox=floor(x+0.5);vec3 a0=x-ox;m*=1.79284291400159-0.85373472095314*(a0*a0+h*h);vec3 g;g.x=a0.x*x0.x+h.x*x0.y;g.yz=a0.yz*x12.xz+h.yz*x12.yw;return 130.0*dot(m,g);}`,r_=`#define GLSLIFY 1
float simplex(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}`,n_=`#define GLSLIFY 1
float simplex(vec3 v,out vec3 gradient){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);vec4 m2=m*m;vec4 m4=m2*m2;vec4 pdotx=vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3));vec4 temp=m2*m*pdotx;gradient=-8.0*(temp.x*x0+temp.y*x1+temp.z*x2+temp.w*x3);gradient+=m4.x*p0+m4.y*p1+m4.z*p2+m4.w*p3;gradient*=42.0;return 42.0*dot(m4,pdotx);}`,a_=`#define GLSLIFY 1
vec4 grad4(float j,vec4 ip){const vec4 ones=vec4(1.0,1.0,1.0,-1.0);vec4 p,s;p.xyz=floor(fract(vec3(j)*ip.xyz)*7.0)*ip.z-1.0;p.w=1.5-dot(abs(p.xyz),ones.xyz);s=vec4(lessThan(p,vec4(0.0)));p.xyz=p.xyz+(s.xyz*2.0-1.0)*s.www;return p;}
#define F4 0.309016994374947451
float simplex(vec4 v){const vec4 C=vec4(0.138196601125011,0.276393202250021,0.414589803375032,-0.447213595499958);vec4 i=floor(v+dot(v,vec4(F4)));vec4 x0=v-i+dot(i,C.xxxx);vec4 i0;vec3 isX=step(x0.yzw,x0.xxx);vec3 isYZ=step(x0.zww,x0.yyz);i0.x=isX.x+isX.y+isX.z;i0.yzw=1.0-isX;i0.y+=isYZ.x+isYZ.y;i0.zw+=1.0-isYZ.xy;i0.z+=isYZ.z;i0.w+=1.0-isYZ.z;vec4 i3=clamp(i0,0.0,1.0);vec4 i2=clamp(i0-1.0,0.0,1.0);vec4 i1=clamp(i0-2.0,0.0,1.0);vec4 x1=x0-i1+C.xxxx;vec4 x2=x0-i2+C.yyyy;vec4 x3=x0-i3+C.zzzz;vec4 x4=x0+C.wwww;i=mod289(i);float j0=permute(permute(permute(permute(i.w)+i.z)+i.y)+i.x);vec4 j1=permute(permute(permute(permute(i.w+vec4(i1.w,i2.w,i3.w,1.0))+i.z+vec4(i1.z,i2.z,i3.z,1.0))+i.y+vec4(i1.y,i2.y,i3.y,1.0))+i.x+vec4(i1.x,i2.x,i3.x,1.0));vec4 ip=vec4(1.0/294.0,1.0/49.0,1.0/7.0,0.0);vec4 p0=grad4(j0,ip);vec4 p1=grad4(j1.x,ip);vec4 p2=grad4(j1.y,ip);vec4 p3=grad4(j1.z,ip);vec4 p4=grad4(j1.w,ip);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;p4*=taylorInvSqrt(dot(p4,p4));vec3 m0=max(0.6-vec3(dot(x0,x0),dot(x1,x1),dot(x2,x2)),0.0);vec2 m1=max(0.6-vec2(dot(x3,x3),dot(x4,x4)),0.0);m0=m0*m0;m1=m1*m1;return 49.0*(dot(m0*m0,vec3(dot(p0,x0),dot(p1,x1),dot(p2,x2)))+dot(m1*m1,vec2(dot(p3,x3),dot(p4,x4))));}`,i_=`#define GLSLIFY 1
#define MIN_PERCEPTUAL_ROUGHNESS 0.045
#define MIN_ROUGHNESS 0.002025
uniform float material_AlphaCutoff;uniform vec4 material_BaseColor;uniform float material_Metal;uniform float material_Roughness;uniform float material_IOR;uniform vec3 material_PBRSpecularColor;uniform float material_Glossiness;uniform vec3 material_EmissiveColor;uniform float material_NormalIntensity;uniform float material_OcclusionIntensity;uniform float material_OcclusionTextureCoord;
#ifdef MATERIAL_ENABLE_CLEAR_COAT
uniform float material_ClearCoat;uniform float material_ClearCoatRoughness;
#ifdef MATERIAL_HAS_CLEAR_COAT_TEXTURE
uniform sampler2D material_ClearCoatTexture;
#endif
#ifdef MATERIAL_HAS_CLEAR_COAT_ROUGHNESS_TEXTURE
uniform sampler2D material_ClearCoatRoughnessTexture;
#endif
#ifdef MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE
uniform sampler2D material_ClearCoatNormalTexture;
#endif
#endif
#ifdef MATERIAL_ENABLE_ANISOTROPY
uniform vec3 material_AnisotropyInfo;
#ifdef MATERIAL_HAS_ANISOTROPY_TEXTURE
uniform sampler2D material_AnisotropyTexture;
#endif
#endif
#ifdef MATERIAL_HAS_BASETEXTURE
uniform sampler2D material_BaseTexture;
#endif
#ifdef MATERIAL_HAS_NORMALTEXTURE
uniform sampler2D material_NormalTexture;
#endif
#ifdef MATERIAL_HAS_EMISSIVETEXTURE
uniform sampler2D material_EmissiveTexture;
#endif
#ifdef MATERIAL_HAS_ROUGHNESS_METALLIC_TEXTURE
uniform sampler2D material_RoughnessMetallicTexture;
#endif
#ifdef MATERIAL_HAS_SPECULAR_GLOSSINESS_TEXTURE
uniform sampler2D material_SpecularGlossinessTexture;
#endif
#ifdef MATERIAL_HAS_OCCLUSION_TEXTURE
uniform sampler2D material_OcclusionTexture;
#endif
struct ReflectedLight{vec3 directDiffuse;vec3 directSpecular;vec3 indirectDiffuse;vec3 indirectSpecular;};struct Geometry{vec3 position;vec3 normal;vec3 viewDir;float dotNV;
#ifdef MATERIAL_ENABLE_CLEAR_COAT
vec3 clearCoatNormal;float clearCoatDotNV;
#endif
#ifdef MATERIAL_ENABLE_ANISOTROPY
vec3 anisotropicT;vec3 anisotropicB;vec3 anisotropicN;float anisotropy;
#endif
};struct Material{vec3 diffuseColor;float roughness;vec3 specularColor;float opacity;float f0;
#ifdef MATERIAL_ENABLE_CLEAR_COAT
float clearCoat;float clearCoatRoughness;
#endif
};`,o_=`#define GLSLIFY 1
#include <normal_get>
float computeSpecularOcclusion(float ambientOcclusion,float roughness,float dotNV){return saturate(pow(dotNV+ambientOcclusion,exp2(-16.0*roughness-1.0))-1.0+ambientOcclusion);}float getAARoughnessFactor(vec3 normal){
#ifdef HAS_DERIVATIVES
vec3 dxy=max(abs(dFdx(normal)),abs(dFdy(normal)));return MIN_PERCEPTUAL_ROUGHNESS+max(max(dxy.x,dxy.y),dxy.z);
#else
return MIN_PERCEPTUAL_ROUGHNESS;
#endif
}
#ifdef MATERIAL_ENABLE_ANISOTROPY
vec3 getAnisotropicBentNormal(Geometry geometry,vec3 n,float roughness){vec3 anisotropyDirection=geometry.anisotropy>=0.0 ? geometry.anisotropicB : geometry.anisotropicT;vec3 anisotropicTangent=cross(anisotropyDirection,geometry.viewDir);vec3 anisotropicNormal=cross(anisotropicTangent,anisotropyDirection);vec3 bentNormal=normalize(mix(n,anisotropicNormal,abs(geometry.anisotropy)*saturate(5.0*roughness)));return bentNormal;}
#endif
void initGeometry(out Geometry geometry,bool isFrontFacing){geometry.position=v_pos;
#ifdef CAMERA_ORTHOGRAPHIC
geometry.viewDir=-camera_Forward;
#else
geometry.viewDir=normalize(camera_Position-v_pos);
#endif
#if defined(MATERIAL_HAS_NORMALTEXTURE) || defined(MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE) || defined(MATERIAL_ENABLE_ANISOTROPY)
mat3 tbn=getTBN(isFrontFacing);
#endif
#ifdef MATERIAL_HAS_NORMALTEXTURE
geometry.normal=getNormalByNormalTexture(tbn,material_NormalTexture,material_NormalIntensity,v_uv,isFrontFacing);
#else
geometry.normal=getNormal(isFrontFacing);
#endif
geometry.dotNV=saturate(dot(geometry.normal,geometry.viewDir));
#ifdef MATERIAL_ENABLE_CLEAR_COAT
#ifdef MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE
geometry.clearCoatNormal=getNormalByNormalTexture(tbn,material_ClearCoatNormalTexture,material_NormalIntensity,v_uv,isFrontFacing);
#else
geometry.clearCoatNormal=getNormal(isFrontFacing);
#endif
geometry.clearCoatDotNV=saturate(dot(geometry.clearCoatNormal,geometry.viewDir));
#endif
#ifdef MATERIAL_ENABLE_ANISOTROPY
float anisotropy=material_AnisotropyInfo.z;vec3 anisotropicDirection=vec3(material_AnisotropyInfo.xy,0.0);
#ifdef MATERIAL_HAS_ANISOTROPY_TEXTURE
vec3 anisotropyTextureInfo=texture2D(material_AnisotropyTexture,v_uv).rgb;anisotropy*=anisotropyTextureInfo.b;anisotropicDirection.xy*=anisotropyTextureInfo.rg*2.0-1.0;
#endif
geometry.anisotropy=anisotropy;geometry.anisotropicT=normalize(tbn*anisotropicDirection);geometry.anisotropicB=normalize(cross(geometry.normal,geometry.anisotropicT));
#endif
}void initMaterial(out Material material,inout Geometry geometry){vec4 baseColor=material_BaseColor;float metal=material_Metal;float roughness=material_Roughness;vec3 specularColor=material_PBRSpecularColor;float glossiness=material_Glossiness;float alphaCutoff=material_AlphaCutoff;float f0=pow2((material_IOR-1.0)/(material_IOR+1.0));material.f0=f0;
#ifdef MATERIAL_HAS_BASETEXTURE
vec4 baseTextureColor=texture2D(material_BaseTexture,v_uv);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
baseTextureColor=gammaToLinear(baseTextureColor);
#endif
baseColor*=baseTextureColor;
#endif
#ifdef RENDERER_ENABLE_VERTEXCOLOR
baseColor*=v_color;
#endif
#ifdef MATERIAL_IS_ALPHA_CUTOFF
if(baseColor.a<alphaCutoff){discard;}
#endif
#ifdef MATERIAL_HAS_ROUGHNESS_METALLIC_TEXTURE
vec4 metalRoughMapColor=texture2D(material_RoughnessMetallicTexture,v_uv);roughness*=metalRoughMapColor.g;metal*=metalRoughMapColor.b;
#endif
#ifdef MATERIAL_HAS_SPECULAR_GLOSSINESS_TEXTURE
vec4 specularGlossinessColor=texture2D(material_SpecularGlossinessTexture,v_uv);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
specularGlossinessColor=gammaToLinear(specularGlossinessColor);
#endif
specularColor*=specularGlossinessColor.rgb;glossiness*=specularGlossinessColor.a;
#endif
#ifdef IS_METALLIC_WORKFLOW
material.diffuseColor=baseColor.rgb*(1.0-metal);material.specularColor=mix(vec3(f0),baseColor.rgb,metal);material.roughness=roughness;
#else
float specularStrength=max(max(specularColor.r,specularColor.g),specularColor.b);material.diffuseColor=baseColor.rgb*(1.0-specularStrength);material.specularColor=specularColor;material.roughness=1.0-glossiness;
#endif
material.roughness=max(material.roughness,getAARoughnessFactor(geometry.normal));
#ifdef MATERIAL_ENABLE_CLEAR_COAT
material.clearCoat=material_ClearCoat;material.clearCoatRoughness=material_ClearCoatRoughness;
#ifdef MATERIAL_HAS_CLEAR_COAT_TEXTURE
material.clearCoat*=texture2D(material_ClearCoatTexture,v_uv).r;
#endif
#ifdef MATERIAL_HAS_CLEAR_COAT_ROUGHNESS_TEXTURE
material.clearCoatRoughness*=texture2D(material_ClearCoatRoughnessTexture,v_uv).g;
#endif
material.clearCoat=saturate(material.clearCoat);material.clearCoatRoughness=max(material.clearCoatRoughness,getAARoughnessFactor(geometry.clearCoatNormal));
#endif
#ifdef MATERIAL_IS_TRANSPARENT
material.opacity=baseColor.a;
#else
material.opacity=1.0;
#endif
#ifdef MATERIAL_ENABLE_ANISOTROPY
geometry.anisotropicN=getAnisotropicBentNormal(geometry,geometry.normal,material.roughness);
#endif
}
#include <brdf>
#include <direct_irradiance_frag_define>
#include <ibl_frag_define>
`,s_=`#define GLSLIFY 1
float F_Schlick(float f0,float dotLH){return f0+0.96*(pow(1.0-dotLH,5.0));}vec3 F_Schlick(vec3 specularColor,float dotLH){float fresnel=exp2((-5.55473*dotLH-6.98316)*dotLH);return(1.0-specularColor)*fresnel+specularColor;}float G_GGX_SmithCorrelated(float alpha,float dotNL,float dotNV){float a2=pow2(alpha);float gv=dotNL*sqrt(a2+(1.0-a2)*pow2(dotNV));float gl=dotNV*sqrt(a2+(1.0-a2)*pow2(dotNL));return 0.5/max(gv+gl,EPSILON);}
#ifdef MATERIAL_ENABLE_ANISOTROPY
float G_GGX_SmithCorrelated_Anisotropic(float at,float ab,float ToV,float BoV,float ToL,float BoL,float NoV,float NoL){float lambdaV=NoL*length(vec3(at*ToV,ab*BoV,NoV));float lambdaL=NoV*length(vec3(at*ToL,ab*BoL,NoL));return 0.5/max(lambdaV+lambdaL,EPSILON);}
#endif
float D_GGX(float alpha,float dotNH){float a2=pow2(alpha);float denom=pow2(dotNH)*(a2-1.0)+1.0;return RECIPROCAL_PI*a2/pow2(denom);}
#ifdef MATERIAL_ENABLE_ANISOTROPY
float D_GGX_Anisotropic(float at,float ab,float ToH,float BoH,float NoH){float a2=at*ab;highp vec3 d=vec3(ab*ToH,at*BoH,a2*NoH);highp float d2=dot(d,d);float b2=a2/d2;return a2*b2*b2*RECIPROCAL_PI;}
#endif
vec3 isotropicLobe(vec3 specularColor,float alpha,float dotNV,float dotNL,float dotNH,float dotLH){vec3 F=F_Schlick(specularColor,dotLH);float D=D_GGX(alpha,dotNH);float G=G_GGX_SmithCorrelated(alpha,dotNL,dotNV);return F*(G*D);}
#ifdef MATERIAL_ENABLE_ANISOTROPY
vec3 anisotropicLobe(vec3 h,vec3 l,Geometry geometry,vec3 specularColor,float alpha,float dotNV,float dotNL,float dotNH,float dotLH){vec3 t=geometry.anisotropicT;vec3 b=geometry.anisotropicB;vec3 v=geometry.viewDir;float dotTV=dot(t,v);float dotBV=dot(b,v);float dotTL=dot(t,l);float dotBL=dot(b,l);float dotTH=dot(t,h);float dotBH=dot(b,h);float at=max(alpha*(1.0+geometry.anisotropy),MIN_ROUGHNESS);float ab=max(alpha*(1.0-geometry.anisotropy),MIN_ROUGHNESS);vec3 F=F_Schlick(specularColor,dotLH);float D=D_GGX_Anisotropic(at,ab,dotTH,dotBH,dotNH);float G=G_GGX_SmithCorrelated_Anisotropic(at,ab,dotTV,dotBV,dotTL,dotBL,dotNV,dotNL);return F*(G*D);}
#endif
vec3 BRDF_Specular_GGX(vec3 incidentDirection,Geometry geometry,vec3 normal,vec3 specularColor,float roughness){float alpha=pow2(roughness);vec3 halfDir=normalize(incidentDirection+geometry.viewDir);float dotNL=saturate(dot(normal,incidentDirection));float dotNV=saturate(dot(normal,geometry.viewDir));float dotNH=saturate(dot(normal,halfDir));float dotLH=saturate(dot(incidentDirection,halfDir));
#ifdef MATERIAL_ENABLE_ANISOTROPY
return anisotropicLobe(halfDir,incidentDirection,geometry,specularColor,alpha,dotNV,dotNL,dotNH,dotLH);
#else
return isotropicLobe(specularColor,alpha,dotNV,dotNL,dotNH,dotLH);
#endif
}vec3 BRDF_Diffuse_Lambert(vec3 diffuseColor){return RECIPROCAL_PI*diffuseColor;}`,c_=`#define GLSLIFY 1
#include <ShadowFragmentDeclaration>
void addDirectRadiance(vec3 incidentDirection,vec3 color,Geometry geometry,Material material,inout ReflectedLight reflectedLight){float attenuation=1.0;
#ifdef MATERIAL_ENABLE_CLEAR_COAT
float clearCoatDotNL=saturate(dot(geometry.clearCoatNormal,incidentDirection));vec3 clearCoatIrradiance=clearCoatDotNL*color;reflectedLight.directSpecular+=material.clearCoat*clearCoatIrradiance*BRDF_Specular_GGX(incidentDirection,geometry,geometry.clearCoatNormal,vec3(0.04),material.clearCoatRoughness);attenuation-=material.clearCoat*F_Schlick(material.f0,geometry.clearCoatDotNV);
#endif
float dotNL=saturate(dot(geometry.normal,incidentDirection));vec3 irradiance=dotNL*color*PI;reflectedLight.directSpecular+=attenuation*irradiance*BRDF_Specular_GGX(incidentDirection,geometry,geometry.normal,material.specularColor,material.roughness);reflectedLight.directDiffuse+=attenuation*irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}
#ifdef SCENE_DIRECT_LIGHT_COUNT
void addDirectionalDirectLightRadiance(DirectLight directionalLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 color=directionalLight.color;vec3 direction=-directionalLight.direction;addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
#ifdef SCENE_POINT_LIGHT_COUNT
void addPointDirectLightRadiance(PointLight pointLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 lVector=pointLight.position-geometry.position;vec3 direction=normalize(lVector);float lightDistance=length(lVector);vec3 color=pointLight.color;color*=clamp(1.0-pow(lightDistance/pointLight.distance,4.0),0.0,1.0);addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
#ifdef SCENE_SPOT_LIGHT_COUNT
void addSpotDirectLightRadiance(SpotLight spotLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 lVector=spotLight.position-geometry.position;vec3 direction=normalize(lVector);float lightDistance=length(lVector);float angleCos=dot(direction,-spotLight.direction);float spotEffect=smoothstep(spotLight.penumbraCos,spotLight.angleCos,angleCos);float decayEffect=clamp(1.0-pow(lightDistance/spotLight.distance,4.0),0.0,1.0);vec3 color=spotLight.color;color*=spotEffect*decayEffect;addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
void addTotalDirectRadiance(Geometry geometry,Material material,inout ReflectedLight reflectedLight){float shadowAttenuation=1.0;
#ifdef SCENE_DIRECT_LIGHT_COUNT
shadowAttenuation=1.0;
#ifdef SCENE_IS_CALCULATE_SHADOWS
shadowAttenuation*=sampleShadowMap();
#endif
DirectLight directionalLight;for(int i=0;i<SCENE_DIRECT_LIGHT_COUNT;i++){if(!isRendererCulledByLight(renderer_Layer.xy,scene_DirectLightCullingMask[i])){directionalLight.color=scene_DirectLightColor[i];
#ifdef SCENE_IS_CALCULATE_SHADOWS
if(i==0){directionalLight.color*=shadowAttenuation;}
#endif
directionalLight.direction=scene_DirectLightDirection[i];addDirectionalDirectLightRadiance(directionalLight,geometry,material,reflectedLight);}}
#endif
#ifdef SCENE_POINT_LIGHT_COUNT
PointLight pointLight;for(int i=0;i<SCENE_POINT_LIGHT_COUNT;i++){if(!isRendererCulledByLight(renderer_Layer.xy,scene_PointLightCullingMask[i])){pointLight.color=scene_PointLightColor[i];pointLight.position=scene_PointLightPosition[i];pointLight.distance=scene_PointLightDistance[i];addPointDirectLightRadiance(pointLight,geometry,material,reflectedLight);}}
#endif
#ifdef SCENE_SPOT_LIGHT_COUNT
SpotLight spotLight;for(int i=0;i<SCENE_SPOT_LIGHT_COUNT;i++){if(!isRendererCulledByLight(renderer_Layer.xy,scene_SpotLightCullingMask[i])){spotLight.color=scene_SpotLightColor[i];spotLight.position=scene_SpotLightPosition[i];spotLight.direction=scene_SpotLightDirection[i];spotLight.distance=scene_SpotLightDistance[i];spotLight.angleCos=scene_SpotLightAngleCos[i];spotLight.penumbraCos=scene_SpotLightPenumbraCos[i];addSpotDirectLightRadiance(spotLight,geometry,material,reflectedLight);}}
#endif
}`,l_=`#define GLSLIFY 1
vec3 getLightProbeIrradiance(vec3 sh[9],vec3 normal){normal.x=-normal.x;vec3 result=sh[0]+sh[1]*(normal.y)+sh[2]*(normal.z)+sh[3]*(normal.x)+sh[4]*(normal.y*normal.x)+sh[5]*(normal.y*normal.z)+sh[6]*(3.0*normal.z*normal.z-1.0)+sh[7]*(normal.z*normal.x)+sh[8]*(normal.x*normal.x-normal.y*normal.y);return max(result,vec3(0.0));}vec3 envBRDFApprox(vec3 specularColor,float roughness,float dotNV){const vec4 c0=vec4(-1,-0.0275,-0.572,0.022);const vec4 c1=vec4(1,0.0425,1.04,-0.04);vec4 r=roughness*c0+c1;float a004=min(r.x*r.x,exp2(-9.28*dotNV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}float getSpecularMIPLevel(float roughness,int maxMIPLevel){return roughness*float(maxMIPLevel);}vec3 getReflectedVector(Geometry geometry,vec3 n){
#ifdef MATERIAL_ENABLE_ANISOTROPY
vec3 r=reflect(-geometry.viewDir,geometry.anisotropicN);
#else
vec3 r=reflect(-geometry.viewDir,n);
#endif
return r;}vec3 getLightProbeRadiance(Geometry geometry,vec3 normal,float roughness,int maxMIPLevel,float specularIntensity){
#ifndef SCENE_USE_SPECULAR_ENV
return vec3(0);
#else
vec3 reflectVec=getReflectedVector(geometry,normal);reflectVec.x=-reflectVec.x;float specularMIPLevel=getSpecularMIPLevel(roughness,maxMIPLevel);
#ifdef HAS_TEX_LOD
vec4 envMapColor=textureCubeLodEXT(scene_EnvSpecularSampler,reflectVec,specularMIPLevel);
#else
vec4 envMapColor=textureCube(scene_EnvSpecularSampler,reflectVec,specularMIPLevel);
#endif
#ifdef SCENE_IS_DECODE_ENV_RGBM
envMapColor.rgb=RGBMToLinear(envMapColor,5.0).rgb;
#ifdef ENGINE_IS_COLORSPACE_GAMMA
envMapColor=linearToGamma(envMapColor);
#endif
#else
#ifndef ENGINE_IS_COLORSPACE_GAMMA
envMapColor=gammaToLinear(envMapColor);
#endif
#endif
return envMapColor.rgb*specularIntensity;
#endif
}`,__=`#define GLSLIFY 1
Geometry geometry;Material material;ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));initGeometry(geometry,gl_FrontFacing);initMaterial(material,geometry);addTotalDirectRadiance(geometry,material,reflectedLight);
#ifdef SCENE_USE_SH
vec3 irradiance=getLightProbeIrradiance(scene_EnvSH,geometry.normal);
#ifdef ENGINE_IS_COLORSPACE_GAMMA
irradiance=linearToGamma(vec4(irradiance,1.0)).rgb;
#endif
irradiance*=scene_EnvMapLight.diffuseIntensity;
#else
vec3 irradiance=scene_EnvMapLight.diffuse*scene_EnvMapLight.diffuseIntensity;irradiance*=PI;
#endif
reflectedLight.indirectDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);vec3 radiance=getLightProbeRadiance(geometry,geometry.normal,material.roughness,int(scene_EnvMapLight.mipMapLevel),scene_EnvMapLight.specularIntensity);float radianceAttenuation=1.0;
#ifdef MATERIAL_ENABLE_CLEAR_COAT
vec3 clearCoatRadiance=getLightProbeRadiance(geometry,geometry.clearCoatNormal,material.clearCoatRoughness,int(scene_EnvMapLight.mipMapLevel),scene_EnvMapLight.specularIntensity);reflectedLight.indirectSpecular+=clearCoatRadiance*material.clearCoat*envBRDFApprox(vec3(0.04),material.clearCoatRoughness,geometry.clearCoatDotNV);radianceAttenuation-=material.clearCoat*F_Schlick(material.f0,geometry.clearCoatDotNV);
#endif
reflectedLight.indirectSpecular+=radianceAttenuation*radiance*envBRDFApprox(material.specularColor,material.roughness,geometry.dotNV);
#ifdef MATERIAL_HAS_OCCLUSION_TEXTURE
vec2 aoUV=v_uv;
#ifdef RENDERER_HAS_UV1
if(material_OcclusionTextureCoord==1.0){aoUV=v_uv1;}
#endif
float ambientOcclusion=(texture2D(material_OcclusionTexture,aoUV).r-1.0)*material_OcclusionIntensity+1.0;reflectedLight.indirectDiffuse*=ambientOcclusion;
#ifdef SCENE_USE_SPECULAR_ENV
reflectedLight.indirectSpecular*=computeSpecularOcclusion(ambientOcclusion,material.roughness,geometry.dotNV);
#endif
#endif
vec3 emissiveRadiance=material_EmissiveColor;
#ifdef MATERIAL_HAS_EMISSIVETEXTURE
vec4 emissiveColor=texture2D(material_EmissiveTexture,v_uv);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
emissiveColor=gammaToLinear(emissiveColor);
#endif
emissiveRadiance*=emissiveColor.rgb;
#endif
vec3 totalRadiance=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+emissiveRadiance;vec4 targetColor=vec4(totalRadiance,material.opacity);gl_FragColor=targetColor;`,u_={pbr_frag_define:i_,pbr_helper:o_,brdf:s_,direct_irradiance_frag_define:c_,ibl_frag_define:l_,pbr_frag:__},h_=`#define GLSLIFY 1
uniform mat4 scene_ShadowMatrices[SCENE_SHADOW_CASCADED_COUNT+1];uniform vec4 scene_ShadowSplitSpheres[4];mediump int computeCascadeIndex(vec3 positionWS){vec3 fromCenter0=positionWS-scene_ShadowSplitSpheres[0].xyz;vec3 fromCenter1=positionWS-scene_ShadowSplitSpheres[1].xyz;vec3 fromCenter2=positionWS-scene_ShadowSplitSpheres[2].xyz;vec3 fromCenter3=positionWS-scene_ShadowSplitSpheres[3].xyz;mediump vec4 comparison=vec4(dot(fromCenter0,fromCenter0)<scene_ShadowSplitSpheres[0].w,dot(fromCenter1,fromCenter1)<scene_ShadowSplitSpheres[1].w,dot(fromCenter2,fromCenter2)<scene_ShadowSplitSpheres[2].w,dot(fromCenter3,fromCenter3)<scene_ShadowSplitSpheres[3].w);comparison.yzw=clamp(comparison.yzw-comparison.xyz,0.0,1.0);mediump vec4 indexCoefficient=vec4(4.0,3.0,2.0,1.0);mediump int index=4-int(dot(comparison,indexCoefficient));return index;}vec3 getShadowCoord(){
#if SCENE_SHADOW_CASCADED_COUNT == 1
mediump int cascadeIndex=0;
#else
mediump int cascadeIndex=computeCascadeIndex(v_pos);
#endif
#ifdef GRAPHICS_API_WEBGL2
mat4 shadowMatrix=scene_ShadowMatrices[cascadeIndex];
#else
mat4 shadowMatrix;
#if SCENE_SHADOW_CASCADED_COUNT == 4
if(cascadeIndex==0){shadowMatrix=scene_ShadowMatrices[0];}else if(cascadeIndex==1){shadowMatrix=scene_ShadowMatrices[1];}else if(cascadeIndex==2){shadowMatrix=scene_ShadowMatrices[2];}else if(cascadeIndex==3){shadowMatrix=scene_ShadowMatrices[3];}else{shadowMatrix=scene_ShadowMatrices[4];}
#endif
#if SCENE_SHADOW_CASCADED_COUNT == 2
if(cascadeIndex==0){shadowMatrix=scene_ShadowMatrices[0];}else if(cascadeIndex==1){shadowMatrix=scene_ShadowMatrices[1];}else{shadowMatrix=scene_ShadowMatrices[2];}
#endif
#if SCENE_SHADOW_CASCADED_COUNT == 1
if(cascadeIndex==0){shadowMatrix=scene_ShadowMatrices[0];}else{shadowMatrix=scene_ShadowMatrices[1];}
#endif
#endif
vec4 shadowCoord=shadowMatrix*vec4(v_pos,1.0);return shadowCoord.xyz;}`,d_=`#define GLSLIFY 1
#if defined(SCENE_SHADOW_TYPE) && defined(RENDERER_IS_RECEIVE_SHADOWS)
#define SCENE_IS_CALCULATE_SHADOWS
#endif
#ifdef SCENE_IS_CALCULATE_SHADOWS
#if SCENE_SHADOW_CASCADED_COUNT == 1
varying vec3 v_shadowCoord;
#else
#include <ShadowCoord>
#endif
uniform vec4 scene_ShadowInfo;uniform vec4 scene_ShadowMapSize;
#ifdef GRAPHICS_API_WEBGL2
uniform mediump sampler2DShadow scene_ShadowMap;
#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) textureLod(textureName, coord3 , 0.0)
#define TEXTURE2D_SHADOW_PARAM(shadowMap) mediump sampler2DShadow shadowMap
#else
uniform sampler2D scene_ShadowMap;
#ifdef ENGINE_NO_DEPTH_TEXTURE
const vec4 bitShift=vec4(1.0,1.0/256.0,1.0/(256.0*256.0),1.0/(256.0*256.0*256.0));float unpack(const in vec4 rgbaDepth){return dot(rgbaDepth,bitShift);}
#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) (unpack(texture2D(textureName, coord3.xy)) < coord3.z ? 0.0 : 1.0)
#else
#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) (texture2D(textureName, coord3.xy).r < coord3.z ? 0.0 : 1.0)
#endif
#define TEXTURE2D_SHADOW_PARAM(shadowMap) mediump sampler2D shadowMap
#endif
#if SCENE_SHADOW_TYPE == 2
float sampleShadowMapFiltered4(TEXTURE2D_SHADOW_PARAM(shadowMap),vec3 shadowCoord,vec4 shadowMapSize){float attenuation;vec4 attenuation4;vec2 offset=shadowMapSize.xy/2.0;vec3 shadowCoord0=shadowCoord+vec3(-offset,0.0);vec3 shadowCoord1=shadowCoord+vec3(offset.x,-offset.y,0.0);vec3 shadowCoord2=shadowCoord+vec3(-offset.x,offset.y,0.0);vec3 shadowCoord3=shadowCoord+vec3(offset,0.0);attenuation4.x=SAMPLE_TEXTURE2D_SHADOW(shadowMap,shadowCoord0);attenuation4.y=SAMPLE_TEXTURE2D_SHADOW(shadowMap,shadowCoord1);attenuation4.z=SAMPLE_TEXTURE2D_SHADOW(shadowMap,shadowCoord2);attenuation4.w=SAMPLE_TEXTURE2D_SHADOW(shadowMap,shadowCoord3);attenuation=dot(attenuation4,vec4(0.25));return attenuation;}
#endif
#if SCENE_SHADOW_TYPE == 3
#include <shadow_sample_tent>
float sampleShadowMapFiltered9(TEXTURE2D_SHADOW_PARAM(shadowMap),vec3 shadowCoord,vec4 shadowmapSize){float attenuation;float fetchesWeights[9];vec2 fetchesUV[9];sampleShadowComputeSamplesTent5x5(shadowmapSize,shadowCoord.xy,fetchesWeights,fetchesUV);attenuation=fetchesWeights[0]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[0].xy,shadowCoord.z));attenuation+=fetchesWeights[1]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[1].xy,shadowCoord.z));attenuation+=fetchesWeights[2]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[2].xy,shadowCoord.z));attenuation+=fetchesWeights[3]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[3].xy,shadowCoord.z));attenuation+=fetchesWeights[4]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[4].xy,shadowCoord.z));attenuation+=fetchesWeights[5]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[5].xy,shadowCoord.z));attenuation+=fetchesWeights[6]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[6].xy,shadowCoord.z));attenuation+=fetchesWeights[7]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[7].xy,shadowCoord.z));attenuation+=fetchesWeights[8]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[8].xy,shadowCoord.z));return attenuation;}
#endif
float getShadowFade(vec3 positionWS){vec3 camToPixel=positionWS-camera_Position;float distanceCamToPixel2=dot(camToPixel,camToPixel);return saturate(distanceCamToPixel2*scene_ShadowInfo.z+scene_ShadowInfo.w);}float sampleShadowMap(){
#if SCENE_SHADOW_CASCADED_COUNT == 1
vec3 shadowCoord=v_shadowCoord;
#else
vec3 shadowCoord=getShadowCoord();
#endif
float attenuation=1.0;if(shadowCoord.z>0.0&&shadowCoord.z<1.0){
#if SCENE_SHADOW_TYPE == 1
attenuation=SAMPLE_TEXTURE2D_SHADOW(scene_ShadowMap,shadowCoord);
#endif
#if SCENE_SHADOW_TYPE == 2
attenuation=sampleShadowMapFiltered4(scene_ShadowMap,shadowCoord,scene_ShadowMapSize);
#endif
#if SCENE_SHADOW_TYPE == 3
attenuation=sampleShadowMapFiltered9(scene_ShadowMap,shadowCoord,scene_ShadowMapSize);
#endif
float shadowFade=getShadowFade(v_pos);attenuation=mix(1.0,mix(attenuation,1.0,shadowFade),scene_ShadowInfo.x);}return attenuation;}
#endif
`,f_=`#define GLSLIFY 1
float sampleShadowGetIRTriangleTexelArea(float triangleHeight){return triangleHeight-0.5;}void sampleShadowGetTexelAreasTent3x3(float offset,out vec4 computedArea,out vec4 computedAreaUncut){float a=offset+0.5;float offsetSquaredHalved=a*a*0.5;computedAreaUncut.x=computedArea.x=offsetSquaredHalved-offset;computedAreaUncut.w=computedArea.w=offsetSquaredHalved;computedAreaUncut.y=sampleShadowGetIRTriangleTexelArea(1.5-offset);float clampedOffsetLeft=min(offset,0.0);float areaOfSmallLeftTriangle=clampedOffsetLeft*clampedOffsetLeft;computedArea.y=computedAreaUncut.y-areaOfSmallLeftTriangle;computedAreaUncut.z=sampleShadowGetIRTriangleTexelArea(1.5+offset);float clampedOffsetRight=max(offset,0.0);float areaOfSmallRightTriangle=clampedOffsetRight*clampedOffsetRight;computedArea.z=computedAreaUncut.z-areaOfSmallRightTriangle;}void sampleShadowGetTexelWeightsTent5x5(float offset,out vec3 texelsWeightsA,out vec3 texelsWeightsB){vec4 areaFrom3texelTriangle;vec4 areaUncutFrom3texelTriangle;sampleShadowGetTexelAreasTent3x3(offset,areaFrom3texelTriangle,areaUncutFrom3texelTriangle);texelsWeightsA.x=0.16*(areaFrom3texelTriangle.x);texelsWeightsA.y=0.16*(areaUncutFrom3texelTriangle.y);texelsWeightsA.z=0.16*(areaFrom3texelTriangle.y+1.0);texelsWeightsB.x=0.16*(areaFrom3texelTriangle.z+1.0);texelsWeightsB.y=0.16*(areaUncutFrom3texelTriangle.z);texelsWeightsB.z=0.16*(areaFrom3texelTriangle.w);}void sampleShadowComputeSamplesTent5x5(vec4 shadowMapTextureTexelSize,vec2 coord,out float fetchesWeights[9],out vec2 fetchesUV[9]){vec2 tentCenterInTexelSpace=coord.xy*shadowMapTextureTexelSize.zw;vec2 centerOfFetchesInTexelSpace=floor(tentCenterInTexelSpace+0.5);vec2 offsetFromTentCenterToCenterOfFetches=tentCenterInTexelSpace-centerOfFetchesInTexelSpace;vec3 texelsWeightsUA,texelsWeightsUB;vec3 texelsWeightsVA,texelsWeightsVB;sampleShadowGetTexelWeightsTent5x5(offsetFromTentCenterToCenterOfFetches.x,texelsWeightsUA,texelsWeightsUB);sampleShadowGetTexelWeightsTent5x5(offsetFromTentCenterToCenterOfFetches.y,texelsWeightsVA,texelsWeightsVB);vec3 fetchesWeightsU=vec3(texelsWeightsUA.xz,texelsWeightsUB.y)+vec3(texelsWeightsUA.y,texelsWeightsUB.xz);vec3 fetchesWeightsV=vec3(texelsWeightsVA.xz,texelsWeightsVB.y)+vec3(texelsWeightsVA.y,texelsWeightsVB.xz);vec3 fetchesOffsetsU=vec3(texelsWeightsUA.y,texelsWeightsUB.xz)/fetchesWeightsU.xyz+vec3(-2.5,-0.5,1.5);vec3 fetchesOffsetsV=vec3(texelsWeightsVA.y,texelsWeightsVB.xz)/fetchesWeightsV.xyz+vec3(-2.5,-0.5,1.5);fetchesOffsetsU*=shadowMapTextureTexelSize.xxx;fetchesOffsetsV*=shadowMapTextureTexelSize.yyy;vec2 bilinearFetchOrigin=centerOfFetchesInTexelSpace*shadowMapTextureTexelSize.xy;fetchesUV[0]=bilinearFetchOrigin+vec2(fetchesOffsetsU.x,fetchesOffsetsV.x);fetchesUV[1]=bilinearFetchOrigin+vec2(fetchesOffsetsU.y,fetchesOffsetsV.x);fetchesUV[2]=bilinearFetchOrigin+vec2(fetchesOffsetsU.z,fetchesOffsetsV.x);fetchesUV[3]=bilinearFetchOrigin+vec2(fetchesOffsetsU.x,fetchesOffsetsV.y);fetchesUV[4]=bilinearFetchOrigin+vec2(fetchesOffsetsU.y,fetchesOffsetsV.y);fetchesUV[5]=bilinearFetchOrigin+vec2(fetchesOffsetsU.z,fetchesOffsetsV.y);fetchesUV[6]=bilinearFetchOrigin+vec2(fetchesOffsetsU.x,fetchesOffsetsV.z);fetchesUV[7]=bilinearFetchOrigin+vec2(fetchesOffsetsU.y,fetchesOffsetsV.z);fetchesUV[8]=bilinearFetchOrigin+vec2(fetchesOffsetsU.z,fetchesOffsetsV.z);fetchesWeights[0]=fetchesWeightsU.x*fetchesWeightsV.x;fetchesWeights[1]=fetchesWeightsU.y*fetchesWeightsV.x;fetchesWeights[2]=fetchesWeightsU.z*fetchesWeightsV.x;fetchesWeights[3]=fetchesWeightsU.x*fetchesWeightsV.y;fetchesWeights[4]=fetchesWeightsU.y*fetchesWeightsV.y;fetchesWeights[5]=fetchesWeightsU.z*fetchesWeightsV.y;fetchesWeights[6]=fetchesWeightsU.x*fetchesWeightsV.z;fetchesWeights[7]=fetchesWeightsU.y*fetchesWeightsV.z;fetchesWeights[8]=fetchesWeightsU.z*fetchesWeightsV.z;}`,v_=`#define GLSLIFY 1
#if defined(SCENE_SHADOW_TYPE) && defined(RENDERER_IS_RECEIVE_SHADOWS)
#define SCENE_IS_CALCULATE_SHADOWS
#endif
#ifdef SCENE_IS_CALCULATE_SHADOWS
#if SCENE_SHADOW_CASCADED_COUNT==1
#include <ShadowCoord>
varying vec3 v_shadowCoord;
#endif
#endif
`,p_=`#define GLSLIFY 1
#ifdef SCENE_IS_CALCULATE_SHADOWS
#if SCENE_SHADOW_CASCADED_COUNT == 1
v_shadowCoord=getShadowCoord();
#endif
#endif
`,g_={ShadowCoord:h_,ShadowFragmentDeclaration:d_,shadow_sample_tent:f_,ShadowVertexDeclaration:v_,ShadowVertex:p_},m_=`#define GLSLIFY 1
vec3 rotationByEuler(in vec3 vector,in vec3 rot){float halfRoll=rot.z*0.5;float halfPitch=rot.x*0.5;float halfYaw=rot.y*0.5;float sinRoll=sin(halfRoll);float cosRoll=cos(halfRoll);float sinPitch=sin(halfPitch);float cosPitch=cos(halfPitch);float sinYaw=sin(halfYaw);float cosYaw=cos(halfYaw);float quaX=(cosYaw*sinPitch*cosRoll)+(sinYaw*cosPitch*sinRoll);float quaY=(sinYaw*cosPitch*cosRoll)-(cosYaw*sinPitch*sinRoll);float quaZ=(cosYaw*cosPitch*sinRoll)-(sinYaw*sinPitch*cosRoll);float quaW=(cosYaw*cosPitch*cosRoll)+(sinYaw*sinPitch*sinRoll);float x=quaX+quaX;float y=quaY+quaY;float z=quaZ+quaZ;float wx=quaW*x;float wy=quaW*y;float wz=quaW*z;float xx=quaX*x;float xy=quaX*y;float xz=quaX*z;float yy=quaY*y;float yz=quaY*z;float zz=quaZ*z;return vec3(((vector.x*((1.0-yy)-zz))+(vector.y*(xy-wz)))+(vector.z*(xz+wy)),((vector.x*(xy+wz))+(vector.y*((1.0-xx)-zz)))+(vector.z*(yz-wx)),((vector.x*(xz-wy))+(vector.y*(yz+wx)))+(vector.z*((1.0-xx)-yy)));}vec3 rotationByAxis(in vec3 vector,in vec3 axis,in float angle){float halfAngle=angle*0.5;float sin=sin(halfAngle);float quaX=axis.x*sin;float quaY=axis.y*sin;float quaZ=axis.z*sin;float quaW=cos(halfAngle);float x=quaX+quaX;float y=quaY+quaY;float z=quaZ+quaZ;float wx=quaW*x;float wy=quaW*y;float wz=quaW*z;float xx=quaX*x;float xy=quaX*y;float xz=quaX*z;float yy=quaY*y;float yz=quaY*z;float zz=quaZ*z;return vec3(((vector.x*((1.0-yy)-zz))+(vector.y*(xy-wz)))+(vector.z*(xz+wy)),((vector.x*(xy+wz))+(vector.y*((1.0-xx)-zz)))+(vector.z*(yz-wx)),((vector.x*(xz-wy))+(vector.y*(yz+wx)))+(vector.z*((1.0-xx)-yy)));}vec3 rotationByQuaternions(in vec3 v,in vec4 q){return v+2.0*cross(q.xyz,cross(q.xyz,v)+q.w*v);}float evaluateParticleCurve(in vec2 keys[4],in float normalizedAge){float value;for(int i=1;i<4;i++){vec2 key=keys[i];float time=key.x;if(time>=normalizedAge){vec2 lastKey=keys[i-1];float lastTime=lastKey.x;float age=(normalizedAge-lastTime)/(time-lastTime);value=mix(lastKey.y,key.y,age);break;}}return value;}float evaluateParticleCurveCumulative(in vec2 keys[4],in float normalizedAge){float cumulativeValue=0.0;for(int i=1;i<4;i++){vec2 key=keys[i];float time=key.x;vec2 lastKey=keys[i-1];float lastValue=lastKey.y;if(time>=normalizedAge){float lastTime=lastKey.x;float offsetTime=normalizedAge-lastTime;float age=offsetTime/(time-lastTime);cumulativeValue+=(lastValue+mix(lastValue,key.y,age))*0.5*offsetTime;break;}else{cumulativeValue+=(lastValue+key.y)*0.5*(time-lastKey.x);}}return cumulativeValue;}`,y_=`#define GLSLIFY 1
#if defined(RENDERER_VOL_CONSTANT) || defined(RENDERER_VOL_CURVE) || defined(RENDERER_VOL_RANDOM_CONSTANT) || defined(RENDERER_VOL_RANDOM_CURVE)
uniform int renderer_VOLSpace;
#if defined(RENDERER_VOL_CONSTANT) || defined(RENDERER_VOL_RANDOM_CONSTANT)
uniform vec3 renderer_VOLMaxConst;
#ifdef RENDERER_VOL_RANDOM_CONSTANT
uniform vec3 renderer_VOLMinConst;
#endif
#endif
#if defined(RENDERER_VOL_CURVE) || defined(RENDERER_VOL_RANDOM_CURVE)
uniform vec2 renderer_VOLMaxGradientX[4];uniform vec2 renderer_VOLMaxGradientY[4];uniform vec2 renderer_VOLMaxGradientZ[4];
#ifdef RENDERER_VOL_RANDOM_CURVE
uniform vec2 renderer_VOLMinGradientX[4];uniform vec2 renderer_VOLMinGradientY[4];uniform vec2 renderer_VOLMinGradientZ[4];
#endif
#endif
#endif
#if defined(RENDERER_VOL_CONSTANT) || defined(RENDERER_VOL_CURVE) || defined(RENDERER_VOL_RANDOM_CONSTANT) || defined(RENDERER_VOL_RANDOM_CURVE)
vec3 computeParticleLifeVelocity(in float normalizedAge){vec3 velocity;
#if defined(RENDERER_VOL_CONSTANT) || defined(RENDERER_VOL_RANDOM_CONSTANT)
velocity=renderer_VOLMaxConst;
#ifdef RENDERER_VOL_RANDOM_CONSTANT
velocity=mix(renderer_VOLMinConst,velocity,vec3(a_Random1.y,a_Random1.z,a_Random1.w));
#endif
#endif
#if defined(RENDERER_VOL_CURVE) || defined(RENDERER_VOL_RANDOM_CURVE)
velocity=vec3(evaluateParticleCurve(renderer_VOLMaxGradientX,normalizedAge),evaluateParticleCurve(renderer_VOLMaxGradientY,normalizedAge),evaluateParticleCurve(renderer_VOLMaxGradientZ,normalizedAge));
#endif
#ifdef RENDERER_VOL_RANDOM_CURVE
velocity=vec3(mix(velocity.x,evaluateParticleCurve(renderer_VOLMinGradientX,normalizedAge),a_Random1.y),mix(velocity.y,evaluateParticleCurve(renderer_VOLMinGradientY,normalizedAge),a_Random1.z),mix(velocity.z,evaluateParticleCurve(renderer_VOLMinGradientZ,normalizedAge),a_Random1.w));
#endif
return velocity;}
#endif
vec3 getStartPosition(vec3 startVelocity,float age,vec3 dragData){vec3 startPosition;float lastTime=min(startVelocity.x/dragData.x,age);startPosition=lastTime*(startVelocity-0.5*dragData*lastTime);return startPosition;}vec3 computeParticlePosition(in vec3 startVelocity,in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation,vec3 dragData){vec3 startPosition=getStartPosition(startVelocity,age,dragData);vec3 lifePosition;
#if defined(RENDERER_VOL_CONSTANT) || defined(RENDERER_VOL_CURVE) || defined(RENDERER_VOL_RANDOM_CONSTANT) || defined(RENDERER_VOL_RANDOM_CURVE)
#if defined(RENDERER_VOL_CONSTANT)|| defined(RENDERER_VOL_RANDOM_CONSTANT)
lifePosition=lifeVelocity*age;
#endif
#if defined(RENDERER_VOL_CURVE) || defined(RENDERER_VOL_RANDOM_CURVE)
lifePosition=vec3(evaluateParticleCurveCumulative(renderer_VOLMaxGradientX,normalizedAge)evaluateParticleCurveCumulative(renderer_VOLMaxGradientY,normalizedAge),evaluateParticleCurveCumulative(renderer_VOLMaxGradientZ,normalizedAge));
#ifdef RENDERER_VOL_RANDOM_CURVE
lifePosition=vec3(mix(evaluateParticleCurveCumulative(renderer_VOLMinGradientX,normalizedAge),lifePosition.x,a_Random1.y),mix(evaluateParticleCurveCumulative(renderer_VOLMinGradientY,normalizedAge),lifePosition.y,a_Random1.z),mix(evaluateParticleCurveCumulative(renderer_VOLMinGradientZ,normalizedAge),lifePosition.z,a_Random1.w));
#endif
lifePosition*=vec3(a_ShapePositionStartLifeTime.w);
#endif
vec3 finalPosition;if(renderer_VOLSpace==0){finalPosition=rotationByQuaternions(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);}else{finalPosition=rotationByQuaternions(a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;}
#else
vec3 finalPosition=rotationByQuaternions(a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);
#endif
if(renderer_SimulationSpace==0){finalPosition=finalPosition+renderer_WorldPosition;}else if(renderer_SimulationSpace==1){finalPosition=finalPosition+a_SimulationWorldPosition;}finalPosition+=0.5*gravityVelocity*age;return finalPosition;}`,x_=`#define GLSLIFY 1
#if defined(RENDERER_ROL_CONSTANT_MODE) || defined(RENDERER_ROL_CURVE_MODE)
#ifdef RENDERER_ROL_CURVE_MODE
uniform vec2 renderer_ROLMaxCurveZ[4];
#ifdef RENDERER_ROL_IS_RANDOM_TWO
uniform vec2 renderer_ROLMinCurveZ[4];
#endif
#else
uniform vec3 renderer_ROLMaxConst;
#ifdef RENDERER_ROL_IS_RANDOM_TWO
uniform vec3 renderer_ROLMinConst;
#endif
#endif
#endif
float computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge){
#if defined(RENDERER_ROL_CONSTANT_MODE) || defined(RENDERER_ROL_CURVE_MODE)
#ifdef RENDERER_ROL_CURVE_MODE
float lifeRotation=evaluateParticleCurveCumulative(renderer_ROLMaxCurveZ,normalizedAge);
#ifdef RENDERER_ROL_IS_RANDOM_TWO
lifeRotation=mix(evaluateParticleCurveCumulative(renderer_ROLMinCurveZ,normalizedAge),lifeRotation,a_Random0.w);
#endif
rotation+=lifeRotation*a_ShapePositionStartLifeTime.w;
#else
float lifeRotation=renderer_ROLMaxConst.z;
#ifdef RENDERER_ROL_IS_RANDOM_TWO
lifeRotation=mix(renderer_ROLMinConst.z,lifeRotation,a_Random0.w);
#endif
rotation+=lifeRotation*age;
#endif
#endif
return rotation;}
#if defined(RENDERER_MODE_MESH) && (defined(ROTATION_OVER_LIFETIME) || defined(ROTATION_OVER_LIFETIME_SEPARATE))
vec3 computeParticleRotationVec3(in vec3 rotation,in float age,in float normalizedAge){
#ifdef ROTATION_OVER_LIFETIME
#ifdef ROTATION_OVER_LIFETIME_CONSTANT
float ageRot=u_ROLAngularVelocityConst*age;rotation+=ageRot;
#endif
#ifdef ROTATION_OVER_LIFETIME_CURVE
rotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);
#endif
#ifdef ROTATION_OVER_LIFETIME_RANDOM_CONSTANTS
float ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;rotation+=ageRot;
#endif
#ifdef ROTATION_OVER_LIFETIME_RANDOM_CURVES
rotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);
#endif
#endif
#ifdef ROTATION_OVER_LIFETIME_SEPARATE
#ifdef ROTATION_OVER_LIFETIME_CONSTANT
vec3 ageRot=u_ROLAngularVelocityConstSeparate*age;rotation+=ageRot;
#endif
#ifdef ROTATION_OVER_LIFETIME_CURVE
rotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));
#endif
#ifdef ROTATION_OVER_LIFETIME_RANDOM_CONSTANTS
vec3 ageRot=mix(u_ROLAngularVelocityConstSeparate,renderer_ROLMaxConst,a_Random0.w)*age;rotation+=ageRot;
#endif
#ifdef ROTATION_OVER_LIFETIME_RANDOM_CURVES
rotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(renderer_ROLMaxCurveX,normalizedAge),a_Random0.w),mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(renderer_ROLMaxCurveY,normalizedAge),a_Random0.w),mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(renderer_ROLMaxCurveZ,normalizedAge),a_Random0.w));
#endif
#endif
return rotation;}
#endif
`,b_=`#define GLSLIFY 1
#ifdef RENDERER_SOL_CURVE_MODE
uniform vec2 renderer_SOLMaxCurveX[4];
#ifdef RENDERER_SOL_IS_SEPARATE
uniform vec2 renderer_SOLMaxCurveY[4];uniform vec2 renderer_SOLMaxCurveZ[4];
#endif
#ifdef RENDERER_SOL_IS_RANDOM_TWO
uniform vec2 renderer_SOLMinCurveX[4];
#ifdef RENDERER_SOL_IS_SEPARATE
uniform vec2 renderer_SOLMinCurveY[4];uniform vec2 renderer_SOLMinCurveZ[4];
#endif
#endif
#endif
vec2 computeParticleSizeBillboard(in vec2 size,in float normalizedAge){
#ifdef RENDERER_SOL_CURVE_MODE
float lifeSizeX=evaluateParticleCurve(renderer_SOLMaxCurveX,normalizedAge);
#ifdef RENDERER_SOL_IS_RANDOM_TWO
lifeSizeX=mix(evaluateParticleCurve(renderer_SOLMinCurveX,normalizedAge),lifeSizeX,a_Random0.z);
#endif
#ifdef RENDERER_SOL_IS_SEPARATE
float lifeSizeY=evaluateParticleCurve(renderer_SOLMaxCurveY,normalizedAge);
#ifdef RENDERER_SOL_IS_RANDOM_TWO
lifeSizeY=mix(evaluateParticleCurve(renderer_SOLMinCurveY,normalizedAge),lifeSizeY,a_Random0.z);
#endif
size*=vec2(lifeSizeX,lifeSizeY);
#else
size*=lifeSizeX;
#endif
#endif
return size;}
#ifdef RENDERER_MODE_MESH
vec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge){
#ifdef RENDERER_SOL_CURVE
size*=evaluateParticleCurve(renderer_SOLMaxCurveX,normalizedAge);
#endif
#ifdef RENDERER_SOL_RANDOM_CURVES
size*=mix(evaluateParticleCurve(renderer_SOLMaxCurveX,normalizedAge),evaluateParticleCurve(u_SOLSizeGradientMax,normalizedAge),a_Random0.z);
#endif
#ifdef RENDERER_SOL_CURVE_SEPARATE
size*=vec3(evaluateParticleCurve(renderer_SOLMinCurveX,normalizedAge),evaluateParticleCurve(renderer_SOLMinCurveY,normalizedAge),evaluateParticleCurve(renderer_SOLMinCurveZ,normalizedAge));
#endif
#ifdef RENDERER_SOL_RANDOM_CURVES_SEPARATE
size*=vec3(mix(evaluateParticleCurve(renderer_SOLMinCurveX,normalizedAge),evaluateParticleCurve(renderer_SOLMaxCurveX,normalizedAge),a_Random0.z),mix(evaluateParticleCurve(renderer_SOLMinCurveY,normalizedAge),evaluateParticleCurve(renderer_SOLMaxCurveY,normalizedAge),a_Random0.z),mix(evaluateParticleCurve(renderer_SOLMinCurveZ,normalizedAge),evaluateParticleCurve(renderer_SOLMaxCurveZ,normalizedAge),a_Random0.z));
#endif
return size;}
#endif
`,S_=`#define GLSLIFY 1
#if defined(RENDERER_COL_GRADIENT) || defined(RENDERER_COL_RANDOM_GRADIENTS)
uniform vec4 renderer_COLMaxGradientColor[4];uniform vec2 renderer_COLMaxGradientAlpha[4];
#ifdef RENDERER_COL_RANDOM_GRADIENTS
uniform vec4 renderer_COLMinGradientColor[4];uniform vec2 renderer_COLMinGradientAlpha[4];
#endif
uniform vec4 renderer_COLGradientKeysMaxTime;
#endif
#if defined(RENDERER_COL_GRADIENT) || defined(RENDERER_COL_RANDOM_GRADIENTS)
vec4 evaluateParticleGradient(in vec4 colorKeys[4],in float colorKeysMaxTime,in vec2 alphaKeys[4],in float alphaKeysMaxTime,in float normalizedAge){vec4 value;float alphaAge=min(normalizedAge,alphaKeysMaxTime);for(int i=0;i<4;i++){vec2 key=alphaKeys[i];float time=key.x;if(alphaAge<=time){if(i==0){value.a=colorKeys[0].y;}else{vec2 lastKey=alphaKeys[i-1];float lastTime=lastKey.x;float age=(alphaAge-lastTime)/(time-lastTime);value.a=mix(lastKey.y,key.y,age);}break;}}float colorAge=min(normalizedAge,colorKeysMaxTime);for(int i=0;i<4;i++){vec4 key=colorKeys[i];float time=key.x;if(colorAge<=time){if(i==0){value.rgb=colorKeys[0].yzw;}else{vec4 lastKey=colorKeys[i-1];float lastTime=lastKey.x;float age=(colorAge-lastTime)/(time-lastTime);value.rgb=mix(lastKey.yzw,key.yzw,age);}break;}}return value;}
#endif
vec4 computeParticleColor(in vec4 color,in float normalizedAge){
#if defined(RENDERER_COL_GRADIENT) || defined(RENDERER_COL_RANDOM_GRADIENTS)
vec4 gradientColor=evaluateParticleGradient(renderer_COLMaxGradientColor,renderer_COLGradientKeysMaxTime.z,renderer_COLMaxGradientAlpha,renderer_COLGradientKeysMaxTime.w,normalizedAge);
#endif
#ifdef RENDERER_COL_RANDOM_GRADIENTS
gradientColor=mix(evaluateParticleGradient(renderer_COLMinGradientColor,renderer_COLGradientKeysMaxTime.x,renderer_COLMinGradientAlpha,renderer_COLGradientKeysMaxTime.y,normalizedAge),gradientColor,a_Random0.y);
#endif
#if defined(RENDERER_COL_GRADIENT) || defined(RENDERER_COL_RANDOM_GRADIENTS)
color*=gradientColor;
#endif
return color;}`,C_=`#define GLSLIFY 1
#if defined(RENDERER_TSA_FRAME_CURVE) || defined(RENDERER_TSA_FRAME_RANDOM_CURVES)
uniform float renderer_TSACycles;uniform vec3 renderer_TSATillingParams;uniform vec2 renderer_TSAFrameMaxCurve[4];
#endif
#ifdef RENDERER_TSA_FRAME_RANDOM_CURVES
uniform vec2 renderer_TSAFrameMinCurve[4];
#endif
vec2 computeParticleUV(in vec2 uv,in float normalizedAge){
#if defined(RENDERER_TSA_FRAME_CURVE) || defined(RENDERER_TSA_FRAME_RANDOM_CURVES)
float scaledNormalizedAge=normalizedAge*renderer_TSACycles;float cycleNormalizedAge=scaledNormalizedAge-floor(scaledNormalizedAge);float normalizedFrame=evaluateParticleCurve(renderer_TSAFrameMaxCurve,cycleNormalizedAge);
#ifdef RENDERER_TSA_FRAME_RANDOM_CURVES
normalizedFrame=mix(evaluateParticleCurve(renderer_TSAFrameMinCurve,cycleNormalizedAge),normalizedFrame,a_Random1.x);
#endif
float frame=floor(normalizedFrame*renderer_TSATillingParams.z);float totalULength=frame*renderer_TSATillingParams.x;float floorTotalULength=floor(totalULength);uv.x+=totalULength-floorTotalULength;uv.y+=floorTotalULength*renderer_TSATillingParams.y;
#endif
return uv;}`,A_=`#define GLSLIFY 1
#ifdef RENDERER_MODE_SPHERE_BILLBOARD
vec2 corner=a_CornerTextureCoordinate.xy+renderer_PivotOffset.xy;vec3 sideVector=normalize(cross(camera_Forward,camera_Up));vec3 upVector=normalize(cross(sideVector,camera_Forward));corner*=computeParticleSizeBillboard(a_StartSize.xy,normalizedAge);
#if defined(RENDERER_ROL_CONSTANT_MODE) || defined(RENDERER_ROL_CURVE_MODE)
if(renderer_ThreeDStartRotation){vec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));center+=renderer_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);}else{float rot=computeParticleRotationFloat(a_StartRotation0.x,age,normalizedAge);float c=cos(rot);float s=sin(rot);mat2 rotation=mat2(c,-s,s,c);corner=rotation*corner;center+=renderer_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);}
#else
if(renderer_ThreeDStartRotation){center+=renderer_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);}else{float c=cos(a_StartRotation0.x);float s=sin(a_StartRotation0.x);mat2 rotation=mat2(c,-s,s,c);corner=rotation*corner;center+=renderer_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);}
#endif
#endif
`,E_=`#define GLSLIFY 1
#ifdef RENDERER_MODE_STRETCHED_BILLBOARD
vec2 corner=a_CornerTextureCoordinate.xy+renderer_PivotOffset.xy;vec3 velocity;
#if defined(RENDERER_VOL_CONSTANT) || defined(RENDERER_VOL_CURVE) || defined(RENDERER_VOL_RANDOM_CONSTANT) || defined(RENDERER_VOL_RANDOM_CURVE)
if(renderer_VOLSpace==0){velocity=rotationByQuaternions(renderer_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;}else{velocity=rotationByQuaternions(renderer_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;}
#else
velocity=rotationByQuaternions(renderer_SizeScale*startVelocity,worldRotation)+gravityVelocity;
#endif
vec3 cameraUpVector=normalize(velocity);vec3 direction=normalize(center-camera_Position);vec3 sideVector=normalize(cross(direction,normalize(velocity)));sideVector=renderer_SizeScale.xzy*sideVector;cameraUpVector=length(vec3(renderer_SizeScale.x,0.0,0.0))*cameraUpVector;vec2 size=computeParticleSizeBillboard(a_StartSize.xy,normalizedAge);const mat2 rotationZHalfPI=mat2(0.0,-1.0,1.0,0.0);corner=rotationZHalfPI*corner;corner.y=corner.y-abs(corner.y);float speed=length(velocity);center+=sign(renderer_SizeScale.x)*(sign(renderer_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*renderer_StretchedBillboardSpeedScale+size.y*renderer_StretchedBillboardLengthScale)*corner.y*cameraUpVector);
#endif
`,w_=`#define GLSLIFY 1
#ifdef RENDERER_MODE_VERTICAL_BILLBOARD
vec2 corner=a_CornerTextureCoordinate.xy+renderer_PivotOffset.xy;const vec3 cameraUpVector=vec3(0.0,1.0,0.0);vec3 sideVector=normalize(cross(camera_Forward,cameraUpVector));float rot=computeParticleRotationFloat(a_StartRotation0.x,age,normalizedAge);float c=cos(rot);float s=sin(rot);mat2 rotation=mat2(c,-s,s,c);corner=rotation*corner*cos(0.78539816339744830961566084581988);corner*=computeParticleSizeBillboard(a_StartSize.xy,normalizedAge);center+=renderer_SizeScale.xzy*(corner.x*sideVector+corner.y*cameraUpVector);
#endif
`,T_=`#define GLSLIFY 1
#ifdef RENDERER_MODE_HORIZONTAL_BILLBOARD
vec2 corner=a_CornerTextureCoordinate.xy+renderer_PivotOffset.xy;const vec3 cameraUpVector=vec3(0.0,0.0,1.0);const vec3 sideVector=vec3(-1.0,0.0,0.0);float rot=computeParticleRotationFloat(a_StartRotation0.x,age,normalizedAge);float c=cos(rot);float s=sin(rot);mat2 rotation=mat2(c,-s,s,c);corner=rotation*corner*cos(0.78539816339744830961566084581988);corner*=computeParticleSizeBillboard(a_StartSize.xy,normalizedAge);center+=renderer_SizeScale.xzy*(corner.x*sideVector+corner.y*cameraUpVector);
#endif
`,R_=`#define GLSLIFY 1
#ifdef RENDERER_MODE_MESH
vec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);
#if defined(RENDERER_ROL_CONSTANT_MODE) || defined(RENDERER_ROL_CURVE_MODE)
if(renderer_ThreeDStartRotation){vec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));center+=rotationByQuaternions(renderer_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);}else{
#ifdef RENDERER_ROL_IS_SEPARATE
float angle=computeParticleRotationFloat(a_StartRotation0.x,age,normalizedAge);if(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){center+=(rotationByQuaternions(rotationByAxis(renderer_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));}else{
#ifdef SHAPE
center+=renderer_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));
#else
if(renderer_SimulationSpace==1)center+=rotationByAxis(renderer_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle);else if(renderer_SimulationSpace==0)center+=rotationByQuaternions(renderer_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation);
#endif
}
#endif
#ifdef ROTATION_OVER_LIFETIME_SEPARATE
vec3 angle=computeParticleRotationVec3(vec3(0.0,0.0,-a_StartRotation0.x),age,normalizedAge);center+=(rotationByQuaternions(rotationByEuler(renderer_SizeScale*a_MeshPosition*size,vec3(angle.x,angle.y,angle.z)),worldRotation));
#endif
}
#else
if(renderer_ThreeDStartRotation){center+=rotationByQuaternions(renderer_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);}else{if(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){if(renderer_SimulationSpace==1)center+=rotationByAxis(renderer_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);else if(renderer_SimulationSpace==0)center+=(rotationByQuaternions(renderer_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));}else{
#ifdef SHAPE
if(renderer_SimulationSpace==1)center+=renderer_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);else if(renderer_SimulationSpace==0)center+=rotationByQuaternions(renderer_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);
#else
if(renderer_SimulationSpace==1)center+=rotationByAxis(renderer_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);else if(renderer_SimulationSpace==0)center+=rotationByQuaternions(renderer_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);
#endif
}}
#endif
v_MeshColor=a_MeshColor;
#endif
`,M_={particle_common:m_,velocity_over_lifetime_module:y_,rotation_over_lifetime_module:x_,size_over_lifetime_module:b_,color_over_lifetime_module:S_,texture_sheet_animation_module:C_,sphere_billboard:A_,stretched_billboard:E_,vertical_billboard:w_,horizontal_billboard:T_,particle_mesh:R_},P_=`#define GLSLIFY 1
vec3 getNormal(bool isFrontFacing){
#ifdef RENDERER_HAS_NORMAL
vec3 normal=normalize(v_normal);
#elif defined(HAS_DERIVATIVES)
vec3 pos_dx=dFdx(v_pos);vec3 pos_dy=dFdy(v_pos);vec3 normal=normalize(cross(pos_dx,pos_dy));normal*=camera_ProjectionParams.x;
#else
vec3 normal=vec3(0,0,1);
#endif
normal*=float(isFrontFacing)*2.0-1.0;return normal;}vec3 getNormalByNormalTexture(mat3 tbn,sampler2D normalTexture,float normalIntensity,vec2 uv,bool isFrontFacing){vec3 normal=texture2D(normalTexture,uv).rgb;normal=normalize(tbn*((2.0*normal-1.0)*vec3(normalIntensity,normalIntensity,1.0)));normal*=float(isFrontFacing)*2.0-1.0;return normal;}mat3 getTBN(bool isFrontFacing){
#if defined(RENDERER_HAS_NORMAL) && defined(RENDERER_HAS_TANGENT) && ( defined(MATERIAL_HAS_NORMALTEXTURE) || defined(MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE) || defined(MATERIAL_ENABLE_ANISOTROPY) )
mat3 tbn=v_TBN;
#else
vec3 normal=getNormal(isFrontFacing);vec3 position=v_pos;vec2 uv=isFrontFacing? v_uv:-v_uv;
#ifdef HAS_DERIVATIVES
vec3 dp1=dFdx(position);vec3 dp2=dFdy(position);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;float denom=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=(denom==0.0)? 0.0 : camera_ProjectionParams.x/sqrt(denom);mat3 tbn=mat3(tangent*invmax,bitangent*invmax,normal);
#else
mat3 tbn=mat3(vec3(0.0),vec3(0.0),normal);
#endif
#endif
return tbn;}`,Ca=io({common:gl,common_vert:ml,transform_declare:yl,camera_declare:pl,color_share:xl,normal_share:Cl,uv_share:Al,worldpos_share:El,FogVertexDeclaration:Sl,FogFragmentDeclaration:bl,begin_normal_vert:wl,begin_position_vert:Tl,position_vert:Ll,color_vert:Pl,normal_vert:Dl,skinning_vert:Vl,blendShape_input:Rl,blendShape_vert:Ml,uv_vert:Fl,worldpos_vert:Nl,FogVertex:Bl,light_frag_define:Ol,mobile_material_frag:zl,FogFragment:Il,begin_mobile_frag:Ul,begin_viewdir_frag:kl,mobile_blinnphong_frag:Gl,noise_common:Yl,noise_cellular_2D:Wl,noise_cellular_2x2:Xl,noise_cellular_2x2x2:jl,noise_cellular_3D:ql,noise_cellular:Hl,noise_perlin_2D:Kl,noise_perlin_3D:Jl,noise_perlin_4D:Zl,noise_perlin:Ql,noise_psrd_2D:$l,noise_simplex_2D:t_,noise_simplex_3D_grad:n_,noise_simplex_3D:r_,noise_simplex_4D:a_,noise_simplex:e_},g_,u_,{normal_get:P_},M_),tn=function(){function n(){}return n.parseCustomMacros=function(i){return i.map(function(t){return"#define "+t+`
`}).join("")},n.registerInclude=function(i,t){if(Ca[i])throw'The "'+i+'" shader include already exist';Ca[i]=t},n.unRegisterInclude=function(i){delete Ca[i]},n.parseIncludes=function(i,t){t===void 0&&(t=/^[ \t]*#include +<([\w\d.]+)>/gm);var e=function(a,o){var c=Ca[o];return c===void 0?(ve.error('Shader slice "'+a.trim()+'" not founded.'),""):n.parseIncludes(c,t)};return i.replace(t,e)},n.convertTo300=function(i,t){if(i=i.replace(/\bvarying\b/g,t?"in":"out"),i=i.replace(/\btexture(2D|Cube)\b/g,"texture"),i=i.replace(/\btexture2DProj\b/g,"textureProj"),t){if(i=i.replace(/\btexture(2D|Cube)LodEXT\b/g,"textureLod"),i=i.replace(/\btexture(2D|Cube)GradEXT\b/g,"textureGrad"),i=i.replace(/\btexture2DProjLodEXT\b/g,"textureProjLod"),i=i.replace(/\btexture2DProjGradEXT\b/g,"textureProjGrad"),i=i.replace(/\bgl_FragDepthEXT\b/g,"gl_FragDepth"),!n._has300Output(i)){var e=/\bgl_FragData\[.+?\]/g.test(i);if(e){i=i.replace(/\bgl_FragColor\b/g,"gl_FragData[0]");var r=i.match(/\bgl_FragData\[.+?\]/g);i=this._replaceMRTShader(i,r)}else i=i.replace(/void\s+?main\s*\(/g,`out vec4 glFragColor;
void main(`),i=i.replace(/\bgl_FragColor\b/g,"glFragColor")}}else i=i.replace(/\battribute\b/g,"in");return i},n._has300Output=function(i){return n._has300OutInFragReg.test(i)},n._replaceMRTShader=function(i,t){for(var e="",r=new Set,a=0;a<t.length;a++){var o=t[a].match(/\bgl_FragData\[(.+?)\]/);r.add(o[1])}return r.forEach(function(c){e+="layout(location="+c+") out vec4 fragOutColor"+c+`;
`}),e+="void main(",i=i.replace(/\bgl_FragData\[(.+?)\]/g,"fragOutColor$1"),i=i.replace(/void\s+?main\s*\(/g,e),i},n}();(function(){tn._shaderExtension=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives","GL_EXT_draw_buffers","GL_EXT_frag_depth"].map(function(n){return"#extension "+n+` : enable
`}).join("")})();(function(){tn._has300OutInFragReg=/\bout\s+(?:\w+\s+)?(?:vec4)\s+(?:\w+)\s*;/})();var sn=function(){function n(s){this.name=s,this._uniqueId=n._nameCounter++}return n.getByName=function(i){var t,e,r=n._nameMap;return(t=r)[e=i]||(t[e]=new n(i))},n}();(function(){sn._nameCounter=0})();(function(){sn._nameMap=Object.create(null)})();var Sc=function(){function n(){this._tagsMap=Object.create(null)}var s=n.prototype;return s.setTag=function(t,e){var r=typeof t=="string"?sn.getByName(t):t,a=this._tagsMap;a[r._uniqueId]!==void 0&&ve.warn('The value of tag named "'+r.name+'" is being replaced.'),a[r._uniqueId]=e},s.deleteTag=function(t){delete this._tagsMap[(typeof t=="string"?sn.getByName(t):t)._uniqueId]},s.getTagValue=function(t){return this._tagsMap[typeof t=="string"?sn.getByName(t)._uniqueId:t._uniqueId]},j(n,[{key:"name",get:function(){return this._name}}]),n}(),or;(function(n){n[n.Linear=0]="Linear",n[n.Gamma=1]="Gamma"})(or||(or={}));var B_=function(){function n(i){this.textureUseCompareMode=!1;var t=i._hardwareRenderer;this._rhi=t,this._gl=t.gl,this._colorSpace=i.settings.colorSpace}var s=n.prototype;return s.upload1f=function(t,e){this.cacheValue!==e&&(this._gl.uniform1f(t.location,e),this.cacheValue=e)},s.upload1fv=function(t,e){this._gl.uniform1fv(t.location,e)},s.upload2f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g)&&(this._colorSpace===or.Linear?this._gl.uniform2f(t.location,q.gammaToLinearSpace(e.r),q.gammaToLinearSpace(e.g)):this._gl.uniform2f(t.location,e.r,e.g),r.x=e.r,r.y=e.g):(r.x!==e.x||r.y!==e.y)&&(this._gl.uniform2f(t.location,e.x,e.y),r.x=e.x,r.y=e.y)},s.upload2fv=function(t,e){this._gl.uniform2fv(t.location,e)},s.upload3f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b)&&(this._colorSpace===or.Linear?this._gl.uniform3f(t.location,q.gammaToLinearSpace(e.r),q.gammaToLinearSpace(e.g),q.gammaToLinearSpace(e.b)):this._gl.uniform3f(t.location,e.r,e.g,e.b),r.x=e.r,r.y=e.g,r.z=e.b):(r.x!==e.x||r.y!==e.y||r.z!==e.z)&&(this._gl.uniform3f(t.location,e.x,e.y,e.z),r.x=e.x,r.y=e.y,r.z=e.z)},s.upload3fv=function(t,e){this._gl.uniform3fv(t.location,e)},s.upload4f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b||r.w!==e.a)&&(this._colorSpace===or.Linear?this._gl.uniform4f(t.location,q.gammaToLinearSpace(e.r),q.gammaToLinearSpace(e.g),q.gammaToLinearSpace(e.b),e.a):this._gl.uniform4f(t.location,e.r,e.g,e.b,e.a),r.x=e.r,r.y=e.g,r.z=e.b,r.w=e.a):(r.x!==e.x||r.y!==e.y||r.z!==e.z||r.w!==e.w)&&(this._gl.uniform4f(t.location,e.x,e.y,e.z,e.w),r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w)},s.upload4fv=function(t,e){this._gl.uniform4fv(t.location,e)},s.upload1i=function(t,e){this.cacheValue!==e&&(this._gl.uniform1i(t.location,e),this.cacheValue=e)},s.upload1iv=function(t,e){this._gl.uniform1iv(t.location,e)},s.upload2i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g)&&(this._gl.uniform2i(t.location,e.r,e.g),r.x=e.r,r.y=e.g):(r.x!==e.x||r.y!==e.y)&&(this._gl.uniform2i(t.location,e.x,e.y),r.x=e.x,r.y=e.y)},s.upload2iv=function(t,e){this._gl.uniform2iv(t.location,e)},s.upload3i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b)&&(this._gl.uniform3i(t.location,e.r,e.g,e.b),r.x=e.r,r.y=e.g,r.z=e.b):(r.x!==e.x||r.y!==e.y||r.z!==e.z)&&(this._gl.uniform3i(t.location,e.x,e.y,e.z),r.x=e.x,r.y=e.y,r.z=e.z)},s.upload3iv=function(t,e){this._gl.uniform3iv(t.location,e)},s.upload4i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b||r.w!==e.a)&&(this._gl.uniform4i(t.location,e.r,e.g,e.b,e.a),r.x=e.r,r.y=e.g,r.z=e.b,r.w=e.a):(r.x!==e.x||r.y!==e.y||r.z!==e.z||r.w!==e.w)&&(this._gl.uniform4i(t.location,e.x,e.y,e.z,e.w),r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w)},s.upload4iv=function(t,e){this._gl.uniform4iv(t.location,e)},s.uploadMat4=function(t,e){this._gl.uniformMatrix4fv(t.location,!1,e.elements)},s.uploadMat4v=function(t,e){this._gl.uniformMatrix4fv(t.location,!1,e)},s.uploadTexture=function(t,e){var r=this._rhi;r.activeTexture(t.textureIndex),r.bindTexture(e._platformTexture),e._setUseDepthCompareMode(t.textureUseCompareMode)},s.uploadTextureArray=function(t,e){for(var r=this._rhi,a=t.textureIndex,o=0;o<e.length;o++){var c=e[o];r.activeTexture(a[o]),r.bindTexture(c._platformTexture),c._setUseDepthCompareMode(t.textureUseCompareMode)}},n}(),ya=function(){this.constUniforms=[],this.textureUniforms=[]},xr;(function(n){n[n.Scene=0]="Scene",n[n.Camera=1]="Camera",n[n.Renderer=2]="Renderer",n[n.Material=3]="Material"})(xr||(xr={}));var Cc=function(){function n(i,t,e){this.sceneUniformBlock=new ya,this.cameraUniformBlock=new ya,this.rendererUniformBlock=new ya,this.materialUniformBlock=new ya,this.otherUniformBlock=new ya,this._uploadRenderCount=-1,this._uploadSceneId=-1,this._uploadCameraId=-1,this._uploadRendererId=-1,this._uploadMaterialId=-1,this.attributeLocation=Object.create(null),this._activeTextureUint=0,this._engine=i,this._gl=i._hardwareRenderer.gl,this._glProgram=this._createProgram(t,e),this._glProgram?(this._isValid=!0,this._recordLocation()):this._isValid=!1,this.id=n._counter++}var s=n.prototype;return s.uploadAll=function(t,e){this.uploadUniforms(t,e),this.uploadTextures(t,e)},s.uploadUniforms=function(t,e){for(var r=e._propertyValueMap,a=t.constUniforms,o=0,c=a.length;o<c;o++){var l=a[o],_=r[l.propertyId];_!=null&&l.applyFunc(l,_)}},s.uploadTextures=function(t,e){var r=e._propertyValueMap,a=t.textureUniforms;if(a)for(var o=0,c=a.length;o<c;o++){var l=a[o],_=r[l.propertyId];_&&!_.destroyed?l.applyFunc(l,_):l.applyFunc(l,l.textureDefault)}},s.uploadUnGroupTextures=function(){var t=this.otherUniformBlock.textureUniforms;if(t)for(var e=0,r=t.length;e<r;e++){var a=t[e];a.applyFunc(a,a.textureDefault)}},s.groupingOtherUniformBlock=function(){var t=this.otherUniformBlock,e=t.constUniforms,r=t.textureUniforms;e.length>0&&this._groupingSubOtherUniforms(e,!1),r.length>0&&this._groupingSubOtherUniforms(r,!0)},s.bind=function(){var t=this._engine._hardwareRenderer;return t._currentBindShaderProgram!==this?(this._gl.useProgram(this._glProgram),t._currentBindShaderProgram=this,!0):!1},s.destroy=function(){var t=this._gl;this._glProgram&&t.deleteProgram(this._glProgram)},s._groupingSubOtherUniforms=function(t,e){for(var r=t.length-1;r>=0;r--){var a=t[r],o=O._getShaderPropertyGroup(a.name);o!==void 0&&(t.splice(t.indexOf(a),1),this._groupingUniform(a,o,e))}},s._groupingUniform=function(t,e,r){switch(e){case xr.Scene:r?this.sceneUniformBlock.textureUniforms.push(t):this.sceneUniformBlock.constUniforms.push(t);break;case xr.Camera:r?this.cameraUniformBlock.textureUniforms.push(t):this.cameraUniformBlock.constUniforms.push(t);break;case xr.Renderer:r?this.rendererUniformBlock.textureUniforms.push(t):this.rendererUniformBlock.constUniforms.push(t);break;case xr.Material:r?this.materialUniformBlock.textureUniforms.push(t):this.materialUniformBlock.constUniforms.push(t);break;default:r?this.otherUniformBlock.textureUniforms.push(t):this.otherUniformBlock.constUniforms.push(t)}},s._createProgram=function(t,e){var r=this._gl,a=this._createShader(r.VERTEX_SHADER,t);if(!a)return null;var o=this._createShader(r.FRAGMENT_SHADER,e);if(!o)return null;var c=r.createProgram();return c?(r.attachShader(c,a),r.attachShader(c,o),r.linkProgram(c),r.validateProgram(c),r.deleteShader(a),r.deleteShader(o),ve.isEnabled&&!r.getProgramParameter(c,r.LINK_STATUS)&&!r.isContextLost()?(ve.error(`Could not link WebGL program

`+("Shader error: "+r.getError()+`

`)+("Validate status: "+r.getProgramParameter(c,r.VALIDATE_STATUS)+`

`)+("Program information log: "+r.getProgramInfoLog(c))),r.deleteProgram(c),null):c):(console.warn("Context lost while create program."),null)},s._createShader=function(t,e){var r=this._gl,a=r.createShader(t);return a?(r.shaderSource(a,e),r.compileShader(a),ve.isEnabled&&!r.getShaderParameter(a,r.COMPILE_STATUS)&&!r.isContextLost()?(console.warn(`Could not compile WebGL shader

`+("Shader type: "+(t==r.VERTEX_SHADER?"vertex":"fragment")+`

`)+(`Shader information log:
`+r.getShaderInfoLog(a)+`
`)+(`Shader source:
`+n._addLineNum(e))),r.deleteShader(a),null):a):(console.warn("Context lost while create shader."),null)},s._recordLocation=function(){var t=this,e=this._gl,r=this._glProgram,a=this._getUniformInfos(),o=this._getAttributeInfos();a.forEach(function(c){var l=c.name,_=c.size,u=c.type,h=new B_(t._engine),d=!1,f=!1;l.indexOf("[0]")>0&&(l=l.substr(0,l.length-3),d=!0);var v=e.getUniformLocation(r,l);switch(h.name=l,h.propertyId=O.getByName(l)._uniqueId,h.location=v,u){case e.FLOAT:d?h.applyFunc=h.upload1fv:(h.applyFunc=h.upload1f,h.cacheValue=0);break;case e.FLOAT_VEC2:d?h.applyFunc=h.upload2fv:(h.applyFunc=h.upload2f,h.cacheValue=new ee(0,0));break;case e.FLOAT_VEC3:d?h.applyFunc=h.upload3fv:(h.applyFunc=h.upload3f,h.cacheValue=new R(0,0,0));break;case e.FLOAT_VEC4:d?h.applyFunc=h.upload4fv:(h.applyFunc=h.upload4f,h.cacheValue=new ie(0,0,0,0));break;case e.BOOL:case e.INT:d?h.applyFunc=h.upload1iv:(h.applyFunc=h.upload1i,h.cacheValue=0);break;case e.BOOL_VEC2:case e.INT_VEC2:d?h.applyFunc=h.upload2iv:(h.applyFunc=h.upload2i,h.cacheValue=new ee(0,0));break;case e.BOOL_VEC3:case e.INT_VEC3:d?h.applyFunc=h.upload3iv:(h.applyFunc=h.upload3i,h.cacheValue=new R(0,0,0));break;case e.BOOL_VEC4:case e.INT_VEC4:d?h.applyFunc=h.upload4iv:(h.applyFunc=h.upload4i,h.cacheValue=new ie(0,0,0));break;case e.FLOAT_MAT4:h.applyFunc=d?h.uploadMat4v:h.uploadMat4;break;case e.SAMPLER_2D:case e.SAMPLER_CUBE:case e.UNSIGNED_INT_SAMPLER_2D:case e.SAMPLER_2D_ARRAY:case e.SAMPLER_2D_SHADOW:var p;switch(u){case e.SAMPLER_2D:p=t._engine._magentaTexture2D;break;case e.SAMPLER_CUBE:p=t._engine._magentaTextureCube;break;case e.UNSIGNED_INT_SAMPLER_2D:p=t._engine._uintMagentaTexture2D;break;case e.SAMPLER_2D_ARRAY:p=t._engine._magentaTexture2DArray;break;case e.SAMPLER_2D_SHADOW:p=t._engine._depthTexture2D,h.textureUseCompareMode=!0;break}if(f=!0,d){for(var g=new Array(_),y=new Int32Array(_),m=new Array(_),x=0;x<_;x++)g[x]=p,y[x]=t._activeTextureUint,m[x]=e.TEXTURE0+t._activeTextureUint++;h.textureDefault=g,h.textureIndex=m,h.applyFunc=h.uploadTextureArray,t.bind(),e.uniform1iv(v,y)}else{var C=e.TEXTURE0+t._activeTextureUint;h.textureDefault=p,h.textureIndex=C,h.applyFunc=h.uploadTexture,t.bind(),e.uniform1i(v,t._activeTextureUint++)}break;default:throw new Error("Unsupported uniform type")}var b=O._getShaderPropertyGroup(l);t._groupingUniform(h,b,f)}),o.forEach(function(c){var l=c.name;t.attributeLocation[l]=e.getAttribLocation(r,l)})},s._getUniformInfos=function(){for(var t=this._gl,e=this._glProgram,r=t.getProgramParameter(e,t.ACTIVE_UNIFORMS),a=new Array(r),o=0;o<r;++o){var c=t.getActiveUniform(e,o);a[o]=c}return a},s._getAttributeInfos=function(){for(var t=this._gl,e=this._glProgram,r=new Array,a=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),o=0;o<a;++o){var c=t.getActiveAttrib(e,o);r[o]=c}return r},n._addLineNum=function(t){var e=t.split(`
`),r=(e.length+1).toString().length+6,a;return e.map(function(o,c){if(a="0:"+(c+1),a.length>=r)return a.substring(0,r)+o;for(var l=0;l<r-a.length;l++)a+=" ";return a+o}).join(`
`)},j(n,[{key:"isValid",get:function(){return this._isValid}}]),n}();(function(){Cc._counter=0})();var vt=function(n){W(s,n);function s(t,e,r,a){var o;o=n.call(this)||this,o._shaderPassId=0,o._renderStateDataMap={},o._shaderProgramPools=[],o._shaderPassId=s._shaderPassCounter++,typeof r=="string"?(o._name=t,o._vertexSource=e,o._fragmentSource=r,a=a??{pipelineStage:Ot.Forward}):(o._name="Default",o._vertexSource=t,o._fragmentSource=e,a=r??{pipelineStage:Ot.Forward});for(var c in a)o.setTag(c,a[c]);return o}var i=s.prototype;return i._getShaderProgram=function(e,r){var a=e._getShaderProgramPool(this),o=a.get(r);if(o)return o;var c=e._hardwareRenderer.isWebGL2,l=[];oe._getNamesByMacros(r,l);var _=tn.parseCustomMacros(l),u=c?"#version 300 es":"#version 100",h=c?"#define GRAPHICS_API_WEBGL2":"#define GRAPHICS_API_WEBGL1",d=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
      precision highp float;
      precision highp int;
    #else
      precision mediump float;
      precision mediump int;
    #endif
    `;e._hardwareRenderer.canIUse(K.shaderTextureLod)&&(d+=`#define HAS_TEX_LOD
`),e._hardwareRenderer.canIUse(K.standardDerivatives)&&(d+=`#define HAS_DERIVATIVES
`);var f=" "+u+`
        `+h+`
        `+_+`
      `+tn.parseIncludes(this._vertexSource),v=" "+u+`
        `+h+`
        `+(c?"":tn._shaderExtension)+`
        `+d+`
        `+_+`
      `+tn.parseIncludes(this._fragmentSource);return c&&(f=tn.convertTo300(f),v=tn.convertTo300(v,!0)),o=new Cc(e,f,v),a.cache(o),o},i._destroy=function(){for(var e=this._shaderProgramPools,r=0,a=e.length;r<a;r++)e[r]._destroy();e.length=0},s}(Sc);(function(){vt._shaderPassCounter=0})();var hi=function(n){W(s,n);function s(i,t,e){var r;r=n.call(this)||this,r._name=i;var a=t.length;if(a<1)throw" count must large than 0.";r._passes=t.slice();for(var o in e)r.setTag(o,e[o]);return r}return j(s,[{key:"passes",get:function(){return this._passes}}]),s}(Sc),Ac=function(){this.enabled=!1,this.colorBlendOperation=It.Add,this.alphaBlendOperation=It.Add,this.sourceColorBlendFactor=be.One,this.sourceAlphaBlendFactor=be.One,this.destinationColorBlendFactor=be.Zero,this.destinationAlphaBlendFactor=be.Zero,this.colorWriteMask=yr.All},Ui=function(){function n(){this.targetBlendState=new Ac,this.blendColor=new q(0,0,0,0),this.alphaToCoverage=!1}var s=n.prototype;return s._applyShaderDataValue=function(t,e){var r=this.targetBlendState,a=t[re.BlendStateEnabled0];if(a!==void 0){var o=e.getFloat(a);r.enabled=o!==void 0?!!o:!1}var c=t[re.BlendStateColorBlendOperation0];if(c!==void 0){var l;r.colorBlendOperation=(l=e.getFloat(c))!=null?l:It.Add}var _=t[re.BlendStateAlphaBlendOperation0];if(_!==void 0){var u;r.alphaBlendOperation=(u=e.getFloat(_))!=null?u:It.Add}var h=t[re.BlendStateSourceColorBlendFactor0];if(h!==void 0){var d;r.sourceColorBlendFactor=(d=e.getFloat(h))!=null?d:be.One}var f=t[re.BlendStateSourceAlphaBlendFactor0];if(f!==void 0){var v;r.sourceAlphaBlendFactor=(v=e.getFloat(f))!=null?v:be.One}var p=t[re.BlendStateDestinationColorBlendFactor0];if(p!==void 0){var g;r.destinationColorBlendFactor=(g=e.getFloat(p))!=null?g:be.Zero}var y=t[re.BlendStateDestinationAlphaBlendFactor0];if(y!==void 0){var m;r.destinationAlphaBlendFactor=(m=e.getFloat(y))!=null?m:be.Zero}var x=t[re.BlendStateColorWriteMask0];if(x!==void 0){var C;r.colorWriteMask=(C=e.getFloat(x))!=null?C:yr.All}var b=t[re.BlendStateBlendColor];if(b!==void 0){var A=e.getColor(b);A!==void 0&&this.blendColor.copyFrom(A)}var S=t[re.BlendStateAlphaToCoverage];if(S!==void 0){var w=e.getFloat(S);this.alphaToCoverage=w!==void 0?!!w:!1}},s._apply=function(t,e){this._platformApply(t,e.blendState)},s._platformApply=function(t,e){var r=t.gl,a=e.targetBlendState,o=this.targetBlendState,c=o.enabled,l=o.colorBlendOperation,_=o.alphaBlendOperation,u=o.sourceColorBlendFactor,h=o.destinationColorBlendFactor,d=o.sourceAlphaBlendFactor,f=o.destinationAlphaBlendFactor,v=o.colorWriteMask;if(c!==a.enabled&&(c?r.enable(r.BLEND):r.disable(r.BLEND),a.enabled=c),c){(u!==a.sourceColorBlendFactor||h!==a.destinationColorBlendFactor||d!==a.sourceAlphaBlendFactor||f!==a.destinationAlphaBlendFactor)&&(r.blendFuncSeparate(n._getGLBlendFactor(t,u),n._getGLBlendFactor(t,h),n._getGLBlendFactor(t,d),n._getGLBlendFactor(t,f)),a.sourceColorBlendFactor=u,a.destinationColorBlendFactor=h,a.sourceAlphaBlendFactor=d,a.destinationAlphaBlendFactor=f),(l!==a.colorBlendOperation||_!==a.alphaBlendOperation)&&(r.blendEquationSeparate(n._getGLBlendOperation(t,l),n._getGLBlendOperation(t,_)),a.colorBlendOperation=l,a.alphaBlendOperation=_);var p=this.blendColor;q.equals(e.blendColor,p)||(r.blendColor(p.r,p.g,p.b,p.a),e.blendColor.copyFrom(p))}v!==a.colorWriteMask&&(r.colorMask((v&yr.Red)!==0,(v&yr.Green)!==0,(v&yr.Blue)!==0,(v&yr.Alpha)!==0),a.colorWriteMask=v);var g=this.alphaToCoverage;g!==e.alphaToCoverage&&(g?r.enable(r.SAMPLE_ALPHA_TO_COVERAGE):r.disable(r.SAMPLE_ALPHA_TO_COVERAGE),e.alphaToCoverage=g)},n._getGLBlendFactor=function(t,e){var r=t.gl;switch(e){case be.Zero:return r.ZERO;case be.One:return r.ONE;case be.SourceColor:return r.SRC_COLOR;case be.OneMinusSourceColor:return r.ONE_MINUS_SRC_COLOR;case be.DestinationColor:return r.DST_COLOR;case be.OneMinusDestinationColor:return r.ONE_MINUS_DST_COLOR;case be.SourceAlpha:return r.SRC_ALPHA;case be.OneMinusSourceAlpha:return r.ONE_MINUS_SRC_ALPHA;case be.DestinationAlpha:return r.DST_ALPHA;case be.OneMinusDestinationAlpha:return r.ONE_MINUS_DST_ALPHA;case be.SourceAlphaSaturate:return r.SRC_ALPHA_SATURATE;case be.BlendColor:return r.CONSTANT_COLOR;case be.OneMinusBlendColor:return r.ONE_MINUS_CONSTANT_COLOR}},n._getGLBlendOperation=function(t,e){var r=t.gl;switch(e){case It.Add:return r.FUNC_ADD;case It.Subtract:return r.FUNC_SUBTRACT;case It.ReverseSubtract:return r.FUNC_REVERSE_SUBTRACT;case It.Min:if(!t.canIUse(K.blendMinMax))throw new Error("BlendOperation.Min is not supported in this context");return r.MIN;case It.Max:if(!t.canIUse(K.blendMinMax))throw new Error("BlendOperation.Max is not supported in this context");return r.MAX}},n}();T([J],Ui.prototype,"targetBlendState",void 0);T([J],Ui.prototype,"blendColor",void 0);var Ec=function(){function n(){this.enabled=!0,this.compareFunction=Ee.Less,this.writeEnabled=!0}var s=n.prototype;return s._applyShaderDataValue=function(t,e){var r=t[re.DepthStateEnabled];if(r!==void 0){var a=e.getFloat(r);this.enabled=a!==void 0?!!a:!1}var o=t[re.DepthStateWriteEnabled];if(o!==void 0){var c=e.getFloat(o);this.writeEnabled=c!==void 0?!!c:!1}var l=t[re.DepthStateCompareFunction];if(l!==void 0){var _;this.compareFunction=(_=e.getFloat(l))!=null?_:Ee.Less}},s._apply=function(t,e){this._platformApply(t,e.depthState)},s._platformApply=function(t,e){var r=t.gl,a=this,o=a.enabled,c=a.compareFunction,l=a.writeEnabled;o!=e.enabled&&(o?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),e.enabled=o),o&&c!=e.compareFunction&&(r.depthFunc(n._getGLCompareFunction(t,c)),e.compareFunction=c),l!=e.writeEnabled&&(r.depthMask(l),e.writeEnabled=l)},n._getGLCompareFunction=function(t,e){var r=t.gl;switch(e){case Ee.Never:return r.NEVER;case Ee.Less:return r.LESS;case Ee.Equal:return r.EQUAL;case Ee.LessEqual:return r.LEQUAL;case Ee.Greater:return r.GREATER;case Ee.NotEqual:return r.NOTEQUAL;case Ee.GreaterEqual:return r.GEQUAL;case Ee.Always:return r.ALWAYS}},n}(),wc=function(){function n(){this.cullMode=qt.Back,this.depthBias=0,this.slopeScaledDepthBias=0,this._cullFaceEnable=!0,this._frontFaceInvert=!1}var s=n.prototype;return s._applyShaderDataValue=function(t,e){var r=t[re.RasterStateCullMode];if(r!==void 0){var a;this.cullMode=(a=e.getFloat(r))!=null?a:qt.Back}var o=t[re.RasterStateDepthBias];if(o!==void 0){var c;this.depthBias=(c=e.getFloat(o))!=null?c:0}var l=t[re.RasterStateSlopeScaledDepthBias];if(l!==void 0){var _;this.slopeScaledDepthBias=(_=e.getFloat(l))!=null?_:0}},s._apply=function(t,e,r){this._platformApply(t,e.rasterState,r)},s._platformApply=function(t,e,r){var a=t.gl,o=this,c=o.cullMode,l=o.depthBias,_=o.slopeScaledDepthBias,u=c!==qt.Off;u!==e._cullFaceEnable&&(u?a.enable(a.CULL_FACE):a.disable(a.CULL_FACE),e._cullFaceEnable=u),u&&c!==e.cullMode&&(c==qt.Back?a.cullFace(a.BACK):a.cullFace(a.FRONT),e.cullMode=c),r!==e._frontFaceInvert&&(r?a.frontFace(a.CW):a.frontFace(a.CCW),e._frontFaceInvert=r),t._enableGlobalDepthBias||(l!==e.depthBias||_!==e.slopeScaledDepthBias)&&(l!==0||_!==0?(a.enable(a.POLYGON_OFFSET_FILL),a.polygonOffset(_,l)):a.disable(a.POLYGON_OFFSET_FILL),e.depthBias=l,e.slopeScaledDepthBias=_)},n}(),Tc=function(){function n(){this.enabled=!1,this.referenceValue=0,this.mask=255,this.writeMask=255,this.compareFunctionFront=Ee.Always,this.compareFunctionBack=Ee.Always,this.passOperationFront=ke.Keep,this.passOperationBack=ke.Keep,this.failOperationFront=ke.Keep,this.failOperationBack=ke.Keep,this.zFailOperationFront=ke.Keep,this.zFailOperationBack=ke.Keep}var s=n.prototype;return s._applyShaderDataValue=function(t,e){var r=t[re.StencilStateEnabled];if(r!==void 0){var a=e.getFloat(r);this.enabled=a!==void 0?!!a:!1}var o=t[re.StencilStateReferenceValue];if(o!==void 0){var c;this.referenceValue=(c=e.getFloat(o))!=null?c:0}var l=t[re.StencilStateMask];if(l!==void 0){var _;this.mask=(_=e.getFloat(l))!=null?_:255}var u=t[re.StencilStateWriteMask];if(u!==void 0){var h;this.writeMask=(h=e.getFloat(u))!=null?h:255}var d=t[re.StencilStateCompareFunctionFront];if(d!==void 0){var f;this.compareFunctionFront=(f=e.getFloat(d))!=null?f:Ee.Always}var v=t[re.StencilStateCompareFunctionBack];if(v!==void 0){var p;this.compareFunctionBack=(p=e.getFloat(v))!=null?p:Ee.Always}var g=t[re.StencilStatePassOperationFront];if(g!==void 0){var y;this.passOperationFront=(y=e.getFloat(g))!=null?y:ke.Keep}var m=t[re.StencilStatePassOperationBack];if(m!==void 0){var x;this.passOperationBack=(x=e.getFloat(m))!=null?x:ke.Keep}var C=t[re.StencilStateFailOperationFront];if(C!==void 0){var b;this.failOperationFront=(b=e.getFloat(C))!=null?b:ke.Keep}var A=t[re.StencilStateFailOperationBack];if(A!==void 0){var S;this.failOperationBack=(S=e.getFloat(A))!=null?S:ke.Keep}var w=t[re.StencilStateZFailOperationFront];if(w!==void 0){var E;this.zFailOperationFront=(E=e.getFloat(w))!=null?E:ke.Keep}var P=t[re.StencilStateZFailOperationBack];if(P!==void 0){var M;this.zFailOperationBack=(M=e.getFloat(P))!=null?M:ke.Keep}},s._apply=function(t,e){this._platformApply(t,e.stencilState)},s._platformApply=function(t,e){var r=t.gl,a=this,o=a.enabled,c=a.referenceValue,l=a.mask,_=a.compareFunctionFront,u=a.compareFunctionBack,h=a.failOperationFront,d=a.zFailOperationFront,f=a.passOperationFront,v=a.failOperationBack,p=a.zFailOperationBack,g=a.passOperationBack,y=a.writeMask;if(o!=e.enabled&&(o?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),e.enabled=o),o){var m=c!==e.referenceValue||l!==e.mask;(m||_!==e.compareFunctionFront)&&(r.stencilFuncSeparate(r.FRONT,n._getGLCompareFunction(t,_),c,l),e.compareFunctionFront=_),(m||u!==e.compareFunctionBack)&&(r.stencilFuncSeparate(r.BACK,n._getGLCompareFunction(t,u),c,l),e.compareFunctionBack=this.compareFunctionBack),m&&(e.referenceValue=this.referenceValue,e.mask=this.mask),(h!==e.failOperationFront||d!==e.zFailOperationFront||f!==e.passOperationFront)&&(r.stencilOpSeparate(r.FRONT,n._getGLStencilOperation(t,h),n._getGLStencilOperation(t,d),n._getGLStencilOperation(t,f)),e.failOperationFront=h,e.zFailOperationFront=d,e.passOperationFront=f),(v!==e.failOperationBack||p!==e.zFailOperationBack||g!==e.passOperationBack)&&(r.stencilOpSeparate(r.BACK,n._getGLStencilOperation(t,v),n._getGLStencilOperation(t,p),n._getGLStencilOperation(t,g)),e.failOperationBack=v,e.zFailOperationBack=p,e.passOperationBack=g),y!==e.writeMask&&(r.stencilMask(y),e.writeMask=y)}},n._getGLCompareFunction=function(t,e){var r=t.gl;switch(e){case Ee.Never:return r.NEVER;case Ee.Less:return r.LESS;case Ee.Equal:return r.EQUAL;case Ee.LessEqual:return r.LEQUAL;case Ee.Greater:return r.GREATER;case Ee.NotEqual:return r.NOTEQUAL;case Ee.GreaterEqual:return r.GEQUAL;case Ee.Always:return r.ALWAYS}},n._getGLStencilOperation=function(t,e){var r=t.gl;switch(e){case ke.Keep:return r.KEEP;case ke.Zero:return r.ZERO;case ke.Replace:return r.REPLACE;case ke.IncrementSaturate:return r.INCR;case ke.DecrementSaturate:return r.DECR;case ke.Invert:return r.INVERT;case ke.IncrementWrap:return r.INCR_WRAP;case ke.DecrementWrap:return r.DECR_WRAP}},n}(),qr=function(){function n(){this.blendState=new Ui,this.depthState=new Ec,this.stencilState=new Tc,this.rasterState=new wc,this.renderQueueType=ft.Opaque}var s=n.prototype;return s._applyShaderDataValue=function(t,e){this.blendState._applyShaderDataValue(t,e),this.depthState._applyShaderDataValue(t,e),this.stencilState._applyShaderDataValue(t,e),this.rasterState._applyShaderDataValue(t,e);var r=t[re.RenderQueueType];if(r!==void 0){var a;this.renderQueueType=(a=e.getFloat(r))!=null?a:ft.Opaque}},s._apply=function(t,e,r,a){r&&this._applyShaderDataValue(r,a);var o=t._hardwareRenderer,c=t._lastRenderState,l=t._renderContext;this.blendState._apply(o,c),this.depthState._apply(o,c),this.stencilState._apply(o,c),this.rasterState._apply(o,c,l.flipProjection?!e:e)},n}();T([J],qr.prototype,"blendState",void 0);T([J],qr.prototype,"depthState",void 0);T([J],qr.prototype,"stencilState",void 0);T([J],qr.prototype,"rasterState",void 0);var Se=function(){function n(i,t){this.name=i,this._refCount=0,this._destroyed=!1,this.name=i,this._subShaders=t}var s=n.prototype;return s.compileVariant=function(t,e){var r=n._compileMacros;r.clear();for(var a=0,o=e.length;a<o;a++)r.enable(oe.getByName(e[a]));for(var c=!1,l=this._subShaders,_=0,u=l.length;_<u;_++)for(var h=l[_].passes,d=0,f=h.length;d<f;d++){var v=h[d]._getShaderProgram(t,r);c=(d===0||c)&&v.isValid}return c},s.destroy=function(t){if(t===void 0&&(t=!1),!t&&this._refCount!==0)return!1;for(var e=this._subShaders,r=0,a=e.length;r<a;r++)for(var o=e[r].passes,c=0,l=o.length;c<l;c++)o[c]._destroy();return delete n._shaderMap[this.name],this._destroyed=!0,!0},s._getReferCount=function(){return this._refCount},s._addReferCount=function(t){this._refCount+=t},n.create=function(t,e,r){var a,o=n._shaderMap;if(e){if(o[t]){console.error('Shader named "'+t+'" already exists.');return}if(typeof e=="string"){var _=new vt(e,r);a=new n(t,[new hi("Default",[_])])}else if(e.length>0)e[0].constructor===vt?a=new n(t,[new hi("Default",e)]):a=new n(t,e.slice());else throw"SubShader or ShaderPass count must large than 0."}else{if(!n._shaderLab)throw"ShaderLab has not been set up yet.";var c=n._shaderLab.parseShader(t);if(o[c.name]){console.error('Shader named "'+c.name+'" already exists.');return}var l=c.subShaders.map(function(u){var h=u.passes.map(function(d){if(typeof d=="string"){var f,v,p=d.split("/");return(v=n.find(p[0]))==null||(f=v.subShaders.find(function(w){return w.name===p[1]}))==null?void 0:f.passes.find(function(w){return w.name===p[2]})}var g=new vt(d.name,d.vertexSource,d.fragmentSource,d.tags),y=d.renderStates,m=new qr;g._renderState=m;var x=y[0];for(var C in x)n._applyConstRenderStates(m,parseInt(C),x[C]);var b=y[1],A={};for(var S in b)A[S]=O.getByName(b[S]);return g._renderStateDataMap=A,g});return new hi(c.name,h,u.tags)});return a=new n(c.name,l),o[c.name]=a,a}return o[t]=a,a},n.find=function(t){return n._shaderMap[t]},n._applyConstRenderStates=function(t,e,r){switch(e){case re.BlendStateEnabled0:t.blendState.targetBlendState.enabled=r;break;case re.BlendStateColorBlendOperation0:t.blendState.targetBlendState.colorBlendOperation=r;break;case re.BlendStateAlphaBlendOperation0:t.blendState.targetBlendState.alphaBlendOperation=r;break;case re.BlendStateSourceColorBlendFactor0:t.blendState.targetBlendState.sourceColorBlendFactor=r;break;case re.BlendStateDestinationColorBlendFactor0:t.blendState.targetBlendState.destinationColorBlendFactor=r;break;case re.BlendStateSourceAlphaBlendFactor0:t.blendState.targetBlendState.sourceAlphaBlendFactor=r;break;case re.BlendStateDestinationAlphaBlendFactor0:t.blendState.targetBlendState.destinationAlphaBlendFactor=r;break;case re.BlendStateColorWriteMask0:t.blendState.targetBlendState.colorWriteMask=r;break;case re.DepthStateEnabled:t.depthState.enabled=r;break;case re.DepthStateWriteEnabled:t.depthState.writeEnabled=r;break;case re.DepthStateCompareFunction:t.depthState.compareFunction=r;break;case re.StencilStateEnabled:t.stencilState.enabled=r;break;case re.StencilStateReferenceValue:t.stencilState.referenceValue=r;break;case re.StencilStateMask:t.stencilState.mask=r;break;case re.StencilStateWriteMask:t.stencilState.writeMask=r;break;case re.StencilStateCompareFunctionFront:t.stencilState.compareFunctionFront=r;break;case re.StencilStateCompareFunctionBack:t.stencilState.compareFunctionBack=r;break;case re.StencilStatePassOperationFront:t.stencilState.passOperationFront=r;break;case re.StencilStatePassOperationBack:t.stencilState.passOperationBack=r;break;case re.StencilStateFailOperationFront:t.stencilState.failOperationFront=r;break;case re.StencilStateFailOperationBack:t.stencilState.failOperationBack=r;break;case re.StencilStateZFailOperationFront:t.stencilState.zFailOperationFront=r;break;case re.StencilStateZFailOperationBack:t.stencilState.zFailOperationBack=r;break;case re.RasterStateCullMode:t.rasterState.cullMode=r;break;case re.RasterStateDepthBias:t.rasterState.depthBias=r;break;case re.RasterStateSlopeScaledDepthBias:t.rasterState.slopeScaledDepthBias=r;break;case re.RenderQueueType:t.renderQueueType=r;break}},n.getMacroByName=function(t,e){return oe.getByName(t,e)},n.getPropertyByName=function(t){return O.getByName(t)},j(n,[{key:"subShaders",get:function(){return this._subShaders}},{key:"destroyed",get:function(){return this._destroyed}}]),n}();(function(){Se._compileMacros=new Kt})();(function(){Se._shaderMap=Object.create(null)})();var ki=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._isContentLost=!1,t.resourceManager._addGraphicResource(ce(e)),e}var i=s.prototype;return i._onDestroy=function(){n.prototype._onDestroy.call(this),this.engine.resourceManager._deleteGraphicResource(this)},j(s,[{key:"isContentLost",get:function(){return this._isContentLost}}]),s}(Qr),tt;(function(n){n[n.Point=0]="Point",n[n.Bilinear=1]="Bilinear",n[n.Trilinear=2]="Trilinear"})(tt||(tt={}));var G;(function(n){n[n.R8G8B8=0]="R8G8B8",n[n.R8G8B8A8=1]="R8G8B8A8",n[n.R4G4B4A4=2]="R4G4B4A4",n[n.R5G5B5A1=3]="R5G5B5A1",n[n.R5G6B5=4]="R5G6B5",n[n.Alpha8=5]="Alpha8",n[n.LuminanceAlpha=6]="LuminanceAlpha",n[n.R16G16B16A16=7]="R16G16B16A16",n[n.R32G32B32A32=8]="R32G32B32A32",n[n.R32G32B32A32_UInt=9]="R32G32B32A32_UInt",n[n.BC1=10]="BC1",n[n.BC3=11]="BC3",n[n.BC7=12]="BC7",n[n.ETC1_RGB=13]="ETC1_RGB",n[n.ETC2_RGB=14]="ETC2_RGB",n[n.ETC2_RGBA5=15]="ETC2_RGBA5",n[n.ETC2_RGBA8=16]="ETC2_RGBA8",n[n.PVRTC_RGB2=17]="PVRTC_RGB2",n[n.PVRTC_RGBA2=18]="PVRTC_RGBA2",n[n.PVRTC_RGB4=19]="PVRTC_RGB4",n[n.PVRTC_RGBA4=20]="PVRTC_RGBA4",n[n.ASTC_4x4=21]="ASTC_4x4",n[n.ASTC_5x5=22]="ASTC_5x5",n[n.ASTC_6x6=23]="ASTC_6x6",n[n.ASTC_8x8=24]="ASTC_8x8",n[n.ASTC_10x10=25]="ASTC_10x10",n[n.ASTC_12x12=26]="ASTC_12x12",n[n.Depth=27]="Depth",n[n.Stencil=28]="Stencil",n[n.DepthStencil=29]="DepthStencil",n[n.Depth16=30]="Depth16",n[n.Depth24=31]="Depth24",n[n.Depth32=32]="Depth32",n[n.Depth24Stencil8=33]="Depth24Stencil8",n[n.Depth32Stencil8=34]="Depth32Stencil8",n[n.DXT1=10]="DXT1",n[n.DXT5=11]="DXT5"})(G||(G={}));var Wr=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t._isDepthTexture=!1,t._anisoLevel=1,t._useDepthCompareMode=!1,t}var i=s.prototype;return i.generateMipmaps=function(){this._mipmap&&this._platformTexture.generateMipmaps()},i._setUseDepthCompareMode=function(e){this._useDepthCompareMode!==e&&(this._platformTexture.setUseDepthCompareMode(e),this._useDepthCompareMode=e)},i._rebuild=function(){var e=this._platformTexture;e.wrapModeU=this._wrapModeU,e.wrapModeV=this._wrapModeV,e.filterMode=this._filterMode,e.anisoLevel=this._anisoLevel,this._engine._hardwareRenderer._isWebGL2&&(e.depthCompareFunction=this._depthCompareFunction,e.setUseDepthCompareMode(this._useDepthCompareMode))},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._platformTexture.destroy(),this._platformTexture=null},i._getMaxMiplevel=function(e){return Math.floor(Math.log2(e))},i._getMipmapCount=function(){return this._mipmap?Math.floor(Math.log2(Math.max(this._width,this._height)))+1:1},i._isIntFormat=function(){return G.R32G32B32A32_UInt===this._format},j(s,[{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"usage",get:function(){return this._usage}},{key:"wrapModeU",get:function(){return this._wrapModeU},set:function(e){e!==this._wrapModeU&&(this._wrapModeU=e,this._platformTexture.wrapModeU=e)}},{key:"wrapModeV",get:function(){return this._wrapModeV},set:function(e){e!==this._wrapModeV&&(this._wrapModeV=e,this._platformTexture.wrapModeV=e)}},{key:"mipmapCount",get:function(){return this._mipmapCount}},{key:"filterMode",get:function(){return this._filterMode},set:function(e){if(e!==this._filterMode){if(e!==tt.Point&&this._isIntFormat()){e=tt.Point,ve.warn("Int or UInt format texture only support TextureFilterMode.Point");return}this._filterMode=e,this._platformTexture.filterMode=e}}},{key:"anisoLevel",get:function(){return this._anisoLevel},set:function(e){var r=this._engine._hardwareRenderer.capability.maxAnisoLevel;e>r&&(ve.warn("anisoLevel:"+e+", exceeds the limit and is automatically downgraded to:"+r),e=r),e<1&&(ve.warn("anisoLevel:"+e+", must be greater than 0, and is automatically downgraded to 1"),e=1),e!==this._anisoLevel&&(this._anisoLevel=e,this._platformTexture.anisoLevel=e)}},{key:"depthCompareFunction",get:function(){return this._depthCompareFunction},set:function(e){if(!this._engine._hardwareRenderer._isWebGL2){console.warn("depthCompareFunction only support WebGL2");return}e!==this._depthCompareFunction&&(this._depthCompareFunction=e,this._platformTexture.depthCompareFunction=e)}}]),s}(ki),Nr=function(){function n(i){this._propertyValueMap=Object.create(null),this._macroCollection=new Kt,this._macroMap=Object.create(null),this._refCount=0,this._group=i}var s=n.prototype;return s.getFloat=function(t){return this.getPropertyValue(t)},s.setFloat=function(t,e){this._setPropertyValue(t,Vt.Float,e)},s.getInt=function(t){return this.getPropertyValue(t)},s.setInt=function(t,e){this._setPropertyValue(t,Vt.Int,e)},s.getFloatArray=function(t){return this.getPropertyValue(t)},s.setFloatArray=function(t,e){this._setPropertyValue(t,Vt.FloatArray,e)},s.getIntArray=function(t){return this.getPropertyValue(t)},s.setIntArray=function(t,e){this._setPropertyValue(t,Vt.IntArray,e)},s.getVector2=function(t){return this.getPropertyValue(t)},s.setVector2=function(t,e){this._setPropertyValue(t,Vt.Vector2,e)},s.getVector3=function(t){return this.getPropertyValue(t)},s.setVector3=function(t,e){this._setPropertyValue(t,Vt.Vector3,e)},s.getVector4=function(t){return this.getPropertyValue(t)},s.setVector4=function(t,e){this._setPropertyValue(t,Vt.Vector4,e)},s.getMatrix=function(t){return this.getPropertyValue(t)},s.setMatrix=function(t,e){this._setPropertyValue(t,Vt.Matrix,e)},s.getColor=function(t){return this.getPropertyValue(t)},s.setColor=function(t,e){this._setPropertyValue(t,Vt.Color,e)},s.getTexture=function(t){return this.getPropertyValue(t)},s.setTexture=function(t,e){var r=this._refCount;if(r>0){var a=this.getPropertyValue(t);a&&a._addReferCount(-r),e&&e._addReferCount(r)}this._setPropertyValue(t,Vt.Texture,e)},s.getTextureArray=function(t){return this.getPropertyValue(t)},s.setTextureArray=function(t,e){var r=this._refCount;if(r>0){var a=this.getPropertyValue(t);if(a)for(var o=0,c=a.length;o<c;o++)a[o]._addReferCount(-r);if(e)for(var l=0,_=e.length;l<_;l++)e[l]._addReferCount(r)}this._setPropertyValue(t,Vt.TextureArray,e)},s.getPropertyValue=function(t){return typeof t=="string"&&(t=O.getByName(t)),this._propertyValueMap[t._uniqueId]},s.enableMacro=function(t,e){typeof t=="string"&&(t=oe.getByName(t,e));var r=t._nameId,a=this._macroMap[r];if(a!==t){var o=this._macroCollection;a&&o.disable(a),o.enable(t),this._macroMap[r]=t}},s.disableMacro=function(t){var e;if(typeof t=="string"){if(e=oe._macroNameIdMap[t],e===void 0)return}else e=t._nameId;var r=this._macroMap[e];r&&(this._macroCollection.disable(r),delete this._macroMap[e])},s.getMacros=function(t){if(t){var e=this._macroMap;t.length=0;for(var r in e)t.push(e[r])}else return Object.values(this._macroMap)},s.getProperties=function(t){var e;t?(t.length=0,e=t):e=[];var r=this._propertyValueMap,a=O._propertyIdMap;for(var o in r)e.push(a[o]);if(!t)return e},s.clone=function(){var t=new n(this._group);return this.cloneTo(t),t},s.cloneTo=function(t){Ar.deepCloneObject(this._macroCollection,t._macroCollection,new Map),Object.assign(t._macroMap,this._macroMap);for(var e=t._getReferCount(),r=this._propertyValueMap,a=t._propertyValueMap,o=Object.keys(r),c=0,l=o.length;c<l;c++){var _=o[c],u=r[_];if(u!=null)if(typeof u=="number")a[_]=u;else if(lt(u,Wr))a[_]=u,e>0&&u._addReferCount(e);else if(lt(u,Array)||lt(u,Float32Array)||lt(u,Int32Array))a[_]=u.slice();else{var h=a[_];h?h.copyFrom(u):a[_]=u.clone()}else a[_]=u}},s._setPropertyValue=function(t,e,r){if(typeof t=="string"&&(t=O.getByName(t)),t._group!==this._group)if(t._group===void 0)t._group=this._group;else throw"Shader property "+t.name+" has been used as "+xr[t._group]+" group.";if(t._type!==e)if(t._type===void 0)t._type=e;else throw"Shader property "+t.name+" has been used as "+Vt[t._type]+" type.";this._propertyValueMap[t._uniqueId]=r},s._getReferCount=function(){return this._refCount},s._addReferCount=function(t){this._refCount+=t;var e=this._propertyValueMap;for(var r in e){var a=e[r];a&&lt(a,Wr)&&a._addReferCount(t)}},n}();T([F],Nr.prototype,"_group",void 0);T([F],Nr.prototype,"_propertyValueMap",void 0);T([F],Nr.prototype,"_macroCollection",void 0);T([F],Nr.prototype,"_macroMap",void 0);T([F],Nr.prototype,"_refCount",void 0);var Pr,ye=(Pr=function(n){W(s,n);function s(t){var e;e=n.call(this,t)||this,e._onUpdateIndex=-1,e._rendererIndex=-1,e._globalShaderMacro=new Kt,e._bounds=new lr,e._overrideUpdate=!1,e._materials=[],e._dirtyUpdateFlag=0,e._shaderData=new Nr(xr.Renderer),e._mvMatrix=new Z,e._mvpMatrix=new Z,e._mvInvMatrix=new Z,e._normalMatrix=new Z,e._materialsInstanced=[],e._priority=0,e._receiveShadows=!0,e._rendererLayer=new ie,e.castShadows=!0;var r=ye.prototype,a=e.shaderData;return e._overrideUpdate=e.update!==r.update,e._addResourceReferCount(e.shaderData,1),e._onTransformChanged=e._onTransformChanged.bind(ce(e)),e._registerEntityTransformListener(),a.enableMacro(ye._receiveShadowMacro),a.setVector4(ye._rendererLayerProperty,e._rendererLayer),e}var i=s.prototype;return i.getInstanceMaterial=function(e){e===void 0&&(e=0);var r=this._materials;if(r.length>e){var a=r[e];if(a)return this._materialsInstanced[e]?a:this._createInstanceMaterial(a,e)}return null},i.getMaterial=function(e){return e===void 0&&(e=0),this._materials[e]||null},i.setMaterial=function(e,r){r===void 0&&(r=null),typeof e=="number"?this._setMaterial(e,r):this._setMaterial(0,e)},i.getInstanceMaterials=function(){for(var e=this._materials,r=this._materialsInstanced,a=0,o=e.length;a<o;a++)r[a]||this._createInstanceMaterial(this._materials[a],a);return e},i.getMaterials=function(){return this._materials},i.setMaterials=function(e){for(var r=e.length,a=this._materials,o=this._materialsInstanced,c=r,l=a.length;c<l;c++){var _=a[c];_&&this._addResourceReferCount(_,-1)}a.length!==r&&(a.length=r),o.length!==0&&(o.length=0);for(var u=0;u<r;u++){var h=a[u],d=e[u];h!==d&&(a[u]=d,h&&this._addResourceReferCount(h,-1),d&&this._addResourceReferCount(d,1))}},i.update=function(e){},i._onEnableInScene=function(){var e=this.scene._componentsManager;this._overrideUpdate&&e.addOnUpdateRenderers(this),e.addRenderer(this)},i._onDisableInScene=function(){var e=this.scene._componentsManager;this._overrideUpdate&&e.removeOnUpdateRenderers(this),e.removeRenderer(this)},i._prepareRender=function(e){var r=e.virtualCamera,a=r.position,o=this.bounds.getCenter(ye._tempVector0);r.isOrthographic?(R.subtract(o,a,o),this._distanceForSort=R.dot(o,r.forward)):this._distanceForSort=R.distanceSquared(o,a),this._updateShaderData(e,!1),this._render(e),Kt.unionCollection(e.camera._globalShaderMacro,this.shaderData._macroCollection,this._globalShaderMacro)},i._cloneTo=function(e,r,a){for(var o=this._materials,c=0,l=o.length;c<l;c++)e._setMaterial(c,o[c])},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._unRegisterEntityTransformListener(),this._addResourceReferCount(this.shaderData,-1);for(var e=this._materials,r=0,a=e.length;r<a;r++){var o=e[r];o&&this._addResourceReferCount(o,-1)}this._entity=null,this._globalShaderMacro=null,this._bounds=null,this._materials=null,this._shaderData=null,this._mvMatrix=null,this._mvpMatrix=null,this._mvInvMatrix=null,this._normalMatrix=null,this._materialsInstanced=null,this._rendererLayer=null},i._updateShaderData=function(e,r){var a=this.entity,o=a.transform.worldMatrix;if(r){this._updateMVPShaderData(e,o);return}this._updateTransformShaderData(e,o);var c=a.layer;this._rendererLayer.set(c&65535,c>>>16&65535,0,0)},i._updateTransformShaderData=function(e,r){var a=this.shaderData,o=this._mvMatrix,c=this._mvInvMatrix,l=this._normalMatrix;Z.multiply(e.viewMatrix,r,o),Z.invert(o,c),Z.invert(r,l),l.transpose(),a.setMatrix(ye._localMatrixProperty,this.entity.transform.localMatrix),a.setMatrix(ye._worldMatrixProperty,r),a.setMatrix(ye._mvMatrixProperty,o),a.setMatrix(ye._mvInvMatrixProperty,c),a.setMatrix(ye._normalMatrixProperty,l),this._updateMVPShaderData(e,r)},i._updateMVPShaderData=function(e,r){var a=this._mvpMatrix;Z.multiply(e.viewProjectionMatrix,r,a),this.shaderData.setMatrix(ye._mvpMatrixProperty,a)},i._registerEntityTransformListener=function(){this.entity.transform._updateFlagManager.addListener(this._onTransformChanged)},i._unRegisterEntityTransformListener=function(){this.entity.transform._updateFlagManager.removeListener(this._onTransformChanged)},i._updateBounds=function(e){},i._render=function(e){throw"not implement"},i._createInstanceMaterial=function(e,r){var a=e.clone();return a.name=a.name+"(Instance)",this._addResourceReferCount(e,-1),this._addResourceReferCount(a,1),this._materialsInstanced[r]=!0,this._materials[r]=a,a},i._setMaterial=function(e,r){var a=this._materials;e>=a.length&&(a.length=e+1);var o=a[e];if(o!==r){var c=this._materialsInstanced;e<c.length&&(c[e]=!1),o&&this._addResourceReferCount(o,-1),r&&this._addResourceReferCount(r,1),a[e]=r}},i._onTransformChanged=function(e){this._dirtyUpdateFlag|=1},j(s,[{key:"shaderData",get:function(){return this._shaderData}},{key:"isCulled",get:function(){return!(this._renderFrameCount===void 0||this._renderFrameCount===this._engine.time.frameCount-1)}},{key:"receiveShadows",get:function(){return this._receiveShadows},set:function(e){this._receiveShadows!==e&&(e?this.shaderData.enableMacro(ye._receiveShadowMacro):this.shaderData.disableMacro(ye._receiveShadowMacro),this._receiveShadows=e)}},{key:"materialCount",get:function(){return this._materials.length},set:function(e){var r=this._materials,a=this._materialsInstanced;r.length!==e&&(r.length=e),a.length>e&&(a.length=e)}},{key:"bounds",get:function(){return this._dirtyUpdateFlag&1&&(this._updateBounds(this._bounds),this._dirtyUpdateFlag&=-2),this._bounds}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}}]),s}(Rt),function(){Pr._tempVector0=new R}(),function(){Pr._receiveShadowMacro=oe.getByName("RENDERER_IS_RECEIVE_SHADOWS")}(),function(){Pr._localMatrixProperty=O.getByName("renderer_LocalMat")}(),function(){Pr._worldMatrixProperty=O.getByName("renderer_ModelMat")}(),function(){Pr._mvMatrixProperty=O.getByName("renderer_MVMat")}(),function(){Pr._mvpMatrixProperty=O.getByName("renderer_MVPMat")}(),function(){Pr._mvInvMatrixProperty=O.getByName("renderer_MVInvMat")}(),function(){Pr._normalMatrixProperty=O.getByName("renderer_NormalMat")}(),function(){Pr._rendererLayerProperty=O.getByName("renderer_Layer")}(),Pr);T([F],ye.prototype,"_distanceForSort",void 0);T([F],ye.prototype,"_onUpdateIndex",void 0);T([F],ye.prototype,"_rendererIndex",void 0);T([F],ye.prototype,"_globalShaderMacro",void 0);T([F],ye.prototype,"_bounds",void 0);T([F],ye.prototype,"_renderFrameCount",void 0);T([F],ye.prototype,"_overrideUpdate",void 0);T([F],ye.prototype,"_materials",void 0);T([F],ye.prototype,"_dirtyUpdateFlag",void 0);T([J],ye.prototype,"_shaderData",void 0);T([F],ye.prototype,"_mvMatrix",void 0);T([F],ye.prototype,"_mvpMatrix",void 0);T([F],ye.prototype,"_mvInvMatrix",void 0);T([F],ye.prototype,"_normalMatrix",void 0);T([F],ye.prototype,"_materialsInstanced",void 0);T([Me],ye.prototype,"_priority",void 0);T([Me],ye.prototype,"_receiveShadows",void 0);T([F],ye.prototype,"_rendererLayer",void 0);T([F],ye.prototype,"_onTransformChanged",null);ye=T([ka(ge,Hn.CheckOnly)],ye);var Qe;(function(n){n[n.WorldVolume=1]="WorldVolume"})(Qe||(Qe={}));function kt(){return function(n){}}var Za,nn=(Za=function(){function n(){}return n.resetData=function(i){var t=i._verticesData,e=t.positions,r=t.uvs;t.vertexCount=e.length=r.length=4;for(var a=0;a<4;a++){var o,c,l,_;(o=e)[c=a]||(o[c]=new R),(l=r)[_=a]||(l[_]=new ee)}t.triangles=nn._rectangleTriangles},n.updatePositions=function(i){var t=i.width,e=i.height,r=i.sprite,a=r.pivot,o=a.x,c=a.y,l=nn._worldMatrix,_=l.elements,u=i.entity.transform.worldMatrix,h=u.elements,d=i.flipX?-t:t,f=i.flipY?-e:e;_[0]=h[0]*d,_[1]=h[1]*d,_[2]=h[2]*d,_[4]=h[4]*f,_[5]=h[5]*f,_[6]=h[6]*f,_[8]=h[8],_[9]=h[9],_[10]=h[10],_[12]=h[12]-o*_[0]-c*_[4],_[13]=h[13]-o*_[1]-c*_[5],_[14]=h[14]-o*_[2]-c*_[6];for(var v=r._getPositions(),p=i._verticesData.positions,g=0;g<4;g++){var y=v[g],m=y.x,x=y.y;p[g].set(_[0]*m+_[4]*x+_[12],_[1]*m+_[5]*x+_[13],_[2]*m+_[6]*x+_[14])}lr.transform(r._getBounds(),l,i._bounds)},n.updateUVs=function(i){var t=i.sprite._getUVs(),e=i._verticesData.uvs,r=t[0],a=r.x,o=r.y,c=t[3],l=c.x,_=c.y;e[0].set(a,o),e[1].set(l,o),e[2].set(a,_),e[3].set(l,_)},n}(),function(){Za._rectangleTriangles=[0,1,2,2,1,3]}(),function(){Za._worldMatrix=new Z}(),Za);nn=T([kt()],nn);var $a,Ma=($a=function(){function n(){}return n.resetData=function(i){var t=i._verticesData,e=t.positions,r=t.uvs;t.vertexCount=e.length=r.length=16;for(var a=0;a<16;a++){var o,c,l,_;(o=e)[c=a]||(o[c]=new R),(l=r)[_=a]||(l[_]=new ee)}t.triangles=Ma._rectangleTriangles},n.updatePositions=function(i){var t=i.width,e=i.height,r=i.sprite,a=i._verticesData,o=a.positions,c=a.uvs,l=r.border,_=r._getUVs(),u=r._getPositions(),h=u[0],d=h.x,f=h.y,v=u[3],p=v.x,g=v.y,y=r.width,m=r.height,x=y*l.x,C=m*l.y,b=y*l.z,A=m*l.w,S,w;if(x+b>t){var E=t/(x+b);S=[y*d*E,x*E,x*E,t-y*(1-p)*E]}else S=[y*d,x,t-b,t-y*(1-p)];if(A+C>e){var P=e/(A+C);w=[m*f*P,C*P,C*P,e-m*(1-g)*P]}else w=[m*f,C,e-A,e-m*(1-g)];var M=i.sprite.pivot,D=M.x,L=M.y,V=i.width*D,N=i.height*L,I=Ma._worldMatrix,B=I.elements,z=i.entity.transform.worldMatrix,U=z.elements,Y=i.flipX?-1:1,Q=i.flipY?-1:1;B[0]=U[0]*Y,B[1]=U[1]*Y,B[2]=U[2]*Y,B[4]=U[4]*Q,B[5]=U[5]*Q,B[6]=U[6]*Q,B[8]=U[8],B[9]=U[9],B[10]=U[10],B[12]=U[12]-V*B[0]-N*B[4],B[13]=U[13]-V*B[1]-N*B[5],B[14]=U[14]-V*B[2]-N*B[6];for(var H=0;H<4;H++)for(var te=S[H],Ce=_[H].x,de=0;de<4;de++){var ae=w[de],Ae=H*4+de;o[Ae].set(B[0]*te+B[4]*ae+B[12],B[1]*te+B[5]*ae+B[13],B[2]*te+B[6]*ae+B[14]),c[Ae].set(Ce,_[de].y)}var je=i._bounds,_t=je.min,xe=je.max;_t.set(S[0],w[0],0),xe.set(S[3],w[3],0),i._bounds.transform(I)},n.updateUVs=function(i){},n}(),function(){$a._rectangleTriangles=[0,1,4,1,5,4,1,2,5,2,6,5,2,3,6,3,7,6,4,5,8,5,9,8,5,6,9,6,10,9,6,7,10,7,11,10,8,9,12,9,13,12,9,10,13,10,14,13,10,11,14,11,15,14]}(),function(){$a._worldMatrix=new Z}(),$a);Ma=T([kt()],Ma);var He=function(){function n(i){i===void 0&&(i=0),this.length=0,this._isLooping=!1,this._blankCount=0,this._elements=new Array(i)}var s=n.prototype;return s.add=function(t){this.length===this._elements.length?this._elements.push(t):this._elements[this.length]=t,this.length++},s.delete=function(t){var e=this._elements.indexOf(t);this.deleteByIndex(e)},s.set=function(t,e){if(t>=this.length)throw"Index is out of range.";this._elements[t]=e},s.get=function(t){if(t>=this.length)throw"Index is out of range.";return this._elements[t]},s.deleteByIndex=function(t){var e=this._elements,r;if(this._isLooping)this._elements[t]=null,this._blankCount++;else{var a=this.length-1;t!==a&&(r=e[a],e[t]=r),e[a]=null,this.length--}return r},s.forEach=function(t,e){this._startLoop();for(var r=this._elements,a=0,o=this.length;a<o;a++){var c=r[a];c&&t(c)}this._endLoop(e)},s.forEachAndClean=function(t){this._startLoop();for(var e=this._elements,r=0,a=this.length;r<a;r++){var o=e[r];o&&t(o)}this._endLoopAndClear()},s.sort=function(t){Ue._quickSort(this._elements,0,this.length,t)},s.garbageCollection=function(){this._elements.length=this.length},s._startLoop=function(){this._isLooping=!0},s._endLoop=function(t){if(this._isLooping=!1,this._blankCount){var e=0,r=this.length-1,a=this._elements;e:do{for(;a[e];)if(++e>=r)break e;for(;!a[r];)if(e>=--r)break e;var o=a[r];t(o,e),a[e++]=o,a[r--]=null}while(e<r);this.length-=this._blankCount,this._blankCount=0}},s._endLoopAndClear=function(){this._isLooping=!1,this.length=0,this._blankCount=0},n}(),Je;(function(n){n[n.Static=0]="Static",n[n.Dynamic=1]="Dynamic",n[n.Stream=2]="Stream"})(Je||(Je={}));var _n;(function(n){n[n.None=0]="None",n[n.Discard=1]="Discard"})(_n||(_n={}));var Jt=function(n){W(s,n);function s(t,e,r,a,o){a===void 0&&(a=Je.Static),o===void 0&&(o=!1);var c;if(c=n.call(this,t)||this,c._dataUpdateManager=new Er,c._engine=t,c._type=e,c._bufferUsage=a,c._readable=o,typeof r=="number")c._byteLength=r,c._platformBuffer=t._hardwareRenderer.createPlatformBuffer(e,r,a),o&&(c._data=new Uint8Array(r));else{var l=r,_=l.byteLength;if(c._byteLength=_,c._platformBuffer=t._hardwareRenderer.createPlatformBuffer(e,_,a,l),o){var u=l.constructor===ArrayBuffer?l.slice(0):l.buffer.slice(l.byteOffset,l.byteOffset+_);c._data=new Uint8Array(u)}}return c}var i=s.prototype;return i.bind=function(){this._platformBuffer.bind()},i.setData=function(e,r,a,o,c){if(r===void 0&&(r=0),a===void 0&&(a=0),c===void 0&&(c=_n.None),this._platformBuffer.setData(this._byteLength,e,r,a,o,c),this._readable){var l=e.constructor===ArrayBuffer?e:e.buffer;if(this._data.buffer!==l){var _=e.BYTES_PER_ELEMENT||1,u=o?_*o:e.byteLength,h=e.byteOffset!==void 0,d=h?e.byteOffset+a*_:a,f=new Uint8Array(l,d,u);this._data.set(f,r)}}this._isContentLost=!1,this._dataUpdateManager.dispatch()},i.getData=function(e,r,a,o){r===void 0&&(r=0),a===void 0&&(a=0),this._platformBuffer.getData(e,r,a,o)},i.markAsUnreadable=function(){this._data=null,this._readable=!1},i._rebuild=function(){var e=this._engine._hardwareRenderer.createPlatformBuffer(this._type,this._byteLength,this._bufferUsage);this._platformBuffer=e},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._platformBuffer.destroy()},j(s,[{key:"type",get:function(){return this._type}},{key:"byteLength",get:function(){return this._byteLength}},{key:"bufferUsage",get:function(){return this._bufferUsage}},{key:"readable",get:function(){return this._readable}},{key:"data",get:function(){if(this._readable)return this._data;throw"Buffer is not readable."}}]),s}(ki),St;(function(n){n[n.UInt8=0]="UInt8",n[n.UInt16=1]="UInt16",n[n.UInt32=2]="UInt32"})(St||(St={}));var $;(function(n){n[n.Float=0]="Float",n[n.Vector2=1]="Vector2",n[n.Vector3=2]="Vector3",n[n.Vector4=3]="Vector4",n[n.Byte4=4]="Byte4",n[n.UByte4=5]="UByte4",n[n.NormalizedByte4=6]="NormalizedByte4",n[n.NormalizedUByte4=7]="NormalizedUByte4",n[n.Short2=8]="Short2",n[n.UShort2=9]="UShort2",n[n.NormalizedShort2=10]="NormalizedShort2",n[n.NormalizedUShort2=11]="NormalizedUShort2",n[n.Short4=12]="Short4",n[n.UShort4=13]="UShort4",n[n.NormalizedShort4=14]="NormalizedShort4",n[n.NormalizedUShort4=15]="NormalizedUShort4"})($||($={}));var pi=function(){function n(){}return n._getGLIndexType=function(i){switch(i){case St.UInt8:return Ie.UNSIGNED_BYTE;case St.UInt16:return Ie.UNSIGNED_SHORT;case St.UInt32:return Ie.UNSIGNED_INT}},n._getGLIndexByteCount=function(i){switch(i){case St.UInt8:return 1;case St.UInt16:return 2;case St.UInt32:return 4}},n._getElementInfo=function(i){var t,e,r=!1,a;switch(i){case $.Float:t=1,e=Ie.FLOAT;break;case $.Vector2:t=2,e=Ie.FLOAT;break;case $.Vector3:t=3,e=Ie.FLOAT;break;case $.Vector4:t=4,e=Ie.FLOAT;break;case $.Byte4:t=4,e=Ie.BYTE;break;case $.UByte4:t=4,e=Ie.UNSIGNED_BYTE;break;case $.NormalizedByte4:t=4,e=Ie.BYTE,r=!0,a=1/127;break;case $.NormalizedUByte4:t=4,e=Ie.UNSIGNED_BYTE,r=!0,a=1/255;break;case $.Short2:t=2,e=Ie.SHORT;break;case $.UShort2:t=2,e=Ie.UNSIGNED_SHORT;break;case $.NormalizedShort2:t=2,e=Ie.SHORT,r=!0,a=1/32767;break;case $.NormalizedUShort2:t=2,e=Ie.UNSIGNED_SHORT,r=!0,a=1/65535;break;case $.Short4:t=4,e=Ie.SHORT;break;case $.UShort4:t=4,e=Ie.UNSIGNED_SHORT;break;case $.NormalizedShort4:t=4,e=Ie.SHORT,r=!0,a=1/32767;break;case $.NormalizedUShort4:t=4,e=Ie.UNSIGNED_SHORT,r=!0,a=1/65535;break}return{size:t,type:e,normalized:r,normalizedScaleFactor:a}},n}(),Mt;(function(n){n[n.VertexBuffer=0]="VertexBuffer",n[n.IndexBuffer=1]="IndexBuffer"})(Mt||(Mt={}));var un;(function(n){n[n.Points=0]="Points",n[n.Lines=1]="Lines",n[n.LineLoop=2]="LineLoop",n[n.LineStrip=3]="LineStrip",n[n.Triangles=4]="Triangles",n[n.TriangleStrip=5]="TriangleStrip",n[n.TriangleFan=6]="TriangleFan"})(un||(un={}));var Pa=function(){function n(s,i){this._buffer=s,this._format=i}return j(n,[{key:"buffer",get:function(){return this._buffer}},{key:"format",get:function(){return this._format}}]),n}(),Gi=function(){function n(i,t,e){i===void 0&&(i=0),t===void 0&&(t=0),e===void 0&&(e=un.Triangles),this.start=i,this.count=t,this.topology=e}var s=n.prototype;return s.dispose=function(){},n}(),To=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e.enableVAO=!0,e.instanceCount=0,e.vertexBufferBindings=[],e._vertexElementMap={},e._bufferStructChanged=!1,e._vertexElements=[],e._platformPrimitive=t._hardwareRenderer.createPlatformPrimitive(ce(e)),e}var i=s.prototype;return i.addVertexElement=function(e){var r=this._vertexElementMap,a=this._vertexElements,o=e.attribute,c=r[o];c&&(console.warn("VertexElement "+o+" already exists."),a.splice(a.indexOf(c),1)),r[o]=e,a.push(e),this._bufferStructChanged=!0},i.removeVertexElement=function(e){var r=this._vertexElements,a=r[e];r.splice(e,1),delete this._vertexElementMap[a.attribute],this._bufferStructChanged=!0},i.clearVertexElements=function(){this._vertexElements.length=0;var e=this._vertexElementMap;for(var r in e)delete e[r];this._bufferStructChanged=!0},i.setVertexElement=function(e,r){var a=this._vertexElementMap,o=this._vertexElements,c=o[e];c&&delete a[c.attribute],a[r.attribute]=r,o[e]=r,this._bufferStructChanged=!0},i.setVertexElementsLength=function(e){for(var r=this._vertexElementMap,a=this._vertexElements,o=e,c=a.length;o<c;o++){var l=a[o];delete r[l.attribute]}a.length=e},i.setVertexBufferBinding=function(e,r){var a=this._getReferCount(),o=this.vertexBufferBindings;if(a>0){var c,l;(c=o[e])==null||c.buffer._addReferCount(-a),(l=r)==null||l.buffer._addReferCount(a)}o[e]=r,this._bufferStructChanged=!0},i.setVertexBufferBindings=function(e,r){r===void 0&&(r=0);var a=this.vertexBufferBindings,o=e.length,c=r+o;a.length<c&&(a.length=c);for(var l=0;l<o;l++)this.setVertexBufferBinding(r+l,e[l])},i.setIndexBufferBinding=function(e){var r=this.indexBufferBinding,a=this._getReferCount();if(r!==e){var o,c,l;this._indexBufferBinding=e,a>0&&((o=r)==null||o.buffer._addReferCount(-a)),e?(a>0&&e.buffer._addReferCount(a),this._glIndexType=pi._getGLIndexType(e.format),this._glIndexByteCount=pi._getGLIndexByteCount(e.format)):this._glIndexType=void 0,this._bufferStructChanged=((c=r)==null?void 0:c.buffer)!==((l=e)==null?void 0:l.buffer)}},i.draw=function(e,r){this._platformPrimitive.draw(e,r),this._bufferStructChanged=!1},i._addReferCount=function(e){var r;n.prototype._addReferCount.call(this,e);for(var a=this.vertexBufferBindings,o=0,c=a.length;o<c;o++){var l;(l=a[o])==null||l.buffer._addReferCount(e)}(r=this.indexBufferBinding)==null||r._buffer._addReferCount(e)},i._rebuild=function(){this._engine._hardwareRenderer.createPlatformPrimitive(this),this._isContentLost=!1},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._platformPrimitive.destroy(),this._vertexElementMap=null},j(s,[{key:"vertexElements",get:function(){return this._vertexElements}},{key:"indexBufferBinding",get:function(){return this._indexBufferBinding}}]),s}(ki),Ro=function(n){W(s,n);function s(t,e){var r;r=n.call(this,t)||this,r._updateFlagManager=new Er,r._bounds=new lr,r._subMeshes=[],r.name=e,r._primitive=new To(t),r._onBoundsChanged=r._onBoundsChanged.bind(ce(r));var a=r._bounds;return a.min._onValueChanged=r._onBoundsChanged,a.max._onValueChanged=r._onBoundsChanged,r}var i=s.prototype;return i.addSubMesh=function(e,r,a){return a===void 0&&(a=un.Triangles),typeof e=="number"&&(e=new Gi(e,r,a)),this._subMeshes.push(e),e},i.removeSubMesh=function(e){var r=this._subMeshes,a=r.indexOf(e);a!==-1&&r.splice(a,1)},i.clearSubMesh=function(){this._subMeshes.length=0},i._clearVertexElements=function(){this._primitive.clearVertexElements(),this._updateFlagManager.dispatch(2)},i._addVertexElement=function(e){this._primitive.addVertexElement(e),this._updateFlagManager.dispatch(2)},i._removeVertexElement=function(e){this._primitive.removeVertexElement(e),this._updateFlagManager.dispatch(2)},i._setVertexElement=function(e,r){this._primitive.setVertexElement(e,r),this._updateFlagManager.dispatch(2)},i._setVertexElementsLength=function(e){this._primitive.setVertexElementsLength(e)},i._setVertexBufferBinding=function(e,r){this._primitive.setVertexBufferBinding(e,r)},i._addReferCount=function(e){n.prototype._addReferCount.call(this,e),this._primitive._addReferCount(e)},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._primitive.destroy()},i._setVertexElements=function(e){this._clearVertexElements();for(var r=0,a=e.length;r<a;r++)this._addVertexElement(e[r])},i._setIndexBufferBinding=function(e){this._primitive.setIndexBufferBinding(e)},i._onBoundsChanged=function(){this._updateFlagManager.dispatch(1)},j(s,[{key:"bounds",get:function(){return this._bounds},set:function(e){this._bounds!==e&&this._bounds.copyFrom(e)}},{key:"subMesh",get:function(){return this._subMeshes[0]||null}},{key:"subMeshes",get:function(){return this._subMeshes}}]),s}(Qr),gi;(function(n){n[n.Bounds=1]="Bounds",n[n.VertexElements=2]="VertexElements"})(gi||(gi={}));var Wn=function(){function n(s,i){this._buffer=s,this._stride=i}return j(n,[{key:"buffer",get:function(){return this._buffer}},{key:"stride",get:function(){return this._stride}}]),n}(),Te=function(){function n(s,i,t,e,r){r===void 0&&(r=0),this._attributeName=s,this._offset=i,this._format=t,this._bindingIndex=e,this._formatMetaInfo=pi._getElementInfo(this.format),this._instanceStepRate=Math.floor(r)}return j(n,[{key:"attribute",get:function(){return this._attributeName}},{key:"offset",get:function(){return this._offset},set:function(i){this._offset=i}},{key:"format",get:function(){return this._format}},{key:"bindingIndex",get:function(){return this._bindingIndex},set:function(i){this._bindingIndex=i}},{key:"instanceStepRate",get:function(){return this._instanceStepRate}},{key:"semantic",get:function(){return this.attribute}}]),n}(),Rc=function(){function n(i,t,e,r){if(e===void 0&&(e=null),r===void 0&&(r=null),this._dataChangeManager=new Er,this._dirty=7,e&&e.length!==t.length)throw"deltaNormals length must same with deltaPositions length.";if(r&&r.length!==t.length)throw"deltaTangents length must same with deltaPositions length.";this.weight=i,this._deltaPositions=t,this._deltaNormals=e,this._deltaTangents=r}var s=n.prototype;return s._releaseData=function(){this._deltaPositions=null,this._deltaNormals=null,this._deltaTangents=null},j(n,[{key:"deltaPositions",get:function(){return this._deltaPositions},set:function(t){this._deltaPositions=t,this._dirty|=1,this._dataChangeManager.dispatch(this._dirty,this)}},{key:"deltaNormals",get:function(){return this._deltaNormals},set:function(t){this._deltaNormals=t,this._dirty|=2,this._dataChangeManager.dispatch(this._dirty,this)}},{key:"deltaTangents",get:function(){return this._deltaTangents},set:function(t){this._deltaTangents=t,this._dirty|=4,this._dataChangeManager.dispatch(this._dirty,this)}}]),n}(),oo;(function(n){n[n.Position=1]="Position",n[n.Normal=2]="Normal",n[n.Tangent=4]="Tangent",n[n.All=7]="All"})(oo||(oo={}));var Mo=function(){function n(i){this._useBlendShapeNormal=!0,this._useBlendShapeTangent=!0,this._layoutChangeManager=new Er,this._dataChangeManager=new Er,this._frames=[],this.name=i,this._frameDataChangeListener=this._frameDataChangeListener.bind(this)}var s=n.prototype;return s.addFrame=function(t,e,r,a){if(typeof t=="number"){var o=new Rc(t,e,r,a);return this._addFrame(o),o}else this._addFrame(t)},s.clearFrames=function(){for(var t=this._frames,e=0,r=t.length;e<r;e++)t[e]._dataChangeManager.removeListener(this._frameDataChangeListener);t.length=0,this._updateUseNormalAndTangent(!0,!0),this._dataChangeManager.dispatch()},s._releaseData=function(){for(var t=this._frames,e=0,r=t.length;e<r;e++)t[e]._releaseData()},s._addFrame=function(t){var e=this._frames,r=e.length;if(r>0&&t.deltaPositions.length!==e[r-1].deltaPositions.length)throw"Frame's deltaPositions length must same with before frame deltaPositions length.";this._frames.push(t),this._frameDataChangeListener(oo.All,t),t._dataChangeManager.addListener(this._frameDataChangeListener)},s._updateUseNormalAndTangent=function(t,e){var r=this._useBlendShapeNormal&&t,a=this._useBlendShapeTangent&&e;(this._useBlendShapeNormal!==r||this._useBlendShapeTangent!==a)&&(this._useBlendShapeNormal=r,this._useBlendShapeTangent=a,this._layoutChangeManager.dispatch(0,this))},s._frameDataChangeListener=function(t,e){this._updateUseNormalAndTangent(!!e.deltaNormals,!!e.deltaTangents),this._dataChangeManager.dispatch()},j(n,[{key:"frames",get:function(){return this._frames}}]),n}(),Po=function(n){W(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.setVertexElements=function(e){this._setVertexElements(e)},i.setVertexBufferBinding=function(e,r,a){r===void 0&&(r=0),a===void 0&&(a=0);var o=e,c=o.buffer!==void 0;c||(o=new Wn(e,r));var l=this._primitive.vertexBufferBindings;l.length<=a&&(l.length=a+1),this._setVertexBufferBinding(c?r:a,o)},i.setVertexBufferBindings=function(e,r){r===void 0&&(r=0);var a=this._primitive.vertexBufferBindings,o=e.length,c=r+o;a.length<c&&(a.length=c);for(var l=0;l<o;l++)this._setVertexBufferBinding(r+l,e[l])},i.setIndexBufferBinding=function(e,r){var a=e;if(a){var o=a.buffer!==void 0;o||(a=new Pa(e,r))}this._setIndexBufferBinding(a)},j(s,[{key:"instanceCount",get:function(){return this._primitive.instanceCount},set:function(e){this._primitive.instanceCount=e}},{key:"vertexBufferBindings",get:function(){return this._primitive.vertexBufferBindings}},{key:"indexBufferBinding",get:function(){return this._primitive.indexBufferBinding}},{key:"vertexElements",get:function(){return this._primitive.vertexElements}}]),s}(Ro),Ir=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._enableVertexColor=!1,e._onMeshChanged=e._onMeshChanged.bind(ce(e)),e}var i=s.prototype;return i._onDestroy=function(){var e=this._mesh;e&&(e.destroyed||this._addResourceReferCount(e,-1),e._updateFlagManager.removeListener(this._onMeshChanged),this._mesh=null),n.prototype._onDestroy.call(this)},i._cloneTo=function(e,r,a){n.prototype._cloneTo.call(this,e,r,a),e.mesh=this._mesh},i._prepareRender=function(e){if(!this._mesh){ve.error("mesh is null.");return}if(this._mesh.destroyed){ve.error("mesh is destroyed.");return}n.prototype._prepareRender.call(this,e)},i._updateBounds=function(e){var r=this._mesh;if(r){var a=r.bounds,o=this._entity.transform.worldMatrix;lr.transform(a,o,e)}else e.min.set(0,0,0),e.max.set(0,0,0)},i._render=function(e){var r=this._mesh;if(this._dirtyUpdateFlag&2){var a=this.shaderData,o=r._primitive.vertexElements;a.disableMacro(s._uvMacro),a.disableMacro(s._uv1Macro),a.disableMacro(s._normalMacro),a.disableMacro(s._tangentMacro),a.disableMacro(s._enableVertexColorMacro);for(var c=0,l=o.length;c<l;c++)switch(o[c].attribute){case"TEXCOORD_0":a.enableMacro(s._uvMacro);break;case"TEXCOORD_1":a.enableMacro(s._uv1Macro);break;case"NORMAL":a.enableMacro(s._normalMacro);break;case"TANGENT":a.enableMacro(s._tangentMacro);break;case"COLOR_0":this._enableVertexColor&&a.enableMacro(s._enableVertexColorMacro);break}this._dirtyUpdateFlag&=-3}for(var _=this._materials,u=r.subMeshes,h=e.camera._renderPipeline,d=this._engine._renderDataPool,f=0,v=u.length;f<v;f++){var p=_[f];if(p){(p.destroyed||p.shader.destroyed)&&(p=this.engine._meshMagentaMaterial);var g=d.getFromPool();g.setX(this,p,r._primitive,u[f]),h.pushRenderData(e,g)}}},i._setMesh=function(e){var r=this._mesh;r&&(this._addResourceReferCount(r,-1),r._updateFlagManager.removeListener(this._onMeshChanged)),e&&(this._addResourceReferCount(e,1),e._updateFlagManager.addListener(this._onMeshChanged),this._dirtyUpdateFlag|=3),this._mesh=e},i._onMeshChanged=function(e){e&gi.Bounds&&(this._dirtyUpdateFlag|=Qe.WorldVolume),e&gi.VertexElements&&(this._dirtyUpdateFlag|=2)},j(s,[{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&this._setMesh(e)}},{key:"enableVertexColor",get:function(){return this._enableVertexColor},set:function(e){e!==this._enableVertexColor&&(this._dirtyUpdateFlag|=2,this._enableVertexColor=e)}}]),s}(ye);(function(){Ir._uvMacro=oe.getByName("RENDERER_HAS_UV")})();(function(){Ir._uv1Macro=oe.getByName("RENDERER_HAS_UV1")})();(function(){Ir._normalMacro=oe.getByName("RENDERER_HAS_NORMAL")})();(function(){Ir._tangentMacro=oe.getByName("RENDERER_HAS_TANGENT")})();(function(){Ir._enableVertexColorMacro=oe.getByName("RENDERER_ENABLE_VERTEXCOLOR")})();T([F],Ir.prototype,"_mesh",void 0);T([F],Ir.prototype,"_onMeshChanged",null);var Qo;(function(n){n[n.VertexElementMacro=2]="VertexElementMacro",n[n.All=3]="All"})(Qo||(Qo={}));var Ba;(function(n){n[n.Depth=27]="Depth",n[n.Stencil=28]="Stencil",n[n.DepthStencil=29]="DepthStencil",n[n.Depth16=30]="Depth16",n[n.Depth24=31]="Depth24",n[n.Depth32=32]="Depth32",n[n.Depth24Stencil8=33]="Depth24Stencil8",n[n.Depth32Stencil8=34]="Depth32Stencil8"})(Ba||(Ba={}));var wr;(function(n){n[n.PositiveX=0]="PositiveX",n[n.NegativeX=1]="NegativeX",n[n.PositiveY=2]="PositiveY",n[n.NegativeY=3]="NegativeY",n[n.PositiveZ=4]="PositiveZ",n[n.NegativeZ=5]="NegativeZ"})(wr||(wr={}));var vr;(function(n){n[n.Never=0]="Never",n[n.Less=1]="Less",n[n.Equal=2]="Equal",n[n.LessEqual=3]="LessEqual",n[n.Greater=4]="Greater",n[n.NotEqual=5]="NotEqual",n[n.GreaterEqual=6]="GreaterEqual",n[n.Always=7]="Always"})(vr||(vr={}));var la;(function(n){n[n.Static=0]="Static",n[n.Dynamic=1]="Dynamic"})(la||(la={}));var gt;(function(n){n[n.Clamp=0]="Clamp",n[n.Repeat=1]="Repeat",n[n.Mirror=2]="Mirror"})(gt||(gt={}));var Da=function(n){W(s,n);function s(t,e,r,a,o,c){o===void 0&&(o=G.Depth),c===void 0&&(c=1);var l;if(l=n.call(this,t)||this,l._depthFormat=null,l._autoGenerateMipmaps=!0,l._depthTexture=null,l._width=e,l._height=r,l._antiAliasing=c,l._depth=o,a){for(var _=lt(a,Array)?a.slice():[a],u=0,h=_.length;u<h;u++){var d=_[u];if(d._isDepthTexture)throw"Render texture can't use depth format.";d._addReferCount(1)}l._colorTextures=_}else l._colorTextures=[];if(lt(o,Wr)){if(!o._isDepthTexture)throw"Depth texture must use depth format.";l._depthTexture=o,l._depthTexture._addReferCount(1),l._depthFormat=o.format}else typeof o=="number"&&(l._depthFormat=o);return l._platformRenderTarget=t._hardwareRenderer.createPlatformRenderTarget(ce(l)),l}var i=s.prototype;return i.getColorTexture=function(e){e===void 0&&(e=0);var r;return(r=this._colorTextures[e])!=null?r:null},i.generateMipmaps=function(){if(this._autoGenerateMipmaps){for(var e=this._colorTextures,r=0,a=e.length;r<a;r++){var o=e[r];o.generateMipmaps()}this._depthTexture&&this._depthTexture.generateMipmaps()}},i._onDestroy=function(){var e;n.prototype._onDestroy.call(this),this._platformRenderTarget.destroy();for(var r=this,a=r._colorTextures,o=0,c=a.length;o<c;o++)a[o]._addReferCount(-1);a.length=0,(e=this._depthTexture)==null||e._addReferCount(-1),this._depthTexture=null,this._depth=null},i._blitRenderTarget=function(){this._platformRenderTarget.blitRenderTarget()},i._rebuild=function(){this._platformRenderTarget=this._engine._hardwareRenderer.createPlatformRenderTarget(this)},j(s,[{key:"autoGenerateMipmaps",get:function(){return this._autoGenerateMipmaps},set:function(e){this._autoGenerateMipmaps=e}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorTextureCount",get:function(){return this._colorTextures.length}},{key:"depthTexture",get:function(){return this._depthTexture}},{key:"antiAliasing",get:function(){return this._antiAliasing}}]),s}(ki),Tt=function(n){W(s,n);function s(t,e,r,a,o,c){a===void 0&&(a=G.R8G8B8A8),o===void 0&&(o=!0),c===void 0&&(c=la.Static);var l;return l=n.call(this,t)||this,l._mipmap=o,l._width=e,l._height=r,l._usage=c,l._format=a,l._mipmapCount=l._getMipmapCount(),l._isDepthTexture=a==G.Depth||a==G.DepthStencil||a==G.Depth16||a==G.Depth24||a==G.Depth32||a==G.Depth24Stencil8||a==G.Depth32Stencil8,l._platformTexture=t._hardwareRenderer.createPlatformTexture2D(ce(l)),l.filterMode=l._isIntFormat()?tt.Point:tt.Bilinear,l.wrapModeU=l.wrapModeV=gt.Repeat,l}var i=s.prototype;return i.setPixelBuffer=function(e,r,a,o,c,l){r===void 0&&(r=0),a===void 0&&(a=0),o===void 0&&(o=0),this._platformTexture.setPixelBuffer(e,r,a,o,c,l),this._isContentLost=!1},i.setImageSource=function(e,r,a,o,c,l){r===void 0&&(r=0),a===void 0&&(a=!1),o===void 0&&(o=!1),c===void 0&&(c=0),l===void 0&&(l=0),this._platformTexture.setImageSource(e,r,a,o,c,l),this._isContentLost=!1},i.getPixelBuffer=function(e,r,a,o,c,l){var _=arguments.length;_===1?this._platformTexture.getPixelBuffer(0,0,this._width,this._height,0,e):_===2?this._platformTexture.getPixelBuffer(0,0,this._width>>e,this._height>>e,e,r):_===5?this._platformTexture.getPixelBuffer(e,r,a,o,0,c):_===6&&this._platformTexture.getPixelBuffer(e,r,a,o,c,l)},i._rebuild=function(){this._platformTexture=this._engine._hardwareRenderer.createPlatformTexture2D(this),n.prototype._rebuild.call(this)},s}(Wr),Bo=function(n){W(s,n);function s(t,e,r,a,o,c){o===void 0&&(o=G.R8G8B8A8),c===void 0&&(c=!0);var l;return l=n.call(this,t)||this,l._mipmap=c,l._width=e,l._height=r,l._length=a,l._format=o,l._mipmapCount=l._getMipmapCount(),l._platformTexture=t._hardwareRenderer.createPlatformTexture2DArray(ce(l)),l.filterMode=tt.Bilinear,l.wrapModeU=l.wrapModeV=gt.Repeat,l}var i=s.prototype;return i.setPixelBuffer=function(e,r,a,o,c,l,_,u){a===void 0&&(a=0),o===void 0&&(o=0),c===void 0&&(c=0),this._platformTexture.setPixelBuffer(e,r,a,o,c,l,_,u),this._isContentLost=!1},i.setImageSource=function(e,r,a,o,c,l,_){a===void 0&&(a=0),o===void 0&&(o=!1),c===void 0&&(c=!1),l===void 0&&(l=0),_===void 0&&(_=0),this._platformTexture.setImageSource(e,r,a,o,c,l,_),this._isContentLost=!1},i.getPixelBuffer=function(e,r,a,o,c,l,_){var u=arguments.length;u===1?this._platformTexture.getPixelBuffer(e,0,0,this._width,this._height,0,r):u===2?this._platformTexture.getPixelBuffer(e,0,0,this._width>>r,this._height>>r,r,a):u===5?this._platformTexture.getPixelBuffer(e,r,a,o,c,0,l):u===6&&this._platformTexture.getPixelBuffer(e,r,a,o,c,l,_)},i._rebuild=function(){this._platformTexture=this._engine._hardwareRenderer.createPlatformTexture2DArray(this),n.prototype._rebuild.call(this)},j(s,[{key:"length",get:function(){return this._length}}]),s}(Wr),jt=function(n){W(s,n);function s(t,e,r,a){r===void 0&&(r=G.R8G8B8A8),a===void 0&&(a=!0);var o;return o=n.call(this,t)||this,o._mipmap=a,o._width=e,o._height=e,o._format=r,o._mipmapCount=o._getMipmapCount(),o._platformTexture=t._hardwareRenderer.createPlatformTextureCube(ce(o)),o.filterMode=tt.Bilinear,o.wrapModeU=o.wrapModeV=gt.Clamp,o}var i=s.prototype;return i.setPixelBuffer=function(e,r,a,o,c,l,_){a===void 0&&(a=0),o===void 0&&(o=0),c===void 0&&(c=0),this._platformTexture.setPixelBuffer(e,r,a,o,c,l,_),this._isContentLost=!1},i.setImageSource=function(e,r,a,o,c,l,_){a===void 0&&(a=0),o===void 0&&(o=!1),c===void 0&&(c=!1),l===void 0&&(l=0),_===void 0&&(_=0),this._platformTexture.setImageSource(e,r,a,o,c,l,_),this._isContentLost=!1},i.getPixelBuffer=function(e,r,a,o,c,l,_){var u=arguments.length;u===2?this._platformTexture.getPixelBuffer(e,0,0,this._width,this._height,0,r):u===3?this._platformTexture.getPixelBuffer(e,0,0,this._width>>r,this._height>>r,r,a):u===6?this._platformTexture.getPixelBuffer(e,r,a,o,c,0,l):u===7&&this._platformTexture.getPixelBuffer(e,r,a,o,c,l,_)},i._rebuild=function(){this._platformTexture=this._engine._hardwareRenderer.createPlatformTextureCube(this),n.prototype._rebuild.call(this)},s}(Wr),Tn=function(){function n(i,t){this._blendShapeCount=0,this._blendShapes=[],this._subDataDirtyFlags=[],this._vertexBuffers=[],this._uniformOccupiesCount=0,this._bufferBindingOffset=-1,this._vertexElementOffset=0,this._useBlendNormal=!1,this._useBlendTangent=!1,this._vertexElementCount=0,this._storeInVertexBufferInfo=[],this._maxCountSingleVertexBuffer=0,this._lastHostCreatedInfo=new ie,this._canUseTextureStoreData=!0,this._dataTextureInfo=new R,this._engine=i,this._modelMesh=t,this._canUseTextureStoreData=this._engine._hardwareRenderer.capability.canUseFloatTextureBlendShape,this._updateLayoutChange=this._updateLayoutChange.bind(this)}var s=n.prototype;return s._addBlendShape=function(t){this._blendShapes.push(t),this._blendShapeCount++,t._layoutChangeManager.addListener(this._updateLayoutChange),this._updateLayoutChange(0,t),this._subDataDirtyFlags.push(t._dataChangeManager.createFlag(zi))},s._clearBlendShapes=function(){for(var t=this._blendShapes,e=0,r=t.length;e<r;e++)t[e]._layoutChangeManager.removeListener(this._updateLayoutChange);this._useBlendNormal=!1,this._useBlendTangent=!1,this._vertexElementCount=0,this._blendShapes.length=0,this._blendShapeCount=0;for(var a=this._subDataDirtyFlags,o=0,c=a.length;o<c;o++)a[o].destroy();a.length=0},s._updateShaderData=function(t,e){var r=this._blendShapeCount;if(r>0){if(t.enableMacro(n._blendShapeMacro),this._useTextureMode())t.enableMacro(n._blendShapeTextureMacro),t.setTexture(n._blendShapeTextureProperty,this._vertexTexture),t.setVector3(n._blendShapeTextureInfoProperty,this._dataTextureInfo),t.setFloatArray(n._blendShapeWeightsProperty,e.blendShapeWeights),t.enableMacro("RENDERER_BLENDSHAPE_COUNT",r.toString()),this._uniformOccupiesCount=r+1;else{var a=this._getVertexBufferModeSupportCount();if(r>a){var o=e._condensedBlendShapeWeights;o||(o=new Float32Array(a),e._condensedBlendShapeWeights=o),this._filterCondensedBlendShapeWeights(e.blendShapeWeights,o),t.setFloatArray(n._blendShapeWeightsProperty,o),this._modelMesh._primitive.enableVAO=!1,r=a}else t.setFloatArray(n._blendShapeWeightsProperty,e.blendShapeWeights),this._modelMesh._primitive.enableVAO=!0;t.disableMacro(n._blendShapeTextureMacro),t.disableMacro("RENDERER_BLENDSHAPE_COUNT"),this._uniformOccupiesCount=r}this._useBlendNormal?t.enableMacro(n._blendShapeNormalMacro):t.disableMacro(n._blendShapeNormalMacro),this._useBlendTangent?t.enableMacro(n._blendShapeTangentMacro):t.disableMacro(n._blendShapeTangentMacro)}else t.disableMacro(n._blendShapeMacro),t.disableMacro("RENDERER_BLENDSHAPE_COUNT")},s._useTextureMode=function(){return this._canUseTextureStoreData?this._blendShapeCount>this._getVertexBufferModeSupportCount():!1},s._isCreateHost=function(t){var e=this._lastHostCreatedInfo;return e.x!==this._blendShapeCount||!!e.y!==this._useBlendNormal||!!e.z!==this._useBlendTangent||e.w!==t},s._vertexElementsNeedUpdate=function(){var t=this._getVertexBufferModeSupportCount(),e=this._lastHostCreatedInfo;return Math.min(e.x,t)!==Math.min(this._blendShapeCount,t)||!!e.y!==this._useBlendNormal||!!e.z!==this._useBlendTangent},s._needUpdateData=function(){for(var t=this._subDataDirtyFlags,e=0,r=t.length;e<r;e++)if(t[e].flag)return!0;return!1},s._updateVertexBufferIndex=function(){if(this._bufferBindingOffset===-1){for(var t=this._modelMesh,e=t._internalVertexBufferIndex,r=t._primitive.vertexBufferBindings,a=0,o=Math.max(r.length,e+1);a<o&&!(!r[a]&&a!==e);a++);this._bufferBindingOffset=a}},s._addVertexElements=function(t){this._updateVertexBufferIndex();for(var e=this._vertexElementOffset,r=this._bufferBindingOffset,a=0,o=0,c=Math.min(this._blendShapeCount,this._getVertexBufferModeSupportCount());o<c;o++)t._setVertexElement(e++,new Te("POSITION_BS"+o,a,$.Vector3,r)),a+=12,this._useBlendNormal&&(t._setVertexElement(e++,new Te("NORMAL_BS"+o,a,$.Vector3,r)),a+=12),this._useBlendTangent&&(t._setVertexElement(e++,new Te("TANGENT_BS"+o,a,$.Vector3,r)),a+=12);return e},s._update=function(t){var e=this._modelMesh.vertexCount,r=this._useTextureMode(),a=this._isCreateHost(e);a&&(r?this._createTextureArray(e):this._createVertexBuffers(e,t),this._lastHostCreatedInfo.set(this._blendShapeCount,+this._useBlendNormal,+this._useBlendTangent,e)),this._needUpdateData()&&(r?this._updateTextureArray(e,a):this._updateVertexBuffers(e,a))},s._releaseMemoryCache=function(){for(var t=this._blendShapes,e=0,r=t.length;e<r;e++)t[e]._releaseData();this._vertices=null},s._createVertexBuffers=function(t,e){var r=this,a=r._engine,o=r._modelMesh,c=r._blendShapeCount,l=r._vertexBuffers,_=this._vertexElementCount*3,u=_*4,h=Math.floor(255/u),d=Math.ceil(c/h),f=_*t*Math.min(h,c);l.length=d,this._vertices=new Float32Array(f),this._maxCountSingleVertexBuffer=h,this._storeInVertexBufferInfo.length=c;for(var v=this._bufferBindingOffset,p=0;p<d;p++){var g=d-1,y=p===g?c-g*h:h,m=y*u,x=m*t,C=e?Je.Static:Je.Dynamic,b=new Jt(a,Mt.VertexBuffer,x,C);o._setVertexBufferBinding(v+p,new Wn(b,m)),l[p]=b}},s._createTextureArray=function(t){var e=this._engine._hardwareRenderer.capability.maxTextureSize,r=this._vertexElementCount,a=r*t,o=1;a>e&&(o=Math.ceil(a/e),a=e);var c=this._vertexTexture,l=this._blendShapes.length;c&&c.destroy(),c=new Bo(this._engine,a,o,l,G.R32G32B32A32,!1),c.filterMode=tt.Point,this._vertices=new Float32Array(l*a*o*4),this._vertexTexture=c,this._dataTextureInfo.set(r,a,o)},s._updateVertexBuffers=function(t,e){for(var r=this,a=r._blendShapes,o=r._maxCountSingleVertexBuffer,c=this,l=c._vertices,_=c._vertexBuffers,u=c._storeInVertexBufferInfo,h=this._subDataDirtyFlags,d=this._vertexElementCount*3,f=d*4,v=this._bufferBindingOffset,p=0,g=a.length;p<g;p++){var y=h[p];if(e||y.flag){var m=a[p].frames,x=m.length,C=m[x-1];if(x>0&&C.deltaPositions.length!==t)throw"BlendShape frame deltaPositions length must same with mesh vertexCount.";var b=Math.floor(p/o),A=p%o,S=_[b],w=S.byteLength/(t*4),E=A*d,P=u[p];P||(u[p]=P=new ee),P.set(v+b,A*f);for(var M=C.deltaPositions,D=0;D<t;D++){var L=E+w*D,V=M[D];V&&(l[L]=V.x,l[L+1]=V.y,l[L+2]=V.z)}if(E+=3,this._useBlendNormal){var N=C.deltaNormals;if(N)for(var I=0;I<t;I++){var B=E+w*I,z=N[I];z&&(l[B]=z.x,l[B+1]=z.y,l[B+2]=z.z)}E+=3}if(this._useBlendTangent){var U=C.deltaTangents;if(U)for(var Y=0;Y<t;Y++){var Q=E+w*Y,H=U[Y];H&&(l[Q]=H.x,l[Q+1]=H.y,l[Q+2]=H.z)}E+=3}(A===o-1||p===g-1)&&S.setData(l,0,0,S.byteLength/4),y.flag=!1}}},s._updateTextureArray=function(t,e){for(var r=this,a=r._blendShapes,o=r._vertexTexture,c=r._vertices,l=r._subDataDirtyFlags,_=0,u=a.length;_<u;_++){var h=l[_],d=o.width*o.height*4;if(e||h.flag){var f=a[_].frames,v=f.length,p=f[v-1];if(v>0&&p.deltaPositions.length!==t)throw"BlendShape frame deltaPositions length must same with mesh vertexCount.";for(var g=p.deltaPositions,y=p.deltaNormals,m=p.deltaTangents,x=_*d,C=0;C<t;C++){var b=g[C];if(c[x]=b.x,c[x+1]=b.y,c[x+2]=b.z,x+=4,y){var A=y[C];c[x]=A.x,c[x+1]=A.y,c[x+2]=A.z,x+=4}if(m){var S=m[C];c[x]=S.x,c[x+1]=S.y,c[x+2]=S.z,x+=4}}h.flag=!1}}o.setPixelBuffer(0,c)},s._updateLayoutChange=function(t,e){var r=this._blendShapeCount>1,a=1,o=e._useBlendShapeNormal,c=e._useBlendShapeTangent;r&&(o&&(o=this._useBlendNormal),c&&(c=this._useBlendTangent)),o&&a++,c&&a++,this._useBlendNormal=o,this._useBlendTangent=c,this._vertexElementCount=a},s._attributeModeUpdateVertexElement=function(t,e,r,a){var o=this._vertexElementOffset+this._vertexElementCount*a,c=e[r],l=c.x,_=c.y,u=t[o];if(u.bindingIndex=l,u.offset=_,this._useBlendNormal){var h=t[++o];_+=12,h.bindingIndex=l,h.offset=_}if(this._useBlendTangent){var d=t[++o];_+=12,d.bindingIndex=l,d.offset=_}},s._getVertexBufferModeSupportCount=function(){return this._useBlendNormal&&this._useBlendTangent?2:this._useBlendNormal||this._useBlendTangent?4:8},s._filterCondensedBlendShapeWeights=function(t,e){for(var r=e.length,a=this._modelMesh._primitive.vertexElements,o=this._storeInVertexBufferInfo,c=Number.POSITIVE_INFINITY,l,_=0,u=Math.min(t.length,this._blendShapeCount);_<u;_++){var h=t[_];if(_<r)this._attributeModeUpdateVertexElement(a,o,_,_),e[_]=h,h<c&&(c=h,l=_);else if(h>c){this._attributeModeUpdateVertexElement(a,o,_,l),e[l]=h,c=Number.POSITIVE_INFINITY;for(var d=0;d<r;d++){var f=e[d];f<c&&(c=f,l=d)}}}},n}();(function(){Tn._blendShapeMacro=oe.getByName("RENDERER_HAS_BLENDSHAPE")})();(function(){Tn._blendShapeTextureMacro=oe.getByName("RENDERER_BLENDSHAPE_USE_TEXTURE")})();(function(){Tn._blendShapeNormalMacro=oe.getByName("RENDERER_BLENDSHAPE_HAS_NORMAL")})();(function(){Tn._blendShapeTangentMacro=oe.getByName("RENDERER_BLENDSHAPE_HAS_TANGENT")})();(function(){Tn._blendShapeWeightsProperty=O.getByName("renderer_BlendShapeWeights")})();(function(){Tn._blendShapeTextureProperty=O.getByName("renderer_BlendShapeTexture")})();(function(){Tn._blendShapeTextureInfoProperty=O.getByName("renderer_BlendShapeTextureInfo")})();var X;(function(n){n.Position="POSITION",n.Normal="NORMAL",n.Color="COLOR_0",n.Tangent="TANGENT",n.BoneWeight="WEIGHTS_0",n.BoneIndex="JOINTS_0",n.UV="TEXCOORD_0",n.UV1="TEXCOORD_1",n.UV2="TEXCOORD_2",n.UV3="TEXCOORD_3",n.UV4="TEXCOORD_4",n.UV5="TEXCOORD_5",n.UV6="TEXCOORD_6",n.UV7="TEXCOORD_7"})(X||(X={}));var dt=function(n){W(s,n);function s(t,e){var r;return r=n.call(this,t)||this,r._internalVertexBufferIndex=-1,r._vertexCount=0,r._vertexCountDirty=!1,r._dataVersionCounter=0,r._positions=null,r._normals=null,r._colors=null,r._tangents=null,r._uv=null,r._uv1=null,r._uv2=null,r._uv3=null,r._uv4=null,r._uv5=null,r._uv6=null,r._uv7=null,r._boneWeights=null,r._boneIndices=null,r._advancedElementUpdateFlag=0,r._advancedDataUpdateFlag=0,r._advancedVertexDataVersions=new Array(14),r._advancedDataSyncToBuffer=!1,r._internalVertexBufferStride=0,r._internalVertexBufferCreatedInfo=new R(0,0,-1),r._internalVertexElementsOffset=0,r._internalVertexElementsFlags=0,r._vertexBufferInfos=[],r._indices=null,r._indicesFormat=null,r._indicesChangeFlag=!1,r._accessible=!0,r.name=e,r._blendShapeManager=new Tn(t,ce(r)),r}var i=s.prototype;return i.setPositions=function(e){var r;if(!(!this._positions&&!e)){this._updateAdvancedVertexDataMarks(1,0),this._positions=e;var a;this._vertexCount=(a=(r=e)==null?void 0:r.length)!=null?a:0,this._vertexCountDirty=!1}},i.getPositions=function(){var e=this._getVertexElementData(this._positions,X.Position,0,this._readVector3VertexData);return this._positions=e,e},i.setNormals=function(e){this._beforeSetAdvancedVertexData(e,2,1),this._normals=e},i.getNormals=function(){var e=this._getVertexElementData(this._normals,X.Normal,1,this._readVector3VertexData);return this._normals=e,e},i.setColors=function(e){this._beforeSetAdvancedVertexData(e,4,2),this._colors=e},i.getColors=function(){var e=this._getVertexElementData(this._colors,X.Color,2,this._readColorVertexData);return this._colors=e,e},i.setBoneWeights=function(e){this._beforeSetAdvancedVertexData(e,16,4),this._boneWeights=e},i.getBoneWeights=function(){var e=this._getVertexElementData(this._boneWeights,X.BoneWeight,4,this._readVector4VertexData);return this._boneWeights=e,e},i.setBoneIndices=function(e){this._beforeSetAdvancedVertexData(e,32,5),this._boneIndices=e},i.getBoneIndices=function(){var e=this._getVertexElementData(this._boneIndices,X.BoneIndex,5,this._readVector4VertexData);return this._boneIndices=e,e},i.setTangents=function(e){this._beforeSetAdvancedVertexData(e,8,3),this._tangents=e},i.getTangents=function(){var e=this._getVertexElementData(this._tangents,X.Tangent,3,this._readVector4VertexData);return this._tangents=e,e},i.setUVs=function(e,r){switch(r=r??0,r){case 0:this._beforeSetAdvancedVertexData(e,64,6),this._uv=e;break;case 1:this._beforeSetAdvancedVertexData(e,128,7),this._uv1=e;break;case 2:this._beforeSetAdvancedVertexData(e,256,8),this._uv2=e;break;case 3:this._beforeSetAdvancedVertexData(e,512,9),this._uv3=e;break;case 4:this._beforeSetAdvancedVertexData(e,1024,10),this._uv4=e;break;case 5:this._beforeSetAdvancedVertexData(e,2048,11),this._uv5=e;break;case 6:this._beforeSetAdvancedVertexData(e,4096,12),this._uv6=e;break;case 7:this._beforeSetAdvancedVertexData(e,8192,13),this._uv7=e;break;default:throw"The index of channel needs to be in range [0 - 7]."}},i.getUVs=function(e){switch(e=e??0,e){case 0:var r=this._getVertexElementData(this._uv,X.UV,6,this._readVector2VertexData);return this._uv=r,r;case 1:var a=this._getVertexElementData(this._uv1,X.UV1,7,this._readVector2VertexData);return this._uv1=a,a;case 2:var o=this._getVertexElementData(this._uv2,X.UV2,8,this._readVector2VertexData);return this._uv2=o,o;case 3:var c=this._getVertexElementData(this._uv3,X.UV3,9,this._readVector2VertexData);return this._uv3=c,c;case 4:var l=this._getVertexElementData(this._uv4,X.UV4,10,this._readVector2VertexData);return this._uv4=l,l;case 5:var _=this._getVertexElementData(this._uv5,X.UV5,11,this._readVector2VertexData);return this._uv5=_,_;case 6:var u=this._getVertexElementData(this._uv6,X.UV6,12,this._readVector2VertexData);return this._uv6=u,u;case 7:var h=this._getVertexElementData(this._uv7,X.UV7,13,this._readVector2VertexData);return this._uv7=h,h}throw"The index of channel needs to be in range [0 - 7]."},i.setIndices=function(e){this._indices!==e&&(this._indices=e,lt(e,Uint8Array)?this._indicesFormat=St.UInt8:lt(e,Uint16Array)?this._indicesFormat=St.UInt16:lt(e,Uint32Array)&&(this._indicesFormat=St.UInt32)),this._indicesChangeFlag=!0},i.getIndices=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._indices},i.setVertexElements=function(e){this._clearVertexElements();for(var r=e.length,a=0;a<r;a++)this._addVertexElement(e[a]);var o=this._primitive._vertexElementMap;o[X.Position]||this.setPositions(null),o[X.Normal]||this.setNormals(null),o[X.Color]||this.setColors(null),o[X.BoneWeight]||this.setBoneWeights(null),o[X.BoneIndex]||this.setBoneIndices(null),o[X.Tangent]||this.setTangents(null),o[X.UV]||this.setUVs(null,0),o[X.UV1]||this.setUVs(null,1),o[X.UV2]||this.setUVs(null,2),o[X.UV3]||this.setUVs(null,3),o[X.UV4]||this.setUVs(null,4),o[X.UV5]||this.setUVs(null,5),o[X.UV6]||this.setUVs(null,6),o[X.UV7]||this.setUVs(null,7);var c=this._internalVertexBufferCreatedInfo.z;if(c!==-1){var l;(l=this._primitive.vertexBufferBindings[c])==null||l.buffer.destroy(),this._setVertexBufferBinding(c,null),this._internalVertexBufferCreatedInfo.z=-1}this._internalVertexBufferStride=0,this._internalVertexElementsOffset=r,this._advancedElementUpdateFlag=0,this._vertexCountDirty=!0,this._blendShapeManager._bufferBindingOffset=-1,this._blendShapeManager._vertexElementOffset=r},i.setVertexBufferBinding=function(e,r,a){r===void 0&&(r=0),a===void 0&&(a=0);var o=e,c=o.buffer!==void 0;c||(o=new Wn(e,r));var l=c?r:a,_=this._primitive.vertexBufferBindings,u=this._vertexBufferInfos,h=l+1;_.length<h&&(_.length=h,u.length=h),this._setVertexBufferBinding(l,o),l===this._internalVertexBufferIndex&&(this._internalVertexBufferIndex=-1),l===this._blendShapeManager._bufferBindingOffset&&(this._blendShapeManager._bufferBindingOffset=-1),this._vertexCountDirty=!0},i.setVertexBufferBindings=function(e,r){r===void 0&&(r=0);var a=e.length,o=this._primitive.vertexBufferBindings,c=this._vertexBufferInfos,l=r+a;o.length<l&&(o.length=l,c.length=l);for(var _=0;_<a;_++){var u=r+_;this._setVertexBufferBinding(u,e[_]),u===this._internalVertexBufferIndex&&(this._internalVertexBufferIndex=-1),u===this._blendShapeManager._bufferBindingOffset&&(this._blendShapeManager._bufferBindingOffset=-1)}this._vertexCountDirty=!0},i.getVertexElement=function(e){return this._updateVertexElements(),this._primitive._vertexElementMap[e]},i.addBlendShape=function(e){this._blendShapeManager._addBlendShape(e)},i.clearBlendShapes=function(){this._blendShapeManager._clearBlendShapes()},i.getBlendShapeName=function(e){var r=this._blendShapeManager._blendShapes;return r[e].name},i.uploadData=function(e){if(this._updateVertexElements(),this._advancedDataSyncToBuffer=!0,this._updateInternalVertexBuffer(e),this._advancedDataUpdateFlag&65535){this._updateAdvancedVertices();for(var r=this._vertexBufferInfos,a=this._primitive.vertexBufferBindings,o=0,c=a.length;o<c;o++){var l,_=r[o];if((l=_)!=null&&l.uploadAdvancedData){var u,h=(u=a[o])==null?void 0:u.buffer;h.setData(h.data),_.uploadAdvancedData=!1}}}if(this._advancedDataSyncToBuffer=!1,this._indicesChangeFlag){var d,f=this,v=f._indices,p=(d=this._primitive.indexBufferBinding)==null?void 0:d._buffer;if(v)if(!p||v.byteLength!=p.byteLength){var g;(g=p)==null||g.destroy();var y=new Jt(this._engine,Mt.IndexBuffer,v);this._setIndexBufferBinding(new Pa(y,this._indicesFormat))}else p.setData(v),this._primitive.indexBufferBinding._format!==this._indicesFormat&&this._setIndexBufferBinding(new Pa(p,this._indicesFormat));else p&&(p.destroy(),this._setIndexBufferBinding(null));this._indicesChangeFlag=!1}var m=this._blendShapeManager;m._blendShapeCount>0&&m._update(e),e&&(this._accessible=!1,this._releaseCache(!1))},i.calculateTangents=function(){var e=this.getPositions(),r=this.getNormals(),a=this.getUVs();if(!r||!a)throw"Set normal and uv before calculation.";for(var o=this,c=o._indices,l=o.vertexCount,_=s._tempVec0,u=s._tempVec1,h=s._tempVec2,d=s._tempVec3,f=s._tempVec4,v=c?c.length/3:e.length/3,p=new Array(l),g=new Array(l),y=0;y<l;y++)p[y]=new ie,g[y]=new R;for(var m=0;m<v;m++){var x=3*m,C=3*m+1,b=3*m+2;c&&(x=c[x],C=c[C],b=c[b]);var A=e[x],S=e[C],w=e[b],E=a[x],P=a[C],M=a[b];R.subtract(S,A,_),R.subtract(w,A,u);var D=P.x-E.x,L=M.x-E.x,V=P.y-E.y,N=M.y-E.y,I=1/(D*N-L*V);R.scale(_,N*I,h),R.scale(u,V*I,f),R.subtract(h,f,h),R.scale(u,D*I,d),R.scale(_,L*I,f),R.subtract(d,f,d);var B=p[x];B.set(B.x+h.x,B.y+h.y,B.z+h.z,1),B=p[C],B.set(B.x+h.x,B.y+h.y,B.z+h.z,1),B=p[b],B.set(B.x+h.x,B.y+h.y,B.z+h.z,1),g[x].add(d),g[C].add(d),g[b].add(d)}for(var z=0;z<l;z++){var U=r[z],Y=g[z],Q=p[z];h.set(Q.x,Q.y,Q.z),R.cross(h,Y,f);var H=R.dot(f,U)>0?1:-1;R.scale(U,R.dot(h,U),f),R.subtract(h,f,h),h.normalize(),Q.set(h.x,h.y,h.z,H)}this.setTangents(p)},i._setVertexBufferBinding=function(e,r){var a=this,o=this._primitive.vertexBufferBindings,c=this._vertexBufferInfos,l=function(){a._advancedDataSyncToBuffer||(c[e].dataVersion=a._dataVersionCounter++)},_=o[e];if(_&&_.buffer._dataUpdateManager.removeListener(l),n.prototype._setVertexBufferBinding.call(this,e,r),r){var u,h;r.buffer._dataUpdateManager.addListener(l),((u=c)[h=e]||(u[h]=new D_)).reset(),l()}else e+1==o.length&&o.length--},i._getVertexTypedArray=function(e,r){switch(r){case Ie.BYTE:return new Int8Array(e);case Ie.UNSIGNED_BYTE:return new Uint8Array(e);case Ie.SHORT:return new Int16Array(e);case Ie.UNSIGNED_SHORT:return new Uint16Array(e);case Ie.FLOAT:return new Float32Array(e)}},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._releaseCache(!0)},i._getVertexElementData=function(e,r,a,o){var c=this._advancedVertexDataVersions,l,_=(l=c[a])!=null?l:-1,u=this._primitive._vertexElementMap[r],h=u?this._vertexBufferInfos[u.bindingIndex].dataVersion:-1;return _>=h?e:(c[a]=h,o.call(this,r))},i._beforeSetAdvancedVertexData=function(e,r,a){if(e&&e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._updateAdvancedVertexDataMarks(r,a)},i._updateAdvancedVertexDataMarks=function(e,r){this._advancedElementUpdateFlag|=e,this._advancedDataUpdateFlag|=e,this._advancedVertexDataVersions[r]=this._dataVersionCounter++},i._updateInternalVertexBuffer=function(e){var r=this._internalVertexBufferStride,a=this.vertexCount,o=this._internalVertexBufferCreatedInfo,c=r*a;if(o.x*o.y!==c){var l=o.z;if(l!==-1){var _;(_=this._primitive.vertexBufferBindings[l])==null||_.buffer.destroy(),this._setVertexBufferBinding(l,null)}var u=this._internalVertexBufferIndex,h=r*this.vertexCount>0;if(h){this._advancedDataUpdateFlag|=this._internalVertexElementsFlags;var d=e?Je.Static:Je.Dynamic,f=new Jt(this._engine,Mt.VertexBuffer,c,d,!0);this._setVertexBufferBinding(u,new Wn(f,r))}o.set(r,a,h?u:-1)}},i._readVector2VertexData=function(e){return this._readVertexData(e,function(r,a){return new ee(r[a],r[a+1])})},i._readVector3VertexData=function(e){return this._readVertexData(e,function(r,a){return new R(r[a],r[a+1],r[a+2])})},i._readVector4VertexData=function(e){return this._readVertexData(e,function(r,a){return new ie(r[a],r[a+1],r[a+2],r[a+3])})},i._readColorVertexData=function(e){return this._readVertexData(e,function(r,a){return new q(r[a],r[a+1],r[a+2],r[a+3])})},i._readVertexData=function(e,r){var a,o=this._primitive,c=o._vertexElementMap[e];if(!c)return null;var l=o.vertexBufferBindings[c.bindingIndex],_=(a=l)==null?void 0:a.buffer;if(!_)return null;if(!_.readable)throw"Not allowed to access data while vertex buffer readable is false.";for(var u=this.vertexCount,h=c._formatMetaInfo,d=new Array(u),f=this._getVertexTypedArray(_.data.buffer,h.type),v=c.offset,p=l.stride,g=0;g<u;g++){var y=(g*p+v)/f.BYTES_PER_ELEMENT,m=r(f,y);h.normalized&&m.scale(h.normalizedScaleFactor),d[g]=m}return d},i._updateAdvancedVertexElement=function(e,r,a){var o=this._primitive,c=o._vertexElementMap;if(e){if(!c[r]){var l=this._getAttributeFormat(r),_=this._internalVertexBufferStride,u=this._getInternalVertexBufferIndex();this._addVertexElement(new Te(r,_,l,u)),this._internalVertexBufferStride+=this._getAttributeByteLength(r),this._internalVertexElementsFlags|=a,this._blendShapeManager._vertexElementOffset++}}else{var h=c[r];if(h){var d=this._primitive.vertexElements.indexOf(h);d>=this._internalVertexElementsOffset?(this._internalVertexBufferStride-=this._getAttributeByteLength(r),this._internalVertexElementsFlags&=~a):this._internalVertexElementsOffset--,this._blendShapeManager._vertexElementOffset--,this._removeVertexElement(d)}}},i._updateAdvancedVertexElements=function(){var e=this._advancedElementUpdateFlag;e&1&&this._updateAdvancedVertexElement(this._positions,X.Position,1),e&2&&this._updateAdvancedVertexElement(this._normals,X.Normal,2),e&4&&this._updateAdvancedVertexElement(this._colors,X.Color,4),e&16&&this._updateAdvancedVertexElement(this._boneWeights,X.BoneWeight,16),e&32&&this._updateAdvancedVertexElement(this._boneIndices,X.BoneIndex,32),e&8&&this._updateAdvancedVertexElement(this._tangents,X.Tangent,8),e&64&&this._updateAdvancedVertexElement(this._uv,X.UV,64),e&128&&this._updateAdvancedVertexElement(this._uv1,X.UV1,128),e&256&&this._updateAdvancedVertexElement(this._uv2,X.UV2,256),e&512&&this._updateAdvancedVertexElement(this._uv3,X.UV3,512),e&1024&&this._updateAdvancedVertexElement(this._uv4,X.UV4,1024),e&2048&&this._updateAdvancedVertexElement(this._uv5,X.UV5,2048),e&4096&&this._updateAdvancedVertexElement(this._uv6,X.UV6,4096),e&8192&&this._updateAdvancedVertexElement(this._uv7,X.UV7,8192)},i._updateVertexElements=function(){var e=this._primitive.vertexElements,r=this._blendShapeManager,a=e.length,o=r._vertexElementOffset;this._advancedElementUpdateFlag&65535&&(this._updateAdvancedVertexElements(),this._advancedElementUpdateFlag=0);var c=!r._useTextureMode()&&r._vertexElementsNeedUpdate();if(o!==r._vertexElementOffset||c&&r._blendShapeCount>0){var l=r._addVertexElements(this);l<a&&this._setVertexElementsLength(l)}},i._writeVector2AdvancedVertexData=function(e,r,a){this._writeAdvancedVertexData(e,r,function(o,c,l){var _=a[l];_&&(o[c]=_.x,o[c+1]=_.y)})},i._writeVector3AdvancedVertexData=function(e,r,a){this._writeAdvancedVertexData(e,r,function(o,c,l){var _=a[l];_&&(o[c]=_.x,o[c+1]=_.y,o[c+2]=_.z)})},i._writeVector4AdvancedVertexData=function(e,r,a){this._writeAdvancedVertexData(e,r,function(o,c,l){var _=a[l];_&&(o[c]=_.x,o[c+1]=_.y,o[c+2]=_.z,o[c+3]=_.w)})},i._writeColorAdvancedVertexData=function(e,r,a){this._writeAdvancedVertexData(e,r,function(o,c,l){var _=a[l];_&&(o[c]=_.r,o[c+1]=_.g,o[c+2]=_.b,o[c+3]=_.a)})},i._writeAdvancedVertexData=function(e,r,a){var o,c=this._primitive,l=c._vertexElementMap[e],_=l.bindingIndex,u=c.vertexBufferBindings[_],h=(o=u)==null?void 0:o.buffer;if(h){if(!h.readable)throw"Vertex buffer is not readable, can't write vertex data.";var d,f=(d=this._advancedVertexDataVersions[r])!=null?d:-1,v=this._vertexBufferInfos[_];if(f>v.dataVersion){for(var p=l._formatMetaInfo,g=this._getVertexTypedArray(h.data.buffer,p.type),y=l.offset,m=u.stride,x=g.BYTES_PER_ELEMENT,C=p.normalized,b=p.size,A=p.normalizedScaleFactor,S=0,w=this._vertexCount;S<w;S++){var E=(S*m+y)/x;if(a(g,E,S),C)for(var P=0;P<b;P++)g[E+P]/=A}v.uploadAdvancedData=!0}}},i._updateAdvancedVertices=function(){var e=this,r=e._positions,a=e._normals,o=e._colors,c=e._advancedDataUpdateFlag,l=e._boneWeights,_=e._boneIndices,u=e._tangents,h=e._uv,d=e._uv1,f=e._uv2,v=e._uv3,p=e._uv4,g=e._uv5,y=e._uv6,m=e._uv7;c&1&&this._writeVector3AdvancedVertexData(X.Position,0,r),a&&c&2&&this._writeVector3AdvancedVertexData(X.Normal,1,a),o&&c&4&&this._writeColorAdvancedVertexData(X.Color,2,o),l&&c&16&&this._writeVector4AdvancedVertexData(X.BoneWeight,4,l),_&&c&32&&this._writeVector4AdvancedVertexData(X.BoneIndex,5,_),u&&c&8&&this._writeVector4AdvancedVertexData(X.Tangent,3,u),h&&c&64&&this._writeVector2AdvancedVertexData(X.UV,6,h),d&&c&128&&this._writeVector2AdvancedVertexData(X.UV1,7,d),f&&c&256&&this._writeVector2AdvancedVertexData(X.UV2,8,f),v&&c&512&&this._writeVector2AdvancedVertexData(X.UV3,9,v),p&&c&1024&&this._writeVector2AdvancedVertexData(X.UV4,10,p),g&&c&2048&&this._writeVector2AdvancedVertexData(X.UV5,11,g),y&&c&4096&&this._writeVector2AdvancedVertexData(X.UV6,12,y),m&&c&8192&&this._writeVector2AdvancedVertexData(X.UV7,13,m),this._advancedDataUpdateFlag=0},i._getInternalVertexBufferIndex=function(){var e=this._internalVertexBufferIndex;if(e!==-1)return e;for(var r=0,a=this._primitive.vertexBufferBindings,o=a.length;r<o&&a[r];r++);return this._internalVertexBufferIndex=r,r},i._getAttributeFormat=function(e){switch(e){case X.Position:case X.Normal:return $.Vector3;case X.Color:case X.BoneWeight:case X.Tangent:return $.Vector4;case X.BoneIndex:return $.UByte4;case X.UV:case X.UV1:case X.UV2:case X.UV3:case X.UV4:case X.UV5:case X.UV6:case X.UV7:return $.Vector2}},i._getAttributeByteLength=function(e){switch(e){case X.Position:case X.Normal:return 12;case X.Color:case X.BoneWeight:case X.Tangent:return 16;case X.BoneIndex:return 4;case X.UV:case X.UV1:case X.UV2:case X.UV3:case X.UV4:case X.UV5:case X.UV6:case X.UV7:return 8}},i._releaseCache=function(e){if(this._positions=null,this._tangents=null,this._normals=null,this._colors=null,this._boneIndices=null,this._boneWeights=null,this._uv=null,this._uv1=null,this._uv2=null,this._uv3=null,this._uv4=null,this._uv5=null,this._uv6=null,this._uv7=null,this._indices=null,this._blendShapeManager._releaseMemoryCache(),!e){var r;(r=this._primitive.vertexBufferBindings[this._internalVertexBufferIndex])==null||r.buffer.markAsUnreadable();for(var a=this._dataVersionCounter++,o=this._vertexBufferInfos,c=0,l=o.length;c<l;c++){var _=o[c];_&&(_.dataVersion=a)}}},j(s,[{key:"vertexCount",get:function(){if(this._vertexCountDirty){var e=0,r=this._primitive._vertexElementMap[X.Position];if(r){var a=this._primitive.vertexBufferBindings[r.bindingIndex];a&&(e=a.buffer.byteLength/a.stride)}this._vertexCount=e,this._vertexCountDirty=!1}return this._vertexCount}},{key:"vertexElements",get:function(){return this._updateVertexElements(),this._primitive.vertexElements}},{key:"vertexBufferBindings",get:function(){return this._primitive.vertexBufferBindings}},{key:"blendShapes",get:function(){return this._blendShapeManager._blendShapes}},{key:"blendShapeCount",get:function(){return this._blendShapeManager._blendShapeCount}},{key:"accessible",get:function(){return this._accessible}}]),s}(Ro);(function(){dt._tempVec0=new R})();(function(){dt._tempVec1=new R})();(function(){dt._tempVec2=new R})();(function(){dt._tempVec3=new R})();(function(){dt._tempVec4=new R})();var D_=function(){function n(){this.dataVersion=-1,this.uploadAdvancedData=!1}var s=n.prototype;return s.reset=function(){this.uploadAdvancedData=!1},n}(),Ko;(function(n){n[n.None=0]="None",n[n.Position=1]="Position",n[n.Normal=2]="Normal",n[n.Color=4]="Color",n[n.Tangent=8]="Tangent",n[n.BoneWeight=16]="BoneWeight",n[n.BoneIndex=32]="BoneIndex",n[n.UV=64]="UV",n[n.UV1=128]="UV1",n[n.UV2=256]="UV2",n[n.UV3=512]="UV3",n[n.UV4=1024]="UV4",n[n.UV5=2048]="UV5",n[n.UV6=4096]="UV6",n[n.UV7=8192]="UV7",n[n.All=65535]="All"})(Ko||(Ko={}));var Jo;(function(n){n[n.Position=0]="Position",n[n.Normal=1]="Normal",n[n.Color=2]="Color",n[n.Tangent=3]="Tangent",n[n.BoneWeight=4]="BoneWeight",n[n.BoneIndex=5]="BoneIndex",n[n.UV=6]="UV",n[n.UV1=7]="UV1",n[n.UV2=8]="UV2",n[n.UV3=9]="UV3",n[n.UV4=10]="UV4",n[n.UV5=11]="UV5",n[n.UV6=12]="UV6",n[n.UV7=13]="UV7"})(Jo||(Jo={}));var br=function(s){this.resource=s},mn=function(n){W(s,n);function s(t,e){var r;return r=n.call(this,t)||this,r.primitiveInfo=e,r}var i=s.prototype;return i.restoreContent=function(){var e=this.primitiveInfo;switch(e.type){case 0:var r=e;at._setSphereData(this.resource,r.radius,r.segments,r.noLongerAccessible,!0,r.vertexBuffer);break;case 7:var a=e;at._setSubdivisionSurfaceSphereData(this.resource,a.radius,a.step,a.noLongerAccessible,!0,a.vertexBuffer);break;case 1:var o=e;at._setCuboidData(this.resource,o.width,o.height,o.depth,o.noLongerAccessible,!0,o.vertexBuffer);break;case 2:var c=e;at._setPlaneData(this.resource,c.width,c.height,c.horizontalSegments,c.verticalSegments,c.noLongerAccessible,!0,c.vertexBuffer);break;case 3:var l=e;at._setCylinderData(this.resource,l.radiusTop,l.radiusBottom,l.height,l.radialSegments,l.heightSegments,l.noLongerAccessible,!0,l.vertexBuffer);break;case 4:var _=e;at._setTorusData(this.resource,_.radius,_.tubeRadius,_.radialSegments,_.tubularSegments,_.arc,_.noLongerAccessible,!0,_.vertexBuffer);break;case 5:var u=e;at._setConeData(this.resource,u.radius,u.height,u.radialSegments,u.heightSegments,u.noLongerAccessible,!0,u.vertexBuffer);break;case 6:var h=e;at._setCapsuleData(this.resource,h.radius,h.height,h.radialSegments,h.heightSegments,h.noLongerAccessible,!0,h.vertexBuffer);break}},s}(br),Zo;(function(n){n[n.Sphere=0]="Sphere",n[n.Cuboid=1]="Cuboid",n[n.Plane=2]="Plane",n[n.Cylinder=3]="Cylinder",n[n.Torus=4]="Torus",n[n.Cone=5]="Cone",n[n.Capsule=6]="Capsule",n[n.CCSphere=7]="CCSphere"})(Zo||(Zo={}));var Rn=function(s,i,t){this.type=s,this.vertexBuffer=i,this.noLongerAccessible=t},L_=function(n){W(s,n);function s(i,t,e,r){var a;return a=n.call(this,0,e,r)||this,a.radius=i,a.segments=t,a}return s}(Rn),V_=function(n){W(s,n);function s(i,t,e,r){var a;return a=n.call(this,7,e,r)||this,a.radius=i,a.step=t,a}return s}(Rn),F_=function(n){W(s,n);function s(i,t,e,r,a){var o;return o=n.call(this,1,r,a)||this,o.width=i,o.height=t,o.depth=e,o}return s}(Rn),N_=function(n){W(s,n);function s(i,t,e,r,a,o){var c;return c=n.call(this,2,a,o)||this,c.width=i,c.height=t,c.horizontalSegments=e,c.verticalSegments=r,c}return s}(Rn),I_=function(n){W(s,n);function s(i,t,e,r,a,o,c){var l;return l=n.call(this,3,o,c)||this,l.radiusTop=i,l.radiusBottom=t,l.height=e,l.radialSegments=r,l.heightSegments=a,l}return s}(Rn),O_=function(n){W(s,n);function s(i,t,e,r,a,o,c){var l;return l=n.call(this,4,o,c)||this,l.radius=i,l.tubeRadius=t,l.radialSegments=e,l.tubularSegments=r,l.arc=a,l}return s}(Rn),z_=function(n){W(s,n);function s(i,t,e,r,a,o){var c;return c=n.call(this,5,a,o)||this,c.radius=i,c.height=t,c.radialSegments=e,c.heightSegments=r,c}return s}(Rn),U_=function(n){W(s,n);function s(i,t,e,r,a,o){var c;return c=n.call(this,6,a,o)||this,c.radius=i,c.height=t,c.radialSegments=e,c.heightSegments=r,c}return s}(Rn),at=function(){function n(){}return n.createSphere=function(i,t,e,r){t===void 0&&(t=.5),e===void 0&&(e=18),r===void 0&&(r=!0);var a=new dt(i);n._setSphereData(a,t,e,r,!1);var o=a.vertexBufferBindings[0].buffer;return i.resourceManager.addContentRestorer(new mn(a,new L_(t,e,o,r))),a},n.createSubdivisionSurfaceSphere=function(i,t,e,r){t===void 0&&(t=.5),e===void 0&&(e=3),r===void 0&&(r=!0);var a=new dt(i);n._setSubdivisionSurfaceSphereData(a,t,e,r,!1);var o=a.vertexBufferBindings[0].buffer;return i.resourceManager.addContentRestorer(new mn(a,new V_(t,e,o,r))),a},n.createCuboid=function(i,t,e,r,a){t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),a===void 0&&(a=!0);var o=new dt(i);n._setCuboidData(o,t,e,r,a,!1);var c=o.vertexBufferBindings[0].buffer;return i.resourceManager.addContentRestorer(new mn(o,new F_(t,e,r,c,a))),o},n.createPlane=function(i,t,e,r,a,o){t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),a===void 0&&(a=1),o===void 0&&(o=!0);var c=new dt(i);n._setPlaneData(c,t,e,r,a,o,!1);var l=c.vertexBufferBindings[0].buffer;return i.resourceManager.addContentRestorer(new mn(c,new N_(t,e,r,a,l,o))),c},n.createCylinder=function(i,t,e,r,a,o,c){t===void 0&&(t=.5),e===void 0&&(e=.5),r===void 0&&(r=2),a===void 0&&(a=20),o===void 0&&(o=1),c===void 0&&(c=!0);var l=new dt(i);n._setCylinderData(l,t,e,r,a,o,c,!1);var _=l.vertexBufferBindings[0].buffer;return i.resourceManager.addContentRestorer(new mn(l,new I_(t,e,r,a,o,_,c))),l},n.createTorus=function(i,t,e,r,a,o,c){t===void 0&&(t=.5),e===void 0&&(e=.1),r===void 0&&(r=30),a===void 0&&(a=30),o===void 0&&(o=360),c===void 0&&(c=!0);var l=new dt(i);n._setTorusData(l,t,e,r,a,o,c,!1);var _=l.vertexBufferBindings[0].buffer;return i.resourceManager.addContentRestorer(new mn(l,new O_(t,e,r,a,o,_,c))),l},n.createCone=function(i,t,e,r,a,o){t===void 0&&(t=.5),e===void 0&&(e=2),r===void 0&&(r=20),a===void 0&&(a=1),o===void 0&&(o=!0);var c=new dt(i);n._setConeData(c,t,e,r,a,o,!1);var l=c.vertexBufferBindings[0].buffer;return i.resourceManager.addContentRestorer(new mn(c,new z_(t,e,r,a,l,o))),c},n.createCapsule=function(i,t,e,r,a,o){t===void 0&&(t=.5),e===void 0&&(e=2),r===void 0&&(r=6),a===void 0&&(a=1),o===void 0&&(o=!0);var c=new dt(i);n._setCapsuleData(c,t,e,r,a,o,!1);var l=c.vertexBufferBindings[0].buffer;return i.resourceManager.addContentRestorer(new mn(c,new U_(t,e,r,a,l,o))),c},n._setSubdivisionSurfaceSphereData=function(i,t,e,r,a,o){e=k.clamp(Math.floor(e),1,6);var c=new Float32Array(3*(6*Math.pow(4,e)+2)),l=new Float32Array(24*Math.pow(4,e));n._subdiveCatmullClark(e,c,l);for(var _=c.length/3,u=l.length/4,h=_+Math.pow(2,e+1)-1,d=h+16,f=new Float32Array(d*8),v=n._generateIndices(i.engine,_,u*6),p=0,g={},y=0;y<_;y++){var m=3*y,x=c[m],C=c[m+1],b=c[m+2],A=1/Math.sqrt(x*x+C*C+b*b);if(x*=A,C*=A,b*=A,m=8*y,f[m]=x*t,f[m+1]=C*t,f[m+2]=b*t,f[m+3]=x,f[m+4]=C,f[m+5]=b,f[m+6]=(Math.PI-Math.atan2(b,x))/(2*Math.PI),f[m+7]=Math.acos(C)/Math.PI,f[m+6]===0){var S=8*(_+p++);f.set(f.subarray(m,m+8),S),f[S+6]=1,g[m/8]=S/8}}var w=0;this._spherePoleIdx=0;for(var E=0;E<u;E++){var P=4*E,M=l[P],D=l[P+1],L=l[P+2],V=l[P+3],N=8*M,I=8*D,B=8*L,z=8*V;f[N+2]+f[I+2]+f[B+2]<0&&(f[N+6]===0&&(M=g[M]),f[I+6]===0&&(D=g[D]),f[B+6]===0&&(L=g[L]),f[z+6]===0&&(V=g[V])),v[w]=M,v[w+1]=D,v[w+2]=L,this._generateAndReplacePoleUV(v,f,w,h),v[w+3]=M,v[w+4]=L,v[w+5]=V,this._generateAndReplacePoleUV(v,f,w+3,h),w+=6}if(!a){var U=i.bounds;U.min.set(-t,-t,-t),U.max.set(t,t,t)}n._initialize(i,f,v,r,a,o)},n._setSphereData=function(i,t,e,r,a,o){e=Math.max(2,Math.floor(e));for(var c=e+1,l=c*c,_=e*e,u=n._generateIndices(i.engine,l,_*6),h=Math.PI,d=h*2,f=1/c,v=1/e,p=8,g=new Float32Array(l*p),y=0;y<l;++y){var m=y%c,x=y*f|0,C=m*v,b=x*v,A=C*d,S=b*h,w=Math.sin(S),E=-t*Math.cos(A)*w,P=t*Math.cos(S),M=t*Math.sin(A)*w,D=y*p;g[D++]=E,g[D++]=P,g[D++]=M,g[D++]=E,g[D++]=P,g[D++]=M,g[D++]=C,g[D++]=b}for(var L=0,V=0;V<_;++V){var N=V%e,I=V*v|0,B=I*c+N,z=B+1,U=B+c,Y=U+1;u[L++]=z,u[L++]=B,u[L++]=Y,u[L++]=B,u[L++]=U,u[L++]=Y}if(!a){var Q=i.bounds;Q.min.set(-t,-t,-t),Q.max.set(t,t,t)}n._initialize(i,g,u,r,a,o)},n._subdiveCatmullClark=function(i,t,e){var r=new Map,a=new Array;t.set(n._sphereSeedPositions),e.set(n._sphereSeedCells);for(var o=0;o<i;o++){var c=6*Math.pow(4,o),l=4*c+2;r.clear(),a.length=0;for(var _=0;_<c;_++){for(var u=a[_]={facePoint:new R,adjacentEdges:new Array(4)},h=0;h<4;h++){var d=3*e[4*_+h];u.facePoint.x+=.25*t[d],u.facePoint.y+=.25*t[d+1],u.facePoint.z+=.25*t[d+2]}for(var f=0;f<4;f++){var v=e[4*_+f],p=e[4*_+(f+1)%4],g=Math.min(v,p)*l+Math.max(v,p);if(!r.has(g)){var y={edgePoint:new R,edgePointIndex:void 0},m=3*v,x=3*p;y.edgePoint.set(.25*(t[m]+t[x]),.25*(t[m+1]+t[x+1]),.25*(t[m+2]+t[x+2])),r.set(g,y)}var C=r.get(g);u.adjacentEdges[f]=C;var b=C.edgePoint,A=u.facePoint;b.x+=.25*A.x,b.y+=.25*A.y,b.z+=.25*A.z}}var S=c+2,w=S+c,E=0;this._sphereEdgeIdx=0;for(var P=e.slice(0,4*c),M=0;M<c;M++){var D=a[M];D.facePoint.copyToArray(t,3*(S+M));for(var L=S+M,V=void 0,N=void 0,I=void 0,B=0;B<4;B++){var z=P[E++];switch(B){case 0:{var U=D.adjacentEdges[B%4],Y=D.adjacentEdges[(B+3)%4];N=this._calculateEdgeIndex(t,U,w),V=this._calculateEdgeIndex(t,Y,w),I=V;break}case 1:case 2:{var Q=D.adjacentEdges[B%4];V=N,N=this._calculateEdgeIndex(t,Q,w);break}case 3:{V=N,N=I;break}}var H=4*(4*M+B);e[H]=z,e[H+1]=N,e[H+2]=L,e[H+3]=V}}}},n._generateAndReplacePoleUV=function(i,t,e,r){var a=t[8*i[e]+7];if(a===0||a===1){var o=8*i[e],c=8*(r+this._spherePoleIdx);t.set(t.subarray(o,o+8),c),t[c+6]=.5*(t[o+6]+t[8*i[e+1]+6]+t[8*i[e+2]+6]-.5),i[e]=r+this._spherePoleIdx++}},n._calculateEdgeIndex=function(i,t,e){if(t.edgePointIndex!==void 0)return t.edgePointIndex;t.edgePoint.copyToArray(i,3*(e+n._sphereEdgeIdx));var r=e+n._sphereEdgeIdx++;return t.edgePointIndex=r,r},n._setCuboidData=function(i,t,e,r,a,o,c){var l=t/2,_=e/2,u=r/2,h=8,d=new Float32Array(24*h);d[0]=-l,d[1]=_,d[2]=-u,d[6]=0,d[7]=0,d[8]=l,d[9]=_,d[10]=-u,d[14]=1,d[15]=0,d[16]=l,d[17]=_,d[18]=u,d[22]=1,d[23]=1,d[24]=-l,d[25]=_,d[26]=u,d[30]=0,d[31]=1;for(var f=0;f<4;f++){var v=h*f+3;d[v++]=0,d[v++]=1,d[v++]=0}d[32]=-l,d[33]=-_,d[34]=-u,d[38]=0,d[39]=1,d[40]=l,d[41]=-_,d[42]=-u,d[46]=1,d[47]=1,d[48]=l,d[49]=-_,d[50]=u,d[54]=1,d[55]=0,d[56]=-l,d[57]=-_,d[58]=u,d[62]=0,d[63]=0;for(var p=0;p<4;p++){var g=h*p+35;d[g++]=0,d[g++]=-1,d[g++]=0}d[64]=-l,d[65]=_,d[66]=-u,d[70]=0,d[71]=0,d[72]=-l,d[73]=_,d[74]=u,d[78]=1,d[79]=0,d[80]=-l,d[81]=-_,d[82]=u,d[86]=1,d[87]=1,d[88]=-l,d[89]=-_,d[90]=-u,d[94]=0,d[95]=1;for(var y=0;y<4;y++){var m=h*y+67;d[m++]=-1,d[m++]=0,d[m++]=0}d[96]=l,d[97]=_,d[98]=-u,d[102]=1,d[103]=0,d[104]=l,d[105]=_,d[106]=u,d[110]=0,d[111]=0,d[112]=l,d[113]=-_,d[114]=u,d[118]=0,d[119]=1,d[120]=l,d[121]=-_,d[122]=-u,d[126]=1,d[127]=1;for(var x=0;x<4;x++){var C=h*x+99;d[C++]=1,d[C++]=0,d[C++]=0}d[128]=-l,d[129]=_,d[130]=u,d[134]=0,d[135]=0,d[136]=l,d[137]=_,d[138]=u,d[142]=1,d[143]=0,d[144]=l,d[145]=-_,d[146]=u,d[150]=1,d[151]=1,d[152]=-l,d[153]=-_,d[154]=u,d[158]=0,d[159]=1;for(var b=0;b<4;b++){var A=h*b+131;d[A++]=0,d[A++]=0,d[A++]=1}d[160]=-l,d[161]=_,d[162]=-u,d[166]=1,d[167]=0,d[168]=l,d[169]=_,d[170]=-u,d[174]=0,d[175]=0,d[176]=l,d[177]=-_,d[178]=-u,d[182]=0,d[183]=1,d[184]=-l,d[185]=-_,d[186]=-u,d[190]=1,d[191]=1;for(var S=0;S<4;S++){var w=h*S+163;d[w++]=0,d[w++]=0,d[w++]=-1}var E=new Uint16Array(36);if(E[0]=0,E[1]=2,E[2]=1,E[3]=2,E[4]=0,E[5]=3,E[6]=4,E[7]=6,E[8]=7,E[9]=6,E[10]=4,E[11]=5,E[12]=8,E[13]=10,E[14]=9,E[15]=10,E[16]=8,E[17]=11,E[18]=12,E[19]=14,E[20]=15,E[21]=14,E[22]=12,E[23]=13,E[24]=16,E[25]=18,E[26]=17,E[27]=18,E[28]=16,E[29]=19,E[30]=20,E[31]=22,E[32]=23,E[33]=22,E[34]=20,E[35]=21,!o){var P=i.bounds;P.min.set(-l,-_,-u),P.max.set(l,_,u)}n._initialize(i,d,E,a,o,c)},n._setPlaneData=function(i,t,e,r,a,o,c,l){r=Math.max(1,Math.floor(r)),a=Math.max(1,Math.floor(a));for(var _=r+1,u=a+1,h=t/2,d=e/2,f=t/r,v=e/a,p=_*u,g=a*r,y=n._generateIndices(i.engine,p,g*6),m=1/_,x=1/r,C=1/a,b=8,A=new Float32Array(p*b),S=0;S<p;++S){var w=S%_,E=S*m|0,P=S*b;A[P++]=w*f-h,A[P++]=0,A[P++]=E*v-d,A[P++]=0,A[P++]=1,A[P++]=0,A[P++]=w*x,A[P++]=E*C}for(var M=0,D=0;D<g;++D){var L=D%r,V=D*x|0,N=V*_+L,I=N+1,B=N+_,z=B+1;y[M++]=N,y[M++]=B,y[M++]=I,y[M++]=B,y[M++]=z,y[M++]=I}if(!c){var U=i.bounds;U.min.set(-h,0,-d),U.max.set(h,0,d)}n._initialize(i,A,y,o,c,l)},n._setCylinderData=function(i,t,e,r,a,o,c,l,_){t===void 0&&(t=.5),e===void 0&&(e=.5),r===void 0&&(r=2),a===void 0&&(a=20),o===void 0&&(o=1),a=Math.floor(a),o=Math.floor(o);for(var u=a+1,h=o+1,d=r*.5,f=r/o,v=u*h,p=a*o,g=a*2,y=v+2+g,m=n._generateIndices(i.engine,y,p*6+g*3),x=1/u,C=1/a,b=1/o,A=8,S=new Float32Array(y*A),w=0,E=Math.PI,P=Math.PI*2,M=e-t,D=M/r,L=M/o,V=0;V<v;++V){var N=V%u,I=V*x|0,B=N*C,z=I*b,U=E+B*P,Y=Math.sin(U),Q=Math.cos(U),H=e-I*L,te=H*Y,Ce=I*f-d,de=H*Q,ae=V*A;S[ae++]=te,S[ae++]=Ce,S[ae++]=de,S[ae++]=Y,S[ae++]=D,S[ae++]=Q,S[ae++]=B,S[ae++]=1-z}for(var Ae=0;Ae<p;++Ae){var je=Ae%a,_t=Ae*C|0,xe=_t*u+je,$e=xe+1,qe=xe+u,ut=qe+1;m[w++]=$e,m[w++]=qe,m[w++]=xe,m[w++]=$e,m[w++]=ut,m[w++]=qe}var se=v*A;S[se++]=0,S[se++]=-d,S[se++]=0,S[se++]=0,S[se++]=-1,S[se++]=0,S[se++]=.5,S[se++]=.5,S[se++]=0,S[se++]=d,S[se++]=0,S[se++]=0,S[se++]=1,S[se++]=0,S[se++]=.5,S[se++]=.5,se=(v+2)*A;for(var it=1/(t*2),rr=1/(e*2),Jr=u*o,Mr=0;Mr<a;++Mr){var pn=Mr*A,Zr=S[pn],Bn=S[pn+2];S[se++]=Zr,S[se++]=-d,S[se++]=Bn,S[se++]=0,S[se++]=-1,S[se++]=0,S[se++]=Zr*rr+.5,S[se++]=.5-Bn*rr;var Qa=(Mr+Jr)*A;Zr=S[Qa],Bn=S[Qa+2],S[se++]=Zr,S[se++]=d,S[se++]=Bn,S[se++]=0,S[se++]=1,S[se++]=0,S[se++]=Zr*it+.5,S[se++]=.5-Bn*it}for(var nl=v+1,Ji=v+2,Ho=Ji+1,Ka=0;Ka<a;++Ka){var Zi=Ka*2,Wo=Ka===a-1?0:Zi+2;m[w++]=v,m[w++]=Ji+Wo,m[w++]=Ji+Zi,m[w++]=nl,m[w++]=Ho+Zi,m[w++]=Ho+Wo}if(!l){var Xo=i.bounds,Ja=Math.max(t,e);Xo.min.set(-Ja,-d,-Ja),Xo.max.set(Ja,d,Ja)}n._initialize(i,S,m,c,l,_)},n._setTorusData=function(i,t,e,r,a,o,c,l,_){r=Math.floor(r),a=Math.floor(a);var u=(r+1)*(a+1),h=r*a,d=n._generateIndices(i.engine,u,h*6),f=8,v=new Float32Array(u*f);o=o/180*Math.PI;for(var p=0,g=n._tempVec30,y=0;y<=r;y++)for(var m=0;m<=a;m++){var x=m/a*o,C=y/r*Math.PI*2,b=Math.cos(C),A=Math.sin(C),S=Math.cos(x),w=Math.sin(x),E=(t+e*b)*S,P=(t+e*b)*w,M=e*A;v[p++]=E,v[p++]=P,v[p++]=M;var D=t*S,L=t*w;g.set(E-D,P-L,M).normalize(),v[p++]=g.x,v[p++]=g.y,v[p++]=g.z,v[p++]=m/a,v[p++]=y/r}p=0;for(var V=1;V<=r;V++)for(var N=1;N<=a;N++){var I=(a+1)*V+N-1,B=(a+1)*(V-1)+N-1,z=(a+1)*(V-1)+N,U=(a+1)*V+N;d[p++]=I,d[p++]=B,d[p++]=U,d[p++]=B,d[p++]=z,d[p++]=U}if(!l){var Y=i.bounds,Q=t+e;Y.min.set(-Q,-Q,-e),Y.max.set(Q,Q,e)}n._initialize(i,v,d,c,l,_)},n._setConeData=function(i,t,e,r,a,o,c,l){r=Math.floor(r),a=Math.floor(a);for(var _=r+1,u=a+1,h=e*.5,d=e/a,f=_*u,v=r*a,p=f+1+r,g=n._generateIndices(i.engine,p,v*6+r*3),y=1/_,m=1/r,x=1/a,C=8,b=new Float32Array(p*8),A=0,S=Math.PI,w=Math.PI*2,E=t/e,P=0;P<f;++P){var M=P%_,D=P*y|0,L=M*m,V=D*x,N=S+L*w,I=Math.sin(N),B=Math.cos(N),z=t-V*t,U=z*I,Y=D*d-h,Q=z*B,H=P*C;b[H++]=U,b[H++]=Y,b[H++]=Q,b[H++]=I,b[H++]=E,b[H++]=B,b[H++]=L,b[H++]=1-V}for(var te=0;te<v;++te){var Ce=te%r,de=te*m|0,ae=de*_+Ce,Ae=ae+1,je=ae+_,_t=je+1;g[A++]=Ae,g[A++]=je,g[A++]=ae,g[A++]=Ae,g[A++]=_t,g[A++]=je}var xe=f*C;b[xe++]=0,b[xe++]=-h,b[xe++]=0,b[xe++]=0,b[xe++]=-1,b[xe++]=0,b[xe++]=.5,b[xe++]=.5,xe=(f+1)*C;for(var $e=1/(t*2),qe=0;qe<r;++qe){var ut=b[qe*C],se=b[qe*C+2];b[xe++]=ut,b[xe++]=-h,b[xe++]=se,b[xe++]=0,b[xe++]=-1,b[xe++]=0,b[xe++]=ut*$e+.5,b[xe++]=.5-se*$e}for(var it=f+1,rr=0;rr<r;++rr){var Jr=rr,Mr=rr===r-1?0:Jr+1;g[A++]=f,g[A++]=it+Mr,g[A++]=it+Jr}if(!c){var pn=i.bounds;pn.min.set(-t,-h,-t),pn.max.set(t,h,t)}n._initialize(i,b,g,o,c,l)},n._setCapsuleData=function(i,t,e,r,a,o,c,l){r=Math.max(2,Math.floor(r)),a=Math.floor(a);for(var _=r+1,u=a+1,h=e*.5,d=e/a,f=_*u,v=r*a,p=_*_,g=r*r,y=f+2*p,m=n._generateIndices(i.engine,y,(v+2*g)*6),x=1/_,C=1/r,b=1/a,A=Math.PI,S=Math.PI*2,w=8,E=new Float32Array(y*w),P=0,M=0;M<f;++M){var D=M%_,L=M*x|0,V=D*C,N=L*b,I=A+V*S,B=Math.sin(I),z=Math.cos(I),U=M*w;E[U++]=t*B,E[U++]=L*d-h,E[U++]=t*z,E[U++]=B,E[U++]=0,E[U++]=z,E[U++]=V,E[U++]=1-N}for(var Y=0;Y<v;++Y){var Q=Y%r,H=Y*C|0,te=H*_+Q,Ce=te+1,de=te+_,ae=de+1;m[P++]=Ce,m[P++]=de,m[P++]=te,m[P++]=Ce,m[P++]=ae,m[P++]=de}if(n._createCapsuleCap(t,e,r,A,S,f,1,E,m,P),n._createCapsuleCap(t,e,r,A,-S,f+p,-1,E,m,P+6*g),!c){var Ae=i.bounds;Ae.min.set(-t,-t-h,-t),Ae.max.set(t,t+h,t)}n._initialize(i,E,m,o,c,l)},n._initialize=function(i,t,e,r,a,o){if(a)o.setData(t),i.setIndices(e),i.uploadData(r);else{var c=[new Te(X.Position,0,$.Vector3,0),new Te(X.Normal,12,$.Vector3,0),new Te(X.UV,24,$.Vector2,0)];i.setVertexElements(c);var l=new Jt(i.engine,Mt.VertexBuffer,t,Je.Static,!0);i.setVertexBufferBinding(l,32,0),i.setIndices(e),i.calculateTangents(),i.uploadData(r),i.addSubMesh(0,e.length)}},n._generateIndices=function(i,t,e){var r=null;if(t>65535)if(i._hardwareRenderer.canIUse(K.elementIndexUint))r=new Uint32Array(e);else throw Error("The vertex count is over limit.");else r=new Uint16Array(e);return r},n._createCapsuleCap=function(i,t,e,r,a,o,c,l,_,u){for(var h=e+1,d=t*.5*c,f=h*h,v=e*e,p=1/h,g=1/e,y=8,m=0;m<f;++m){var x=m%h,C=m*p|0,b=x*g,A=C*g,S=r+b*a,w=A*Math.PI*.5,E=Math.sin(w),P=i*Math.sin(S)*E,M=i*Math.cos(w)*c+d,D=i*Math.cos(S)*E,L=(m+o)*y;l[L++]=P,l[L++]=M,l[L++]=D,l[L++]=P,l[L++]=M-d,l[L++]=D,l[L++]=b,l[L++]=A}for(var V=0;V<v;++V){var N=V%e,I=V*g|0,B=I*h+N+o,z=B+1,U=B+h,Y=U+1;_[u++]=z,_[u++]=B,_[u++]=Y,_[u++]=B,_[u++]=U,_[u++]=Y}},n}();(function(){at._tempVec30=new R})();(function(){at._sphereSeedPositions=new Float32Array([-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,1,-1,-1,-1,-1,-1,1,-1])})();(function(){at._sphereSeedCells=new Float32Array([0,1,2,3,3,2,4,5,5,4,6,7,7,0,3,5,7,6,1,0,6,4,2,1])})();(function(){at._sphereEdgeIdx=0})();(function(){at._spherePoleIdx=0})();var An;(function(n){n[n.Layer0=1]="Layer0",n[n.Layer1=2]="Layer1",n[n.Layer2=4]="Layer2",n[n.Layer3=8]="Layer3",n[n.Layer4=16]="Layer4",n[n.Layer5=32]="Layer5",n[n.Layer6=64]="Layer6",n[n.Layer7=128]="Layer7",n[n.Layer8=256]="Layer8",n[n.Layer9=512]="Layer9",n[n.Layer10=1024]="Layer10",n[n.Layer11=2048]="Layer11",n[n.Layer12=4096]="Layer12",n[n.Layer13=8192]="Layer13",n[n.Layer14=16384]="Layer14",n[n.Layer15=32768]="Layer15",n[n.Layer16=65536]="Layer16",n[n.Layer17=131072]="Layer17",n[n.Layer18=262144]="Layer18",n[n.Layer19=524288]="Layer19",n[n.Layer20=1048576]="Layer20",n[n.Layer21=2097152]="Layer21",n[n.Layer22=4194304]="Layer22",n[n.Layer23=8388608]="Layer23",n[n.Layer24=16777216]="Layer24",n[n.Layer25=33554432]="Layer25",n[n.Layer26=67108864]="Layer26",n[n.Layer27=134217728]="Layer27",n[n.Layer28=268435456]="Layer28",n[n.Layer29=536870912]="Layer29",n[n.Layer30=1073741824]="Layer30",n[n.Layer31=2147483648]="Layer31",n[n.Everything=4294967295]="Everything",n[n.Nothing=0]="Nothing"})(An||(An={}));var k_=function(){function n(){}return n.cloneComponent=function(i,t,e,r,a){var o=Ar.getCloneMode(i.constructor);for(var c in i)Ar.cloneProperty(i,t,c,o[c],e,r,a);i._cloneTo&&i._cloneTo(t,e,r)},n}(),Yt=function(n){W(s,n);function s(t,e){var r;return r=n.call(this,t)||this,r.layer=An.Layer0,r._isActiveInHierarchy=!1,r._isActiveInScene=!1,r._components=[],r._scripts=new He,r._children=[],r._isRoot=!1,r._isActive=!0,r._siblingIndex=-1,r._isTemplate=!1,r._parent=null,r._invModelMatrix=new Z,r.name=e,r.transform=r.addComponent(ge),r._inverseWorldMatFlag=r.transform.registerWorldChangeFlag(),r}var i=s.prototype;return i.addComponent=function(e){ca._addCheck(this,e);var r=new e(this);return this._components.push(r),r._setActive(!0,ue.All),r},i.getComponent=function(e){for(var r=this._components,a=0,o=r.length;a<o;a++){var c=r[a];if(lt(c,e))return c}return null},i.getComponents=function(e,r){r.length=0;for(var a=this._components,o=0,c=a.length;o<c;o++){var l=a[o];lt(l,e)&&r.push(l)}return r},i.getComponentsIncludeChildren=function(e,r){return r.length=0,this._getComponentsInChildren(e,r),r},i.addChild=function(e,r){var a;if(typeof e=="number"?a=e:(a=void 0,r=e),r._isRoot){r._scene._removeFromEntityList(r),r._isRoot=!1,this._addToChildrenList(a,r),r._parent=this;var o=r._scene,c=this._scene,l=ue.None;this._isActiveInHierarchy||r._isActiveInHierarchy&&(l|=ue.Hierarchy),r._isActiveInScene&&(this._isActiveInScene?o!==c&&(l|=ue.Scene):l|=ue.Scene),l&&r._processInActive(l),r._scene!==c&&s._traverseSetOwnerScene(r,c);var _=ue.None;r._isActive&&(this._isActiveInHierarchy&&!r._isActiveInHierarchy&&(_|=ue.Hierarchy),this._isActiveInScene&&(!r._isActiveInScene||o!==c)&&(_|=ue.Scene)),_&&r._processActive(_),r._setTransformDirty()}else r._setParent(this,a)},i.removeChild=function(e){e._setParent(null)},i.getChild=function(e){return this._children[e]},i.findByName=function(e){if(e===this.name)return this;for(var r=this._children,a=0,o=r.length;a<o;a++){var c=r[a].findByName(e);if(c)return c}return null},i.findByPath=function(e){for(var r=e.split("/"),a=this,o=0,c=r.length;o<c;++o){var l=r[o];if(l&&(a=s._findChildByName(a,l),!a))return null}return a},i.createChild=function(e){var r=new s(this.engine,e);return r.layer=this.layer,r.parent=this,r},i.clearChildren=function(){for(var e=this._children,r=e.length-1;r>=0;r--){var a=e[r];a._parent=null;var o=ue.None;a._isActiveInHierarchy&&(o|=ue.Hierarchy),a._isActiveInScene&&(o|=ue.Scene),o&&a._processInActive(o),s._traverseSetOwnerScene(a,null)}e.length=0},i.clone=function(){var e=this._createCloneEntity(this);return this._parseCloneEntity(this,e,this,e,new Map),e},i._markAsTemplate=function(e){this._isTemplate=!0,this._templateResource=e},i._createCloneEntity=function(e){var r=new s(e._engine,e.name),a=this._templateResource;a&&(r._templateResource=a,a._addReferCount(1)),r.layer=e.layer,r._isActive=e._isActive;var o=r.transform,c=e.transform;o.position=c.position,o.rotation=c.rotation,o.scale=c.scale;for(var l=e._children,_=0,u=e._children.length;_<u;_++)r.addChild(this._createCloneEntity(l[_]));return r},i._parseCloneEntity=function(e,r,a,o,c){for(var l=e._children,_=r._children,u=0,h=l.length;u<h;u++)this._parseCloneEntity(l[u],_[u],a,o,c);for(var d=e._components,f=0,v=d.length;f<v;f++){var p=d[f];if(!lt(p,ge)){var g=r.addComponent(p.constructor);k_.cloneComponent(p,g,a,o,c)}}},i.destroy=function(){if(!this._destroyed){n.prototype.destroy.call(this),this._templateResource&&(this._isTemplate||this._templateResource._addReferCount(-1),this._templateResource=null);for(var e=this._components,r=e.length-1;r>=0;r--)e[r].destroy();this._components.length=0;for(var a=this._children;a.length>0;)a[0].destroy();this._isRoot?this._scene.removeRootEntity(this):this._setParent(null),this.isActive=!1}},i._removeComponent=function(e){ca._removeCheck(this,e.constructor);var r=this._components;r.splice(r.indexOf(e),1)},i._addScript=function(e){e._entityScriptsIndex=this._scripts.length,this._scripts.add(e)},i._removeScript=function(e){var r=this._scripts.deleteByIndex(e._entityScriptsIndex);r&&(r._entityScriptsIndex=e._entityScriptsIndex),e._entityScriptsIndex=-1},i._removeFromParent=function(){var e=this._parent;if(e!=null){var r=e._children,a=this._siblingIndex;r.splice(a,1);for(var o=r.length;a<o;a++)r[a]._siblingIndex--;this._parent=null,this._siblingIndex=-1}},i._processActive=function(e){if(this._activeChangedComponents)throw"Note: can't set the 'main inActive entity' active in hierarchy, if the operation is in main inActive entity or it's children script's onDisable Event.";this._activeChangedComponents=this._scene._componentsManager.getActiveChangedTempList(),this._setActiveInHierarchy(this._activeChangedComponents,e),this._setActiveComponents(!0,e)},i._processInActive=function(e){if(this._activeChangedComponents)throw"Note: can't set the 'main active entity' inActive in hierarchy, if the operation is in main active entity or it's children script's onEnable Event.";this._activeChangedComponents=this._scene._componentsManager.getActiveChangedTempList(),this._setInActiveInHierarchy(this._activeChangedComponents,e),this._setActiveComponents(!1,e)},i._addToChildrenList=function(e,r){var a=this._children,o=a.length;if(e===void 0)r._siblingIndex=o,a.push(r);else{if(e<0||e>o)throw"The index "+e+" is out of child list bounds "+o;r._siblingIndex=e,a.splice(e,0,r);for(var c=e+1,l=o+1;c<l;c++)a[c]._siblingIndex++}},i._setParent=function(e,r){var a=this._parent;if(e!==a){if(this._removeFromParent(),this._parent=e,e){e._addToChildrenList(r,this);var o=this._scene,c=e._scene,l=ue.None;e._isActiveInHierarchy||this._isActiveInHierarchy&&(l|=ue.Hierarchy),e._isActiveInScene?this._isActiveInScene&&o!==c&&(l|=ue.Scene):this._isActiveInScene&&(l|=ue.Scene),l&&this._processInActive(l),o!==c&&s._traverseSetOwnerScene(this,c);var _=ue.None;this._isActive&&(e._isActiveInHierarchy&&!this._isActiveInHierarchy&&(_|=ue.Hierarchy),e._isActiveInScene&&(!this._isActiveInScene||o!==c)&&(_|=ue.Scene)),_&&this._processActive(_)}else{var u=ue.None;this._isActiveInHierarchy&&(u|=ue.Hierarchy),this._isActiveInScene&&(u|=ue.Scene),u&&this._processInActive(u),a&&s._traverseSetOwnerScene(this,null)}this._setTransformDirty()}},i._getComponentsInChildren=function(e,r){for(var a=this._components.length-1;a>=0;a--){var o=this._components[a];lt(o,e)&&r.push(o)}for(var c=this._children.length-1;c>=0;c--)this._children[c]._getComponentsInChildren(e,r)},i._setActiveComponents=function(e,r){for(var a=this._activeChangedComponents,o=0,c=a.length;o<c;++o)a[o]._setActive(e,r);this._scene._componentsManager.putActiveChangedTempList(a),this._activeChangedComponents=null},i._setActiveInHierarchy=function(e,r){r&ue.Hierarchy&&(this._isActiveInHierarchy=!0),r&ue.Scene&&(this._isActiveInScene=!0);for(var a=this._components,o=0,c=a.length;o<c;o++){var l=a[o];(l.enabled||!l._awoken)&&e.push(l)}for(var _=this._children,u=0,h=_.length;u<h;u++){var d=_[u];d.isActive&&d._setActiveInHierarchy(e,r)}},i._setInActiveInHierarchy=function(e,r){r&ue.Hierarchy&&(this._isActiveInHierarchy=!1),r&ue.Scene&&(this._isActiveInScene=!1);for(var a=this._components,o=0,c=a.length;o<c;o++){var l=a[o];l.enabled&&e.push(l)}for(var _=this._children,u=0,h=_.length;u<h;u++){var d=_[u];d.isActive&&d._setInActiveInHierarchy(e,r)}},i._setTransformDirty=function(){if(this.transform)this.transform._parentChange();else for(var e=0,r=this._children.length;e<r;e++)this._children[e]._setTransformDirty()},i._setSiblingIndex=function(e,r){if(r=Math.min(r,e.length-1),r<0)throw"Sibling index "+r+" should large than 0";if(this._siblingIndex!==r){var a=this._siblingIndex;if(r<a)for(var o=a;o>=r;o--){var c=o==r?this:e[o-1];e[o]=c,c._siblingIndex=o}else for(var l=a;l<=r;l++){var _=l==r?this:e[l+1];e[l]=_,_._siblingIndex=l}}},i.getInvModelMatrix=function(){return this._inverseWorldMatFlag.flag&&(Z.invert(this.transform.worldMatrix,this._invModelMatrix),this._inverseWorldMatFlag.flag=!1),this._invModelMatrix},s._findChildByName=function(e,r){for(var a=e._children,o=a.length-1;o>=0;o--){var c=a[o];if(c.name===r)return c}return null},s._traverseSetOwnerScene=function(e,r){e._scene=r;for(var a=e._children,o=a.length-1;o>=0;o--)this._traverseSetOwnerScene(a[o],r)},s._getEntityHierarchyPath=function(e,r,a){for(a.length=0;r!==e;){var o=r.parent;if(!o)return!1;a.push(r.siblingIndex),r=o}return!0},s._getEntityByHierarchyPath=function(e,r){for(var a=e,o=r.length-1;o>=0;o--)a=a.children[r[o]];return a},j(s,[{key:"isActive",get:function(){return this._isActive},set:function(e){if(e!==this._isActive)if(this._isActive=e,e){var r=this._parent,a=ue.None;if(this._isRoot&&this._scene._isActiveInEngine)a|=ue.All;else{var o,c;(o=r)!=null&&o._isActiveInHierarchy&&(a|=ue.Hierarchy),(c=r)!=null&&c._isActiveInScene&&(a|=ue.Scene)}a&&this._processActive(a)}else{var l=ue.None;this._isActiveInHierarchy&&(l|=ue.Hierarchy),this._isActiveInScene&&(l|=ue.Scene),l&&this._processInActive(l)}}},{key:"isActiveInHierarchy",get:function(){return this._isActiveInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this._setParent(e)}},{key:"children",get:function(){return this._children}},{key:"childCount",get:function(){return this._children.length}},{key:"scene",get:function(){return this._scene}},{key:"siblingIndex",get:function(){return this._siblingIndex},set:function(e){if(this._siblingIndex===-1)throw"The entity "+this.name+" is not in the hierarchy";this._setSiblingIndex(this._isRoot?this._scene._rootEntities:this._parent._children,e)}}]),s}(Yr),Mn=function(n){W(s,n);function s(t){var e;return e=n.call(this,null)||this,e.name=t,e.inverseBindMatrices=new Array,e._updatedManager=new Er,e._bones=new Array,e._updateMark=-1,e.joints=[],e}var i=s.prototype;return i._updateSkinMatrices=function(e){if(this._updateMark!==e.engine.time.frameCount){for(var r=this,a=r.bones,o=r.inverseBindMatrices,c=r._skinMatrices,l,_=((l=this.rootBone)!=null?l:e.entity).getInvModelMatrix(),u=a.length-1;u>=0;u--){var h=a[u],d=u*16;h?Ue._floatMatrixMultiply(h.transform.worldMatrix,o[u].elements,0,c,d):c.set(o[u].elements,d),Ue._floatMatrixMultiply(_,c,d,c,d)}this._updateMark=e.engine.time.frameCount}},i._cloneTo=function(e,r,a){var o=new Array,c=this.rootBone;if(c){var l=Yt._getEntityHierarchyPath(r,c,o);e.rootBone=l?Yt._getEntityByHierarchyPath(a,o):c}var _=this.bones;if(_.length>0){for(var u=_.length,h=new Array(u),d=0;d<u;d++){var f=_[d],v=Yt._getEntityHierarchyPath(r,f,o);h[d]=v?Yt._getEntityByHierarchyPath(a,o):f}e.bones=h}},j(s,[{key:"rootBone",get:function(){return this._rootBone},set:function(e){this._rootBone!==e&&(this._updatedManager.dispatch(1,e),this._rootBone=e)}},{key:"bones",get:function(){return this._bones},set:function(e){var r,a=this._bones,o,c=(o=(r=e)==null?void 0:r.length)!=null?o:0,l=a.length;a.length=c;for(var _=0;_<c;_++)a[_]=e[_];l!==c&&(this._skinMatrices=new Float32Array(c*16),this._updatedManager.dispatch(0,c))}},{key:"skeleton",get:function(){var e;return(e=this.rootBone)==null?void 0:e.name},set:function(e){var r=this._rootBone;r&&(r.name=e)}}]),s}(Yr);T([J],Mn.prototype,"inverseBindMatrices",void 0);T([F],Mn.prototype,"_skinMatrices",void 0);T([F],Mn.prototype,"_updatedManager",void 0);T([F],Mn.prototype,"_rootBone",void 0);T([F],Mn.prototype,"_bones",void 0);T([F],Mn.prototype,"_updateMark",void 0);var ea;(function(n){n[n.BoneCountChanged=0]="BoneCountChanged",n[n.RootBoneChanged=1]="RootBoneChanged"})(ea||(ea={}));var Dt=function(n){W(s,n);function s(t){var e;e=n.call(this,t)||this,e._localBounds=new lr,e._jointDataCreateCache=new ee(-1,-1),e._skin=null;var r=e.entity.engine._hardwareRenderer,a=r.renderStates.getParameter(r.gl.MAX_VERTEX_UNIFORM_VECTORS);a=Math.min(a,r._options._maxAllowSkinUniformVectorCount),e._maxVertexUniformVectors=a,e._onLocalBoundsChanged=e._onLocalBoundsChanged.bind(ce(e)),e._onSkinUpdated=e._onSkinUpdated.bind(ce(e));var o=e._localBounds;return o.min._onValueChanged=e._onLocalBoundsChanged,o.max._onValueChanged=e._onLocalBoundsChanged,e}var i=s.prototype;return i.update=function(){var e,r=this._skin;((e=r)==null?void 0:e.bones.length)>0&&r._updateSkinMatrices(this)},i._updateShaderData=function(e,r){var a,o,c=this,l=c.entity,_=c.skin,u,h=((u=(a=_)==null?void 0:a.rootBone)!=null?u:l).transform.worldMatrix;if(r){this._updateMVPShaderData(e,h);return}this._updateTransformShaderData(e,h);var d=this.shaderData,f=this.mesh,v=f._blendShapeManager;v._updateShaderData(d,this);var p=(o=_)==null?void 0:o.bones;if(p){var g=v._uniformOccupiesCount,y=p.length,m=this._jointDataCreateCache,x=y!==m.x;if(x||g!==m.y){var C=Math.ceil((this._maxVertexUniformVectors-(44+g))/4);if(y>C){var b=this.engine;if(b._hardwareRenderer.canIUseMoreJoints){if(x){var A;(A=this._jointTexture)==null||A.destroy(),this._jointTexture=new Tt(b,4,y,G.R32G32B32A32,!1),this._jointTexture.filterMode=tt.Point,this._jointTexture.isGCIgnored=!0}d.disableMacro("RENDERER_JOINTS_NUM"),d.enableMacro("RENDERER_USE_JOINT_TEXTURE"),d.setTexture(s._jointSamplerProperty,this._jointTexture)}else ve.error("component's joints count("+y+") greater than device's MAX_VERTEX_UNIFORM_VECTORS number "+this._maxVertexUniformVectors+", and don't support jointTexture in this device. suggest joint count less than "+C+".",this)}else{var S;(S=this._jointTexture)==null||S.destroy(),d.disableMacro("RENDERER_USE_JOINT_TEXTURE"),d.enableMacro("RENDERER_JOINTS_NUM",C.toString()),d.setFloatArray(s._jointMatrixProperty,_._skinMatrices)}m.set(y,g)}this._jointTexture&&this._jointTexture.setPixelBuffer(_._skinMatrices)}var w=l.layer;this._rendererLayer.set(w&65535,w>>>16&65535,0,0)},i._onDestroy=function(){var e;n.prototype._onDestroy.call(this),this._jointDataCreateCache=null,this._skin=null,this._blendShapeWeights=null,this._localBounds=null,(e=this._jointTexture)==null||e.destroy(),this._jointTexture=null},i._cloneTo=function(e,r,a){n.prototype._cloneTo.call(this,e,r,a),this.skin&&e._applySkin(null,e.skin),this._blendShapeWeights&&(e._blendShapeWeights=this._blendShapeWeights.slice())},i._updateBounds=function(e){var r,a=(r=this.skin)==null?void 0:r.rootBone;a?lr.transform(this._localBounds,a.transform.worldMatrix,e):n.prototype._updateBounds.call(this,e)},i._checkBlendShapeWeightLength=function(){var e=this._mesh,r=e?e.blendShapeCount:0,a=this._blendShapeWeights;if(a){var o=a.length;if(o!==r){var c=new Float32Array(r);if(r>o)c.set(a);else for(var l=0;l<r;l++)c[l]=a[l];this._blendShapeWeights=c}}else this._blendShapeWeights=new Float32Array(r)},i._onLocalBoundsChanged=function(){this._dirtyUpdateFlag|=Qe.WorldVolume},i._onSkinUpdated=function(e,r){switch(e){case ea.BoneCountChanged:var a=this.shaderData;r>0?(a.enableMacro("RENDERER_HAS_SKIN"),a.setInt(s._jointCountProperty,r)):a.disableMacro("RENDERER_HAS_SKIN");break;case ea.RootBoneChanged:this._dirtyUpdateFlag|=Qe.WorldVolume;break}},i._applySkin=function(e,r){var a,o,c,l,_,u,h,d,f,v=(f=(o=e)==null||(a=o.bones)==null?void 0:a.length)!=null?f:0,p,g=(p=(c=e)==null?void 0:c.rootBone)!=null?p:this.entity;(l=e)==null||l._updatedManager.removeListener(this._onSkinUpdated);var y,m=(y=(u=r)==null||(_=u.bones)==null?void 0:_.length)!=null?y:0,x,C=(x=(h=r)==null?void 0:h.rootBone)!=null?x:this.entity;(d=r)==null||d._updatedManager.addListener(this._onSkinUpdated),v!==m&&this._onSkinUpdated(ea.BoneCountChanged,m),g!==C&&this._onSkinUpdated(ea.RootBoneChanged,C)},j(s,[{key:"skin",get:function(){return this._skin},set:function(e){var r=this._skin;r!==e&&(this._applySkin(r,e),this._skin=e)}},{key:"blendShapeWeights",get:function(){return this._checkBlendShapeWeightLength(),this._blendShapeWeights},set:function(e){this._checkBlendShapeWeightLength();var r=this._blendShapeWeights;if(e.length<=r.length)r.set(e);else for(var a=0,o=r.length;a<o;a++)r[a]=e[a]}},{key:"localBounds",get:function(){return this._localBounds},set:function(e){this._localBounds!==e&&this._localBounds.copyFrom(e)}},{key:"rootBone",get:function(){return this.skin.rootBone},set:function(e){this.skin.rootBone=e}},{key:"bones",get:function(){return this.skin.bones},set:function(e){this.skin.bones=e}}]),s}(Ir);(function(){Dt._jointCountProperty=O.getByName("renderer_JointCount")})();(function(){Dt._jointSamplerProperty=O.getByName("renderer_JointSampler")})();(function(){Dt._jointMatrixProperty=O.getByName("renderer_JointMatrix")})();T([F],Dt.prototype,"_condensedBlendShapeWeights",void 0);T([J],Dt.prototype,"_localBounds",void 0);T([F],Dt.prototype,"_jointDataCreateCache",void 0);T([F],Dt.prototype,"_blendShapeWeights",void 0);T([F],Dt.prototype,"_maxVertexUniformVectors",void 0);T([F],Dt.prototype,"_jointTexture",void 0);T([J],Dt.prototype,"_skin",void 0);T([F],Dt.prototype,"_onLocalBoundsChanged",null);T([F],Dt.prototype,"_onSkinUpdated",null);var Fn=function(){function n(i){this._elementPoolIndex=0,this._elementPool=[],this._type=i}var s=n.prototype;return s.getFromPool=function(){var t=this,e=t._elementPoolIndex,r=t._elementPool;if(this._elementPoolIndex++,r.length===e){var a=new this._type;return r.push(a),a}else return r[e]},s.resetPool=function(){this._elementPoolIndex=0},s.garbageCollection=function(){for(var t=this,e=t._elementPool,r=e.length-1;r>=0;r--)e[r].dispose&&e[r].dispose()},n}(),Lr=function(){function n(i){this._subMeshPool=new Fn(Gi),this._batchedQueue=[],this._meshes=[],this._meshCount=1,this._vertexBuffers=[],this._indiceBuffers=[],this._flushId=0,this._vertexCount=0,this._elementCount=0,this._engine=i,this._initMeshes(i)}var s=n.prototype;return s.drawElement=function(t,e){var r=t.data;if(r.multiRenderData)for(var a=r.charsData,o=e.engine._renderElementPool,c=0,l=a.length;c<l;++c){var _=o.getFromPool();_.set(a[c],t.shaderPasses),this._drawSubElement(_,e)}else this._drawSubElement(t,e)},s._initMeshes=function(t){var e=n.MAX_VERTEX_COUNT;this._vertices=new Float32Array(e*9),this._indices=new Uint16Array(e*3);for(var r=this,a=r._meshes,o=r._meshCount,c=0;c<o;c++)a[c]=this._createMesh(t,c)},s.flush=function(t){var e=this._batchedQueue;e.length!==0&&(this._updateData(this._engine),this.drawBatches(t),n._canUploadSameBuffer||this._flushId++,e.length=0,this._subMeshPool.resetPool(),this._vertexCount=0,this._elementCount=0)},s.clear=function(){this._flushId=0,this._vertexCount=0,this._elementCount=0,this._batchedQueue.length=0},s.destroy=function(){this._batchedQueue=null;for(var t=this,e=t._meshes,r=t._vertexBuffers,a=t._indiceBuffers,o=0,c=e.length;o<c;++o){var l=e[o];l._addReferCount(-1),l.destroy()}this._meshes=null;for(var _=0,u=r.length;_<u;++_)r[_].destroy();this._vertexBuffers=null;for(var h=0,d=a.length;h<d;++h)a[h].destroy();this._indiceBuffers=null},s._drawSubElement=function(t,e){var r=t.data.verticesData.vertexCount;this._vertexCount+r>n.MAX_VERTEX_COUNT&&this.flush(e),this._vertexCount+=r,this._batchedQueue[this._elementCount++]=t},s._createMesh=function(t,e){var r=n.MAX_VERTEX_COUNT,a=new Po(t,"BufferMesh"+e);a._addReferCount(1);var o=[],c=this.createVertexElements(o),l=this._vertexBuffers[e]=new Jt(t,Mt.VertexBuffer,r*c,Je.Dynamic),_=this._indiceBuffers[e]=new Jt(t,Mt.IndexBuffer,r*6,Je.Dynamic);return a.setVertexBufferBinding(l,c),a.setIndexBufferBinding(_,St.UInt16),a.setVertexElements(o),a},s._updateData=function(t){var e=this,r=e._meshes,a=e._flushId;!n._canUploadSameBuffer&&this._meshCount<=a&&(this._meshCount++,r[a]=this._createMesh(t,a));var o=this,c=o._batchedQueue,l=o._vertices,_=o._indices,u=r[a];u.clearSubMesh();for(var h=0,d=0,f=0,v=0,p=0,g=0,y=null,m=0,x=c.length;m<x;m++){var C=c[m],b=C.data;h=this.updateVertices(b,l,h);for(var A=b.verticesData.triangles,S=A.length,w=0;w<S;w++)_[d++]=A[w]+p;p+=b.verticesData.vertexCount,y===null||this.canBatch(y,C)?v+=S:(u.addSubMesh(this._getSubMeshFromPool(f,v)),f+=v,v=S,c[g++]=y),y=C}u.addSubMesh(this._getSubMeshFromPool(f,v)),c[g]=y,this._vertexBuffers[a].setData(l,0,0,h,_n.Discard),this._indiceBuffers[a].setData(_,0,0,d,_n.Discard)},s._getSubMeshFromPool=function(t,e){var r=this._subMeshPool.getFromPool();return r.start=t,r.count=e,r.topology=un.Triangles,r},n}();(function(){Lr._disableBatchTag=sn.getByName("spriteDisableBatching")})();(function(){Lr.MAX_VERTEX_COUNT=4096})();(function(){Lr._canUploadSameBuffer=!0})();var Dn,mi=(Dn=function(){function n(){}return n.resetData=function(i){i._verticesData.triangles=[]},n.updatePositions=function(i){var t=i.width,e=i.height,r=i.sprite,a=i.tileMode,o=i.tiledAdaptiveThreshold,c=i._verticesData,l=c.positions,_=c.uvs,u=c.triangles,h=this,d=h._posRow,f=h._posColumn,v=h._uvRow,p=h._uvColumn;d.length=f.length=v.length=p.length=0,a===Ra.Adaptive?this._calculateAdaptiveDividing(r,t,e,o,d,f,v,p):this._calculateContinuousDividing(r,t,e,d,f,v,p);var g=i.sprite.pivot,y=g.x,m=g.y,x=i.width*y,C=i.height*m,b=mi._worldMatrix,A=b.elements,S=i.entity.transform.worldMatrix,w=S.elements,E=i.flipX?-1:1,P=i.flipY?-1:1,M,D,L,V,N,I;M=A[0]=w[0]*E,D=A[1]=w[1]*E,L=A[2]=w[2]*E,V=A[4]=w[4]*P,N=A[5]=w[5]*P,I=A[6]=w[6]*P,A[8]=w[8],A[9]=w[9],A[10]=w[10];for(var B=A[12]=w[12]-x*A[0]-C*A[4],z=A[13]=w[13]-x*A[1]-C*A[5],U=A[14]=w[14]-x*A[2]-C*A[6],Y=d.length-1,Q=f.length-1,H=0,te=0,Ce=0;Ce<Q;Ce++)for(var de=2*Ce,ae=0;ae<Y;ae++){var Ae=v.get(2*ae),je=p.get(de),_t=v.get(2*ae+1),xe=p.get(de+1);if(!(isNaN(Ae)||isNaN(Ae)||isNaN(_t)||isNaN(xe))){u[te++]=H,u[te++]=H+1,u[te++]=H+2,u[te++]=H+2,u[te++]=H+1,u[te++]=H+3;var $e=d.get(ae),qe=f.get(Ce),ut=d.get(ae+1),se=f.get(Ce+1);_[H]?_[H].set(Ae,je):_[H]=new ee(Ae,je);var it=l[H];it?it.set(M*$e+V*qe+B,D*$e+N*qe+z,L*$e+I*qe+U):l[H]=new R(M*$e+V*qe+B,D*$e+N*qe+z,L*$e+I*qe+U),H++,_[H]?_[H].set(_t,je):_[H]=new ee(_t,je),it=l[H],it?it.set(M*ut+V*qe+B,D*ut+N*qe+z,L*ut+I*qe+U):l[H]=new R(M*ut+V*qe+B,D*ut+N*qe+z,L*ut+I*qe+U),H++,_[H]?_[H].set(Ae,xe):_[H]=new ee(Ae,xe),it=l[H],it?it.set(M*$e+V*se+B,D*$e+N*se+z,L*$e+I*se+U):l[H]=new R(M*$e+V*se+B,D*$e+N*se+z,L*$e+I*se+U),H++,_[H]?_[H].set(_t,xe):_[H]=new ee(_t,xe),it=l[H],it?it.set(M*ut+V*se+B,D*ut+N*se+z,L*ut+I*se+U):l[H]=new R(M*ut+V*se+B,D*ut+N*se+z,L*ut+I*se+U),H++}}i._verticesData.vertexCount=H,u.length=te;var rr=i._bounds,Jr=rr.min,Mr=rr.max;Jr.set(d.get(0),f.get(0),0),Mr.set(d.get(Y),f.get(Q),0),i._bounds.transform(b)},n.updateUVs=function(i){},n._calculateAdaptiveDividing=function(i,t,e,r,a,o,c,l){var _=i.border,u=i._getPositions(),h=u[0],d=h.x,f=h.y,v=u[3],p=v.x,g=v.y,y=i._getUVs(),m=y[0],x=y[1],C=y[2],b=y[3],A=i.width,S=i.height,w=A*_.x,E=A*_.z,P=w+E,M=A-P,D=S*_.w,L=S*_.y,V=D+L,N=S-V,I,B,z,U,Y,Q,H;if(P>=t?(U=3,B=0):M>k.zeroTolerance?(Q=(t-P)/M,Q=Q%1>=r?Math.ceil(Q):Math.floor(Q),U=4+Q-1,B=2):(U=4,B=1),V>=e?(Y=3,z=0):N>k.zeroTolerance?(H=(e-V)/N,H=H%1>=r?Math.ceil(H):Math.floor(H),Y=4+H-1,z=2):(Y=4,z=1),(U-1)*(Y-1)*4>Lr.MAX_VERTEX_COUNT){a.add(t*d),a.add(t*p),o.add(e*f),o.add(e*g),c.add(m.x),c.add(b.x),l.add(m.y),l.add(b.y),ve.warn("The number of vertices exceeds the upper limit("+Lr.MAX_VERTEX_COUNT+").");return}switch(B){case 0:I=t/P,a.add(A*d*I),a.add(w*I),a.add(t-A*(1-p)*I),c.add(m.x),c.add(x.x),c.add(C.x),c.add(b.x);break;case 1:a.add(A*d),a.add(w),a.add(t-E),a.add(t-A*(1-p)),c.add(m.x),c.add(x.x),c.add(NaN),c.add(NaN),c.add(C.x),c.add(b.x);break;case 2:I=t/(P+Q*M),a.add(A*d*I),a.add(w*I),c.add(m.x),c.add(x.x),c.add(x.x);for(var te=0,Ce=Q-1;te<Ce;te++)a.add(w+(te+1)*M*I),c.add(C.x),c.add(x.x);a.add(t-E*I),a.add(t-A*(1-p)*I),c.add(C.x),c.add(C.x),c.add(b.x);break}switch(z){case 0:I=e/V,o.add(S*f*I),o.add(L*I),o.add(e-S*(1-g)*I),l.add(m.y),l.add(x.y),l.add(C.y),l.add(b.y);break;case 1:o.add(S*f),o.add(L),o.add(e-D),o.add(e-S*(1-g)),l.add(m.y),l.add(x.y),l.add(NaN),l.add(NaN),l.add(C.y),l.add(b.y);break;case 2:I=e/(V+H*N),o.add(S*f*I),o.add(L*I),l.add(m.y),l.add(x.y),l.add(x.y);for(var de=0,ae=H-1;de<ae;de++)o.add(L+(de+1)*N*I),l.add(C.y),l.add(x.y);o.add(e-D*I),o.add(e-S*(1-g)*I),l.add(C.y),l.add(C.y),l.add(b.y);break}},n._calculateContinuousDividing=function(i,t,e,r,a,o,c){var l=i.border,_=i._getPositions(),u=_[0],h=u.x,d=u.y,f=_[3],v=f.x,p=f.y,g=i._getUVs(),y=g[0],m=g[1],x=g[2],C=g[3],b=i.width,A=i.height,S=b*l.x,w=b*l.z,E=S+w,P=b-E,M=A*l.w,D=A*l.y,L=M+D,V=A-L,N,I,B,z,U,Y;if(E>=t?(B=3,N=0):P>k.zeroTolerance?(U=(t-E)/P,B=4+(U|0),N=2):(B=4,N=1),L>=e?(z=3,I=0):V>k.zeroTolerance?(Y=(e-L)/V,z=4+(Y|0),I=2):(z=4,I=1),(B-1)*(z-1)*4>Lr.MAX_VERTEX_COUNT){r.add(t*h),r.add(t*v),a.add(e*d),a.add(e*p),o.add(y.x),o.add(C.x),c.add(y.y),c.add(C.y),ve.warn("The number of vertices exceeds the upper limit("+Lr.MAX_VERTEX_COUNT+").");return}switch(N){case 0:var Q=t/E;r.add(b*h*Q),r.add(S*Q),r.add(t-b*(1-v)*Q),o.add(y.x),o.add(m.x),o.add(x.x),o.add(C.x);break;case 1:r.add(b*h),r.add(S),r.add(t-w),r.add(t-b*(1-v)),o.add(y.x),o.add(m.x),o.add(NaN),o.add(NaN),o.add(x.x),o.add(C.x);break;case 2:r.add(b*h),r.add(S),o.add(y.x),o.add(m.x),o.add(m.x);for(var H=U|0,te=0;te<H;te++)r.add(S+(te+1)*P),o.add(x.x),o.add(m.x);r.add(t-w),r.add(t-b*(1-v)),o.add((x.x-m.x)*(U-H)+m.x),o.add(x.x),o.add(C.x);break}switch(I){case 0:var Ce=e/L;a.add(A*d*Ce),a.add(D*Ce),a.add(e-A*(1-p)*Ce),c.add(y.y),c.add(m.y),c.add(x.y),c.add(C.y);break;case 1:a.add(A*d),a.add(D),a.add(e-M),a.add(e-A*(1-p)),c.add(y.y),c.add(m.y),c.add(NaN),c.add(NaN),c.add(x.y),c.add(C.y);break;case 2:a.add(A*d),a.add(D),c.add(y.y),c.add(m.y),c.add(m.y);for(var de=Y|0,ae=0;ae<de;ae++)a.add(D+(ae+1)*V),c.add(x.y),c.add(m.y);a.add(e-M),a.add(e-A*(1-p)),c.add((x.y-m.y)*(Y-de)+m.y),c.add(x.y),c.add(C.y);break}},n}(),function(){Dn._worldMatrix=new Z}(),function(){Dn._posRow=new He}(),function(){Dn._posColumn=new He}(),function(){Dn._uvRow=new He}(),function(){Dn._uvColumn=new He}(),Dn);mi=T([kt()],mi);var $o;(function(n){n[n.Compressed=0]="Compressed",n[n.WithoutTiled=1]="WithoutTiled",n[n.WithTiled=2]="WithTiled"})($o||($o={}));var Do=function(s,i,t,e,r){e===void 0&&(e=null),r===void 0&&(r=null),this.vertexCount=s,this.positions=i,this.uvs=t,this.triangles=e,this.color=r},mt=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._tileMode=Ra.Continuous,e._tiledAdaptiveThreshold=.5,e._color=new q(1,1,1,1),e._sprite=null,e._automaticWidth=0,e._automaticHeight=0,e._customWidth=void 0,e._customHeight=void 0,e._flipX=!1,e._flipY=!1,e._maskLayer=sa.Layer0,e._maskInteraction=ct.None,e._verticesData=new Do(4,[],[],null,e._color),e.drawMode=fr.Simple,e.setMaterial(e._engine._spriteDefaultMaterial),e._onSpriteChange=e._onSpriteChange.bind(ce(e)),e}var i=s.prototype;return i._cloneTo=function(e,r,a){n.prototype._cloneTo.call(this,e,r,a),e._assembler.resetData(e),e.sprite=this._sprite,e.drawMode=this._drawMode},i._updateShaderData=function(e,r){if(r){this._updateMVPShaderData(e,Z._identity);return}this._updateTransformShaderData(e,Z._identity)},i._updateBounds=function(e){this.sprite?this._assembler.updatePositions(this):(e.min.set(0,0,0),e.max.set(0,0,0))},i._render=function(e){var r;if(!(!((r=this.sprite)!=null&&r.texture)||!this.width||!this.height)){var a=this.getMaterial();if(a){a.destroyed&&(a=this._engine._spriteDefaultMaterials[this._maskInteraction]),this._dirtyUpdateFlag&Qe.WorldVolume&&(this._assembler.updatePositions(this),this._dirtyUpdateFlag&=~Qe.WorldVolume),this._dirtyUpdateFlag&2&&(this._assembler.updateUVs(this),this._dirtyUpdateFlag&=-3);var o=this.sprite.texture,c=this._engine._spriteRenderDataPool.getFromPool();c.set(this,a,this._verticesData,o),e.camera._renderPipeline.pushRenderData(e,c)}}},i._onDestroy=function(){var e=this._sprite;e&&(this._addResourceReferCount(e,-1),e._updateFlagManager.removeListener(this._onSpriteChange)),n.prototype._onDestroy.call(this),this._entity=null,this._color=null,this._sprite=null,this._assembler=null,this._verticesData=null},i._calDefaultSize=function(){var e=this._sprite;e?(this._automaticWidth=e.width,this._automaticHeight=e.height):this._automaticWidth=this._automaticHeight=0,this._dirtyUpdateFlag&=-5},i._updateStencilState=function(e,r){var a=this.getMaterial(),o=this._engine,c=o._spriteDefaultMaterials;if(a===c[e])this.setMaterial(c[r]);else{var l=a.renderState.stencilState;r===ct.None?(l.enabled=!1,l.writeMask=255,l.referenceValue=0,l.compareFunctionFront=l.compareFunctionBack=Ee.Always):(l.enabled=!0,l.writeMask=0,l.referenceValue=1,l.compareFunctionFront=l.compareFunctionBack=r===ct.VisibleInsideMask?Ee.LessEqual:Ee.Greater)}},i._onSpriteChange=function(e){switch(e){case we.texture:this.shaderData.setTexture(s._textureProperty,this.sprite.texture);break;case we.size:var r=this,a=r._drawMode;this._dirtyUpdateFlag|=4,this._drawMode===fr.Sliced?this._dirtyUpdateFlag|=Qe.WorldVolume:a===fr.Tiled?this._dirtyUpdateFlag|=3:(this._customWidth===void 0||this._customHeight===void 0)&&(this._dirtyUpdateFlag|=Qe.WorldVolume);break;case we.border:this._drawMode===fr.Sliced&&(this._dirtyUpdateFlag|=3);break;case we.region:case we.atlasRegionOffset:this._dirtyUpdateFlag|=3;break;case we.atlasRegion:this._dirtyUpdateFlag|=2;break;case we.pivot:this._dirtyUpdateFlag|=Qe.WorldVolume;break;case we.destroy:this.sprite=null;break}},j(s,[{key:"drawMode",get:function(){return this._drawMode},set:function(e){if(this._drawMode!==e){switch(this._drawMode=e,e){case fr.Simple:this._assembler=nn;break;case fr.Sliced:this._assembler=Ma;break;case fr.Tiled:this._assembler=mi;break}this._assembler.resetData(this),this._dirtyUpdateFlag|=3}}},{key:"tileMode",get:function(){return this._tileMode},set:function(e){this._tileMode!==e&&(this._tileMode=e,this.drawMode===fr.Tiled&&(this._dirtyUpdateFlag|=3))}},{key:"tiledAdaptiveThreshold",get:function(){return this._tiledAdaptiveThreshold},set:function(e){e!==this._tiledAdaptiveThreshold&&(e=k.clamp(e,0,1),this._tiledAdaptiveThreshold=e,this.drawMode===fr.Tiled&&(this._dirtyUpdateFlag|=3))}},{key:"sprite",get:function(){return this._sprite},set:function(e){var r=this._sprite;r!==e&&(r&&(this._addResourceReferCount(r,-1),r._updateFlagManager.removeListener(this._onSpriteChange)),this._dirtyUpdateFlag|=7,e?(this._addResourceReferCount(e,1),e._updateFlagManager.addListener(this._onSpriteChange),this.shaderData.setTexture(s._textureProperty,e.texture)):this.shaderData.setTexture(s._textureProperty,null),this._sprite=e)}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.copyFrom(e)}},{key:"width",get:function(){return this._customWidth!==void 0?this._customWidth:(this._dirtyUpdateFlag&4&&this._calDefaultSize(),this._automaticWidth)},set:function(e){this._customWidth!==e&&(this._customWidth=e,this._dirtyUpdateFlag|=Qe.WorldVolume)}},{key:"height",get:function(){return this._customHeight!==void 0?this._customHeight:(this._dirtyUpdateFlag&4&&this._calDefaultSize(),this._automaticHeight)},set:function(e){this._customHeight!==e&&(this._customHeight=e,this._dirtyUpdateFlag|=Qe.WorldVolume)}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._dirtyUpdateFlag|=Qe.WorldVolume)}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._dirtyUpdateFlag|=Qe.WorldVolume)}},{key:"maskLayer",get:function(){return this._maskLayer},set:function(e){this._maskLayer=e}},{key:"maskInteraction",get:function(){return this._maskInteraction},set:function(e){this._maskInteraction!==e&&(this._updateStencilState(this._maskInteraction,e),this._maskInteraction=e)}}]),s}(ye);(function(){mt._textureProperty=O.getByName("renderer_SpriteTexture")})();T([F],mt.prototype,"_verticesData",void 0);T([F],mt.prototype,"_drawMode",void 0);T([Me],mt.prototype,"_assembler",void 0);T([Me],mt.prototype,"_tileMode",void 0);T([Me],mt.prototype,"_tiledAdaptiveThreshold",void 0);T([J],mt.prototype,"_color",void 0);T([F],mt.prototype,"_sprite",void 0);T([F],mt.prototype,"_automaticWidth",void 0);T([F],mt.prototype,"_automaticHeight",void 0);T([Me],mt.prototype,"_customWidth",void 0);T([Me],mt.prototype,"_customHeight",void 0);T([Me],mt.prototype,"_flipX",void 0);T([Me],mt.prototype,"_flipY",void 0);T([Me],mt.prototype,"_maskLayer",void 0);T([Me],mt.prototype,"_maskInteraction",void 0);T([F],mt.prototype,"_onSpriteChange",null);var es;(function(n){n[n.UV=2]="UV",n[n.RenderData=3]="RenderData",n[n.AutomaticSize=4]="AutomaticSize",n[n.All=7]="All"})(es||(es={}));var Pt=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e.influenceLayers=sa.Everything,e._sprite=null,e._automaticWidth=0,e._automaticHeight=0,e._customWidth=void 0,e._customHeight=void 0,e._flipX=!1,e._flipY=!1,e._alphaCutoff=.5,e._verticesData=new Do(4,[],[]),nn.resetData(ce(e)),e.setMaterial(e._engine._spriteMaskDefaultMaterial),e.shaderData.setFloat(s._alphaCutoffProperty,e._alphaCutoff),e._onSpriteChange=e._onSpriteChange.bind(ce(e)),e}var i=s.prototype;return i._cloneTo=function(e,r,a){n.prototype._cloneTo.call(this,e,r,a),e.sprite=this._sprite},i._updateBounds=function(e){this.sprite?nn.updatePositions(this):(e.min.set(0,0,0),e.max.set(0,0,0))},i._render=function(e){var r;if(!(!((r=this.sprite)!=null&&r.texture)||!this.width||!this.height)){var a=this.getMaterial();if(a){var o=this,c=o._engine;a.destroyed&&(a=c._spriteMaskDefaultMaterial),this._dirtyUpdateFlag&Qe.WorldVolume&&(nn.updatePositions(this),this._dirtyUpdateFlag&=~Qe.WorldVolume),this._dirtyUpdateFlag&2&&(nn.updateUVs(this),this._dirtyUpdateFlag&=-3),e.camera._renderPipeline._allSpriteMasks.add(this);var l=c._spriteMaskRenderDataPool.getFromPool();l.set(this,a,this._verticesData);var _=c._renderElementPool.getFromPool();_.set(l,a.shader.subShaders[0].passes),this._maskElement=_}}},i._onDestroy=function(){var e=this._sprite;e&&(this._addResourceReferCount(e,-1),e._updateFlagManager.removeListener(this._onSpriteChange)),n.prototype._onDestroy.call(this),this._sprite=null,this._verticesData=null},i._calDefaultSize=function(){var e=this._sprite;e?(this._automaticWidth=e.width,this._automaticHeight=e.height):this._automaticWidth=this._automaticHeight=0,this._dirtyUpdateFlag&=-5},i._onSpriteChange=function(e){switch(e){case we.texture:this.shaderData.setTexture(s._textureProperty,this.sprite.texture);break;case we.size:this._dirtyUpdateFlag|=4,(this._customWidth===void 0||this._customHeight===void 0)&&(this._dirtyUpdateFlag|=Qe.WorldVolume);break;case we.region:case we.atlasRegionOffset:this._dirtyUpdateFlag|=3;break;case we.atlasRegion:this._dirtyUpdateFlag|=2;break;case we.pivot:this._dirtyUpdateFlag|=Qe.WorldVolume;break;case we.destroy:this.sprite=null;break}},j(s,[{key:"width",get:function(){return this._customWidth!==void 0?this._customWidth:(this._dirtyUpdateFlag&4&&this._calDefaultSize(),this._automaticWidth)},set:function(e){this._customWidth!==e&&(this._customWidth=e,this._dirtyUpdateFlag|=Qe.WorldVolume)}},{key:"height",get:function(){return this._customHeight!==void 0?this._customHeight:(this._dirtyUpdateFlag&4&&this._calDefaultSize(),this._automaticHeight)},set:function(e){this._customHeight!==e&&(this._customHeight=e,this._dirtyUpdateFlag|=Qe.WorldVolume)}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._dirtyUpdateFlag|=Qe.WorldVolume)}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._dirtyUpdateFlag|=Qe.WorldVolume)}},{key:"sprite",get:function(){return this._sprite},set:function(e){var r=this._sprite;r!==e&&(r&&(this._addResourceReferCount(r,-1),r._updateFlagManager.removeListener(this._onSpriteChange)),this._dirtyUpdateFlag|=7,e?(this._addResourceReferCount(e,1),e._updateFlagManager.addListener(this._onSpriteChange),this.shaderData.setTexture(s._textureProperty,e.texture)):this.shaderData.setTexture(s._textureProperty,null),this._sprite=e)}},{key:"alphaCutoff",get:function(){return this._alphaCutoff},set:function(e){this._alphaCutoff!==e&&(this._alphaCutoff=e,this.shaderData.setFloat(s._alphaCutoffProperty,e))}}]),s}(ye);(function(){Pt._textureProperty=O.getByName("renderer_MaskTexture")})();(function(){Pt._alphaCutoffProperty=O.getByName("renderer_MaskAlphaCutoff")})();T([Me],Pt.prototype,"influenceLayers",void 0);T([F],Pt.prototype,"_verticesData",void 0);T([F],Pt.prototype,"_sprite",void 0);T([F],Pt.prototype,"_automaticWidth",void 0);T([F],Pt.prototype,"_automaticHeight",void 0);T([Me],Pt.prototype,"_customWidth",void 0);T([Me],Pt.prototype,"_customHeight",void 0);T([Me],Pt.prototype,"_flipX",void 0);T([Me],Pt.prototype,"_flipY",void 0);T([Me],Pt.prototype,"_alphaCutoff",void 0);T([F],Pt.prototype,"_onSpriteChange",null);var ts;(function(n){n[n.UV=2]="UV",n[n.RenderData=3]="RenderData",n[n.AutomaticSize=4]="AutomaticSize",n[n.All=7]="All"})(ts||(ts={}));var G_=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._charInfoMap={},e._space=1,e._curX=1,e._curY=1,e._nextY=1,e}var i=s.prototype;return i.uploadCharTexture=function(e){var r=e.w,a=e.h,o=e.data,c=this,l=c._space,_=c.texture,u=_.width,h=r+l,d=a+l;if(1+h>=u||1+d>=u)throw Error("The char fontSize is too large.");var f=this._curX+h;f>=u&&(this._curX=l,this._curY=this._nextY+l);var v=this._curY+d;if(v>this._nextY&&(this._nextY=v),v>=u)return!1;r>0&&a>0&&o&&(e.bufferOffset=new ee(this._curX,this._curY),_.setPixelBuffer(o,0,this._curX,this._curY,r,a),_.generateMipmaps());var p=1/u,g=this._curX,y=this._curY,m=r,x=a,C=g*p,b=(g+m)*p,A=y*p,S=(y+x)*p;e.x=g,e.y=y;var w=e.uvs;return w[0].set(C,A),w[1].set(b,A),w[2].set(b,S),w[3].set(C,S),this._curX+=h+l,!0},i.addCharInfo=function(e,r){this._charInfoMap[e.charCodeAt(0)]=r},i.getCharInfo=function(e){return this._charInfoMap[e.charCodeAt(0)]},i._onDestroy=function(){n.prototype._onDestroy.call(this),this.texture.destroy(),this.texture=null,this._charInfoMap={}},s}(Qr),sr=function(){function n(){}return n.textContext=function(){var i=n._textContext;if(!i){var t;try{t=new OffscreenCanvas(0,0)}catch{t=document.createElement("canvas")}var e=t.getContext("2d",{willReadFrequently:!0});i={canvas:t,context:e},n._textContext=i}return i},n.measureFont=function(i){var t=n._fontSizeInfoCache,e=t[i];return e||(e=n._measureFontOrChar(i),t[i]=e,e)},n.getNativeFontString=function(i,t,e){var r=e&xn.Bold?"bold ":"";return e&xn.Italic&&(r+="italic "),!/([\"\'])[^\'\"]+\1/.test(i)&&n._genericFontFamilies.indexOf(i)==-1&&(i='"'+i+'"'),r+=t+"px "+i,r},n.measureChar=function(i,t){return n._measureFontOrChar(t,i)},n.measureTextWithWrap=function(i){var t=i._subFont,e=t.nativeFontString,r=n.measureFont(e),a=i.text.split(/(?:\r\n|\r|\n)/),o=new Array,c=new Array,l=new Array,_=hn._pixelsPerUnit,u=r.size+i.lineSpacing*_,h=i.width*_,d=0;t.nativeFontString=e;for(var f=0,v=a.length;f<v;f++){var p=a[f];if(p.length===0){this._pushLine(o,c,l,"",0,0,0);continue}for(var g="",y=0,m=0,x=0,C="",b=0,A=0,S=0,w=!1,E=0,P=p.length;E<P;++E){var M=p[E],D=n._getCharInfo(M,e,t),L=M.charCodeAt(0),V=L===32;if(!(V&&w&&C.length===0&&g.length===0)){var N=V||L>=19968&&L<=40959,I=D.w,B=D.offsetY,z=D.h*.5,U=z+B,Y=z-B;N?(g.length>0&&(b+y>h?(b>0&&this._pushLine(o,c,l,C,b,A,S),d=Math.max(d,b),w=!0,C=g,b=y,A=m,S=x):(C+=g,b+=y,A=Math.max(A,m),S=Math.max(S,x)),g="",y=m=x=0),b+I>h&&b>0?(this._pushLine(o,c,l,C,b,A,S),d=Math.max(d,b),w=!0,V?(C="",b=A=S=0):(C=M,b=D.xAdvance,A=U,S=Y)):(C+=M,b+=D.xAdvance,A=Math.max(A,U),S=Math.max(S,Y))):y+D.w>h?(b>0&&(this._pushLine(o,c,l,C,b,A,S),d=Math.max(d,b),C="",b=A=S=0),y>0&&this._pushLine(o,c,l,g,y,m,x),d=Math.max(d,y),w=!0,g=M,y=D.xAdvance,m=U,x=Y):(g+=M,y+=D.xAdvance,m=Math.max(m,U),x=Math.max(x,Y))}}y>0&&(b+y>h?(b>0&&this._pushLine(o,c,l,C,b,A,S),d=Math.max(d,b),b=0,y>0&&this._pushLine(o,c,l,g,y,m,x),d=Math.max(d,y)):(C+=g,b+=y,A=Math.max(A,m),S=Math.max(S,x))),b>0&&(this._pushLine(o,c,l,C,b,A,S),d=Math.max(d,b))}var Q=i.height*_;return i.overflowMode===Gn.Overflow&&(Q=u*o.length),{width:d,height:Q,lines:o,lineWidths:c,lineHeight:u,lineMaxSizes:l}},n.measureTextWithoutWrap=function(i){var t=i._subFont,e=t.nativeFontString,r=n.measureFont(e),a=i.text.split(/(?:\r\n|\r|\n)/),o=a.length,c=new Array,l=new Array,_=new Array,u=hn._pixelsPerUnit,h=r.size+i.lineSpacing*u,d=0;t.nativeFontString=e;for(var f=0;f<o;++f){for(var v=a[f],p=0,g=0,y=0,m=0,x=v.length;m<x;++m){var C=n._getCharInfo(v[m],e,t);p+=C.xAdvance;var b=C.offsetY,A=C.h*.5,S=A+b,w=A-b;g<S&&(g=S),y<w&&(y=w)}p>0&&(this._pushLine(c,l,_,v,p,g,y),d=Math.max(d,p))}var E=i.height*u;return i.overflowMode===Gn.Overflow&&(E=h*c.length),{width:d,height:E,lines:c,lineWidths:l,lineHeight:h,lineMaxSizes:_}},n.getNativeFontHash=function(i,t,e){var r=e&xn.Bold?"bold":"";return e&xn.Italic&&(r+="italic"),!/([\"\'])[^\'\"]+\1/.test(i)&&n._genericFontFamilies.indexOf(i)==-1&&(i=""+i),r+=t+"px"+i,r},n._measureFontOrChar=function(i,t){t===void 0&&(t="");var e=n.textContext(),r=e.canvas,a=e.context;a.font=i;var o=t||n._measureString,c=Math.max(1,Math.round(a.measureText(o).width)),l=Math.ceil(a.measureText(n._measureBaseline).width),_=l*n._heightMultiplier;l=n._baselineMultiplier*l|0;var u=n._extendHeight;_+=u,l+=u*.5,r.width=c,r.height=_,a.font=i,a.fillStyle="#000",a.clearRect(0,0,c,_),a.textBaseline="middle",a.fillStyle="#fff",a.fillText(o,0,l);for(var h=a.getImageData(0,0,c,_).data,d=h.length,f=-1,v=-1,p,g=0,y=0,m=0,x=r.width,C=1/x,b=0;b<d;b+=4)if(h[b+3]!==0){var A=b*.25;p=~~(A*C),f===-1&&(f=p),p>v&&(v=p)}else h[b]=h[b+1]=h[b+2]=255;f!==-1&&v!==-1&&(g=l-f,y=v-l+1,m=g+y);var S={ascent:g,descent:y,size:m};if(t){var w=null;if(m>0){var E=x*4;w=new Uint8Array(h.buffer,f*E,m*E)}return{char:t,x:0,y:0,w:c,h:m,offsetX:0,offsetY:(g-y)*.5,xAdvance:c,uvs:[new ee,new ee,new ee,new ee],ascent:g,descent:y,index:0,data:w}}else return S},n._getCharInfo=function(i,t,e){var r=e._getCharInfo(i);return r||(r=n.measureChar(i,t),e._uploadCharTexture(r),e._addCharInfo(i,r)),r},n._pushLine=function(i,t,e,r,a,o,c){i.push(r),t.push(a),e.push({ascent:o,descent:c,size:o+c})},n}();(function(){sr._genericFontFamilies=["serif","sans-serif","monospace","cursive","fantasy","system-ui","math","emoji","fangsong"]})();(function(){sr._extendHeight=0})();(function(){sr._measureString="|ÉqÅ"})();(function(){sr._measureBaseline="M"})();(function(){sr._heightMultiplier=2})();(function(){sr._baselineMultiplier=1.4})();(function(){sr._fontSizeInfoCache={}})();(function(){sr._textContext=null})();var H_=function(){function n(i){this._fontAtlases=[],this._lastIndex=-1,this._engine=i}var s=n.prototype;return s.destroy=function(){for(var t=this._fontAtlases,e=0,r=t.length;e<r;++e)t[e].destroy(!0);t.length=0},s._uploadCharTexture=function(t){var e=this._fontAtlases,r=this._lastIndex;r===-1&&(this._createFontAtlas(),r++);var a=e[r];a.uploadCharTexture(t)||(a=this._createFontAtlas(),a.uploadCharTexture(t),r++),this._lastIndex=r,t.data=null},s._addCharInfo=function(t,e){var r=this._lastIndex;e.index=r,this._fontAtlases[r].addCharInfo(t,e)},s._getCharInfo=function(t){for(var e=this._fontAtlases,r=0,a=e.length;r<a;++r){var o=e[r],c=o.getCharInfo(t);if(c)return c}return null},s._getTextureByIndex=function(t){var e=this._fontAtlases[t];return e?e.texture:null},s._getLastIndex=function(){return this._lastIndex},s._createFontAtlas=function(){var t=this,e=t._engine,r=new G_(e),a=new Tt(e,256,256,G.R8G8B8A8,!1);a.filterMode=tt.Bilinear,r.texture=a,r.isGCIgnored=a.isGCIgnored=!0,this._fontAtlases.push(r);var o=this.nativeFontString;return e.resourceManager.addContentRestorer(new(function(c){W(l,c);function l(){return c.call(this,r)}var _=l.prototype;return _.restoreContent=function(){var h=this.resource,d=h._charInfoMap,f=h.texture;for(var v in d){var p=d[v],g=sr.measureChar(p.char,o).data;if(p.w>0&&p.h>0&&g){var y=p.bufferOffset;f.setPixelBuffer(g,0,y.x,y.y,p.w,p.h)}}f.generateMipmaps()},l}(br))),r},n}(),_a=function(n){W(s,n);function s(t,e){e===void 0&&(e="");var r;return r=n.call(this,t)||this,r._name="",r._subFontMap={},r._name=e,r}var i=s.prototype;return i._getSubFont=function(e,r){var a=e+"-"+r,o=this._subFontMap,c=o[a];return c||(c=new H_(this.engine),o[a]=c,c)},i._onDestroy=function(){n.prototype._onDestroy.call(this);var e=this._subFontMap;for(var r in e)e[r].destroy();this._subFontMap=null,delete this.engine._fontMap[this._name]},s.createFromOS=function(e,r){if(r){var a=e._fontMap,o=a[r];return o||(o=new s(e,r),a[r]=o,o)}return null},j(s,[{key:"name",get:function(){return this._name}}]),s}(Qr),Mc=function n(){this.localPositions=new ie;var s=[new R,new R,new R,new R];this.renderData=new Do(4,s,null,n.triangles,null)};(function(){Mc.triangles=[0,2,1,2,0,3]})();var W_=function(){function n(i,t){this._elements=[],this._type=i;for(var e=this._elements,r=0;r<t;++r)e[r]=new i}var s=n.prototype;return s.get=function(){return this._elements.length>0?this._elements.pop():new this._type},s.put=function(t){this._elements.push(t)},n}(),rt=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._subFont=null,e._charRenderDatas=[],e._dirtyFlag=15,e._color=new q(1,1,1,1),e._text="",e._width=0,e._height=0,e._localBounds=new lr,e._font=null,e._fontSize=24,e._fontStyle=xn.None,e._lineSpacing=0,e._horizontalAlignment=Nn.Center,e._verticalAlignment=In.Center,e._enableWrapping=!1,e._overflowMode=Gn.Overflow,e._maskInteraction=ct.None,e._maskLayer=sa.Layer0,e._init(),e}var i=s.prototype;return i._init=function(){var e=this.engine;this._font=e._textDefaultFont,this._addResourceReferCount(this._font,1),this.setMaterial(e._spriteDefaultMaterial)},i._onDestroy=function(){this._font&&(this._addResourceReferCount(this._font,-1),this._font=null),n.prototype._onDestroy.call(this);for(var e=this._charRenderDatas,r=0,a=e.length;r<a;++r)s._charRenderDataPool.put(e[r]);e.length=0,this._subFont&&(this._subFont=null)},i._cloneTo=function(e,r,a){n.prototype._cloneTo.call(this,e,r,a),e.font=this._font,e._subFont=this._subFont},i._isContainDirtyFlag=function(e){return(this._dirtyFlag&e)!=0},i._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},i._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},i._updateShaderData=function(e,r){if(r){this._updateMVPShaderData(e,Z._identity);return}this._updateTransformShaderData(e,Z._identity)},i._updateBounds=function(e){lr.transform(this._localBounds,this._entity.transform.worldMatrix,e)},i._render=function(e){if(!this._isTextNoVisible()){this._isContainDirtyFlag(16)&&(this._updateStencilState(),this._setDirtyFlagFalse(16)),this._isContainDirtyFlag(1)&&(this._resetSubFont(),this._setDirtyFlagFalse(1)),this._isContainDirtyFlag(2)&&(this._updateLocalData(),this._setDirtyFlagFalse(2)),this._isContainDirtyFlag(4)&&(this._updatePosition(),this._setDirtyFlagFalse(4));var r=this._engine._spriteRenderDataPool,a=this._engine._textRenderDataPool.getFromPool(),o=a.charsData,c=this.getMaterial(),l=this._charRenderDatas,_=l.length;a.component=this,a.material=c,o.length=_;for(var u=0;u<_;++u){var h=l[u],d=r.getFromPool();d.set(this,c,h.renderData,h.texture,u),o[u]=d}e.camera._renderPipeline.pushRenderData(e,a)}},i._updateStencilState=function(){var e=this.getInstanceMaterial(),r=e.renderState.stencilState,a=this._maskInteraction;if(a===ct.None)r.enabled=!1,r.writeMask=255,r.referenceValue=0,r.compareFunctionFront=r.compareFunctionBack=Ee.Always;else{r.enabled=!0,r.writeMask=0,r.referenceValue=1;var o=a===ct.VisibleInsideMask?Ee.LessEqual:Ee.Greater;r.compareFunctionFront=o,r.compareFunctionBack=o}},i._resetSubFont=function(){var e=this._font;this._subFont=e._getSubFont(this.fontSize,this.fontStyle),this._subFont.nativeFontString=sr.getNativeFontString(e.name,this.fontSize,this.fontStyle)},i._updatePosition=function(){for(var e=this.entity.transform,r=e.worldMatrix.elements,a=this._charRenderDatas,o=r[0],c=r[1],l=r[2],_=r[4],u=r[5],h=r[6],d=r[12],f=r[13],v=r[14],p=s._tempVec31.set(_,u,h),g=s._tempVec30.set(o,c,l),y=0,m=a.length;y<m;++y){var x=a[y],C=x.localPositions,b=x.renderData.positions,A=C.x,S=C.y,w=b[0];w.x=A*o+S*_+d,w.y=A*c+S*u+f,w.z=A*l+S*h+v;var E=b[1];R.scale(g,C.z-A,E),R.add(w,E,E);var P=b[2];R.scale(p,C.w-S,P),R.add(w,P,b[3]),R.add(E,P,P)}},i._updateLocalData=function(){var e=this._localBounds,r=e.min,a=e.max,o=this,c=o.color,l=o._charRenderDatas,_=o._subFont,u=this.enableWrapping?sr.measureTextWithWrap(this):sr.measureTextWithoutWrap(this),h=u.height,d=u.lines,f=u.lineWidths,v=u.lineHeight,p=u.lineMaxSizes,g=s._charRenderDataPool,y=d.length,m=0;if(y>0){var x=hn._pixelsPerUnit,C=this.horizontalAlignment,b=1/x,A=this.width*x,S=A*.5,w=this.height*x,E=v*.5,P=0,M=v*.5-p[0].ascent,D=v*.5-p[y-1].descent-1;switch(this.verticalAlignment){case In.Top:P=w*.5-E+M;break;case In.Center:P=h*.5-E-(D-M)*.5;break;case In.Bottom:P=h-w*.5-E-D;break}for(var L=-1,V=Number.MAX_SAFE_INTEGER,N=Number.MAX_SAFE_INTEGER,I=Number.MIN_SAFE_INTEGER,B=Number.MIN_SAFE_INTEGER,z=0;z<y;++z){var U=f[z];if(U>0){var Y=d[z],Q=0,H=-1;switch(L<0&&(L=z),C){case Nn.Left:Q=-S;break;case Nn.Center:Q=-U*.5;break;case Nn.Right:Q=S-U;break}for(var te=0,Ce=Y.length;te<Ce;++te){var de=Y[te],ae=_._getCharInfo(de);if(ae.h>0){var Ae,je;H<0&&(H=te);var _t=(Ae=l)[je=m++]||(Ae[je]=g.get()),xe=_t.renderData,$e=_t.localPositions;_t.texture=_._getTextureByIndex(ae.index),xe.color=c,xe.uvs=ae.uvs;var qe=ae.w,ut=ae.ascent,se=ae.descent,it=Q*b,rr=(Q+qe)*b,Jr=(P+ut)*b,Mr=(P-se)*b;$e.set(it,Jr,rr,Mr),z===L&&(B=Math.max(B,Jr)),N=Math.min(N,Mr),te===H&&(V=Math.min(V,it)),I=Math.max(I,rr)}Q+=ae.xAdvance}}P-=v}L<0?(r.set(0,0,0),a.set(0,0,0)):(r.set(V,N,0),a.set(I,B,0))}else r.set(0,0,0),a.set(0,0,0);var pn=l.length;if(pn>m){for(var Zr=m;Zr<pn;++Zr)g.put(l[Zr]);l.length=m}_._getLastIndex()>0&&l.sort(function(Bn,Qa){return Bn.texture.instanceId-Qa.texture.instanceId})},i._onTransformChanged=function(e){n.prototype._onTransformChanged.call(this,e),this._setDirtyFlagTrue(12)},i._isTextNoVisible=function(){return this._text===""||this._fontSize===0||this.enableWrapping&&this.width<=0||this.overflowMode===Gn.Truncate&&this.height<=0},j(s,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.copyFrom(e)}},{key:"text",get:function(){return this._text},set:function(e){e=e||"",this._text!==e&&(this._text=e,this._setDirtyFlagTrue(14))}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._setDirtyFlagTrue(14))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._height=e,this._setDirtyFlagTrue(14))}},{key:"font",get:function(){return this._font},set:function(e){var r=this._font;r!==e&&(r&&this._addResourceReferCount(r,-1),e&&this._addResourceReferCount(e,1),this._font=e,this._setDirtyFlagTrue(15))}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._setDirtyFlagTrue(15))}},{key:"fontStyle",get:function(){return this._fontStyle},set:function(e){this.fontStyle!==e&&(this._fontStyle=e,this._setDirtyFlagTrue(15))}},{key:"lineSpacing",get:function(){return this._lineSpacing},set:function(e){this._lineSpacing!==e&&(this._lineSpacing=e,this._setDirtyFlagTrue(14))}},{key:"horizontalAlignment",get:function(){return this._horizontalAlignment},set:function(e){this._horizontalAlignment!==e&&(this._horizontalAlignment=e,this._setDirtyFlagTrue(14))}},{key:"verticalAlignment",get:function(){return this._verticalAlignment},set:function(e){this._verticalAlignment!==e&&(this._verticalAlignment=e,this._setDirtyFlagTrue(14))}},{key:"enableWrapping",get:function(){return this._enableWrapping},set:function(e){this._enableWrapping!==e&&(this._enableWrapping=e,this._setDirtyFlagTrue(14))}},{key:"overflowMode",get:function(){return this._overflowMode},set:function(e){this._overflowMode!==e&&(this._overflowMode=e,this._setDirtyFlagTrue(14))}},{key:"maskInteraction",get:function(){return this._maskInteraction},set:function(e){this._maskInteraction!==e&&(this._maskInteraction=e,this._setDirtyFlagTrue(16))}},{key:"maskLayer",get:function(){return this._maskLayer},set:function(e){this._maskLayer=e}},{key:"bounds",get:function(){if(this._isTextNoVisible()){if(this._isContainDirtyFlag(8)){var e=this._localBounds;e.min.set(0,0,0),e.max.set(0,0,0),this._updateBounds(this._bounds),this._setDirtyFlagFalse(8)}return this._bounds}return this._isContainDirtyFlag(1)&&this._resetSubFont(),this._isContainDirtyFlag(2)&&this._updateLocalData(),this._isContainDirtyFlag(4)&&this._updatePosition(),this._isContainDirtyFlag(8)&&this._updateBounds(this._bounds),this._setDirtyFlagFalse(15),this._bounds}}]),s}(ye);(function(){rt._charRenderDataPool=new W_(Mc,50)})();(function(){rt._tempVec30=new R})();(function(){rt._tempVec31=new R})();T([Me],rt.prototype,"_subFont",void 0);T([F],rt.prototype,"_charRenderDatas",void 0);T([F],rt.prototype,"_dirtyFlag",void 0);T([J],rt.prototype,"_color",void 0);T([Me],rt.prototype,"_text",void 0);T([Me],rt.prototype,"_width",void 0);T([Me],rt.prototype,"_height",void 0);T([F],rt.prototype,"_localBounds",void 0);T([Me],rt.prototype,"_font",void 0);T([Me],rt.prototype,"_fontSize",void 0);T([Me],rt.prototype,"_fontStyle",void 0);T([Me],rt.prototype,"_lineSpacing",void 0);T([Me],rt.prototype,"_horizontalAlignment",void 0);T([Me],rt.prototype,"_verticalAlignment",void 0);T([Me],rt.prototype,"_enableWrapping",void 0);T([Me],rt.prototype,"_overflowMode",void 0);T([Me],rt.prototype,"_maskInteraction",void 0);T([Me],rt.prototype,"_maskLayer",void 0);var rs;(function(n){n[n.SubFont=1]="SubFont",n[n.LocalPositionBounds=2]="LocalPositionBounds",n[n.WorldPosition=4]="WorldPosition",n[n.WorldBounds=8]="WorldBounds",n[n.MaskInteraction=16]="MaskInteraction",n[n.Position=14]="Position",n[n.Font=15]="Font"})(rs||(rs={}));var On;(function(n){n[n.Normal=0]="Normal",n[n.Additive=1]="Additive"})(On||(On={}));var an;(function(n){n[n.Front=0]="Front",n[n.Back=1]="Back",n[n.Double=2]="Double"})(an||(an={}));var Sr=function(n){W(s,n);function s(t,e){var r;return r=n.call(this,t)||this,r._renderStates=[],r._priority=0,r._shaderData=new Nr(xr.Material),r.shader=e,r}var i=s.prototype;return i.clone=function(){var e=new s(this._engine,this.shader);return this.cloneTo(e),e},i.cloneTo=function(e){e.shader=this.shader,this.shaderData.cloneTo(e.shaderData),Ar.deepCloneObject(this.renderStates,e.renderStates,new Map)},i._addReferCount=function(e){this._destroyed||(n.prototype._addReferCount.call(this,e),this.shaderData._addReferCount(e),this._shader._addReferCount(e))},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._shader=null,this._shaderData=null,this._renderStates.length=0,this._renderStates=null},j(s,[{key:"shaderData",get:function(){return this._shaderData}},{key:"shader",get:function(){return this._shader},set:function(e){var r=this._getReferCount();if(r>0){var a;(a=this._shader)==null||a._addReferCount(-r),e._addReferCount(r)}this._shader=e;for(var o=this._renderStates,c=o.length,l=0,_=e.subShaders,u=0;u<_.length;u++)l=Math.max(_[u].passes.length,l);if(c<l)for(var h=c;h<l;h++)o.push(new qr);else o.length=l}},{key:"renderState",get:function(){return this._renderStates[0]}},{key:"renderStates",get:function(){return this._renderStates}}]),s}(Qr),We=function(n){W(s,n);function s(t,e){var r;return r=n.call(this,t,e)||this,r._renderFace=an.Front,r._isTransparent=!1,r._blendMode=On.Normal,r.shaderData.setFloat(s._alphaCutoffProp,0),r}var i=s.prototype;return i.setIsTransparent=function(e,r){var a=this.renderStates;if(a.length<e)throw"Pass should less than pass count.";var o=a[e];r?(o.blendState.targetBlendState.enabled=!0,o.depthState.writeEnabled=!1,o.renderQueueType=ft.Transparent,this.shaderData.enableMacro(s._transparentMacro)):(o.blendState.targetBlendState.enabled=!1,o.depthState.writeEnabled=!0,o.renderQueueType=this.shaderData.getFloat(s._alphaCutoffProp)?ft.AlphaTest:ft.Opaque,this.shaderData.disableMacro(s._transparentMacro))},i.setBlendMode=function(e,r){var a=this.renderStates;if(a.length<e)throw"Pass should less than pass count.";var o=a[e].blendState,c=o.targetBlendState;switch(r){case On.Normal:c.sourceColorBlendFactor=be.SourceAlpha,c.destinationColorBlendFactor=be.OneMinusSourceAlpha,c.sourceAlphaBlendFactor=be.One,c.destinationAlphaBlendFactor=be.OneMinusSourceAlpha,c.colorBlendOperation=c.alphaBlendOperation=It.Add;break;case On.Additive:c.sourceColorBlendFactor=be.SourceAlpha,c.destinationColorBlendFactor=be.One,c.sourceAlphaBlendFactor=be.One,c.destinationAlphaBlendFactor=be.OneMinusSourceAlpha,c.colorBlendOperation=c.alphaBlendOperation=It.Add;break}},i.setRenderFace=function(e,r){var a=this.renderStates;if(a.length<e)throw"Pass should less than pass count.";switch(r){case an.Front:a[e].rasterState.cullMode=qt.Back;break;case an.Back:a[e].rasterState.cullMode=qt.Front;break;case an.Double:a[e].rasterState.cullMode=qt.Off;break}},i.clone=function(){var e=new s(this._engine,this.shader);return this.cloneTo(e),e},i.cloneTo=function(e){n.prototype.cloneTo.call(this,e),e._renderFace=this._renderFace,e._isTransparent=this._isTransparent,e._blendMode=this._blendMode},j(s,[{key:"shader",get:function(){return this._shader},set:function(e){var r=this._getReferCount();if(r>0){var a;(a=this._shader)==null||a._addReferCount(-r),e._addReferCount(r)}this._shader=e;for(var o=this._renderStates,c=o.length,l=0,_=e.subShaders,u=0;u<_.length;u++)l=Math.max(_[u].passes.length,l);if(c<l)for(var h=c;h<l;h++)o.push(new qr),this.setBlendMode(h,On.Normal);else o.length=l}},{key:"isTransparent",get:function(){return this._isTransparent},set:function(e){e!==this._isTransparent&&(this.setIsTransparent(0,e),this._isTransparent=e)}},{key:"blendMode",get:function(){return this._blendMode},set:function(e){e!==this._blendMode&&(this.setBlendMode(0,e),this._blendMode=e)}},{key:"alphaCutoff",get:function(){return this.shaderData.getFloat(s._alphaCutoffProp)},set:function(e){var r=this.shaderData;if(r.getFloat(s._alphaCutoffProp)!==e){e?r.enableMacro(s._alphaCutoffMacro):r.disableMacro(s._alphaCutoffMacro);for(var a=this.renderStates,o=0,c=a.length;o<c;o++){var l=a[o];e>0?l.renderQueueType=l.blendState.targetBlendState.enabled?ft.Transparent:ft.AlphaTest:l.renderQueueType=l.blendState.targetBlendState.enabled?ft.Transparent:ft.Opaque}r.setFloat(s._alphaCutoffProp,e)}}},{key:"renderFace",get:function(){return this._renderFace},set:function(e){e!==this._renderFace&&(this.setRenderFace(0,e),this._renderFace=e)}}]),s}(Sr);(function(){We._baseTextureMacro=oe.getByName("MATERIAL_HAS_BASETEXTURE")})();(function(){We._normalTextureMacro=oe.getByName("MATERIAL_HAS_NORMALTEXTURE")})();(function(){We._emissiveTextureMacro=oe.getByName("MATERIAL_HAS_EMISSIVETEXTURE")})();(function(){We._transparentMacro=oe.getByName("MATERIAL_IS_TRANSPARENT")})();(function(){We._baseColorProp=O.getByName("material_BaseColor")})();(function(){We._baseTextureProp=O.getByName("material_BaseTexture")})();(function(){We._tilingOffsetProp=O.getByName("material_TilingOffset")})();(function(){We._normalTextureProp=O.getByName("material_NormalTexture")})();(function(){We._normalIntensityProp=O.getByName("material_NormalIntensity")})();(function(){We._emissiveColorProp=O.getByName("material_EmissiveColor")})();(function(){We._emissiveTextureProp=O.getByName("material_EmissiveTexture")})();(function(){We._alphaCutoffProp=O.getByName("material_AlphaCutoff")})();(function(){We._alphaCutoffMacro=oe.getByName("MATERIAL_IS_ALPHA_CUTOFF")})();var Ga=function(n){W(s,n);function s(t){var e;e=n.call(this,t,Se.find("blinn-phong"))||this;var r=e.shaderData;return r.enableMacro("MATERIAL_NEED_WORLD_POS"),r.enableMacro("MATERIAL_NEED_TILING_OFFSET"),r.setColor(s._baseColorProp,new q(1,1,1,1)),r.setColor(s._specularColorProp,new q(1,1,1,1)),r.setColor(s._emissiveColorProp,new q(0,0,0,1)),r.setVector4(s._tilingOffsetProp,new ie(1,1,0,0)),r.setFloat(s._shininessProp,16),r.setFloat(s._normalIntensityProp,1),e}var i=s.prototype;return i.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},j(s,[{key:"baseColor",get:function(){return this.shaderData.getColor(s._baseColorProp)},set:function(e){var r=this.shaderData.getColor(s._baseColorProp);e!==r&&r.copyFrom(e)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(s._baseTextureProp)},set:function(e){this.shaderData.setTexture(s._baseTextureProp,e),e?this.shaderData.enableMacro(s._baseTextureMacro):this.shaderData.disableMacro(s._baseTextureMacro)}},{key:"specularColor",get:function(){return this.shaderData.getColor(s._specularColorProp)},set:function(e){var r=this.shaderData.getColor(s._specularColorProp);e!==r&&r.copyFrom(e)}},{key:"specularTexture",get:function(){return this.shaderData.getTexture(s._specularTextureProp)},set:function(e){this.shaderData.setTexture(s._specularTextureProp,e),e?this.shaderData.enableMacro("MATERIAL_HAS_SPECULAR_TEXTURE"):this.shaderData.disableMacro("MATERIAL_HAS_SPECULAR_TEXTURE")}},{key:"emissiveColor",get:function(){return this.shaderData.getColor(s._emissiveColorProp)},set:function(e){var r=this.shaderData.getColor(s._emissiveColorProp);e!==r&&r.copyFrom(e)}},{key:"emissiveTexture",get:function(){return this.shaderData.getTexture(s._emissiveTextureProp)},set:function(e){this.shaderData.setTexture(s._emissiveTextureProp,e),e?this.shaderData.enableMacro(s._emissiveTextureMacro):this.shaderData.disableMacro(s._emissiveTextureMacro)}},{key:"normalTexture",get:function(){return this.shaderData.getTexture(s._normalTextureProp)},set:function(e){this.shaderData.setTexture(s._normalTextureProp,e),e?this.shaderData.enableMacro(s._normalTextureMacro):this.shaderData.disableMacro(s._normalTextureMacro)}},{key:"normalIntensity",get:function(){return this.shaderData.getFloat(s._normalIntensityProp)},set:function(e){this.shaderData.setFloat(s._normalIntensityProp,e)}},{key:"shininess",get:function(){return this.shaderData.getFloat(s._shininessProp)},set:function(e){this.shaderData.setFloat(s._shininessProp,Math.max(e,1e-4))}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(s._tilingOffsetProp)},set:function(e){var r=this.shaderData.getVector4(s._tilingOffsetProp);e!==r&&r.copyFrom(e)}}]),s}(We);(function(){Ga._specularColorProp=O.getByName("material_SpecularColor")})();(function(){Ga._shininessProp=O.getByName("material_Shininess")})();(function(){Ga._specularTextureProp=O.getByName("material_SpecularTexture")})();var Cn;(function(n){n[n.UV0=0]="UV0",n[n.UV1=1]="UV1",n[n.UV2=2]="UV2",n[n.UV3=3]="UV3",n[n.UV4=4]="UV4",n[n.UV5=5]="UV5",n[n.UV6=6]="UV6",n[n.UV7=7]="UV7"})(Cn||(Cn={}));var Or=function(n){W(s,n);function s(i,t){var e;e=n.call(this,i,t)||this;var r=e.shaderData;return r.enableMacro("MATERIAL_NEED_WORLD_POS"),r.enableMacro("MATERIAL_NEED_TILING_OFFSET"),r.setColor(s._baseColorProp,new q(1,1,1,1)),r.setColor(s._emissiveColorProp,new q(0,0,0,1)),r.setVector4(s._tilingOffsetProp,new ie(1,1,0,0)),r.setFloat(s._normalIntensityProp,1),r.setFloat(s._occlusionTextureIntensityProp,1),r.setFloat(s._occlusionTextureCoordProp,Cn.UV0),r.setFloat(s._clearCoatProp,0),r.setFloat(s._clearCoatRoughnessProp,0),e}return j(s,[{key:"baseColor",get:function(){return this.shaderData.getColor(s._baseColorProp)},set:function(t){var e=this.shaderData.getColor(s._baseColorProp);t!==e&&e.copyFrom(t)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(s._baseTextureProp)},set:function(t){this.shaderData.setTexture(s._baseTextureProp,t),t?this.shaderData.enableMacro(s._baseTextureMacro):this.shaderData.disableMacro(s._baseTextureMacro)}},{key:"normalTexture",get:function(){return this.shaderData.getTexture(s._normalTextureProp)},set:function(t){this.shaderData.setTexture(s._normalTextureProp,t),t?this.shaderData.enableMacro(s._normalTextureMacro):this.shaderData.disableMacro(s._normalTextureMacro)}},{key:"normalTextureIntensity",get:function(){return this.shaderData.getFloat(s._normalIntensityProp)},set:function(t){this.shaderData.setFloat(s._normalIntensityProp,t)}},{key:"emissiveColor",get:function(){return this.shaderData.getColor(s._emissiveColorProp)},set:function(t){var e=this.shaderData.getColor(s._emissiveColorProp);t!==e&&e.copyFrom(t)}},{key:"emissiveTexture",get:function(){return this.shaderData.getTexture(s._emissiveTextureProp)},set:function(t){this.shaderData.setTexture(s._emissiveTextureProp,t),t?this.shaderData.enableMacro(s._emissiveTextureMacro):this.shaderData.disableMacro(s._emissiveTextureMacro)}},{key:"occlusionTexture",get:function(){return this.shaderData.getTexture(s._occlusionTextureProp)},set:function(t){this.shaderData.setTexture(s._occlusionTextureProp,t),t?this.shaderData.enableMacro("MATERIAL_HAS_OCCLUSION_TEXTURE"):this.shaderData.disableMacro("MATERIAL_HAS_OCCLUSION_TEXTURE")}},{key:"occlusionTextureIntensity",get:function(){return this.shaderData.getFloat(s._occlusionTextureIntensityProp)},set:function(t){this.shaderData.setFloat(s._occlusionTextureIntensityProp,t)}},{key:"occlusionTextureCoord",get:function(){return this.shaderData.getFloat(s._occlusionTextureCoordProp)},set:function(t){t>Cn.UV1&&ve.warn("Occlusion texture uv coordinate must be UV0 or UV1."),this.shaderData.setFloat(s._occlusionTextureCoordProp,t)}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(s._tilingOffsetProp)},set:function(t){var e=this.shaderData.getVector4(s._tilingOffsetProp);t!==e&&e.copyFrom(t)}},{key:"clearCoat",get:function(){return this.shaderData.getFloat(s._clearCoatProp)},set:function(t){!!this.shaderData.getFloat(s._clearCoatProp)!=!!t&&(t===0?this.shaderData.disableMacro("MATERIAL_ENABLE_CLEAR_COAT"):this.shaderData.enableMacro("MATERIAL_ENABLE_CLEAR_COAT")),this.shaderData.setFloat(s._clearCoatProp,t)}},{key:"clearCoatTexture",get:function(){return this.shaderData.getTexture(s._clearCoatTextureProp)},set:function(t){this.shaderData.setTexture(s._clearCoatTextureProp,t),t?this.shaderData.enableMacro("MATERIAL_HAS_CLEAR_COAT_TEXTURE"):this.shaderData.disableMacro("MATERIAL_HAS_CLEAR_COAT_TEXTURE")}},{key:"clearCoatRoughness",get:function(){return this.shaderData.getFloat(s._clearCoatRoughnessProp)},set:function(t){this.shaderData.setFloat(s._clearCoatRoughnessProp,t)}},{key:"clearCoatRoughnessTexture",get:function(){return this.shaderData.getTexture(s._clearCoatRoughnessTextureProp)},set:function(t){this.shaderData.setTexture(s._clearCoatRoughnessTextureProp,t),t?this.shaderData.enableMacro("MATERIAL_HAS_CLEAR_COAT_ROUGHNESS_TEXTURE"):this.shaderData.disableMacro("MATERIAL_HAS_CLEAR_COAT_ROUGHNESS_TEXTURE")}},{key:"clearCoatNormalTexture",get:function(){return this.shaderData.getTexture(s._clearCoatNormalTextureProp)},set:function(t){this.shaderData.setTexture(s._clearCoatNormalTextureProp,t),t?this.shaderData.enableMacro("MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE"):this.shaderData.disableMacro("MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE")}}]),s}(We);(function(){Or._occlusionTextureIntensityProp=O.getByName("material_OcclusionIntensity")})();(function(){Or._occlusionTextureCoordProp=O.getByName("material_OcclusionTextureCoord")})();(function(){Or._occlusionTextureProp=O.getByName("material_OcclusionTexture")})();(function(){Or._clearCoatProp=O.getByName("material_ClearCoat")})();(function(){Or._clearCoatTextureProp=O.getByName("material_ClearCoatTexture")})();(function(){Or._clearCoatRoughnessProp=O.getByName("material_ClearCoatRoughness")})();(function(){Or._clearCoatRoughnessTextureProp=O.getByName("material_ClearCoatRoughnessTexture")})();(function(){Or._clearCoatNormalTextureProp=O.getByName("material_ClearCoatNormalTexture")})();var Xr=function(n){W(s,n);function s(t){var e;e=n.call(this,t,Se.find("pbr"))||this,e._anisotropyRotation=0;var r=e.shaderData;return r.setFloat(s._metallicProp,1),r.setFloat(s._roughnessProp,1),r.setFloat(s._iorProp,1.5),r.setVector3(s._anisotropyInfoProp,new R(1,0,0)),e}var i=s.prototype;return i.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},j(s,[{key:"ior",get:function(){return this.shaderData.getFloat(s._iorProp)},set:function(e){this.shaderData.setFloat(s._iorProp,Math.max(e,0))}},{key:"metallic",get:function(){return this.shaderData.getFloat(s._metallicProp)},set:function(e){this.shaderData.setFloat(s._metallicProp,e)}},{key:"roughness",get:function(){return this.shaderData.getFloat(s._roughnessProp)},set:function(e){this.shaderData.setFloat(s._roughnessProp,e)}},{key:"roughnessMetallicTexture",get:function(){return this.shaderData.getTexture(s._roughnessMetallicTextureProp)},set:function(e){this.shaderData.setTexture(s._roughnessMetallicTextureProp,e),e?this.shaderData.enableMacro("MATERIAL_HAS_ROUGHNESS_METALLIC_TEXTURE"):this.shaderData.disableMacro("MATERIAL_HAS_ROUGHNESS_METALLIC_TEXTURE")}},{key:"anisotropy",get:function(){return this.shaderData.getVector3(s._anisotropyInfoProp).z},set:function(e){var r=this.shaderData.getVector3(s._anisotropyInfoProp);!!r.z!=!!e&&(e===0?this.shaderData.disableMacro("MATERIAL_ENABLE_ANISOTROPY"):this.shaderData.enableMacro("MATERIAL_ENABLE_ANISOTROPY")),r.z=e}},{key:"anisotropyRotation",get:function(){return this._anisotropyRotation},set:function(e){if(this._anisotropyRotation!==e){this._anisotropyRotation=e;var r=this.shaderData.getVector3(s._anisotropyInfoProp),a=k.degreeToRadFactor*e;r.x=Math.cos(a),r.y=Math.sin(a)}}},{key:"anisotropyTexture",get:function(){return this.shaderData.getTexture(s._anisotropyTextureProp)},set:function(e){this.shaderData.setTexture(s._anisotropyTextureProp,e),e?this.shaderData.enableMacro("MATERIAL_HAS_ANISOTROPY_TEXTURE"):this.shaderData.disableMacro("MATERIAL_HAS_ANISOTROPY_TEXTURE")}}]),s}(Or);(function(){Xr._metallicProp=O.getByName("material_Metal")})();(function(){Xr._roughnessProp=O.getByName("material_Roughness")})();(function(){Xr._roughnessMetallicTextureProp=O.getByName("material_RoughnessMetallicTexture")})();(function(){Xr._iorProp=O.getByName("material_IOR")})();(function(){Xr._anisotropyInfoProp=O.getByName("material_AnisotropyInfo")})();(function(){Xr._anisotropyTextureProp=O.getByName("material_AnisotropyTexture")})();var qn=function(n){W(s,n);function s(t){var e;return e=n.call(this,t,Se.find("pbr-specular"))||this,e.shaderData.setColor(s._specularColorProp,new q(1,1,1,1)),e.shaderData.setFloat(s._glossinessProp,1),e}var i=s.prototype;return i.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},j(s,[{key:"specularColor",get:function(){return this.shaderData.getColor(s._specularColorProp)},set:function(e){var r=this.shaderData.getColor(s._specularColorProp);e!==r&&r.copyFrom(e)}},{key:"glossiness",get:function(){return this.shaderData.getFloat(s._glossinessProp)},set:function(e){this.shaderData.setFloat(s._glossinessProp,e)}},{key:"specularGlossinessTexture",get:function(){return this.shaderData.getTexture(s._specularGlossinessTextureProp)},set:function(e){this.shaderData.setTexture(s._specularGlossinessTextureProp,e),e?this.shaderData.enableMacro(s._specularGlossinessTextureMacro):this.shaderData.disableMacro(s._specularGlossinessTextureMacro)}}]),s}(Or);(function(){qn._specularColorProp=O.getByName("material_PBRSpecularColor")})();(function(){qn._glossinessProp=O.getByName("material_Glossiness")})();(function(){qn._specularGlossinessTextureProp=O.getByName("material_SpecularGlossinessTexture")})();(function(){qn._specularGlossinessTextureMacro=oe.getByName("MATERIAL_HAS_SPECULAR_GLOSSINESS_TEXTURE")})();var Pc=function(n){W(s,n);function s(t){var e;e=n.call(this,t,Se.find("unlit"))||this;var r=e.shaderData;return r.enableMacro("MATERIAL_OMIT_NORMAL"),r.enableMacro("MATERIAL_NEED_TILING_OFFSET"),r.setColor(s._baseColorProp,new q(1,1,1,1)),r.setVector4(s._tilingOffsetProp,new ie(1,1,0,0)),e}var i=s.prototype;return i.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},j(s,[{key:"baseColor",get:function(){return this.shaderData.getColor(s._baseColorProp)},set:function(e){var r=this.shaderData.getColor(s._baseColorProp);e!==r&&r.copyFrom(e)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(s._baseTextureProp)},set:function(e){this.shaderData.setTexture(s._baseTextureProp,e),e?this.shaderData.enableMacro(s._baseTextureMacro):this.shaderData.disableMacro(s._baseTextureMacro)}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(s._tilingOffsetProp)},set:function(e){var r=this.shaderData.getVector4(s._tilingOffsetProp);e!==r&&r.copyFrom(e)}}]),s}(We),X_=function(){function n(i){var t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),e=new Float32Array([1,-1,1,0,-1,-1,0,0,1,1,1,1,-1,1,0,1]),r=new Sr(i,Se.find("blit"));r._addReferCount(1),r.renderState.depthState.enabled=!1,r.renderState.depthState.writeEnabled=!1,this.blitMesh=this._createBlitMesh(i,t),this.flipYBlitMesh=this._createBlitMesh(i,e),this.blitMaterial=r}var s=n.prototype;return s._createBlitMesh=function(t,e){var r=new dt(t);return r._addReferCount(1),r.setVertexElements([new Te("POSITION_UV",0,$.Vector4,0)]),r.setVertexBufferBinding(new Jt(t,Mt.VertexBuffer,e,Je.Static),16),r.addSubMesh(0,4,un.TriangleStrip),r},n}(),Qt=function(){function n(){this._projectionParams=new ie,this.flipProjection=!1}var s=n.prototype;return s.applyVirtualCamera=function(t,e){this.virtualCamera=t,this.flipProjection=e;var r=this.camera.shaderData,a=t.viewMatrix,o=t.projectionMatrix,c=t.viewProjectionMatrix;e&&(Z.multiply(n._flipYMatrix,o,n._flipYProjectionMatrix),Z.multiply(n._flipYProjectionMatrix,a,n._flipYViewProjectionMatrix),o=n._flipYProjectionMatrix,c=n._flipYViewProjectionMatrix),this.viewMatrix=a,this.projectionMatrix=o,this.viewProjectionMatrix=c,r.setMatrix(n._viewMatrixProperty,a),r.setMatrix(n._projectionMatrixProperty,o),r.setMatrix(n.vpMatrixProperty,c);var l=this._projectionParams;l.set(e?-1:1,t.nearClipPlane,t.farClipPlane,0),r.setVector4(n._cameraProjectionProperty,l)},s.garbageCollection=function(){this.camera=null},n}();(function(){Qt.vpMatrixProperty=O.getByName("camera_VPMat")})();(function(){Qt.pipelineStageKey=sn.getByName("pipelineStage")})();(function(){Qt._flipYMatrix=new Z(1,0,0,0,0,-1)})();(function(){Qt._cameraProjectionProperty=O.getByName("camera_ProjectionParams")})();(function(){Qt._viewMatrixProperty=O.getByName("camera_ViewMat")})();(function(){Qt._projectionMatrixProperty=O.getByName("camera_ProjMat")})();(function(){Qt._flipYProjectionMatrix=new Z})();(function(){Qt._flipYViewProjectionMatrix=new Z})();var Hi=function(){function n(){}var s=n.prototype;return s.setX=function(t,e,r,a){this.component=t,this.material=e,this.primitive=r,this.subPrimitive=a},s.dispose=function(){this.component=null,this.material=null,this.primitive=null,this.subPrimitive=null},n}(),j_=function(){function n(){}var s=n.prototype;return s.set=function(t,e){this.data=t,this.shaderPasses=e},s.dispose=function(){this.data=this.shaderPasses=null},n}(),q_=function(n){W(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.createVertexElements=function(e){return e[0]=new Te("POSITION",0,$.Vector3,0),e[1]=new Te("TEXCOORD_0",12,$.Vector2,0),20},i.canBatch=function(e,r){var a=e.data,o=r.data;if(a.isAdd!==o.isAdd)return!1;var c=a.component.shaderData,l=o.component.shaderData,_=Pt._textureProperty,u=Pt._alphaCutoffProperty;return c.getTexture(_)===l.getTexture(_)&&c.getTexture(u)===l.getTexture(u)},i.updateVertices=function(e,r,a){for(var o=e.verticesData,c=o.positions,l=o.uvs,_=o.vertexCount,u=0;u<_;u++){var h=c[u],d=l[u];r[a++]=h.x,r[a++]=h.y,r[a++]=h.z,r[a++]=d.x,r[a++]=d.y}return a},i.drawBatches=function(e){for(var r=this,a=r._engine,o=r._batchedQueue,c=this._meshes[this._flushId],l=c.subMeshes,_=c._primitive,u=e.scene.shaderData,h=e.shaderData,d=0,f=l.length;d<f;d++){var v=l[d],p=o[d],g=p.data;if(!v||!p)return;var y=g.component,m=g.material,x=Se._compileMacros;Kt.unionCollection(y._globalShaderMacro,m.shaderData._macroCollection,x);var C=m.renderState.stencilState,b=g.isAdd?ke.IncrementSaturate:ke.DecrementSaturate;C.passOperationFront=b,C.passOperationBack=b;var A=m.shader.subShaders[0].passes[0],S=A._getShaderProgram(a,x);if(!S.isValid)return;S.bind(),S.groupingOtherUniformBlock(),S.uploadAll(S.sceneUniformBlock,u),S.uploadAll(S.cameraUniformBlock,h),S.uploadAll(S.rendererUniformBlock,y.shaderData),S.uploadAll(S.materialUniformBlock,m.shaderData),(A._renderState||m.renderState)._apply(a,!1,A._renderStateDataMap,m.shaderData),a._hardwareRenderer.drawPrimitive(_,v,S)}},s}(Lr),Y_=function(){function n(i){this._preMaskLayer=0,this._batcher=new q_(i)}var s=n.prototype;return s.clear=function(){this._preMaskLayer=0,this._batcher.clear()},s.preRender=function(t,e){e.maskInteraction!==ct.None&&(this._batcher.clear(),this._processMasksDiff(t,e),this._batcher.flush(t))},s.postRender=function(t){t.maskInteraction!==ct.None&&(this._preMaskLayer=t.maskLayer)},s.destroy=function(){this._batcher.destroy(),this._batcher=null},s._processMasksDiff=function(t,e){var r=this._preMaskLayer,a=e.maskLayer;if(r!==a)for(var o=t._renderPipeline._allSpriteMasks,c=r&a,l=a&~r,_=r&~a,u=o._elements,h=0,d=o.length;h<d;h++){var f=u[h],v=f.influenceLayers;if(!(v&c)){if(v&l){var p=f._maskElement;p.data.isAdd=!0,this._batcher.drawElement(p,t);continue}if(v&_){var g=f._maskElement;g.data.isAdd=!1,this._batcher.drawElement(g,t)}}}},n}(),Q_=function(n){W(s,n);function s(){var t;return t=n.call(this)||this,t.isAdd=!0,t.multiRenderData=!1,t}var i=s.prototype;return i.set=function(e,r,a){this.component=e,this.material=r,this.verticesData=a},i.dispose=function(){this.component=this.material=this.verticesData=null},s}(Hi),K_=function(n){W(s,n);function s(){var t;return t=n.call(this)||this,t.multiRenderData=!1,t}var i=s.prototype;return i.set=function(e,r,a,o,c){c===void 0&&(c=0),this.component=e,this.material=r,this.verticesData=a,this.texture=o,this.dataIndex=c},i.dispose=function(){this.component=this.material=this.verticesData=this.texture=null},s}(Hi),J_=function(n){W(s,n);function s(){var t;return t=n.call(this)||this,t.charsData=[],t.multiRenderData=!0,t}var i=s.prototype;return i.dispose=function(){this.component=this.material=null,this.charsData.length=0},s}(Hi),Ve;(function(n){n.Text="Text",n.JSON="JSON",n.Buffer="Buffer",n.Texture2D="Texture2D",n.TextureCube="TextureCube",n.Material="Material",n.Mesh="Mesh",n.AnimationClip="AnimationClip",n.AnimatorController="AnimatorController",n.GLTF="GLTF",n.KTX="KTX",n.KTXCube="KTXCube",n.KTX2="KTX2",n.Sprite="Sprite",n.PrimitiveMesh="PrimitiveMesh",n.SpriteAtlas="SpriteAtlas",n.Env="Environment",n.Scene="Scene",n.HDR="HDR",n.Font="Font",n.SourceFont="SourceFont",n.Project="project"})(Ve||(Ve={}));var Z_=function(){function n(){this._array=[],this._loopArray=[],this._loopArrayDirty=!1}var s=n.prototype;return s.push=function(t){this._array.push(t),this._loopArrayDirty=!0},s.add=function(t,e){this._array.splice(t,0,e),this._loopArrayDirty=!0},s.removeByIndex=function(t){this._array.splice(t,1),this._loopArrayDirty=!0},s.indexOf=function(t){return this._array.indexOf(t)},s.getArray=function(){return this._array},s.getLoopArray=function(){var t=this._loopArray;if(this._loopArrayDirty){var e=this._array,r=e.length;t.length=r;for(var a=0;a<r;a++)t[a]=e[a];this._loopArrayDirty=!1}return t},j(n,[{key:"length",get:function(){return this._array.length}}]),n}(),Bc=function(){function n(i){this.engine=i,this._allCreatedScenes=[],this._scenes=new Z_}var s=n.prototype;return s.addScene=function(t,e){var r=this._scenes,a;if(typeof t=="number"){if(t<0||t>r.length)throw"The index is out of range.";a=t}else a=r.length,e=t;if(e.engine!==this.engine)throw"The scene is not belong to this engine.";if(e._sceneManager){var o=r.indexOf(e);o!==a&&(r.removeByIndex(o),r.add(a,e))}else e._sceneManager=this,r.add(a,e),e.isActive&&e._processActive(!0)},s.removeScene=function(t){var e=this._scenes,r=e.indexOf(t);if(r!==-1){var a=e.getArray()[r];e.removeByIndex(r),t._sceneManager=null,a.isActive&&a._processActive(!1)}},s.loadScene=function(t,e){e===void 0&&(e=!0);var r=this,a=this.engine.resourceManager.load({url:t,type:Ve.Scene});return a.then(function(o){if(e)for(var c=r._scenes.getArray(),l=0,_=c.length;l<_;l++)c[l].destroy();r.addScene(o)}),a},s.mergeScenes=function(t,e){for(var r=t.rootEntities;r.length>0;)e.addRootEntity(r[0])},s._destroyAllScene=function(){for(var t=this._allCreatedScenes;t.length>0;)t[0].destroy()},j(n,[{key:"scenes",get:function(){return this._scenes.getArray()}},{key:"activeScene",get:function(){return this._scenes.getArray()[0]},set:function(t){var e=this.scenes[0];e&&this.removeScene(e),t&&this.addScene(0,t)}}]),n}(),Pe=function(){function n(i){var t=this;this._state="pending",this._onTaskCompleteCallbacks=[],this._onTaskDetailCallbacks=[],this._promise=new Promise(function(e,r){t._reject=r;var a=function(u){t._state==="pending"&&(e(u),t._state="fulfilled",t._onTaskCompleteCallbacks=void 0,t._onTaskDetailCallbacks=void 0)},o=function(u){t._state==="pending"&&(r(u),t._state="rejected",t._onTaskCompleteCallbacks=void 0,t._onTaskDetailCallbacks=void 0)},c=function(u){t._state==="pending"&&(t._onCancelHandler=u)},l=function(u,h){if(t._state==="pending"){var d=t._taskCompleteProgress||(t._taskCompleteProgress={loaded:u,total:h});d.loaded=u,d.total=h,t._onTaskCompleteCallbacks.forEach(function(f){return f(u,h)})}},_=function(u,h,d){if(t._state==="pending"){var f,v;t._taskDetailProgress||(t._taskDetailProgress={});var p=(f=t._taskDetailProgress)[v=u]||(f[v]={loaded:h,total:d});p.loaded=h,p.total=d,t._onTaskDetailCallbacks.forEach(function(g){return g(u,h,d)})}};i(a,o,l,_,c)})}var s=n.prototype;return s.onProgress=function(t,e){var r=this._taskCompleteProgress,a=this._taskDetailProgress;if(r&&t(r.loaded,r.total),a)for(var o in a){var c=a[o],l=c.loaded,_=c.total;e(o,l,_)}return this._state==="pending"&&(t&&this._onTaskCompleteCallbacks.push(t),e&&this._onTaskDetailCallbacks.push(e)),this},s.then=function(t,e){var r=this;return new n(function(a,o){r._promise.then(t,e).then(a).catch(o)})},s.catch=function(t){var e=this;return new n(function(r,a){e._promise.catch(t).then(r).catch(a)})},s.finally=function(t){return this._promise.finally(t)},s.cancel=function(){if(this._state==="pending")return this._state="canceled",this._reject("canceled"),this._onCancelHandler&&this._onCancelHandler(),this},n.all=function(t){return new n(function(e,r,a){var o=function(f,v){u++,_[f]=v,a(u,l),u===l&&e(_)},c=function(f,v){lt(f,Promise)||lt(f,n)?f.then(function(p){o(v,p)},r):Promise.resolve().then(function(){o(v,f)})},l=t.length,_=new Array(l),u=0;if(l===0)return e(_);for(var h=0;h<l;h++)c(t[h],h)})},j(n,[{key:Symbol.toStringTag,get:function(){return"AssetPromise"}}]),n}(),ns;(function(n){n.Pending="pending",n.Fulfilled="fulfilled",n.Rejected="rejected",n.Canceled="canceled"})(ns||(ns={}));var ua=function(){function n(i){this.engine=i,this.retryCount=1,this.retryInterval=0,this.timeout=1/0,this.baseUrl=null,this._loadingPromises={},this._assetPool=Object.create(null),this._assetUrlPool=Object.create(null),this._referResourcePool=Object.create(null),this._graphicResourcePool=Object.create(null),this._contentRestorerPool=Object.create(null),this._subAssetPromiseCallbacks={},this._objectPool=Object.create(null),this._editorResourceConfig=Object.create(null),this._virtualPathMap=Object.create(null)}var s=n.prototype;return s.load=function(t){var e=this;if(!Array.isArray(t))return this._loadSingleItem(t);var r=t.map(function(a){return e._loadSingleItem(a)});return Pe.all(r)},s.getFromCache=function(t){var e;return(e=this._assetUrlPool[t])!=null?e:null},s.findResourcesByType=function(t){var e=new Array,r=this._referResourcePool;for(var a in r){var o=r[a];lt(o,t)&&e.push(o)}return e},s.getAssetPath=function(t){return this._assetPool[t]},s.cancelNotLoaded=function(t){var e=this;if(!t)Ue.objectValues(this._loadingPromises).forEach(function(a){a.cancel()});else if(typeof t=="string"){var r;(r=this._loadingPromises[t])==null||r.cancel()}else t.forEach(function(a){var o;(o=e._loadingPromises[a])==null||o.cancel()})},s.gc=function(){this._gc(!1),this.engine._pendingGC()},s.addContentRestorer=function(t){this._contentRestorerPool[t.resource.instanceId]=t},s._onSubAssetSuccess=function(t,e){var r;(r=this._subAssetPromiseCallbacks[t])==null||r.resolve(e),delete this._subAssetPromiseCallbacks[t]},s._onSubAssetFail=function(t,e){var r;(r=this._subAssetPromiseCallbacks[t])==null||r.reject(e),delete this._subAssetPromiseCallbacks[t]},s._addAsset=function(t,e){this._assetPool[e.instanceId]=t,this._assetUrlPool[t]=e},s._deleteAsset=function(t){var e=t.instanceId,r=this._assetPool[e];r&&(delete this._assetPool[e],delete this._assetUrlPool[r])},s._addReferResource=function(t){this._referResourcePool[t.instanceId]=t},s._deleteReferResource=function(t){delete this._referResourcePool[t.instanceId]},s._addGraphicResource=function(t){this._graphicResourcePool[t.instanceId]=t},s._deleteGraphicResource=function(t){delete this._graphicResourcePool[t.instanceId]},s._deleteContentRestorer=function(t){delete this._contentRestorerPool[t.instanceId]},s._restoreGraphicResources=function(){var t=this._graphicResourcePool;for(var e in t)t[e]._rebuild()},s._lostGraphicResources=function(){var t=this._graphicResourcePool;for(var e in t)t[e]._isContentLost=!0},s._restoreResourcesContent=function(){var t=this._contentRestorerPool,e=new Array;for(var r in t){var a=t[r],o=a.restoreContent();o&&e.push(o)}return Promise.all(e)},s._destroy=function(){this.cancelNotLoaded(),this._gc(!0),this._assetPool=null,this._assetUrlPool=null,this._referResourcePool=null,this._graphicResourcePool=null,this._contentRestorerPool=null,this._loadingPromises=null},s._assignDefaultOptions=function(t){var e;if(t.type=(e=t.type)!=null?e:n._getTypeByUrl(t.url),t.type===void 0)throw"asset type should be specified: "+t.url;var r;t.retryCount=(r=t.retryCount)!=null?r:this.retryCount;var a;t.timeout=(a=t.timeout)!=null?a:this.timeout;var o;t.retryInterval=(o=t.retryInterval)!=null?o:this.retryInterval;var c;return t.url=(c=t.url)!=null?c:t.urls.join(","),t},s._loadSingleItem=function(t){var e=this,r=this._assignDefaultOptions(typeof t=="string"?{url:t}:t),a=r.url,o=this._virtualPathMap[a]?this._virtualPathMap[a]:a;!Ue.isAbsoluteUrl(o)&&this.baseUrl&&(o=Ue.resolveAbsoluteUrl(this.baseUrl,o));var c=this._parseURL(o),l=c.assetBaseURL,_=c.queryPath,u=_?this._parseQueryPath(_):[],h=this._assetUrlPool[l];if(h)return new Pe(function(x){x(e._getResolveResource(h,u))});var d=l;if(_){d+="?q="+u.shift();for(var f;f=u.shift();)d+="["+f+"]"}var v=this._loadingPromises,p=v[d];if(p)return new Pe(function(x,C,b,A){p.onProgress(b,A).then(function(S){x(S)}).catch(function(S){C(S)})});var g=n._loaders[r.type];if(!g)throw"loader not found: "+r.type;r.url=l;var y=g.load(r,this);if(v[l]=y,y.then(function(x){g.useCache&&e._addAsset(l,x),delete v[l]},function(){return delete v[l]}),_){var m=new Pe(function(x,C){e._pushSubAssetPromiseCallback(d,x,C)});return v[d]=m,m.then(function(){delete v[d]},function(){return delete v[d]}),y.catch(function(x){e._onSubAssetFail(d,x)}),m}return y},s._pushSubAssetPromiseCallback=function(t,e,r){this._subAssetPromiseCallbacks[t]={resolve:e,reject:r}},s._gc=function(t){for(var e=Ue.objectValues(this._referResourcePool),r=0,a=e.length;r<a;r++){var o=e[r];(!o.isGCIgnored||t)&&o.destroy(t,!0)}},s._getResolveResource=function(t,e){var r=t;if(e)for(var a=0,o=e.length;a<o;a++){var c=e[a];r=r[c]}return r},s._parseURL=function(t){var e=t.split("?"),r=e[0],a=e[1],o=void 0,c=r;if(a){for(var l=a.split("&"),_=0;_<l.length;_++){var u=l[_];if(u.startsWith("q=")){o=decodeURIComponent(u.split("=")[1]),l.splice(_,1);break}}c=l.length>0?r+"?"+l.join("&"):r}return{assetBaseURL:c,queryPath:o}},s._parseQueryPath=function(t){var e=[];return t.charCodeAt(0)===$_&&e.push(""),t.replace(tu,function(r,a,o,c){var l=r;o?l=c.replace(eu,"$1"):a&&(l=a.trim()),e.push(l)}),e},s.getResourceByRef=function(t){var e=t.refId,r=t.key,a=t.isClone,o=this._objectPool[e],c;if(o)c=Promise.resolve(o);else{var l,_=(l=this._editorResourceConfig[e])==null?void 0:l.path;if(!_)return ve.warn("refId:"+e+" is not find in this._editorResourceConfig."),Promise.resolve(null);_=r?""+_+(_.indexOf("?")>-1?"&":"?")+"q="+r:_,c=this.load({url:_,type:this._editorResourceConfig[e].type})}return c.then(function(u){return a?u.clone():u})},s.initVirtualResources=function(t){var e=this;t.forEach(function(r){e._virtualPathMap[r.virtualPath]=r.path,e._editorResourceConfig[r.id]=r})},n._addLoader=function(t,e,r){this._loaders[t]=e;for(var a=0,o=r.length;a<o;a++)this._extTypeMapping[r[a].toLowerCase()]=t},n._getTypeByUrl=function(t){var e=t.split("?")[0];return this._extTypeMapping[e.substring(e.lastIndexOf(".")+1).toLowerCase()]},n}();(function(){ua._loaders={}})();(function(){ua._extTypeMapping={}})();function Xe(n,s,i){return i===void 0&&(i=!0),function(t){var e=new t(i);ua._addLoader(n,e,s)}}var $_=46,eu=/\\(\\)?/g,tu=RegExp(`[^.[\\]]+|\\[(?:([^"'][^[]*)|(["'])((?:(?!\\2)[^\\\\]|\\\\.)*?)\\2)\\]|(?=(?:\\.|\\[\\])(?:\\.|\\[\\]|$))`,"g"),ar;(function(n){n[n.Down=0]="Down",n[n.Move=1]="Move",n[n.Stationary=2]="Stationary",n[n.Up=3]="Up",n[n.Leave=4]="Leave"})(ar||(ar={}));var Dc=function(){function n(i){this.phase=ar.Leave,this.position=new ee,this.deltaPosition=new ee,this._events=[],this._upMap=[],this._downMap=[],this._upList=new He,this._downList=new He,this.id=i}var s=n.prototype;return s._firePointerExitAndEnter=function(t){var e=this;this._currentEnteredEntity!==t&&(this._currentEnteredEntity&&this._currentEnteredEntity._scripts.forEach(function(r){r.onPointerExit(e)},function(r,a){r._entityScriptsIndex=a}),t&&t._scripts.forEach(function(r){r.onPointerEnter(e)},function(r,a){r._entityScriptsIndex=a}),this._currentEnteredEntity=t)},s._firePointerDown=function(t){var e=this;t&&t._scripts.forEach(function(r){r.onPointerDown(e)},function(r,a){r._entityScriptsIndex=a}),this._currentPressedEntity=t},s._firePointerDrag=function(){var t=this;this._currentPressedEntity&&this._currentPressedEntity._scripts.forEach(function(e){e.onPointerDrag(t)},function(e,r){e._entityScriptsIndex=r})},s._firePointerUpAndClick=function(t){var e=this,r=this,a=r._currentPressedEntity;if(a){var o=a===t;a._scripts.forEach(function(c){o&&c.onPointerClick(e),c.onPointerUp(e)},function(c,l){c._entityScriptsIndex=l}),this._currentPressedEntity=null}},n}(),ra;(function(n){n[n.None=0]="None",n[n.Primary=1]="Primary",n[n.Secondary=2]="Secondary",n[n.Auxiliary=4]="Auxiliary",n[n.XButton1=8]="XButton1",n[n.XButton2=16]="XButton2",n[n.XButton3=32]="XButton3",n[n.XButton4=64]="XButton4",n[n.XButton5=128]="XButton5",n[n.XButton6=256]="XButton6",n[n.XButton7=512]="XButton7",n[n.XButton8=1024]="XButton8"})(ra||(ra={}));var ru=[1,4,2,8,16,32,64,128,256,512,1024],as={1:0,2:2,4:1,8:3,16:4,32:5,64:6,128:7,256:8,512:9,1024:10},jr=function(){function n(){}return n._initialize=function(){{if(typeof navigator>"u")return;var i=navigator.userAgent;/iPhone/i.test(i)?n.platform=Nt.IPhone:/iPad/i.test(i)?n.platform=Nt.IPad:/Android/i.test(i)?n.platform=Nt.Android:/Macintosh/i.test(i)&&(n.platform=Nt.Mac);var t;switch(n.platform){case Nt.IPhone:t=i.match(/OS (\d+)_?(\d+)?_?(\d+)?/),this.operatingSystem=t?"iPhone OS "+t[1]+"."+(t[2]||0)+"."+(t[3]||0):"iPhone OS";break;case Nt.IPad:t=i.match(/OS (\d+)_?(\d+)?_?(\d+)?/),this.operatingSystem=t?"iPad OS "+t[1]+"."+(t[2]||0)+"."+(t[3]||0):"iPad OS";break;case Nt.Android:t=i.match(/Android (\d+).?(\d+)?.?(\d+)?/),this.operatingSystem=t?"Android "+t[1]+"."+(t[2]||0)+"."+(t[3]||0):"Android";break;case Nt.Mac:t=i.match(/Mac OS X (\d+)_?(\d+)?_?(\d+)?/),this.operatingSystem=t?"Mac OS X "+t[1]+"."+(t[2]||0)+"."+(t[3]||0):"Mac OS X";break}}},n._detectSIMDSupported=function(){return this._simdSupported===null&&(this._simdSupported=WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]))),this._simdSupported},j(n,null,[{key:"devicePixelRatio",get:function(){return window.devicePixelRatio}}]),n}();(function(){jr.platform=Nt.Unknown})();(function(){jr.operatingSystem=""})();(function(){jr._simdSupported=null})();jr._initialize();var na;(function(n){n[n.Backquote=0]="Backquote",n[n.Backslash=1]="Backslash",n[n.Backspace=2]="Backspace",n[n.BracketLeft=3]="BracketLeft",n[n.BracketRight=4]="BracketRight",n[n.Comma=5]="Comma",n[n.Digit0=6]="Digit0",n[n.Digit1=7]="Digit1",n[n.Digit2=8]="Digit2",n[n.Digit3=9]="Digit3",n[n.Digit4=10]="Digit4",n[n.Digit5=11]="Digit5",n[n.Digit6=12]="Digit6",n[n.Digit7=13]="Digit7",n[n.Digit8=14]="Digit8",n[n.Digit9=15]="Digit9",n[n.Equal=16]="Equal",n[n.IntlBackslash=17]="IntlBackslash",n[n.IntlRo=18]="IntlRo",n[n.IntlYen=19]="IntlYen",n[n.KeyA=20]="KeyA",n[n.KeyB=21]="KeyB",n[n.KeyC=22]="KeyC",n[n.KeyD=23]="KeyD",n[n.KeyE=24]="KeyE",n[n.KeyF=25]="KeyF",n[n.KeyG=26]="KeyG",n[n.KeyH=27]="KeyH",n[n.KeyI=28]="KeyI",n[n.KeyJ=29]="KeyJ",n[n.KeyK=30]="KeyK",n[n.KeyL=31]="KeyL",n[n.KeyM=32]="KeyM",n[n.KeyN=33]="KeyN",n[n.KeyO=34]="KeyO",n[n.KeyP=35]="KeyP",n[n.KeyQ=36]="KeyQ",n[n.KeyR=37]="KeyR",n[n.KeyS=38]="KeyS",n[n.KeyT=39]="KeyT",n[n.KeyU=40]="KeyU",n[n.KeyV=41]="KeyV",n[n.KeyW=42]="KeyW",n[n.KeyX=43]="KeyX",n[n.KeyY=44]="KeyY",n[n.KeyZ=45]="KeyZ",n[n.Minus=46]="Minus",n[n.Period=47]="Period",n[n.Quote=48]="Quote",n[n.Semicolon=49]="Semicolon",n[n.Slash=50]="Slash",n[n.AltLeft=51]="AltLeft",n[n.AltRight=52]="AltRight",n[n.CapsLock=53]="CapsLock",n[n.ContextMenu=54]="ContextMenu",n[n.ControlLeft=55]="ControlLeft",n[n.ControlRight=56]="ControlRight",n[n.Enter=57]="Enter",n[n.MetaLeft=58]="MetaLeft",n[n.MetaRight=59]="MetaRight",n[n.ShiftLeft=60]="ShiftLeft",n[n.ShiftRight=61]="ShiftRight",n[n.Space=62]="Space",n[n.Tab=63]="Tab",n[n.Convert=64]="Convert",n[n.KanaMode=65]="KanaMode",n[n.Lang1=66]="Lang1",n[n.Lang2=67]="Lang2",n[n.Lang3=68]="Lang3",n[n.Lang4=69]="Lang4",n[n.Lang5=70]="Lang5",n[n.NonConvert=71]="NonConvert",n[n.Delete=72]="Delete",n[n.End=73]="End",n[n.Help=74]="Help",n[n.Home=75]="Home",n[n.Insert=76]="Insert",n[n.PageDown=77]="PageDown",n[n.PageUp=78]="PageUp",n[n.ArrowDown=79]="ArrowDown",n[n.ArrowLeft=80]="ArrowLeft",n[n.ArrowRight=81]="ArrowRight",n[n.ArrowUp=82]="ArrowUp",n[n.NumLock=83]="NumLock",n[n.Numpad0=84]="Numpad0",n[n.Numpad1=85]="Numpad1",n[n.Numpad2=86]="Numpad2",n[n.Numpad3=87]="Numpad3",n[n.Numpad4=88]="Numpad4",n[n.Numpad5=89]="Numpad5",n[n.Numpad6=90]="Numpad6",n[n.Numpad7=91]="Numpad7",n[n.Numpad8=92]="Numpad8",n[n.Numpad9=93]="Numpad9",n[n.NumpadAdd=94]="NumpadAdd",n[n.NumpadBackspace=95]="NumpadBackspace",n[n.NumpadClear=96]="NumpadClear",n[n.NumpadClearEntry=97]="NumpadClearEntry",n[n.NumpadComma=98]="NumpadComma",n[n.NumpadDecimal=99]="NumpadDecimal",n[n.NumpadDivide=100]="NumpadDivide",n[n.NumpadEnter=101]="NumpadEnter",n[n.NumpadEqual=102]="NumpadEqual",n[n.NumpadHash=103]="NumpadHash",n[n.NumpadMemoryAdd=104]="NumpadMemoryAdd",n[n.NumpadMemoryClear=105]="NumpadMemoryClear",n[n.NumpadMemoryRecall=106]="NumpadMemoryRecall",n[n.NumpadMemoryStore=107]="NumpadMemoryStore",n[n.NumpadMemorySubtract=108]="NumpadMemorySubtract",n[n.NumpadMultiply=109]="NumpadMultiply",n[n.NumpadParenLeft=110]="NumpadParenLeft",n[n.NumpadParenRight=111]="NumpadParenRight",n[n.NumpadStar=112]="NumpadStar",n[n.NumpadSubtract=113]="NumpadSubtract",n[n.Escape=114]="Escape",n[n.F1=115]="F1",n[n.F2=116]="F2",n[n.F3=117]="F3",n[n.F4=118]="F4",n[n.F5=119]="F5",n[n.F6=120]="F6",n[n.F7=121]="F7",n[n.F8=122]="F8",n[n.F9=123]="F9",n[n.F10=124]="F10",n[n.F11=125]="F11",n[n.F12=126]="F12",n[n.F13=127]="F13",n[n.F14=128]="F14",n[n.F15=129]="F15",n[n.Fn=130]="Fn",n[n.FnLock=131]="FnLock",n[n.PrintScreen=132]="PrintScreen",n[n.ScrollLock=133]="ScrollLock",n[n.Pause=134]="Pause",n[n.BrowserBack=135]="BrowserBack",n[n.BrowserFavorites=136]="BrowserFavorites",n[n.BrowserForward=137]="BrowserForward",n[n.BrowserHome=138]="BrowserHome",n[n.BrowserRefresh=139]="BrowserRefresh",n[n.BrowserSearch=140]="BrowserSearch",n[n.BrowserStop=141]="BrowserStop",n[n.Eject=142]="Eject",n[n.LaunchApp1=143]="LaunchApp1",n[n.LaunchApp2=144]="LaunchApp2",n[n.LaunchMail=145]="LaunchMail",n[n.MediaPlayPause=146]="MediaPlayPause",n[n.MediaSelect=147]="MediaSelect",n[n.MediaStop=148]="MediaStop",n[n.MediaTrackNext=149]="MediaTrackNext",n[n.MediaTrackPrevious=150]="MediaTrackPrevious",n[n.Power=151]="Power",n[n.Sleep=152]="Sleep",n[n.AudioVolumeDown=153]="AudioVolumeDown",n[n.AudioVolumeMute=154]="AudioVolumeMute",n[n.AudioVolumeUp=155]="AudioVolumeUp",n[n.WakeUp=156]="WakeUp",n[n.Hyper=157]="Hyper",n[n.Super=158]="Super",n[n.Turbo=159]="Turbo",n[n.Abort=160]="Abort",n[n.Resume=161]="Resume",n[n.Suspend=162]="Suspend",n[n.Again=163]="Again",n[n.Copy=164]="Copy",n[n.Cut=165]="Cut",n[n.Find=166]="Find",n[n.Open=167]="Open",n[n.Paste=168]="Paste",n[n.Props=169]="Props",n[n.Select=170]="Select",n[n.Undo=171]="Undo",n[n.Hiragana=172]="Hiragana",n[n.Katakana=173]="Katakana",n[n.Unidentified=174]="Unidentified"})(na||(na={}));var nu=function(){function n(i,t){this._curHeldDownKeyToIndexMap=[],this._upKeyToFrameCountMap=[],this._downKeyToFrameCountMap=[],this._curFrameHeldDownList=new He,this._curFrameDownList=new He,this._curFrameUpList=new He,this._nativeEvents=[],this._engine=i,this._onBlur=this._onBlur.bind(this),this._onKeyEvent=this._onKeyEvent.bind(this),this._target=t,this._addEventListener()}var s=n.prototype;return s._update=function(){var t=this,e=t._nativeEvents,r=t._curFrameDownList,a=t._curFrameUpList;if(r.length=0,a.length=0,e.length>0){for(var o=this._engine.time.frameCount,c=this,l=c._curHeldDownKeyToIndexMap,_=c._curFrameHeldDownList,u=c._downKeyToFrameCountMap,h=c._upKeyToFrameCountMap,d=0,f=e.length;d<f;d++){var v=e[d],p=na[v.code];switch(v.type){case"keydown":l[p]==null&&(r.add(p),_.add(p),l[p]=_.length-1,u[p]=o);break;case"keyup":var g=l[p];if(g!=null){l[p]=null;var y=_.deleteByIndex(g);y&&(l[y]=g)}if(a.add(p),h[p]=o,jr.platform===Nt.Mac&&(p===na.MetaLeft||p===na.MetaRight)){for(var m=0,x=_.length;m<x;m++)l[_.get(m)]=null;_.length=0}break}}e.length=0}},s._destroy=function(){this._removeEventListener(),this._curHeldDownKeyToIndexMap.length=0,this._curHeldDownKeyToIndexMap=null,this._upKeyToFrameCountMap.length=0,this._upKeyToFrameCountMap=null,this._downKeyToFrameCountMap.length=0,this._downKeyToFrameCountMap=null,this._nativeEvents.length=0,this._nativeEvents=null,this._curFrameHeldDownList.length=0,this._curFrameHeldDownList=null,this._curFrameDownList.length=0,this._curFrameDownList=null,this._curFrameUpList.length=0,this._curFrameUpList=null,this._engine=null},s._onBlur=function(){this._curHeldDownKeyToIndexMap.length=0,this._curFrameHeldDownList.length=0,this._curFrameDownList.length=0,this._curFrameUpList.length=0,this._nativeEvents.length=0},s._onKeyEvent=function(t){this._nativeEvents.push(t)},s._addEventListener=function(){var t=this,e=t._target;e.addEventListener("keydown",this._onKeyEvent),e.addEventListener("keyup",this._onKeyEvent),e.addEventListener("blur",this._onBlur)},s._removeEventListener=function(){var t=this,e=t._target;e.removeEventListener("keydown",this._onKeyEvent),e.removeEventListener("keyup",this._onKeyEvent),e.removeEventListener("blur",this._onBlur)},n}(),zt;(function(n){n[n.None=0]="None",n[n.Color=1]="Color",n[n.Depth=2]="Depth",n[n.Stencil=4]="Stencil",n[n.ColorDepth=3]="ColorDepth",n[n.ColorStencil=5]="ColorStencil",n[n.DepthStencil=6]="DepthStencil",n[n.All=7]="All"})(zt||(zt={}));var Zt=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._index=-1,e._shapes=[],e._updateFlag=e.entity.transform.registerWorldChangeFlag(),e}var i=s.prototype;return i.addShape=function(e){var r=e._collider;r!==this&&(r&&r.removeShape(e),this._shapes.push(e),e._collider=this,this._nativeCollider.addShape(e._nativeShape),this._phasedActiveInScene&&this.scene.physics._addColliderShape(e))},i.removeShape=function(e){var r=this._shapes.indexOf(e);r!==-1&&(this._shapes.splice(r,1),this._phasedActiveInScene&&this.scene.physics._removeColliderShape(e),e._collider=null,this._nativeCollider.removeShape(e._nativeShape))},i.clearShapes=function(){for(var e=this._shapes,r=0,a=e.length;r<a;r++){var o=e[r];this._phasedActiveInScene&&this.scene.physics._removeColliderShape(o),o._destroy(),this._nativeCollider.removeShape(o._nativeShape)}e.length=0},i._onUpdate=function(){if(this._updateFlag.flag){var e=this.entity.transform;this._nativeCollider.setWorldTransform(e.worldPosition,e.worldRotationQuaternion);for(var r=e.lossyWorldScale,a=0,o=this.shapes.length;a<o;a++)this.shapes[a]._nativeShape.setWorldScale(r);this._updateFlag.flag=!1}},i._onLateUpdate=function(){},i._onEnableInScene=function(){var e=this.scene.physics;e._addCollider(this);for(var r=this.shapes,a=0,o=r.length;a<o;a++)e._addColliderShape(r[a])},i._onDisableInScene=function(){var e=this.scene.physics;e._removeCollider(this);for(var r=this.shapes,a=0,o=r.length;a<o;a++)e._removeColliderShape(r[a])},i._cloneTo=function(e){for(var r=e._shapes,a=0,o=r.length;a<o;a++)e._addPhysicsShape(r[a])},i._onDestroy=function(){n.prototype._onDestroy.call(this),this.clearShapes(),this._nativeCollider.destroy()},i._addPhysicsShape=function(e){e._collider=this,this._nativeCollider.addShape(e._nativeShape),this._phasedActiveInScene&&this.scene.physics._addColliderShape(e)},j(s,[{key:"shapes",get:function(){return this._shapes}}]),s}(Rt);T([F],Zt.prototype,"_index",void 0);T([F],Zt.prototype,"_nativeCollider",void 0);T([F],Zt.prototype,"_updateFlag",void 0);T([J],Zt.prototype,"_shapes",void 0);Zt=T([ka(ge,Hn.CheckOnly)],Zt);var au=function(){},Gt=function(){function n(i){var t=this;this._restTime=0,this._fixedTimeStep=1/60,this._colliders=new He,this._gravity=new R(0,-9.81,0),this._onContactEnter=function(r,a){var o=t._scene.engine._physicalObjectsMap,c=o[r],l=o[a];c.collider.entity._scripts.forEach(function(_){var u=n._collision;u.shape=l,_.onCollisionEnter(u)},function(_,u){_._entityScriptsIndex=u}),l.collider.entity._scripts.forEach(function(_){var u=n._collision;u.shape=c,_.onCollisionEnter(u)},function(_,u){_._entityScriptsIndex=u})},this._onContactExit=function(r,a){var o=t._scene.engine._physicalObjectsMap,c=o[r],l=o[a];c.collider.entity._scripts.forEach(function(_){var u=n._collision;u.shape=l,_.onCollisionExit(u)},function(_,u){_._entityScriptsIndex=u}),l.collider.entity._scripts.forEach(function(_){var u=n._collision;u.shape=c,_.onCollisionExit(u)},function(_,u){_._entityScriptsIndex=u})},this._onContactStay=function(r,a){var o=t._scene.engine._physicalObjectsMap,c=o[r],l=o[a];c.collider.entity._scripts.forEach(function(_){var u=n._collision;u.shape=l,_.onCollisionStay(u)},function(_,u){_._entityScriptsIndex=u}),l.collider.entity._scripts.forEach(function(_){var u=n._collision;u.shape=c,_.onCollisionStay(u)},function(_,u){_._entityScriptsIndex=u})},this._onTriggerEnter=function(r,a){var o=t._scene.engine._physicalObjectsMap,c=o[r],l=o[a];c.collider.entity._scripts.forEach(function(_){_.onTriggerEnter(l)},function(_,u){_._entityScriptsIndex=u}),l.collider.entity._scripts.forEach(function(_){_.onTriggerEnter(c)},function(_,u){_._entityScriptsIndex=u})},this._onTriggerExit=function(r,a){var o=t._scene.engine._physicalObjectsMap,c=o[r],l=o[a];c.collider.entity._scripts.forEach(function(_){_.onTriggerExit(l)},function(_,u){_._entityScriptsIndex=u}),l.collider.entity._scripts.forEach(function(_){_.onTriggerExit(c)},function(_,u){_._entityScriptsIndex=u})},this._onTriggerStay=function(r,a){var o=t._scene.engine._physicalObjectsMap,c=o[r],l=o[a];c.collider.entity._scripts.forEach(function(_){_.onTriggerStay(l)},function(_,u){_._entityScriptsIndex=u}),l.collider.entity._scripts.forEach(function(_){_.onTriggerStay(c)},function(_,u){_._entityScriptsIndex=u})},this._scene=i,this._setGravity=this._setGravity.bind(this),this._gravity._onValueChanged=this._setGravity;var e=i.engine;e._physicsInitialized&&(this._nativePhysicsScene=n._nativePhysics.createPhysicsScene(e._nativePhysicsManager,this._onContactEnter,this._onContactExit,this._onContactStay,this._onTriggerEnter,this._onTriggerExit,this._onTriggerStay))}var s=n.prototype;return s.raycast=function(t,e,r,a){var o=this,c,l=Number.MAX_VALUE;typeof e=="number"?l=e:e!=null&&(c=e);var _=An.Everything;typeof r=="number"?_=r:r!=null&&(c=r),a&&(c=a);var u=function(d){var f=o._scene.engine._physicalObjectsMap[d];return f?f.collider.entity.layer&_&&f.isSceneQuery:!1};if(c!=null){var h=this._nativePhysicsScene.raycast(t,l,u,function(d,f,v,p){var g=o._scene.engine._physicalObjectsMap[d];c.entity=g._collider.entity,c.shape=g,c.distance=f,c.normal.copyFrom(p),c.point.copyFrom(v)});return h?!0:(c.entity=null,c.shape=null,c.distance=0,c.point.set(0,0,0),c.normal.set(0,0,0),!1)}else return this._nativePhysicsScene.raycast(t,l,u)},s._update=function(t){var e=this,r=e._fixedTimeStep,a=e._nativePhysicsScene,o=this._scene._componentsManager,c=this._restTime+t,l=Math.floor(c/r);this._restTime=c-l*r;for(var _=0;_<l;_++)o.callScriptOnPhysicsUpdate(),this._callColliderOnUpdate(),a.update(r),this._callColliderOnLateUpdate()},s._addColliderShape=function(t){this._scene.engine._physicalObjectsMap[t.id]=t,this._nativePhysicsScene.addColliderShape(t._nativeShape)},s._removeColliderShape=function(t){delete this._scene.engine._physicalObjectsMap[t.id],this._nativePhysicsScene.removeColliderShape(t._nativeShape)},s._addCollider=function(t){t._index===-1&&(t._index=this._colliders.length,this._colliders.add(t)),this._nativePhysicsScene.addCollider(t._nativeCollider)},s._addCharacterController=function(t){t._index===-1&&(t._index=this._colliders.length,this._colliders.add(t)),this._nativePhysicsScene.addCharacterController(t._nativeCollider)},s._removeCollider=function(t){var e=this._colliders.deleteByIndex(t._index);e&&(e._index=t._index),t._index=-1,this._nativePhysicsScene.removeCollider(t._nativeCollider)},s._removeCharacterController=function(t){var e=this._colliders.deleteByIndex(t._index);e&&(e._index=t._index),t._index=-1,this._nativePhysicsScene.removeCharacterController(t._nativeCollider)},s._callColliderOnUpdate=function(){for(var t=this._colliders._elements,e=this._colliders.length-1;e>=0;--e)t[e]._onUpdate()},s._callColliderOnLateUpdate=function(){for(var t=this._colliders._elements,e=this._colliders.length-1;e>=0;--e)t[e]._onLateUpdate()},s._gc=function(){this._colliders.garbageCollection()},s._setGravity=function(){this._nativePhysicsScene.setGravity(this._gravity)},j(n,[{key:"gravity",get:function(){return this._gravity},set:function(t){var e=this._gravity;e!==t&&e.copyFrom(t)}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(t){this._fixedTimeStep=Math.max(t,k.zeroTolerance)}}]),n}();(function(){Gt._collision=new au})();var yi;(function(n){n[n.PreventClimbing=0]="PreventClimbing",n[n.PreventClimbingAndForceSliding=1]="PreventClimbingAndForceSliding"})(yi||(yi={}));var iu=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._stepOffset=.5,e._nonWalkableMode=yi.PreventClimbing,e._upDirection=new R(0,1,0),e._slopeLimit=.707,e._nativeCollider=Gt._nativePhysics.createCharacterController(),e._setUpDirection=e._setUpDirection.bind(ce(e)),e._upDirection._onValueChanged=e._setUpDirection,e}var i=s.prototype;return i.move=function(e,r,a){return this._nativeCollider.move(e,r,a)},i.addShape=function(e){if(this._shapes.length>0)throw"only allow single shape on controller!";n.prototype.addShape.call(this,e),this._updateFlag.flag=!0},i.clearShapes=function(){this._shapes.length>0&&n.prototype.removeShape.call(this,this._shapes[0])},i._onUpdate=function(){if(this._updateFlag.flag){var e=this.entity.transform,r=this.shapes;this._nativeCollider.setWorldPosition(e.worldPosition);for(var a=e.lossyWorldScale,o=0,c=r.length;o<c;o++)r[o]._nativeShape.setWorldScale(a);this._updateFlag.flag=!1}},i._onLateUpdate=function(){var e=this.entity.transform.worldPosition;this._nativeCollider.getWorldPosition(e),this._updateFlag.flag=!1},i._onEnableInScene=function(){var e=this.scene.physics;e._addCharacterController(this);for(var r=this.shapes,a=0,o=r.length;a<o;a++)e._addColliderShape(r[a])},i._onDisableInScene=function(){var e=this.scene.physics;e._removeCharacterController(this);for(var r=this.shapes,a=0,o=r.length;a<o;a++)e._removeColliderShape(r[a])},i._setUpDirection=function(){this._nativeCollider.setUpDirection(this._upDirection)},j(s,[{key:"stepOffset",get:function(){return this._stepOffset},set:function(e){this._stepOffset!==e&&(this._stepOffset=e,this._nativeCollider.setStepOffset(e))}},{key:"nonWalkableMode",get:function(){return this._nonWalkableMode},set:function(e){this._nonWalkableMode!==e&&(this._nonWalkableMode=e,this._nativeCollider.setNonWalkableMode(e))}},{key:"upDirection",get:function(){return this._upDirection},set:function(e){this._upDirection!==e&&this._upDirection.copyFrom(e)}},{key:"slopeLimit",get:function(){return this._slopeLimit},set:function(e){this._slopeLimit!==e&&(this._slopeLimit=e,this._nativeCollider.setSlopeLimit(e))}}]),s}(Zt),Ht=function(n){W(s,n);function s(t){var e;e=n.call(this,t)||this,e._linearDamping=0,e._angularDamping=.05,e._linearVelocity=new R,e._angularVelocity=new R,e._mass=1,e._centerOfMass=new R,e._inertiaTensor=new R(1,1,1),e._maxAngularVelocity=100,e._maxDepenetrationVelocity=1e3,e._solverIterations=4,e._isKinematic=!1,e._constraints=0,e._collisionDetectionMode=0,e._sleepThreshold=.005;var r=e.entity.transform;return e._nativeCollider=Gt._nativePhysics.createDynamicCollider(r.worldPosition,r.worldRotationQuaternion),e._setLinearVelocity=e._setLinearVelocity.bind(ce(e)),e._setAngularVelocity=e._setAngularVelocity.bind(ce(e)),e._setCenterOfMass=e._setCenterOfMass.bind(ce(e)),e._setInertiaTensor=e._setInertiaTensor.bind(ce(e)),e._linearVelocity._onValueChanged=e._setLinearVelocity,e._angularVelocity._onValueChanged=e._setAngularVelocity,e._centerOfMass._onValueChanged=e._setCenterOfMass,e._inertiaTensor._onValueChanged=e._setInertiaTensor,e}var i=s.prototype;return i.applyForce=function(e){this._nativeCollider.addForce(e)},i.applyTorque=function(e){this._nativeCollider.addTorque(e)},i.move=function(e,r){this._nativeCollider.move(e,r)},i.sleep=function(){this._nativeCollider.sleep()},i.wakeUp=function(){this._nativeCollider.wakeUp()},i._onLateUpdate=function(){var e=this.entity.transform,r=e.worldPosition,a=e.worldRotationQuaternion;this._nativeCollider.getWorldTransform(r,a),this._updateFlag.flag=!1},i._cloneTo=function(e){n.prototype._cloneTo.call(this,e),e.linearDamping=this.linearDamping,e.angularDamping=this.angularDamping,e.linearVelocity=this.linearVelocity,e.angularVelocity=this.angularVelocity,e.mass=this.mass,e.centerOfMass=this.centerOfMass,e.inertiaTensor=this.inertiaTensor,e.maxAngularVelocity=this.maxAngularVelocity,e.maxDepenetrationVelocity=this.maxDepenetrationVelocity,e.sleepThreshold=this.sleepThreshold,e.solverIterations=this.solverIterations,e.isKinematic=this.isKinematic,e.constraints=this.constraints,e.collisionDetectionMode=this.collisionDetectionMode},i._setLinearVelocity=function(){this._nativeCollider.setLinearVelocity(this._linearVelocity)},i._setAngularVelocity=function(){this._nativeCollider.setAngularVelocity(this._angularVelocity)},i._setCenterOfMass=function(){this._nativeCollider.setCenterOfMass(this._centerOfMass)},i._setInertiaTensor=function(){this._nativeCollider.setInertiaTensor(this._inertiaTensor)},j(s,[{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping!==e&&(this._linearDamping=e,this._nativeCollider.setLinearDamping(e))}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping!==e&&(this._angularDamping=e,this._nativeCollider.setAngularDamping(e))}},{key:"linearVelocity",get:function(){return this._linearVelocity},set:function(e){this._linearVelocity!==e&&this._linearVelocity.copyFrom(e)}},{key:"angularVelocity",get:function(){return this._angularVelocity},set:function(e){this._angularVelocity!==e&&this._angularVelocity.copyFrom(e)}},{key:"mass",get:function(){return this._mass},set:function(e){this._mass!==e&&(this._mass=e,this._nativeCollider.setMass(e))}},{key:"centerOfMass",get:function(){return this._centerOfMass},set:function(e){this._centerOfMass!==e&&this._centerOfMass.copyFrom(e)}},{key:"inertiaTensor",get:function(){return this._inertiaTensor},set:function(e){this._inertiaTensor!==e&&this._inertiaTensor.copyFrom(e)}},{key:"maxAngularVelocity",get:function(){return this._maxAngularVelocity},set:function(e){this._maxAngularVelocity!==e&&(this._maxAngularVelocity=e,this._nativeCollider.setMaxAngularVelocity(e))}},{key:"maxDepenetrationVelocity",get:function(){return this._maxDepenetrationVelocity},set:function(e){this._maxDepenetrationVelocity!==e&&(this._maxDepenetrationVelocity=e,this._nativeCollider.setMaxDepenetrationVelocity(e))}},{key:"sleepThreshold",get:function(){return this._sleepThreshold},set:function(e){e!==this._sleepThreshold&&(this._sleepThreshold=e,this._nativeCollider.setSleepThreshold(e))}},{key:"solverIterations",get:function(){return this._solverIterations},set:function(e){this._solverIterations!==e&&(this._solverIterations=e,this._nativeCollider.setSolverIterations(e))}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic!==e&&(this._isKinematic=e,this._nativeCollider.setIsKinematic(e))}},{key:"constraints",get:function(){return this._constraints},set:function(e){this._constraints!==e&&(this._constraints=e,this._nativeCollider.setConstraints(e))}},{key:"collisionDetectionMode",get:function(){return this._collisionDetectionMode},set:function(e){this._collisionDetectionMode!==e&&(this._collisionDetectionMode=e,this._nativeCollider.setCollisionDetectionMode(e))}}]),s}(Zt);T([F],Ht.prototype,"_linearDamping",void 0);T([F],Ht.prototype,"_angularDamping",void 0);T([F],Ht.prototype,"_linearVelocity",void 0);T([F],Ht.prototype,"_angularVelocity",void 0);T([F],Ht.prototype,"_mass",void 0);T([F],Ht.prototype,"_centerOfMass",void 0);T([F],Ht.prototype,"_inertiaTensor",void 0);T([F],Ht.prototype,"_maxAngularVelocity",void 0);T([F],Ht.prototype,"_maxDepenetrationVelocity",void 0);T([F],Ht.prototype,"_solverIterations",void 0);T([F],Ht.prototype,"_isKinematic",void 0);T([F],Ht.prototype,"_constraints",void 0);T([F],Ht.prototype,"_collisionDetectionMode",void 0);T([F],Ht.prototype,"_sleepThreshold",void 0);var so;(function(n){n[n.Discrete=0]="Discrete",n[n.Continuous=1]="Continuous",n[n.ContinuousDynamic=2]="ContinuousDynamic",n[n.ContinuousSpeculative=3]="ContinuousSpeculative"})(so||(so={}));var co;(function(n){n[n.None=0]="None",n[n.FreezePositionX=1]="FreezePositionX",n[n.FreezePositionY=2]="FreezePositionY",n[n.FreezePositionZ=4]="FreezePositionZ",n[n.FreezeRotationX=8]="FreezeRotationX",n[n.FreezeRotationY=16]="FreezeRotationY",n[n.FreezeRotationZ=32]="FreezeRotationZ"})(co||(co={}));var Lc=function(){this.entity=null,this.distance=0,this.point=new R,this.normal=new R,this.shape=null},La;(function(n){n[n.Average=0]="Average",n[n.Minimum=1]="Minimum",n[n.Multiply=2]="Multiply",n[n.Maximum=3]="Maximum"})(La||(La={}));var Vc=function(){function n(){this._bounciness=.1,this._dynamicFriction=.1,this._staticFriction=.1,this._bounceCombine=La.Average,this._frictionCombine=La.Average,this._nativeMaterial=Gt._nativePhysics.createPhysicsMaterial(this._staticFriction,this._dynamicFriction,this._bounciness,this._bounceCombine,this._frictionCombine)}var s=n.prototype;return s._destroy=function(){!this._destroyed&&this._nativeMaterial.destroy(),this._destroyed=!0},j(n,[{key:"bounciness",get:function(){return this._bounciness},set:function(t){this._bounciness!==t&&(this._bounciness=t,this._nativeMaterial.setBounciness(t))}},{key:"dynamicFriction",get:function(){return this._dynamicFriction},set:function(t){this._dynamicFriction!==t&&(this._dynamicFriction=t,this._nativeMaterial.setDynamicFriction(t))}},{key:"staticFriction",get:function(){return this._staticFriction},set:function(t){this._staticFriction!==t&&(this._staticFriction=t,this._nativeMaterial.setStaticFriction(t))}},{key:"bounceCombine",get:function(){return this._bounceCombine},set:function(t){this._bounceCombine!==t&&(this._bounceCombine=t,this._nativeMaterial.setBounceCombine(t))}},{key:"frictionCombine",get:function(){return this._frictionCombine},set:function(t){this._frictionCombine!==t&&(this._frictionCombine=t,this._nativeMaterial.setFrictionCombine(t))}}]),n}(),ou=function(n){W(s,n);function s(i){var t;t=n.call(this,i)||this;var e=t.entity.transform;return t._nativeCollider=Gt._nativePhysics.createStaticCollider(e.worldPosition,e.worldRotationQuaternion),t}return s}(Zt),xi;(function(n){n[n.X=0]="X",n[n.Y=1]="Y",n[n.Z=2]="Z"})(xi||(xi={}));var lo;(function(n){n[n.Sides=1]="Sides",n[n.Up=2]="Up",n[n.Down=4]="Down"})(lo||(lo={}));var Vr=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._colliderInfo=new is,e._connectedColliderInfo=new is,e._force=0,e._torque=0,e._connectedColliderInfo.localPosition=new R,e}var i=s.prototype;return i._cloneTo=function(e){e.connectedCollider=this.connectedCollider,e.connectedAnchor=this.connectedAnchor,e.connectedMassScale=this.connectedMassScale,e.connectedInertiaScale=this.connectedInertiaScale,e.massScale=this.massScale,e.inertiaScale=this.inertiaScale,e.breakForce=this.breakForce,e.breakTorque=this.breakTorque},j(s,[{key:"connectedCollider",get:function(){return this._connectedColliderInfo.collider},set:function(e){this._connectedColliderInfo.collider!==e&&(this._connectedColliderInfo.collider=e,this._nativeJoint.setConnectedCollider(e._nativeCollider))}},{key:"connectedAnchor",get:function(){return this._connectedColliderInfo.localPosition},set:function(e){var r=this._connectedColliderInfo.localPosition;e!==r&&r.copyFrom(e),this._nativeJoint.setConnectedAnchor(e)}},{key:"connectedMassScale",get:function(){return this._connectedColliderInfo.massScale},set:function(e){e!==this._connectedColliderInfo.massScale&&(this._connectedColliderInfo.massScale=e,this._nativeJoint.setConnectedMassScale(e))}},{key:"connectedInertiaScale",get:function(){return this._connectedColliderInfo.inertiaScale},set:function(e){e!==this._connectedColliderInfo.inertiaScale&&(this._connectedColliderInfo.inertiaScale=e,this._nativeJoint.setConnectedInertiaScale(e))}},{key:"massScale",get:function(){return this._colliderInfo.massScale},set:function(e){e!==this._colliderInfo.massScale&&(this._colliderInfo.massScale=e,this._nativeJoint.setMassScale(e))}},{key:"inertiaScale",get:function(){return this._colliderInfo.inertiaScale},set:function(e){e!==this._colliderInfo.inertiaScale&&(this._colliderInfo.inertiaScale=e,this._nativeJoint.setInertiaScale(e))}},{key:"breakForce",get:function(){return this._force},set:function(e){e!==this._force&&(this._force=e,this._nativeJoint.setBreakForce(e))}},{key:"breakTorque",get:function(){return this._torque},set:function(e){e!==this._torque&&(this._torque=e,this._nativeJoint.setBreakTorque(e))}}]),s}(Rt);T([F],Vr.prototype,"_colliderInfo",void 0);T([F],Vr.prototype,"_connectedColliderInfo",void 0);T([F],Vr.prototype,"_nativeJoint",void 0);T([F],Vr.prototype,"_force",void 0);T([F],Vr.prototype,"_torque",void 0);Vr=T([ka(Zt,Hn.CheckOnly)],Vr);var is=function(){this.collider=null,this.massScale=0,this.inertiaScale=0},su=function(n){W(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i._onAwake=function(){var e=this._colliderInfo;e.collider=this.entity.getComponent(Zt),this._nativeJoint=Gt._nativePhysics.createFixedJoint(e.collider._nativeCollider)},s}(Vr),Wt;(function(n){n[n.None=0]="None",n[n.LimitEnabled=1]="LimitEnabled",n[n.DriveEnabled=2]="DriveEnabled",n[n.DriveFreeSpin=4]="DriveFreeSpin"})(Wt||(Wt={}));var ga=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t._axis=new R(1,0,0),t._hingeFlags=Wt.None,t._useSpring=!1,t}var i=s.prototype;return i._onAwake=function(){var e=this._colliderInfo;e.localPosition=new R,e.collider=this.entity.getComponent(Zt),this._nativeJoint=Gt._nativePhysics.createHingeJoint(e.collider._nativeCollider)},i._cloneTo=function(e){e.axis=this.axis,e.swingOffset=this.swingOffset,e.useLimits=this.useLimits,e.useMotor=this.useMotor,e.useSpring=this.useSpring,e.motor=this.motor,e.limits=this.limits},j(s,[{key:"axis",get:function(){return this._axis},set:function(e){var r=this._axis;e!==r&&r.copyFrom(e),this._nativeJoint.setAxis(r)}},{key:"swingOffset",get:function(){return this._colliderInfo.localPosition},set:function(e){var r=this._colliderInfo.localPosition;e!==r&&r.copyFrom(e),this._nativeJoint.setSwingOffset(r)}},{key:"angle",get:function(){return this._nativeJoint.getAngle()}},{key:"velocity",get:function(){return this._nativeJoint.getVelocity()}},{key:"useLimits",get:function(){return(this._hingeFlags&Wt.LimitEnabled)==Wt.LimitEnabled},set:function(e){e!==this.useLimits&&(e?this._hingeFlags|=Wt.LimitEnabled:this._hingeFlags&=~Wt.LimitEnabled,this._nativeJoint.setHingeJointFlag(Wt.LimitEnabled,e))}},{key:"useMotor",get:function(){return(this._hingeFlags&Wt.DriveEnabled)==Wt.DriveEnabled},set:function(e){e!==this.useMotor&&(e?this._hingeFlags|=Wt.DriveEnabled:this._hingeFlags&=~Wt.DriveEnabled,this._nativeJoint.setHingeJointFlag(Wt.DriveEnabled,e))}},{key:"useSpring",get:function(){return this._useSpring},set:function(e){this._useSpring!==e&&(this._useSpring=e,this.limits=this._limits)}},{key:"motor",get:function(){return this._jointMonitor},set:function(e){this._jointMonitor!==e&&(this._jointMonitor=e,this._nativeJoint.setDriveVelocity(e.targetVelocity),this._nativeJoint.setDriveForceLimit(e.forceLimit),this._nativeJoint.setDriveGearRatio(e.gearRation),this._nativeJoint.setHingeJointFlag(Wt.DriveFreeSpin,e.freeSpin))}},{key:"limits",get:function(){return this._limits},set:function(e){this._limits!==e&&(this._limits=e,this.useSpring?this._nativeJoint.setSoftLimit(e.min,e.max,e.stiffness,e.damping):this._nativeJoint.setHardLimit(e.min,e.max,e.contactDistance))}}]),s}(Vr);T([F],ga.prototype,"_axis",void 0);T([F],ga.prototype,"_hingeFlags",void 0);T([F],ga.prototype,"_useSpring",void 0);T([F],ga.prototype,"_jointMonitor",void 0);T([F],ga.prototype,"_limits",void 0);var cu=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t._minDistance=0,t._maxDistance=0,t._tolerance=.25,t._stiffness=0,t._damping=0,t}var i=s.prototype;return i._onAwake=function(){var e=this._colliderInfo;e.localPosition=new R,e.collider=this.entity.getComponent(Zt),this._nativeJoint=Gt._nativePhysics.createSpringJoint(e.collider._nativeCollider)},i._cloneTo=function(e){e.swingOffset=this.swingOffset,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.tolerance=this.tolerance,e.stiffness=this.stiffness,e.damping=this.damping},j(s,[{key:"swingOffset",get:function(){return this._colliderInfo.localPosition},set:function(e){var r=this._colliderInfo.localPosition;e!==r&&r.copyFrom(e),this._nativeJoint.setSwingOffset(e)}},{key:"minDistance",get:function(){return this._minDistance},set:function(e){this._minDistance!==e&&(this._minDistance=e,this._nativeJoint.setMinDistance(e))}},{key:"maxDistance",get:function(){return this._maxDistance},set:function(e){this._maxDistance!==e&&(this._maxDistance=e,this._nativeJoint.setMaxDistance(e))}},{key:"tolerance",get:function(){return this._tolerance},set:function(e){this._tolerance!==e&&(this._tolerance=e,this._nativeJoint.setTolerance(e))}},{key:"stiffness",get:function(){return this._stiffness},set:function(e){this._stiffness!==e&&(this._stiffness=e,this._nativeJoint.setStiffness(e))}},{key:"damping",get:function(){return this._damping},set:function(e){this._damping!==e&&(this._damping=e,this._nativeJoint.setDamping(e))}}]),s}(Vr),lu=function(){this.max=0,this.min=0,this.contactDistance=-1,this.stiffness=0,this.damping=0},_u=function(){this.targetVelocity=0,this.forceLimit=Number.MAX_VALUE,this.gearRation=1,this.freeSpin=!1},er=function(){function n(){this._isTrigger=!1,this._rotation=new R,this._position=new R,this._contactOffset=.02,this.isSceneQuery=!0,this._material=new Vc,this._id=n._idGenerator++,this._setRotation=this._setRotation.bind(this),this._setPosition=this._setPosition.bind(this),this._rotation._onValueChanged=this._setRotation,this._position._onValueChanged=this._setPosition}var s=n.prototype;return s._cloneTo=function(t){t.contactOffset=this.contactOffset,t.rotation=this.rotation,t.position=this.position,t.isTrigger=this.isTrigger,t.material=this.material},s._destroy=function(){this._material._destroy(),this._nativeShape.destroy()},s._setPosition=function(){this._nativeShape.setPosition(this._position)},s._setRotation=function(){this._nativeShape.setRotation(this._rotation)},j(n,[{key:"collider",get:function(){return this._collider}},{key:"id",get:function(){return this._id}},{key:"contactOffset",get:function(){return this._contactOffset},set:function(t){this._contactOffset!==t&&(this._contactOffset=t,this._nativeShape.setContactOffset(t))}},{key:"material",get:function(){return this._material},set:function(t){this._material!==t&&(this._material=t,this._nativeShape.setMaterial(t._nativeMaterial))}},{key:"rotation",get:function(){return this._rotation},set:function(t){this._rotation!=t&&this._rotation.copyFrom(t)}},{key:"position",get:function(){return this._position},set:function(t){this._position!==t&&this._position.copyFrom(t)}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(t){this._isTrigger!==t&&(this._isTrigger=t,this._nativeShape.setIsTrigger(t))}}]),n}();(function(){er._idGenerator=0})();T([F],er.prototype,"_collider",void 0);T([F],er.prototype,"_nativeShape",void 0);T([F],er.prototype,"_id",void 0);T([F],er.prototype,"_material",void 0);T([F],er.prototype,"_isTrigger",void 0);T([F],er.prototype,"_rotation",void 0);T([F],er.prototype,"_position",void 0);T([F],er.prototype,"_contactOffset",void 0);var Fc=function(n){W(s,n);function s(){var t;return t=n.call(this)||this,t._size=new R(1,1,1),t._nativeShape=Gt._nativePhysics.createBoxColliderShape(t._id,t._size,t._material._nativeMaterial),t._setSize=t._setSize.bind(ce(t)),t._size._onValueChanged=t._setSize,t}var i=s.prototype;return i._cloneTo=function(e){n.prototype._cloneTo.call(this,e),e.size=this.size},i._setSize=function(){this._nativeShape.setSize(this._size)},j(s,[{key:"size",get:function(){return this._size},set:function(e){this._size!==e&&this._size.copyFrom(e)}}]),s}(er);T([F],Fc.prototype,"_size",void 0);var Nc=function(n){W(s,n);function s(){var t;return t=n.call(this)||this,t._radius=1,t._nativeShape=Gt._nativePhysics.createSphereColliderShape(t._id,t._radius,t._material._nativeMaterial),t}var i=s.prototype;return i._cloneTo=function(e){n.prototype._cloneTo.call(this,e),e.radius=this.radius},j(s,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=e,this._nativeShape.setRadius(e))}}]),s}(er);T([F],Nc.prototype,"_radius",void 0);var uu=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._nativeShape=Gt._nativePhysics.createPlaneColliderShape(i._id,i._material._nativeMaterial),i}return s}(er),Wi=function(n){W(s,n);function s(){var t;return t=n.call(this)||this,t._radius=1,t._height=2,t._upAxis=xi.Y,t._nativeShape=Gt._nativePhysics.createCapsuleColliderShape(t._id,t._radius,t._height,t._material._nativeMaterial),t}var i=s.prototype;return i._cloneTo=function(e){n.prototype._cloneTo.call(this,e),e.radius=this.radius,e.height=this.height,e.upAxis=this.upAxis},j(s,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=e,this._nativeShape.setRadius(e))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._height=e,this._nativeShape.setHeight(e))}},{key:"upAxis",get:function(){return this._upAxis},set:function(e){this._upAxis!==e&&(this._upAxis=e,this._nativeShape.setUpAxis(e))}}]),s}(er);T([F],Wi.prototype,"_radius",void 0);T([F],Wi.prototype,"_height",void 0);T([F],Wi.prototype,"_upAxis",void 0);var Xi=function(){function n(i,t){if(this._pointers=[],this._multiPointerEnabled=!0,this._buttons=ra.None,this._upMap=[],this._downMap=[],this._upList=new He,this._downList=new He,this._nativeEvents=[],typeof Window<"u"&&lt(t,Window))throw"Do not set window as target because window cannot listen to pointer leave event.";this._engine=i,this._target=t,this._canvas=i.canvas,this._htmlCanvas=i._canvas._webCanvas,this._pointerPool=new Array(11),this._onPointerEvent=this._onPointerEvent.bind(this),this._addEventListener()}var s=n.prototype;return s._update=function(){for(var t=this,e=t._pointers,r=t._nativeEvents,a=t._htmlCanvas,o=this._canvas,c=o.width,l=o.height,_=a.clientWidth,u=a.clientHeight,h=a.getBoundingClientRect(),d=h.left,f=h.top,v=c/_,p=l/u,g=e.length-1;g>=0;g--)e[g].phase===ar.Leave&&e.splice(g,1);for(var y=0,m=r.length;y<m;y++){var x=r[y],C=x.pointerId,b=this._getPointerByID(C);if(b)b._events.push(x);else{var A=e.length;if(A===0||this._multiPointerEnabled){for(var S,w,E=this,P=E._pointerPool,M=0;M<A&&!(e[M].id>M);M++);b=(S=P)[w=M]||(S[w]=new Dc(M)),b._uniqueID=C,b._events.push(x),b.position.set((x.clientX-d)*v,(x.clientY-f)*p),e.splice(M,0,b)}}}r.length=0,this._upList.length=this._downList.length=0,this._buttons=ra.None;for(var D=this._engine.time.frameCount,L=0,V=e.length;L<V;L++){var N=e[L];N._upList.length=N._downList.length=0,this._updatePointerInfo(D,N,d,f,v,p),this._buttons|=N.pressedButtons}},s._firePointerScript=function(t){for(var e=this,r=e._pointers,a=e._canvas,o=0,c=r.length;o<c;o++){var l=r[o],_=l._events,u=l.position;l._firePointerDrag();var h=this._pointerRayCast(t,u.x/a.width,u.y/a.height);l._firePointerExitAndEnter(h);var d=_.length;if(d>0){for(var f=0;f<d;f++){var v=_[f];switch(v.type){case"pointerdown":l.phase=ar.Down,l._firePointerDown(h);break;case"pointerup":l.phase=ar.Up,l._firePointerUpAndClick(h);break;case"pointerleave":case"pointercancel":l.phase=ar.Leave,l._firePointerExitAndEnter(null);break}}_.length=0}}},s._destroy=function(){this._removeEventListener(),this._pointerPool.length=0,this._nativeEvents.length=0,this._downMap.length=0,this._upMap.length=0},s._onPointerEvent=function(t){this._nativeEvents.push(t)},s._getPointerByID=function(t){for(var e=this,r=e._pointers,a=r.length-1;a>=0;a--)if(r[a]._uniqueID===t)return r[a];return null},s._updatePointerInfo=function(t,e,r,a,o,c){var l=e._events,_=e.position,u=l.length;if(u>0){var h=this,d=h._upList,f=h._upMap,v=h._downList,p=h._downMap,g=l[u-1],y=(g.clientX-r)*o,m=(g.clientY-a)*c;e.deltaPosition.set(y-_.x,m-_.y),_.set(y,m);for(var x=0;x<u;x++){var C=l[x],b=C.button;switch(e.button=ru[b]||ra.None,e.pressedButtons=C.buttons,C.type){case"pointerdown":v.add(b),p[b]=t,e._downList.add(b),e._downMap[b]=t,e.phase=ar.Down;break;case"pointerup":d.add(b),f[b]=t,e._upList.add(b),e._upMap[b]=t,e.phase=ar.Up;break;case"pointermove":e.phase=ar.Move;break;case"pointerleave":case"pointercancel":e.phase=ar.Leave}}this._engine._physicsInitialized||(l.length=0)}else e.deltaPosition.set(0,0),e.phase=ar.Stationary},s._pointerRayCast=function(t,e,r){for(var a=n._tempPoint,o=n._tempRay,c=n._tempHitResult,l=t.length-1;l>=0;l--){var _=t[l];if(!(!_.isActive||_.destroyed))for(var u=_._componentsManager,h=u._activeCameras,d=h._elements,f=h.length-1;f>=0;f--){var v=d[f];if(!v.renderTarget){var p=v.viewport,g=p.x,y=p.y,m=p.z,x=p.w;if(e>=g&&r>=y&&e-g<=m&&r-y<=x){if(a.set((e-g)/m,(r-y)/x),_.physics.raycast(v.viewportPointToRay(a,o),Number.MAX_VALUE,v.cullingMask,c))return c.entity;if(v.clearFlags&zt.Color)return null}}}}return null},s._addEventListener=function(){var t=this,e=t._target,r=t._onPointerEvent;e.addEventListener("pointerdown",r),e.addEventListener("pointerup",r),e.addEventListener("pointerleave",r),e.addEventListener("pointermove",r),e.addEventListener("pointercancel",r)},s._removeEventListener=function(){var t=this,e=t._target,r=t._onPointerEvent;e.removeEventListener("pointerdown",r),e.removeEventListener("pointerup",r),e.removeEventListener("pointerleave",r),e.removeEventListener("pointermove",r),e.removeEventListener("pointercancel",r),this._nativeEvents.length=0,this._pointers.length=0,this._downList.length=0,this._upList.length=0},n}();(function(){Xi._tempRay=new ol})();(function(){Xi._tempPoint=new ee})();(function(){Xi._tempHitResult=new Lc})();var hu=function(){function n(i,t){this._delta=new R,this._nativeEvents=[],this._onWheelEvent=this._onWheelEvent.bind(this),this._target=t,this._addEventListener()}var s=n.prototype;return s._update=function(){var t=this,e=t._delta;e.set(0,0,0);var r=this,a=r._nativeEvents;if(a.length>0){for(var o=a.length-1;o>=0;o--){var c=a[o];e.x+=c.deltaX,e.y+=c.deltaY,e.z+=c.deltaZ}a.length=0}},s._addEventListener=function(){this._target.addEventListener("wheel",this._onWheelEvent)},s._removeEventListener=function(){this._target.removeEventListener("wheel",this._onWheelEvent),this._nativeEvents.length=0,this._delta.set(0,0,0)},s._destroy=function(){this._removeEventListener(),this._nativeEvents=null,this._delta=null},s._onWheelEvent=function(t){this._nativeEvents.push(t)},n}(),Ic=function(){function n(i,t){this._initialized=!1,this._engine=i;var e=i._canvas._webCanvas;if(typeof OffscreenCanvas>"u"||!lt(e,OffscreenCanvas)){var r,a,o,c;this._wheelManager=new hu(i,(c=(r=t)==null?void 0:r.wheelTarget)!=null?c:e);var l;this._pointerManager=new Xi(i,(l=(a=t)==null?void 0:a.pointerTarget)!=null?l:e);var _;this._keyboardManager=new nu(i,(_=(o=t)==null?void 0:o.keyboardTarget)!=null?_:window),this._initialized=!0}}var s=n.prototype;return s.isKeyHeldDown=function(t){return this._initialized?t===void 0?this._keyboardManager._curFrameHeldDownList.length>0:this._keyboardManager._curHeldDownKeyToIndexMap[t]!=null:!1},s.isKeyDown=function(t){return this._initialized?t===void 0?this._keyboardManager._curFrameDownList.length>0:this._keyboardManager._downKeyToFrameCountMap[t]===this._engine.time.frameCount:!1},s.isKeyUp=function(t){return this._initialized?t===void 0?this._keyboardManager._curFrameUpList.length>0:this._keyboardManager._upKeyToFrameCountMap[t]===this._engine.time.frameCount:!1},s.isPointerHeldDown=function(t){return this._initialized?t===void 0?this._pointerManager._buttons!==0:(this._pointerManager._buttons&t)!==0:!1},s.isPointerDown=function(t){return this._initialized?t===void 0?this._pointerManager._downList.length>0:this._pointerManager._downMap[as[t]]===this._engine.time.frameCount:!1},s.isPointerUp=function(t){return this._initialized?t===void 0?this._pointerManager._upList.length>0:this._pointerManager._upMap[as[t]]===this._engine.time.frameCount:!1},s._update=function(){this._initialized&&(this._wheelManager._update(),this._pointerManager._update(),this._keyboardManager._update())},s._firePointerScript=function(t){this._initialized&&this._pointerManager._firePointerScript(t)},s._destroy=function(){this._initialized&&(this._wheelManager._destroy(),this._wheelManager=null,this._pointerManager._destroy(),this._pointerManager=null,this._keyboardManager._destroy(),this._keyboardManager=null)},j(n,[{key:"pointers",get:function(){return this._initialized?this._pointerManager._pointers:[]}},{key:"multiPointerEnabled",get:function(){return this._initialized?this._pointerManager._multiPointerEnabled:!1},set:function(t){this._initialized&&(this._pointerManager._multiPointerEnabled=t)}},{key:"wheelDelta",get:function(){return this._initialized?this._wheelManager._delta:null}}]),n}(),_o;(function(n){n.cornerTextureCoordinate="a_CornerTextureCoordinate"})(_o||(_o={}));var nr;(function(n){n.ShapePositionStartLifeTime="a_ShapePositionStartLifeTime",n.DirectionTime="a_DirectionTime",n.StartColor="a_StartColor",n.StartSize="a_StartSize",n.StartRotation0="a_StartRotation0",n.StartSpeed="a_StartSpeed",n.Random0="a_Random0",n.Random1="a_Random1",n.SimulationWorldPosition="a_SimulationWorldPosition",n.SimulationWorldRotation="a_SimulationWorldRotation",n.SimulationUV="a_SimulationUV"})(nr||(nr={}));var du=function(s){this.billboardVertexElement=new Te(_o.cornerTextureCoordinate,0,$.Vector4,0),this.instanceVertexElements=[new Te(nr.ShapePositionStartLifeTime,0,$.Vector4,1,1),new Te(nr.DirectionTime,16,$.Vector4,1,1),new Te(nr.StartColor,32,$.Vector4,1,1),new Te(nr.StartSize,48,$.Vector3,1,1),new Te(nr.StartRotation0,60,$.Vector3,1,1),new Te(nr.StartSpeed,72,$.Float,1,1),new Te(nr.Random0,76,$.Vector4,1,1),new Te(nr.Random1,92,$.Vector4,1,1),new Te(nr.SimulationWorldPosition,108,$.Vector3,1,1),new Te(nr.SimulationWorldRotation,120,$.Vector4,1,1),new Te(nr.SimulationUV,136,$.Vector4,1,1)],this.instanceVertexStride=152,this.instanceVertexFloatStride=this.instanceVertexStride/4,this.startLifeTimeOffset=3,this.timeOffset=7,this.simulationUVOffset=34,this.billboardIndexCount=6;var i=16,t=new Jt(s,Mt.VertexBuffer,i*4,Je.Static,!1);t.isGCIgnored=!0,this.billboardVertexBufferBinding=new Wn(t,i);var e=new Jt(s,Mt.IndexBuffer,this.billboardIndexCount,Je.Static,!1);e.isGCIgnored=!0,this.billboardIndexBufferBinding=new Pa(e,St.UInt8);var r=new Float32Array([-.5,-.5,0,1,.5,-.5,1,1,.5,.5,1,0,-.5,.5,0,0]),a=new Uint8Array([0,2,3,0,1,2]);t.setData(r),e.setData(a),s.resourceManager.addContentRestorer(new(function(o){W(c,o);function c(){return o.call(this,t)}var l=c.prototype;return l.restoreContent=function(){t.setData(r)},c}(br))),s.resourceManager.addContentRestorer(new(function(o){W(c,o);function c(){return o.call(this,e)}var l=c.prototype;return l.restoreContent=function(){},c}(br)))},fu=`#define GLSLIFY 1
uniform mediump sampler2D renderer_BlitTexture;
#ifdef HAS_TEX_LOD
uniform float renderer_BlitMipLevel;
#endif
varying vec2 v_uv;void main(){
#ifdef HAS_TEX_LOD
gl_FragColor=texture2DLodEXT(renderer_BlitTexture,v_uv,renderer_BlitMipLevel);
#else
gl_FragColor=texture2D(renderer_BlitTexture,v_uv);
#endif
}`,vu=`#define GLSLIFY 1
attribute vec4 POSITION_UV;varying vec2 v_uv;void main(){gl_Position=vec4(POSITION_UV.xy,0.0,1.0);v_uv=POSITION_UV.zw;}`,pu=`#define GLSLIFY 1
#include <common>
const float MIE_G=-0.990;const float MIE_G2=0.9801;const float SKY_GROUND_THRESHOLD=0.02;uniform float material_SunSize;uniform float material_SunSizeConvergence;uniform vec4 scene_SunlightColor;uniform vec3 scene_SunlightDirection;varying vec3 v_GroundColor;varying vec3 v_SkyColor;
#ifdef MATERIAL_SUN_HIGH_QUALITY
varying vec3 v_Vertex;
#elif defined(MATERIAL_SUN_SIMPLE)
varying vec3 v_RayDir;
#else
varying float v_SkyGroundFactor;
#endif
#if defined(MATERIAL_SUN_HIGH_QUALITY)||defined(MATERIAL_SUN_SIMPLE)
varying vec3 v_SunColor;
#endif
#if defined(ENGINE_IS_COLORSPACE_GAMMA)
#define LINEAR_2_OUTPUT(color) sqrt(color)
#endif
float getMiePhase(float eyeCos,float eyeCos2){float temp=1.0+MIE_G2-2.0*MIE_G*eyeCos;temp=pow(temp,pow(material_SunSize,0.65)*10.0);temp=max(temp,1.0e-4);temp=1.5*((1.0-MIE_G2)/(2.0+MIE_G2))*(1.0+eyeCos2)/temp;return temp;}float calcSunAttenuation(vec3 lightPos,vec3 ray){
#ifdef MATERIAL_SUN_HIGH_QUALITY
float focusedEyeCos=pow(clamp(dot(lightPos,ray),0.0,1.0),material_SunSizeConvergence);return getMiePhase(-focusedEyeCos,focusedEyeCos*focusedEyeCos);
#else
vec3 delta=lightPos-ray;float dist=length(delta);float spot=1.0-smoothstep(0.0,material_SunSize,dist);return spot*spot;
#endif
}void main(){vec3 col=vec3(0.0,0.0,0.0);
#ifdef MATERIAL_SUN_HIGH_QUALITY
vec3 ray=normalize(v_Vertex);float y=ray.y/SKY_GROUND_THRESHOLD;
#elif defined(MATERIAL_SUN_SIMPLE)
vec3 ray=v_RayDir;float y=ray.y/SKY_GROUND_THRESHOLD;
#else
float y=v_SkyGroundFactor;
#endif
col=mix(v_SkyColor,v_GroundColor,clamp(y,0.0,1.0));
#if defined(MATERIAL_SUN_HIGH_QUALITY)||defined(MATERIAL_SUN_SIMPLE)
if(y<0.0)col+=v_SunColor*calcSunAttenuation(-scene_SunlightDirection,-ray);
#endif
#ifdef ENGINE_IS_COLORSPACE_GAMMA
col=LINEAR_2_OUTPUT(col);
#endif
gl_FragColor=vec4(col,1.0);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
}`,gu=`#define GLSLIFY 1
#define OUTER_RADIUS 1.025
#define RAYLEIGH (mix(0.0, 0.0025, pow(material_AtmosphereThickness,2.5)))
#define MIE 0.0010
#define SUN_BRIGHTNESS 20.0
#define MAX_SCATTER 50.0
const float SKY_GROUND_THRESHOLD=0.02;const float outerRadius=OUTER_RADIUS;const float outerRadius2=OUTER_RADIUS*OUTER_RADIUS;const float innerRadius=1.0;const float innerRadius2=1.0;const float cameraHeight=0.0001;const float HDSundiskIntensityFactor=15.0;const float simpleSundiskIntensityFactor=27.0;const float sunScale=400.0*SUN_BRIGHTNESS;const float kmESun=MIE*SUN_BRIGHTNESS;const float km4PI=MIE*4.0*3.14159265;const float scale=1.0/(OUTER_RADIUS-1.0);const float scaleDepth=0.25;const float scaleOverScaleDepth=(1.0/(OUTER_RADIUS-1.0))/0.25;const float samples=2.0;const vec3 c_DefaultScatteringWavelength=vec3(0.65,0.57,0.475);const vec3 c_VariableRangeForScatteringWavelength=vec3(0.15,0.15,0.15);attribute vec4 POSITION;uniform mat4 camera_VPMat;uniform vec3 material_SkyTint;uniform vec3 material_GroundTint;uniform float material_Exposure;uniform float material_AtmosphereThickness;uniform vec4 scene_SunlightColor;uniform vec3 scene_SunlightDirection;varying vec3 v_GroundColor;varying vec3 v_SkyColor;
#ifdef MATERIAL_SUN_HIGH_QUALITY
varying vec3 v_Vertex;
#elif defined(MATERIAL_SUN_SIMPLE)
varying vec3 v_RayDir;
#else
varying float v_SkyGroundFactor;
#endif
#if defined(MATERIAL_SUN_HIGH_QUALITY)||defined(MATERIAL_SUN_SIMPLE)
varying vec3 v_SunColor;
#endif
#if defined(ENGINE_IS_COLORSPACE_GAMMA)
#define COLOR_2_GAMMA(color) color
#define COLOR_2_LINEAR(color) color*color
#else
#define GAMMA 2.2
#define COLOR_2_GAMMA(color) pow(color,vec3(1.0/GAMMA))
#define COLOR_2_LINEAR(color) color
#endif
float getRayleighPhase(vec3 light,vec3 ray){float eyeCos=dot(light,ray);return 0.75+0.75*eyeCos*eyeCos;}float scaleAngle(float inCos){float x=1.0-inCos;return 0.25*exp(-0.00287+x*(0.459+x*(3.83+x*(-6.80+x*5.25))));}void main(){gl_Position=camera_VPMat*vec4(POSITION.xyz,1.0);vec3 skyTintInGammaSpace=COLOR_2_GAMMA(material_SkyTint);vec3 scatteringWavelength=mix(c_DefaultScatteringWavelength-c_VariableRangeForScatteringWavelength,c_DefaultScatteringWavelength+c_VariableRangeForScatteringWavelength,vec3(1.0)-skyTintInGammaSpace);vec3 invWavelength=1.0/pow(scatteringWavelength,vec3(4.0));float krESun=RAYLEIGH*SUN_BRIGHTNESS;float kr4PI=RAYLEIGH*4.0*3.14159265;vec3 cameraPos=vec3(0.0,innerRadius+cameraHeight,0.0);vec3 eyeRay=normalize(POSITION.xyz);float far=0.0;vec3 cIn,cOut;if(eyeRay.y>=0.0){far=sqrt(outerRadius2+innerRadius2*eyeRay.y*eyeRay.y-innerRadius2)-innerRadius*eyeRay.y;float height=innerRadius+cameraHeight;float depth=exp(scaleOverScaleDepth*-cameraHeight);float startAngle=dot(eyeRay,cameraPos)/height;float startOffset=depth*scaleAngle(startAngle);float sampleLength=far/samples;float scaledLength=sampleLength*scale;vec3 sampleRay=eyeRay*sampleLength;vec3 samplePoint=cameraPos+sampleRay*0.5;vec3 frontColor=vec3(0.0);{float height=length(samplePoint);float depth=exp(scaleOverScaleDepth*(innerRadius-height));float lightAngle=dot(-scene_SunlightDirection,samplePoint)/height;float cameraAngle=dot(eyeRay,samplePoint)/height;float scatter=(startOffset+depth*(scaleAngle(lightAngle)-scaleAngle(cameraAngle)));vec3 attenuate=exp(-clamp(scatter,0.0,MAX_SCATTER)*(invWavelength*kr4PI+km4PI));frontColor+=attenuate*(depth*scaledLength);samplePoint+=sampleRay;}{float height=length(samplePoint);float depth=exp(scaleOverScaleDepth*(innerRadius-height));float lightAngle=dot(-scene_SunlightDirection,samplePoint)/height;float cameraAngle=dot(eyeRay,samplePoint)/height;float scatter=(startOffset+depth*(scaleAngle(lightAngle)-scaleAngle(cameraAngle)));vec3 attenuate=exp(-clamp(scatter,0.0,MAX_SCATTER)*(invWavelength*kr4PI+km4PI));frontColor+=attenuate*(depth*scaledLength);samplePoint+=sampleRay;}cIn=frontColor*(invWavelength*krESun);cOut=frontColor*kmESun;}else{far=(-cameraHeight)/(min(-0.001,eyeRay.y));vec3 pos=cameraPos+far*eyeRay;float depth=exp((-cameraHeight)*(1.0/scaleDepth));float cameraAngle=dot(-eyeRay,pos);float lightAngle=dot(-scene_SunlightDirection,pos);float cameraScale=scaleAngle(cameraAngle);float lightScale=scaleAngle(lightAngle);float cameraOffset=depth*cameraScale;float temp=lightScale+cameraScale;float sampleLength=far/samples;float scaledLength=sampleLength*scale;vec3 sampleRay=eyeRay*sampleLength;vec3 samplePoint=cameraPos+sampleRay*0.5;vec3 frontColor=vec3(0.0,0.0,0.0);vec3 attenuate;{float height=length(samplePoint);float depth=exp(scaleOverScaleDepth*(innerRadius-height));float scatter=depth*temp-cameraOffset;attenuate=exp(-clamp(scatter,0.0,MAX_SCATTER)*(invWavelength*kr4PI+km4PI));frontColor+=attenuate*(depth*scaledLength);samplePoint+=sampleRay;}cIn=frontColor*(invWavelength*krESun+kmESun);cOut=clamp(attenuate,0.0,1.0);}
#ifdef MATERIAL_SUN_HIGH_QUALITY
v_Vertex=-POSITION.xyz;
#elif defined(MATERIAL_SUN_SIMPLE)
v_RayDir=-eyeRay;
#else
v_SkyGroundFactor=-eyeRay.y/SKY_GROUND_THRESHOLD;
#endif
v_GroundColor=material_Exposure*(cIn+COLOR_2_LINEAR(material_GroundTint)*cOut);v_SkyColor=material_Exposure*(cIn*getRayleighPhase(-scene_SunlightDirection,-eyeRay));float lightColorIntensity=clamp(length(scene_SunlightColor.xyz),0.25,1.0);
#ifdef MATERIAL_SUN_HIGH_QUALITY
v_SunColor=HDSundiskIntensityFactor*clamp(cOut,0.0,1.0)*scene_SunlightColor.xyz/lightColorIntensity;
#elif defined(MATERIAL_SUN_SIMPLE)
v_SunColor=simpleSundiskIntensityFactor*clamp(cOut*sunScale,0.0,1.0)*scene_SunlightColor.xyz/lightColorIntensity;
#endif
}`,mu=`#define GLSLIFY 1
uniform sampler2D material_BaseTexture;varying vec2 v_uv;void main(){gl_FragColor=texture2D(material_BaseTexture,v_uv);}`,yu=`#define GLSLIFY 1
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`,xu=`#define GLSLIFY 1
#include <common>
#include <camera_declare>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <ShadowFragmentDeclaration>
#include <mobile_material_frag>
#include <FogFragmentDeclaration>
#include <normal_get>
void main(){
#include <begin_mobile_frag>
#include <begin_viewdir_frag>
#include <mobile_blinnphong_frag>
gl_FragColor=emission+ambient+diffuse+specular;
#ifdef MATERIAL_IS_TRANSPARENT
gl_FragColor.a=diffuse.a;
#else
gl_FragColor.a=1.0;
#endif
#include <FogFragment>
#ifndef ENGINE_IS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
}`,bu=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <color_share>
#include <normal_share>
#include <worldpos_share>
#include <ShadowVertexDeclaration>
#include <FogVertexDeclaration>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <color_vert>
#include <normal_vert>
#include <worldpos_vert>
#include <position_vert>
#include <ShadowVertex>
#include <FogVertex>
}`,Su=`#define GLSLIFY 1
void main(){}`,Cu=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
uniform mat4 camera_VPMat;void main(){
#include <begin_position_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <position_vert>
}`,Au=`#define GLSLIFY 1
#include <common>
varying vec4 v_Color;varying vec2 v_TextureCoordinate;uniform sampler2D material_BaseTexture;uniform vec4 material_BaseColor;
#ifdef RENDERER_MODE_MESH
varying vec4 v_MeshColor;
#endif
void main(){vec4 color=material_BaseColor*v_Color;
#ifdef RENDERER_MODE_MESH
color*=v_MeshColor;
#endif
#ifdef MATERIAL_HAS_BASETEXTURE
vec4 textureColor=texture2D(material_BaseTexture,v_TextureCoordinate);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
textureColor=gammaToLinear(textureColor);
#endif
color*=textureColor;
#endif
gl_FragColor=color;
#ifndef ENGINE_IS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
}`,Eu=`#define GLSLIFY 1
#if defined(RENDERER_MODE_SPHERE_BILLBOARD) || defined(RENDERER_MODE_STRETCHED_BILLBOARD) || defined(RENDERER_MODE_HORIZONTAL_BILLBOARD) || defined(RENDERER_MODE_VERTICAL_BILLBOARD)
attribute vec4 a_CornerTextureCoordinate;
#endif
#ifdef RENDERER_MODE_MESH
attribute vec3 a_MeshPosition;attribute vec4 a_MeshColor;attribute vec2 a_MeshTextureCoordinate;varying vec4 v_MeshColor;
#endif
attribute vec4 a_ShapePositionStartLifeTime;attribute vec4 a_DirectionTime;attribute vec4 a_StartColor;attribute vec3 a_StartSize;attribute vec3 a_StartRotation0;attribute float a_StartSpeed;attribute vec4 a_Random0;
#if defined(RENDERER_TSA_FRAME_RANDOM_CURVES) || defined(RENDERER_VOL_RANDOM_CONSTANT) || defined(RENDERER_VOL_RANDOM_CURVE)
attribute vec4 a_Random1;
#endif
attribute vec3 a_SimulationWorldPosition;attribute vec4 a_SimulationWorldRotation;varying vec4 v_Color;
#ifdef MATERIAL_HAS_BASETEXTURE
attribute vec4 a_SimulationUV;varying vec2 v_TextureCoordinate;
#endif
uniform float renderer_CurrentTime;uniform vec3 renderer_Gravity;uniform vec2 u_DragConstant;uniform vec3 renderer_WorldPosition;uniform vec4 renderer_WorldRotation;uniform bool renderer_ThreeDStartRotation;uniform int renderer_ScalingMode;uniform vec3 renderer_PositionScale;uniform vec3 renderer_SizeScale;uniform vec3 renderer_PivotOffset;uniform mat4 camera_ViewMat;uniform mat4 camera_ProjMat;
#ifdef RENDERER_MODE_STRETCHED_BILLBOARD
uniform vec3 camera_Position;
#endif
uniform vec3 camera_Forward;uniform vec3 camera_Up;uniform float renderer_StretchedBillboardLengthScale;uniform float renderer_StretchedBillboardSpeedScale;uniform int renderer_SimulationSpace;
#include <particle_common>
#include <velocity_over_lifetime_module>
#include <color_over_lifetime_module>
#include <size_over_lifetime_module>
#include <rotation_over_lifetime_module>
#include <texture_sheet_animation_module>
void main(){float age=renderer_CurrentTime-a_DirectionTime.w;float normalizedAge=age/a_ShapePositionStartLifeTime.w;vec3 lifeVelocity;if(normalizedAge<1.0){vec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;
#if defined(RENDERER_VOL_CONSTANT) || defined(RENDERER_VOL_CURVE) || defined(RENDERER_VOL_RANDOM_CONSTANT) || defined(RENDERER_VOL_RANDOM_CURVE)
lifeVelocity=computeParticleLifeVelocity(normalizedAge);
#endif
vec3 gravityVelocity=renderer_Gravity*age;vec4 worldRotation;if(renderer_SimulationSpace==0){worldRotation=renderer_WorldRotation;}else{worldRotation=a_SimulationWorldRotation;}vec3 dragData=a_DirectionTime.xyz*mix(u_DragConstant.x,u_DragConstant.y,a_Random0.x);vec3 center=computeParticlePosition(startVelocity,lifeVelocity,age,normalizedAge,gravityVelocity,worldRotation,dragData);
#include <sphere_billboard>
#include <stretched_billboard>
#include <horizontal_billboard>
#include <vertical_billboard>
#include <particle_mesh>
gl_Position=camera_ProjMat*camera_ViewMat*vec4(center,1.0);v_Color=computeParticleColor(a_StartColor,normalizedAge);
#ifdef MATERIAL_HAS_BASETEXTURE
vec2 simulateUV;
#if defined(RENDERER_MODE_SPHERE_BILLBOARD) || defined(RENDERER_MODE_STRETCHED_BILLBOARD) || defined(RENDERER_MODE_HORIZONTAL_BILLBOARD) || defined(RENDERER_MODE_VERTICAL_BILLBOARD)
simulateUV=a_CornerTextureCoordinate.zw*a_SimulationUV.xy+a_SimulationUV.zw;v_TextureCoordinate=computeParticleUV(simulateUV,normalizedAge);
#endif
#ifdef RENDERER_MODE_MESH
simulateUV=a_SimulationUV.xy+a_MeshTextureCoordinate*a_SimulationUV.zw;v_TextureCoordinate=computeParticleUV(simulateUV,normalizedAge);
#endif
#endif
}else{gl_Position=vec4(2.0,2.0,2.0,1.0);}}`,wu=`#define GLSLIFY 1
#include <common>
#include <camera_declare>
#include <FogFragmentDeclaration>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <pbr_frag_define>
#include <pbr_helper>
void main(){
#include <pbr_frag>
#include <FogFragment>
#ifndef ENGINE_IS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
}`,Tu=`#define GLSLIFY 1
#define IS_METALLIC_WORKFLOW
#include <common>
#include <camera_declare>
#include <FogFragmentDeclaration>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <pbr_frag_define>
#include <pbr_helper>
void main(){
#include <pbr_frag>
#include <FogFragment>
#ifndef ENGINE_IS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
}`,os=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <color_share>
#include <normal_share>
#include <worldpos_share>
#include <ShadowVertexDeclaration>
#include <FogVertexDeclaration>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <color_vert>
#include <normal_vert>
#include <worldpos_vert>
#include <position_vert>
#include <ShadowVertex>
#include <FogVertex>
}`,Ru=`#define GLSLIFY 1
#ifdef ENGINE_NO_DEPTH_TEXTURE
vec4 pack(float depth){const vec4 bitShift=vec4(1.0,256.0,256.0*256.0,256.0*256.0*256.0);const vec4 bitMask=vec4(1.0/256.0,1.0/256.0,1.0/256.0,0.0);vec4 rgbaDepth=fract(depth*bitShift);rgbaDepth-=rgbaDepth.gbaa*bitMask;return rgbaDepth;}
#endif
void main(){
#ifdef ENGINE_NO_DEPTH_TEXTURE
gl_FragColor=pack(gl_FragCoord.z);
#else
gl_FragColor=vec4(0.0,0.0,0.0,0.0);
#endif
}`,Mu=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <normal_share>
uniform mat4 camera_VPMat;uniform vec2 scene_ShadowBias;uniform vec3 scene_LightDirection;vec3 applyShadowBias(vec3 positionWS){positionWS-=scene_LightDirection*scene_ShadowBias.x;return positionWS;}vec3 applyShadowNormalBias(vec3 positionWS,vec3 normalWS){float invNdotL=1.0-clamp(dot(-scene_LightDirection,normalWS),0.0,1.0);float scale=invNdotL*scene_ShadowBias.y;positionWS+=normalWS*vec3(scale);return positionWS;}void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
vec4 positionWS=renderer_ModelMat*position;positionWS.xyz=applyShadowBias(positionWS.xyz);
#ifndef MATERIAL_OMIT_NORMAL
#ifdef RENDERER_HAS_NORMAL
vec3 normalWS=normalize(mat3(renderer_NormalMat)*normal);positionWS.xyz=applyShadowNormalBias(positionWS.xyz,normalWS);
#endif
#endif
vec4 positionCS=camera_VPMat*positionWS;positionCS.z=max(positionCS.z,-1.0);gl_Position=positionCS;}`,Pu=`#define GLSLIFY 1
#include <common>
uniform samplerCube material_CubeTexture;varying vec3 v_cubeUV;uniform float material_Exposure;uniform vec4 material_TintColor;void main(){vec4 textureColor=textureCube(material_CubeTexture,v_cubeUV);
#ifdef MATERIAL_IS_DECODE_SKY_RGBM
textureColor=RGBMToLinear(textureColor,5.0);
#elif !defined(ENGINE_IS_COLORSPACE_GAMMA)
textureColor=gammaToLinear(textureColor);
#endif
textureColor.rgb*=material_Exposure*material_TintColor.rgb;gl_FragColor=textureColor;
#if defined(MATERIAL_IS_DECODE_SKY_RGBM) || !defined(ENGINE_IS_COLORSPACE_GAMMA)
gl_FragColor=linearToGamma(gl_FragColor);
#endif
}`,Bu=`#define GLSLIFY 1
#include <common_vert>
uniform mat4 camera_VPMat;varying vec3 v_cubeUV;uniform float material_Rotation;vec4 rotateY(vec4 v,float angle){const float deg2rad=3.1415926/180.0;float radian=angle*deg2rad;float sina=sin(radian);float cosa=cos(radian);mat2 m=mat2(cosa,-sina,sina,cosa);return vec4(m*v.xz,v.yw).xzyw;}void main(){v_cubeUV=vec3(-POSITION.x,POSITION.yz);gl_Position=camera_VPMat*rotateY(vec4(POSITION,1.0),material_Rotation);}`,Du=`#define GLSLIFY 1
uniform sampler2D renderer_MaskTexture;uniform float renderer_MaskAlphaCutoff;varying vec2 v_uv;void main(){vec4 color=texture2D(renderer_MaskTexture,v_uv);if(color.a<renderer_MaskAlphaCutoff){discard;}gl_FragColor=color;}`,Lu=`#define GLSLIFY 1
uniform mat4 camera_VPMat;attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=camera_VPMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`,Vu=`#define GLSLIFY 1
uniform sampler2D renderer_SpriteTexture;varying vec2 v_uv;varying vec4 v_color;void main(){vec4 baseColor=texture2D(renderer_SpriteTexture,v_uv);gl_FragColor=baseColor*v_color;}`,Fu=`#define GLSLIFY 1
uniform mat4 renderer_MVPMat;attribute vec3 POSITION;attribute vec2 TEXCOORD_0;attribute vec4 COLOR_0;varying vec2 v_uv;varying vec4 v_color;void main(){gl_Position=renderer_MVPMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;v_color=COLOR_0;}`,Nu=`#define GLSLIFY 1
#include <common>
#include <uv_share>
#include <FogFragmentDeclaration>
uniform vec4 material_BaseColor;uniform float material_AlphaCutoff;
#ifdef MATERIAL_HAS_BASETEXTURE
uniform sampler2D material_BaseTexture;
#endif
void main(){vec4 baseColor=material_BaseColor;
#ifdef MATERIAL_HAS_BASETEXTURE
vec4 textureColor=texture2D(material_BaseTexture,v_uv);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
textureColor=gammaToLinear(textureColor);
#endif
baseColor*=textureColor;
#endif
#ifdef MATERIAL_IS_ALPHA_CUTOFF
if(baseColor.a<material_AlphaCutoff){discard;}
#endif
gl_FragColor=baseColor;
#ifndef MATERIAL_IS_TRANSPARENT
gl_FragColor.a=1.0;
#endif
#include <FogFragment>
#ifndef ENGINE_IS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
}`,Iu=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <FogVertexDeclaration>
void main(){
#include <begin_position_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <position_vert>
#include <FogVertex>
}`,Ou=function(){function n(){}return n.init=function(){var i=new vt("ShadowCaster",Mu,Ru,{pipelineStage:Ot.ShadowCaster}),t=new vt("DepthOnly",Cu,Su,{pipelineStage:Ot.DepthOnly}),e=[i,t],r={pipelineStage:Ot.Forward};Se.create("blinn-phong",[].concat(new vt("Forward",bu,xu,r),e)),Se.create("pbr",[].concat(new vt("Forward",os,Tu,r),e)),Se.create("pbr-specular",[].concat(new vt("Forward",os,wu,r),e)),Se.create("unlit",[].concat(new vt("Forward",Iu,Nu,r),e)),Se.create("blit",[new vt("Forward",vu,fu,r)]),Se.create("skybox",[new vt("Forward",Bu,Pu,r)]),Se.create("SkyProcedural",[new vt("Forward",gu,pu,r)]),Se.create("particle-shader",[new vt("Forward",Eu,Au,r)]),Se.create("SpriteMask",[new vt("Forward",Lu,Du,r)]),Se.create("Sprite",[new vt("Forward",Fu,Vu,r)]),Se.create("background-texture",[new vt("Forward",yu,mu,r)])},n}(),zu=function(){function n(){this._cacheHierarchyDepth=1,this._cacheMap=Object.create(null)}var s=n.prototype;return s.get=function(t){var e=this._cacheMap,r=t._length,a=this._cacheHierarchyDepth;r>a&&(this._resizeCacheMapHierarchy(e,0,a,r-a),this._cacheHierarchyDepth=r);for(var o=t._mask,c=t._length-1,l=this._cacheHierarchyDepth-1,_=0;_<l;_++){var u=c<_?0:o[_],h=e[u];h||(e[u]=h=Object.create(null)),e=h}var d=c<l?0:o[l],f=e[d];return f||(this._lastQueryKey=d,this._lastQueryMap=e),f},s.cache=function(t){this._lastQueryMap[this._lastQueryKey]=t},s._destroy=function(){this._recursiveDestroy(0,this._cacheMap),this._cacheMap=Object.create(null)},s._recursiveDestroy=function(t,e){if(t===this._cacheHierarchyDepth-1){for(var r in e)e[r].destroy();return}++t;for(var a in e)this._recursiveDestroy(t,e[a])},s._resizeCacheMapHierarchy=function(t,e,r,a){if(e==r-1)for(var o in t){for(var c=t[o],l=t,_=0;_<a;_++)l[_==0?o:0]=l=Object.create(null);l[0]=c}else{e++;for(var u in t)this._resizeCacheMapHierarchy(t[u],e,r,a)}},n}(),Oc=function(){function n(){}var s=n.prototype;return s._initialize=function(t,e){},s._update=function(){},s._destroy=function(){},s._getRequestAnimationFrame=function(){return null},s._getCancelAnimationFrame=function(){return null},s._getCameraClearFlagsMask=function(t){return zt.None},n}();Ou.init();var hn=function(n){W(s,n);function s(t,e,r){var a;a=n.call(this)||this,a._physicsInitialized=!1,a._physicalObjectsMap={},a._lastRenderState=new qr,a._renderElementPool=new Fn(j_),a._renderDataPool=new Fn(Hi),a._spriteRenderDataPool=new Fn(K_),a._spriteMaskRenderDataPool=new Fn(Q_),a._textRenderDataPool=new Fn(J_),a._spriteDefaultMaterials=[],a._renderContext=new Qt,a._renderCount=0,a._shaderProgramPools=[],a._canSpriteBatch=!0,a._fontMap={},a._macroCollection=new Kt,a._settings={},a._resourceManager=new ua(ce(a)),a._sceneManager=new Bc(ce(a)),a._vSyncCount=1,a._targetFrameRate=60,a._time=new Oi,a._isPaused=!0,a._vSyncCounter=1,a._targetFrameInterval=1e3/60,a._destroyed=!1,a._frameInProcess=!1,a._waitingDestroy=!1,a._isDeviceLost=!1,a._waitingGC=!1,a._animate=function(){if(a._vSyncCount){var v,p=((v=a.xrManager)==null?void 0:v._getRequestAnimationFrame())||requestAnimationFrame;a._requestId=p(a._animate),a._vSyncCounter++%a._vSyncCount===0&&(a.update(),a._vSyncCounter=1)}else a._timeoutId=window.setTimeout(a._animate,a._targetFrameInterval),a.update()},a._hardwareRenderer=e,a._hardwareRenderer.init(t,a._onDeviceLost.bind(ce(a)),a._onDeviceRestored.bind(ce(a))),a._canvas=t,a._spriteMaskManager=new Y_(ce(a));var o=ce(a),c=o._spriteDefaultMaterials;a._spriteDefaultMaterial=c[ct.None]=a._createSpriteMaterial(ct.None),c[ct.VisibleInsideMask]=a._createSpriteMaterial(ct.VisibleInsideMask),c[ct.VisibleOutsideMask]=a._createSpriteMaterial(ct.VisibleOutsideMask),a._spriteMaskDefaultMaterial=a._createSpriteMaskMaterial(),a._textDefaultFont=_a.createFromOS(ce(a),"Arial"),a._textDefaultFont.isGCIgnored=!0,a.inputManager=new Ic(ce(a),r.input);var l=r.xrDevice;if(l&&(a.xrManager=new Oc,a.xrManager._initialize(ce(a),l)),a._initMagentaTextures(e),!e.canIUse(K.depthTexture))a._macroCollection.enable(s._noDepthTextureMacro);else{var _=new Tt(ce(a),1,1,G.Depth16,!1);_.isGCIgnored=!0,a._depthTexture2D=_}var u=new Sr(ce(a),Se.find("unlit"));u.isGCIgnored=!0,u.shaderData.setColor("material_BaseColor",new q(1,0,1.01,1)),a._meshMagentaMaterial=u;var h=new Sr(ce(a),Se.find("particle-shader"));h.isGCIgnored=!0,h.shaderData.setColor("material_BaseColor",new q(1,0,1.01,1)),a._particleMagentaMaterial=h;var d=a._settings,f=r.colorSpace||or.Linear;return f===or.Gamma&&a._macroCollection.enable(s._gammaMacro),d.colorSpace=f,a._basicResources=new X_(ce(a)),a._particleBufferUtils=new du(ce(a)),a}var i=s.prototype;return i.createEntity=function(e){return new Yt(this,e)},i.pause=function(){var e;this._isPaused=!0;var r=((e=this.xrManager)==null?void 0:e._getCancelAnimationFrame())||cancelAnimationFrame;r(this._requestId),clearTimeout(this._timeoutId)},i.resume=function(){if(this._isPaused)if(this._isPaused=!1,this.time._reset(),this._vSyncCount){var e,r=((e=this.xrManager)==null?void 0:e._getRequestAnimationFrame())||requestAnimationFrame;this._requestId=r(this._animate)}else this._timeoutId=window.setTimeout(this._animate,this._targetFrameInterval)},i.update=function(){var e,r=this._time;r._update();var a=r.deltaTime;this._frameInProcess=!0,this._renderElementPool.resetPool(),this._renderDataPool.resetPool(),this._spriteRenderDataPool.resetPool(),this._spriteMaskRenderDataPool.resetPool(),this._textRenderDataPool.resetPool(),(e=this.xrManager)==null||e._update();var o=this,c=o.inputManager,l=o._physicsInitialized;c._update();for(var _=this._sceneManager._scenes.getLoopArray(),u=_.length,h=0;h<u;h++){var d=_[h];if(!(!d.isActive||d.destroyed)){var f=d._componentsManager;f.sortCameras(),f.callScriptOnStart()}}if(l)for(var v=0;v<u;v++){var p=_[v];!p.isActive||p.destroyed||p.physics._update(a)}l&&c._firePointerScript(_);for(var g=0;g<u;g++){var y=_[g];!y.isActive||y.destroyed||y._componentsManager.callScriptOnUpdate(a)}for(var m=0;m<u;m++){var x=_[m];!x.isActive||x.destroyed||x._componentsManager.callAnimationUpdate(a)}for(var C=0;C<u;C++){var b=_[C];!b.isActive||b.destroyed||b._componentsManager.callScriptOnLateUpdate(a)}if(this._isDeviceLost||this._render(_),this._waitingDestroy)this._destroy();else for(var A=0;A<u;A++){var S=_[A];!S.isActive||S.destroyed||S._componentsManager.handlingInvalidScripts()}this._waitingGC&&(this._gc(),this._waitingGC=!1),this._frameInProcess=!1},i.run=function(){this.resume(),this.dispatch("run",this)},i.forceLoseDevice=function(){this._hardwareRenderer.forceLoseDevice()},i.forceRestoreDevice=function(){this._hardwareRenderer.forceRestoreDevice()},i._destroy=function(){var e;this._sceneManager._destroyAllScene(),this._resourceManager._destroy(),this._textDefaultFont=null,this._fontMap=null,this.inputManager._destroy(),(e=this.xrManager)==null||e._destroy(),this.dispatch("shutdown",this),this.pause(),this._spriteMaskManager.destroy(),this._hardwareRenderer.destroy(),this.removeAllEventListeners(),this._animate=null,this._sceneManager=null,this._resourceManager=null,this._canvas=null,this._time=null,this._waitingDestroy=!1,this._destroyed=!0},i.destroy=function(){this._destroyed||(this._frameInProcess?this._waitingDestroy=!0:this._destroy())},i._getShaderProgramPool=function(e){var r=e._shaderPassId,a=this._shaderProgramPools,o=a[r];if(!o){var c=r+1;c>a.length&&(a.length=c),a[r]=o=new zu,e._shaderProgramPools.push(o)}return o},i._render=function(e){for(var r=function(d,f){var v=e[d];if(!v.isActive||v.destroyed)return"continue";var p=v._componentsManager._activeCameras;if(p.length===0)return ve.debug("No active camera in scene."),"continue";p.forEach(function(g){var y=v._componentsManager;y.callCameraOnBeginRender(g),g.render(),y.callCameraOnEndRender(g),a._hardwareRenderer._options._forceFlush&&a._hardwareRenderer.flush()},function(g,y){g._cameraIndex=y})},a=this,o=this.time.deltaTime,c=0,l=e.length;c<l;c++){var _=e[c];!_.isActive||_.destroyed||(_._componentsManager.callRendererOnUpdate(o),_._updateShaderData())}for(var u=0,h=e.length;u<h;u++)r(u)},i._initMagentaTextures=function(e){var r=new Uint8Array([255,255,255,255]),a=new Tt(this,1,1,G.R8G8B8A8,!1);a.setPixelBuffer(r),a.isGCIgnored=!0;var o=new Uint8Array([255,0,255,255]),c=new Tt(this,1,1,G.R8G8B8A8,!1);c.setPixelBuffer(o),c.isGCIgnored=!0,this.resourceManager.addContentRestorer(new(function(f){W(v,f);function v(){return f.call(this,c)}var p=v.prototype;return p.restoreContent=function(){this.resource.setPixelBuffer(o)},v}(br)));for(var l=new jt(this,1,G.R8G8B8A8,!1),_=0;_<6;_++)l.setPixelBuffer(wr.PositiveX+_,o);if(l.isGCIgnored=!0,this.resourceManager.addContentRestorer(new(function(f){W(v,f);function v(){return f.call(this,l)}var p=v.prototype;return p.restoreContent=function(){for(var y=0;y<6;y++)this.resource.setPixelBuffer(wr.PositiveX+y,o)},v}(br))),this._whiteTexture2D=a,this._magentaTexture2D=c,this._magentaTextureCube=l,e.isWebGL2){var u=new Uint32Array([255,0,255,255]),h=new Tt(this,1,1,G.R32G32B32A32_UInt,!1);h.setPixelBuffer(u),h.isGCIgnored=!0,this.resourceManager.addContentRestorer(new(function(f){W(v,f);function v(){return f.call(this,h)}var p=v.prototype;return p.restoreContent=function(){this.resource.setPixelBuffer(u)},v}(br)));var d=new Bo(this,1,1,1,G.R8G8B8A8,!1);d.setPixelBuffer(0,o),d.isGCIgnored=!0,this.resourceManager.addContentRestorer(new(function(f){W(v,f);function v(){return f.call(this,d)}var p=v.prototype;return p.restoreContent=function(){this.resource.setPixelBuffer(0,o)},v}(br))),this._uintMagentaTexture2D=h,this._magentaTexture2DArray=d}},i._pendingGC=function(){this._frameInProcess?this._waitingGC=!0:this._gc()},i._initialize=function(e){var r=this,a=e.shaderLab,o=e.physics;a&&(Se._shaderLab=a);var c=new Array;o&&c.push(o.initialize().then(function(){return Gt._nativePhysics=o,r._nativePhysicsManager=o.createPhysicsManager(),r._physicsInitialized=!0,r}));var l=ua._loaders;for(var _ in l){var u=l[_];u.initialize&&c.push(u.initialize(this,e))}return Promise.all(c).then(function(){return r})},i._createSpriteMaterial=function(e){var r=new Sr(this,Se.find("Sprite")),a=r.renderState,o=a.blendState.targetBlendState;if(o.enabled=!0,o.sourceColorBlendFactor=be.SourceAlpha,o.destinationColorBlendFactor=be.OneMinusSourceAlpha,o.sourceAlphaBlendFactor=be.One,o.destinationAlphaBlendFactor=be.OneMinusSourceAlpha,o.colorBlendOperation=o.alphaBlendOperation=It.Add,e!==ct.None){var c=a.stencilState;c.enabled=!0,c.writeMask=0,c.referenceValue=1;var l=e===ct.VisibleInsideMask?Ee.LessEqual:Ee.Greater;c.compareFunctionFront=l,c.compareFunctionBack=l}return a.depthState.writeEnabled=!1,a.rasterState.cullMode=qt.Off,a.renderQueueType=ft.Transparent,r.isGCIgnored=!0,r},i._createSpriteMaskMaterial=function(){var e=new Sr(this,Se.find("SpriteMask")),r=e.renderState;return r.blendState.targetBlendState.colorWriteMask=yr.None,r.rasterState.cullMode=qt.Off,r.stencilState.enabled=!0,r.depthState.enabled=!1,e.isGCIgnored=!0,e},i._onDeviceLost=function(){this._isDeviceLost=!0,this.resourceManager._lostGraphicResources(),console.log("Device lost."),this.dispatch("devicelost",this)},i._onDeviceRestored=function(){var e=this;this._hardwareRenderer.resetState(),this._lastRenderState=new qr,this._shaderProgramPools.length=0;var r=this.resourceManager;r._restoreGraphicResources(),console.log("Graphic resource restored."),r._restoreResourcesContent().then(function(){console.log(`Graphic resource content restored.

Device restored.`),e.dispatch("devicerestored",e),e._isDeviceLost=!1}).catch(function(a){console.error(a)})},i._gc=function(){this._renderElementPool.garbageCollection(),this._renderDataPool.garbageCollection(),this._spriteRenderDataPool.garbageCollection(),this._spriteMaskRenderDataPool.garbageCollection(),this._textRenderDataPool.garbageCollection(),this._renderContext.garbageCollection()},j(s,[{key:"settings",get:function(){return this._settings}},{key:"canvas",get:function(){return this._canvas}},{key:"resourceManager",get:function(){return this._resourceManager}},{key:"sceneManager",get:function(){return this._sceneManager}},{key:"time",get:function(){return this._time}},{key:"isPaused",get:function(){return this._isPaused}},{key:"vSyncCount",get:function(){return this._vSyncCount},set:function(e){this._vSyncCount=Math.max(0,Math.floor(e))}},{key:"targetFrameRate",get:function(){return this._targetFrameRate},set:function(e){e=Math.max(1e-6,e),this._targetFrameRate=e,this._targetFrameInterval=1e3/e}},{key:"destroyed",get:function(){return this._destroyed}},{key:"physicsManager",get:function(){var e;return(e=this.sceneManager.scenes[0])==null?void 0:e.physics}}]),s}(wo);(function(){hn._gammaMacro=oe.getByName("ENGINE_IS_COLORSPACE_GAMMA")})();(function(){hn._noDepthTextureMacro=oe.getByName("ENGINE_NO_DEPTH_TEXTURE")})();(function(){hn._pixelsPerUnit=100})();var zc=function(){function n(){this._sizeUpdateFlagManager=new Er}return j(n,[{key:"width",get:function(){return this._width},set:function(i){this._width!==i&&(this._width=i,this._onWidthChanged(i),this._sizeUpdateFlagManager.dispatch())}},{key:"height",get:function(){return this._height},set:function(i){this._height!==i&&(this._height=i,this._onHeightChange(i),this._sizeUpdateFlagManager.dispatch())}}]),n}(),cn;(function(n){n[n.SolidColor=0]="SolidColor",n[n.Sky=1]="Sky",n[n.Texture=2]="Texture"})(cn||(cn={}));var bn;(function(n){n[n.AspectFitWidth=0]="AspectFitWidth",n[n.AspectFitHeight=1]="AspectFitHeight",n[n.Fill=2]="Fill"})(bn||(bn={}));var ha=function(){function n(){}var s=n.prototype;return s.destroy=function(){this.mesh=null,this.material=null},s._render=function(t){var e=this,r=e.material,a=e.mesh;if(!r){ve.warn("The material of sky is not defined.");return}if(r.destroyed){ve.warn("The material of sky is destroyed.");return}if(!a){ve.warn("The mesh of sky is not defined.");return}if(a.destroyed){ve.warn("The mesh of sky is destroyed.");return}var o=t.camera,c=o.engine,l=o.scene,_=o.aspectRatio,u=o.fieldOfView,h=o.viewMatrix,d=o.shaderData,f=l.shaderData,v=n._viewProjMatrix,p=n._projectionMatrix,g=c._hardwareRenderer,y=r.shaderData,m=r.shader,x=r.renderState;v.copyFrom(h);var C=v.elements;C[12]=C[13]=C[14]=0;var b=1/Math.tan(k.degreeToRadian(u)/2);p.elements[0]=b/_,p.elements[5]=b,Z.multiply(p,v,v);var A=d.getMatrix(Qt.vpMatrixProperty);t.flipProjection&&Z.multiply(Qt._flipYMatrix,v,v),d.setMatrix(Qt.vpMatrixProperty,v);var S=Se._compileMacros;Kt.unionCollection(t.camera._globalShaderMacro,y._macroCollection,S);var w=m.subShaders[0].passes[0],E=w._getShaderProgram(c,S);E.bind(),E.groupingOtherUniformBlock(),E.uploadAll(E.sceneUniformBlock,f),E.uploadAll(E.cameraUniformBlock,d),E.uploadAll(E.materialUniformBlock,y),E.uploadUnGroupTextures(),x._apply(c,!1,w._renderStateDataMap,y),g.drawPrimitive(a._primitive,a.subMesh,E),d.setMatrix(Qt.vpMatrixProperty,A)},j(n,[{key:"material",get:function(){return this._material},set:function(t){if(this._material!==t){var e,r;(e=t)==null||e._addReferCount(1),(r=this._material)==null||r._addReferCount(-1),this._material=t}}},{key:"mesh",get:function(){return this._mesh},set:function(t){if(this._mesh!==t){var e,r;(e=t)==null||e._addReferCount(1),(r=this._mesh)==null||r._addReferCount(-1),this._mesh=t}}}]),n}();(function(){ha._epsilon=1e-6})();(function(){ha._viewProjMatrix=new Z})();(function(){ha._projectionMatrix=new Z(1,0,0,0,0,1,0,0,0,0,ha._epsilon-1,-1,0,0,0,0)})();var Uc=function(){function n(i){this._engine=i,this.mode=cn.SolidColor,this.solidColor=new q(.25,.25,.25,1),this.sky=new ha,this._textureFillMode=bn.AspectFitHeight,this._texture=null,this._initMesh(i),this._initMaterial(i)}var s=n.prototype;return s.destroy=function(){this.texture=null,this._mesh._addReferCount(-1),this._mesh=null,this._material._addReferCount(-1),this._material=null,this.solidColor=null,this.sky.destroy()},s._resizeBackgroundTexture=function(){var t=this,e=t._texture,r=t._mesh;if(this._texture){var a=this._engine.canvas,o=a.width,c=a.height,l=r.getPositions();switch(this._textureFillMode){case bn.Fill:l[0].set(-1,-1,1),l[1].set(1,-1,1),l[2].set(-1,1,1),l[3].set(1,1,1);break;case bn.AspectFitWidth:var _=e.height*o/e.width/c;l[0].set(-1,-_,1),l[1].set(1,-_,1),l[2].set(-1,_,1),l[3].set(1,_,1);break;case bn.AspectFitHeight:var u=e.width*c/e.height/o;l[0].set(-u,-1,1),l[1].set(u,-1,1),l[2].set(-u,1,1),l[3].set(u,1,1);break}r.setPositions(l),r.uploadData(!1)}},s._initMesh=function(t){this._mesh=this._createPlane(t),this._mesh._addReferCount(1)},s._initMaterial=function(t){var e=this._material=new Sr(t,Se.find("background-texture"));e.renderState.depthState.compareFunction=Ee.LessEqual,e._addReferCount(1)},s._createPlane=function(t){for(var e=new dt(t),r=new Uint8Array([1,2,0,1,3,2]),a=new Array(4),o=new Array(4),c=0;c<4;++c)a[c]=new R,o[c]=new ee(c%2,1-(c*.5|0));return e.setPositions(a),e.setUVs(o),e.setIndices(r),e.uploadData(!1),e.addSubMesh(0,r.length),e},j(n,[{key:"texture",get:function(){return this._texture},set:function(t){if(this._texture!==t){var e,r;(e=t)==null||e._addReferCount(1),(r=this._texture)==null||r._addReferCount(-1),this._texture=t,this._material.shaderData.setTexture("material_BaseTexture",t),this._resizeBackgroundTexture()}}},{key:"textureFillMode",get:function(){return this._textureFillMode},set:function(t){t!==this._textureFillMode&&(this._textureFillMode=t,this._resizeBackgroundTexture())}}]),n}(),Uu=function(){function n(){this._cameraNeedSorting=!1,this._activeCameras=new He,this._renderers=new He,this._onStartScripts=new He,this._onUpdateScripts=new He,this._onLateUpdateScripts=new He,this._onPhysicsUpdateScripts=new He,this._pendingDestroyScripts=[],this._disposeDestroyScripts=[],this._onUpdateAnimations=new He,this._onUpdateRenderers=new He,this._componentsContainerPool=[]}var s=n.prototype;return s.addCamera=function(t){t._cameraIndex=this._activeCameras.length,this._activeCameras.add(t),this._cameraNeedSorting=!0},s.removeCamera=function(t){var e=this._activeCameras.deleteByIndex(t._cameraIndex);e&&(e._cameraIndex=t._cameraIndex),t._cameraIndex=-1,this._cameraNeedSorting=!0},s.sortCameras=function(){if(this._cameraNeedSorting){var t=this._activeCameras;t.sort(function(a,o){return a.priority-o.priority});for(var e=0,r=t.length;e<r;e++)t.get(e)._cameraIndex=e;this._cameraNeedSorting=!1}},s.addRenderer=function(t){t._rendererIndex=this._renderers.length,this._renderers.add(t)},s.removeRenderer=function(t){var e=this._renderers.deleteByIndex(t._rendererIndex);e&&(e._rendererIndex=t._rendererIndex),t._rendererIndex=-1},s.addOnStartScript=function(t){t._onStartIndex=this._onStartScripts.length,this._onStartScripts.add(t)},s.removeOnStartScript=function(t){var e=this._onStartScripts.deleteByIndex(t._onStartIndex);e&&(e._onStartIndex=t._onStartIndex),t._onStartIndex=-1},s.addOnUpdateScript=function(t){t._onUpdateIndex=this._onUpdateScripts.length,this._onUpdateScripts.add(t)},s.removeOnUpdateScript=function(t){var e=this._onUpdateScripts.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},s.addOnLateUpdateScript=function(t){t._onLateUpdateIndex=this._onLateUpdateScripts.length,this._onLateUpdateScripts.add(t)},s.removeOnLateUpdateScript=function(t){var e=this._onLateUpdateScripts.deleteByIndex(t._onLateUpdateIndex);e&&(e._onLateUpdateIndex=t._onLateUpdateIndex),t._onLateUpdateIndex=-1},s.addOnPhysicsUpdateScript=function(t){t._onPhysicsUpdateIndex=this._onPhysicsUpdateScripts.length,this._onPhysicsUpdateScripts.add(t)},s.removeOnPhysicsUpdateScript=function(t){var e=this._onPhysicsUpdateScripts.deleteByIndex(t._onPhysicsUpdateIndex);e&&(e._onPhysicsUpdateIndex=t._onPhysicsUpdateIndex),t._onPhysicsUpdateIndex=-1},s.addOnUpdateAnimations=function(t){t._onUpdateIndex=this._onUpdateAnimations.length,this._onUpdateAnimations.add(t)},s.removeOnUpdateAnimations=function(t){var e=this._onUpdateAnimations.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},s.addOnUpdateRenderers=function(t){t._onUpdateIndex=this._onUpdateRenderers.length,this._onUpdateRenderers.add(t)},s.removeOnUpdateRenderers=function(t){var e=this._onUpdateRenderers.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},s.addPendingDestroyScript=function(t){this._pendingDestroyScripts.push(t)},s.callScriptOnStart=function(){var t=this,e=this._onStartScripts;e.length>0&&e.forEachAndClean(function(r){r._started=!0,t.removeOnStartScript(r),r.onStart()})},s.callScriptOnUpdate=function(t){this._onUpdateScripts.forEach(function(e){e._started&&e.onUpdate(t)},function(e,r){e._onUpdateIndex=r})},s.callScriptOnLateUpdate=function(t){this._onLateUpdateScripts.forEach(function(e){e._started&&e.onLateUpdate(t)},function(e,r){e._onLateUpdateIndex=r})},s.callScriptOnPhysicsUpdate=function(){this._onPhysicsUpdateScripts.forEach(function(t){t._started&&t.onPhysicsUpdate()},function(t,e){t._onPhysicsUpdateIndex=e})},s.callAnimationUpdate=function(t){this._onUpdateAnimations.forEach(function(e){e.engine.time.frameCount>e._playFrameCount&&e.update(t)},function(e,r){e._onUpdateIndex=r})},s.callRendererOnUpdate=function(t){this._onUpdateRenderers.forEach(function(e){e.update(t)},function(e,r){e._onUpdateIndex=r})},s.handlingInvalidScripts=function(){var t=this,e=t._disposeDestroyScripts,r=t._pendingDestroyScripts;this._disposeDestroyScripts=r,this._pendingDestroyScripts=e;var a=r.length;if(a>0){for(var o=a-1;o>=0;o--)r[o].onDestroy();r.length=0}},s.callCameraOnBeginRender=function(t){t.entity._scripts.forEach(function(e){e.onBeginRender(t)},function(e,r){e._entityScriptsIndex=r})},s.callCameraOnEndRender=function(t){t.entity._scripts.forEach(function(e){e.onEndRender(t)},function(e,r){e._entityScriptsIndex=r})},s.getActiveChangedTempList=function(){return this._componentsContainerPool.length?this._componentsContainerPool.pop():[]},s.putActiveChangedTempList=function(t){t.length=0,this._componentsContainerPool.push(t)},s._gc=function(){this._renderers.garbageCollection(),this._onStartScripts.garbageCollection(),this._onUpdateScripts.garbageCollection(),this._onLateUpdateScripts.garbageCollection(),this._onPhysicsUpdateScripts.garbageCollection(),this._onUpdateAnimations.garbageCollection(),this._onUpdateRenderers.garbageCollection(),this._activeCameras.garbageCollection()},n}(),bi;(function(n){n[n.None=0]="None",n[n.Linear=1]="Linear",n[n.Exponential=2]="Exponential",n[n.ExponentialSquared=3]="ExponentialSquared"})(bi||(bi={}));var Xn;(function(n){n[n.SolidColor=0]="SolidColor",n[n.SphericalHarmonics=1]="SphericalHarmonics"})(Xn||(Xn={}));var Tr=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._diffuseSolidColor=new q(.212,.227,.259),e._diffuseIntensity=1,e._specularIntensity=1,e._diffuseMode=Xn.SolidColor,e._shArray=new Float32Array(27),e._scenes=[],e._specularTextureDecodeRGBM=!1,e}var i=s.prototype;return i._addToScene=function(e){this._addReferCount(1),this._scenes.push(e);var r=e.shaderData;r.setColor(s._diffuseColorProperty,this._diffuseSolidColor),r.setFloat(s._diffuseIntensityProperty,this._diffuseIntensity),r.setFloat(s._specularIntensityProperty,this._specularIntensity),r.setFloatArray(s._diffuseSHProperty,this._shArray),this._setDiffuseMode(r),this._setSpecularTextureDecodeRGBM(r),this._setSpecularTexture(r)},i._removeFromScene=function(e){this._addReferCount(-1);var r=this._scenes,a=r.indexOf(e);r.splice(a,1);var o=e.shaderData;o.setTexture(s._specularTextureProperty,null),o.disableMacro(s._specularMacro)},i._setDiffuseMode=function(e){this._diffuseMode===Xn.SphericalHarmonics?e.enableMacro(s._shMacro):e.disableMacro(s._shMacro)},i._setSpecularTexture=function(e){this._specularTexture?(e.setTexture(s._specularTextureProperty,this._specularTexture),e.setFloat(s._mipLevelProperty,this._specularTexture.mipmapCount-1),e.enableMacro(s._specularMacro)):e.disableMacro(s._specularMacro)},i._setSpecularTextureDecodeRGBM=function(e){this._specularTextureDecodeRGBM?e.enableMacro(s._decodeRGBMMacro):e.disableMacro(s._decodeRGBMMacro)},i._preComputeSH=function(e,r){var a=e.coefficients;r[0]=a[0]*.886227,r[1]=a[1]*.886227,r[2]=a[2]*.886227,r[3]=a[3]*-1.023327,r[4]=a[4]*-1.023327,r[5]=a[5]*-1.023327,r[6]=a[6]*1.023327,r[7]=a[7]*1.023327,r[8]=a[8]*1.023327,r[9]=a[9]*-1.023327,r[10]=a[10]*-1.023327,r[11]=a[11]*-1.023327,r[12]=a[12]*.858086,r[13]=a[13]*.858086,r[14]=a[14]*.858086,r[15]=a[15]*-.858086,r[16]=a[16]*-.858086,r[17]=a[17]*-.858086,r[18]=a[18]*.247708,r[19]=a[19]*.247708,r[20]=a[20]*.247708,r[21]=a[21]*-.858086,r[22]=a[22]*-.858086,r[23]=a[23]*-.858086,r[24]=a[24]*.429042,r[25]=a[25]*.429042,r[26]=a[26]*.429042},j(s,[{key:"specularTextureDecodeRGBM",get:function(){return this._specularTextureDecodeRGBM},set:function(e){this._specularTextureDecodeRGBM=e;for(var r=this._scenes,a=0,o=r.length;a<o;a++)this._setSpecularTextureDecodeRGBM(r[a].shaderData)}},{key:"diffuseMode",get:function(){return this._diffuseMode},set:function(e){this._diffuseMode=e;for(var r=this._scenes,a=0,o=r.length;a<o;a++)this._setDiffuseMode(r[a].shaderData)}},{key:"diffuseSolidColor",get:function(){return this._diffuseSolidColor},set:function(e){e!==this._diffuseSolidColor&&this._diffuseSolidColor.copyFrom(e)}},{key:"diffuseSphericalHarmonics",get:function(){return this._diffuseSphericalHarmonics},set:function(e){if(this._diffuseSphericalHarmonics=e,e){this._preComputeSH(e,this._shArray);for(var r=this._scenes,a=0,o=r.length;a<o;a++)r[a].shaderData.setFloatArray(s._diffuseSHProperty,this._shArray)}}},{key:"diffuseIntensity",get:function(){return this._diffuseIntensity},set:function(e){this._diffuseIntensity=e;for(var r=this._scenes,a=0,o=r.length;a<o;a++)r[a].shaderData.setFloat(s._diffuseIntensityProperty,e)}},{key:"specularTexture",get:function(){return this._specularTexture},set:function(e){this._specularTexture=e;for(var r=this._scenes,a=0,o=r.length;a<o;a++)this._setSpecularTexture(r[a].shaderData)}},{key:"specularIntensity",get:function(){return this._specularIntensity},set:function(e){this._specularIntensity=e;for(var r=0,a=this._scenes.length;r<a;r++)this._scenes[r].shaderData.setFloat(s._specularIntensityProperty,e)}}]),s}(Qr);(function(){Tr._shMacro=oe.getByName("SCENE_USE_SH")})();(function(){Tr._specularMacro=oe.getByName("SCENE_USE_SPECULAR_ENV")})();(function(){Tr._decodeRGBMMacro=oe.getByName("SCENE_IS_DECODE_ENV_RGBM")})();(function(){Tr._diffuseColorProperty=O.getByName("scene_EnvMapLight.diffuse")})();(function(){Tr._diffuseSHProperty=O.getByName("scene_EnvSH")})();(function(){Tr._diffuseIntensityProperty=O.getByName("scene_EnvMapLight.diffuseIntensity")})();(function(){Tr._specularTextureProperty=O.getByName("scene_EnvSpecularSampler")})();(function(){Tr._specularIntensityProperty=O.getByName("scene_EnvMapLight.specularIntensity")})();(function(){Tr._mipLevelProperty=O.getByName("scene_EnvMapLight.mipMapLevel")})();var pr;(function(n){n[n.NoCascades=1]="NoCascades",n[n.TwoCascades=2]="TwoCascades",n[n.FourCascades=4]="FourCascades"})(pr||(pr={}));var Sn;(function(n){n[n.Low=0]="Low",n[n.Medium=1]="Medium",n[n.High=2]="High",n[n.VeryHigh=3]="VeryHigh"})(Sn||(Sn={}));var dn;(function(n){n[n.None=0]="None",n[n.Hard=1]="Hard",n[n.SoftLow=2]="SoftLow",n[n.SoftHigh=3]="SoftHigh"})(dn||(dn={}));var Ha=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.intensity=1,t.cullingMask=An.Everything,t.shadowType=dn.None,t.shadowBias=1,t.shadowNormalBias=1,t.shadowNearPlane=.1,t.shadowStrength=1,t._lightIndex=-1,t._lightColor=new q,t._color=new q(1,1,1,1),t}var i=s.prototype;return i._getLightIntensityColor=function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor},j(s,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.copyFrom(e)}},{key:"viewMatrix",get:function(){return this._viewMat||(this._viewMat=new Z),Z.invert(this.entity.transform.worldMatrix,this._viewMat),this._viewMat}},{key:"inverseViewMatrix",get:function(){return this._inverseViewMat||(this._inverseViewMat=new Z),Z.invert(this.viewMatrix,this._inverseViewMat),this._inverseViewMat}}]),s}(Rt);T([F],Ha.prototype,"_lightIndex",void 0);var jn=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t._reverseDirection=new R,t}var i=s.prototype;return i._appendData=function(e,r){var a=e*2,o=e*3,c=e*3,l=this._getLightIntensityColor(),_=this.direction,u=this.cullingMask;r.cullingMask[a]=u&65535,r.cullingMask[a+1]=u>>>16&65535,this.engine.settings.colorSpace===or.Linear?(r.color[o]=q.gammaToLinearSpace(l.r),r.color[o+1]=q.gammaToLinearSpace(l.g),r.color[o+2]=q.gammaToLinearSpace(l.b)):(r.color[o]=l.r,r.color[o+1]=l.g,r.color[o+2]=l.b),r.direction[c]=_.x,r.direction[c+1]=_.y,r.direction[c+2]=_.z},i._onEnableInScene=function(){this.scene._lightManager._attachDirectLight(this)},i._onDisableInScene=function(){this.scene._lightManager._detachDirectLight(this)},s._updateShaderData=function(e,r){e.setIntArray(s._cullingMaskProperty,r.cullingMask),e.setFloatArray(s._colorProperty,r.color),e.setFloatArray(s._directionProperty,r.direction)},j(s,[{key:"direction",get:function(){return this.entity.transform.worldForward}},{key:"reverseDirection",get:function(){return R.scale(this.direction,-1,this._reverseDirection),this._reverseDirection}},{key:"_shadowProjectionMatrix",get:function(){throw"Unknown!"}}]),s}(Ha);(function(){jn._cullingMaskProperty=O.getByName("scene_DirectLightCullingMask")})();(function(){jn._colorProperty=O.getByName("scene_DirectLightColor")})();(function(){jn._directionProperty=O.getByName("scene_DirectLightDirection")})();var Yn=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.distance=100,t}var i=s.prototype;return i._appendData=function(e,r){var a=e*2,o=e*3,c=e*3,l=e,_=this._getLightIntensityColor(),u=this.position,h=this.cullingMask;r.cullingMask[a]=h&65535,r.cullingMask[a+1]=h>>>16&65535,this.engine.settings.colorSpace===or.Linear?(r.color[o]=q.gammaToLinearSpace(_.r),r.color[o+1]=q.gammaToLinearSpace(_.g),r.color[o+2]=q.gammaToLinearSpace(_.b)):(r.color[o]=_.r,r.color[o+1]=_.g,r.color[o+2]=_.b),r.position[c]=u.x,r.position[c+1]=u.y,r.position[c+2]=u.z,r.distance[l]=this.distance},i._onEnableInScene=function(){this.scene._lightManager._attachPointLight(this)},i._onDisableInScene=function(){this.scene._lightManager._detachPointLight(this)},s._updateShaderData=function(e,r){e.setIntArray(s._cullingMaskProperty,r.cullingMask),e.setFloatArray(s._colorProperty,r.color),e.setFloatArray(s._positionProperty,r.position),e.setFloatArray(s._distanceProperty,r.distance)},j(s,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"_shadowProjectionMatrix",get:function(){throw"Unknown!"}}]),s}(Ha);(function(){Yn._cullingMaskProperty=O.getByName("scene_PointLightCullingMask")})();(function(){Yn._colorProperty=O.getByName("scene_PointLightColor")})();(function(){Yn._positionProperty=O.getByName("scene_PointLightPosition")})();(function(){Yn._distanceProperty=O.getByName("scene_PointLightDistance")})();var Fr=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.distance=100,t.angle=Math.PI/6,t.penumbra=Math.PI/12,t._inverseDirection=new R,t._projectMatrix=new Z,t}var i=s.prototype;return i._appendData=function(e,r){var a=e*2,o=e*3,c=e*3,l=e*3,_=e,u=e,h=e,d=this._getLightIntensityColor(),f=this.position,v=this.direction,p=this.cullingMask;r.cullingMask[a]=p&65535,r.cullingMask[a+1]=p>>>16&65535,this.engine.settings.colorSpace===or.Linear?(r.color[o]=q.gammaToLinearSpace(d.r),r.color[o+1]=q.gammaToLinearSpace(d.g),r.color[o+2]=q.gammaToLinearSpace(d.b)):(r.color[o]=d.r,r.color[o+1]=d.g,r.color[o+2]=d.b),r.position[c]=f.x,r.position[c+1]=f.y,r.position[c+2]=f.z,r.direction[l]=v.x,r.direction[l+1]=v.y,r.direction[l+2]=v.z,r.distance[_]=this.distance,r.angleCos[h]=Math.cos(this.angle),r.penumbraCos[u]=Math.cos(this.angle+this.penumbra)},i._onEnableInScene=function(){this.scene._lightManager._attachSpotLight(this)},i._onDisableInScene=function(){this.scene._lightManager._detachSpotLight(this)},s._updateShaderData=function(e,r){e.setIntArray(s._cullingMaskProperty,r.cullingMask),e.setFloatArray(s._colorProperty,r.color),e.setFloatArray(s._positionProperty,r.position),e.setFloatArray(s._directionProperty,r.direction),e.setFloatArray(s._distanceProperty,r.distance),e.setFloatArray(s._angleCosProperty,r.angleCos),e.setFloatArray(s._penumbraCosProperty,r.penumbraCos)},j(s,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"direction",get:function(){return this.entity.transform.worldForward}},{key:"reverseDirection",get:function(){return R.scale(this.direction,-1,this._inverseDirection),this._inverseDirection}},{key:"_shadowProjectionMatrix",get:function(){var e=this._projectMatrix,r=Math.min(Math.PI/2,this.angle*2*Math.sqrt(2));return Z.perspective(r,1,this.shadowNearPlane,this.distance+this.shadowNearPlane,e),e}}]),s}(Ha);(function(){Fr._cullingMaskProperty=O.getByName("scene_SpotLightCullingMask")})();(function(){Fr._colorProperty=O.getByName("scene_SpotLightColor")})();(function(){Fr._positionProperty=O.getByName("scene_SpotLightPosition")})();(function(){Fr._directionProperty=O.getByName("scene_SpotLightDirection")})();(function(){Fr._distanceProperty=O.getByName("scene_SpotLightDistance")})();(function(){Fr._angleCosProperty=O.getByName("scene_SpotLightAngleCos")})();(function(){Fr._penumbraCosProperty=O.getByName("scene_SpotLightPenumbraCos")})();var zn=function(){function n(){this._spotLights=new He,this._pointLights=new He,this._directLights=new He,this._directData={cullingMask:new Int32Array(n._maxLight*2),color:new Float32Array(n._maxLight*3),direction:new Float32Array(n._maxLight*3)},this._pointData={cullingMask:new Int32Array(n._maxLight*2),color:new Float32Array(n._maxLight*3),position:new Float32Array(n._maxLight*3),distance:new Float32Array(n._maxLight)},this._spotData={cullingMask:new Int32Array(n._maxLight*2),color:new Float32Array(n._maxLight*3),position:new Float32Array(n._maxLight*3),direction:new Float32Array(n._maxLight*3),distance:new Float32Array(n._maxLight),angleCos:new Float32Array(n._maxLight),penumbraCos:new Float32Array(n._maxLight)}}var s=n.prototype;return s._attachSpotLight=function(t){t._lightIndex=this._spotLights.length,this._spotLights.add(t)},s._detachSpotLight=function(t){var e=this._spotLights.deleteByIndex(t._lightIndex);e&&(e._lightIndex=t._lightIndex),t._lightIndex=-1},s._attachPointLight=function(t){t._lightIndex=this._pointLights.length,this._pointLights.add(t)},s._detachPointLight=function(t){var e=this._pointLights.deleteByIndex(t._lightIndex);e&&(e._lightIndex=t._lightIndex),t._lightIndex=-1},s._attachDirectLight=function(t){t._lightIndex=this._directLights.length,this._directLights.add(t)},s._detachDirectLight=function(t){var e=this._directLights.deleteByIndex(t._lightIndex);e&&(e._lightIndex=t._lightIndex),t._lightIndex=-1},s._updateShaderData=function(t){for(var e=this,r=e._spotLights,a=e._pointLights,o=e._directLights,c=this,l=c._spotData,_=c._pointData,u=c._directData,h=n._maxLight,d=Math.min(r.length,h),f=Math.min(a.length,h),v=Math.min(o.length,h),p=0;p<d;p++)r.get(p)._appendData(p,l);for(var g=0;g<f;g++)a.get(g)._appendData(g,_);for(var y=0;y<v;y++)o.get(y)._appendData(y,u);v?(jn._updateShaderData(t,u),t.enableMacro("SCENE_DIRECT_LIGHT_COUNT",v.toString())):t.disableMacro("SCENE_DIRECT_LIGHT_COUNT"),f?(Yn._updateShaderData(t,_),t.enableMacro("SCENE_POINT_LIGHT_COUNT",f.toString())):t.disableMacro("SCENE_POINT_LIGHT_COUNT"),d?(Fr._updateShaderData(t,l),t.enableMacro("SCENE_SPOT_LIGHT_COUNT",d.toString())):t.disableMacro("SCENE_SPOT_LIGHT_COUNT")},s._gc=function(){this._spotLights.garbageCollection(),this._pointLights.garbageCollection(),this._directLights.garbageCollection()},s._updateSunlightIndex=function(t){var e=this._directLights,r=t._lightIndex;if(r>0){var a=e.get(0),o=e.get(r);e.set(0,o),e.set(r,a),o._lightIndex=0,a._lightIndex=r}},s._getMaxBrightestSunlight=function(){for(var t=this._directLights,e=null,r=Number.NEGATIVE_INFINITY,a=!1,o=0,c=t.length;o<c;o++){var l=t.get(o);l.shadowType!==dn.None&&!a&&(r=Number.NEGATIVE_INFINITY,a=!0);var _=l.intensity*l.color.getBrightness();a?l.shadowType!==dn.None&&r<_&&(r=_,e=l):r<_&&(r=_,e=l)}return e},n}();(function(){zn._sunlightColorProperty=O.getByName("scene_SunlightColor")})();(function(){zn._sunlightDirectionProperty=O.getByName("scene_SunlightDirection")})();(function(){zn._maxLight=10})();var Wa=function(n){W(s,n);function s(t,e){var r;r=n.call(this,t)||this,r.physics=new Gt(ce(r)),r.castShadows=!0,r.shadowResolution=Sn.Medium,r.shadowTwoCascadeSplits=1/3,r.shadowFourCascadeSplits=new R(1/15,3/15,7/15),r.shadowDistance=50,r.shadowFadeBorder=.1,r._lightManager=new zn,r._componentsManager=new Uu,r._isActiveInEngine=!1,r._globalShaderMacro=new Kt,r._rootEntities=[],r._background=new Uc(r._engine),r._shaderData=new Nr(xr.Scene),r._shadowCascades=pr.NoCascades,r._fogMode=bi.None,r._fogColor=new q(.5,.5,.5,1),r._fogStart=0,r._fogEnd=300,r._fogDensity=.01,r._fogParams=new ie,r._isActive=!0,r.name=e||"";var a=r.shaderData;return a._addReferCount(1),r.ambientLight=new Tr(t),t.sceneManager._allCreatedScenes.push(ce(r)),a.enableMacro("SCENE_FOG_MODE",r._fogMode.toString()),a.enableMacro("SCENE_SHADOW_CASCADED_COUNT",r.shadowCascades.toString()),a.setColor(s._fogColorProperty,r._fogColor),a.setVector4(s._fogParamsProperty,r._fogParams),r._computeLinearFogParams(r._fogStart,r._fogEnd),r._computeExponentialFogParams(r._fogDensity),r}var i=s.prototype;return i.createRootEntity=function(e){var r=new Yt(this._engine,e);return this.addRootEntity(r),r},i.addRootEntity=function(e,r){var a;typeof e=="number"?a=e:(a=void 0,r=e);var o=r._isRoot;o||(r._isRoot=!0,r._removeFromParent());var c=r._scene;c!==this?(c&&o&&c._removeFromEntityList(r),this._addToRootEntityList(a,r)):o||this._addToRootEntityList(a,r);var l=ue.None;r._isActiveInHierarchy&&(this._isActiveInEngine||(l|=ue.Hierarchy)),r._isActiveInScene&&c!==this&&(l|=ue.Scene),l&&r._processInActive(l),c!==this&&Yt._traverseSetOwnerScene(r,this);var _=ue.None;r._isActive&&(this._isActiveInEngine&&!r._isActiveInHierarchy&&(_|=ue.Hierarchy),(!r._isActiveInScene||c!==this)&&(_|=ue.Scene)),_&&r._processActive(_)},i.removeRootEntity=function(e){if(e._isRoot&&e._scene==this){this._removeFromEntityList(e),e._isRoot=!1;var r=ue.None;this._isActiveInEngine&&e._isActiveInHierarchy&&(r|=ue.Hierarchy),e._isActiveInScene&&(r|=ue.Scene),r&&e._processInActive(r),Yt._traverseSetOwnerScene(e,null)}},i.getRootEntity=function(e){return e===void 0&&(e=0),this._rootEntities[e]},i.findEntityByName=function(e){for(var r=this._rootEntities,a=0,o=r.length;a<o;a++){var c=r[a].findByName(e);if(c)return c}return null},i.findEntityByPath=function(e){for(var r=e.split("/").filter(Boolean),a=0,o=this.rootEntitiesCount;a<o;a++){var c=this.getRootEntity(a);if(c.name==r[0]){for(var l=1,_=r.length;l<_&&(c=Yt._findChildByName(c,r[l]),!!c);++l);return c}}return null},i._processActive=function(e){this._isActiveInEngine=e;for(var r=this._rootEntities,a=r.length-1;a>=0;a--){var o=r[a];o._isActive&&(e?o._processActive(ue.Hierarchy):o._processInActive(ue.Hierarchy))}},i._updateShaderData=function(){var e=this.shaderData,r=this._engine,a=this._lightManager;r.time._updateSceneShaderData(e),a._updateShaderData(this.shaderData);var o=this._lightManager._sunlight=this._getSunlight();o?(a._updateSunlightIndex(o),e.setColor(zn._sunlightColorProperty,o._lightColor),e.setVector3(zn._sunlightDirectionProperty,o.direction)):e.setVector3(zn._sunlightDirectionProperty,R._zero),this.castShadows&&o&&o.shadowType!==dn.None?e.enableMacro("SCENE_SHADOW_TYPE",o.shadowType.toString()):e.disableMacro("SCENE_SHADOW_TYPE"),Kt.unionCollection(this.engine._macroCollection,e._macroCollection,this._globalShaderMacro)},i._removeFromEntityList=function(e){var r=this._rootEntities,a=e._siblingIndex;r.splice(a,1);for(var o=r.length;a<o;a++)r[a]._siblingIndex--;e._siblingIndex=-1},i._onDestroy=function(){n.prototype._onDestroy.call(this);var e=this._engine.sceneManager;for(e.removeScene(this);this.rootEntitiesCount>0;)this._rootEntities[0].destroy();this.background.destroy(),this._ambientLight&&this._ambientLight._removeFromScene(this),this.shaderData._addReferCount(-1),this._componentsManager.handlingInvalidScripts();var r=e._allCreatedScenes;r.splice(r.indexOf(this),1)},i._addToRootEntityList=function(e,r){var a=this._rootEntities,o=a.length;if(e===void 0)r._siblingIndex=o,a.push(r);else{if(e<0||e>o)throw"The index "+e+" is out of child list bounds "+o;r._siblingIndex=e,a.splice(e,0,r);for(var c=e+1,l=o+1;c<l;c++)a[c]._siblingIndex++}},i._computeLinearFogParams=function(e,r){var a=r-e,o=this._fogParams;o.x=-1/a,o.y=r/a},i._computeExponentialFogParams=function(e){this._fogParams.z=e/Math.LN2,this._fogParams.w=e/Math.sqrt(Math.LN2)},i._getSunlight=function(){var e=null;return this._sun?e=this._sun.enabled?this._sun:null:e=this._lightManager._getMaxBrightestSunlight(),e},j(s,[{key:"isActive",get:function(){return this._isActive},set:function(e){this._isActive!==e&&(this._isActive=e,e?this._sceneManager&&this._processActive(!0):this._sceneManager&&this._processActive(!1))}},{key:"shaderData",get:function(){return this._shaderData}},{key:"background",get:function(){return this._background}},{key:"shadowCascades",get:function(){return this._shadowCascades},set:function(e){this._shadowCascades!==e&&(this.shaderData.enableMacro("SCENE_SHADOW_CASCADED_COUNT",e.toString()),this._shadowCascades=e)}},{key:"ambientLight",get:function(){return this._ambientLight},set:function(e){if(!e){ve.warn("The scene must have one ambient light");return}var r=this._ambientLight;r!==e&&(r&&r._removeFromScene(this),e._addToScene(this),this._ambientLight=e)}},{key:"fogMode",get:function(){return this._fogMode},set:function(e){this._fogMode!==e&&(this.shaderData.enableMacro("SCENE_FOG_MODE",e.toString()),this._fogMode=e)}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor!==e&&this._fogColor.copyFrom(e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart!==e&&(this._computeLinearFogParams(e,this._fogEnd),this._fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd!==e&&(this._computeLinearFogParams(this._fogStart,e),this._fogEnd=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity!==e&&(this._computeExponentialFogParams(e),this._fogDensity=e)}},{key:"rootEntitiesCount",get:function(){return this._rootEntities.length}},{key:"rootEntities",get:function(){return this._rootEntities}},{key:"sun",get:function(){return this._sun},set:function(e){this._sun=e}}]),s}(Yr);(function(){Wa._fogColorProperty=O.getByName("scene_FogColor")})();(function(){Wa._fogParamsProperty=O.getByName("scene_FogParams")})();var zr=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t._started=!1,t._onStartIndex=-1,t._onUpdateIndex=-1,t._onLateUpdateIndex=-1,t._onPhysicsUpdateIndex=-1,t._onPreRenderIndex=-1,t._onPostRenderIndex=-1,t._entityScriptsIndex=-1,t}var i=s.prototype;return i.onAwake=function(){},i.onEnable=function(){},i.onStart=function(){},i.onUpdate=function(e){},i.onLateUpdate=function(e){},i.onBeginRender=function(e){},i.onEndRender=function(e){},i.onPhysicsUpdate=function(){},i.onTriggerEnter=function(e){},i.onTriggerExit=function(e){},i.onTriggerStay=function(e){},i.onCollisionEnter=function(e){},i.onCollisionExit=function(e){},i.onCollisionStay=function(e){},i.onPointerDown=function(e){},i.onPointerUp=function(e){},i.onPointerClick=function(e){},i.onPointerEnter=function(e){},i.onPointerExit=function(e){},i.onPointerDrag=function(e){},i.onDisable=function(){},i.onDestroy=function(){},i._onAwake=function(){this.onAwake()},i._onEnable=function(){this.onEnable()},i._onDisable=function(){this.onDisable()},i._onEnableInScene=function(){var e=this.scene,r=e._componentsManager,a=s.prototype;this._started||r.addOnStartScript(this),this.onUpdate!==a.onUpdate&&r.addOnUpdateScript(this),this.onLateUpdate!==a.onLateUpdate&&r.addOnLateUpdateScript(this),this.onPhysicsUpdate!==a.onPhysicsUpdate&&r.addOnPhysicsUpdateScript(this),this._entity._addScript(this)},i._onDisableInScene=function(){var e=this.scene._componentsManager,r=s.prototype;this._started||e.removeOnStartScript(this),this.onUpdate!==r.onUpdate&&e.removeOnUpdateScript(this),this.onLateUpdate!==r.onLateUpdate&&e.removeOnLateUpdateScript(this),this.onPhysicsUpdate!==r.onPhysicsUpdate&&e.removeOnPhysicsUpdateScript(this),this._entity._removeScript(this)},i._onDestroy=function(){n.prototype._onDestroy.call(this),this.scene?this.scene._componentsManager.addPendingDestroyScript(this):this.onDestroy()},s}(Rt);T([F],zr.prototype,"_started",void 0);T([F],zr.prototype,"_onStartIndex",void 0);T([F],zr.prototype,"_onUpdateIndex",void 0);T([F],zr.prototype,"_onLateUpdateIndex",void 0);T([F],zr.prototype,"_onPhysicsUpdateIndex",void 0);T([F],zr.prototype,"_onPreRenderIndex",void 0);T([F],zr.prototype,"_onPostRenderIndex",void 0);T([F],zr.prototype,"_entityScriptsIndex",void 0);var Va;(function(n){n[n.None=0]="None",n[n.PrePass=1]="PrePass"})(Va||(Va={}));var Lo=function(s){this._engine=s},cr=function(){function n(){}return n.recreateTextureIfNeeded=function(i,t,e,r,a,o){if(t)if(t.width!==e||t.height!==r||t.format!==a||t.mipmapCount>1!==o){t.destroy(!0);var c=new Tt(i,e,r,a,o);return c.isGCIgnored=!0,c}else return t;else{var l=new Tt(i,e,r,a,o);return l.isGCIgnored=!0,l}},n.recreateRenderTargetIfNeeded=function(i,t,e,r,a,o,c,l,_){var u,h=(u=t)==null?void 0:u.getColorTexture(0),d=a?n.recreateTextureIfNeeded(i,h,e,r,a,l):null;if(c){var f,v=(f=t)==null?void 0:f.depthTexture,p=o?n.recreateTextureIfNeeded(i,v,e,r,o,l):null;if(h!==d||v!==p){var g;(g=t)==null||g.destroy(!0),t=new Da(i,e,r,d,p,_),t.isGCIgnored=!0}}else{var y,m=o;if(h!==d||((y=t)==null?void 0:y._depthFormat)!==m){var x;(x=t)==null||x.destroy(!0),t=new Da(i,e,r,d,m,_),t.isGCIgnored=!0}}return t},n.blitTexture=function(i,t,e,r,a){r===void 0&&(r=0);var o=i._basicResources,c=e?o.flipYBlitMesh:o.blitMesh,l=o.blitMaterial,_=i._hardwareRenderer,u=i._renderContext;u.flipProjection=!!e,_.activeRenderTarget(e,a??n.defaultViewport,u.flipProjection,0);var h=n._rendererShaderData,d=l.shader.subShaders[0].passes[0],f=d._getShaderProgram(i,Se._compileMacros);h.setTexture(n._blitTextureProperty,t),h.setFloat(n._blitMipLevelProperty,r),f.bind(),f.groupingOtherUniformBlock(),f.uploadAll(f.rendererUniformBlock,h),f.uploadAll(f.materialUniformBlock,l.shaderData),f.uploadUnGroupTextures(),(d._renderState||l.renderState)._apply(i,!1,d._renderStateDataMap,l.shaderData),_.drawPrimitive(c._primitive,c.subMesh,f)},n}();(function(){cr._blitTextureProperty=O.getByName("renderer_BlitTexture")})();(function(){cr._blitMipLevelProperty=O.getByName("renderer_BlitMipLevel")})();(function(){cr._rendererShaderData=new Nr(xr.Renderer)})();(function(){cr.defaultViewport=new ie(0,0,1,1)})();var kc=function(n){W(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.createVertexElements=function(e){return e[0]=new Te("POSITION",0,$.Vector3,0),e[1]=new Te("TEXCOORD_0",12,$.Vector2,0),e[2]=new Te("COLOR_0",20,$.Vector4,0),36},i.canBatch=function(e,r){if(!this._engine._canSpriteBatch||r.shaderPasses[0].getTagValue(Lr._disableBatchTag)===!0)return!1;var a=e.data,o=r.data,c=a.component,l=o.component;return!this.checkBatchWithMask(c,l)||a.texture!==o.texture?!1:a.material===o.material},i.checkBatchWithMask=function(e,r){var a=e.maskInteraction;return a!==r.maskInteraction?!1:a===ct.None?!0:e.maskLayer===r.maskLayer},i.updateVertices=function(e,r,a){for(var o=e.verticesData,c=o.positions,l=o.uvs,_=o.color,u=o.vertexCount,h=0;h<u;h++){var d=c[h],f=l[h];r[a++]=d.x,r[a++]=d.y,r[a++]=d.z,r[a++]=f.x,r[a++]=f.y,r[a++]=_.r,r[a++]=_.g,r[a++]=_.b,r[a++]=_.a}return a},i.drawBatches=function(e){for(var r=this,a=r._engine,o=r._batchedQueue,c=this._meshes[this._flushId],l=c.subMeshes,_=c._primitive,u=a._spriteMaskManager,h=e.scene.shaderData,d=e.shaderData,f=0,v=l.length;f<v;f++){var p=l[f],g=o[f],y=g.data;if(!p||!g)return;var m=y.component,x=y.material;u.preRender(e,m);var C=Se._compileMacros;Kt.unionCollection(m._globalShaderMacro,x.shaderData._macroCollection,C);var b=g.shaderPasses[0],A=b._getShaderProgram(a,C);if(!A.isValid)return;m.shaderData.setTexture(s._textureProperty,y.texture),A.bind(),A.groupingOtherUniformBlock(),A.uploadAll(A.sceneUniformBlock,h),A.uploadAll(A.cameraUniformBlock,d),A.uploadAll(A.rendererUniformBlock,m.shaderData),A.uploadAll(A.materialUniformBlock,x.shaderData),(b._renderState||x.renderState)._apply(a,!1,b._renderStateDataMap,x.shaderData),a._hardwareRenderer.drawPrimitive(_,p,A),u.postRender(m)}},s}(Lr);(function(){kc._textureProperty=O.getByName("renderer_SpriteTexture")})();var rn=function(){function n(i,t){this.elements=[],this._initSpriteBatcher(i),this._renderQueueType=t}var s=n.prototype;return s.pushRenderElement=function(t){this.elements.push(t)},s.render=function(t,e){var r=this.elements;if(r.length!==0){for(var a=t.engine,o=t.instanceId,c=t.shaderData,l=t.scene,_=l.shaderData,u=l.instanceId,h=a._renderCount,d=a._hardwareRenderer,f=Qt.pipelineStageKey,v=this._renderQueueType,p=0,g=r.length;p<g;p++){var y=r[p],m=y.data,x=y.shaderPasses;if(m.primitive){this._spriteBatcher.flush(t);var C=Se._compileMacros,b=m.primitive,A=m.component,S=m.material,w=A.shaderData,E=A.instanceId,P=S.shaderData,M=S.instanceId,D=S.renderStates;Kt.unionCollection(A._globalShaderMacro,P._macroCollection,C);for(var L=0,V=x.length;L<V;L++){var N=x[L];if(N.getTagValue(f)===e){var I;if(((I=N._renderState)!=null?I:D[L]).renderQueueType===v){var B=N._getShaderProgram(a,C);if(B.isValid){var z=B.bind(),U=h!==B._uploadRenderCount;U?(B.groupingOtherUniformBlock(),B.uploadAll(B.sceneUniformBlock,_),B.uploadAll(B.cameraUniformBlock,c),B.uploadAll(B.rendererUniformBlock,w),B.uploadAll(B.materialUniformBlock,P),B.uploadUnGroupTextures(),B._uploadSceneId=u,B._uploadCameraId=o,B._uploadRendererId=E,B._uploadMaterialId=M,B._uploadRenderCount=h):(B._uploadSceneId!==u?(B.uploadAll(B.sceneUniformBlock,_),B._uploadSceneId=u):z&&B.uploadTextures(B.sceneUniformBlock,_),B._uploadCameraId!==o?(B.uploadAll(B.cameraUniformBlock,c),B._uploadCameraId=o):z&&B.uploadTextures(B.cameraUniformBlock,c),B._uploadRendererId!==E?(B.uploadAll(B.rendererUniformBlock,w),B._uploadRendererId=E):z&&B.uploadTextures(B.rendererUniformBlock,w),B._uploadMaterialId!==M?(B.uploadAll(B.materialUniformBlock,P),B._uploadMaterialId=M):z&&B.uploadTextures(B.materialUniformBlock,P),z&&B.uploadUnGroupTextures());var Y,Q=(Y=N._renderState)!=null?Y:D[L];Q._apply(a,A.entity.transform._isFrontFaceInvert(),N._renderStateDataMap,S.shaderData),d.drawPrimitive(b,m.subPrimitive,B)}}}}}else this._spriteBatcher.drawElement(y,t)}this._spriteBatcher.flush(t)}},s.clear=function(){this.elements.length=0,this._spriteBatcher.clear()},s.destroy=function(){this._spriteBatcher.destroy(),this._spriteBatcher=null},s.sort=function(t){Ue._quickSort(this.elements,0,this.elements.length,t)},s._initSpriteBatcher=function(t){this._spriteBatcher=new kc(t)},n._compareFromNearToFar=function(t,e){var r=t.data,a=e.data,o=r.component,c=a.component,l=o.priority-c.priority;if(l!==0)return l;if(o.instanceId===c.instanceId)return r.material._priority-a.material._priority;var _=o._distanceForSort-c._distanceForSort;return _===0?o.instanceId-c.instanceId:_},n._compareFromFarToNear=function(t,e){var r=t.data,a=e.data,o=r.component,c=a.component,l=o.priority-c.priority;if(l!==0)return l;if(o.instanceId===c.instanceId)return r.material._priority-a.material._priority;var _=c._distanceForSort-o._distanceForSort;return _===0?o.instanceId-c.instanceId:_},n}(),Gc=function(){this.position=new R,this.isOrthographic=!1,this.viewMatrix=new Z,this.projectionMatrix=new Z,this.viewProjectionMatrix=new Z,this.nearClipPlane=.1,this.farClipPlane=100,this.forward=new R},ku=function(){this.virtualCamera=new Gc,this.cullPlanes=[new ht(new R),new ht(new R),new ht(new R),new ht(new R),new ht(new R),new ht(new R),new ht(new R),new ht(new R),new ht(new R),new ht(new R)],this.splitBoundSphere=new xc(new R,0)},ss;(function(n){n[n.FarBottomLeft=0]="FarBottomLeft",n[n.FarTopLeft=1]="FarTopLeft",n[n.FarTopRight=2]="FarTopRight",n[n.FarBottomRight=3]="FarBottomRight",n[n.nearBottomLeft=4]="nearBottomLeft",n[n.nearTopLeft=5]="nearTopLeft",n[n.nearTopRight=6]="nearTopRight",n[n.nearBottomRight=7]="nearBottomRight",n[n.unknown=8]="unknown"})(ss||(ss={}));var st=function(){function n(){}return n.shadowResolution=function(i){switch(i){case Sn.Low:return 512;case Sn.Medium:return 1024;case Sn.High:return 2048;case Sn.VeryHigh:return 4096}},n.shadowDepthFormat=function(i,t){return t?G.Depth16:G.R8G8B8A8},n.cullingRenderBounds=function(i,t,e){for(var r=i.min,a=i.max,o=0;o<t;o++){var c=e[o],l=c.normal;if(l.x*(l.x>=0?a.x:r.x)+l.y*(l.y>=0?a.y:r.y)+l.z*(l.z>=0?a.z:r.z)<-c.distance)return!1}return!0},n.shadowCullFrustum=function(i,t,e,r){var a=e._entity.layer;i.camera.cullingMask&a&&t.cullingMask&a&&e.castShadows&&n.cullingRenderBounds(e.bounds,r.cullPlaneCount,r.cullPlanes)&&(e._renderFrameCount=e.engine.time.frameCount,e._prepareRender(i))},n.getBoundSphereByFrustum=function(i,t,e,r,a){var o=e.aspectRatio,c=e.fieldOfView,l,_,u=Math.sqrt(1+o*o)*Math.tan(k.degreeToRadian(c)/2),h=u*u,d=t-i,f=t+i;h>d/f?(l=t,_=t*u):(l=.5*f*(1+h),_=.5*Math.sqrt(d*d+2*(t*t+i*i)*h+f*f*h*h));var v=a.splitBoundSphere.center;a.splitBoundSphere.radius=_,R.scale(r,l,v),R.add(e.entity.transform.worldPosition,v,v),a.sphereCenterZ=l},n.getDirectionLightShadowCullPlanes=function(i,t,e,r,a){var o=n._frustumCorners,c=n._backPlaneFaces,l=n._frustumPlaneNeighbors,_=n._frustumTwoPlaneCorners,u=n._edgePlanePoint2,h=a.cullPlanes,d=i.getPlane(me.Near),f=i.getPlane(me.Far),v=i.getPlane(me.Left),p=i.getPlane(me.Right),g=i.getPlane(me.Bottom),y=i.getPlane(me.Top),m=t-e,x=n._adjustNearPlane,C=n._adjustFarPlane;x.normal.copyFrom(d.normal),C.normal.copyFrom(f.normal),x.distance=d.distance-m,C.distance=Math.min(-d.distance+a.sphereCenterZ+a.splitBoundSphere.radius,f.distance),wt.intersectionPointThreePlanes(x,g,p,o[7]),wt.intersectionPointThreePlanes(x,y,p,o[6]),wt.intersectionPointThreePlanes(x,y,v,o[5]),wt.intersectionPointThreePlanes(x,g,v,o[4]),wt.intersectionPointThreePlanes(C,g,p,o[3]),wt.intersectionPointThreePlanes(C,y,p,o[2]),wt.intersectionPointThreePlanes(C,y,v,o[1]),wt.intersectionPointThreePlanes(C,g,v,o[0]);for(var b=0,A=0;A<6;A++){var S=void 0;switch(A){case me.Near:S=x;break;case me.Far:S=C;break;default:S=i.getPlane(A);break}R.dot(S.normal,r)<0&&(h[b].copyFrom(S),c[b]=A,b++)}for(var w=b,E=0;E<b;E++)for(var P=c[E],M=l[P],D=0;D<4;D++){for(var L=M[D],V=!0,N=0;N<b;N++)if(L==c[N]){V=!1;break}if(V){var I=_[P][L],B=o[I[0]],z=o[I[1]];R.add(B,r,u),ht.fromPoints(B,z,u,h[w++])}}a.cullPlaneCount=w},n.getDirectionalLightMatrices=function(i,t,e,r,a,o,c,l){var _=c.splitBoundSphere;c.resolution=o;var u=_.center,h=_.radius,d=o/2,f=h*d/(d-n.atlasBorderSize),v=f*2,p=o/v,g=v/o,y=Math.ceil(R.dot(u,i)*p)*g,m=Math.ceil(R.dot(u,t)*p)*g,x=R.dot(u,e);u.x=i.x*y+t.x*m+e.x*x,u.y=i.y*y+t.y*m+e.y*x,u.z=i.z*y+t.z*m+e.z*x;var C=c.virtualCamera,b=C.position,A=C.viewMatrix,S=C.projectionMatrix;R.scale(e,h+a,b),R.subtract(u,b,b),Z.lookAt(b,u,i,A),Z.ortho(-f,f,-f,f,0,h*2+a,S);var w=C.viewProjectionMatrix;Z.multiply(S,A,w),Ue._floatMatrixMultiply(n._shadowMapCoordMatrix,w.elements,0,l,r*16)},n.getMaxTileResolutionInAtlas=function(i,t,e){for(var r=Math.min(i,t),a=Math.floor(i/r)*Math.floor(t/r);a<e;)r=Math.floor(r>>1),a=Math.floor(i/r)*Math.floor(t/r);return r},n.getShadowBias=function(i,t,e,r){var a=2/t.elements[0],o=a/e,c=-i.shadowBias*o,l=-i.shadowNormalBias*o;if(i.shadowType==dn.SoftHigh){var _=2.5;c*=_,l*=_}r.set(c,l)},n.applySliceTransform=function(i,t,e,r,a,o){var c=n._tempMatrix0,l=c.elements,_=1/t,u=1/e,h=i*_,d=i*u,f=a.x*_,v=a.y*u;l[0]=h,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=d,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=1,l[11]=0,l[12]=f,l[13]=v,l[14]=0,l[15]=1;var p=r*16;Ue._floatMatrixMultiply(c,o,p,o,p)},n.getScaleAndBiasForLinearDistanceFade=function(i,t,e){if(t<1e-4){var r=1e3;e.z=r,e.w=-i*r;return}t=1-t,t*=t;var a=t*i,o=i-a;e.z=1/o,e.w=-a/o},n}();(function(){st._tempMatrix0=new Z})();(function(){st._shadowMapCoordMatrix=new Z(.5,0,0,0,0,-.5,0,0,0,0,.5,0,.5,.5,.5,1)})();(function(){st._frustumCorners=[new R,new R,new R,new R,new R,new R,new R,new R]})();(function(){st._adjustNearPlane=new ht(new R)})();(function(){st._adjustFarPlane=new ht(new R)})();(function(){st._backPlaneFaces=new Array(5)})();(function(){st._edgePlanePoint2=new R})();(function(){st._frustumPlaneNeighbors=[[me.Left,me.Right,me.Top,me.Bottom],[me.Left,me.Right,me.Top,me.Bottom],[me.Near,me.Far,me.Top,me.Bottom],[me.Near,me.Far,me.Top,me.Bottom],[me.Near,me.Far,me.Left,me.Right],[me.Near,me.Far,me.Left,me.Right]]})();(function(){st._frustumTwoPlaneCorners=[[[8,8],[8,8],[4,5],[6,7],[7,4],[5,6]],[[8,8],[8,8],[1,0],[3,2],[0,3],[2,1]],[[5,4],[0,1],[8,8],[8,8],[4,0],[1,5]],[[7,6],[2,3],[8,8],[8,8],[3,7],[6,2]],[[4,7],[3,0],[0,4],[7,3],[8,8],[8,8]],[[6,5],[1,2],[5,1],[2,6],[8,8],[8,8]]]})();(function(){st.atlasBorderSize=4})();var Ut=function(n){W(s,n);function s(t){var e;return e=n.call(this,t.engine)||this,e._shadowMapSize=new ie,e._shadowBias=new ee,e._shadowSliceData=new ku,e._lightUp=new R,e._lightSide=new R,e._splitBoundSpheres=new Float32Array(s._maxCascades*4),e._shadowMatrices=new Float32Array((s._maxCascades+1)*16),e._shadowInfos=new ie,e._viewportOffsets=[new ee,new ee,new ee,new ee],e._camera=t,e._supportDepthTexture=t.engine._hardwareRenderer.canIUse(K.depthTexture),e._shadowSliceData.virtualCamera.isOrthographic=!0,e}var i=s.prototype;return i.onRender=function(e){var r=this._camera.scene._lightManager._sunlight;this._updateShadowSettings(),this._renderDirectShadowMap(e,r),this._updateReceiversShaderData(r)},i._renderDirectShadowMap=function(e,r){var a=this,o=a._engine,c=a._camera,l=a._viewportOffsets,_=a._shadowSliceData,u=a._splitBoundSpheres,h=a._shadowMatrices,d=c._renderPipeline._cullingResults,f=d.opaqueQueue,v=d.alphaTestQueue,p=d.transparentQueue,g=c.scene,y=g._componentsManager,m=o._hardwareRenderer,x=g.shadowCascades,C=s._cascadesSplitDistance,b=_.splitBoundSphere,A=s._tempMatrix0,S=A.elements,w=this._lightUp,E=this._lightSide,P=_.virtualCamera.forward,M=this._shadowMapSize,D=M.z,L=M.w,V=this._shadowMapFormat,N,I;this._supportDepthTexture?(N=cr.recreateRenderTargetIfNeeded(o,this._renderTarget,D,L,null,V,!0,!1,1),I=N.depthTexture):(N=cr.recreateRenderTargetIfNeeded(o,this._renderTarget,D,L,V,null,!1,!1,1),I=N.getColorTexture(0)),I.wrapModeU=I.wrapModeV=gt.Clamp,o._hardwareRenderer._isWebGL2&&(I.depthCompareFunction=vr.Less),this._renderTarget=N,this._depthTexture=I,m.activeRenderTarget(N,s._viewport,e.flipProjection,0),this._supportDepthTexture?m.clearRenderTarget(o,zt.Depth,null):m.clearRenderTarget(o,zt.All,s._clearColor),Z.rotationQuaternion(r.entity.transform.worldRotationQuaternion,A),E.set(S[0],S[1],S[2]),w.set(S[4],S[5],S[6]),P.set(-S[8],-S[9],-S[10]);var B=s._tempVector;B.copyFrom(c.entity.transform.worldForward);for(var z=this._shadowTileResolution,U=0;U<x;U++){st.getBoundSphereByFrustum(C[U],C[U+1],c,B,_),st.getDirectionLightShadowCullPlanes(c._frustum,C[U],c.nearClipPlane,P,_),st.getDirectionalLightMatrices(w,E,P,U,r.shadowNearPlane,z,_,h),x>1&&st.applySliceTransform(z,D,L,U,this._viewportOffsets[U],h),this._updateSingleShadowCasterShaderData(r,_,e);var Y=b.center,Q=b.radius,H=U*4;u[H]=Y.x,u[H+1]=Y.y,u[H+2]=Y.z,u[H+3]=Q*Q,f.clear(),v.clear(),p.clear();for(var te=y._renderers,Ce=te._elements,de=te.length-1;de>=0;--de)st.shadowCullFrustum(e,r,Ce[de],_);if(f.elements.length||v.elements.length){f.sort(rn._compareFromNearToFar),v.sort(rn._compareFromNearToFar);var ae=l[U],Ae=ae.x,je=ae.y;m.setGlobalDepthBias(1,1),m.viewport(Ae,je,z,z),m.scissor(Ae+1,je+1,z-2,z-2),o._renderCount++,f.render(c,Ot.ShadowCaster),v.render(c,Ot.ShadowCaster),m.setGlobalDepthBias(0,0)}}},i._updateReceiversShaderData=function(e){var r=this._camera,a=r.scene,o=this._splitBoundSpheres,c=this._shadowMatrices,l=a.shadowCascades,_=Math.min(a.shadowDistance,r.farClipPlane);if(st.getScaleAndBiasForLinearDistanceFade(Math.pow(_,2),a.shadowFadeBorder,this._shadowInfos),this._shadowInfos.x=e.shadowStrength,l>1)for(var u=l*4,h=o.length;u<h;u++)o[u]=0;for(var d=l*16,f=c.length;d<f;d++)c[d]=0;var v=a.shaderData;v.setFloatArray(s._shadowMatricesProperty,this._shadowMatrices),v.setVector4(s._shadowInfosProperty,this._shadowInfos),v.setTexture(s._shadowMapsProperty,this._depthTexture),v.setFloatArray(s._shadowSplitSpheresProperty,this._splitBoundSpheres),v.setVector4(s._shadowMapSize,this._shadowMapSize)},i._getCascadesSplitDistance=function(e){var r=s._cascadesSplitDistance,a=this._camera.scene,o=a.shadowTwoCascadeSplits,c=a.shadowFourCascadeSplits,l=a.shadowCascades,_=this._camera,u=_.nearClipPlane,h=_.aspectRatio,d=_.fieldOfView;r[0]=u;var f=e-u,v=Math.tan(k.degreeToRadian(d)*.5),p=1+v*v*(h*h+1);switch(l){case pr.NoCascades:r[1]=this._getFarWithRadius(e,p);break;case pr.TwoCascades:r[1]=this._getFarWithRadius(u+f*o,p),r[2]=this._getFarWithRadius(e,p);break;case pr.FourCascades:r[1]=this._getFarWithRadius(u+f*c.x,p),r[2]=this._getFarWithRadius(u+f*c.y,p),r[3]=this._getFarWithRadius(u+f*c.z,p),r[4]=this._getFarWithRadius(e,p);break}},i._getFarWithRadius=function(e,r){return Math.sqrt(e*e/r)},i._updateShadowSettings=function(){var e=this._camera,r=e.scene,a=st.shadowDepthFormat(r.shadowResolution,this._supportDepthTexture),o=st.shadowResolution(r.shadowResolution),c=r.shadowCascades,l=Math.min(r.shadowDistance,e.farClipPlane);if(this._getCascadesSplitDistance(l),a!==this._shadowMapFormat||o!==this._shadowMapResolution||c!==this._shadowCascadeMode){if(this._shadowMapFormat=a,this._shadowMapResolution=o,this._shadowCascadeMode=c,c==pr.NoCascades)this._shadowTileResolution=o,this._shadowMapSize.set(1/o,1/o,o,o);else{var _=st.getMaxTileResolutionInAtlas(o,o,c);this._shadowTileResolution=_;var u=_*2,h=c==pr.TwoCascades?_:_*2;this._shadowMapSize.set(1/u,1/h,u,h)}this._renderTarget=null;var d=this._viewportOffsets,f=this._shadowTileResolution;switch(c){case pr.NoCascades:d[0].set(0,0);break;case pr.TwoCascades:d[0].set(0,0),d[1].set(f,0);break;case pr.FourCascades:d[0].set(0,0),d[1].set(f,0),d[2].set(0,f),d[3].set(f,f)}}},i._updateSingleShadowCasterShaderData=function(e,r,a){var o=r.virtualCamera;st.getShadowBias(e,o.projectionMatrix,this._shadowTileResolution,this._shadowBias);var c=this._camera.scene.shaderData;c.setVector2(s._lightShadowBiasProperty,this._shadowBias),c.setVector3(s._lightDirectionProperty,e.direction),a.applyVirtualCamera(o,!0)},s}(Lo);(function(){Ut._lightShadowBiasProperty=O.getByName("scene_ShadowBias")})();(function(){Ut._lightDirectionProperty=O.getByName("scene_LightDirection")})();(function(){Ut._shadowMatricesProperty=O.getByName("scene_ShadowMatrices")})();(function(){Ut._shadowMapSize=O.getByName("scene_ShadowMapSize")})();(function(){Ut._shadowInfosProperty=O.getByName("scene_ShadowInfo")})();(function(){Ut._shadowMapsProperty=O.getByName("scene_ShadowMap")})();(function(){Ut._shadowSplitSpheresProperty=O.getByName("scene_ShadowSplitSpheres")})();(function(){Ut._maxCascades=4})();(function(){Ut._cascadesSplitDistance=new Array(Ut._maxCascades+1)})();(function(){Ut._viewport=new ie(0,0,1,1)})();(function(){Ut._clearColor=new q(1,1,1,1)})();(function(){Ut._tempVector=new R})();(function(){Ut._tempMatrix0=new Z})();var Gu=function(){function n(i){this.opaqueQueue=new rn(i,ft.Opaque),this.transparentQueue=new rn(i,ft.Transparent),this.alphaTestQueue=new rn(i,ft.AlphaTest)}var s=n.prototype;return s.reset=function(){this.opaqueQueue.clear(),this.transparentQueue.clear(),this.alphaTestQueue.clear()},s.sort=function(){this.opaqueQueue.sort(rn._compareFromNearToFar),this.alphaTestQueue.sort(rn._compareFromNearToFar),this.transparentQueue.sort(rn._compareFromFarToNear)},s.destroy=function(){this.opaqueQueue.destroy(),this.transparentQueue.destroy(),this.alphaTestQueue.destroy()},n}(),Hu=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._supportDepthTexture=t._hardwareRenderer.canIUse(K.depthTexture),e}var i=s.prototype;return i.onConfig=function(e){var r=this._engine,a=e.pixelViewport,o=a.width,c=a.height,l=cr.recreateRenderTargetIfNeeded(r,this._renderTarget,o,c,null,G.Depth16,!0,!1,1),_=l.depthTexture;_.wrapModeU=_.wrapModeV=gt.Clamp,_.filterMode=tt.Point,this._renderTarget=l},i.onRender=function(e,r){var a=this._engine,o=this._renderTarget,c=e.camera,l=a._hardwareRenderer;l.activeRenderTarget(o,c.viewport,e.flipProjection,0),l.viewport(0,0,o.width,o.height),l.scissor(0,0,o.width,o.height),l.clearRenderTarget(a,zt.Depth,null),r.opaqueQueue.render(c,Ot.DepthOnly),r.alphaTestQueue.render(c,Ot.DepthOnly),c.shaderData.setTexture(ze._cameraDepthTextureProperty,this._renderTarget.depthTexture)},s}(Lo),da;(function(n){n[n.None=1]="None",n[n.TwoX=2]="TwoX",n[n.FourX=4]="FourX"})(da||(da={}));var Wu=function(n){W(s,n);function s(t){return n.call(this,t)}var i=s.prototype;return i.onConfig=function(e,r){this._cameraColorTexture=r;var a=e.opaqueTextureDownsampling,o=a===da.None,c=e.pixelViewport,l=o?1:a===da.TwoX?.5:.25,_=cr.recreateRenderTargetIfNeeded(this._engine,this._renderTarget,c.width*l,c.height*l,G.R8G8B8A8,null,!1,!1,1),u=_.getColorTexture(0);u.wrapModeU=u.wrapModeV=gt.Clamp,u.filterMode=o?tt.Point:tt.Bilinear,this._renderTarget=_},i.onRender=function(e,r){cr.blitTexture(this._engine,this._cameraColorTexture,this._renderTarget),e.camera.shaderData.setTexture(ze._cameraOpaqueTextureProperty,this._renderTarget.getColorTexture(0))},s}(Lo),Hc=function(){function n(i){this._allSpriteMasks=new He,this._lastCanvasSize=new ee,this._internalColorTarget=null,this._camera=i;var t=i.engine;this._cullingResults=new Gu(t),this._cascadedShadowCasterPass=new Ut(i),this._depthOnlyPass=new Hu(t),this._opaqueTexturePass=new Wu(t)}var s=n.prototype;return s.destroy=function(){this._cullingResults.destroy(),this._allSpriteMasks=null,this._camera=null},s.render=function(t,e,r,a){var o=this._camera,c=o.scene,l=o.engine,_=this._cullingResults,u=c._lightManager._sunlight,h=this._depthOnlyPass,d=o.depthTextureMode===Va.PrePass&&h._supportDepthTexture;o.engine._spriteMaskManager.clear(),c.castShadows&&u&&u.shadowType!==dn.None&&this._cascadedShadowCasterPass.onRender(t),_.reset(),this._allSpriteMasks.length=0,t.applyVirtualCamera(o._virtualCamera,d),this._prepareRender(t),_.sort(),d?(h.onConfig(o),h.onRender(t,_)):o.shaderData.setTexture(ze._cameraDepthTextureProperty,l._whiteTexture2D);var f=o.independentCanvasEnabled;if(f){var v=o.pixelViewport,p=cr.recreateRenderTargetIfNeeded(l,this._internalColorTarget,v.width,v.height,G.R8G8B8A8,G.Depth24Stencil8,!1,!1,o.msaaSamples),g=p.getColorTexture(0);g.wrapModeU=g.wrapModeV=gt.Clamp,this._internalColorTarget=p}else{var y=this._internalColorTarget;if(y){var m;(m=y.getColorTexture(0))==null||m.destroy(!0),y.destroy(!0),this._internalColorTarget=null}}this._drawRenderPass(t,o,e,r,a)},s._drawRenderPass=function(t,e,r,a,o){var c,l,_=this._cullingResults,u=_.opaqueQueue,h=_.alphaTestQueue,d=_.transparentQueue,f=e.engine,v=e.scene,p=v.background,g=this._internalColorTarget,y=f._hardwareRenderer,m,x=(m=e.renderTarget)!=null?m:g,C=g?cr.defaultViewport:e.viewport,b=e.renderTarget&&r==null||g!==null;t.flipProjection!==b&&(t.applyVirtualCamera(e._virtualCamera,b),this._updateMVPShaderData(t),f._renderCount++),y.activeRenderTarget(x,C,t.flipProjection,a,r);var A=e.clearFlags&~(o??zt.None),S=p.solidColor;if(A!==zt.None&&y.clearRenderTarget(e.engine,A,S),u.render(e,Ot.Forward),h.render(e,Ot.Forward),A&zt.Color&&(p.mode===cn.Sky?p.sky._render(t):p.mode===cn.Texture&&p.texture&&this._drawBackgroundTexture(f,p)),e.opaqueTextureEnabled){x._blitRenderTarget();var w=this._opaqueTexturePass;w.onConfig(e,x.getColorTexture(0)),w.onRender(t,_),y.activeRenderTarget(x,C,t.flipProjection,a,r)}else e.shaderData.setTexture(ze._cameraOpaqueTextureProperty,null);d.render(e,Ot.Forward),(c=x)==null||c._blitRenderTarget(),(l=x)==null||l.generateMipmaps(),g&&cr.blitTexture(f,g.getColorTexture(0),null,0,e.viewport)},s.pushRenderData=function(t,e){var r=e.material,a=r.renderStates,o=r.shader.subShaders[0],c=t.replacementShader;if(c){var l=c.subShaders,_=t.replacementTag;if(_)for(var u=0,h=l.length;u<h;u++){var d=l[u];if(d.getTagValue(_)===o.getTagValue(_)){this.pushRenderDataWithShader(t,e,d.passes,a);break}}else this.pushRenderDataWithShader(t,e,l[0].passes,a)}else this.pushRenderDataWithShader(t,e,o.passes,a)},s.pushRenderDataWithShader=function(t,e,r,a){for(var o=this._cullingResults,c=o.opaqueQueue,l=o.alphaTestQueue,_=o.transparentQueue,u=t.camera.engine._renderElementPool,h=0,d=0,f=r.length;d<f;d++){var v,p=((v=r[d]._renderState)!=null?v:a[d]).renderQueueType;if(!(h&1<<p)){var g=u.getFromPool();switch(g.set(e,r),p){case ft.Opaque:c.pushRenderElement(g),h|=1;break;case ft.AlphaTest:l.pushRenderElement(g),h|=2;break;case ft.Transparent:_.pushRenderElement(g),h|=4;break}}}},s._drawBackgroundTexture=function(t,e){var r=t._hardwareRenderer,a=t.canvas,o=e._material,c=e._mesh;(this._lastCanvasSize.x!==a.width||this._lastCanvasSize.y!==a.height)&&e._textureFillMode!==bn.Fill&&(this._lastCanvasSize.set(a.width,a.height),e._resizeBackgroundTexture());var l=o.shader.subShaders[0].passes[0],_=l._getShaderProgram(t,Se._compileMacros);_.bind(),_.uploadAll(_.materialUniformBlock,o.shaderData),_.uploadUnGroupTextures(),(l._renderState||o.renderState)._apply(t,!1,l._renderStateDataMap,o.shaderData),r.drawPrimitive(c._primitive,c.subMesh,_)},s._prepareRender=function(t){for(var e=t.camera,r=e.engine,a=e.scene._componentsManager._renderers,o=a._elements,c=a.length-1;c>=0;--c){var l=o[c];e.cullingMask&l._entity.layer&&(e.enableFrustumCulling&&!e._frustum.intersectsBox(l.bounds)||(l._renderFrameCount=r.time.frameCount,l._prepareRender(t)))}},s._updateMVPShaderData=function(t){for(var e=t.camera,r=e.scene._componentsManager._renderers,a=r._elements,o=r.length-1;o>=0;--o){var c=a[o];c._updateShaderData(t,!0)}},n}(),cs;(function(n){n[n.None=0]="None",n[n.Opaque=1]="Opaque",n[n.AlphaTest=2]="AlphaTest",n[n.Transparent=4]="Transparent"})(cs||(cs={}));var Fa;(function(n){n[n.Normal=0]="Normal",n[n.XRCenterCamera=1]="XRCenterCamera",n[n.XRLeftCamera=2]="XRLeftCamera",n[n.XRRightCamera=4]="XRRightCamera"})(Fa||(Fa={}));var Si;(function(n){n[n.None=1]="None",n[n.TwoX=2]="TwoX",n[n.FourX=4]="FourX",n[n.EightX=8]="EightX"})(Si||(Si={}));var $r,Un=function(){};(function(){Un.tempVec4=new ie})();(function(){Un.tempVec3=new R})();(function(){Un.tempVec2=new ee})();var ze=($r=function(n){W(s,n);function s(t){var e;e=n.call(this,t)||this,e.enableFrustumCulling=!0,e.clearFlags=zt.All,e.cullingMask=An.Everything,e.depthTextureMode=Va.None,e.opaqueTextureDownsampling=da.TwoX,e.msaaSamples=Si.None,e._cameraType=Fa.Normal,e._globalShaderMacro=new Kt,e._frustum=new il,e._virtualCamera=new Gc,e._replacementShader=null,e._replacementSubShaderTag=null,e._cameraIndex=-1,e._priority=0,e._shaderData=new Nr(xr.Camera),e._isCustomViewMatrix=!1,e._isCustomProjectionMatrix=!1,e._fieldOfView=45,e._orthographicSize=10,e._isProjectionDirty=!0,e._isInvProjMatDirty=!0,e._customAspectRatio=void 0,e._renderTarget=null,e._depthBufferParams=new ie,e._opaqueTextureEnabled=!1,e._viewport=new ie(0,0,1,1),e._pixelViewport=new Gr(0,0,0,0),e._inverseProjectionMatrix=new Z,e._invViewProjMat=new Z;var r=e.entity.transform;return e._transform=r,e._isViewMatrixDirty=r.registerWorldChangeFlag(),e._isInvViewProjDirty=r.registerWorldChangeFlag(),e._frustumChangeFlag=r.registerWorldChangeFlag(),e._renderPipeline=new Hc(ce(e)),e._addResourceReferCount(e.shaderData,1),e._updatePixelViewport(),e._onPixelViewportChanged=e._onPixelViewportChanged.bind(ce(e)),e._viewport._onValueChanged=e._onPixelViewportChanged,e.engine.canvas._sizeUpdateFlagManager.addListener(e._onPixelViewportChanged),e}var i=s.prototype;return i.resetViewMatrix=function(){this._isCustomViewMatrix=!1,this._viewMatrixChange()},i.resetProjectionMatrix=function(){this._isCustomProjectionMatrix=!1,this._projectionMatrixChange()},i.resetAspectRatio=function(){this._customAspectRatio=void 0,this._projectionMatrixChange()},i.worldToViewportPoint=function(e,r){var a=Un.tempVec3,o=Un.tempVec4;R.transformCoordinate(e,this.viewMatrix,a),R.transformToVec4(a,this.projectionMatrix,o);var c=o.w;return r.set((o.x/c+1)*.5,(1-o.y/c)*.5,-a.z),r},i.viewportToWorldPoint=function(e,r){var a=this,o=a.nearClipPlane,c=a.farClipPlane,l=1/(o-c),_;if(this.isOrthographic)_=-e.z*2*l,_+=(c+o)*l;else{var u=e.z;_=-u*(o+c)*l,_+=2*o*c*l,_=_/u}return this._innerViewportToWorldPoint(e.x,e.y,(_+1)/2,this._getInvViewProjMat(),r),r},i.viewportPointToRay=function(e,r){var a=this._getInvViewProjMat(),o=this._innerViewportToWorldPoint(e.x,e.y,0,a,r.origin),c=this._innerViewportToWorldPoint(e.x,e.y,1-k.zeroTolerance,a,r.direction);return R.subtract(c,o,c),c.normalize(),r},i.screenToViewportPoint=function(e,r){var a=this.engine.canvas,o=this.viewport;return r.x=(e.x/a.width-o.x)/o.z,r.y=(e.y/a.height-o.y)/o.w,e.z!==void 0&&(r.z=e.z),r},i.viewportToScreenPoint=function(e,r){var a=this.engine.canvas,o=this.viewport;return r.x=(o.x+e.x*o.z)*a.width,r.y=(o.y+e.y*o.w)*a.height,e.z!==void 0&&(r.z=e.z),r},i.worldToScreenPoint=function(e,r){return this.worldToViewportPoint(e,r),this.viewportToScreenPoint(r,r)},i.screenToWorldPoint=function(e,r){return this.screenToViewportPoint(e,r),this.viewportToWorldPoint(r,r)},i.screenPointToRay=function(e,r){var a=Un.tempVec2;return this.screenToViewportPoint(e,a),this.viewportPointToRay(a,r)},i.render=function(e,r){r===void 0&&(r=0);var a=this.engine._renderContext,o=this._virtualCamera,c=this.entity.transform;Z.multiply(this.projectionMatrix,this.viewMatrix,o.viewProjectionMatrix),o.position.copyFrom(c.worldPosition),o.isOrthographic&&o.forward.copyFrom(c.worldForward),a.camera=this,a.virtualCamera=o,a.replacementShader=this._replacementShader,a.replacementTag=this._replacementSubShaderTag,this.enableFrustumCulling&&this._frustumChangeFlag.flag&&(this._frustum.calculateFromMatrix(o.viewProjectionMatrix),this._frustumChangeFlag.flag=!1),this._updateShaderData(),Kt.unionCollection(this.scene._globalShaderMacro,this.shaderData._macroCollection,this._globalShaderMacro),r>0&&!this.engine._hardwareRenderer.isWebGL2&&(r=0,ve.error("mipLevel only take effect in WebGL2.0"));var l;this._cameraType!==Fa.Normal&&(l=this.engine.xrManager._getCameraClearFlagsMask(this._cameraType)),this._renderPipeline.render(a,e,r,l),this._engine._renderCount++},i.setReplacementShader=function(e,r){this._replacementShader=e,this._replacementSubShaderTag=typeof r=="string"?sn.getByName(r):r},i.resetReplacementShader=function(){this._replacementShader=null,this._replacementSubShaderTag=null},i._onEnableInScene=function(){this.scene._componentsManager.addCamera(this)},i._onDisableInScene=function(){this.scene._componentsManager.removeCamera(this)},i._onDestroy=function(){var e;n.prototype._onDestroy.call(this),(e=this._renderPipeline)==null||e.destroy(),this._isInvViewProjDirty.destroy(),this._isViewMatrixDirty.destroy(),this._addResourceReferCount(this.shaderData,-1),this._viewport._onValueChanged=null,this.engine.canvas._sizeUpdateFlagManager.removeListener(this._onPixelViewportChanged),this._entity=null,this._globalShaderMacro=null,this._frustum=null,this._renderPipeline=null,this._virtualCamera=null,this._shaderData=null,this._frustumChangeFlag=null,this._transform=null,this._isViewMatrixDirty=null,this._isInvViewProjDirty=null,this._viewport=null,this._inverseProjectionMatrix=null,this._invViewProjMat=null},i._updatePixelViewport=function(){var e,r,a=this._renderTarget;if(a)e=a.width,r=a.height;else{var o=this.engine.canvas;e=o.width,r=o.height}var c=this._viewport;this._pixelViewport.set(c.x*e,c.y*r,c.z*e,c.w*r)},i._viewMatrixChange=function(){this._isViewMatrixDirty.flag=!0,this._isInvViewProjDirty.flag=!0,this._frustumChangeFlag.flag=!0},i._projectionMatrixChange=function(){this._isProjectionDirty=!0,this._isInvProjMatDirty=!0,this._isInvViewProjDirty.flag=!0,this._frustumChangeFlag.flag=!0},i._innerViewportToWorldPoint=function(e,r,a,o,c){var l=Un.tempVec3;return l.set(e*2-1,1-r*2,a*2-1),R.transformCoordinate(l,o,c),c},i._updateShaderData=function(){var e=this.shaderData,r=this._transform;e.setMatrix(ze._inverseViewMatrixProperty,r.worldMatrix),e.setVector3(ze._cameraPositionProperty,r.worldPosition),e.setVector3(ze._cameraForwardProperty,r.worldForward),e.setVector3(ze._cameraUpProperty,r.worldUp);var a=this._depthBufferParams,o=this.farClipPlane/this.nearClipPlane;a.set(1-o,o,0,0),e.setVector4(ze._cameraDepthBufferParamsProperty,a)},i._getInvViewProjMat=function(){return this._isInvViewProjDirty.flag&&(this._isInvViewProjDirty.flag=!1,Z.multiply(this._transform.worldMatrix,this._getInverseProjectionMatrix(),this._invViewProjMat)),this._invViewProjMat},i._getInverseProjectionMatrix=function(){return this._isInvProjMatDirty&&(this._isInvProjMatDirty=!1,Z.invert(this.projectionMatrix,this._inverseProjectionMatrix)),this._inverseProjectionMatrix},i._forceUseInternalCanvas=function(){return this.opaqueTextureEnabled},i._onPixelViewportChanged=function(){this._updatePixelViewport();var e;(e=this._customAspectRatio)!=null||this._projectionMatrixChange(),this._checkMainCanvasAntialiasWaste()},i._checkMainCanvasAntialiasWaste=function(){this.independentCanvasEnabled&&ie.equals(this._viewport,cr.defaultViewport)&&console.warn("Camera use independent canvas and viewport cover the whole screen, it is recommended to disable antialias, depth and stencil to save memory when create engine.")},j(s,[{key:"opaqueTextureEnabled",get:function(){return this._opaqueTextureEnabled},set:function(e){this._opaqueTextureEnabled!==e&&(this._opaqueTextureEnabled=e,this._checkMainCanvasAntialiasWaste())}},{key:"independentCanvasEnabled",get:function(){return this._renderTarget?!1:this._forceUseInternalCanvas()}},{key:"shaderData",get:function(){return this._shaderData}},{key:"nearClipPlane",get:function(){return this._virtualCamera.nearClipPlane},set:function(e){this._virtualCamera.nearClipPlane=e,this._projectionMatrixChange()}},{key:"farClipPlane",get:function(){return this._virtualCamera.farClipPlane},set:function(e){this._virtualCamera.farClipPlane=e,this._projectionMatrixChange()}},{key:"fieldOfView",get:function(){return this._fieldOfView},set:function(e){this._fieldOfView=e,this._projectionMatrixChange()}},{key:"aspectRatio",get:function(){var e=this.pixelViewport,r;return(r=this._customAspectRatio)!=null?r:e.width/e.height},set:function(e){this._customAspectRatio=e,this._projectionMatrixChange()}},{key:"viewport",get:function(){return this._viewport},set:function(e){e!==this._viewport&&this._viewport.copyFrom(e)}},{key:"pixelViewport",get:function(){return this._pixelViewport}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this._phasedActiveInScene&&(this.scene._componentsManager._cameraNeedSorting=!0),this._priority=e)}},{key:"isOrthographic",get:function(){return this._virtualCamera.isOrthographic},set:function(e){this._virtualCamera.isOrthographic=e,this._projectionMatrixChange(),e?this.shaderData.enableMacro("CAMERA_ORTHOGRAPHIC"):this.shaderData.disableMacro("CAMERA_ORTHOGRAPHIC")}},{key:"orthographicSize",get:function(){return this._orthographicSize},set:function(e){this._orthographicSize=e,this._projectionMatrixChange()}},{key:"viewMatrix",get:function(){var e=this._virtualCamera.viewMatrix;if(!this._isViewMatrixDirty.flag||this._isCustomViewMatrix)return e;this._isViewMatrixDirty.flag=!1;var r=this._transform;return Z.rotationTranslation(r.worldRotationQuaternion,r.worldPosition,e),e.invert(),e},set:function(e){this._virtualCamera.viewMatrix.copyFrom(e),this._isCustomViewMatrix=!0,this._viewMatrixChange()}},{key:"projectionMatrix",get:function(){var e=this._virtualCamera,r=e.projectionMatrix;if(!this._isProjectionDirty||this._isCustomProjectionMatrix)return r;this._isProjectionDirty=!1;var a=this.aspectRatio;if(!e.isOrthographic)Z.perspective(k.degreeToRadian(this._fieldOfView),a,this.nearClipPlane,this.farClipPlane,r);else{var o=this._orthographicSize*a,c=this._orthographicSize;Z.ortho(-o,o,-c,c,this.nearClipPlane,this.farClipPlane,r)}return r},set:function(e){this._virtualCamera.projectionMatrix.copyFrom(e),this._isCustomProjectionMatrix=!0,this._projectionMatrixChange()}},{key:"enableHDR",get:function(){return console.log("not implementation"),!1},set:function(e){console.log("not implementation")}},{key:"renderTarget",get:function(){return this._renderTarget},set:function(e){this._renderTarget!==e&&(this._renderTarget&&this._addResourceReferCount(this._renderTarget,-1),e&&this._addResourceReferCount(e,1),this._renderTarget=e,this._onPixelViewportChanged(),this._checkMainCanvasAntialiasWaste())}}]),s}(Rt),function(){$r._cameraDepthTextureProperty=O.getByName("camera_DepthTexture")}(),function(){$r._cameraOpaqueTextureProperty=O.getByName("camera_OpaqueTexture")}(),function(){$r._inverseViewMatrixProperty=O.getByName("camera_ViewInvMat")}(),function(){$r._cameraPositionProperty=O.getByName("camera_Position")}(),function(){$r._cameraForwardProperty=O.getByName("camera_Forward")}(),function(){$r._cameraUpProperty=O.getByName("camera_Up")}(),function(){$r._cameraDepthBufferParamsProperty=O.getByName("camera_DepthBufferParams")}(),$r);T([J],ze.prototype,"_frustum",void 0);T([F],ze.prototype,"_renderPipeline",void 0);T([F],ze.prototype,"_virtualCamera",void 0);T([F],ze.prototype,"_cameraIndex",void 0);T([F],ze.prototype,"_frustumChangeFlag",void 0);T([F],ze.prototype,"_transform",void 0);T([F],ze.prototype,"_isViewMatrixDirty",void 0);T([F],ze.prototype,"_isInvViewProjDirty",void 0);T([J],ze.prototype,"_viewport",void 0);T([J],ze.prototype,"_pixelViewport",void 0);T([J],ze.prototype,"_inverseProjectionMatrix",void 0);T([J],ze.prototype,"_invViewProjMat",void 0);T([F],ze.prototype,"_onPixelViewportChanged",null);ze=T([ka(ge,Hn.CheckOnly)],ze);var Xu={json:"json",gltf:"json",mtl:"json",prefab:"json",txt:"text",bin:"arraybuffer",png:"image",webp:"image",jpg:"image"},ju=1,qu=1/0,Yu=500;function Qn(n,s){return s===void 0&&(s={}),new Pe(function(i,t,e,r){var a,o=(a=s.retryCount)!=null?a:ju,c,l=(c=s.retryInterval)!=null?c:Yu,_;s.timeout=(_=s.timeout)!=null?_:qu;var u;s.type=(u=s.type)!=null?u:Ku(n);var h=new Ju(function(){return Qu(n,s).onProgress(e,r)},o,l);h.start().onError(t).onComplete(i)})}function Qu(n,s){return new Pe(function(i,t,e,r){var a=new XMLHttpRequest,o=s.type==="image";a.timeout=s.timeout;var c;s.method=(c=s.method)!=null?c:"get",a.onload=function(){if(a.status<200||a.status>=300){t(new Error("request failed from: "+n));return}var _,u=(_=a.response)!=null?_:a.responseText;if(o){var h=new Image;h.onload=function(){requestAnimationFrame(function(){e(1,1),i(h),h.onload=null,h.onerror=null,h.onabort=null,URL.revokeObjectURL(h.src)})},h.onerror=h.onabort=function(){t(new Error("request "+h.src+" fail")),URL.revokeObjectURL(h.src)},h.crossOrigin="anonymous",h.src=URL.createObjectURL(u)}else e(1,1),i(u)},a.onerror=function(){t(new Error("request failed from: "+n))},a.ontimeout=function(){t(new Error("request timeout from: "+n))},a.onprogress=function(_){_.lengthComputable&&r(n,_.loaded,_.total)},a.open(s.method,n,!0),a.withCredentials=s.credentials==="include",a.responseType=o?"blob":s.type;var l=s.headers;l&&Object.keys(l).forEach(function(_){a.setRequestHeader(_,l[_])}),a.send(s.body)})}function Ku(n){var s=n.substring(n.lastIndexOf(".")+1);return Xu[s]}var Ju=function(){function n(i,t,e){this.execFunc=i,this.totalCount=t,this.interval=e,this._timeoutId=-100,this._currentCount=0,this.exec=this.exec.bind(this)}var s=n.prototype;return s.start=function(){return this.exec(),this},s.onComplete=function(t){return this._onComplete=t,this},s.onError=function(t){return this._onError=t,this},s.cancel=function(){window.clearTimeout(this._timeoutId)},s.exec=function(){var t=this;if(this._currentCount>=this.totalCount){this._onError&&this._onError(this._error);return}this._currentCount++,this.execFunc(this._currentCount).then(function(e){return t._onComplete&&t._onComplete(e)}).catch(function(e){t._error=e,t._timeoutId=window.setTimeout(t.exec,t.interval)})},n}(),Be=function(){function n(s){this.useCache=s,this.request=Qn}return n.registerClass=function(i,t){this._engineObjects[i]=t,this._classNameMap.set(t,i)},n.getClass=function(i){return this._engineObjects[i]},n.getClassName=function(i){return this._classNameMap.get(i)},n}();(function(){Be._engineObjects={}})();(function(){Be._classNameMap=new Map})();var Zu=function(){function n(){}var s=n.prototype;return s.initialize=function(t){var e=t.component,r=t.property.split(".");if(t.getProperty){var a=t.getProperty.split(".");this._initializeMounted(e,a,1),this._initializeMounted(e,r,2)}else this._initializeMounted(e,r,3)},s.getTargetValue=function(){switch(this._getType){case 2:return this._getMounted[this._getArrayIndex];case 1:return this._getMounted[this._getValueName].apply(this._getMounted,this._getArgs);case 0:return this._getMounted[this._getValueName]}},s.setTargetValue=function(t){switch(this._setType){case 2:this._setMounted[this._setArrayIndex]=t;break;case 1:var e=this._setArgs;e[this._replaceValueIndex]=t,this._setMounted[this._setValueName].apply(this._setMounted,e);break;case 0:this._setMounted[this._setValueName]=t;break}},s._initializeMounted=function(t,e,r){for(var a=e.length-1,o=0;o<a;o++){var c=e[o];if(c.indexOf("[")>-1){var l=c.indexOf("[");t=t[c.slice(0,l)],t=t[parseInt(c.slice(l+1,-1))]}else if(c.endsWith(")")){var _=c.slice(0,c.indexOf("(")),u=c.match(/\w+\(([^)]*)\)/)[1].split(",").map(function(m){return m.trim().replace(/['"]+/g,"")}).filter(function(m){return m!==""});t=t[_].apply(t,u)}else t=t[c]}var h=e[a],d,f,v,p;if(h.indexOf("[")>-1){var g=h.indexOf("[");d=2,t=t[h.slice(0,g)],f=parseInt(h.slice(g+1,-1))}else if(h.endsWith(")")){if(v=h.slice(0,h.indexOf("(")),p=h.match(/\w+\(([^)]*)\)/)[1].split(",").map(function(m){return m.trim().replace(/['"]+/g,"")}).filter(function(m){return m!==""}),d=1,r&2){var y=p.indexOf("$value");this._replaceValueIndex=y>-1?y:p.length}}else d=0;r&2&&(this._setMounted=t,this._setType=d,this._setArrayIndex=f,this._setValueName=h,v&&(this._setValueName=v),this._setArgs=p),r&1&&(this._getMounted=t,this._getType=d,this._getArrayIndex=f,this._getValueName=h,v&&(this._getValueName=v),this._getArgs=p)},n}(),ls;(function(n){n[n.Property=0]="Property",n[n.Method=1]="Method",n[n.Array=2]="Array"})(ls||(ls={}));var _s;(function(n){n[n.Get=1]="Get",n[n.Set=2]="Set",n[n.Both=3]="Both"})(_s||(_s={}));var fn=function(){function n(i,t,e,r,a,o){this.baseEvaluateData={curKeyframeIndex:0,value:null},this.crossEvaluateData={curKeyframeIndex:0,value:null},this.updateMark=0,this.target=i,this.property=r,this.getProperty=a,this.component=e,this.cureType=o;var c=n.getAssemblerType(t,r);this._assembler=new c,this._assembler.initialize(this),o._isCopyMode&&(this.referenceTargetValue=this._assembler.getTargetValue())}var s=n.prototype;return s.evaluateValue=function(t,e,r){return r?t._evaluateAdditive(e,this.baseEvaluateData):t._evaluate(e,this.baseEvaluateData)},s.evaluateCrossFadeValue=function(t,e,r,a,o,c){if(!this.cureType._supportInterpolationMode)return this.evaluateValue(e,a,!1);var l=t&&t.keys.length?c?t._evaluateAdditive(r,this.baseEvaluateData):t._evaluate(r,this.baseEvaluateData):c?this.cureType._getZeroValue(this.baseEvaluateData.value):this.defaultValue,_=e&&e.keys.length?c?e._evaluateAdditive(a,this.crossEvaluateData):e._evaluate(a,this.crossEvaluateData):c?this.cureType._getZeroValue(this.crossEvaluateData.value):this.defaultValue;return this._lerpValue(l,_,o)},s.crossFadeFromPoseAndApplyValue=function(t,e,r,a){if(!this.cureType._supportInterpolationMode)return this.evaluateValue(t,e,!1);var o=a?this.cureType._subtractValue(this.fixedPoseValue,this.defaultValue,this.baseEvaluateData.value):this.fixedPoseValue,c=t&&t.keys.length?a?t._evaluateAdditive(e,this.crossEvaluateData):t._evaluate(e,this.crossEvaluateData):a?this.cureType._getZeroValue(this.crossEvaluateData.value):this.defaultValue;return this._lerpValue(o,c,r)},s.revertDefaultValue=function(){this._assembler.setTargetValue(this.defaultValue)},s.getEvaluateValue=function(t){return this.cureType._isCopyMode?(this.cureType._setValue(this.baseEvaluateData.value,t),t):this.baseEvaluateData.value},s.saveDefaultValue=function(){this.cureType._isCopyMode?this.cureType._setValue(this.referenceTargetValue,this.defaultValue):this.defaultValue=this._assembler.getTargetValue()},s.saveFixedPoseValue=function(){this.cureType._isCopyMode?this.cureType._setValue(this.referenceTargetValue,this.fixedPoseValue):this.fixedPoseValue=this._assembler.getTargetValue()},s.applyValue=function(t,e,r){var a=this.cureType;if(r){var o=this._assembler;if(a._isCopyMode)a._additiveValue(t,e,this.referenceTargetValue);else{var c=o.getTargetValue(),l=a._additiveValue(t,e,c);o.setTargetValue(l)}}else if(e===1)a._isCopyMode?a._setValue(t,this.referenceTargetValue):this._assembler.setTargetValue(t);else if(a._isCopyMode){var _=this.referenceTargetValue;a._lerpValue(_,t,e,_)}else{var u=this._assembler.getTargetValue(),h=a._lerpValue(u,t,e);this._assembler.setTargetValue(h)}},s._lerpValue=function(t,e,r){return this.cureType._isCopyMode?this.cureType._lerpValue(t,e,r,this.baseEvaluateData.value):(this.baseEvaluateData.value=this.cureType._lerpValue(t,e,r),this.baseEvaluateData.value)},n.registerAssembler=function(t,e,r){var a=n._assemblerMap.get(t);a||(a={},n._assemblerMap.set(t,a)),a[e]=r},n.getAssemblerType=function(t,e){var r=n._assemblerMap.get(t),a=r?r[e]:void 0;return a??Zu},n}();(function(){fn._components=[]})();(function(){fn._assemblerMap=new Map})();var $u=function(){function n(){}var s=n.prototype;return s.initialize=function(t){this._transform=t.target.transform},s.getTargetValue=function(){return this._transform.position},s.setTargetValue=function(t){this._transform.position=t},n}();fn.registerAssembler(ge,"position",$u);var eh=function(){function n(){}var s=n.prototype;return s.initialize=function(t){this._transform=t.target.transform},s.getTargetValue=function(){return this._transform.rotationQuaternion},s.setTargetValue=function(t){this._transform.rotationQuaternion=t},n}();fn.registerAssembler(ge,"rotationQuaternion",eh);var th=function(){function n(){}var s=n.prototype;return s.initialize=function(t){this._transform=t.target.transform},s.getTargetValue=function(){return this._transform.scale},s.setTargetValue=function(t){this._transform.scale=t},n}();fn.registerAssembler(ge,"scale",th);var rh=function(){function n(){}var s=n.prototype;return s.initialize=function(t){this._skinnedMeshRenderer=t.component},s.getTargetValue=function(){return this._skinnedMeshRenderer.blendShapeWeights},s.setTargetValue=function(t){this._skinnedMeshRenderer.blendShapeWeights=t},n}();fn.registerAssembler(Dt,"blendShapeWeights",rh);var nh=function(){function n(){this.crossCurveMark=0,this.isActive=!0}var s=n.prototype;return s.initFinalValue=function(){var t=this.curveOwner,e=t.cureType,r=t.defaultValue;e._isCopyMode?e._setValue(r,this.finalValue):this.finalValue=r},s.saveFinalValue=function(){this.finalValue=this.curveOwner.getEvaluateValue(this.finalValue)},n}(),Wc=function(){function n(){this.typeIndex=0,this._tempCurveOwner={}}var s=n.prototype;return s._createCurveOwner=function(t,e){var r=this.curve.constructor,a=new fn(t,this.type,e,this.property,this.getProperty,r);return r._initializeOwner(a),a.saveDefaultValue(),a},s._createCurveLayerOwner=function(t){var e=this.curve.constructor,r=new nh;return r.curveOwner=t,e._initializeLayerOwner(r),r.initFinalValue(),r},s._getTempCurveOwner=function(t,e){var r=t.instanceId;return this._tempCurveOwner[r]||(this._tempCurveOwner[r]=this._createCurveOwner(t,e)),this._tempCurveOwner[r]},n}(),ji=function(){},Vo=function(n){W(s,n);function s(t){var e;return e=n.call(this,null)||this,e.name=t,e._curveBindings=[],e._updateFlagManager=new Er,e._length=0,e._events=[],e}var i=s.prototype;return i.addEvent=function(e,r,a){var o;if(typeof e=="string"){var c=new ji;c.functionName=e,c.time=r,c.parameter=a,o=c}else o=e;var l=this._events,_=l.length,u=o.time,h=_?l[_-1].time:0;if(u>=h)l.push(o);else{for(var d=_;--d>=0&&u<l[d].time;);l.splice(d+1,0,o)}this._updateFlagManager.dispatch()},i.clearEvents=function(){this._events.length=0,this._updateFlagManager.dispatch()},i.addCurveBinding=function(e,r,a,o,c,l){var _=new Wc;_.relativePath=e,_.type=r,typeof a=="number"?(_.typeIndex=a,_.property=o,typeof c=="string"?(_.getProperty=c,_.curve=l):_.curve=c):(_.property=a,typeof o=="string"?(_.getProperty=o,_.curve=c):_.curve=o),this._length=Math.max(this._length,_.curve.length),this._curveBindings.push(_)},i.clearCurveBindings=function(){this._curveBindings.length=0,this._length=0},i._sampleAnimation=function(e,r){for(var a=this,o=a._curveBindings,c=o.length-1;c>=0;c--){var l=o[c],_=e.findByPath(l.relativePath);if(_){var u=l.typeIndex>0?_.getComponents(l.type,fn._components)[l.typeIndex]:_.getComponent(l.type);if(!u)continue;var h=l._getTempCurveOwner(_,u);if(h&&l.curve.keys.length){var d=h.evaluateValue(l.curve,r,!1);h.applyValue(d,1,!1)}}}},j(s,[{key:"events",get:function(){return this._events}},{key:"curveBindings",get:function(){return this._curveBindings}},{key:"length",get:function(){return this._length}}]),s}(Yr),xt;(function(n){n[n.Linear=0]="Linear",n[n.CubicSpine=1]="CubicSpine",n[n.Step=2]="Step",n[n.Hermite=3]="Hermite"})(xt||(xt={}));var _r=function(){function n(){this.keys=[],this._evaluateData={curKeyframeIndex:0,value:null},this._length=0;var i=this.constructor;this._interpolation=i._supportInterpolationMode?xt.Linear:xt.Step,this._type=i}var s=n.prototype;return s.addKey=function(t){var e=t.time,r=this.keys;if(e>=this._length)r.push(t),this._length=e;else{for(var a=r.length;--a>=0&&e<r[a].time;);r.splice(a+1,0,t)}},s.evaluate=function(t){return this._evaluate(t,this._evaluateData)},s.removeKey=function(t){this.keys.splice(t,1);for(var e=this.keys,r=0,a=e.length-1;a>=0;a--){var o=e[a];o.time>this._length&&(r=o.time)}this._length=r},s._evaluate=function(t,e){var r=this.keys.length;if(!r){console.warn("This curve don't have any keyframes: ",this);return}var a=this,o=a.keys,c=a.interpolation,l=e.curKeyframeIndex;l!==-1&&(l>=r||t<o[l].time)&&(l=-1);for(var _=l+1;_<r&&!(t<o[_].time);)l++,_++;e.curKeyframeIndex=l;var u;if(l===-1)u=this._type._setValue(o[0].value,e.value);else if(_===r)u=this._type._setValue(o[l].value,e.value);else{var h=o[l],d=o[_],f=h.time,v=d.time-f,p=(t-f)/v;switch(c){case xt.Linear:u=this._type._lerpValue(h.value,d.value,p,e.value);break;case xt.Step:u=this._type._setValue(h.value,e.value);break;case xt.CubicSpine:case xt.Hermite:u=this._type._hermiteInterpolationValue(h,d,p,v,e.value);break}}return e.value=u,u},s._evaluateAdditive=function(t,e){var r=this._evaluate(t,e);return this._type._subtractValue(r,this.keys[0].value,e.value)},j(n,[{key:"interpolation",get:function(){return this._interpolation},set:function(t){!this._type._supportInterpolationMode&&t!==xt.Step?(this._interpolation=xt.Step,console.warn("The interpolation type must be `InterpolationType.Step`.")):this._interpolation=t}},{key:"length",get:function(){return this._length}}]),n}(),ei,Ci=(ei=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=[],i}return s._initializeOwner=function(t){t.defaultValue=[],t.fixedPoseValue=[],t.baseEvaluateData.value=[],t.crossEvaluateData.value=[]},s._initializeLayerOwner=function(t){t.finalValue=[]},s._lerpValue=function(t,e,r,a){for(var o=0,c=a.length;o<c;++o){var l=t[o];a[o]=l+(e[o]-l)*r}return a},s._subtractValue=function(t,e,r){for(var a=0,o=t.length;a<o;a++)r[a]=t[a]-e[a];return r},s._getZeroValue=function(t){for(var e=0,r=t.length;e<r;e++)t[e]=0;return t},s._additiveValue=function(t,e,r){for(var a=0,o=r.length;a<o;++a)r[a]+=t[a]*e;return r},s._setValue=function(t,e){for(var r=0,a=e.length;r<a;++r)e[r]=t[r];return e},s._hermiteInterpolationValue=function(t,e,r,a,o){for(var c=t.outTangent,l=e.inTangent,_=t.value,u=e.value,h=r*r,d=h*r,f=2*d-3*h+1,v=d-2*h+r,p=d-h,g=-2*d+3*h,y=0,m=_.length;y<m;++y)Number.isFinite(c[y])&&Number.isFinite(l[y])?o[y]=f*_[y]+v*c[y]*a+p*l[y]*a+g*u[y]:o[y]=t.value[y];return o},s}(_r),function(){ei._isCopyMode=!0}(),function(){ei._supportInterpolationMode=!0}(),ei);Ci=T([kt()],Ci);var ti,Ai=(ti=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=!1,i}return s._initializeOwner=function(t){t.defaultValue=!1,t.fixedPoseValue=!1,t.baseEvaluateData.value=!1,t.crossEvaluateData.value=!1},s._initializeLayerOwner=function(t){t.finalValue=!1},s._lerpValue=function(t,e){return t},s._subtractValue=function(t,e,r){return t},s._getZeroValue=function(){return!1},s._additiveValue=function(t,e,r){return t},s._setValue=function(t){return t},s._hermiteInterpolationValue=function(t){return t.value},s}(_r),function(){ti._isCopyMode=!1}(),function(){ti._supportInterpolationMode=!1}(),ti);Ai=T([kt()],Ai);var ri,Ei=(ri=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=new q,i}return s._initializeOwner=function(t){t.defaultValue=new q,t.fixedPoseValue=new q,t.baseEvaluateData.value=new q,t.crossEvaluateData.value=new q},s._initializeLayerOwner=function(t){t.finalValue=new q},s._lerpValue=function(t,e,r,a){return q.lerp(t,e,r,a),a},s._subtractValue=function(t,e,r){return q.subtract(t,e,r),r},s._getZeroValue=function(t){return t.set(0,0,0,0),t},s._additiveValue=function(t,e,r){return q.scale(t,e,t),q.add(r,t,r),r},s._setValue=function(t,e){return e.copyFrom(t),e},s._hermiteInterpolationValue=function(t,e,r,a,o){var c=t.value,l=t.outTangent,_=e.value,u=e.inTangent,h=r*r,d=h*r,f=2*d-3*h+1,v=d-2*h+r,p=d-h,g=-2*d+3*h,y=l.x,m=u.x;return Number.isFinite(y)&&Number.isFinite(m)?o.r=f*c.r+v*y*a+p*m*a+g*_.r:o.r=c.r,y=l.y,m=u.y,Number.isFinite(y)&&Number.isFinite(m)?o.g=f*c.g+v*y*a+p*m*a+g*_.g:o.g=c.g,y=l.z,m=u.z,Number.isFinite(y)&&Number.isFinite(m)?o.b=f*c.b+v*y*a+p*m*a+g*_.b:o.b=c.b,y=l.w,m=u.w,Number.isFinite(y)&&Number.isFinite(m)?o.a=f*c.a+v*y*a+p*m*a+g*_.a:o.a=c.a,o},s}(_r),function(){ri._isCopyMode=!0}(),function(){ri._supportInterpolationMode=!0}(),ri);Ei=T([kt()],Ei);var ni,Na=(ni=function(n){W(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.addKey=function(e){n.prototype.addKey.call(this,e);var r=this._evaluateData;if(!r.value||r.value.length!==e.value.length){var a=e.value.length;r.value=new Float32Array(a)}},s._initializeOwner=function(e){var r=e.referenceTargetValue.length;e.defaultValue=new Float32Array(r),e.fixedPoseValue=new Float32Array(r),e.baseEvaluateData.value=new Float32Array(r),e.crossEvaluateData.value=new Float32Array(r)},s._initializeLayerOwner=function(e){var r=e.curveOwner.referenceTargetValue.length;e.finalValue=new Float32Array(r)},s._lerpValue=function(e,r,a,o){for(var c=0,l=o.length;c<l;++c){var _=e[c];o[c]=_+(r[c]-_)*a}return o},s._subtractValue=function(e,r,a){for(var o=0,c=e.length;o<c;o++)a[o]=e[o]-r[o];return a},s._getZeroValue=function(e){for(var r=0,a=e.length;r<a;r++)e[r]=0;return e},s._additiveValue=function(e,r,a){for(var o=0,c=a.length;o<c;++o)a[o]+=e[o]*r;return a},s._setValue=function(e,r){for(var a=0,o=r.length;a<o;++a)r[a]=e[a];return r},s._hermiteInterpolationValue=function(e,r,a,o,c){for(var l=e.outTangent,_=r.inTangent,u=e.value,h=r.value,d=a*a,f=d*a,v=2*f-3*d+1,p=f-2*d+a,g=f-d,y=-2*f+3*d,m=0,x=u.length;m<x;++m)Number.isFinite(l[m])&&Number.isFinite(_[m])?c[m]=v*u[m]+p*l[m]*o+g*_[m]*o+y*h[m]:c[m]=e.value[m];return c},s}(_r),function(){ni._isCopyMode=!0}(),function(){ni._supportInterpolationMode=!0}(),ni);Na=T([kt()],Na);var ai,wi=(ai=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=0,i}return s._initializeOwner=function(t){t.defaultValue=0,t.fixedPoseValue=0,t.baseEvaluateData.value=0,t.crossEvaluateData.value=0},s._initializeLayerOwner=function(t){t.finalValue=0},s._lerpValue=function(t,e,r){return t+(e-t)*r},s._additiveValue=function(t,e,r){return r+=t*e},s._subtractValue=function(t,e){return t-e},s._getZeroValue=function(){return 0},s._setValue=function(t){return t},s._hermiteInterpolationValue=function(t,e,r,a){var o=t.outTangent,c=e.inTangent;if(Number.isFinite(o)&&Number.isFinite(c)){var l=r*r,_=l*r,u=2*_-3*l+1,h=_-2*l+r,d=_-l,f=-2*_+3*l;return u*t.value+h*o*a+d*c*a+f*e.value}else return t.value},s}(_r),function(){ai._isCopyMode=!1}(),function(){ai._supportInterpolationMode=!0}(),ai);wi=T([kt()],wi);var xa,fa=(xa=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=new Re,i}return s._initializeOwner=function(t){t.defaultValue=new Re,t.fixedPoseValue=new Re,t.baseEvaluateData.value=new Re,t.crossEvaluateData.value=new Re},s._initializeLayerOwner=function(t){t.finalValue=new Re},s._lerpValue=function(t,e,r,a){return Re.slerp(t,e,r,a),a},s._additiveValue=function(t,e,r){return t.x=t.x*e,t.y=t.y*e,t.z=t.z*e,t.normalize(),r.multiply(t),r},s._subtractValue=function(t,e,r){var a=fa._tempConjugateQuat;return Re.conjugate(e,a),Re.multiply(a,t,r),r},s._getZeroValue=function(t){return t.set(0,0,0,1),t},s._setValue=function(t,e){return e.copyFrom(t),e},s._hermiteInterpolationValue=function(t,e,r,a,o){var c=t.value,l=t.outTangent,_=e.value,u=e.inTangent,h=r*r,d=h*r,f=2*d-3*h+1,v=d-2*h+r,p=d-h,g=-2*d+3*h,y=l.x,m=u.x;return Number.isFinite(y)&&Number.isFinite(m)?o.x=f*c.x+v*y*a+p*m*a+g*_.x:o.x=c.x,y=l.y,m=u.y,Number.isFinite(y)&&Number.isFinite(m)?o.y=f*c.y+v*y*a+p*m*a+g*_.y:o.y=c.y,y=l.z,m=u.z,Number.isFinite(y)&&Number.isFinite(m)?o.z=f*c.z+v*y*a+p*m*a+g*_.z:o.z=c.z,y=l.w,m=u.w,Number.isFinite(y)&&Number.isFinite(m)?o.w=f*c.w+v*y*a+p*m*a+g*_.w:o.w=c.w,o},s}(_r),function(){xa._supportInterpolationMode=!0}(),function(){xa._isCopyMode=!0}(),function(){xa._tempConjugateQuat=new Re}(),xa);fa=T([kt()],fa);var ii,Ti=(ii=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=new ee,i}return s._initializeOwner=function(t){t.defaultValue=new ee,t.fixedPoseValue=new ee,t.baseEvaluateData.value=new ee,t.crossEvaluateData.value=new ee},s._initializeLayerOwner=function(t){t.finalValue=new ee},s._lerpValue=function(t,e,r,a){return ee.lerp(t,e,r,a),a},s._additiveValue=function(t,e,r){return ee.scale(t,e,t),ee.add(r,t,r),r},s._subtractValue=function(t,e,r){return ee.subtract(t,e,r),r},s._getZeroValue=function(t){return t.set(0,0),t},s._setValue=function(t,e){return e.copyFrom(t),e},s._hermiteInterpolationValue=function(t,e,r,a,o){var c=t.value,l=t.outTangent,_=e.value,u=e.inTangent,h=r*r,d=h*r,f=2*d-3*h+1,v=d-2*h+r,p=d-h,g=-2*d+3*h,y=l.x,m=u.x;return Number.isFinite(y)&&Number.isFinite(m)?o.x=f*c.x+v*y*a+p*m*a+g*_.x:o.x=c.x,y=l.y,m=u.y,Number.isFinite(y)&&Number.isFinite(m)?o.y=f*c.y+v*y*a+p*m*a+g*_.y:o.y=c.y,o},s}(_r),function(){ii._isCopyMode=!0}(),function(){ii._supportInterpolationMode=!0}(),ii);Ti=T([kt()],Ti);var oi,Ia=(oi=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=new R,i}return s._initializeOwner=function(t){t.defaultValue=new R,t.fixedPoseValue=new R,t.baseEvaluateData.value=new R,t.crossEvaluateData.value=new R},s._initializeLayerOwner=function(t){t.finalValue=new R},s._lerpValue=function(t,e,r,a){return R.lerp(t,e,r,a),a},s._relativeBaseValue=function(t,e){return R.subtract(e,t,e),e},s._additiveValue=function(t,e,r){return R.scale(t,e,t),R.add(r,t,r),r},s._subtractValue=function(t,e,r){return R.subtract(t,e,r),r},s._getZeroValue=function(t){return t.set(0,0,0),t},s._setValue=function(t,e){return e.copyFrom(t),e},s._hermiteInterpolationValue=function(t,e,r,a,o){var c=t.value,l=t.outTangent,_=e.value,u=e.inTangent,h=r*r,d=h*r,f=2*d-3*h+1,v=d-2*h+r,p=d-h,g=-2*d+3*h,y=l.x,m=u.x;return Number.isFinite(y)&&Number.isFinite(m)?o.x=f*c.x+v*y*a+p*m*a+g*_.x:o.x=c.x,y=l.y,m=u.y,Number.isFinite(y)&&Number.isFinite(m)?o.y=f*c.y+v*y*a+p*m*a+g*_.y:o.y=c.y,y=l.z,m=u.z,Number.isFinite(y)&&Number.isFinite(m)?o.z=f*c.z+v*y*a+p*m*a+g*_.z:o.z=c.z,o},s}(_r),function(){oi._isCopyMode=!0}(),function(){oi._supportInterpolationMode=!0}(),oi);Ia=T([kt()],Ia);var si,Ri=(si=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=new ie,i}return s._initializeOwner=function(t){t.defaultValue=new ie,t.fixedPoseValue=new ie,t.baseEvaluateData.value=new ie,t.crossEvaluateData.value=new ie},s._initializeLayerOwner=function(t){t.finalValue=new ie},s._lerpValue=function(t,e,r,a){return ie.lerp(t,e,r,a),a},s._additiveValue=function(t,e,r){return ie.scale(t,e,t),ie.add(r,t,r),r},s._subtractValue=function(t,e,r){return ie.subtract(t,e,r),r},s._getZeroValue=function(t){return t.set(0,0,0,0),t},s._setValue=function(t,e){return e.copyFrom(t),e},s._hermiteInterpolationValue=function(t,e,r,a,o){var c=t.value,l=t.outTangent,_=e.value,u=e.inTangent,h=r*r,d=h*r,f=2*d-3*h+1,v=d-2*h+r,p=d-h,g=-2*d+3*h,y=l.x,m=u.x;return Number.isFinite(y)&&Number.isFinite(m)?o.x=f*c.x+v*y*a+p*m*a+g*_.x:o.x=c.x,y=l.y,m=u.y,Number.isFinite(y)&&Number.isFinite(m)?o.y=f*c.y+v*y*a+p*m*a+g*_.y:o.y=c.y,y=l.z,m=u.z,Number.isFinite(y)&&Number.isFinite(m)?o.z=f*c.z+v*y*a+p*m*a+g*_.z:o.z=c.z,y=l.w,m=u.w,Number.isFinite(y)&&Number.isFinite(m)?o.w=f*c.w+v*y*a+p*m*a+g*_.w:o.w=c.w,o},s}(_r),function(){si._isCopyMode=!0}(),function(){si._supportInterpolationMode=!0}(),si);Ri=T([kt()],Ri);var ci,Mi=(ci=function(n){W(s,n);function s(){return n.call(this)}return s._initializeOwner=function(t){},s._initializeLayerOwner=function(t){},s._setValue=function(t){return t},s}(_r),function(){ci._isCopyMode=!1}(),function(){ci._supportInterpolationMode=!1}(),ci);Mi=T([kt()],Mi);var li,uo=(li=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=new Gr,i}return s._initializeOwner=function(t){t.defaultValue=new Gr,t.fixedPoseValue=new Gr,t.baseEvaluateData.value=new Gr,t.crossEvaluateData.value=new Gr},s._initializeLayerOwner=function(t){t.finalValue=new Gr},s._setValue=function(t,e){return e.copyFrom(t),e},s}(_r),function(){li._isCopyMode=!0}(),function(){li._supportInterpolationMode=!1}(),li);uo=T([kt()],uo);var _i,Pi=(_i=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value="",i}return s._initializeOwner=function(t){t.defaultValue="",t.fixedPoseValue="",t.baseEvaluateData.value="",t.crossEvaluateData.value=""},s._initializeLayerOwner=function(t){t.finalValue=""},s._lerpValue=function(t,e){return t},s._subtractValue=function(t,e,r){return t},s._getZeroValue=function(){return""},s._additiveValue=function(t,e,r){return t},s._setValue=function(t){return t},s._hermiteInterpolationValue=function(t){return t.value},s}(_r),function(){_i._isCopyMode=!1}(),function(){_i._supportInterpolationMode=!1}(),_i);Pi=T([kt()],Pi);var Oa;(function(n){n[n.None=0]="None",n[n.Complete=1]="Complete"})(Oa||(Oa={}));var za;(function(n){n[n.Override=0]="Override",n[n.Additive=1]="Additive"})(za||(za={}));var pt;(function(n){n[n.UnStarted=0]="UnStarted",n[n.Playing=1]="Playing",n[n.Finished=2]="Finished"})(pt||(pt={}));var Ye;(function(n){n[n.Standby=0]="Standby",n[n.Playing=1]="Playing",n[n.CrossFading=2]="CrossFading",n[n.FixedCrossFading=3]="FixedCrossFading",n[n.Finished=4]="Finished"})(Ye||(Ye={}));var ah=function(){function n(){this.handlers=[]}var s=n.prototype;return s.dispose=function(){},n}(),Fo=function(){this.duration=0,this.offset=0,this.exitTime=1},Ua;(function(n){n[n.Once=0]="Once",n[n.Loop=1]="Loop"})(Ua||(Ua={}));var us=function(){function n(){}var s=n.prototype;return s.reset=function(t,e,r){this.state=t,this.frameTime=r,this.stateData=e,this.playState=pt.UnStarted,this.clipTime=t.clipStartTime*t.clip.length,this.currentEventIndex=0,this.currentTransitionIndex=0},s.update=function(t){var e=this.state,r=this.frameTime,a=e._getDuration();this.playState=pt.Playing,e.wrapMode===Ua.Loop?r=a?r%a:0:Math.abs(r)>a&&(r=r<0?-a:a,this.playState=pt.Finished),t&&r===0?this.clipTime=e.clipEndTime*e.clip.length:(r<0&&(r+=a),this.clipTime=r+e.clipStartTime*e.clip.length)},n}(),ih=function(){function n(){this.curveOwnerPool=Object.create(null),this.animatorStateDataMap={},this.srcPlayData=new us,this.destPlayData=new us,this.layerState=Ye.Standby,this.crossCurveMark=0,this.manuallyTransition=new Fo,this.crossLayerOwnerCollection=[]}var s=n.prototype;return s.switchPlayData=function(){var t=this.destPlayData,e=this.srcPlayData;this.srcPlayData=t,this.destPlayData=e},n}(),oh=function(){this.curveLayerOwner=[],this.eventHandlers=[]},Kr=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e.cullingMode=Oa.None,e.speed=1,e._playFrameCount=-1,e._onUpdateIndex=-1,e._updateMark=0,e._animatorLayersData=[],e._curveOwnerPool=Object.create(null),e._animationEventHandlerPool=new Fn(ah),e._tempAnimatorStateInfo={layerIndex:-1,state:null},e._controlledRenderers=[],e}var i=s.prototype;return i.play=function(e,r,a){r===void 0&&(r=-1),a===void 0&&(a=0);var o;(o=this._controllerUpdateFlag)!=null&&o.flag&&this._reset(),this._playFrameCount=this.engine.time.frameCount;var c=this._getAnimatorStateInfo(e,r),l=c.state,_=c.layerIndex;if(l){if(!l.clip){ve.warn("The state named "+e+" has no AnimationClip data.");return}var u=this._getAnimatorLayerData(_),h=this._getAnimatorStateData(e,l,u,_);this._preparePlay(u,l),u.layerState=Ye.Playing,u.srcPlayData.reset(l,h,l._getDuration()*a),this.update(0)}},i.crossFade=function(e,r,a,o){a===void 0&&(a=-1),o===void 0&&(o=0);var c;(c=this._controllerUpdateFlag)!=null&&c.flag&&this._reset(),this._playFrameCount=this.engine.time.frameCount;var l=this._getAnimatorStateInfo(e,a),_=l.state,u=l.layerIndex,h=this._getAnimatorLayerData(u).manuallyTransition;h.duration=r,h.offset=o,h.destinationState=_,this._crossFadeByTransition(h,u)&&this.update(0)},i.update=function(e){var r,a;if(this.cullingMode===Oa.Complete){a=!1;for(var o=this._controlledRenderers,c=0,l=o.length;c<l;c++)if(!o[c].isCulled){a=!0;break}}else a=!0;var _=this,u=_._animatorController;if(u){if((r=this._controllerUpdateFlag)!=null&&r.flag){this._checkAutoPlay();return}this._updateMark++;for(var h=0,d=u.layers.length;h<d;h++){var f=this._getAnimatorLayerData(h);f.layerState!==Ye.Standby&&this._updateLayer(h,h===0,e,a)}}},i.getCurrentAnimatorState=function(e){var r,a;return(a=this._animatorLayersData[e])==null||(r=a.srcPlayData)==null?void 0:r.state},i.findAnimatorState=function(e,r){return r===void 0&&(r=-1),this._getAnimatorStateInfo(e,r).state},i._onEnable=function(){this.animatorController&&this._checkAutoPlay(),this._entity.getComponentsIncludeChildren(ye,this._controlledRenderers)},i._onEnableInScene=function(){this.scene._componentsManager.addOnUpdateAnimations(this)},i._onDisableInScene=function(){this.scene._componentsManager.removeOnUpdateAnimations(this)},i._reset=function(){var e=this,r=e._curveOwnerPool;for(var a in r){var o=r[a];for(var c in o){var l=o[c];l.revertDefaultValue()}}this._animatorLayersData.length=0,this._curveOwnerPool={},this._animationEventHandlerPool.resetPool(),this._controllerUpdateFlag&&(this._controllerUpdateFlag.flag=!1)},i._getAnimatorStateInfo=function(e,r){var a=this,o=a._animatorController,c=a._tempAnimatorStateInfo,l=null;if(o){var _=o.layers;if(r===-1){for(var u=0,h=_.length;u<h;u++)if(l=_[u].stateMachine.findStateByName(e),l){r=u;break}}else l=_[r].stateMachine.findStateByName(e)}return c.layerIndex=r,c.state=l,c},i._getAnimatorStateData=function(e,r,a,o){var c=a.animatorStateDataMap,l=c[e];return l||(l=new oh,c[e]=l,this._saveAnimatorStateData(r,l,a,o),this._saveAnimatorEventHandlers(r,l)),l},i._saveAnimatorStateData=function(e,r,a,o){for(var c=this,l=c.entity,_=c._curveOwnerPool,u=this._animatorController.layers[o].mask,h=r.curveLayerOwner,d=e.clip,f=d._curveBindings,v=a.curveOwnerPool,p=f.length-1;p>=0;p--){var g=f[p],y=g.relativePath,m=g.relativePath===""?l:l.findByPath(g.relativePath);if(m){var x,C,b,A,S,w,E,P,M=g.typeIndex>0?m.getComponents(g.type,fn._components)[g.typeIndex]:m.getComponent(g.type);if(!M)continue;var D=g.property,L=M.instanceId,V=(x=_)[C=L]||(x[C]=Object.create(null)),N=(b=V)[A=D]||(b[A]=g._createCurveOwner(m,M)),I=(S=v)[w=L]||(S[w]=Object.create(null)),B=(E=I)[P=D]||(E[P]=g._createCurveLayerOwner(N));if(u&&u.pathMasks.length){var z,U;B.isActive=(U=(z=u.getPathMask(y))==null?void 0:z.active)!=null?U:!0}h[p]=B}else h[p]=null,ve.warn("The entity don't have the child entity which path is "+g.relativePath+".")}},i._saveAnimatorEventHandlers=function(e,r){var a=this,o=this._animationEventHandlerPool,c=[],l=r.eventHandlers,_=function(){a._entity.getComponents(zr,c);var u=c.length,h=e.clip.events;l.length=0;for(var d=0,f=h.length;d<f;d++){var v=h[d],p=o.getFromPool(),g=v.functionName,y=p.handlers;p.event=v,y.length=0;for(var m=u-1;m>=0;m--){var x=c[m][g];x&&y.push(x)}l.push(p)}};_(),e._updateFlagManager.addListener(_)},i._clearCrossData=function(e){e.crossCurveMark++,e.crossLayerOwnerCollection.length=0},i._addCrossOwner=function(e,r,a,o){r.crossSrcCurveIndex=a,r.crossDestCurveIndex=o,e.crossLayerOwnerCollection.push(r)},i._prepareCrossFading=function(e){this._prepareSrcCrossData(e,!1),this._prepareDestCrossData(e,!1)},i._prepareStandbyCrossFading=function(e){e.srcPlayData.state&&this._prepareSrcCrossData(e,!0),this._prepareDestCrossData(e,!0)},i._prepareFixedPoseCrossFading=function(e){for(var r=e.crossLayerOwnerCollection,a=r.length-1;a>=0;a--){var o=r[a];o&&(o.curveOwner.saveFixedPoseValue(),o.crossDestCurveIndex=-1)}this._prepareDestCrossData(e,!0)},i._prepareSrcCrossData=function(e,r){for(var a=e.srcPlayData.stateData.curveLayerOwner,o=a.length-1;o>=0;o--){var c=a[o];c&&(c.crossCurveMark=e.crossCurveMark,r&&c.curveOwner.saveFixedPoseValue(),this._addCrossOwner(e,c,o,-1))}},i._prepareDestCrossData=function(e,r){for(var a=e.destPlayData.stateData.curveLayerOwner,o=a.length-1;o>=0;o--){var c=a[o];if(c)if(c.crossCurveMark===e.crossCurveMark)c.crossDestCurveIndex=o;else{var l=c.curveOwner;r&&l.saveFixedPoseValue(),c.crossCurveMark=e.crossCurveMark,this._addCrossOwner(e,c,-1,o)}}},i._getAnimatorLayerData=function(e){var r=this._animatorLayersData[e];return r||(this._animatorLayersData[e]=r=new ih),r},i._updateLayer=function(e,r,a,o){var c=this._animatorController.layers[e],l=c.blendingMode,_=c.weight,u=this._animatorLayersData[e],h=u.srcPlayData,d=u.destPlayData,f=l===za.Additive;switch(r&&(_=1),u.layerState){case Ye.Playing:this._updatePlayingState(h,u,e,_,a,f,o);break;case Ye.FixedCrossFading:this._updateCrossFadeFromPose(d,u,e,_,a,f,o);break;case Ye.CrossFading:this._updateCrossFade(h,d,u,e,_,a,f,o);break;case Ye.Finished:this._updateFinishedState(h,_,f,o);break}},i._updatePlayingState=function(e,r,a,o,c,l,_){var u=e.stateData,h=u.curveLayerOwner,d=u.eventHandlers,f=e.state,v=e.playState,p=e.clipTime,g=f.transitions,y=f.clip,m=y._curveBindings,x=f.speed*this.speed;e.frameTime+=x*c,e.update(x<0);var C=e.clipTime,b=e.playState,A=b===pt.Finished;if(_||A)for(var S=m.length-1;S>=0;S--){var w,E=h[S],P=(w=E)==null?void 0:w.curveOwner;if(!(!P||!E.isActive)){var M=m[S].curve;if(M.keys.length){this._checkRevertOwner(P,l);var D=P.evaluateValue(M,C,l);_&&P.applyValue(D,o,l),A&&E.saveFinalValue()}}}if(b===pt.Finished&&(r.layerState=Ye.Finished),d.length&&this._fireAnimationEvents(e,d,p,C),v===pt.UnStarted&&this._callAnimatorScriptOnEnter(f,a),b===pt.Finished?this._callAnimatorScriptOnExit(f,a):this._callAnimatorScriptOnUpdate(f,a),g.length){var L=r.layerState;L!==Ye.CrossFading&&L!==Ye.FixedCrossFading&&this._checkTransition(e,g,a,p,C)}},i._updateCrossFade=function(e,r,a,o,c,l,_,u){var h=this.speed,d=a.crossLayerOwnerCollection,f=e.state.clip,v=f._curveBindings,p=e.state,g=e.stateData,y=e.playState,m=g.eventHandlers,x=r.state,C=r.stateData,b=r.playState,A=C.eventHandlers,S=x.clip,w=S._curveBindings,E=e.clipTime,P=r.clipTime,M=x._getDuration()*a.crossFadeTransition.duration,D=Math.abs(r.frameTime)/M;(D>=1||M===0)&&(D=1);var L=p.speed*h,V=x.speed*h;e.frameTime+=L*l,r.frameTime+=V*l,e.update(L<0),r.update(V<0);var N=e.clipTime,I=e.playState,B=r.clipTime,z=r.playState,U=r.playState===pt.Finished;if(u||U)for(var Y=d.length-1;Y>=0;Y--){var Q,H=d[Y],te=(Q=H)==null?void 0:Q.curveOwner;if(te){var Ce=H.crossSrcCurveIndex,de=H.crossDestCurveIndex;this._checkRevertOwner(te,_);var ae=te.evaluateCrossFadeValue(Ce>=0?v[Ce].curve:null,de>=0?w[de].curve:null,N,B,D,_);u&&te.applyValue(ae,c,_),U&&H.saveFinalValue()}}this._updateCrossFadeData(a,D),m.length&&this._fireAnimationEvents(e,m,E,N),A.length&&this._fireAnimationEvents(r,A,P,B),y===pt.UnStarted&&this._callAnimatorScriptOnEnter(p,o),D===1||I===pt.Finished?this._callAnimatorScriptOnExit(p,o):this._callAnimatorScriptOnUpdate(p,o),b===pt.UnStarted&&this._callAnimatorScriptOnEnter(x,o),z===pt.Finished?this._callAnimatorScriptOnExit(x,o):this._callAnimatorScriptOnUpdate(x,o)},i._updateCrossFadeFromPose=function(e,r,a,o,c,l,_){var u=r.crossLayerOwnerCollection,h=e.state,d=e.stateData,f=e.playState,v=d.eventHandlers,p=h.clip,g=p._curveBindings,y=e.clipTime,m=h._getDuration()*r.crossFadeTransition.duration,x=Math.abs(e.frameTime)/m;(x>=1||m===0)&&(x=1);var C=h.speed*this.speed;e.frameTime+=C*c,e.update(C<0);var b=e.clipTime,A=e.playState,S=A===pt.Finished;if(_||S)for(var w=u.length-1;w>=0;w--){var E,P=u[w],M=(E=P)==null?void 0:E.curveOwner;if(M){var D=P.crossDestCurveIndex;this._checkRevertOwner(M,l);var L=P.curveOwner.crossFadeFromPoseAndApplyValue(D>=0?g[D].curve:null,b,x,l);_&&M.applyValue(L,o,l),S&&P.saveFinalValue()}}this._updateCrossFadeData(r,x),v.length&&this._fireAnimationEvents(e,v,y,b),f===pt.UnStarted&&this._callAnimatorScriptOnEnter(h,a),A===pt.Finished?this._callAnimatorScriptOnExit(h,a):this._callAnimatorScriptOnUpdate(h,a)},i._updateFinishedState=function(e,r,a,o){if(o)for(var c=e.stateData.curveLayerOwner,l=e.state.clip,_=l._curveBindings,u=_.length-1;u>=0;u--){var h,d=c[u],f=(h=d)==null?void 0:h.curveOwner;f&&(this._checkRevertOwner(f,a),f.applyValue(d.finalValue,r,a))}},i._updateCrossFadeData=function(e,r){var a=e.destPlayData;r===1&&(a.playState===pt.Finished?e.layerState=Ye.Finished:e.layerState=Ye.Playing,e.switchPlayData(),e.crossFadeTransition=null)},i._preparePlay=function(e,r){if(e.layerState===Ye.Playing){var a=e.srcPlayData;if(a.state!==r)for(var o=a.stateData.curveLayerOwner,c=o.length-1;c>=0;c--){var l;(l=o[c])==null||l.curveOwner.revertDefaultValue()}}else for(var _=e.crossLayerOwnerCollection,u=_.length-1;u>=0;u--)_[u].curveOwner.revertDefaultValue()},i._checkTransition=function(e,r,a,o,c){var l=e.state,_=l.clip.length;this.speed*l.speed>=0?c<o?(this._checkSubTransition(e,r,a,o,l.clipEndTime*_),e.currentTransitionIndex=0,this._checkSubTransition(e,r,a,l.clipStartTime*_,c)):this._checkSubTransition(e,r,a,o,c):c>o?(this._checkBackwardsSubTransition(e,r,a,o,l.clipStartTime*_),e.currentTransitionIndex=r.length-1,this._checkBackwardsSubTransition(e,r,a,c,l.clipEndTime*_)):this._checkBackwardsSubTransition(e,r,a,o,c)},i._checkSubTransition=function(e,r,a,o,c){for(var l=e.currentTransitionIndex,_=e.state._getDuration(),u=r.length;l<u;l++){var h=r[l],d=h.exitTime*_;if(d>c)break;d>=o&&(this._crossFadeByTransition(h,a),e.currentTransitionIndex=Math.min(l+1,u-1))}},i._checkBackwardsSubTransition=function(e,r,a,o,c){for(var l=e.currentTransitionIndex,_=e.state._getDuration();l>=0;l--){var u=r[l],h=u.exitTime*_;if(h<c)break;h<=o&&(this._crossFadeByTransition(u,a),e.currentTransitionIndex=Math.max(l-1,0))}},i._crossFadeByTransition=function(e,r){var a=e.destinationState;if(!a)return!1;if(!a.clip)return ve.warn("The state named "+name+" has no AnimationClip data."),!1;var o=this._getAnimatorLayerData(r),c=o.layerState,l=o.destPlayData,_=this._getAnimatorStateData(a.name,a,o,r),u=a._getDuration(),h=u*e.offset;switch(l.reset(a,_,h),c){case Ye.Standby:case Ye.Finished:o.layerState=Ye.FixedCrossFading,this._clearCrossData(o),this._prepareStandbyCrossFading(o);break;case Ye.Playing:o.layerState=Ye.CrossFading,this._clearCrossData(o),this._prepareCrossFading(o);break;case Ye.CrossFading:o.layerState=Ye.FixedCrossFading,this._prepareFixedPoseCrossFading(o);break;case Ye.FixedCrossFading:this._prepareFixedPoseCrossFading(o);break}return o.crossFadeTransition=e,!0},i._fireAnimationEvents=function(e,r,a,o){var c=e.state,l=c.clip.length;this.speed*c.speed>=0?o<a?(this._fireSubAnimationEvents(e,r,a,c.clipEndTime*l),e.currentEventIndex=0,this._fireSubAnimationEvents(e,r,c.clipStartTime*l,o)):this._fireSubAnimationEvents(e,r,a,o):o>a?(this._fireBackwardSubAnimationEvents(e,r,a,c.clipStartTime*l),e.currentEventIndex=r.length-1,this._fireBackwardSubAnimationEvents(e,r,c.clipEndTime*l,o)):this._fireBackwardSubAnimationEvents(e,r,a,o)},i._fireSubAnimationEvents=function(e,r,a,o){for(var c=e.currentEventIndex,l=r.length;c<l;c++){var _=r[c],u=_.event,h=u.time,d=u.parameter;if(h>o)break;var f=_.handlers;if(h>=a){for(var v=f.length-1;v>=0;v--)f[v](d);e.currentEventIndex=Math.min(c+1,l-1)}}},i._fireBackwardSubAnimationEvents=function(e,r,a,o){for(var c=e.currentEventIndex;c>=0;c--){var l=r[c],_=l.event,u=_.time,h=_.parameter;if(u<o)break;if(u<=a){for(var d=l.handlers,f=d.length-1;f>=0;f--)d[f](h);e.currentEventIndex=Math.max(c-1,0)}}},i._callAnimatorScriptOnEnter=function(e,r){for(var a=e._onStateEnterScripts,o=0,c=a.length;o<c;o++)a[o].onStateEnter(this,e,r)},i._callAnimatorScriptOnUpdate=function(e,r){for(var a=e._onStateUpdateScripts,o=0,c=a.length;o<c;o++)a[o].onStateUpdate(this,e,r)},i._callAnimatorScriptOnExit=function(e,r){for(var a=e._onStateExitScripts,o=0,c=a.length;o<c;o++)a[o].onStateExit(this,e,r)},i._checkAutoPlay=function(){for(var e=this._animatorController.layers,r=0,a=e.length;r<a;++r){var o,c=e[r].stateMachine;(o=c)!=null&&o.defaultState&&this.play(c.defaultState.name,r)}},i._checkRevertOwner=function(e,r){r&&e.updateMark!==this._updateMark&&e.revertDefaultValue(),e.updateMark=this._updateMark},j(s,[{key:"animatorController",get:function(){return this._animatorController},set:function(e){e!==this._animatorController&&(this._reset(),this._controllerUpdateFlag&&this._controllerUpdateFlag.destroy(),this._controllerUpdateFlag=e&&e._registerChangeFlag(),this._animatorController=e)}}]),s}(Rt);T([Me],Kr.prototype,"speed",void 0);T([F],Kr.prototype,"_controllerUpdateFlag",void 0);T([F],Kr.prototype,"_updateMark",void 0);T([F],Kr.prototype,"_animatorLayersData",void 0);T([F],Kr.prototype,"_curveOwnerPool",void 0);T([F],Kr.prototype,"_animationEventHandlerPool",void 0);T([F],Kr.prototype,"_tempAnimatorStateInfo",void 0);T([F],Kr.prototype,"_controlledRenderers",void 0);var No=function(){function n(){this._updateFlagManager=new Er,this._layers=[],this._layersMap={}}var s=n.prototype;return s.findLayerByName=function(t){return this._layersMap[t]},s.addLayer=function(t){this._layers.push(t),this._layersMap[t.name]=t,this._updateFlagManager.dispatch()},s.removeLayer=function(t){var e=this.layers[t];this._layers.splice(t,1),delete this._layersMap[e.name],this._updateFlagManager.dispatch()},s.clearLayers=function(){this._layers.length=0;for(var t in this._layersMap)delete this._layersMap[t];this._updateFlagManager.dispatch()},s._registerChangeFlag=function(){return this._updateFlagManager.createFlag(zi)},j(n,[{key:"layers",get:function(){return this._layers}}]),n}(),Io=function(s){this.name=s,this.weight=1,this.blendingMode=za.Override},ho=function(){function n(){this._destroyed=!1}var s=n.prototype;return s.onStateEnter=function(t,e,r){},s.onStateUpdate=function(t,e,r){},s.onStateExit=function(t,e,r){},s.destroy=function(){this._destroyed||(this._state._removeStateMachineScript(this),this._destroyed=!0)},n}(),Xc=function(){function n(i){this.name=i,this.speed=1,this.wrapMode=Ua.Loop,this._onStateEnterScripts=[],this._onStateUpdateScripts=[],this._onStateExitScripts=[],this._updateFlagManager=new Er,this._clipStartTime=0,this._clipEndTime=1,this._transitions=[],this._onClipChanged=this._onClipChanged.bind(this)}var s=n.prototype;return s.addTransition=function(t){var e=this._transitions,r=e.length,a=t.exitTime,o=r?e[r-1].exitTime:0;if(a>=o)e.push(t);else{for(var c=r;--c>=0&&a<e[c].exitTime;);e.splice(c+1,0,t)}},s.removeTransition=function(t){var e=this._transitions.indexOf(t);e!==-1&&this._transitions.splice(e,1)},s.addStateMachineScript=function(t){var e=new t;e._state=this;var r=ho.prototype;return e.onStateEnter!==r.onStateEnter&&this._onStateEnterScripts.push(e),e.onStateUpdate!==r.onStateUpdate&&this._onStateUpdateScripts.push(e),e.onStateExit!==r.onStateExit&&this._onStateExitScripts.push(e),e},s.clearTransitions=function(){this._transitions.length=0},s._getDuration=function(){return this.clip?(this._clipEndTime-this._clipStartTime)*this.clip.length:null},s._removeStateMachineScript=function(t){var e=ho.prototype;if(t.onStateEnter!==e.onStateEnter){var r=this._onStateEnterScripts.indexOf(t);r!==-1&&this._onStateEnterScripts.splice(r,1)}if(t.onStateUpdate!==e.onStateUpdate){var a=this._onStateUpdateScripts.indexOf(t);a!==-1&&this._onStateUpdateScripts.splice(a,1)}if(t.onStateExit!==e.onStateExit){var o=this._onStateExitScripts.indexOf(t);o!==-1&&this._onStateExitScripts.splice(o,1)}},s._onClipChanged=function(){this._updateFlagManager.dispatch()},j(n,[{key:"transitions",get:function(){return this._transitions}},{key:"clip",get:function(){return this._clip},set:function(t){var e=this._clip;e!==t&&(e&&e._updateFlagManager.removeListener(this._onClipChanged),this._clip=t,this._clipEndTime=Math.min(this._clipEndTime,1),this._onClipChanged(),t&&t._updateFlagManager.addListener(this._onClipChanged))}},{key:"clipStartTime",get:function(){return this._clipStartTime},set:function(t){this._clipStartTime=Math.max(t,0)}},{key:"clipEndTime",get:function(){return this._clipEndTime},set:function(t){this._clipEndTime=Math.min(t,1)}}]),n}(),Oo=function(){function n(){this.states=[],this._statesMap={}}var s=n.prototype;return s.addState=function(t){var e=this.findStateByName(t);return e?console.warn("The state named "+t+" has existed."):(e=new Xc(t),this.states.push(e),this._statesMap[t]=e),e},s.removeState=function(t){var e=t.name,r=this.states.indexOf(t);r>-1&&this.states.splice(r,1),delete this._statesMap[e]},s.findStateByName=function(t){return this._statesMap[t]},s.makeUniqueStateName=function(t){for(var e=this._statesMap,r=t,a=0;e[t];)t=r+" "+a,a++;return t},n}(),fo;(function(n){n[n.If=0]="If",n[n.IfNot=1]="IfNot",n[n.Greater=2]="Greater",n[n.Less=3]="Less",n[n.Equals=4]="Equals",n[n.NotEquals=5]="NotEquals"})(fo||(fo={}));var Ft=function(){},sh=function(){},ch=function(){function n(){this._pathMasks=[],this._pathMaskMap={}}var s=n.prototype;return s.addPathMask=function(t){var e=this._pathMaskMap[t];if(e)return e;var r=new sh;return r.path=t,r.active=!0,this._pathMasks.push(r),this._pathMaskMap[t]=r,r},s.removePathMask=function(t){for(var e=this,r=e._pathMasks,a=0,o=this._pathMasks.length;a<o;++a)if(r[a].path===t){r.splice(a,1),delete this._pathMaskMap[t];break}},s.getPathMask=function(t){return this._pathMaskMap[t]},s.setPathMaskActive=function(t,e,r){r===void 0&&(r=!1);var a=this._pathMaskMap[t];if(a&&(a.active=e),r)for(var o in this._pathMaskMap)o.startsWith(t)&&(this._pathMaskMap[o].active=e)},n.createByEntity=function(t){var e=new n;return e.addPathMask(""),n._addPathMaskWithChildren(e,t,""),e},n._addPathMaskWithChildren=function(t,e,r){for(var a=e.children,o=0,c=a.length;o<c;++o){var l=a[o],_=r?r+"/"+l.name:l.name;t.addPathMask(_),n._addPathMaskWithChildren(t,l,_)}},j(n,[{key:"pathMasks",get:function(){return this._pathMasks}}]),n}(),ma=function(n){W(s,n);function s(t){var e;return e=n.call(this,t,Se.find("skybox"))||this,e._textureDecodeRGBM=!1,e._tintColor=new q(1,1,1,1),e.renderState.rasterState.cullMode=qt.Off,e.renderState.depthState.compareFunction=Ee.LessEqual,e.shaderData.setFloat(s._rotationProp,0),e.shaderData.setFloat(s._exposureProp,1),e.shaderData.setColor(s._tintColorProp,e._tintColor),e}var i=s.prototype;return i.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},j(s,[{key:"textureDecodeRGBM",get:function(){return this._textureDecodeRGBM},set:function(e){this._textureDecodeRGBM=e,e?this.shaderData.enableMacro(s._decodeSkyRGBMMacro):this.shaderData.disableMacro(s._decodeSkyRGBMMacro)}},{key:"texture",get:function(){return this.shaderData.getTexture(s._textureCubeProp)},set:function(e){this.shaderData.setTexture(s._textureCubeProp,e)}},{key:"rotation",get:function(){return this.shaderData.getFloat(s._rotationProp)},set:function(e){this.shaderData.setFloat(s._rotationProp,e)}},{key:"exposure",get:function(){return this.shaderData.getFloat(s._exposureProp)},set:function(e){this.shaderData.setFloat(s._exposureProp,e)}},{key:"tintColor",get:function(){return this._tintColor},set:function(e){this._tintColor!=e&&this._tintColor.copyFrom(e)}}]),s}(Sr);(function(){ma._tintColorProp=O.getByName("material_TintColor")})();(function(){ma._textureCubeProp=O.getByName("material_CubeTexture")})();(function(){ma._rotationProp=O.getByName("material_Rotation")})();(function(){ma._exposureProp=O.getByName("material_Exposure")})();(function(){ma._decodeSkyRGBMMacro=oe.getByName("MATERIAL_IS_DECODE_SKY_RGBM")})();var vo;(function(n){n[n.None=0]="None",n[n.Simple=1]="Simple",n[n.HighQuality=2]="HighQuality"})(vo||(vo={}));var vn=function(n){W(s,n);function s(t){var e;return e=n.call(this,t,Se.find("SkyProcedural"))||this,e.sunMode=2,e.sunSize=.04,e.sunSizeConvergence=5,e.atmosphereThickness=1,e.skyTint=new q(.5,.5,.5,1),e.groundTint=new q(.369,.349,.341,1),e.exposure=1.3,e.renderState.rasterState.cullMode=qt.Off,e.renderState.depthState.compareFunction=Ee.LessEqual,e}var i=s.prototype;return i.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},j(s,[{key:"sunMode",get:function(){return this._sunDisk},set:function(e){var r=this.shaderData;switch(e){case 2:r.disableMacro(s._sunSimpleMacro),r.enableMacro(s._sunHighQualityMacro);break;case 1:r.disableMacro(s._sunHighQualityMacro),r.enableMacro(s._sunSimpleMacro);break;case 0:r.disableMacro(s._sunHighQualityMacro),r.disableMacro(s._sunSimpleMacro);break;default:throw"SkyBoxProceduralMaterial: unknown sun value."}this._sunDisk=e}},{key:"sunSize",get:function(){return this.shaderData.getFloat(s._sunSizeProp)},set:function(e){this.shaderData.setFloat(s._sunSizeProp,Math.min(Math.max(0,e),1))}},{key:"sunSizeConvergence",get:function(){return this.shaderData.getFloat(s._sunSizeConvergenceProp)},set:function(e){this.shaderData.setFloat(s._sunSizeConvergenceProp,Math.min(Math.max(0,e),20))}},{key:"atmosphereThickness",get:function(){return this.shaderData.getFloat(s._atmosphereThicknessProp)},set:function(e){this.shaderData.setFloat(s._atmosphereThicknessProp,Math.min(Math.max(0,e),5))}},{key:"skyTint",get:function(){return this.shaderData.getColor(s._skyTintProp)},set:function(e){this.shaderData.setColor(s._skyTintProp,e)}},{key:"groundTint",get:function(){return this.shaderData.getColor(s._groundTintProp)},set:function(e){this.shaderData.setColor(s._groundTintProp,e)}},{key:"exposure",get:function(){return this.shaderData.getFloat(s._exposureProp)},set:function(e){this.shaderData.setFloat(s._exposureProp,Math.min(Math.max(0,e),8))}}]),s}(Sr);(function(){vn._sunSizeProp=O.getByName("material_SunSize")})();(function(){vn._sunSizeConvergenceProp=O.getByName("material_SunSizeConvergence")})();(function(){vn._atmosphereThicknessProp=O.getByName("material_AtmosphereThickness")})();(function(){vn._skyTintProp=O.getByName("material_SkyTint")})();(function(){vn._groundTintProp=O.getByName("material_GroundTint")})();(function(){vn._exposureProp=O.getByName("material_Exposure")})();(function(){vn._sunHighQualityMacro=oe.getByName("MATERIAL_SUN_HIGH_QUALITY")})();(function(){vn._sunSimpleMacro=oe.getByName("MATERIAL_SUN_SIMPLE")})();var lh=function(){},gr;(function(n){n[n.Billboard=0]="Billboard",n[n.StretchBillboard=1]="StretchBillboard",n[n.HorizontalBillboard=2]="HorizontalBillboard",n[n.VerticalBillboard=3]="VerticalBillboard",n[n.Mesh=4]="Mesh",n[n.None=5]="None"})(gr||(gr={}));var va;(function(n){n[n.StopEmittingAndClear=0]="StopEmittingAndClear",n[n.StopEmitting=1]="StopEmitting"})(va||(va={}));var $t=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e.generator=new Ne(ce(e)),e.velocityScale=0,e.lengthScale=2,e.pivot=new R,e._currentRenderModeMacro=s._billboardModeMacro,e.shaderData.enableMacro(s._billboardModeMacro),e._supportInstancedArrays=e.engine._hardwareRenderer.canIUse(K.instancedArrays),e._dirtyUpdateFlag|=Qe.WorldVolume,e}var i=s.prototype;return i._onEnable=function(){this.generator.main.playOnEnabled&&this.generator.play(!1)},i._onDisable=function(){this.generator.stop(!1,va.StopEmittingAndClear)},i._prepareRender=function(e){if(this._supportInstancedArrays){var r=this.generator;r._update(this.engine.time.deltaTime),r._firstActiveElement!==r._firstFreeElement&&n.prototype._prepareRender.call(this,e)}},i._updateBounds=function(e){e.min.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),e.max.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},i._updateShaderData=function(e,r){var a=this.shaderData;a.setFloat(s._lengthScale,this.lengthScale),a.setFloat(s._speedScale,this.velocityScale),a.setFloat(s._currentTime,this.generator._playTime),a.setVector3(s._pivotOffsetProperty,this.pivot),this.generator._updateShaderData(a)},i._render=function(e){var r=this.generator;r._primitive.instanceCount=r._getAliveParticleCount();var a=this.getMaterial();if(a){(a.destroyed||a.shader.destroyed)&&(a=this.engine._particleMagentaMaterial);var o=this._engine._renderDataPool.getFromPool();o.setX(this,a,r._primitive,r._subPrimitive),e.camera._renderPipeline.pushRenderData(e,o)}},i._onDestroy=function(){n.prototype._onDestroy.call(this);var e=this._mesh;e&&(e.destroyed||this._addResourceReferCount(e,-1)),this.generator._destroy()},j(s,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){if(this._renderMode!==e){var r=this._renderMode;this._renderMode=e;var a=null,o=this.shaderData;switch(e){case gr.Billboard:a=s._billboardModeMacro;break;case gr.StretchBillboard:a=s._stretchedBillboardModeMacro;break;case gr.HorizontalBillboard:throw"Not implemented";case gr.VerticalBillboard:throw"Not implemented";case gr.Mesh:throw"Not implemented"}this._currentRenderModeMacro!==a&&(this._currentRenderModeMacro&&o.disableMacro(this._currentRenderModeMacro),a&&o.enableMacro(a),this._currentRenderModeMacro=a),r!==gr.Mesh!=(e===gr.Mesh)&&this.generator._reorganizeGeometryBuffers()}}},{key:"mesh",get:function(){return this._mesh},set:function(e){var r=this._mesh;r!==e&&(this._mesh=e,r&&this._addResourceReferCount(r,-1),e&&this._addResourceReferCount(e,1),this.renderMode===gr.Mesh&&this.generator._reorganizeGeometryBuffers())}}]),s}(ye);(function(){$t._billboardModeMacro=oe.getByName("RENDERER_MODE_SPHERE_BILLBOARD")})();(function(){$t._stretchedBillboardModeMacro=oe.getByName("RENDERER_MODE_STRETCHED_BILLBOARD")})();(function(){$t._horizontalBillboardModeMacro=oe.getByName("RENDERER_MODE_HORIZONTAL_BILLBOARD")})();(function(){$t._verticalBillboardModeMacro=oe.getByName("RENDERER_MODE_VERTICAL_BILLBOARD")})();(function(){$t._renderModeMeshMacro=oe.getByName("RENDERER_MODE_MESH")})();(function(){$t._pivotOffsetProperty=O.getByName("renderer_PivotOffset")})();(function(){$t._lengthScale=O.getByName("renderer_StretchedBillboardLengthScale")})();(function(){$t._speedScale=O.getByName("renderer_StretchedBillboardSpeedScale")})();(function(){$t._currentTime=O.getByName("renderer_CurrentTime")})();T([J],$t.prototype,"generator",void 0);T([Eo],$t.prototype,"pivot",void 0);var he;(function(n){n[n.Constant=0]="Constant",n[n.TwoConstants=1]="TwoConstants",n[n.Curve=2]="Curve",n[n.TwoCurves=3]="TwoCurves"})(he||(he={}));var Xt;(function(n){n[n.Constant=0]="Constant",n[n.TwoConstants=1]="TwoConstants",n[n.Gradient=2]="Gradient",n[n.TwoGradients=3]="TwoGradients"})(Xt||(Xt={}));var ln;(function(n){n[n.Local=0]="Local",n[n.World=1]="World"})(ln||(ln={}));var Ge;(function(n){n[n.Burst=592910910]="Burst",n[n.StartDelay=322376503]="StartDelay",n[n.StartColor=306581307]="StartColor",n[n.StartSize=1793934638]="StartSize",n[n.StartRotation=3737431713]="StartRotation",n[n.randomizeRotationDirection=2527743459]="randomizeRotationDirection",n[n.StartLifetime=2368504881]="StartLifetime",n[n.StartSpeed=4085612399]="StartSpeed",n[n.VelocityOverLifetime=3774601268]="VelocityOverLifetime",n[n.ColorOverLifetime=326370691]="ColorOverLifetime",n[n.SizeOverLifetime=1494990940]="SizeOverLifetime",n[n.RotationOverLifetime=1089181156]="RotationOverLifetime",n[n.TextureSheetAnimation=197469413]="TextureSheetAnimation",n[n.Shape=2941263940]="Shape",n[n.GravityModifier=2759560269]="GravityModifier"})(Ge||(Ge={}));var En=function(){function n(i,t){if(i===void 0&&(i=null),t===void 0&&(t=null),this._colorKeys=[],this._alphaKeys=[],this._colorTypeArrayDirty=!1,this._alphaTypeArrayDirty=!1,i)for(var e=0,r=i.length;e<r;e++){var a=i[e];this.addColorKey(a)}if(t)for(var o=0,c=t.length;o<c;o++){var l=t[o];this.addAlphaKey(l)}}var s=n.prototype;return s.addColorKey=function(t,e){var r=this._colorKeys;if(r.length===4)throw new Error("Gradient can only have 4 color keys");var a=typeof t=="number"?new Bi(t,e):t;a._onValueChanged=this._setColorTypeArrayDirty.bind(this),this._addKey(r,a),this._colorTypeArrayDirty=!0},s.addAlphaKey=function(t,e){var r=this._alphaKeys;if(r.length===4)throw new Error("Gradient can only have 4 alpha keys");var a=typeof t=="number"?new Di(t,e):t;a._onValueChanged=this._setAlphaTypeArrayDirty.bind(this),this._addKey(r,a),this._alphaTypeArrayDirty=!0},s.removeColorKey=function(t){this._colorKeys[t]._onValueChanged=null,this._removeKey(this._colorKeys,t),this._colorTypeArrayDirty=!0},s.removeAlphaKey=function(t){this._alphaKeys[t]._onValueChanged=null,this._removeKey(this._alphaKeys,t),this._alphaTypeArrayDirty=!0},s.setKeys=function(t,e){for(var r=this._colorKeys,a=this._alphaKeys,o=0,c=r.length;o<c;o++)r[o]._onValueChanged=null;for(var l=0,_=a.length;l<_;l++)a[l]._onValueChanged=null;r.length=0,a.length=0;for(var u=0,h=t.length;u<h;u++)this._addKey(r,t[u]);for(var d=0,f=e.length;d<f;d++)this._addKey(a,e[d]);this._alphaTypeArrayDirty=!0,this._colorTypeArrayDirty=!0},s._getColorTypeArray=function(t){var e=this._colorTypeArray||(this._colorTypeArray=new Float32Array(16));if(this._colorTypeArrayDirty){for(var r=this._colorKeys,a=0,o=Math.min(r.length,4);a<o;a++){var c=a*4,l=r[a];e[c]=l.time;var _=l.color;t===or.Linear?(e[c+1]=q.gammaToLinearSpace(_.r),e[c+2]=q.gammaToLinearSpace(_.g),e[c+3]=q.gammaToLinearSpace(_.b)):(e[c+1]=_.r,e[c+2]=_.g,e[c+3]=_.b)}this._colorTypeArrayDirty=!1}return e},s._getAlphaTypeArray=function(){var t=this._alphaTypeArray||(this._alphaTypeArray=new Float32Array(8));if(this._alphaTypeArrayDirty){for(var e=this._alphaKeys,r=0,a=Math.min(e.length,4);r<a;r++){var o=r*2,c=e[r];t[o]=c.time,t[o+1]=c.alpha}this._alphaTypeArrayDirty=!1}return t},s._addKey=function(t,e){var r=e.time,a=t.length,o=a?t[a-1].time:0;if(r>=o)t.push(e);else{for(var c=a;--c>=0&&r<t[c].time;);t.splice(c+1,0,e)}},s._removeKey=function(t,e){t.splice(e,1)},s._setColorTypeArrayDirty=function(){this._colorTypeArrayDirty=!0},s._setAlphaTypeArrayDirty=function(){this._alphaTypeArrayDirty=!0},j(n,[{key:"colorKeys",get:function(){return this._colorKeys}},{key:"alphaKeys",get:function(){return this._alphaKeys}}]),n}();T([J],En.prototype,"_colorKeys",void 0);T([J],En.prototype,"_alphaKeys",void 0);T([F],En.prototype,"_colorTypeArray",void 0);T([F],En.prototype,"_alphaTypeArray",void 0);var Bi=function(){function n(s,i){this._onValueChanged=null,this._color=new q,this._time=s,i&&this._color.copyFrom(i),this._color._onValueChanged=this._onValueChanged}return j(n,[{key:"time",get:function(){return this._time},set:function(i){this._time=i,this._onValueChanged&&this._onValueChanged()}},{key:"color",get:function(){return this._color},set:function(i){this._color!==i&&this._color.copyFrom(i)}}]),n}(),Di=function(){function n(s,i){this._onValueChanged=null,this._time=s,this._alpha=i}return j(n,[{key:"time",get:function(){return this._time},set:function(i){this._time=i,this._onValueChanged&&this._onValueChanged()}},{key:"alpha",get:function(){return this._alpha},set:function(i){this._alpha=i,this._onValueChanged&&this._onValueChanged()}}]),n}(),Kn=function(){function n(i,t){this.mode=Xt.Constant,this.constantMin=new q,this.constantMax=new q,this.gradientMin=new En,this.gradientMax=new En,i.constructor===q?t?(this.constantMin.copyFrom(i),this.constantMax.copyFrom(t),this.mode=Xt.TwoConstants):(this.constant.copyFrom(i),this.mode=Xt.Constant):t?(this.gradientMin=i,this.gradientMax=t,this.mode=Xt.TwoGradients):(this.gradient=i,this.mode=Xt.Gradient)}var s=n.prototype;return s.evaluate=function(t,e,r){switch(this.mode){case Xt.Constant:r.copyFrom(this.constant);break;case Xt.TwoConstants:q.lerp(this.constantMin,this.constantMax,e,r);break}},j(n,[{key:"constant",get:function(){return this.constantMax},set:function(t){this.constantMax=t}},{key:"gradient",get:function(){return this.gradientMax},set:function(t){this.gradientMax=t}}]),n}();T([J],Kn.prototype,"constantMin",void 0);T([J],Kn.prototype,"constantMax",void 0);T([J],Kn.prototype,"gradientMin",void 0);T([J],Kn.prototype,"gradientMax",void 0);var Jn=function(){function n(i){this.enabled=!1,this._generator=i}var s=n.prototype;return s._enableMacro=function(t,e,r){return e!==r&&(e&&t.disableMacro(e),r&&t.enableMacro(r)),r},n}();T([F],Jn.prototype,"_generator",void 0);var ur=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.color=new Kn(new En([new Bi(0,new q(1,1,1)),new Bi(1,new q(1,1,1))],[new Di(0,1),new Di(1,1)])),t._colorGradientRand=new mr(0,Ge.ColorOverLifetime),t._gradientKeysCount=new ie(0,0,0,0),t}var i=s.prototype;return i._updateShaderData=function(e){var r=null;if(this.enabled){var a=this.color.mode;if(a!==Xt.Gradient&&a!==Xt.TwoGradients)throw new Error("Invalid color mode, only gradient and two gradients are supported in color over lifetime.");var o=this.color,c=this._generator._renderer.engine.settings.colorSpace;e.setFloatArray(s._maxGradientColor,o.gradientMax._getColorTypeArray(c)),e.setFloatArray(s._maxGradientAlpha,o.gradientMax._getAlphaTypeArray()),a===Xt.Gradient?r=s._gradientMacro:(e.setFloatArray(s._minGradientColor,o.gradientMin._getColorTypeArray(c)),e.setFloatArray(s._minGradientAlpha,o.gradientMin._getAlphaTypeArray()),r=s._randomGradientsMacro);var l=o.gradientMin.colorKeys,_=o.gradientMin.alphaKeys,u=o.gradientMax.colorKeys,h=o.gradientMax.alphaKeys;this._gradientKeysCount.set(l.length?l[l.length-1].time:0,_.length?_[_.length-1].time:0,u.length?u[u.length-1].time:0,h.length?h[h.length-1].time:0),e.setVector4(s._gradientKeysCount,this._gradientKeysCount)}this._colorMacro=this._enableMacro(e,this._colorMacro,r)},i._resetRandomSeed=function(e){this._colorGradientRand.reset(e,Ge.ColorOverLifetime)},s}(Jn);(function(){ur._gradientMacro=oe.getByName("RENDERER_COL_GRADIENT")})();(function(){ur._randomGradientsMacro=oe.getByName("RENDERER_COL_RANDOM_GRADIENTS")})();(function(){ur._minGradientColor=O.getByName("renderer_COLMinGradientColor")})();(function(){ur._minGradientAlpha=O.getByName("renderer_COLMinGradientAlpha")})();(function(){ur._maxGradientColor=O.getByName("renderer_COLMaxGradientColor")})();(function(){ur._maxGradientAlpha=O.getByName("renderer_COLMaxGradientAlpha")})();(function(){ur._gradientKeysCount=O.getByName("renderer_COLGradientKeysMaxTime")})();T([J],ur.prototype,"color",void 0);T([F],ur.prototype,"_colorGradientRand",void 0);T([F],ur.prototype,"_gradientKeysCount",void 0);T([F],ur.prototype,"_colorMacro",void 0);var Oe=function(){function n(i,t){this.mode=he.Constant,this.constantMin=0,this.constantMax=0,typeof i=="number"?t?(this.constantMin=i,this.constantMax=t,this.mode=he.TwoConstants):(this.constant=i,this.mode=he.Constant):t?(this.curveMin=i,this.curveMax=t,this.mode=he.TwoCurves):(this.curve=i,this.mode=he.Curve)}var s=n.prototype;return s.evaluate=function(t,e){switch(this.mode){case he.Constant:return this.constant;case he.TwoConstants:return this.constantMin+(this.constantMax-this.constantMin)*e}},j(n,[{key:"constant",get:function(){return this.constantMax},set:function(t){this.constantMax=t}},{key:"curve",get:function(){return this.curveMax},set:function(t){this.curveMax=t}}]),n}();T([J],Oe.prototype,"curveMin",void 0);T([J],Oe.prototype,"curveMax",void 0);var Pn=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.rateOverTime=new Oe(10),t.rateOverDistance=new Oe(0),t._shapeRand=new mr(0,Ge.Shape),t._frameRateTime=0,t._bursts=[],t._currentBurstIndex=0,t._burstRand=new mr(0,Ge.Burst),t}var i=s.prototype;return i.addBurst=function(e){for(var r=this._bursts,a=r.length;--a>=0&&e.time<r[a].time;);r.splice(a+1,0,e)},i.removeBurst=function(e){var r=this._bursts.indexOf(e);r!==-1&&this._bursts.splice(r,1)},i.removeBurstByIndex=function(e){this._bursts.splice(e,1)},i.clearBurst=function(){this._bursts.length=0},i._emit=function(e,r){this._emitByRateOverTime(r),this._emitByBurst(e,r)},i._resetRandomSeed=function(e){this._burstRand.reset(e,Ge.Burst),this._shapeRand.reset(e,Ge.Shape)},i._reset=function(){this._frameRateTime=0,this._currentBurstIndex=0},i._emitByRateOverTime=function(e){var r=this.rateOverTime.evaluate(void 0,void 0);if(r>0)for(var a=this._generator,o=1/r,c=e-this._frameRateTime;c>=o;)c-=o,this._frameRateTime+=o,a._emit(this._frameRateTime,1)},i._emitByBurst=function(e,r){var a=this._generator.main,o=a.duration,c=Math.floor((r-e)/o);if(a.isLoop&&(c>0||r%o<e%o)){var l=Math.ceil(e/o)*o;this._emitBySubBurst(e,l,o),this._currentBurstIndex=0;for(var _=0;_<c;_++){var u=l;l+=o,this._emitBySubBurst(u,l,o),this._currentBurstIndex=0}this._emitBySubBurst(l,r,o)}else this._emitBySubBurst(e,r,o)},i._emitBySubBurst=function(e,r,a){for(var o=this._generator,c=this._burstRand,l=this.bursts,_=Math.floor(e/a)*a,u=e%a,h=u+(r-e),d=this._currentBurstIndex,f=l.length;d<f;d++){var v=l[d],p=v.time;if(p>h)break;if(p>=u){var g=v.count.evaluate(void 0,c.random());o._emit(_+p,g)}}this._currentBurstIndex=d},j(s,[{key:"bursts",get:function(){return this._bursts}}]),s}(Jn);T([J],Pn.prototype,"rateOverTime",void 0);T([J],Pn.prototype,"rateOverDistance",void 0);T([J],Pn.prototype,"shape",void 0);T([F],Pn.prototype,"_shapeRand",void 0);T([J],Pn.prototype,"_bursts",void 0);T([F],Pn.prototype,"_burstRand",void 0);var kr;(function(n){n[n.Hierarchy=0]="Hierarchy",n[n.Local=1]="Local",n[n.World=2]="World"})(kr||(kr={}));var De=function(){function n(i){this.duration=5,this.isLoop=!0,this.startDelay=new Oe(0),this.startLifetime=new Oe(5),this.startSpeed=new Oe(5),this.startSize3D=!1,this.startSizeX=new Oe(1),this.startSizeY=new Oe(1),this.startSizeZ=new Oe(1),this.startRotation3D=!1,this.startRotationX=new Oe(0),this.startRotationY=new Oe(0),this.startRotationZ=new Oe(0),this.flipRotation=0,this.startColor=new Kn(new q(1,1,1,1)),this.gravityModifier=new Oe(0),this.simulationSpace=ln.Local,this.simulationSpeed=1,this.scalingMode=kr.Local,this.playOnEnabled=!0,this._maxParticleBuffer=1e3,this._startSpeedRand=new mr(0,Ge.StartSpeed),this._startLifeTimeRand=new mr(0,Ge.StartLifetime),this._startColorRand=new mr(0,Ge.StartColor),this._startSizeRand=new mr(0,Ge.StartSize),this._startRotationRand=new mr(0,Ge.StartRotation),this._gravityModifierRand=new mr(0,Ge.GravityModifier),this._gravity=new R,this._generator=i}var s=n.prototype;return s._resetRandomSeed=function(t){this._startSpeedRand.reset(t,Ge.StartSpeed),this._startLifeTimeRand.reset(t,Ge.StartLifetime),this._startColorRand.reset(t,Ge.StartColor),this._startSizeRand.reset(t,Ge.StartSize),this._startRotationRand.reset(t,Ge.StartRotation)},s._getPositionScale=function(){var t=this._generator._renderer.entity.transform;switch(this.scalingMode){case kr.Hierarchy:case kr.World:return t.lossyWorldScale;case kr.Local:return t.scale}},s._updateShaderData=function(t){var e=this._generator._renderer,r=e.entity.transform;switch(this.simulationSpace){case ln.Local:t.setVector3(n._worldPosition,r.worldPosition);var a=r.worldRotationQuaternion,o=n._tempVector40;o.copyFrom(a),t.setVector4(n._worldRotation,o);break;case ln.World:break;default:throw new Error("ParticleRenderer: SimulationSpace value is invalid.")}switch(this.scalingMode){case kr.Hierarchy:var c=r.lossyWorldScale;t.setVector3(n._positionScale,c),t.setVector3(n._sizeScale,c);break;case kr.Local:var c=r.scale;t.setVector3(n._positionScale,c),t.setVector3(n._sizeScale,c);break;case kr.World:t.setVector3(n._positionScale,r.lossyWorldScale),t.setVector3(n._sizeScale,n._vector3One);break}var l=this._gravity,_=this.gravityModifier.evaluate(void 0,this._gravityModifierRand.random());R.scale(e.scene.physics.gravity,_,l),t.setVector3(n._gravity,l),t.setInt(n._simulationSpace,this.simulationSpace),t.setFloat(n._startRotation3D,+this.startRotation3D),t.setInt(n._scaleMode,this.scalingMode)},s._cloneTo=function(t){t.maxParticles=this.maxParticles},j(n,[{key:"maxParticles",get:function(){return this._maxParticleBuffer-1},set:function(t){this._maxParticleBuffer=t+1}},{key:"startSize",get:function(){return this.startSizeX},set:function(t){this.startSizeX=t}}]),n}();(function(){De._tempVector40=new ie})();(function(){De._vector3One=new R(1,1,1)})();(function(){De._positionScale=O.getByName("renderer_PositionScale")})();(function(){De._sizeScale=O.getByName("renderer_SizeScale")})();(function(){De._worldPosition=O.getByName("renderer_WorldPosition")})();(function(){De._worldRotation=O.getByName("renderer_WorldRotation")})();(function(){De._gravity=O.getByName("renderer_Gravity")})();(function(){De._simulationSpace=O.getByName("renderer_SimulationSpace")})();(function(){De._startRotation3D=O.getByName("renderer_ThreeDStartRotation")})();(function(){De._scaleMode=O.getByName("renderer_ScalingMode")})();T([J],De.prototype,"startDelay",void 0);T([J],De.prototype,"startLifetime",void 0);T([J],De.prototype,"startSpeed",void 0);T([J],De.prototype,"startSizeX",void 0);T([J],De.prototype,"startSizeY",void 0);T([J],De.prototype,"startSizeZ",void 0);T([J],De.prototype,"startRotationX",void 0);T([J],De.prototype,"startRotationY",void 0);T([J],De.prototype,"startRotationZ",void 0);T([J],De.prototype,"startColor",void 0);T([J],De.prototype,"gravityModifier",void 0);T([F],De.prototype,"_maxParticleBuffer",void 0);T([F],De.prototype,"_startSpeedRand",void 0);T([F],De.prototype,"_startLifeTimeRand",void 0);T([F],De.prototype,"_startColorRand",void 0);T([F],De.prototype,"_startSizeRand",void 0);T([F],De.prototype,"_startRotationRand",void 0);T([F],De.prototype,"_gravityModifierRand",void 0);T([F],De.prototype,"_generator",void 0);T([F],De.prototype,"_gravity",void 0);var Ze=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.separateAxes=!1,t.rotationX=new Oe(0),t.rotationY=new Oe(0),t.rotationZ=new Oe(45),t._rotationRand=new mr(0,Ge.RotationOverLifetime),t._rotationMinConstant=new R,t._rotationMaxConstant=new R,t}var i=s.prototype;return i._updateShaderData=function(e){var r=null,a=null,o=null;if(this.enabled){var c=this.rotationX,l=this.rotationY,_=this.rotationZ,u=this.separateAxes,h=u?c.mode===he.TwoCurves&&l.mode===he.TwoCurves&&_.mode===he.TwoCurves:_.mode===he.TwoCurves,d=h||u?c.mode===he.Curve&&l.mode===he.Curve&&_.mode===he.Curve:_.mode===he.Curve;if(d)e.setFloatArray(s._maxCurveZProperty,_.curveMax._getTypeArray()),u&&(e.setFloatArray(s._maxCurveXProperty,c.curveMax._getTypeArray()),e.setFloatArray(s._maxCurveYProperty,l.curveMax._getTypeArray())),h&&(e.setFloatArray(s._minCurveZProperty,_.curveMin._getTypeArray()),u&&(e.setFloatArray(s._minCurveXProperty,c.curveMin._getTypeArray()),e.setFloatArray(s._minCurveYProperty,l.curveMin._getTypeArray())),o=s._isRandomTwoMacro),a=s._curveModeMacro;else{var f=this._rotationMaxConstant;if(f.set(k.degreeToRadian(c.constantMax),k.degreeToRadian(l.constantMax),k.degreeToRadian(_.constantMax)),e.setVector3(s._maxConstantProperty,f),u?c.mode===he.TwoConstants&&l.mode===he.TwoConstants&&_.mode===he.TwoConstants:_.mode===he.TwoConstants){var v=this._rotationMinConstant;v.set(k.degreeToRadian(c.constantMin),k.degreeToRadian(l.constantMin),k.degreeToRadian(_.constantMin)),e.setVector3(s._minConstantProperty,v),o=s._isRandomTwoMacro}a=s._constantModeMacro}u&&(r=s._isSeparateMacro)}this._enableSeparateMacro=this._enableMacro(e,this._enableSeparateMacro,r),this._isCurveMacro=this._enableMacro(e,this._isCurveMacro,a),this._isRandomTwoMacro=this._enableMacro(e,this._isRandomTwoMacro,o)},i._resetRandomSeed=function(e){this._rotationRand.reset(e,Ge.RotationOverLifetime)},s}(Jn);(function(){Ze._constantModeMacro=oe.getByName("RENDERER_ROL_CONSTANT_MODE")})();(function(){Ze._curveModeMacro=oe.getByName("RENDERER_ROL_CURVE_MODE")})();(function(){Ze._isSeparateMacro=oe.getByName("RENDERER_ROL_IS_SEPARATE")})();(function(){Ze._isRandomTwoMacro=oe.getByName("RENDERER_ROL_IS_RANDOM_TWO")})();(function(){Ze._minConstantProperty=O.getByName("renderer_ROLMinConst")})();(function(){Ze._minCurveXProperty=O.getByName("renderer_ROLMinCurveX")})();(function(){Ze._minCurveYProperty=O.getByName("renderer_ROLMinCurveY")})();(function(){Ze._minCurveZProperty=O.getByName("renderer_ROLMinCurveZ")})();(function(){Ze._maxConstantProperty=O.getByName("renderer_ROLMaxConst")})();(function(){Ze._maxCurveXProperty=O.getByName("renderer_ROLMaxCurveX")})();(function(){Ze._maxCurveYProperty=O.getByName("renderer_ROLMaxCurveY")})();(function(){Ze._maxCurveZProperty=O.getByName("renderer_ROLMaxCurveZ")})();T([J],Ze.prototype,"rotationX",void 0);T([J],Ze.prototype,"rotationY",void 0);T([J],Ze.prototype,"rotationZ",void 0);T([F],Ze.prototype,"_rotationRand",void 0);T([F],Ze.prototype,"_rotationMinConstant",void 0);T([F],Ze.prototype,"_rotationMaxConstant",void 0);T([F],Ze.prototype,"_enableSeparateMacro",void 0);T([F],Ze.prototype,"_isCurveMacro",void 0);T([F],Ze.prototype,"_isRandomTwoMacro",void 0);var kn=function(){function n(){for(var i=arguments.length,t=new Array(i),e=0;e<i;e++)t[e]=arguments[e];this._keys=[],this._typeArrayDirty=!1;for(var r=0,a=t.length;r<a;r++){var o=t[r];this.addKey(o)}}var s=n.prototype;return s.addKey=function(t,e){var r=this._keys;if(r.length===4)throw new Error("Curve can only have 4 keys");var a=typeof t=="number"?new Hr(t,e):t;this._addKey(r,a),this._typeArrayDirty=!0},s.removeKey=function(t){this._keys.splice(t,1),this._typeArrayDirty=!0},s.setKeys=function(t){this._keys.length=0;for(var e=0,r=t.length;e<r;e++)this.addKey(t[e]);this._typeArrayDirty=!0},s._getTypeArray=function(){var t=this._typeArray||(this._typeArray=new Float32Array(8));if(this._typeArrayDirty){for(var e=this._keys,r=0,a=Math.min(e.length,4);r<a;r++){var o=r*2,c=e[r];t[o]=c.time,t[o+1]=c.value}this._typeArrayDirty=!1}return t},s._addKey=function(t,e){var r=t.length,a=e.time,o=r?t[r-1].time:0;if(a>=o)t.push(e);else{for(var c=r;--c>=0&&a<t[c].time;);t.splice(c+1,0,e)}},j(n,[{key:"keys",get:function(){return this._keys}}]),n}();T([J],kn.prototype,"_keys",void 0);T([F],kn.prototype,"_typeArray",void 0);var Hr=function(s,i){this.time=s,this.value=i},Et=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.separateAxes=!1,t.sizeX=new Oe(new kn(new Hr(0,0),new Hr(1,1))),t.sizeY=new Oe(new kn(new Hr(0,0),new Hr(1,1))),t.sizeZ=new Oe(new kn(new Hr(0,0),new Hr(1,1))),t}var i=s.prototype;return i._updateShaderData=function(e){var r=null,a=null,o=null;if(this.enabled){var c=this.sizeX,l=this.sizeY,_=this.sizeZ,u=this.separateAxes,h=u?c.mode===he.TwoCurves&&l.mode===he.TwoCurves&&_.mode===he.TwoCurves:c.mode===he.TwoCurves,d=h||u?c.mode===he.Curve&&l.mode===he.Curve&&_.mode===he.Curve:c.mode===he.Curve;d&&(e.setFloatArray(s._maxCurveXProperty,c.curveMax._getTypeArray()),u&&(e.setFloatArray(s._maxCurveYProperty,l.curveMax._getTypeArray()),e.setFloatArray(s._maxCurveZProperty,_.curveMax._getTypeArray())),h&&(e.setFloatArray(s._minCurveXProperty,c.curveMin._getTypeArray()),u&&(e.setFloatArray(s._minCurveYProperty,l.curveMin._getTypeArray()),e.setFloatArray(s._minCurveZProperty,_.curveMin._getTypeArray())),o=s._isRandomTwoMacro),a=s._curveModeMacro),u&&(r=s._isSeparateMacro)}this._enableSeparateMacro=this._enableMacro(e,this._enableSeparateMacro,r),this._isCurveMacro=this._enableMacro(e,this._isCurveMacro,a),this._isRandomTwoMacro=this._enableMacro(e,this._isRandomTwoMacro,o)},j(s,[{key:"size",get:function(){return this.sizeX},set:function(e){this.sizeX=e}}]),s}(Jn);(function(){Et._curveModeMacro=oe.getByName("RENDERER_SOL_CURVE_MODE")})();(function(){Et._isSeparateMacro=oe.getByName("RENDERER_SOL_IS_SEPARATE")})();(function(){Et._isRandomTwoMacro=oe.getByName("RENDERER_SOL_IS_RANDOM_TWO")})();(function(){Et._minCurveXProperty=O.getByName("renderer_SOLMinCurveX")})();(function(){Et._minCurveYProperty=O.getByName("renderer_SOLMinCurveY")})();(function(){Et._minCurveZProperty=O.getByName("renderer_SOLMinCurveZ")})();(function(){Et._maxCurveXProperty=O.getByName("renderer_SOLMaxCurveX")})();(function(){Et._maxCurveYProperty=O.getByName("renderer_SOLMaxCurveY")})();(function(){Et._maxCurveZProperty=O.getByName("renderer_SOLMaxCurveZ")})();T([J],Et.prototype,"sizeX",void 0);T([J],Et.prototype,"sizeY",void 0);T([J],Et.prototype,"sizeZ",void 0);T([F],Et.prototype,"_enableSeparateMacro",void 0);T([F],Et.prototype,"_isCurveMacro",void 0);T([F],Et.prototype,"_isRandomTwoMacro",void 0);var tr=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.startFrame=new Oe(0),t.frameOverTime=new Oe(new kn(new Hr(0,0),new Hr(1,1))),t.type=0,t.cycleCount=1,t._tillingInfo=new R(1,1,1),t._frameOverTimeRand=new mr(0,Ge.TextureSheetAnimation),t._tiling=new ee(1,1),t}var i=s.prototype;return i._updateShaderData=function(e){var r=null;if(this.enabled){var a=this.frameOverTime.mode;if(a===he.Curve||a===he.TwoCurves){var o=this.frameOverTime;e.setFloatArray(s._frameMaxCurveProperty,o.curveMax._getTypeArray()),a===he.Curve?r=s._frameCurveMacro:(e.setFloatArray(s._frameMinCurveProperty,o.curveMin._getTypeArray()),r=s._frameRandomCurvesMacro),e.setFloat(s._cycleCountProperty,this.cycleCount),e.setVector3(s._tillingParamsProperty,this._tillingInfo)}}this._textureSheetMacro=this._enableMacro(e,this._textureSheetMacro,r)},i._resetRandomSeed=function(e){this._frameOverTimeRand.reset(e,Ge.TextureSheetAnimation)},j(s,[{key:"tiling",get:function(){return this._tiling},set:function(e){this._tiling=e,this._tillingInfo.set(1/e.x,1/e.y,e.x*e.y)}}]),s}(Jn);(function(){tr._frameCurveMacro=oe.getByName("RENDERER_TSA_FRAME_CURVE")})();(function(){tr._frameRandomCurvesMacro=oe.getByName("RENDERER_TSA_FRAME_RANDOM_CURVES")})();(function(){tr._cycleCountProperty=O.getByName("renderer_TSACycles")})();(function(){tr._tillingParamsProperty=O.getByName("renderer_TSATillingParams")})();(function(){tr._frameMinCurveProperty=O.getByName("renderer_TSAFrameMinCurve")})();(function(){tr._frameMaxCurveProperty=O.getByName("renderer_TSAFrameMaxCurve")})();T([J],tr.prototype,"startFrame",void 0);T([J],tr.prototype,"frameOverTime",void 0);T([Eo],tr.prototype,"_tillingInfo",void 0);T([F],tr.prototype,"_frameOverTimeRand",void 0);T([J],tr.prototype,"_tiling",void 0);T([F],tr.prototype,"_textureSheetMacro",void 0);var hs;(function(n){n[n.WholeSheet=0]="WholeSheet",n[n.SingleRow=1]="SingleRow"})(hs||(hs={}));var nt=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.velocityX=new Oe(0),t.velocityY=new Oe(0),t.velocityZ=new Oe(0),t.space=ln.Local,t._velocityRand=new mr(0,Ge.VelocityOverLifetime),t._velocityMinConstant=new R,t._velocityMaxConstant=new R,t}var i=s.prototype;return i._updateShaderData=function(e){var r=null;if(this.enabled){var a=this.velocityX,o=this.velocityY,c=this.velocityZ,l=a.mode===he.TwoCurves&&o.mode===he.TwoCurves&&c.mode===he.TwoCurves;if(l||a.mode===he.Curve&&o.mode===he.Curve&&c.mode===he.Curve)e.setFloatArray(s._maxGradientXProperty,a.curveMax._getTypeArray()),e.setFloatArray(s._maxGradientYProperty,o.curveMax._getTypeArray()),e.setFloatArray(s._maxGradientZProperty,c.curveMax._getTypeArray()),l?(e.setFloatArray(s._minGradientXProperty,a.curveMin._getTypeArray()),e.setFloatArray(s._minGradientYProperty,o.curveMin._getTypeArray()),e.setFloatArray(s._minGradientZProperty,c.curveMin._getTypeArray()),r=s._randomCurveMacro):r=s._curveMacro;else{var _=this._velocityMaxConstant;if(_.set(a.constantMax,o.constantMax,c.constantMax),e.setVector3(s._maxConstantProperty,_),a.mode===he.TwoConstants&&o.mode===he.TwoConstants&&c.mode===he.TwoConstants){var u=this._velocityMinConstant;u.set(a.constantMin,o.constantMin,c.constantMin),e.setVector3(s._minConstantProperty,u),r=s._randomConstantMacro}else r=s._constantMacro}e.setInt(s._spaceProperty,this.space)}this._velocityMacro=this._enableMacro(e,this._velocityMacro,r)},i._resetRandomSeed=function(e){this._velocityRand.reset(e,Ge.VelocityOverLifetime)},s}(Jn);(function(){nt._constantMacro=oe.getByName("RENDERER_VOL_CONSTANT")})();(function(){nt._curveMacro=oe.getByName("RENDERER_VOL_CURVE")})();(function(){nt._randomConstantMacro=oe.getByName("RENDERER_VOL_RANDOM_CONSTANT")})();(function(){nt._randomCurveMacro=oe.getByName("RENDERER_VOL_RANDOM_CURVE")})();(function(){nt._minConstantProperty=O.getByName("renderer_VOLMinConst")})();(function(){nt._maxConstantProperty=O.getByName("renderer_VOLMaxConst")})();(function(){nt._minGradientXProperty=O.getByName("renderer_VOLMinGradientX")})();(function(){nt._minGradientYProperty=O.getByName("renderer_VOLMinGradientY")})();(function(){nt._minGradientZProperty=O.getByName("renderer_VOLMinGradientZ")})();(function(){nt._maxGradientXProperty=O.getByName("renderer_VOLMaxGradientX")})();(function(){nt._maxGradientYProperty=O.getByName("renderer_VOLMaxGradientY")})();(function(){nt._maxGradientZProperty=O.getByName("renderer_VOLMaxGradientZ")})();(function(){nt._spaceProperty=O.getByName("renderer_VOLSpace")})();T([J],nt.prototype,"velocityX",void 0);T([J],nt.prototype,"velocityY",void 0);T([J],nt.prototype,"velocityZ",void 0);T([F],nt.prototype,"_velocityRand",void 0);T([F],nt.prototype,"_velocityMinConstant",void 0);T([F],nt.prototype,"_velocityMaxConstant",void 0);T([F],nt.prototype,"_velocityMacro",void 0);var Ne=function(){function n(i){this.useAutoRandomSeed=!0,this.main=new De(this),this.emission=new Pn(this),this.velocityOverLifetime=new nt(this),this.sizeOverLifetime=new Et(this),this.rotationOverLifetime=new Ze(this),this.colorOverLifetime=new ur(this),this.textureSheetAnimation=new tr(this),this._currentParticleCount=0,this._playTime=0,this._firstNewElement=0,this._firstActiveElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._vertexBufferBindings=new Array,this._subPrimitive=new Gi(0,0,un.Triangles),this._isPlaying=!1,this._instanceBufferResized=!1,this._waitProcessRetiredElementCount=0,this._randomSeed=0,this._renderer=i;var t=new lh;t.start=0,this._primitive=new To(i.engine),this._reorganizeGeometryBuffers(),this._resizeInstanceBuffer(!0,n._particleIncreaseCount),this.emission.enabled=!0}var s=n.prototype;return s.play=function(t){if(t===void 0&&(t=!0),t)for(var e=this._renderer.entity.getComponentsIncludeChildren($t,n._tempParticleRenderers),r=0,a=e.length;r<a;r++){var o=e[r];o.generator.play(!1)}else this._isPlaying=!0,this.useAutoRandomSeed&&this._resetGlobalRandSeed(Math.floor(Math.random()*4294967295))},s.stop=function(t,e){if(t===void 0&&(t=!0),e===void 0&&(e=va.StopEmitting),t)for(var r=this._renderer.entity.getComponentsIncludeChildren($t,n._tempParticleRenderers),a=0,o=r.length;a<o;a++){var c=r[a];c.generator.stop(!1,e)}else if(this._isPlaying=!1,e===va.StopEmittingAndClear){var l=this._firstFreeElement;this._firstRetiredElement=l,this._firstActiveElement=l,this._firstNewElement=l,this._playTime=0,this.emission._reset()}},s.emit=function(t){this._emit(this._playTime,t)},s._emit=function(t,e){if(this.emission.enabled){if(this.main._maxParticleBuffer<this._currentParticleCount)return;for(var r=n._tempVector30,a=n._tempVector31,o=this._renderer.entity.transform,c=this.emission.shape,l=0;l<e;l++){var _;if((_=c)!=null&&_.enabled){c._generatePositionAndDirection(this.emission._shapeRand,t,r,a);var u=this.main._getPositionScale();r.multiply(u),a.normalize().multiply(u)}else r.set(0,0,0),a.set(0,0,-1);this._addNewParticle(r,a,o,t)}}},s._update=function(t){var e=this,r=e.main,a=e.emission,o=r.duration,c=this._playTime;if(this._playTime+=t*r.simulationSpeed,this._retireActiveParticles(),this._freeRetiredParticles(),a.enabled&&this._isPlaying){if(this._currentParticleCount>r._maxParticleBuffer){var l=this._getNotRetiredParticleCount();l<r._maxParticleBuffer&&this._resizeInstanceBuffer(!1)}a._emit(c,this._playTime),!r.isLoop&&this._playTime>o&&(this._isPlaying=!1)}if(!this.isAlive){var _=Math.min(a._frameRateTime,Math.floor(this._playTime/o)*o);this._playTime-=_,a._frameRateTime-=_}(this._firstNewElement!=this._firstFreeElement||this._waitProcessRetiredElementCount>0||this._instanceBufferResized||this._instanceVertexBufferBinding._buffer.isContentLost)&&this._addActiveParticlesToVertexBuffer()},s._reorganizeGeometryBuffers=function(){var t=this._renderer,e=t.engine._particleBufferUtils,r=this._primitive,a=this._vertexBufferBindings;if(r.clearVertexElements(),a.length=0,t.renderMode===gr.Mesh){var o=t.mesh;if(!o)return;var c=o.getVertexElement(X.Position),l=o.getVertexElement(X.Color),_=o.getVertexElement(X.UV),u=c?o.vertexBufferBindings[c.bindingIndex]:null,h=l?o.vertexBufferBindings[l.bindingIndex]:null,d=_?o.vertexBufferBindings[_.bindingIndex]:null;if(u){var f=this._addVertexBufferBindingsFilterDuplicate(u,a);r.addVertexElement(new Te(X.Position,c.offset,c.format,f))}if(h){var v=this._addVertexBufferBindingsFilterDuplicate(h,a);r.addVertexElement(new Te(X.Color,l.offset,l.format,v))}if(d){var p=this._addVertexBufferBindingsFilterDuplicate(d,a);r.addVertexElement(new Te(X.UV,_.offset,_.format,p))}var g=o._primitive.indexBufferBinding;r.setIndexBufferBinding(g),this._subPrimitive.count=g.buffer.byteLength/r._glIndexByteCount}else r.addVertexElement(e.billboardVertexElement),a.push(e.billboardVertexBufferBinding),r.setIndexBufferBinding(e.billboardIndexBufferBinding),this._subPrimitive.count=e.billboardIndexCount;r.setVertexBufferBindings(a);for(var y=e.instanceVertexElements,m=a.length,x=0,C=y.length;x<C;x++){var b=y[x];r.addVertexElement(new Te(b.attribute,b.offset,b.format,m,b.instanceStepRate))}},s._resizeInstanceBuffer=function(t,e){var r;(r=this._instanceVertexBufferBinding)==null||r.buffer.destroy();var a=this._renderer.engine._particleBufferUtils,o=a.instanceVertexStride,c=t?this._currentParticleCount+e:this.main._maxParticleBuffer,l=o*c,_=this._renderer.engine,u=new Jt(_,Mt.VertexBuffer,l,Je.Dynamic,!1);u.isGCIgnored=!0;var h=this._primitive.vertexBufferBindings,d=new Wn(u,o),f=new Float32Array(l/4),v=this._instanceVertices;if(v){var p=a.instanceVertexFloatStride,g=this._firstFreeElement,y=this._firstRetiredElement;if(t){var m=this._firstFreeElement*p;f.set(new Float32Array(v.buffer,0,m));var x=(this._firstFreeElement+e)*p;f.set(new Float32Array(v.buffer,m*4),x),this._firstNewElement>g&&(this._firstNewElement+=e),this._firstActiveElement>g&&(this._firstActiveElement+=e),y>g&&(this._firstRetiredElement+=e)}else{var C,b;y<=g?(C=g-y,b=0,this._firstFreeElement-=y,this._firstNewElement-=y,this._firstActiveElement-=y,this._firstRetiredElement=0):(C=this._currentParticleCount-y,b=g,this._firstNewElement>g&&(this._firstNewElement-=g),this._firstActiveElement>g&&(this._firstActiveElement-=g),y>g&&(this._firstRetiredElement-=g)),f.set(new Float32Array(v.buffer,y*p*4,C*p),b*p)}this._instanceBufferResized=!0}this._primitive.setVertexBufferBinding(v?h.length-1:h.length,d),this._instanceVertices=f,this._instanceVertexBufferBinding=d,this._currentParticleCount=c},s._updateShaderData=function(t){this.main._updateShaderData(t),this.velocityOverLifetime._updateShaderData(t),this.textureSheetAnimation._updateShaderData(t),this.sizeOverLifetime._updateShaderData(t),this.rotationOverLifetime._updateShaderData(t),this.colorOverLifetime._updateShaderData(t)},s._resetGlobalRandSeed=function(t){this._randomSeed=t,this.main._resetRandomSeed(t),this.emission._resetRandomSeed(t),this.textureSheetAnimation._resetRandomSeed(t),this.velocityOverLifetime._resetRandomSeed(t),this.rotationOverLifetime._resetRandomSeed(t),this.colorOverLifetime._resetRandomSeed(t)},s._getAliveParticleCount=function(){if(this._firstActiveElement<=this._firstFreeElement)return this._firstFreeElement-this._firstActiveElement;var t=this._currentParticleCount-this._firstActiveElement;return this._firstFreeElement>0&&(t+=this._firstFreeElement),t},s._getNotRetiredParticleCount=function(){if(this._firstRetiredElement<=this._firstFreeElement)return this._firstFreeElement-this._firstRetiredElement;var t=this._currentParticleCount-this._firstRetiredElement;return this._firstFreeElement>0&&(t+=this._firstFreeElement),t},s._destroy=function(){this._instanceVertexBufferBinding.buffer.destroy(),this._primitive.destroy()},s._addNewParticle=function(t,e,r,a){var o=this._firstFreeElement,c=o+1;c>=this._currentParticleCount&&(c=0);var l=this.main;if(c===this._firstRetiredElement){var _=Math.min(n._particleIncreaseCount,l._maxParticleBuffer-this._currentParticleCount);if(_===0)return;this._resizeInstanceBuffer(!0,_),c=o+1}var u,h;l.simulationSpace===ln.World&&(u=r.worldPosition,h=r.worldRotationQuaternion);var d=this._renderer.engine._particleBufferUtils,f=l.startSpeed.evaluate(void 0,l._startSpeedRand.random()),v=this._instanceVertices,p=o*d.instanceVertexFloatStride;v[p]=t.x,v[p+1]=t.y,v[p+2]=t.z,v[p+d.startLifeTimeOffset]=l.startLifetime.evaluate(void 0,l._startLifeTimeRand.random()),v[p+4]=e.x,v[p+5]=e.y,v[p+6]=e.z,v[p+d.timeOffset]=a;var g=n._tempColor0;l.startColor.evaluate(void 0,l._startColorRand.random(),g),this._renderer.engine.settings.colorSpace===or.Linear&&g.toLinear(g),v[p+8]=g.r,v[p+9]=g.g,v[p+10]=g.b,v[p+11]=g.a;var y=l._startSizeRand;if(l.startSize3D)v[p+12]=l.startSizeX.evaluate(void 0,y.random()),v[p+13]=l.startSizeY.evaluate(void 0,y.random()),v[p+14]=l.startSizeZ.evaluate(void 0,y.random());else{var m=l.startSize.evaluate(void 0,y.random());v[p+12]=m,v[p+13]=m,v[p+14]=m}var x=l._startRotationRand;l.startRotation3D?(v[p+15]=k.degreeToRadian(l.startRotationX.evaluate(void 0,x.random())),v[p+16]=k.degreeToRadian(l.startRotationY.evaluate(void 0,x.random())),v[p+17]=k.degreeToRadian(l.startRotationZ.evaluate(void 0,x.random()))):v[p+15]=k.degreeToRadian(l.startRotationZ.evaluate(void 0,x.random())),v[p+18]=f;var C=this.colorOverLifetime;C.enabled&&C.color.mode===Xt.TwoGradients&&(v[p+20]=C._colorGradientRand.random());var b=this.rotationOverLifetime;b.enabled&&b.rotationZ.mode===he.TwoConstants&&(v[p+22]=b._rotationRand.random());var A=this.textureSheetAnimation;A.enabled&&A.frameOverTime.mode===he.TwoCurves&&(v[p+23]=A._frameOverTimeRand.random());var S=this.velocityOverLifetime;if(S.enabled&&S.velocityX.mode===he.TwoConstants&&S.velocityY.mode===he.TwoConstants&&S.velocityZ.mode===he.TwoConstants){var w=S._velocityRand;v[p+24]=w.random(),v[p+25]=w.random(),v[p+26]=w.random()}if(this.main.simulationSpace===ln.World&&(v[p+27]=u.x,v[p+28]=u.y,v[p+29]=u.z,v[p+30]=h.x,v[p+31]=h.y,v[p+32]=h.z,v[p+33]=h.w),this.textureSheetAnimation.enabled){var E=this.textureSheetAnimation._tillingInfo;v[p+d.simulationUVOffset]=E.x,v[p+35]=E.y,v[p+36]=0,v[p+37]=0}else v[p+d.simulationUVOffset]=1,v[p+35]=1,v[p+36]=0,v[p+37]=0;this._firstFreeElement=c},s._retireActiveParticles=function(){for(var t=this._renderer.engine,e=t._particleBufferUtils,r=t.time.frameCount,a=this._instanceVertices;this._firstActiveElement!==this._firstNewElement;){var o=this._firstActiveElement*e.instanceVertexFloatStride,c=o+e.timeOffset,l=this._playTime-a[c];if(Math.fround(l)<a[o+e.startLifeTimeOffset])break;a[c]=r,++this._firstActiveElement>=this._currentParticleCount&&(this._firstActiveElement=0),this._waitProcessRetiredElementCount++}},s._freeRetiredParticles=function(){for(var t=this._renderer.engine._particleBufferUtils,e=this._renderer.engine.time.frameCount;this._firstRetiredElement!==this._firstActiveElement;){var r=this._firstRetiredElement*t.instanceVertexFloatStride+t.startLifeTimeOffset,a=e-this._instanceVertices[r];if(a<0)break;++this._firstRetiredElement>=this._currentParticleCount&&(this._firstRetiredElement=0)}},s._addActiveParticlesToVertexBuffer=function(){var t=this._firstActiveElement,e=this._firstFreeElement;if(t!==e){var r=this._renderer.engine._particleBufferUtils.instanceVertexStride,a=t*r,o=this._instanceVertexBufferBinding.buffer,c=this._instanceVertices.buffer;if(t<e)o.setData(c,0,a,(e-t)*r,_n.Discard);else{var l=(this._currentParticleCount-t)*r;o.setData(c,0,a,l,_n.Discard),e>0&&o.setData(c,l,0,e*r)}this._firstNewElement=e,this._waitProcessRetiredElementCount=0,this._instanceBufferResized=!1}},s._addVertexBufferBindingsFilterDuplicate=function(t,e){for(var r=0,a=e.length;r<a;r++)if(e[r]===t)return r;return e.push(t),r},j(n,[{key:"isAlive",get:function(){return this._isPlaying?!0:this._firstActiveElement!==this._firstFreeElement}},{key:"randomSeed",get:function(){return this._randomSeed},set:function(t){this._resetGlobalRandSeed(t),this.useAutoRandomSeed=!1}}]),n}();(function(){Ne._tempVector30=new R})();(function(){Ne._tempVector31=new R})();(function(){Ne._tempColor0=new q})();(function(){Ne._tempParticleRenderers=new Array})();(function(){Ne._particleIncreaseCount=128})();T([J],Ne.prototype,"main",void 0);T([J],Ne.prototype,"emission",void 0);T([J],Ne.prototype,"velocityOverLifetime",void 0);T([J],Ne.prototype,"sizeOverLifetime",void 0);T([J],Ne.prototype,"rotationOverLifetime",void 0);T([J],Ne.prototype,"colorOverLifetime",void 0);T([J],Ne.prototype,"textureSheetAnimation",void 0);T([F],Ne.prototype,"_playTime",void 0);T([F],Ne.prototype,"_firstNewElement",void 0);T([F],Ne.prototype,"_firstActiveElement",void 0);T([F],Ne.prototype,"_firstFreeElement",void 0);T([F],Ne.prototype,"_firstRetiredElement",void 0);T([F],Ne.prototype,"_primitive",void 0);T([F],Ne.prototype,"_vertexBufferBindings",void 0);T([F],Ne.prototype,"_subPrimitive",void 0);T([F],Ne.prototype,"_renderer",void 0);T([F],Ne.prototype,"_isPlaying",void 0);T([F],Ne.prototype,"_instanceBufferResized",void 0);T([F],Ne.prototype,"_waitProcessRetiredElementCount",void 0);T([F],Ne.prototype,"_instanceVertexBufferBinding",void 0);T([F],Ne.prototype,"_instanceVertices",void 0);var _h=function(n){W(s,n);function s(t){var e;e=n.call(this,t,Se.find("particle-shader"))||this;var r=e.shaderData;return r.setColor(We._baseColorProp,new q(1,1,1,1)),e.isTransparent=!0,e}var i=s.prototype;return i.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},j(s,[{key:"baseColor",get:function(){return this.shaderData.getColor(We._baseColorProp)},set:function(e){var r=this.shaderData.getColor(We._baseColorProp);e!==r&&r.copyFrom(e)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(We._baseTextureProp)},set:function(e){this.shaderData.setTexture(We._baseTextureProp,e),e?this.shaderData.enableMacro(We._baseTextureMacro):this.shaderData.disableMacro(We._baseTextureMacro)}}]),s}(We),jc=function(s,i){this.time=s,this.count=i};T([J],jc.prototype,"count",void 0);var Xa=function(){function n(){this.enabled=!0,this.randomDirectionAmount=0}var s=n.prototype;return s._generatePositionAndDirection=function(t,e,r,a){throw new Error("BaseShape: must override it.")},n}(),Cr=function(){function n(){}return n.randomPointUnitArcCircle=function(i,t,e){var r=e.random()*i;t.x=Math.cos(r),t.y=Math.sin(r)},n.randomPointInsideUnitArcCircle=function(i,t,e){n.randomPointUnitArcCircle(i,t,e);var r=Math.sqrt(e.random());t.x=t.x*r,t.y=t.y*r},n.randomPointUnitCircle=function(i,t){var e=t.random()*Math.PI*2;i.x=Math.cos(e),i.y=Math.sin(e)},n.randomPointInsideUnitCircle=function(i,t){n.randomPointUnitCircle(i,t);var e=Math.sqrt(t.random());i.x=i.x*e,i.y=i.y*e},n._randomPointUnitSphere=function(i,t){var e=t.random()*2-1,r=t.random()*Math.PI*2,a=Math.sqrt(1-e*e);i.x=a*Math.cos(r),i.y=a*Math.sin(r),i.z=e},n._randomPointInsideUnitSphere=function(i,t){n._randomPointUnitSphere(i,t);var e=Math.pow(t.random(),1/3);i.x=i.x*e,i.y=i.y*e,i.z=i.z*e},n._randomPointInsideHalfUnitBox=function(i,t){t===void 0&&(t=null),i.x=t.random()-.5,i.y=t.random()-.5,i.z=t.random()-.5},n}(),wn;(function(n){n[n.Box=0]="Box",n[n.Circle=1]="Circle",n[n.Cone=2]="Cone",n[n.Hemisphere=3]="Hemisphere",n[n.Sphere=4]="Sphere"})(wn||(wn={}));var zo=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.shapeType=wn.Box,t.size=new R(1,1,1),t}var i=s.prototype;return i._generatePositionAndDirection=function(e,r,a,o){Cr._randomPointInsideHalfUnitBox(a,e),a.multiply(this.size);var c=s._tempVector30;c.set(0,0,-1),Cr._randomPointUnitSphere(o,e),R.lerp(c,o,this.randomDirectionAmount,o)},s}(Xa);(function(){zo._tempVector30=new R})();T([J],zo.prototype,"size",void 0);var aa;(function(n){n[n.Random=0]="Random",n[n.Loop=1]="Loop"})(aa||(aa={}));var qc=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.shapeType=wn.Circle,t.radius=1,t.arc=360,t.arcMode=aa.Random,t.arcSpeed=1,t}var i=s.prototype;return i._generatePositionAndDirection=function(e,r,a,o){var c=s._tempPositionPoint;switch(this.arcMode){case aa.Loop:var l=r*this.arcSpeed*(360/this.arc)%1,_=k.degreeToRadian(this.arc*l);c.set(Math.cos(_),Math.sin(_)),c.scale(e.random());break;case aa.Random:Cr.randomPointInsideUnitArcCircle(k.degreeToRadian(this.arc),c,e);break}a.set(c.x,c.y,0),a.scale(this.radius),Cr._randomPointUnitSphere(o,e),R.lerp(a,o,this.randomDirectionAmount,o)},s}(Xa);(function(){qc._tempPositionPoint=new ee})();var ja=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.shapeType=wn.Cone,t.angle=25,t.radius=1,t.length=5,t.emitType=0,t}var i=s.prototype;return i._generatePositionAndDirection=function(e,r,a,o){var c=s._tempVector20,l=k.degreeToRadian(this.angle),_=Math.sin(l),u=Math.cos(l);switch(this.emitType){case 0:Cr.randomPointInsideUnitCircle(c,e),a.set(c.x*this.radius,c.y*this.radius,0);var h=s._tempVector21;Cr.randomPointInsideUnitCircle(h,e),ee.lerp(c,h,this.randomDirectionAmount,h),o.set(h.x*_,h.y*_,-u);break;case 1:Cr.randomPointInsideUnitCircle(c,e),a.set(c.x*this.radius,c.y*this.radius,0),o.set(c.x*_,c.y*_,-u),o.normalize();var d=s._tempVector30;R.scale(o,this.length*e.random(),d),a.add(d);var f=s._tempVector31;Cr._randomPointUnitSphere(f,e),R.lerp(o,f,this.randomDirectionAmount,o);break}},s}(Xa);(function(){ja._tempVector20=new ee})();(function(){ja._tempVector21=new ee})();(function(){ja._tempVector30=new R})();(function(){ja._tempVector31=new R})();var po;(function(n){n[n.Base=0]="Base",n[n.Volume=1]="Volume"})(po||(po={}));var uh=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.shapeType=wn.Hemisphere,t.radius=1,t}var i=s.prototype;return i._generatePositionAndDirection=function(e,r,a,o){Cr._randomPointInsideUnitSphere(a,e),a.scale(this.radius);var c=a.z;c>0&&(a.z=-c),Cr._randomPointUnitSphere(o,e),R.lerp(a,o,this.randomDirectionAmount,o)},s}(Xa),hh=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.shapeType=wn.Sphere,t.radius=1,t}var i=s.prototype;return i._generatePositionAndDirection=function(e,r,a,o){Cr._randomPointInsideUnitSphere(a,e),a.scale(this.radius),Cr._randomPointUnitSphere(o,e),R.lerp(a,o,this.randomDirectionAmount,o)},s}(Xa),dh=`#define GLSLIFY 1
varying vec2 v_uv;uniform sampler2D u_texture;void main(void){gl_FragColor=texture2D(u_texture,v_uv);}`,fh=`#define GLSLIFY 1
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;uniform mat4 camera_ProjMat;uniform mat4 camera_ViewMat;void main(){gl_Position=camera_ProjMat*camera_ViewMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`;Se.create("trail",fh,dh);var Yc=function(n){W(s,n);function s(i){var t;t=n.call(this,i,Se.find("trail"))||this;var e=t.renderState.blendState.targetBlendState;return e.enabled=!0,e.sourceColorBlendFactor=e.sourceAlphaBlendFactor=be.SourceAlpha,e.destinationColorBlendFactor=e.destinationAlphaBlendFactor=be.One,t.renderState.depthState.writeEnabled=!1,t}return s}(Sr),ds=new R,vh=function(n){W(s,n);function s(t,e){var r;r=n.call(this,t)||this,r._stroke=e.stroke||.2,r._minSeg=e.minSeg||.02,r._lifetime=e.lifetime||1e3,r._maxPointNum=r._lifetime/1e3*t.engine.targetFrameRate,r._points=[],r._pointStates=[],r._strapPoints=[];for(var a=0;a<r._maxPointNum;a++)r._points.push(new R),r._pointStates.push(r._lifetime),r._strapPoints.push(new R),r._strapPoints.push(new R);r._curPointNum=0;var o=e.material||new Yc(r.engine);return r.setMaterial(o),r.setTexture(e.texture),r._initGeometry(),r}var i=s.prototype;return i.update=function(e){for(var r=0,a=0,o=0;o<this._curPointNum;o++)this._pointStates[o]-=e,this._pointStates[o]<0?r++:r>0&&(a=o-r,this._pointStates[a]=this._pointStates[o],this._points[a].copyFrom(this._points[o]));this._curPointNum-=r;var c=!0;if(this._curPointNum===this._maxPointNum)c=!1;else if(this._curPointNum>0){var l=this._points[this._points.length-1];R.distance(this.entity.transform.worldPosition,l)<this._minSeg&&(c=!1)}c&&(this._pointStates[this._curPointNum]=this._lifetime,this._points[this._curPointNum].copyFrom(this.entity.transform.worldPosition),this._curPointNum++)},i.setTexture=function(e){e&&this.getMaterial().shaderData.setTexture("u_texture",e)},i._render=function(e){this._updateStrapVertices(e.camera,this._points),this._updateStrapCoords(),this._vertexBuffer.setData(this._vertices),n.prototype._render.call(this,e)},i._initGeometry=function(){var e=new Po(this._entity.engine),r=20,a=this._maxPointNum*2,o=a*r,c=new Float32Array(o),l=[new Te("POSITION",0,$.Vector3,0),new Te("TEXCOORD_0",12,$.Vector2,0)],_=new Jt(this.engine,o*4,Je.Dynamic);e.setVertexBufferBinding(_,r),e.setVertexElements(l),e.addSubMesh(0,a,un.TriangleStrip),this._vertexBuffer=_,this._vertexStride=r,this._vertices=c,this.mesh=e},i._updateStrapVertices=function(e,r){var a=e.viewMatrix,o=a.elements,c=new R(o[0],o[4],o[8]),l=new R(o[1],o[5],o[9]),_=new R(o[2],o[6],o[10]),u=this._stroke;l.scale(u);var h=new R,d=new R,f=new Re;R.transformByQuat(c,f,c),R.transformByQuat(l,f,l);var v=new R,p=new R,g=new R;c.normalize();for(var y=this._vertices,m=0;m<this._maxPointNum;m++){if(m<this._curPointNum){var x=r[m];m===this._curPointNum-1&&m!==0?R.subtract(x,r[m-1],g):R.subtract(r[m+1],x,g),this._projectOnPlane(g,_,g),g.normalize();var C=Math.acos(R.dot(c,g));R.cross(c,g,p),R.dot(p,_)<=0&&(C=Math.PI*2-C),Re.rotationAxisAngle(_,C,f),R.transformByQuat(l,f,v),R.add(x,v,h),R.subtract(x,v,d)}var b=m*2*this._vertexStride/4,A=(m*2+1)*this._vertexStride/4;y[b]=h.x,y[b+1]=h.y,y[b+2]=h.z,y[A]=d.x,y[A+1]=d.y,y[A+2]=d.z}},i._updateStrapCoords=function(){if(this._prePointsNum!==this._curPointNum){this._prePointsNum=this._curPointNum;for(var e=this._curPointNum,r=1/e,a=this._vertices,o=0;o<e;o++){var c=1-o*r,l=o*2*this._vertexStride/4,_=(o*2+1)*this._vertexStride/4;a[l]=0,a[l+1]=c,a[_]=1,a[_+1]=c}}},i._projectOnVector=function(e,r,a){var o=r.clone();R.normalize(o,o);var c=R.dot(e,o);a.x=o.x*c,a.y=o.y*c,a.z=o.z*c},i._projectOnPlane=function(e,r,a){this._projectOnVector(e,r,ds),R.subtract(e,ds,a)},s}(Ir),Qc=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.probeLayer=An.Everything,t.width=1024,t.height=1024,t.antiAliasing=1,t._isCube=!1,t}var i=s.prototype;return i.onTextureChange=function(e){},i.onBeginRender=function(e){this.enabled&&(this._camera=e,this._oriCameraCullingMask=e.cullingMask,e.cullingMask=this.probeLayer,(!this._activeRenderTarget||this._activeRenderTarget.width!==this.width||this._activeRenderTarget.height!==this.height||this._activeRenderTarget.antiAliasing!==this.antiAliasing)&&(this._renderTarget=new Da(this.engine,this.width,this.height,this._isCube?new jt(this.engine,this.width):new Tt(this.engine,this.width,this.height),Ba.Depth,this.antiAliasing),this._renderTargetSwap=new Da(this.engine,this.width,this.height,this._isCube?new jt(this.engine,this.width):new Tt(this.engine,this.width,this.height),Ba.Depth,this.antiAliasing),this._activeRenderTarget=this._renderTarget),this._oriCameraRenderTarget=e.renderTarget,e.renderTarget=this._activeRenderTarget)},i.onEndRender=function(e){this.enabled&&(this.onTextureChange&&this.onTextureChange(this._texture),this._activeRenderTarget=this._activeRenderTarget===this._renderTarget?this._renderTargetSwap:this._renderTarget)},i._reset=function(){this.enabled&&(this._camera.renderTarget=this._oriCameraRenderTarget,this._camera.cullingMask=this._oriCameraCullingMask)},j(s,[{key:"_texture",get:function(){var e;return(e=this._activeRenderTarget)==null?void 0:e.getColorTexture()}}]),s}(zr),fs=new R,Ln=new R,Vn=new R,ph=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.position=new R(0,0,0),t._isCube=!0,t.oriViewMatrix=new Z,t}var i=s.prototype;return i.onBeginRender=function(e){if(this.enabled){n.prototype.onBeginRender.call(this,e),this._storeCamera(e);for(var r=0;r<6;r++)this._setCamera(r,e),e.render(wr.PositiveX+r);this._restoreCamera(e),n.prototype._reset.call(this)}},i._storeCamera=function(e){this.oriViewMatrix.copyFrom(e.viewMatrix),this._oriFieldOfView=e.fieldOfView},i._restoreCamera=function(e){e.viewMatrix.copyFrom(this.oriViewMatrix),e.fieldOfView=this._oriFieldOfView},i._setCamera=function(e,r){switch(e){case 0:Ln.set(0,-1,0),Vn.set(1,0,0);break;case 1:Ln.set(0,-1,0),Vn.set(-1,0,0);break;case 2:Ln.set(0,0,1),Vn.set(0,1,0);break;case 3:Ln.set(0,0,-1),Vn.set(0,-1,0);break;case 4:Ln.set(0,-1,0),Vn.set(0,0,1);break;case 5:Ln.set(0,-1,0),Vn.set(0,0,-1);break}R.add(this.position,Vn,fs),Z.lookAt(this.position,fs,Ln,r.viewMatrix),r.fieldOfView=90},s}(Qc);const vs=Object.freeze(Object.defineProperty({__proto__:null,AmbientLight:Tr,get AnimationArrayCurve(){return Ci},get AnimationBoolCurve(){return Ai},AnimationClip:Vo,AnimationClipCurveBinding:Wc,get AnimationColorCurve(){return Ei},AnimationCurve:_r,AnimationEvent:ji,get AnimationFloatArrayCurve(){return Na},get AnimationFloatCurve(){return wi},get AnimationQuaternionCurve(){return fa},get AnimationRectCurve(){return uo},get AnimationRefCurve(){return Mi},get AnimationStringCurve(){return Pi},get AnimationVector2Curve(){return Ti},get AnimationVector3Curve(){return Ia},get AnimationVector4Curve(){return Ri},Animator:Kr,get AnimatorConditionMode(){return fo},AnimatorController:No,AnimatorControllerLayer:Io,get AnimatorCullingMode(){return Oa},get AnimatorLayerBlendingMode(){return za},AnimatorLayerMask:ch,AnimatorState:Xc,AnimatorStateMachine:Oo,AnimatorStateTransition:Fo,AssetPromise:Pe,get AssetType(){return Ve},Background:Uc,get BackgroundMode(){return cn},get BackgroundTextureFillMode(){return bn},BaseMaterial:We,Basic2DBatcher:Lr,BasicRenderPipeline:Hc,get BlendFactor(){return be},get BlendMode(){return On},get BlendOperation(){return It},BlendShape:Mo,BlendShapeFrame:Rc,BlendState:Ui,BlinnPhongMaterial:Ga,BoolUpdateFlag:zi,BoxColliderShape:Fc,BoxShape:zo,Buffer:Jt,get BufferBindFlag(){return Mt},BufferMesh:Po,get BufferUsage(){return Je},BufferUtil:pi,Burst:jc,get Camera(){return ze},get CameraClearFlags(){return zt},get CameraType(){return Fa},Canvas:zc,CapsuleColliderShape:Wi,CharacterController:iu,CircleShape:qc,CloneManager:Ar,get Collider(){return Zt},ColliderShape:er,get ColliderShapeUpAxis(){return xi},get CollisionDetectionMode(){return so},ColorOverLifetimeModule:ur,get ColorSpace(){return or},get ColorWriteMask(){return yr},get CompareFunction(){return Ee},Component:Rt,get ConeEmitType(){return po},ConeShape:ja,ContentRestorer:br,get ControllerCollisionFlag(){return lo},get ControllerNonWalkableMode(){return yi},CubeProbe:ph,get CullMode(){return qt},CurveKey:Hr,get DataType(){return Ie},get DependentMode(){return Hn},DepthState:Ec,get DepthTextureMode(){return Va},get DiffuseMode(){return Xn},DirectLight:jn,get Downsampling(){return da},DynamicCollider:Ht,get DynamicColliderConstraints(){return co},EmissionModule:Pn,Engine:hn,EngineObject:Yr,Entity:Yt,EventDispatcher:wo,FixedJoint:su,get FogMode(){return bi},Font:_a,get FontStyle(){return xn},get GLCapabilityType(){return K},GradientAlphaKey:Di,GradientColorKey:Bi,HemisphereShape:uh,HingeJoint:ga,HitResult:Lc,IndexBufferBinding:Pa,get IndexFormat(){return St},InputManager:Ic,get InterpolationType(){return xt},get Joint(){return Vr},JointLimits:lu,JointMotor:_u,Keyframe:Ft,get Keys(){return na},get Layer(){return An},Light:Ha,Loader:Be,Logger:ve,get MSAASamples(){return Si},MainModule:De,Material:Sr,Mesh:Ro,MeshRenderer:Ir,get MeshTopology(){return un},ModelMesh:dt,get OverflowMode(){return Gn},PBRBaseMaterial:Or,PBRMaterial:Xr,PBRSpecularMaterial:qn,ParticleCompositeCurve:Oe,ParticleCompositeGradient:Kn,ParticleCurve:kn,get ParticleCurveMode(){return he},ParticleGenerator:Ne,ParticleGradient:En,get ParticleGradientMode(){return Xt},ParticleMaterial:_h,get ParticleRenderMode(){return gr},ParticleRenderer:$t,get ParticleScaleMode(){return kr},get ParticleShapeArcMode(){return aa},get ParticleShapeType(){return wn},get ParticleSimulationSpace(){return ln},get ParticleStopMode(){return va},PhysicsMaterial:Vc,get PhysicsMaterialCombineMode(){return La},PhysicsScene:Gt,get PipelineStage(){return Ot},PlaneColliderShape:uu,get Platform(){return Nt},PointLight:Yn,Pointer:Dc,get PointerButton(){return ra},get PointerPhase(){return ar},Primitive:To,PrimitiveMesh:at,Probe:Qc,RasterState:wc,ReferResource:Qr,get RenderBufferDepthFormat(){return Ba},get RenderFace(){return an},RenderQueue:rn,get RenderQueueType(){return ft},RenderState:qr,get RenderStateDataKey(){return re},RenderTarget:Da,RenderTargetBlendState:Ac,get Renderer(){return ye},ResourceManager:ua,RotationOverLifetimeModule:Ze,Scene:Wa,SceneManager:Bc,Script:zr,get SetDataOptions(){return _n},Shader:Se,ShaderData:Nr,ShaderFactory:tn,ShaderLib:Ca,ShaderMacro:oe,ShaderMacroCollection:Kt,ShaderPass:vt,ShaderProperty:O,get ShaderPropertyType(){return Vt},ShaderTagKey:sn,get ShadowCascadesMode(){return pr},get ShadowResolution(){return Sn},get ShadowType(){return dn},SizeOverLifetimeModule:Et,Skin:Mn,SkinnedMeshRenderer:Dt,Sky:ha,SkyBoxMaterial:ma,SkyProceduralMaterial:vn,SphereColliderShape:Nc,SphereShape:hh,SpotLight:Fr,SpringJoint:cu,Sprite:vi,SpriteAtlas:bc,get SpriteDrawMode(){return fr},SpriteMask:Pt,get SpriteMaskInteraction(){return ct},get SpriteMaskLayer(){return sa},SpriteRenderer:mt,get SpriteTileMode(){return Ra},StateMachineScript:ho,StaticCollider:ou,get StencilOperation(){return ke},StencilState:Tc,SubMesh:Gi,SubShader:hi,get SunMode(){return vo},SystemInfo:jr,get TextHorizontalAlignment(){return Nn},TextRenderer:rt,TextUtils:sr,get TextVerticalAlignment(){return In},Texture:Wr,Texture2D:Tt,Texture2DArray:Bo,get TextureCoordinate(){return Cn},TextureCube:jt,get TextureCubeFace(){return wr},get TextureDepthCompareFunction(){return vr},get TextureFilterMode(){return tt},get TextureFormat(){return G},TextureSheetAnimationModule:tr,get TextureUsage(){return la},get TextureWrapMode(){return gt},Time:Oi,TrailMaterial:Yc,TrailRenderer:vh,Transform:ge,UnlitMaterial:Pc,Utils:Ue,VelocityOverLifetimeModule:nt,get VertexAttribute(){return X},VertexBufferBinding:Wn,VertexElement:Te,get VertexElementFormat(){return $},get WrapMode(){return Ua},XRManager:Oc,assignmentClone:Me,deepClone:J,dependentComponents:ka,ignoreClone:F,request:Qn,resourceLoader:Xe,shallowClone:Eo},Symbol.toStringTag,{value:"Module"}));var _e;(function(n){n[n.RGBA_ASTC_4X4_KHR=37808]="RGBA_ASTC_4X4_KHR",n[n.RGBA_ASTC_5X4_KHR=37809]="RGBA_ASTC_5X4_KHR",n[n.RGBA_ASTC_5X5_KHR=37810]="RGBA_ASTC_5X5_KHR",n[n.RGBA_ASTC_6X5_KHR=37811]="RGBA_ASTC_6X5_KHR",n[n.RGBA_ASTC_6X6_KHR=37812]="RGBA_ASTC_6X6_KHR",n[n.RGBA_ASTC_8X5_KHR=37813]="RGBA_ASTC_8X5_KHR",n[n.RGBA_ASTC_8X6_KHR=37814]="RGBA_ASTC_8X6_KHR",n[n.RGBA_ASTC_8X8_KHR=37815]="RGBA_ASTC_8X8_KHR",n[n.RGBA_ASTC_10X5_KHR=37816]="RGBA_ASTC_10X5_KHR",n[n.RGBA_ASTC_10X6_KHR=37817]="RGBA_ASTC_10X6_KHR",n[n.RGBA_ASTC_10X8_KHR=37818]="RGBA_ASTC_10X8_KHR",n[n.RGBA_ASTC_10X10_KHR=37819]="RGBA_ASTC_10X10_KHR",n[n.RGBA_ASTC_12X10_KHR=37820]="RGBA_ASTC_12X10_KHR",n[n.RGBA_ASTC_12X12_KHR=37821]="RGBA_ASTC_12X12_KHR",n[n.SRGB8_ALPHA8_ASTC_4X4_KHR=37840]="SRGB8_ALPHA8_ASTC_4X4_KHR",n[n.SRGB8_ALPHA8_ASTC_5X4_KHR=37841]="SRGB8_ALPHA8_ASTC_5X4_KHR",n[n.SRGB8_ALPHA8_ASTC_5X5_KHR=37842]="SRGB8_ALPHA8_ASTC_5X5_KHR",n[n.SRGB8_ALPHA8_ASTC_6X5_KHR=37843]="SRGB8_ALPHA8_ASTC_6X5_KHR",n[n.SRGB8_ALPHA8_ASTC_6X6_KHR=37844]="SRGB8_ALPHA8_ASTC_6X6_KHR",n[n.SRGB8_ALPHA8_ASTC_8X5_KHR=37845]="SRGB8_ALPHA8_ASTC_8X5_KHR",n[n.SRGB8_ALPHA8_ASTC_8X6_KHR=37846]="SRGB8_ALPHA8_ASTC_8X6_KHR",n[n.SRGB8_ALPHA8_ASTC_8X8_KHR=37847]="SRGB8_ALPHA8_ASTC_8X8_KHR",n[n.SRGB8_ALPHA8_ASTC_10X5_KHR=37848]="SRGB8_ALPHA8_ASTC_10X5_KHR",n[n.SRGB8_ALPHA8_ASTC_10X6_KHR=37849]="SRGB8_ALPHA8_ASTC_10X6_KHR",n[n.SRGB8_ALPHA8_ASTC_10X8_KHR=37850]="SRGB8_ALPHA8_ASTC_10X8_KHR",n[n.SRGB8_ALPHA8_ASTC_10X10_KHR=37851]="SRGB8_ALPHA8_ASTC_10X10_KHR",n[n.SRGB8_ALPHA8_ASTC_12X10_KHR=37852]="SRGB8_ALPHA8_ASTC_12X10_KHR",n[n.SRGB8_ALPHA8_ASTC_12X12_KHR=37853]="SRGB8_ALPHA8_ASTC_12X12_KHR",n[n.RGB_ETC1_WEBGL=36196]="RGB_ETC1_WEBGL",n[n.R11_EAC=37488]="R11_EAC",n[n.SIGNED_R11_EAC=37489]="SIGNED_R11_EAC",n[n.RG11_EAC=37490]="RG11_EAC",n[n.SIGNED_RG11_EAC=37491]="SIGNED_RG11_EAC",n[n.RGB8_ETC2=37492]="RGB8_ETC2",n[n.SRGB8_ETC2=37493]="SRGB8_ETC2",n[n.RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="RGB8_PUNCHTHROUGH_ALPHA1_ETC2",n[n.SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",n[n.RGBA8_ETC2_EAC=37496]="RGBA8_ETC2_EAC",n[n.SRGB8_ALPHA8_ETC2_EAC=37497]="SRGB8_ALPHA8_ETC2_EAC",n[n.RGB_PVRTC_4BPPV1_IMG=35840]="RGB_PVRTC_4BPPV1_IMG",n[n.RGB_PVRTC_2BPPV1_IMG=35841]="RGB_PVRTC_2BPPV1_IMG",n[n.RGBA_PVRTC_4BPPV1_IMG=35842]="RGBA_PVRTC_4BPPV1_IMG",n[n.RGBA_PVRTC_2BPPV1_IMG=35843]="RGBA_PVRTC_2BPPV1_IMG",n[n.RGB_S3TC_DXT1_EXT=33776]="RGB_S3TC_DXT1_EXT",n[n.RGBA_S3TC_DXT1_EXT=33777]="RGBA_S3TC_DXT1_EXT",n[n.RGBA_S3TC_DXT3_EXT=33778]="RGBA_S3TC_DXT3_EXT",n[n.RGBA_S3TC_DXT5_EXT=33779]="RGBA_S3TC_DXT5_EXT",n[n.RGBA_BPTC_UNORM_EXT=36492]="RGBA_BPTC_UNORM_EXT",n[n.SRGB_ALPHA_BPTC_UNORM_EXT=36493]="SRGB_ALPHA_BPTC_UNORM_EXT",n[n.RGB_BPTC_SIGNED_FLOAT_EXT=36494]="RGB_BPTC_SIGNED_FLOAT_EXT",n[n.RGB_BPTC_UNSIGNED_FLOAT_EXT=36495]="RGB_BPTC_UNSIGNED_FLOAT_EXT"})(_e||(_e={}));function gh(n,s){for(var i=0;i<s.length;i++){var t=s[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function qa(n,s,i){return s&&gh(n.prototype,s),n}function go(n,s){return go=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},go(n,s)}function Ya(n,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(s&&s.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),s&&go(n,s)}function ir(n,s){return s!=null&&typeof Symbol<"u"&&s[Symbol.hasInstance]?!!s[Symbol.hasInstance](n):n instanceof s}var mh=function(n){Ya(s,n);function s(t){var e;e=n.call(this)||this,e._scale=new ee;var r=t.width,a=t.height;return e._webCanvas=t,e.width=r,e.height=a,e}var i=s.prototype;return i.resizeByClientSize=function(e){e===void 0&&(e=window.devicePixelRatio);var r=this._webCanvas;if(typeof OffscreenCanvas>"u"||!ir(r,OffscreenCanvas)){var a=r.clientWidth*e,o=r.clientHeight*e;this.width=a,this.height=o}},i.setScale=function(e,r){this._scale.set(e,r),this.scale=this._scale},i._onWidthChanged=function(e){this._webCanvas.width=e},i._onHeightChange=function(e){this._webCanvas.height=e},qa(s,[{key:"scale",get:function(){var e=this._webCanvas;return(typeof OffscreenCanvas>"u"||!ir(e,OffscreenCanvas))&&this._scale.set(e.clientWidth*devicePixelRatio/e.width,e.clientHeight*devicePixelRatio/e.height),this._scale},set:function(e){var r=this._webCanvas;(typeof OffscreenCanvas>"u"||!ir(r,OffscreenCanvas))&&(r.style.transformOrigin="left top",r.style.transform="scale("+e.x+", "+e.y+")")}}]),s}(zc),od=function(n){Ya(s,n);function s(){return n.apply(this,arguments)}return s.create=function(t){var e=t.canvas,r=new mh(typeof e=="string"?document.getElementById(e):e),a=new Rh(t.graphicDeviceOptions),o=new s(r,a,t),c=o._initialize(t);return c.then(function(){return o.sceneManager.addScene(new Wa(o,"DefaultScene")),o})},qa(s,[{key:"canvas",get:function(){return this._canvas}}]),s}(hn);function Li(){return Li=Object.assign||function(s){for(var i=1;i<arguments.length;i++){var t=arguments[i];for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(s[e]=t[e])}return s},Li.apply(this,arguments)}var yh=function(){function n(i,t,e,r,a){r===void 0&&(r=Je.Static);var o=i.gl,c=o.createBuffer(),l=this._getGLBufferUsage(o,r),_=t===Mt.VertexBuffer?o.ARRAY_BUFFER:o.ELEMENT_ARRAY_BUFFER;this._gl=o,this._glBuffer=c,this._glBufferUsage=l,this._glBindTarget=_,this._isWebGL2=i.isWebGL2,this.bind(),a?o.bufferData(_,a,l):o.bufferData(_,e,l),o.bindBuffer(_,null)}var s=n.prototype;return s.bind=function(){this._gl.bindBuffer(this._glBindTarget,this._glBuffer)},s.setData=function(t,e,r,a,o,c){var l=this._gl,_=this._glBindTarget;this.bind(),c===_n.Discard&&l.bufferData(_,t,this._glBufferUsage);var u=e.BYTES_PER_ELEMENT||1,h=o?u*o:e.byteLength;if(a!==0||h<e.byteLength){var d=e.byteOffset!==void 0;if(this._isWebGL2&&d)l.bufferSubData(_,r,e,a,h/u);else{var f=new Uint8Array(d?e.buffer:e,a*u,h);l.bufferSubData(_,r,f)}}else l.bufferSubData(_,r,e);l.bindBuffer(_,null)},s.getData=function(t,e,r,a){if(this._isWebGL2){var o=this._gl;this.bind(),o.getBufferSubData(this._glBindTarget,e,t,r,a)}else throw"Buffer is write-only on WebGL1.0 platforms."},s.destroy=function(){this._gl.deleteBuffer(this._glBuffer),this._gl=null,this._glBuffer=null},s._getGLBufferUsage=function(t,e){switch(e){case Je.Static:return t.STATIC_DRAW;case Je.Dynamic:return t.DYNAMIC_DRAW;case Je.Stream:return t.STREAM_DRAW}},n}(),xh=function(){function n(i){this._rhi=i,this.capabilityList=new Map,this._init(),this._compatibleAllInterface()}var s=n.prototype;return s.canIUse=function(t){return this.capabilityList.get(t)},s.canIUseCompressedTextureInternalFormat=function(t){var e=_e.RGBA_ASTC_4X4_KHR,r=_e.RGBA_ASTC_12X12_KHR,a=_e.SRGB8_ALPHA8_ASTC_4X4_KHR,o=_e.SRGB8_ALPHA8_ASTC_12X12_KHR,c=_e.RGB_ETC1_WEBGL,l=_e.R11_EAC,_=_e.SRGB8_ALPHA8_ETC2_EAC,u=_e.RGB_PVRTC_4BPPV1_IMG,h=_e.RGBA_PVRTC_2BPPV1_IMG,d=_e.RGB_S3TC_DXT1_EXT,f=_e.RGBA_S3TC_DXT5_EXT,v=_e.RGBA_BPTC_UNORM_EXT,p=_e.RGB_BPTC_UNSIGNED_FLOAT_EXT;return t>=e&&r<=r||t>=a&&t<=o?this.canIUse(K.astc):t===c?this.canIUse(K.etc1):t>=l&&t<=_?this.canIUse(K.etc):t>=u&&t<=h?this.canIUse(K.pvrtc):t>=d&&t<=f?this.canIUse(K.s3tc):t>=v&&t<=p?this.canIUse(K.bptc):!1},s._init=function(){var t=this.capabilityList,e=this.rhi.isWebGL2,r=this.rhi.requireExtension.bind(this.rhi),a=K.shaderVertexID,o=K.standardDerivatives,c=K.shaderTextureLod,l=K.elementIndexUint,_=K.depthTexture,u=K.vertexArrayObject,h=K.instancedArrays,d=K.multipleSample,f=K.drawBuffers,v=K.blendMinMax,p=K.astc,g=K.astc_webkit,y=K.etc,m=K.etc_webkit,x=K.etc1,C=K.etc1_webkit,b=K.pvrtc,A=K.pvrtc_webkit,S=K.s3tc,w=K.s3tc_webkit,E=K.bptc,P=K.textureFloat,M=K.textureHalfFloat,D=K.textureFloatLinear,L=K.textureHalfFloatLinear,V=K.WEBGL_colorBufferFloat,N=K.colorBufferFloat,I=K.colorBufferHalfFloat,B=K.textureFilterAnisotropic,z=K.fragDepth;t.set(a,e),t.set(o,e||!!r(o)),t.set(c,e||!!r(c)),t.set(l,e||!!r(l)),t.set(_,e||!!r(_)),t.set(u,e||!!r(u)),t.set(h,e||!!r(h)),t.set(d,e),t.set(f,e||!!r(f)),t.set(v,e||!!r(v)),t.set(P,e||!!r(P)),t.set(M,e||!!r(M)),t.set(D,!!r(D)),t.set(L,e||!!r(L)),t.set(N,e&&!!r(N)||!!r(V)),t.set(I,e&&!!r(N)||!!r(I)),t.set(B,!!r(B)),t.set(z,e||!!r(z)),t.set(p,!!(r(p)||r(g))),t.set(y,!!(r(y)||r(m))),t.set(x,!!(r(x)||r(C))),t.set(b,!!(r(b)||r(A))),t.set(S,!!(r(S)||r(w))),t.set(E,!!r(E))},s._compatibleInterface=function(t,e){var r=this.rhi,a=r.gl,o=null;if(o=r.requireExtension(t))for(var c in e){var l,_=e[c],u=o[_];(l=u)!=null&&l.bind?a[c]=u.bind(o):a[c]=u}},s._compatibleAllInterface=function(){var t=K.depthTexture,e=K.vertexArrayObject,r=K.instancedArrays,a=K.drawBuffers,o=K.textureFilterAnisotropic,c=K.textureHalfFloat,l=K.colorBufferHalfFloat,_=K.WEBGL_colorBufferFloat,u=K.blendMinMax,h=this.rhi.isWebGL2;if(!h){this._compatibleInterface(u,{MIN:"MIN_EXT",MAX:"MAX_EXT"}),this._compatibleInterface(t,{UNSIGNED_INT_24_8:"UNSIGNED_INT_24_8_WEBGL"}),this._compatibleInterface(e,{createVertexArray:"createVertexArrayOES",deleteVertexArray:"deleteVertexArrayOES",isVertexArray:"isVertexArrayOES",bindVertexArray:"bindVertexArrayOES"}),this._compatibleInterface(r,{drawArraysInstanced:"drawArraysInstancedANGLE",drawElementsInstanced:"drawElementsInstancedANGLE",vertexAttribDivisor:"vertexAttribDivisorANGLE"}),this._compatibleInterface(a,{MAX_DRAW_BUFFERS:"MAX_DRAW_BUFFERS_WEBGL"});var d={};if(this.canIUse(K.drawBuffers)){for(var f=this.maxDrawBuffers,v=0;v<f;v++)v!=0&&(d["COLOR_ATTACHMENT"+v]="COLOR_ATTACHMENT"+v+"_WEBGL"),d["DRAW_BUFFER"+v]="DRAW_BUFFER"+v+"_WEBGL";this._compatibleInterface(a,Li({drawBuffers:"drawBuffersWEBGL"},d))}this._compatibleInterface(c,{HALF_FLOAT:"HALF_FLOAT_OES"}),this._compatibleInterface(l,{RGBA16F:"RBGA16F_EXT"}),this._compatibleInterface(_,{RGBA32F:"RBGA32F_EXT"})}this._compatibleInterface(o,{TEXTURE_MAX_ANISOTROPY_EXT:"TEXTURE_MAX_ANISOTROPY_EXT"})},qa(n,[{key:"maxTextureSize",get:function(){return this.rhi.renderStates.getParameter(this.rhi.gl.MAX_TEXTURE_SIZE)}},{key:"canUseFloatTextureBlendShape",get:function(){return this.canIUse(K.shaderVertexID)&&this.canIUse(K.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}},{key:"canIUseMoreJoints",get:function(){return this.canIUse(K.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}},{key:"maxDrawBuffers",get:function(){return this._maxDrawBuffers||(this.canIUse(K.drawBuffers)?this._maxDrawBuffers=this._rhi.gl.getParameter(this._rhi.gl.MAX_DRAW_BUFFERS):this._maxDrawBuffers=1),this._maxDrawBuffers}},{key:"maxAnisoLevel",get:function(){if(!this._maxAnisoLevel){var t=this._rhi.requireExtension(K.textureFilterAnisotropic);this._maxAnisoLevel=t?this._rhi.gl.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1}return this._maxAnisoLevel}},{key:"maxAntiAliasing",get:function(){if(!this._maxAntiAliasing){var t=this._rhi.gl,e=this.canIUse(K.multipleSample);this._maxAntiAliasing=e?t.getParameter(t.MAX_SAMPLES):1}return this._maxAntiAliasing}},{key:"rhi",get:function(){return this._rhi}}]),n}(),bh=function(){function n(i){this.rhi=i,this._requireResult={}}var s=n.prototype;return s.requireExtension=function(t){return this._requireResult[t]!==void 0?this._requireResult[t]:(this._requireResult[t]=this.rhi.gl.getExtension(t),this._requireResult[t])},n}(),Sh=function(){function n(i,t){this._attribLocArray=[],this._vaoMap=new Map,this._primitive=t,this._canUseInstancedArrays=i.canIUse(K.instancedArrays),this._isSupportVAO=i.canIUse(K.vertexArrayObject),this._gl=i.gl}var s=n.prototype;return s.draw=function(t,e){var r=this._gl,a=this._primitive,o=this._isSupportVAO&&a.enableVAO;if(o){a._bufferStructChanged&&this._clearVAO(),this._vaoMap.has(t.id)||this._registerVAO(t);var c=this._vaoMap.get(t.id);r.bindVertexArray(c)}else this._bindBufferAndAttrib(t);var l=a.indexBufferBinding,_=a.instanceCount,u=a._glIndexType,h=a._glIndexByteCount,d=e.topology,f=e.start,v=e.count;if(_)if(this._canUseInstancedArrays)if(l)if(o)r.drawElementsInstanced(d,v,u,f*h,_);else{var g=l.buffer._platformBuffer._glBuffer;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,g),r.drawElementsInstanced(d,v,u,f*h,_),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)}else r.drawArraysInstanced(d,f,v,_);else ve.error("ANGLE_instanced_arrays extension is not supported");else if(l)if(o)r.drawElements(d,v,u,f*h);else{var p=l.buffer._platformBuffer._glBuffer;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,p),r.drawElements(d,v,u,f*h),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)}else r.drawArrays(d,f,v);o?r.bindVertexArray(null):this._disableAttrib()},s.destroy=function(){this._isSupportVAO&&this._clearVAO()},s._bindBufferAndAttrib=function(t){var e=this._gl,r=this._primitive,a=r.vertexBufferBindings;this._attribLocArray.length=0;var o=t.attributeLocation,c=r._vertexElementMap,l,_;for(var u in o){var h=o[u];if(h!==-1){var d=c[u];if(d){var f=a[d.bindingIndex],v=f.buffer,p=f.stride;l=v._platformBuffer._glBuffer,_!==l&&(_=l,e.bindBuffer(e.ARRAY_BUFFER,l)),e.enableVertexAttribArray(h);var g=d._formatMetaInfo;e.vertexAttribPointer(h,g.size,g.type,g.normalized,p,d.offset),this._canUseInstancedArrays&&e.vertexAttribDivisor(h,d.instanceStepRate),this._attribLocArray.push(h)}else ve.warn("vertex attribute not found: "+u)}}e.bindBuffer(e.ARRAY_BUFFER,null)},s._disableAttrib=function(){for(var t=this._gl,e=0,r=this._attribLocArray.length;e<r;e++)t.disableVertexAttribArray(this._attribLocArray[e])},s._registerVAO=function(t){var e=this._gl,r=e.createVertexArray();e.bindVertexArray(r);var a=this._primitive.indexBufferBinding;a&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a.buffer._platformBuffer._glBuffer),this._bindBufferAndAttrib(t),e.bindVertexArray(null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),this._disableAttrib(),this._vaoMap.set(t.id,r)},s._clearVAO=function(){var t=this._gl;this._vaoMap.forEach(function(e){t.deleteVertexArray(e)}),this._vaoMap.clear()},n}(),Ch=function(){function n(i){this._parameters={},this._gl=i,this._parameters={},this._parameters[i.MAX_COMBINED_TEXTURE_IMAGE_UNITS]=i.getParameter(i.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this._parameters[i.MAX_VERTEX_UNIFORM_VECTORS]=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this._parameters[i.MAX_VERTEX_ATTRIBS]=i.getParameter(i.MAX_VERTEX_ATTRIBS),this._parameters[i.MAX_VERTEX_TEXTURE_IMAGE_UNITS]=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._parameters[i.MAX_TEXTURE_SIZE]=i.getParameter(i.MAX_TEXTURE_SIZE),i.blendFuncSeparate(i.ONE,i.ZERO,i.ONE,i.ZERO),i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD),i.colorMask(!0,!0,!0,!0),i.blendColor(0,0,0,0),i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),i.enable(i.DEPTH_TEST),i.depthFunc(i.LESS),i.depthMask(!0),i.disable(i.STENCIL_TEST),i.stencilFuncSeparate(i.FRONT,i.ALWAYS,0,255),i.stencilFuncSeparate(i.BACK,i.ALWAYS,0,255),i.stencilOpSeparate(i.FRONT,i.KEEP,i.KEEP,i.KEEP),i.stencilOpSeparate(i.BACK,i.KEEP,i.KEEP,i.KEEP),i.stencilMask(255),i.enable(i.CULL_FACE),i.cullFace(i.BACK),i.disable(i.POLYGON_OFFSET_FILL),i.polygonOffset(0,0)}var s=n.prototype;return s.getParameter=function(t){return this._parameters[t]},n}(),Ct=function(){function n(i,t,e){this._texture=t,this._rhi=i,this._gl=i.gl,this._isWebGL2=i.isWebGL2,this._target=e,this._glTexture=this._gl.createTexture()}var s=n.prototype;return s.destroy=function(){this._gl.deleteTexture(this._glTexture),this._texture=null,this._glTexture=null,this._formatDetail=null},s.setUseDepthCompareMode=function(t){var e=this._gl;e.texParameteri(this._target,e.TEXTURE_COMPARE_MODE,t?e.COMPARE_REF_TO_TEXTURE:e.NONE)},s.generateMipmaps=function(){(this._texture.width!==1||this._texture.height!==1)&&(this._bind(),this._gl.generateMipmap(this._target))},s._bind=function(){this._rhi.bindTexture(this)},s._init=function(t){var e=this._gl,r=this._isWebGL2,a=this._formatDetail,o=a.internalFormat,c=a.baseFormat,l=a.dataType,_=this._texture,u=_.mipmapCount,h=_.width,d=_.height,f=_.usage,v=_._isDepthTexture;if(this._bind(),r&&!(c===e.LUMINANCE_ALPHA||c===e.ALPHA)&&f!==la.Dynamic)e.texStorage2D(this._target,u,o,h,d);else if(t)for(var m=0;m<u;m++)for(var x=Math.max(1,h>>m),C=0;C<6;C++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+C,m,o,x,x,0,c,l,null);else if(v)e.texImage2D(this._target,0,o,h,d,0,c,l,null);else for(var p=0;p<u;p++){var g=Math.max(1,h>>p),y=Math.max(1,d>>p);e.texImage2D(this._target,p,o,g,y,0,c,l,null)}},s._getPixelBuffer=function(t,e,r,a,o,c,l){var _=this._gl,u=this._formatDetail,h=u.baseFormat,d=u.dataType;_.bindFramebuffer(_.FRAMEBUFFER,this._getReadFrameBuffer()),c>0&&!this._isWebGL2&&(c=0,ve.error("mipLevel only take effect in WebGL2.0")),t!=null?_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_CUBE_MAP_POSITIVE_X+t,this._glTexture,c):_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,this._glTexture,c),_.readPixels(e,r,a,o,h,d,l),_.bindFramebuffer(_.FRAMEBUFFER,null)},s._setWrapMode=function(t,e){var r=this._gl,a=this._isWebGL2,o=this._target,c=this._texture,l=c.width,_=c.height;switch(!a&&t!==gt.Clamp&&(!n._isPowerOf2(l)||!n._isPowerOf2(_))&&(ve.warn("non-power-2 texture is not supported for REPEAT or MIRRORED_REPEAT in WebGL1,and has automatically downgraded to CLAMP_TO_EDGE"),t=gt.Clamp),t){case gt.Clamp:r.texParameteri(o,e,r.CLAMP_TO_EDGE);break;case gt.Repeat:r.texParameteri(o,e,r.REPEAT);break;case gt.Mirror:r.texParameteri(o,e,r.MIRRORED_REPEAT);break}},s._getReadFrameBuffer=function(){var t=this._rhi._readFrameBuffer;return t||(this._rhi._readFrameBuffer=t=this._gl.createFramebuffer()),t},n._isPowerOf2=function(t){return(t&t-1)===0},n._getFormatDetail=function(t,e,r){switch(t){case G.R8G8B8:return{internalFormat:r?e.RGB8:e.RGB,baseFormat:e.RGB,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case G.R8G8B8A8:return{internalFormat:r?e.RGBA8:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case G.R4G4B4A4:return{internalFormat:r?e.RGBA4:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case G.R5G5B5A1:return{internalFormat:r?e.RGB5_A1:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case G.R5G6B5:return{internalFormat:r?e.RGB565:e.RGB,baseFormat:e.RGB,dataType:e.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case G.Alpha8:return{internalFormat:e.ALPHA,baseFormat:e.ALPHA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case G.LuminanceAlpha:return{internalFormat:e.LUMINANCE_ALPHA,baseFormat:e.LUMINANCE_ALPHA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case G.R16G16B16A16:return{internalFormat:r?e.RGBA16F:e.RGBA,baseFormat:e.RGBA,dataType:e.HALF_FLOAT,isCompressed:!1};case G.R32G32B32A32:return{internalFormat:r?e.RGBA32F:e.RGBA,baseFormat:e.RGBA,dataType:e.FLOAT,isCompressed:!1};case G.R32G32B32A32_UInt:return{internalFormat:r?e.RGBA32UI:e.NONE,baseFormat:e.RGBA_INTEGER,dataType:e.UNSIGNED_INT,isCompressed:!1};case G.BC1:return{internalFormat:_e.RGB_S3TC_DXT1_EXT,isCompressed:!0};case G.BC3:return{internalFormat:_e.RGBA_S3TC_DXT5_EXT,isCompressed:!0};case G.BC7:return{internalFormat:_e.RGBA_BPTC_UNORM_EXT,isCompressed:!0};case G.ETC1_RGB:return{internalFormat:_e.RGB_ETC1_WEBGL,isCompressed:!0};case G.ETC2_RGB:return{internalFormat:_e.RGB8_ETC2,isCompressed:!0};case G.ETC2_RGBA5:return{internalFormat:_e.RGB8_PUNCHTHROUGH_ALPHA1_ETC2,isCompressed:!0};case G.ETC2_RGBA8:return{internalFormat:_e.RGBA8_ETC2_EAC,isCompressed:!0};case G.PVRTC_RGB2:return{internalFormat:_e.RGB_PVRTC_2BPPV1_IMG,isCompressed:!0};case G.PVRTC_RGBA2:return{internalFormat:_e.RGBA_PVRTC_2BPPV1_IMG,isCompressed:!0};case G.PVRTC_RGB4:return{internalFormat:_e.RGB_PVRTC_4BPPV1_IMG,isCompressed:!0};case G.PVRTC_RGBA4:return{internalFormat:_e.RGBA_PVRTC_4BPPV1_IMG,isCompressed:!0};case G.ASTC_4x4:return{internalFormat:_e.RGBA_ASTC_4X4_KHR,isCompressed:!0};case G.ASTC_5x5:return{internalFormat:_e.RGBA_ASTC_5X5_KHR,isCompressed:!0};case G.ASTC_6x6:return{internalFormat:_e.RGBA_ASTC_6X6_KHR,isCompressed:!0};case G.ASTC_8x8:return{internalFormat:_e.RGBA_ASTC_8X8_KHR,isCompressed:!0};case G.ASTC_10x10:return{internalFormat:_e.RGBA_ASTC_10X10_KHR,isCompressed:!0};case G.ASTC_12x12:return{internalFormat:_e.RGBA_ASTC_12X12_KHR,isCompressed:!0};case G.Depth:return{internalFormat:r?e.DEPTH_COMPONENT32F:e.DEPTH_COMPONENT,baseFormat:e.DEPTH_COMPONENT,dataType:r?e.FLOAT:e.UNSIGNED_SHORT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case G.DepthStencil:return{internalFormat:r?e.DEPTH32F_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:r?e.FLOAT_32_UNSIGNED_INT_24_8_REV:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case G.Depth16:return{internalFormat:r?e.DEPTH_COMPONENT16:e.DEPTH_COMPONENT,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_SHORT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case G.Depth24Stencil8:return{internalFormat:r?e.DEPTH24_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case G.Depth24:return{internalFormat:e.DEPTH_COMPONENT24,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_INT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case G.Depth32:return{internalFormat:e.DEPTH_COMPONENT32F,baseFormat:e.DEPTH_COMPONENT,dataType:e.FLOAT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case G.Depth32Stencil8:return{internalFormat:e.DEPTH32F_STENCIL8,baseFormat:e.DEPTH_STENCIL,dataType:e.FLOAT_32_UNSIGNED_INT_24_8_REV,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};default:throw new Error("this TextureFormat is not supported in Galacean Engine: "+t)}},n._getRenderBufferDepthFormatDetail=function(t,e,r){switch(t){case G.Depth:return{internalFormat:r?e.DEPTH_COMPONENT32F:e.DEPTH_COMPONENT16,baseFormat:e.DEPTH_COMPONENT,dataType:r?e.FLOAT:e.UNSIGNED_SHORT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case G.DepthStencil:return{internalFormat:r?e.DEPTH32F_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:r?e.FLOAT_32_UNSIGNED_INT_24_8_REV:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case G.Stencil:return{internalFormat:e.STENCIL_INDEX8,baseFormat:e.STENCIL_ATTACHMENT,dataType:e.UNSIGNED_BYTE,isCompressed:!1,attachment:e.STENCIL_ATTACHMENT};case G.Depth16:return{internalFormat:e.DEPTH_COMPONENT16,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_SHORT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case G.Depth24Stencil8:return{internalFormat:r?e.DEPTH24_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case G.Depth24:return{internalFormat:e.DEPTH_COMPONENT24,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_INT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case G.Depth32:return{internalFormat:e.DEPTH_COMPONENT32F,baseFormat:e.DEPTH_COMPONENT,dataType:e.FLOAT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case G.Depth32Stencil8:return{internalFormat:e.DEPTH32F_STENCIL8,baseFormat:e.DEPTH_STENCIL,dataType:e.FLOAT_32_UNSIGNED_INT_24_8_REV,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};default:throw new Error("this TextureFormat is not supported in Galacean Engine: "+t)}},n._supportTextureFormat=function(t,e){switch(t){case G.R16G16B16A16:if(!e.canIUse(K.textureHalfFloat))return!1;break;case G.R32G32B32A32:if(!e.canIUse(K.textureFloat))return!1;break;case G.Depth16:case G.Depth24Stencil8:case G.Depth:case G.DepthStencil:if(!e.canIUse(K.depthTexture))return!1;break;case G.R32G32B32A32_UInt:case G.Depth24:case G.Depth32:case G.Depth32Stencil8:return e.isWebGL2}return!0},n._supportRenderBufferColorFormat=function(t,e){var r=!0;switch(t){case G.R16G16B16A16:(!e.canIUse(K.colorBufferHalfFloat)||!e.canIUse(K.textureHalfFloat))&&(r=!1);break;case G.R32G32B32A32:(!e.canIUse(K.colorBufferFloat)||!e.canIUse(K.textureFloat))&&(r=!1);break}return r},n._supportRenderBufferDepthFormat=function(t,e){if(!e.isWebGL2)switch(t){case G.Depth24:case G.Depth32:case G.Depth32Stencil8:return!1}return!0},qa(n,[{key:"wrapModeU",set:function(t){this._bind(),this._setWrapMode(t,this._gl.TEXTURE_WRAP_S)}},{key:"wrapModeV",set:function(t){this._bind(),this._setWrapMode(t,this._gl.TEXTURE_WRAP_T)}},{key:"filterMode",set:function(t){var e=this._gl,r=this._target,a=this._texture._mipmap;switch(this._bind(),t){case tt.Point:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(r,e.TEXTURE_MIN_FILTER,a?e.NEAREST_MIPMAP_NEAREST:e.NEAREST);break;case tt.Bilinear:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(r,e.TEXTURE_MIN_FILTER,a?e.LINEAR_MIPMAP_NEAREST:e.LINEAR);break;case tt.Trilinear:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(r,e.TEXTURE_MIN_FILTER,a?e.LINEAR_MIPMAP_LINEAR:e.LINEAR);break}}},{key:"anisoLevel",set:function(t){var e=this._gl;this._bind(),e.texParameterf(this._target,e.TEXTURE_MAX_ANISOTROPY_EXT,t)}},{key:"depthCompareFunction",set:function(t){this._bind();var e=this._gl;switch(t){case vr.Never:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.NEVER);break;case vr.Less:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.LESS);break;case vr.Equal:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.EQUAL);break;case vr.LessEqual:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.LEQUAL);break;case vr.Greater:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.GREATER);break;case vr.NotEqual:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.NOTEQUAL);break;case vr.GreaterEqual:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.GEQUAL);break;case vr.Always:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.ALWAYS);break}}}]),n}(),Ah=function(){function n(i,t){this._MSAAColorRenderBuffers=[],this._curMipLevel=0,this._curFaceIndex=void 0,this._gl=i.gl,this._isWebGL2=i.isWebGL2,this._target=t;for(var e=t._colorTextures,r=t._depth,a=t.width,o=t.height,c=ir(r,Wr),l=0,_=e.length;l<_;l++){var u=e[l]._format;if(!Ct._supportRenderBufferColorFormat(u,i))throw new Error("TextureFormat is not supported:"+G[u]+" in RenderTarget")}if(!c&&!Ct._supportRenderBufferDepthFormat(r,i))throw new Error("TextureFormat is not supported:"+G[r]+" in RenderTarget");if(e.length>1&&!i.canIUse(K.drawBuffers))throw new Error("MRT is not supported");if(e.some(function(d){return d.width!==a||d.height!==o}))throw new Error("ColorTexture's size must as same as RenderTarget");if(c&&(r.width!==a||r.height!==o))throw new Error("DepthTexture's size must as same as RenderTarget");if(e.length>1&&e.some(function(d){return ir(d,jt)}))throw new Error("MRT+Cube+[,MSAA] is not supported");var h=i.capability.maxAntiAliasing;t.antiAliasing>h&&(ve.warn("MSAA antiAliasing exceeds the limit and is automatically downgraded to:"+h),t._antiAliasing=h),this._frameBuffer=this._gl.createFramebuffer(),this._bindMainFBO(),t.antiAliasing>1&&(this._MSAAFrameBuffer=this._gl.createFramebuffer(),this._bindMSAAFBO())}var s=n.prototype;return s.activeRenderTarget=function(t,e){var r=this,a=r._gl,o=r._target;a.bindFramebuffer(a.FRAMEBUFFER,this._frameBuffer);var c=t!==this._curMipLevel,l=e!==this._curFaceIndex,_=o.getColorTexture(0);if(_){var u=ir(_,jt);(c||u&&l)&&a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,u?a.TEXTURE_CUBE_MAP_POSITIVE_X+e:a.TEXTURE_2D,_._platformTexture._glTexture,t)}var h=o.depthTexture;if(h){var d=ir(h,jt);if(c||d){var f=h._platformTexture;a.framebufferTexture2D(a.FRAMEBUFFER,f._formatDetail.attachment,d?a.TEXTURE_CUBE_MAP_POSITIVE_X+e:a.TEXTURE_2D,f._glTexture,t)}}else if(c){var v=Ct._getRenderBufferDepthFormatDetail(o._depth,a,this._isWebGL2).internalFormat;a.bindRenderbuffer(a.RENDERBUFFER,this._depthRenderBuffer),a.renderbufferStorage(a.RENDERBUFFER,v,o.width>>t,o.height>>t)}this._curMipLevel=t,this._curFaceIndex=e,this._MSAAFrameBuffer&&a.bindFramebuffer(a.FRAMEBUFFER,this._MSAAFrameBuffer)},s.blitRenderTarget=function(){if(this._MSAAFrameBuffer){var t=this._gl,e=t.COLOR_BUFFER_BIT|(this._target.depthTexture?t.DEPTH_BUFFER_BIT:0),r=this._target,a=r.colorTextureCount,o=r.width,c=r.height;t.bindFramebuffer(t.READ_FRAMEBUFFER,this._MSAAFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this._frameBuffer);for(var l=0;l<a;l++){var _=t.COLOR_ATTACHMENT0+l;this._blitDrawBuffers[l]=_,t.readBuffer(_),t.drawBuffers(this._blitDrawBuffers),t.blitFramebuffer(0,0,o,c,0,0,o,c,e,t.NEAREST),this._blitDrawBuffers[l]=t.NONE}t.bindFramebuffer(t.FRAMEBUFFER,null)}},s.destroy=function(){var t=this._gl;this._frameBuffer&&t.deleteFramebuffer(this._frameBuffer),this._depthRenderBuffer&&t.deleteRenderbuffer(this._depthRenderBuffer),this._MSAAFrameBuffer&&t.deleteFramebuffer(this._MSAAFrameBuffer),this._MSAADepthRenderBuffer&&t.deleteRenderbuffer(this._MSAADepthRenderBuffer);for(var e=0;e<this._MSAAColorRenderBuffers.length;e++)t.deleteRenderbuffer(this._MSAAColorRenderBuffers[e]);this._frameBuffer=null,this._depthRenderBuffer=null,this._MSAAFrameBuffer=null,this._MSAAColorRenderBuffers.length=0,this._MSAADepthRenderBuffer=null},s._bindMainFBO=function(){var t=this._gl,e=this._isWebGL2,r=this._target,a=r._depth,o=r.colorTextureCount,c=r.width,l=r.height,_=new Array(o);t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer);for(var u=0;u<o;u++){var h=this._target.getColorTexture(u),d=t.COLOR_ATTACHMENT0+u;_[u]=d,ir(h,jt)||t.framebufferTexture2D(t.FRAMEBUFFER,d,t.TEXTURE_2D,h._platformTexture._glTexture,0)}if(o>1&&t.drawBuffers(_),this._oriDrawBuffers=_,a!==null){if(ir(a,Wr)&&!ir(a,jt)){var f=a._platformTexture;t.framebufferTexture2D(t.FRAMEBUFFER,f._formatDetail.attachment,t.TEXTURE_2D,f._glTexture,0)}else if(this._target.antiAliasing<=1){var v=Ct._getRenderBufferDepthFormatDetail(a,t,e),p=v.internalFormat,g=v.attachment,y=t.createRenderbuffer();this._depthRenderBuffer=y,t.bindRenderbuffer(t.RENDERBUFFER,y),t.renderbufferStorage(t.RENDERBUFFER,p,c,l),t.framebufferRenderbuffer(t.FRAMEBUFFER,g,t.RENDERBUFFER,y)}}t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},s._bindMSAAFBO=function(){var t=this._gl,e=this._isWebGL2,r=t.createRenderbuffer(),a=this._target,o=a._depth,c=a.colorTextureCount,l=a.antiAliasing,_=a.width,u=a.height;this._blitDrawBuffers=new Array(c),this._MSAADepthRenderBuffer=r,t.bindFramebuffer(t.FRAMEBUFFER,this._MSAAFrameBuffer);for(var h=0;h<c;h++){var d=t.createRenderbuffer();this._MSAAColorRenderBuffers[h]=d,this._blitDrawBuffers[h]=t.NONE,t.bindRenderbuffer(t.RENDERBUFFER,d),t.renderbufferStorageMultisample(t.RENDERBUFFER,l,this._target.getColorTexture(h)._platformTexture._formatDetail.internalFormat,_,u),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+h,t.RENDERBUFFER,d)}if(t.drawBuffers(this._oriDrawBuffers),o!==null){var f=ir(o,Wr)?o._platformTexture._formatDetail:Ct._getRenderBufferDepthFormatDetail(o,t,e),v=f.internalFormat,p=f.attachment;t.bindRenderbuffer(t.RENDERBUFFER,r),t.renderbufferStorageMultisample(t.RENDERBUFFER,l,v,_,u),t.framebufferRenderbuffer(t.FRAMEBUFFER,p,t.RENDERBUFFER,r)}this._checkFrameBuffer(),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},s._checkFrameBuffer=function(){var t=this._gl,e=this._isWebGL2,r=t.checkFramebufferStatus(t.FRAMEBUFFER);switch(r){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete");case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment");case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error(" Height and width of the attachment are not the same.");case t.FRAMEBUFFER_UNSUPPORTED:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer")}if(e&&r===t.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE)throw new Error("The values of gl.RENDERBUFFER_SAMPLES are different among attached renderbuffers, or are non-zero if the attached images are a mix of renderbuffers and textures.")},n}(),Eh=function(n){Ya(s,n);function s(t,e){var r;r=n.call(this,t,e,t.gl.TEXTURE_2D)||this,r._compressedMipFilled=0;var a=e.format,o=e._mipmap,c=e.width,l=e.height,_=r._isWebGL2;if(!Ct._supportTextureFormat(a,t))throw new Error("Texture format is not supported:"+G[a]);return o&&!_&&(!Ct._isPowerOf2(c)||!Ct._isPowerOf2(l))&&(ve.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),e._mipmap=!1,e._mipmapCount=e._getMipmapCount()),r._formatDetail=Ct._getFormatDetail(a,r._gl,_),r._formatDetail.isCompressed&&!_||r._init(!1),r}var i=s.prototype;return i.setPixelBuffer=function(e,r,a,o,c,l){r===void 0&&(r=0);var _=this._gl,u=this._isWebGL2,h=this._formatDetail,d=h.internalFormat,f=h.baseFormat,v=h.dataType,p=h.isCompressed,g=Math.max(1,this._texture.width>>r),y=Math.max(1,this._texture.height>>r);if(c=c||g-a,l=l||y-o,this._bind(),_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,0),_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),p){var m=1<<r;u||this._compressedMipFilled&m?_.compressedTexSubImage2D(this._target,r,a,o,c,l,d,e):(_.compressedTexImage2D(this._target,r,d,c,l,0,e),this._compressedMipFilled|=m)}else _.texSubImage2D(this._target,r,a,o,c,l,f,v,e)},i.setImageSource=function(e,r,a,o,c,l){var _=this._gl,u=this._formatDetail,h=u.internalFormat,d=u.baseFormat,f=u.dataType;this._bind(),_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,+a),_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+o),this._texture.usage===la.Dynamic?_.texImage2D(this._target,r,h,d,f,e):_.texSubImage2D(this._target,r,c||0,l||0,d,f,e)},i.getPixelBuffer=function(e,r,a,o,c,l){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");n.prototype._getPixelBuffer.call(this,null,e,r,a,o,c,l)},s}(Ct),wh=function(n){Ya(s,n);function s(t,e){var r;r=n.call(this,t,e,t.gl.TEXTURE_2D_ARRAY)||this;var a=e.format,o=e.width,c=e.height,l=e.length,_=e.mipmapCount;if(!r._isWebGL2)throw new Error("Texture2D Array is not supported in WebGL1.0");if(!Ct._supportTextureFormat(a,t))throw new Error("Texture format is not supported:"+G[a]);return r._bind(),r._formatDetail=Ct._getFormatDetail(a,r._gl,!0),r._gl.texStorage3D(r._target,_,r._formatDetail.internalFormat,o,c,l),r}var i=s.prototype;return i.setPixelBuffer=function(e,r,a,o,c,l,_,u){var h=this,d=h._target,f=h._gl,v=this._formatDetail,p=v.internalFormat,g=v.baseFormat,y=v.dataType,m=v.isCompressed;l=l||Math.max(1,this._texture.width>>a)-o,_=_||Math.max(1,this._texture.height>>a)-c,u=u||this._texture.length,this._bind(),f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,0),f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),m?f.compressedTexSubImage3D(d,a,o,c,e,l,_,u,p,r):f.texSubImage3D(d,a,o,c,e,l,_,u,g,y,r)},i.setImageSource=function(e,r,a,o,c,l,_){var u=this._gl,h=this._formatDetail,d=h.baseFormat,f=h.dataType;this._bind(),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,+o),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+c);var v,p;u.texSubImage3D(this._target,a,l,_,e,(v=r.width)!=null?v:r.codedWidth,(p=r.height)!=null?p:r.codedHeight,1,d,f,r)},i.getPixelBuffer=function(e,r,a,o,c,l,_){var u=this,h=u._gl,d=u._formatDetail;if(d.isCompressed)throw new Error("Unable to read compressed texture");h.bindFramebuffer(h.FRAMEBUFFER,this._getReadFrameBuffer()),h.framebufferTextureLayer(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,this._glTexture,l,e),h.readPixels(r,a,o,c,d.baseFormat,d.dataType,_),h.bindFramebuffer(h.FRAMEBUFFER,null)},s}(Ct),Th=function(n){Ya(s,n);function s(t,e){var r;r=n.call(this,t,e,t.gl.TEXTURE_CUBE_MAP)||this,r._compressedFaceFilled=[0,0,0,0,0,0];var a=e.format,o=e._mipmap,c=e.width,l=r._isWebGL2;if(!Ct._supportTextureFormat(a,t))throw new Error("Texture format is not supported:"+G[a]);return o&&!l&&!Ct._isPowerOf2(c)&&(ve.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),e._mipmap=!1,e._mipmapCount=e._getMipmapCount()),r._formatDetail=Ct._getFormatDetail(a,r._gl,l),r._formatDetail.isCompressed&&!l||r._init(!0),r}var i=s.prototype;return i.setPixelBuffer=function(e,r,a,o,c,l,_){var u=this._gl,h=this._isWebGL2,d=this._formatDetail,f=d.internalFormat,v=d.baseFormat,p=d.dataType,g=d.isCompressed,y=Math.max(1,this._texture.width>>a);if(l=l||y-o,_=_||y-c,this._bind(),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,0),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),g){var m=1<<a;h||this._compressedFaceFilled[e]&m?u.compressedTexSubImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+e,a,o,c,l,_,f,r):(u.compressedTexImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+e,a,f,l,_,0,r),this._compressedFaceFilled[e]|=m)}else u.texSubImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+e,a,o,c,l,_,v,p,r)},i.setImageSource=function(e,r,a,o,c,l,_){var u=this._gl,h=this._formatDetail,d=h.baseFormat,f=h.dataType;this._bind(),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,+o),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+c),u.texSubImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+e,a,l||0,_||0,d,f,r)},i.getPixelBuffer=function(e,r,a,o,c,l,_){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");n.prototype._getPixelBuffer.call(this,e,r,a,o,c,l,_)},s}(Ct),ps;(function(n){n[n.Auto=0]="Auto",n[n.WebGL2=1]="WebGL2",n[n.WebGL1=2]="WebGL1"})(ps||(ps={}));var Rh=function(){function n(i){i===void 0&&(i={}),this._readFrameBuffer=null,this._mainFrameBuffer=null,this._mainFrameWidth=0,this._mainFrameHeight=0,this._enableGlobalDepthBias=!1,this._activeTextures=new Array(32),this._lastViewport=new ie(null,null,null,null),this._lastScissor=new ie(null,null,null,null),this._lastClearColor=new q(null,null,null,null),this._scissorEnable=!1;var t=Li({webGLMode:0,stencil:!0,_forceFlush:!1,_maxAllowSkinUniformVectorCount:256},i);if(jr.platform===Nt.IPhone||jr.platform===Nt.IPad){var e=jr.operatingSystem.match(/(\d+).?(\d+)?.?(\d+)?/);if(e){var r=parseInt(e[1]),a=parseInt(e[2]);r===15&&a>=0&&a<=4&&(t._forceFlush=!0)}}this._options=t,this._onWebGLContextLost=this._onWebGLContextLost.bind(this),this._onWebGLContextRestored=this._onWebGLContextRestored.bind(this)}var s=n.prototype;return s.init=function(t,e,r){var a=this._options,o=t._webCanvas,c=a.webGLMode;this._onDeviceLost=e,this._onDeviceRestored=r,o.addEventListener("webglcontextlost",this._onWebGLContextLost,!1),o.addEventListener("webglcontextrestored",this._onWebGLContextRestored,!1),o.addEventListener("webglcontextcreationerror",this._onContextCreationError,!1),this._webCanvas=o;var l;if((c==0||c==1)&&(l=o.getContext("webgl2",a),!l&&(typeof OffscreenCanvas>"u"||!ir(o,OffscreenCanvas))&&(l=o.getContext("experimental-webgl2",a)),this._isWebGL2=!0,l&&!l.deleteQuery&&(this._isWebGL2=!1)),l||(c==0||c==2)&&(l=o.getContext("webgl",a),!l&&(typeof OffscreenCanvas>"u"||!ir(o,OffscreenCanvas))&&(l=o.getContext("experimental-webgl",a)),this._isWebGL2=!1),!l)throw new Error("Get GL Context FAILED.");this._gl=l,this._initGLState(l)},s.createPlatformPrimitive=function(t){return new Sh(this,t)},s.createPlatformTexture2D=function(t){return new Eh(this,t)},s.createPlatformTexture2DArray=function(t){return new wh(this,t)},s.createPlatformTextureCube=function(t){return new Th(this,t)},s.createPlatformRenderTarget=function(t){return new Ah(this,t)},s.createPlatformBuffer=function(t,e,r,a){return r===void 0&&(r=Je.Static),new yh(this,t,e,r,a)},s.requireExtension=function(t){return this._extensions.requireExtension(t)},s.canIUse=function(t){return this.capability.canIUse(t)},s.canIUseCompressedTextureInternalFormat=function(t){return this.capability.canIUseCompressedTextureInternalFormat(t)},s.viewport=function(t,e,r,a){var o=this,c=o._gl,l=o._lastViewport;(t!==l.x||e!==l.y||r!==l.z||a!==l.w)&&(c.viewport(t,e,r,a),l.set(t,e,r,a))},s.scissor=function(t,e,r,a){var o=this,c=o._gl,l=o._lastScissor;if(t!==l.x||e!==l.y||r!==l.z||a!==l.w){var _=this,u=_._webCanvas;t===0&&e===0&&r===u.width&&a===u.height?this._scissorEnable&&(c.disable(c.SCISSOR_TEST),this._scissorEnable=!1):(this._scissorEnable||(c.enable(c.SCISSOR_TEST),this._scissorEnable=!0),c.scissor(t,e,r,a)),l.set(t,e,r,a)}},s.colorMask=function(t,e,r,a){this._gl.colorMask(t,e,r,a)},s.clearRenderTarget=function(t,e,r){var a=this._gl,o=t._lastRenderState,c=o.blendState.targetBlendState,l=o.depthState,_=o.stencilState,u=0;if(e&zt.Color){u|=a.COLOR_BUFFER_BIT;var h=this._lastClearColor,d=r.r,f=r.g,v=r.b,p=r.a;r&&(d!==h.r||f!==h.g||v!==h.b||p!==h.a)&&(a.clearColor(d,f,v,p),h.set(d,f,v,p)),c.colorWriteMask!==yr.All&&(a.colorMask(!0,!0,!0,!0),c.colorWriteMask=yr.All)}e&zt.Depth&&(u|=a.DEPTH_BUFFER_BIT,l.writeEnabled!==!0&&(a.depthMask(!0),l.writeEnabled=!0)),e&zt.Stencil&&(u|=a.STENCIL_BUFFER_BIT,_.writeMask!==255&&(a.stencilMask(255),_.writeMask=255)),a.clear(u)},s.drawPrimitive=function(t,e,r){t?t.draw(r,e):ve.error("draw primitive failed.")},s.getMainFrameBufferWidth=function(){return this._mainFrameWidth||this._gl.drawingBufferWidth},s.getMainFrameBufferHeight=function(){return this._mainFrameHeight||this._gl.drawingBufferHeight},s.activeRenderTarget=function(t,e,r,a,o){var c,l;if(t){t._isContentLost=!1;var _=t._platformRenderTarget;_.activeRenderTarget(a,o),c=t.width>>a,l=t.height>>a}else{var u=this._gl;u.bindFramebuffer(u.FRAMEBUFFER,this._mainFrameBuffer),c=this.getMainFrameBufferWidth(),l=this.getMainFrameBufferHeight()}var h=c*e.z,d=l*e.w,f=e.x*c,v=r?e.y*l:l-e.y*l-d;this.viewport(f,v,h,d),this.scissor(f,v,h,d)},s.activeTexture=function(t){this._activeTextureID!==t&&(this._gl.activeTexture(t),this._activeTextureID=t)},s.bindTexture=function(t){var e=this._activeTextureID-this._gl.TEXTURE0;this._activeTextures[e]!==t&&(this._gl.bindTexture(t._target,t._glTexture),this._activeTextures[e]=t)},s.setGlobalDepthBias=function(t,e){var r=this._gl,a=t!==0||e!==0;a?(r.enable(r.POLYGON_OFFSET_FILL),r.polygonOffset(e,t)):r.disable(r.POLYGON_OFFSET_FILL),this._enableGlobalDepthBias=a},s.flush=function(){this._gl.flush()},s.forceLoseDevice=function(){var t=this.requireExtension(K.WEBGL_lose_context);t.loseContext()},s.forceRestoreDevice=function(){var t=this.requireExtension(K.WEBGL_lose_context);t.restoreContext()},s.resetState=function(){this._readFrameBuffer=null,this._enableGlobalDepthBias=!1,this._currentBindShaderProgram=null;for(var t=this._activeTextures,e=0,r=t.length;e<r;e++)t[e]=null;this._lastViewport.set(null,null,null,null),this._lastScissor.set(null,null,null,null),this._lastClearColor.set(null,null,null,null),this._scissorEnable=!1,this._initGLState(this._gl)},s._initGLState=function(t){this._activeTextureID=t.TEXTURE0,this._renderStates=new Ch(t),this._extensions=new bh(this),this._capability=new xh(this),t.activeTexture(t.TEXTURE0);var e=t.getExtension("WEBGL_debug_renderer_info");e!=null&&(this._renderer=t.getParameter(e.UNMASKED_RENDERER_WEBGL))},s.destroy=function(){var t=this._webCanvas;t.removeEventListener("webglcontextcreationerror",this._onContextCreationError,!1),t.removeEventListener("webglcontextlost",this._onWebGLContextLost,!1),t.removeEventListener("webglcontextrestored",this._onWebGLContextRestored,!1)},s._onContextCreationError=function(t){console.error("WebGLRenderer: WebGL context could not be created. Reason: ",t.statusMessage)},s._onWebGLContextLost=function(t){t.preventDefault(),this._onDeviceLost()},s._onWebGLContextRestored=function(t){this._onDeviceRestored()},qa(n,[{key:"isWebGL2",get:function(){return this._isWebGL2}},{key:"renderer",get:function(){return this._renderer}},{key:"gl",get:function(){return this._gl}},{key:"renderStates",get:function(){return this._renderStates}},{key:"capability",get:function(){return this._capability}},{key:"canIUseMoreJoints",get:function(){return this.capability.canIUseMoreJoints}}]),n}();function Bt(){return Bt=Object.assign||function(s){for(var i=1;i<arguments.length;i++){var t=arguments[i];for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(s[e]=t[e])}return s},Bt.apply(this,arguments)}function Vi(n,s){return Vi=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},Vi(n,s)}function ne(n,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(s&&s.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),s&&Vi(n,s)}function le(n,s,i,t){var e=arguments.length,r=e<3?s:t===null?t=Object.getOwnPropertyDescriptor(s,i):t,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(n,s,i,t);else for(var o=n.length-1;o>=0;o--)(a=n[o])&&(r=(e<3?a(r):e>3?a(s,i,r):a(s,i))||r);return e>3&&r&&Object.defineProperty(s,i,r),r}function qi(n,s){var i={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},t,e,r,a;return a={next:o(0),throw:o(1),return:o(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function o(l){return function(_){return c([l,_])}}function c(l){if(t)throw new TypeError("Generator is already executing.");for(;a&&(a=0,l[0]&&(i=0)),i;)try{if(t=1,e&&(r=l[0]&2?e.return:l[0]?e.throw||((r=e.return)&&r.call(e),0):e.next)&&!(r=r.call(e,l[1])).done)return r;switch(e=0,r&&(l=[l[0]&2,r.value]),l[0]){case 0:case 1:r=l;break;case 4:return i.label++,{value:l[1],done:!1};case 5:i.label++,e=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(r=i.trys,!(r=r.length>0&&r[r.length-1])&&(l[0]===6||l[0]===2)){i=0;continue}if(l[0]===3&&(!r||l[1]>r[0]&&l[1]<r[3])){i.label=l[1];break}if(l[0]===6&&i.label<r[1]){i.label=r[1],r=l;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(l);break}r[2]&&i.ops.pop(),i.trys.pop();continue}l=s.call(n,i)}catch(_){l=[6,_],e=0}finally{t=r=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function Mh(n,s){for(var i=0;i<s.length;i++){var t=s[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function Yi(n,s,i){return s&&Mh(n.prototype,s),n}var $n=function(){function n(i,t,e,r){t===void 0&&(t=0),r===void 0&&(r=!0),this.data=i,this._dataView=new DataView(i.buffer,i.byteOffset+t,e??i.byteLength-t),this._littleEndian=r,this._position=0,this._baseOffset=t}var s=n.prototype;return s.nextUint8=function(){var t=this._dataView.getUint8(this._position);return this._position+=1,t},s.nextUint16=function(){var t=this._dataView.getUint16(this._position,this._littleEndian);return this._position+=2,t},s.nextUint32=function(){var t=this._dataView.getUint32(this._position,this._littleEndian);return this._position+=4,t},s.nextInt32=function(){var t=this._dataView.getInt32(this._position,this._littleEndian);return this._position+=4,t},s.nextInt32Array=function(t){var e=new Int32Array(this.data.buffer,this._position+this._dataView.byteOffset,t);return this._position+=4*t,e},s.nextFloat32=function(){var t=this._dataView.getFloat32(this._position,this._littleEndian);return this._position+=4,t},s.nextFloat32Array=function(t){var e=new Float32Array(this.data.buffer,this._position+this._dataView.byteOffset,t);return this._position+=4*t,e},s.nextUint32Array=function(t){var e=new Uint32Array(this.data.buffer,this._position+this._dataView.byteOffset,t);return this._position+=4*t,e},s.nextUint8Array=function(t){var e=new Uint8Array(this.data.buffer,this._position+this._dataView.byteOffset,t);return this._position+=t,e},s.nextUint64=function(){var t=this._dataView.getUint32(this._position,this._littleEndian),e=this._dataView.getUint32(this._position+4,this._littleEndian),r=t+Math.pow(2,32)*e;return this._position+=8,r},s.nextStr=function(){var t=this.nextUint16(),e=new Uint8Array(this.data.buffer,this._position+this._dataView.byteOffset,t);return this._position+=t,Ue.decodeText(e)},s.nextImageData=function(t){return new Uint8Array(this.data.buffer,this.data.byteOffset+this._position)},s.nextImagesData=function(t){for(var e=new Array(t),r=0;r<t;r++){var a=this._dataView.getUint32(this._position,this._littleEndian);e[r]=a,this._position+=4}for(var o=[],c=0;c<t;c++){var l=e[c],_=new Uint8Array(this.data.buffer,this._dataView.byteOffset+this._position,l);this._position+=l,o.push(_)}return o},s.skip=function(t){return this._position+=t,this},s.scan=function(t,e){e===void 0&&(e=0);for(var r=this._position,a=0;this._dataView.getUint8(this._position)!==e&&a<t;)a++,this._position++;return a<t&&this._position++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+r,a)},Yi(n,[{key:"position",get:function(){return this._position}},{key:"offset",get:function(){return this._position+this._baseOffset}}]),n}(),Kc={};function Uo(n){return function(s){Kc[n]=s}}var Ph=function(){function n(){this.totalLength=0,this.version=0,this.type="",this.name="",this.headerLength=0}return n.decode=function(i){var t=new DataView(i),e=t.getUint32(0,!0),r=t.getUint8(4),a=t.getUint16(5,!0),o=new Uint8Array(i,7,a),c=t.getUint16(7+a,!0),l=new Uint8Array(i,9+a,c),_=Ue.decodeText(l),u=Ue.decodeText(o),h=new n;return h.totalLength=e,h.name=_,h.type=u,h.version=r,h.headerLength=l.byteLength+o.byteLength+9,h},Yi(n,[{key:"dataLength",get:function(){return this.totalLength-this.headerLength}}]),n}(),gs=function(){function n(){}return n.decode=function(i,t){return new Promise(function(e){var r=new dt(i),a=t.nextStr(),o=JSON.parse(a);o.bounds&&r.bounds.copyFrom(o.bounds);var c=Math.ceil(t.offset/4)*4+t.data.byteOffset,l=t.data.buffer,_=new Float32Array(l,o.positions.start+c,(o.positions.end-o.positions.start)/4),u=_.length/3,h=ui(_,u);if(r.setPositions(h),o.normals){var d=new Float32Array(l,o.normals.start+c,(o.normals.end-o.normals.start)/4),f=ui(d,u);r.setNormals(f)}if(o.uvs){var v=new Float32Array(l,o.uvs.start+c,(o.uvs.end-o.uvs.start)/4);r.setUVs(yn(v,u))}if(o.uv1){var p=new Float32Array(l,o.uv1.start+c,(o.uv1.end-o.uv1.start)/4);r.setUVs(yn(p,u),1)}if(o.uv2){var g=new Float32Array(l,o.uv2.start+c,(o.uv2.end-o.uv2.start)/4);r.setUVs(yn(g,u),2)}if(o.uv3){var y=new Float32Array(l,o.uv3.start+c,(o.uv3.end-o.uv3.start)/4);r.setUVs(yn(y,u),3)}if(o.uv4){var m=new Float32Array(l,o.uv4.start+c,(o.uv4.end-o.uv4.start)/4);r.setUVs(yn(m,u),4)}if(o.uv5){var x=new Float32Array(l,o.uv5.start+c,(o.uv5.end-o.uv5.start)/4);r.setUVs(yn(x,u),5)}if(o.uv6){var C=new Float32Array(l,o.uv6.start+c,(o.uv6.end-o.uv6.start)/4);r.setUVs(yn(C,u),6)}if(o.uv7){var b=new Float32Array(l,o.uv7.start+c,(o.uv7.end-o.uv7.start)/4);r.setUVs(yn(b,u),7)}if(o.colors){var A=new Float32Array(l,o.colors.start+c,(o.colors.end-o.colors.start)/4);r.setColors(Bh(A,u))}if(o.boneWeights){var S=new Float32Array(l,o.boneWeights.start+c,(o.boneWeights.end-o.boneWeights.start)/4);r.setBoneWeights($i(S,u))}if(o.boneIndices){var w=new Float32Array(l,o.boneIndices.start+c,(o.boneIndices.end-o.boneIndices.start)/4);r.setBoneIndices($i(w,u))}if(o.blendShapes&&o.blendShapes.forEach(function(P){var M=new Mo(P.name);P.frames.forEach(function(D){var L=new Float32Array(l,D.deltaPosition.start+c,(D.deltaPosition.end-D.deltaPosition.start)/4),V=L.length/3,N=ui(L,V);if(D.deltaNormals){var I=new Float32Array(l,D.deltaNormals.start+c,(D.deltaNormals.end-D.deltaNormals.start)/4);ui(I,V)}if(D.deltaTangents){var B=new Float32Array(l,D.deltaTangents.start+c,(D.deltaTangents.end-D.deltaTangents.start)/4);$i(B,V)}M.addFrame(D.weight,N)}),r.addBlendShape(M)}),o.indices){var E=null;o.indices.type===0?E=new Uint16Array(l,o.indices.start+c,(o.indices.end-o.indices.start)/2):E=new Uint32Array(l,o.indices.start+c,(o.indices.end-o.indices.start)/4),r.setIndices(E)}o.subMeshes.forEach(function(P){return r.addSubMesh(P)}),r.uploadData(!1),e(r)})},n}();gs=le([Uo("Mesh")],gs);function Bh(n,s){for(var i=new Array(s),t=0;t<s;t++)i[t]=new q(n[t*4],n[t*4+1],n[t*4+2],n[t*4+3]);return i}function $i(n,s){for(var i=new Array(s),t=0;t<s;t++)i[t]=new ie(n[t*4],n[t*4+1],n[t*4+2],n[t*4+3]);return i}function ui(n,s){for(var i=new Array(s),t=0;t<s;t++)i[t]=new R(n[t*3],n[t*3+1],n[t*3+2]);return i}function yn(n,s){for(var i=new Array(s),t=0;t<s;t++)i[t]=new ee(n[t*2],n[t*2+1]);return i}var ms=function(){function n(){}return n.decode=function(i,t){return new Promise(function(e,r){var a=t.nextStr(),o=!!t.nextUint8(),c=t.nextUint8(),l=t.nextUint8(),_=t.nextUint8(),u=t.nextUint8(),h=t.nextUint8(),d=t.nextUint16(),f=t.nextUint16(),v=t.nextUint8(),p=t.nextUint8(),g=t.nextImagesData(p),y=new Tt(i,d,f,h,o);if(y.filterMode=c,y.anisoLevel=l,y.wrapModeU=_,y.wrapModeV=u,v){var m=g[0];if(y.setPixelBuffer(m),o){y.generateMipmaps();for(var x=1;x<p;x++){var C=g[x];y.setPixelBuffer(C,x)}}i.resourceManager._objectPool[a]=y,e(y)}else{var b=new window.Blob([g[0]]),A=new Image;A.onload=function(){y.setImageSource(A);var S=0,w=function(){S++,S>=p&&e(y)};if(w(),o){var E=function(M){var D=new window.Blob([g[M]]),L=new Image;L.onload=function(){y.setImageSource(L,M),w()},L.src=URL.createObjectURL(D)};y.generateMipmaps();for(var P=1;P<p;P++)E(P)}},A.src=URL.createObjectURL(b)}})},n}();ms=le([Uo("Texture2D")],ms);function Dh(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function di(n,s,i){return Dh()?di=Reflect.construct:di=function(e,r,a){var o=[null];o.push.apply(o,r);var c=Function.bind.apply(e,o),l=new c;return a&&Vi(l,a.prototype),l},di.apply(null,arguments)}var ko=function(){function n(i){this._context=i}var s=n.prototype;return s.parseEntity=function(t){return this._getEntityByConfig(t).then(function(e){var r;e.isActive=(r=t.isActive)!=null?r:!0;var a=t.position,o=t.rotation,c=t.scale;a&&e.transform.position.copyFrom(a),o&&e.transform.rotation.copyFrom(o),c&&e.transform.scale.copyFrom(c);var l;return e.layer=(l=t.layer)!=null?l:e.layer,e})},s.parseClassObject=function(t){var e=this,r=Be.getClass(t.class),a,o=(a=t.constructParams)!=null?a:[];return Promise.all(o.map(function(c){return e.parseBasicType(c)})).then(function(c){return di(r,[].concat(c))}).then(function(c){return e.parsePropsAndMethods(c,t)})},s.parsePropsAndMethods=function(t,e){var r=[];if(e.methods)for(var a in e.methods)for(var o=e.methods[a],c=0,l=o.length;c<l;c++)r.push(this.parseMethod(t,a,o[c]));if(e.props){var _=this,u=function(d){var f=e.props[d],v=_.parseBasicType(f,t[d]).then(function(p){return t[d]=p});r.push(v)};for(var h in e.props)u(h)}return Promise.all(r).then(function(){var d=n.customParseComponentHandles[t.constructor.name];return d?d(t,e):t})},s.parseMethod=function(t,e,r){var a=this;return Promise.all(r.map(function(o){return a.parseBasicType(o)})).then(function(o){var c;return(c=t)[e].apply(c,[].concat(o))})},s.parseBasicType=function(t,e){var r=this;if(Array.isArray(t))return Promise.all(t.map(function(_){return r.parseBasicType(_)}));if(typeof t=="object"&&t!=null){if(n._isClass(t))return this.parseClassObject(t);if(n._isAssetRef(t))return this._context.resourceManager.getResourceByRef(t);if(n._isEntityRef(t))return Promise.resolve(this._context.entityMap.get(t.entityId));if(e){var a=this,o=function(_){if(_==="methods"){var u=t[_];for(var h in u)for(var d=u[h],f=0,v=d.length;f<v;f++){var p=d[f],g=a.parseMethod(e,h,p);c.push(g)}}else c.push(a.parseBasicType(t[_],e[_]).then(function(y){return e[_]=y}))},c=[];for(var l in t)o(l);return Promise.all(c).then(function(){return e})}}return Promise.resolve(t)},s._getEntityByConfig=function(t){var e=t.assetRefId,r=this._context.engine;if(e)return r.resourceManager.getResourceByRef({refId:e,key:t.key,isClone:t.isClone}).then(function(o){return o.name=t.name,o});var a=new Yt(r,t.name);return Promise.resolve(a)},n.registerCustomParseComponent=function(t,e){this.customParseComponentHandles[t]=e},n._isClass=function(t){return t.class!=null},n._isAssetRef=function(t){return t.refId!=null},n._isEntityRef=function(t){return t.entityId!=null},n}();(function(){ko.customParseComponentHandles=new Map})();var Jc=function(){function n(i,t,e){this.originalData=i,this.engine=t,this.target=e,this.entityMap=new Map,this.components=new Map,this.assets=new Map,this.entityConfigMap=new Map,this.rootIds=[],this.strippedIds=[],this.resourceManager=t.resourceManager}var s=n.prototype;return s.destroy=function(){this.entityMap.clear(),this.components.clear(),this.assets.clear(),this.entityConfigMap.clear(),this.rootIds.length=0},n}();function ys(n,s){(s==null||s>n.length)&&(s=n.length);for(var i=0,t=new Array(s);i<s;i++)t[i]=n[i];return t}function Lh(n,s){if(n){if(typeof n=="string")return ys(n,s);var i=Object.prototype.toString.call(n).slice(8,-1);if(i==="Object"&&n.constructor&&(i=n.constructor.name),i==="Map"||i==="Set")return Array.from(i);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return ys(n,s)}}function ia(n,s){var i=typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(i)return(i=i.call(n)).next.bind(i);if(Array.isArray(n)||(i=Lh(n))||s){i&&(n=i);var t=0;return function(){return t>=n.length?{done:!0}:{done:!1,value:n[t++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var Vh=function(){function n(i){var t=this;this.context=i,this.prefabContextMap=new WeakMap,this.prefabPromiseMap=new Map,this._engine=this.context.engine,this._organizeEntities=this._organizeEntities.bind(this),this._parseComponents=this._parseComponents.bind(this),this._parsePrefabModification=this._parsePrefabModification.bind(this),this._parsePrefabRemovedEntities=this._parsePrefabRemovedEntities.bind(this),this._parsePrefabRemovedComponents=this._parsePrefabRemovedComponents.bind(this),this._clearAndResolve=this._clearAndResolve.bind(this),this.promise=new Promise(function(e,r){t._reject=r,t._resolve=e}),this._reflectionParser=new ko(i)}var s=n.prototype;return s.start=function(){this._parseEntities().then(this._organizeEntities).then(this._parseComponents).then(this._parsePrefabModification).then(this._parsePrefabRemovedEntities).then(this._parsePrefabRemovedComponents).then(this._clearAndResolve).then(this._resolve).catch(this._reject)},s._parseEntities=function(){var t=this,e=this.context.originalData.entities,r=this.context.entityConfigMap,a=this.context.entityMap,o=this._engine,c=e.map(function(l){var _,u=(_=l.strippedId)!=null?_:l.id;return l.id=u,r.set(u,l),t._getEntityByConfig(l,o)});return Promise.all(c).then(function(l){for(var _=0,u=l.length;_<u;_++)a.set(e[_].id,l[_]);return l})},s._parseComponents=function(){for(var t=this.context.originalData.entities,e=this.context.entityMap,r=this.context.components,a=[],o=0,c=t.length;o<c;o++)for(var l=t[o],_=e.get(l.id),u=0;u<l.components.length;u++){var h=l.components[u],d=h.refId?h.refId:h.class,f=_.addComponent(Be.getClass(d));r.set(h.id,f);var v=this._reflectionParser.parsePropsAndMethods(f,h);a.push(v)}return Promise.all(a)},s._parsePrefabModification=function(){for(var t=function(_,u){var h,d=r[_],f=d.id,v=d.modifications;if((h=v)!=null&&h.length){var p,g=a.get(f);(p=o).push.apply(p,[].concat(v.map(function(y){var m=y.target,x=y.props,C=y.methods,b=m.entityId,A=m.componentId,S=e.prefabContextMap.get(g),w=S.entityMap.get(b),E=S.components.get(A);if(E)return e._reflectionParser.parsePropsAndMethods(E,{props:x,methods:C});if(w)return Promise.resolve(e._applyEntityData(w,x))})))}},e=this,r=this.context.originalData.entities,a=this.context.entityMap,o=[],c=0,l=r.length;c<l;c++)t(c);return Promise.all(o)},s._parsePrefabRemovedEntities=function(){for(var t=function(_,u){var h,d=r[_],f=d.id,v=d.removedEntities;if((h=v)!=null&&h.length){var p,g=a.get(f);(p=o).push.apply(p,[].concat(v.map(function(y){var m=y.entityId,x=e.prefabContextMap.get(g),C=x.entityMap.get(m);C&&C.destroy()})))}},e=this,r=this.context.originalData.entities,a=this.context.entityMap,o=[],c=0,l=r.length;c<l;c++)t(c);return Promise.all(o)},s._parsePrefabRemovedComponents=function(){for(var t=function(_,u){var h,d=r[_],f=d.id,v=d.removedComponents;if((h=v)!=null&&h.length){var p,g=a.get(f);(p=o).concat.apply(p,[].concat(v.map(function(y){var m=y.componentId,x=e.prefabContextMap.get(g),C=x.components.get(m);C&&C.destroy()})))}},e=this,r=this.context.originalData.entities,a=this.context.entityMap,o=[],c=0,l=r.length;c<l;c++)t(c);return Promise.all(o)},s._clearAndResolve=function(){var t=this.context.target;return t},s._organizeEntities=function(){for(var t=this.context,e=t.rootIds,r=t.strippedIds,a=e.concat(r),o=ia(a),c;!(c=o()).done;){var l=c.value;this._parseChildren(l)}for(var _=0;_<e.length;_++)this.handleRootEntity(e[_])},s._getEntityByConfig=function(t,e){var r=this,a;return t.assetRefId?a=this._parseGLTF(t,e):t.strippedId?a=this._parseStrippedEntity(t):a=this._parseEntity(t,e),a.then(function(o){return r._applyEntityData(o,t)})},s._parseEntity=function(t,e){var r=new Yt(e,t.name);return t.parent||this.context.rootIds.push(t.id),Promise.resolve(r)},s._parseGLTF=function(t,e){var r=this,a=t.assetRefId,o=new Jc(null,e);return e.resourceManager.getResourceByRef({refId:a}).then(function(c){var l=c.instantiateSceneRoot();t.parent||r.context.rootIds.push(t.id),r._traverseAddEntityToMap(l,o,""),r.prefabContextMap.set(l,o);var _=r.prefabPromiseMap.get(t.id);return _&&_.forEach(function(u){u.resolve(o)}),l})},s._parseStrippedEntity=function(t){var e=this;return this.context.strippedIds.push(t.id),new Promise(function(r,a){var o,c=(o=e.prefabPromiseMap.get(t.prefabInstanceId))!=null?o:[];c.push({resolve:r,reject:a}),e.prefabPromiseMap.set(t.prefabInstanceId,c)}).then(function(r){var a=t.prefabSource.entityId;return r.entityMap.get(a)})},s._parseChildren=function(t){var e=this.context,r=e.entityConfigMap,a=e.entityMap,o=r.get(t).children;if(o&&o.length>0)for(var c=a.get(t),l=0;l<o.length;l++){var _=o[l],u=a.get(_);c.addChild(u),this._parseChildren(_)}},s._applyEntityData=function(t,e){e===void 0&&(e={});var r;t.isActive=(r=e.isActive)!=null?r:t.isActive;var a;t.name=(a=e.name)!=null?a:t.name;var o=e.position,c=e.rotation,l=e.scale,_=e.layer;return o&&t.transform.position.copyFrom(o),c&&t.transform.rotation.copyFrom(c),l&&t.transform.scale.copyFrom(l),_&&(t.layer=_),t},s._traverseAddEntityToMap=function(t,e,r){var a=e.entityMap,o=e.components,c={},l={};a.set(r,t),t._components.forEach(function(f){var v=Be.getClassName(f.constructor);c[v]||(c[v]=t.getComponents(f.constructor,[]),l[v]=0),o.set(r+":"+v+"/"+l[v]++,f)});for(var _=0,u=t.children.length;_<u;_++){var h=t.children[_],d=r?r+"/"+_:""+_;this._traverseAddEntityToMap(h,e,d)}},n}(),xs;(function(n){n[n.Float=0]="Float",n[n.FloatArray=1]="FloatArray",n[n.Vector2=2]="Vector2",n[n.Vector3=3]="Vector3",n[n.Vector4=4]="Vector4",n[n.Quaternion=5]="Quaternion",n[n.Color=6]="Color",n[n.Array=7]="Array",n[n.Boolean=8]="Boolean",n[n.Rect=9]="Rect",n[n.ReferResource=10]="ReferResource"})(xs||(xs={}));var bs=function(){function n(){}return n.decode=function(i,t){return new Promise(function(e){for(var r=t.nextStr(),a=new Vo(r),o=t.nextUint16(),c=0;c<o;++c){var l=new ji;l.time=t.nextFloat32(),l.functionName=t.nextStr(),l.parameter=JSON.parse(t.nextStr()).val,a.addEvent(l)}for(var _=t.nextUint16(),u=0;u<_;++u){var h=t.nextStr(),d=t.nextStr(),f=Be.getClass(d),v=t.nextStr(),p=t.nextStr(),g=void 0,y=t.nextUint8(),m=t.nextUint16(),x=t.nextStr();switch(x){case"AnimationFloatCurve":{g=new wi,g.interpolation=y;for(var C=0;C<m;++C){var b=new Ft;b.time=t.nextFloat32(),b.value=t.nextFloat32(),b.inTangent=t.nextFloat32(),b.outTangent=t.nextFloat32(),g.addKey(b)}break}case"AnimationArrayCurve":{g=new Ci,g.interpolation=y;for(var A=0;A<m;++A){var S=new Ft;S.time=t.nextFloat32();var w=t.nextUint16();S.value=Array.from(t.nextFloat32Array(w)),S.inTangent=Array.from(t.nextFloat32Array(w)),S.outTangent=Array.from(t.nextFloat32Array(w)),g.addKey(S)}break}case"AnimationFloatArrayCurve":{g=new Na,g.interpolation=y;for(var E=0;E<m;++E){var P=new Ft;P.time=t.nextFloat32();var M=t.nextUint16();P.value=t.nextFloat32Array(M),P.inTangent=Array.from(t.nextFloat32Array(M)),P.outTangent=Array.from(t.nextFloat32Array(M)),g.addKey(P)}break}case"AnimationVector2Curve":{g=new Ti,g.interpolation=y;for(var D=0;D<m;++D){var L=new Ft;L.time=t.nextFloat32(),L.value=new ee(t.nextFloat32(),t.nextFloat32()),L.inTangent=new ee(t.nextFloat32(),t.nextFloat32()),L.outTangent=new ee(t.nextFloat32(),t.nextFloat32()),g.addKey(L)}break}case"AnimationVector3Curve":{g=new Ia,g.interpolation=y;for(var V=0;V<m;++V){var N=new Ft;N.time=t.nextFloat32(),N.value=new R(t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),N.inTangent=new R(t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),N.outTangent=new R(t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),g.addKey(N)}break}case"AnimationVector4Curve":{g=new Ri,g.interpolation=y;var I=new Ft;I.time=t.nextFloat32(),I.value=new ie(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),I.inTangent=new ie(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),I.outTangent=new ie(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),g.addKey(I);break}case"AnimationColorCurve":{g=new Ei,g.interpolation=y;for(var B=0;B<m;++B){var z=new Ft;z.time=t.nextFloat32(),z.value=new q(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),z.inTangent=new ie(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),z.outTangent=new ie(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),g.addKey(z)}break}case"AnimationQuaternionCurve":{g=new fa,g.interpolation=y;for(var U=0;U<m;++U){var Y=new Ft;Y.time=t.nextFloat32(),Y.value=new Re(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),Y.inTangent=new ie(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),Y.outTangent=new ie(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),g.addKey(Y)}break}case"AnimationRefCurve":{g=new Mi,g.interpolation=y;for(var Q=0;Q<m;++Q){var H=new Ft;H.time=t.nextFloat32();var te=t.nextStr();te?H.value=JSON.parse(te):H.value=null,g.addKey(H)}break}case"AnimationBoolCurve":{g=new Ai,g.interpolation=y;for(var Ce=0;Ce<m;++Ce){var de=new Ft;de.time=t.nextFloat32(),de.value=t.nextUint8()===1,g.addKey(de)}break}case"AnimationStringCurve":{g=new Pi,g.interpolation=y;for(var ae=0;ae<m;++ae){var Ae=new Ft;Ae.time=t.nextFloat32(),Ae.value=t.nextStr(),g.addKey(Ae)}break}}a.addCurveBinding(h,f,v,p,g)}e(a)})},n}();bs=le([Uo("AnimationClip")],bs);var mo;(function(n){n.Sky="Sky",n.Custom="Custom"})(mo||(mo={}));var Fh=function(n){ne(s,n);function s(i,t,e){var r;return r=n.call(this,i,t,e)||this,r.originalData=i,r.engine=t,r.scene=e,r}return s}(Jc),Nh=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.handleRootEntity=function(e){var r=this.context,a=r.target,o=r.entityMap;a.addRootEntity(o.get(e))},s.parse=function(e,r){var a=new Wa(e),o=new Fh(r,e,a),c=new s(o);return c.start(),c.promise},s}(Vh),Ss=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Pe(function(o,c){a.request(e.url,{type:"arraybuffer"}).then(function(l){Qi(l,r.engine).then(function(_){o(_)})}).catch(c)})},s}(Be);Ss=le([Xe("Mesh",["prefab"],!0)],Ss);var Cs=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Pe(function(o,c){a.request(e.url,{type:"arraybuffer"}).then(function(l){Qi(l,r.engine).then(function(_){o(_)})}).catch(c)})},s}(Be);Cs=le([Xe("EditorTexture2D",["prefab"],!0)],Cs);function Qi(n,s){var i=Ph.decode(n),t=new $n(new Uint8Array(n),i.headerLength,i.dataLength);return Kc[i.type].decode(s,t).then(function(e){return e.name=i.name,e})}var As=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Pe(function(o,c){a.request(e.url,Bt({},e,{type:"arraybuffer"})).then(function(l){return Qi(l,r.engine).then(function(_){var u=_.curveBindings.map(function(h){var d=h.curve,f=d.keys.map(function(v){return a._parseKeyframeValue(v,r).then(function(p){v.value=p})});return Promise.all(f)});return Promise.all(u).then(function(){o(_)})}).catch(c)}).catch(c)})},i._parseKeyframeValue=function(e,r){var a,o=e.value;return typeof o=="object"&&((a=o)!=null&&a.refId)?new Promise(function(c){r.getResourceByRef(o).then(function(l){e.value=l,c(e.value)})}):Promise.resolve(e.value)},s}(Be);As=le([Xe(Ve.AnimationClip,["ani"])],As);var Es=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Pe(function(o,c){a.request(e.url,Bt({},e,{type:"json"})).then(function(l){var _=new No,u=l.layers,h=[];u.forEach(function(d,f){var v=d.name,p=d.blendingMode,g=d.weight,y=d.stateMachine,m=new Io(v);if(m.blendingMode=p,m.weight=g,y){var x=y.states,C=m.stateMachine=new Oo;x.forEach(function(b,A){var S,w=b.name,E=b.speed,P=b.wrapMode,M=b.clipStartNormalizedTime,D=b.clipEndNormalizedTime,L=b.isDefaultState,V=b.clip,N=b.scripts,I=C.addState(w);L&&(C.defaultState=I),I.speed=E,I.wrapMode=P,I.clipStartTime=M,I.clipEndTime=D;var B=JSON.parse(N);(S=B)==null||S.forEach(function(z){I.addStateMachineScript(Be.getClass(z))}),V&&h.push(new Promise(function(z){r.getResourceByRef(V).then(function(U){z({layerIndex:f,stateIndex:A,clip:U})})}))}),x.forEach(function(b){var A=b.name,S=b.transitions;S.forEach(function(w){var E=w.targetStateName,P=w.duration,M=w.offset,D=w.exitTime,L=C.findStateByName(A),V=C.findStateByName(E),N=new Fo;N.destinationState=V,N.duration=P,N.exitTime=D,N.offset=M,L.addTransition(N)})})}_.addLayer(m)}),Promise.all(h).then(function(d){d.forEach(function(f){var v=f.layerIndex,p=f.stateIndex,g=f.clip;_.layers[v].stateMachine.states[p].clip=g}),o(_)})}).catch(c)})},s}(Be);Es=le([Xe(Ve.AnimatorController,["json"],!1)],Es);function Ih(n){return/^data:(.+?);base64,/.test(n)}var ws=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e){var r=e.url;return Ih(r)?new Pe(function(a){var o=r.slice(13+RegExp.$1.length),c=Uint8Array.from(atob(o),function(l){return l.charCodeAt(0)});a(c.buffer)}):this.request(r,Bt({},e,{type:"arraybuffer"}))},s}(Be);ws=le([Xe(Ve.Buffer,["bin","r3bin"],!1)],ws);var Ts=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Pe(function(o,c){a.request(e.url,{type:"arraybuffer"}).then(function(l){var _,u=new Float32Array(l,0,27),h=27*4,d=(_=new Uint16Array(l,h,1))==null?void 0:_[0],f=r.engine,v=new jt(f,d);v.filterMode=tt.Trilinear;for(var p=v.mipmapCount,g=h+2,y=0;y<p;y++)for(var m=d>>y,x=0;x<6;x++){var C=m*m*4,b=new Uint8Array(l,g,C);g+=C,v.setPixelBuffer(wr.PositiveX+x,b,y)}var A=new Tr(f),S=new sl;A.diffuseMode=Xn.SphericalHarmonics,S.copyFromArray(u),A.diffuseSphericalHarmonics=S,A.specularTexture=v,A.specularTextureDecodeRGBM=!0,o(A)}).catch(function(l){c(l)})})},s}(Be);Ts=le([Xe(Ve.Env,["env"])],Ts);function Rs(n,s,i,t,e,r,a){try{var o=n[r](a),c=o.value}catch(l){i(l);return}o.done?s(c):Promise.resolve(c).then(t,e)}function Ki(n){return function(){var s=this,i=arguments;return new Promise(function(t,e){var r=n.apply(s,i);function a(c){Rs(r,t,e,a,o,"next",c)}function o(c){Rs(r,t,e,a,o,"throw",c)}a(void 0)})}}var Ms=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Pe(function(o,c){a.request(e.url,{type:"json"}).then(function(l){var _=l.fontName,u=l.fontUrl;if(u)a._registerFont(_,u).then(function(){var d=new _a(r.engine,_);o(d)}).catch(function(d){c("load font "+u+" fail")});else{var h=new _a(r.engine,_);o(h)}}).catch(function(l){c(l)})})},i._registerFont=function(e,r){return Ki(function(){var a;return qi(this,function(o){switch(o.label){case 0:return a=new FontFace(e,"url("+r+")"),[4,a.load()];case 1:return o.sent(),document.fonts.add(a),[2]}})})()},s}(Be);Ms=le([Xe(Ve.Font,["font"],!1)],Ms);var Oh=function(n){ne(s,n);function s(t,e){var r;return r=n.call(this,t)||this,r.url=e,r}var i=s.prototype;return i.instantiateSceneRoot=function(e){var r=e===void 0?this._defaultSceneRoot:this._sceneRoots[e];return r.clone()},i._onDestroy=function(){n.prototype._onDestroy.call(this);var e=this,r=e.textures,a=e.materials,o=e.meshes;if(r&&this._disassociationSuperResource(r),a&&this._disassociationSuperResource(a),o)for(var c=0,l=o.length;c<l;c++)this._disassociationSuperResource(o[c])},i._disassociationSuperResource=function(e){for(var r=0,a=e.length;r<a;r++)e[r]._disassociationSuperResource(this)},Yi(s,[{key:"extensionsData",get:function(){return this._extensionsData}},{key:"sceneRoots",get:function(){return this._sceneRoots}},{key:"defaultSceneRoot",get:function(){return this._defaultSceneRoot}}]),s}(Qr),ot;(function(n){n[n.BYTE=5120]="BYTE",n[n.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",n[n.SHORT=5122]="SHORT",n[n.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",n[n.UNSIGNED_INT=5125]="UNSIGNED_INT",n[n.FLOAT=5126]="FLOAT"})(ot||(ot={}));var en;(function(n){n.SCALAR="SCALAR",n.VEC2="VEC2",n.VEC3="VEC3",n.VEC4="VEC4",n.MAT2="MAT2",n.MAT3="MAT3",n.MAT4="MAT4"})(en||(en={}));var Dr;(function(n){n.TRANSLATION="translation",n.ROTATION="rotation",n.SCALE="scale",n.WEIGHTS="weights"})(Dr||(Dr={}));var ta;(function(n){n.Linear="LINEAR",n.Step="STEP",n.CubicSpine="CUBICSPLINE"})(ta||(ta={}));var Fi;(function(n){n.PERSPECTIVE="perspective",n.ORTHOGRAPHIC="orthographic"})(Fi||(Fi={}));var Ps;(function(n){n.JPEG="image/jpeg",n.PNG="image/png"})(Ps||(Ps={}));var Aa;(function(n){n.OPAQUE="OPAQUE",n.MASK="MASK",n.BLEND="BLEND"})(Aa||(Aa={}));var yo;(function(n){n[n.NEAREST=9728]="NEAREST",n[n.LINEAR=9729]="LINEAR"})(yo||(yo={}));var Ni;(function(n){n[n.NEAREST=9728]="NEAREST",n[n.LINEAR=9729]="LINEAR",n[n.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",n[n.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",n[n.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",n[n.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(Ni||(Ni={}));var Ea;(function(n){n[n.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",n[n.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",n[n.REPEAT=10497]="REPEAT"})(Ea||(Ea={}));var Go=function(){function n(i,t,e){var r=this;this.glTFResource=i,this.resourceManager=t,this.params=e,this.accessorBufferCache={},this.needAnimatorController=!1,this._resourceCache=new Map,this._progress={taskDetail:{},taskComplete:{loaded:0,total:0}},this._onTaskDetail=function(a,o,c){var l,_,u=(l=r._progress.taskDetail)[_=a]||(l[_]={});u.loaded=o,u.total=c,r._setTaskDetailProgress(a,o,c)},this.contentRestorer=new jh(i)}var s=n.prototype;return s.get=function(t,e){var r=this,a=n._parsers[t];if(!a)return Promise.resolve(null);var o=this._resourceCache,c=e===void 0?""+t:t+":"+e,l=o.get(c);if(l)return l;var _=zh[t],u=!!Bs[t];if(_){var h=this.glTF[_];h&&(e===void 0||h[e])?e===void 0?l=t===8?h.map(function(d,f){return r.get(t,f)}):Promise.all(h.map(function(d,f){return r.get(t,f)})):(l=a.parse(this,e),u&&this._handleSubAsset(l,t,e)):l=Promise.resolve(null)}else l=a.parse(this,e),u&&this._handleSubAsset(l,t,e);return o.set(c,l),l},s.parse=function(){var t=this,e=this.get(0).then(function(r){return t.glTF=r,t.needAnimatorController=!!(r.skins||r.animations),Promise.all([t.get(1),t.get(5),t.get(6),t.get(7),t.get(9),t.get(10),t.get(11),t.get(2)]).then(function(){var a=t.glTFResource,o=a.animatorController;if(o){var c=a._defaultSceneRoot.addComponent(Kr);c.animatorController=o}return t.resourceManager.addContentRestorer(t.contentRestorer),a})});return this._addTaskCompletePromise(e),e},s._addTaskCompletePromise=function(t){var e=this,r=this._progress.taskComplete;r.total+=1,t.then(function(){e._setTaskCompleteProgress(++r.loaded,r.total)})},s._handleSubAsset=function(t,e,r){var a=this,o=Bs[e];if(e===8){var c,l;((c=this.glTFResource)[l=o]||(c[l]=[]))[r]=t}else{var _=this.glTFResource.url;t.then(function(u){if(r==null)a.glTFResource[o]=u;else{var h,d;((h=a.glTFResource)[d=o]||(h[d]=[]))[r]=u}if(e===7)for(var f=0,v=u.length;f<v;f++){var p=u[f];a.resourceManager._onSubAssetSuccess(_+"?q="+o+"["+r+"]["+f+"]",p)}else{a.resourceManager._onSubAssetSuccess(_+"?q="+o+"["+r+"]",u);var g;e===2&&((g=a.glTF.scene)!=null?g:0)===r&&a.resourceManager._onSubAssetSuccess(""+_+"?q=defaultSceneRoot",u)}})}},n.addParser=function(t,e){this._parsers[t]=e},n}();(function(){Go._parsers={}})();var eo=function(s,i,t){this.data=s,this.interleaved=i,this.stride=t,this.vertexBindingInfos={}},pe;(function(n){n[n.Schema=0]="Schema",n[n.Validator=1]="Validator",n[n.Scene=2]="Scene",n[n.Buffer=3]="Buffer",n[n.BufferView=4]="BufferView",n[n.Texture=5]="Texture",n[n.Material=6]="Material",n[n.Mesh=7]="Mesh",n[n.Entity=8]="Entity",n[n.Skin=9]="Skin",n[n.Animation=10]="Animation",n[n.AnimatorController=11]="AnimatorController"})(pe||(pe={}));var Br,zh=(Br={},Br[2]="scenes",Br[3]="buffers",Br[5]="textures",Br[6]="materials",Br[7]="meshes",Br[8]="nodes",Br[9]="skins",Br[10]="animations",Br[4]="bufferViews",Br),Ur,Bs=(Ur={},Ur[2]="_sceneRoots",Ur[5]="textures",Ur[6]="materials",Ur[7]="meshes",Ur[8]="entities",Ur[9]="skins",Ur[10]="animations",Ur[11]="animatorController",Ur);function Rr(n){return function(s){var i=new s;Go.addParser(n,i)}}var Ke=function(){function n(){}return n.floatBufferToVector2Array=function(i){for(var t=i.length,e=new Array(t/2),r=0;r<t;r+=2)e[r/2]=new ee(i[r],i[r+1]);return e},n.floatBufferToVector3Array=function(i){for(var t=i.length,e=new Array(t/3),r=0;r<t;r+=3)e[r/3]=new R(i[r],i[r+1],i[r+2]);return e},n.floatBufferToVector4Array=function(i){for(var t=i.length,e=new Array(t/4),r=0;r<t;r+=4)e[r/4]=new ie(i[r],i[r+1],i[r+2],i[r+3]);return e},n.floatBufferToColorArray=function(i,t){var e=i.length,r=new Array(e/(t?3:4));if(t)for(var a=0;a<e;a+=3)r[a/3]=new q(i[a],i[a+1],i[a+2],1);else for(var o=0;o<e;o+=4)r[o/4]=new q(i[o],i[o+1],i[o+2],i[o+3]);return r},n.getAccessorTypeSize=function(i){switch(i){case en.SCALAR:return 1;case en.VEC2:return 2;case en.VEC3:return 3;case en.VEC4:return 4;case en.MAT2:return 4;case en.MAT3:return 9;case en.MAT4:return 16}},n.getComponentType=function(i){switch(i){case ot.BYTE:return Int8Array;case ot.UNSIGNED_BYTE:return Uint8Array;case ot.SHORT:return Int16Array;case ot.UNSIGNED_SHORT:return Uint16Array;case ot.UNSIGNED_INT:return Uint32Array;case ot.FLOAT:return Float32Array}},n.getNormalizedComponentScale=function(i){switch(i){case ot.BYTE:return 1/127;case ot.UNSIGNED_BYTE:return 1/255;case ot.SHORT:return 1/32767;case ot.UNSIGNED_SHORT:return 1/65535;default:throw new Error("Galacean.GLTFLoader: Unsupported normalized accessor component type.")}},n.getAccessorBuffer=function(i,t,e){var r=e.componentType,a=n.getComponentType(r),o=n.getAccessorTypeSize(e.type),c=a.BYTES_PER_ELEMENT,l=o*c,_=e.count,u;if(e.bufferView!==void 0){var h=e.bufferView,d=t[h];u=i.get(pe.BufferView,e.bufferView).then(function(g){var y=d.buffer,m,x=(m=g.byteOffset)!=null?m:0,C,b=(C=e.byteOffset)!=null?C:0,A=d.byteStride,S;if(A!==void 0&&A!==l){var w=Math.floor(b/A),E=h+":"+r+":"+w+":"+_,P=i.accessorBufferCache;if(S=P[E],!S){var M=x+w*A,D=_*(A/c),L=new a(g.buffer,M,D);P[E]=S=new eo(L,!0,A),S.restoreInfo=new to(new Sa(y,a,M,D))}}else{var V=x+b,N=_*o,I=new a(g.buffer,V,N);S=new eo(I,!1,l),S.restoreInfo=new to(new Sa(y,a,V,N))}return S})}else{var f=_*o,v=new a(f),p=new eo(v,!1,l);p.restoreInfo=new to(new Sa(void 0,a,void 0,f)),u=Promise.resolve(p)}return e.sparse?u.then(function(g){return n.processingSparseData(i,e,g).then(function(){return g})}):u},n.bufferToVector3Array=function(i,t,e,r,a){for(var o=t/i.BYTES_PER_ELEMENT,c=i.length/e,l=new Array(e),_=r?n.getNormalizedComponentScale(a):1,u=0;u<e;u++){var h=o+u*c;l[u]=new R(i[h]*_,i[h+1]*_,i[h+2]*_)}return l},n.getBufferViewData=function(i,t){var e=i.byteOffset,r=e===void 0?0:e,a=t[i.buffer];return a.slice(r,r+i.byteLength)},n.processingSparseData=function(i,t,e){var r=e.restoreInfo,a=i.glTF.bufferViews,o=n.getAccessorTypeSize(t.type),c=n.getComponentType(t.componentType),l=e.data.slice(),_=t.sparse,u=_.count,h=_.indices,d=_.values,f=a[h.bufferView],v=a[d.bufferView];return Promise.all([i.get(pe.BufferView,h.bufferView),i.get(pe.BufferView,d.bufferView)]).then(function(p){var g=p[0],y=p[1],m,x,C=((m=h.byteOffset)!=null?m:0)+((x=g.byteOffset)!=null?x:0),b=g.byteLength,A,S,w=((A=d.byteOffset)!=null?A:0)+((S=y.byteOffset)!=null?S:0),E=y.byteLength;r.typeSize=o,r.sparseCount=u;var P=n.getComponentType(h.componentType),M=b/P.BYTES_PER_ELEMENT,D=new P(g.buffer,C,M);r.sparseIndices=new Sa(f.buffer,P,C,M);var L=E/c.BYTES_PER_ELEMENT,V=new c(y.buffer,w,L);r.sparseValues=new Sa(v.buffer,c,w,L);for(var N=0;N<u;N++)for(var I=D[N],B=0;B<o;B++)l[I*o+B]=V[N*o+B];e.data=l})},n.getIndexFormat=function(i){switch(i){case ot.UNSIGNED_BYTE:return St.UInt8;case ot.UNSIGNED_SHORT:return St.UInt16;case ot.UNSIGNED_INT:return St.UInt32}},n.getElementFormat=function(i,t,e){if(e===void 0&&(e=!1),i==ot.FLOAT)switch(t){case 1:return $.Float;case 2:return $.Vector2;case 3:return $.Vector3;case 4:return $.Vector4}if(i==ot.SHORT)switch(t){case 2:return e?$.NormalizedShort2:$.Short2;case 3:case 4:return e?$.NormalizedShort4:$.Short4}if(i==ot.UNSIGNED_SHORT)switch(t){case 2:return e?$.NormalizedUShort2:$.UShort2;case 3:case 4:return e?$.NormalizedUShort4:$.UShort4}if(i==ot.BYTE)switch(t){case 2:case 3:case 4:return e?$.NormalizedByte4:$.Byte4}if(i==ot.UNSIGNED_BYTE)switch(t){case 2:case 3:case 4:return e?$.NormalizedUByte4:$.UByte4}},n.loadImageBuffer=function(i,t){return new Promise(function(e,r){var a=new window.Blob([i],{type:t}),o=new Image;o.onerror=function(){r(new Error("Failed to load image buffer"))},o.onload=function(){requestAnimationFrame(function(){e(o),o.onload=null,o.onerror=null,o.onabort=null})},o.crossOrigin="anonymous",o.src=URL.createObjectURL(a)})},n.parseGLB=function(i,t){var e=4,r=1179937895,a=12,o={JSON:1313821514,BIN:5130562},c=new DataView(t),l={magic:c.getUint32(0,!0),version:c.getUint32(e,!0),length:c.getUint32(2*e,!0)};if(l.magic!==r)return{originBuffer:t};var _=c.getUint32(a,!0),u=c.getUint32(a+e,!0);if(u!==o.JSON)return console.error("Invalid glb chunk type. Expected 0x4E4F534A, found 0x"+u.toString(16)),null;for(var h=new Uint8Array(t,a+2*e,_),d=JSON.parse(Ue.decodeText(h)),f=[],v=a+2*e+_,p=i.contentRestorer.glbBufferSlices;v<l.length;){if(_=c.getUint32(v,!0),u=c.getUint32(v+e,!0),u!==o.BIN)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+u.toString(16)),null;var g=v+2*e,y=t.slice(g,g+_);f.push(y),p.push(new ee(g,_)),v+=_+2*e}return{glTF:d,buffers:f}},n.parseSampler=function(i,t){var e=t.filterMode,r=t.wrapModeU,a=t.wrapModeV;e!==void 0&&(i.filterMode=e),r!==void 0&&(i.wrapModeU=r),a!==void 0&&(i.wrapModeV=a)},n.getSamplerInfo=function(i){var t=i.minFilter,e=i.magFilter,r=i.wrapS,a=i.wrapT,o={};return(t||e)&&(o.mipmap=t>=Ni.NEAREST_MIPMAP_NEAREST,e===yo.NEAREST?o.filterMode=tt.Point:t<=Ni.LINEAR_MIPMAP_NEAREST?o.filterMode=tt.Bilinear:o.filterMode=tt.Trilinear),r&&(o.wrapModeU=Ii._wrapMap[r]),a&&(o.wrapModeV=Ii._wrapMap[a]),o},n}(),Ds;(function(n){n[n.linear=1]="linear",n[n.sRGB=2]="sRGB"})(Ds||(Ds={}));var Ls;(function(n){n[n.ETC1S=163]="ETC1S",n[n.UASTC=166]="UASTC"})(Ls||(Ls={}));var xo;(function(n){n[n.None=0]="None",n[n.BasisLZ=1]="BasisLZ",n[n.Zstd=2]="Zstd",n[n.ZLib=3]="ZLib"})(xo||(xo={}));var Uh=function(){function n(i){this.vkFormat=0,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=0,this.levels=[],this.keyValue={},this.globalData=null,this.parse(i)}var s=n.prototype;return s.parse=function(t){var e=t.buffer,r=t.byteOffset,a=new $n(t,12);this.vkFormat=a.nextUint32(),this.typeSize=a.nextUint32(),this.pixelWidth=a.nextUint32(),this.pixelHeight=a.nextUint32(),this.pixelDepth=a.nextUint32(),this.layerCount=a.nextUint32(),this.faceCount=a.nextUint32();var o=Math.max(1,a.nextUint32());this.supercompressionScheme=a.nextUint32();var c=a.nextUint32(),l=a.nextUint32(),_=a.nextUint32(),u=a.nextUint32(),h=a.nextUint64(),d=a.nextUint64(),f=new Array(o),v=o*3*8,p=new $n(t,a.offset,v);this.levels=f;for(var g=0;g<o;g++)f[g]={levelData:new Uint8Array(e,r+p.nextUint64(),p.nextUint64()),uncompressedByteLength:p.nextUint64()};var y=new $n(t,c,l),m={vendorId:y.skip(4).nextUint16(),descriptorType:y.nextUint16(),versionNumber:y.nextUint16(),descriptorBlockSize:y.nextUint16(),colorModel:y.nextUint8(),colorPrimaries:y.nextUint8(),transferFunction:y.nextUint8(),flags:y.nextUint8(),texelBlockDimension:[y.nextUint8(),y.nextUint8(),y.nextUint8(),y.nextUint8()],bytesPlane:[y.nextUint8(),y.nextUint8(),y.nextUint8(),y.nextUint8(),y.nextUint8(),y.nextUint8(),y.nextUint8(),y.nextUint8()],samples:[]};this.dataFormatDescriptor=m;for(var x=6,C=4,b=(m.descriptorBlockSize/4-x)/C,A=0;A<b;A++){var S={bitOffset:y.nextUint16(),bitLength:y.nextUint8(),channelType:y.nextUint8(),samplePosition:[y.nextUint8(),y.nextUint8(),y.nextUint8(),y.nextUint8()],sampleLower:-1/0,sampleUpper:1/0};S.channelType&64?(S.sampleLower=y.nextInt32(),S.sampleUpper=y.nextInt32()):(S.sampleLower=y.nextUint32(),S.sampleUpper=y.nextUint32()),m.samples[A]=S}for(var w=new $n(t,_,u,!0);w.position<u;){var E=w.nextUint32(),P=w.scan(E),M=Ue.decodeText(P),D=w.nextUint8Array(E-P.byteLength-1);this.keyValue[M]=M.match(/^ktx/i)?Ue.decodeText(D).replace(/^(.*)\x00$/,"$1"):D;var L=E%4?4-E%4:0;w.skip(L)}if(d<=0)return this;for(var V=new $n(t,h,d,!0),N=V.nextUint16(),I=V.nextUint16(),B=V.nextUint32(),z=V.nextUint32(),U=V.nextUint32(),Y=V.nextUint32(),Q=new Array(o),H=0;H<o;H++)Q[H]={imageFlags:V.nextUint32(),rgbSliceByteOffset:V.nextUint32(),rgbSliceByteLength:V.nextUint32(),alphaSliceByteOffset:V.nextUint32(),alphaSliceByteLength:V.nextUint32()};var te=h+V.position,Ce=te+B,de=Ce+z,ae=de+U,Ae=new Uint8Array(e,r+te,B),je=new Uint8Array(e,r+Ce,z),_t=new Uint8Array(e,r+de,U),xe=new Uint8Array(e,r+ae,Y);this.globalData={endpointCount:N,selectorCount:I,imageDescs:Q,endpointsData:Ae,selectorsData:je,tablesData:_t,extendedData:xe}},Yi(n,[{key:"isSRGB",get:function(){return this.dataFormatDescriptor.transferFunction===2}},{key:"isUASTC",get:function(){return this.dataFormatDescriptor.colorModel===166}}]),n}(),Le;(function(n){n[n.ASTC=0]="ASTC",n[n.BC7=1]="BC7",n[n.BC1_BC3=2]="BC1_BC3",n[n.PVRTC=3]="PVRTC",n[n.ETC=4]="ETC",n[n.R8=5]="R8",n[n.R8G8=6]="R8G8",n[n.R8G8B8A8=7]="R8G8B8A8"})(Le||(Le={}));var kh=function(){function n(i,t){i===void 0&&(i=4),this.limitedCount=i,this._workerCreator=t,this._taskQueue=[],this._workerStatus=0,this._workerItems=new Array(i)}var s=n.prototype;return s.prepareWorker=function(){for(var t=this.limitedCount,e=new Array(t),r=0;r<t;r++)e.push(this._initWorker(r));return Promise.all(e)},s.postMessage=function(t){var e=this;return new Promise(function(r,a){var o=e._getIdleWorkerId();if(o!==-1){e._workerStatus|=1<<o;var c=e._workerItems,l;Promise.resolve((l=c[o])!=null?l:e._initWorker(o)).then(function(){var _=c[o];_.resolve=r,_.reject=a,_.worker.postMessage(t)}).catch(a)}else e._taskQueue.push({resolve:r,reject:a,message:t})})},s.destroy=function(){for(var t=this._workerItems,e=0,r=t.length;e<r;e++){var a=t[e];a.worker.terminate(),a.reject=null,a.resolve=null}t.length=0,this._taskQueue.length=0,this._workerStatus=0},s._initWorker=function(t){var e=this;return Promise.resolve(this._workerCreator()).then(function(r){return r.addEventListener("message",e._onMessage.bind(e,t)),e._workerItems[t]={worker:r,resolve:null,reject:null},r})},s._getIdleWorkerId=function(){for(var t=0,e=this.limitedCount;t<e;t++)if(!(this._workerStatus&1<<t))return t;return-1},s._onMessage=function(t,e){var r=e.data.error;r?this._workerItems[t].reject(r):this._workerItems[t].resolve(e.data),this._nextTask(t)},s._nextTask=function(t){if(this._taskQueue.length){var e=this._taskQueue.shift(),r=this._workerItems[t];r.resolve=e.resolve,r.reject=e.reject,r.worker.postMessage(e.message)}else this._workerStatus^=1<<t},n}(),Zc=function(){function n(i){this.workerLimitCount=i}var s=n.prototype;return s.init=function(){return this._initPromise||(this._initPromise=this._initTranscodeWorkerPool()),this._initPromise},s.destroy=function(){this._transcodeWorkerPool.destroy()},s._createTranscodePool=function(t,e){return this._transcodeWorkerPool=new kh(this.workerLimitCount,function(){return new Promise(function(r,a){var o=function(u){u.data.error?a(u.data.error):r(c)},c=new Worker(t),l={type:"init",transcoderWasm:e};c.addEventListener("message",o),c.postMessage(l)})}),this._transcodeWorkerPool.prepareWorker()},n}();function Gh(){var n,s=function(t){return n||(n=new Promise(function(e,r){var a={wasmBinary:t,onRuntimeInitialized:function(){return e(a)},onAbort:r};self.BASIS(a)}).then(function(e){return e.initializeBasis(),e.KTX2File})),n};self.onmessage=function(t){var e=t.data;switch(e.type){case"init":s(e.transcoderWasm).then(function(){self.postMessage("init-completed")}).catch(function(r){return self.postMessage({error:r})});break;case"transcode":s().then(function(r){var a=bo(e.buffer,e.format,r);a.type="transcoded",self.postMessage(a)}).catch(function(r){return self.postMessage({error:r})});break}}}var Hh=function(){var s;return function(t){return s||(s=new Promise(function(e,r){var a={wasmBinary:t,onRuntimeInitialized:function(){return e(a)},onAbort:r};self.BASIS(a)}).then(function(e){return e.initializeBasis(),e.KTX2File})),s}},Vs=Hh();function bo(n,s,i){var t=function(D,L){switch(D){case 2:return L?3:2;case 4:return L?1:0;case 3:return L?9:8;case 7:return 13;case 0:return 10;case 1:return 7}},e=function(D){if(D.length===1)return D[0];for(var L=0,V=0;V<D.length;V++)L+=D[V].byteLength;for(var N=new Uint8Array(L),I=0,B=0;B<D.length;B++)N.set(D[B],I),I+=D[B].byteLength;return N},r=function(){c.close(),c.delete()},a;(function(M){M[M.ETC1=0]="ETC1",M[M.ETC2=1]="ETC2",M[M.BC1=2]="BC1",M[M.BC3=3]="BC3",M[M.BC4=4]="BC4",M[M.BC5=5]="BC5",M[M.BC7=7]="BC7",M[M.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",M[M.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",M[M.ASTC_4x4=10]="ASTC_4x4",M[M.RGBA8=13]="RGBA8"})(a||(a={}));var o;(function(M){M[M.ASTC=0]="ASTC",M[M.BC7=1]="BC7",M[M.BC1_BC3=2]="BC1_BC3",M[M.PVRTC=3]="PVRTC",M[M.ETC=4]="ETC",M[M.R8=5]="R8",M[M.RG8=6]="RG8",M[M.RGBA8=7]="RGBA8"})(o||(o={}));var c=new i(new Uint8Array(n));if(!c.isValid())throw r(),new Error("Invalid or unsupported .ktx2 file");if(!c.startTranscoding())throw r(),new Error("KTX2 startTranscoding failed");for(var l=c.getWidth(),_=c.getHeight(),u=c.getLayers()||1,h=c.getLevels(),d=c.getHasAlpha(),f=c.getFaces(),v=t(s,d),p=new Array(f),g=v===2||v===3||v===7,y=0;y<f;y++){for(var m=new Array(h),x=0;x<h;x++){for(var C=new Array(u),b=void 0,A=void 0,S=0;S<u;S++){var w=c.getImageLevelInfo(x,S,y);g&&x===0&&(l!==w.width||_!==w.height)?(l=b=w.width,_=A=w.height,console.warn("KTX2 transcode to BC will resize to width: "+l+", height: "+_+". You'd better use an image whose size if multiple of 4.")):(b=w.origWidth,A=w.origHeight);var E=new Uint8Array(c.getImageTranscodedSizeInBytes(x,S,0,v)),P=c.transcodeImage(E,x,S,y,v,0,-1,-1);if(!P)throw r(),new Error("transcodeImage failed.");C[S]=E}m[x]={data:e(C),width:b,height:A}}p[y]=m}return r(),{faces:p,width:l,height:_,hasAlpha:d,faceCount:f,format:v}}var Wh=function(n){ne(s,n);function s(t){return n.call(this,t)}var i=s.prototype;return i._initTranscodeWorkerPool=function(){var e=this;return Promise.all([fetch("https://mdn.alipayobjects.com/rms/afts/file/A*nG8SR6vCgXgAAAAAAAAAAAAAARQnAQ/basis_transcoder.js").then(function(r){return r.text()}),fetch("https://mdn.alipayobjects.com/rms/afts/file/A*qEUfQ7317KsAAAAAAAAAAAAAARQnAQ/basis_transcoder.wasm").then(function(r){return r.arrayBuffer()})]).then(function(r){var a=r[0],o=r[1];if(e.workerLimitCount===0)return new Promise(function(h,d){var f=document.createElement("script");f.src=URL.createObjectURL(new Blob([a],{type:"application/javascript"})),document.body.appendChild(f),f.onload=function(){Vs(o).then(function(){h(null)})},f.onerror=function(){d()}});var c=Gh.toString(),l=c.substring(c.indexOf("{"),c.lastIndexOf("}")+1),_=`
        `+a+`
        `+bo.toString()+`
        `+l+`
        `,u=URL.createObjectURL(new Blob([_],{type:"application/javascript"}));return e._createTranscodePool(u,o)})},i.transcode=function(e,r){return this.workerLimitCount===0?Vs().then(function(a){return bo(e,r,a)}):this._transcodeWorkerPool.postMessage({buffer:e,format:r,type:"transcode"})},s}(Zc);function Xh(){var n=function(o,c,l,_){var u=(l+3>>2)*(_+3>>2),h=u*16+65535>>16,d=o.memory,f=h+1-(d.buffer.byteLength>>16);f>0&&d.grow(f);var v=new Uint8Array(d.buffer,65536,u*16);return v.set(c),o.transcode(u)===0?v:null},s=function(o){return t=WebAssembly.instantiate(o,{env:{memory:new WebAssembly.Memory({initial:16})}}).then(function(c){return c.instance.exports}),t},i=function(o,c,l){var _=o.length,u=new Array(_),h=Promise.resolve();return c&&(r.init(),h=r._initPromise),h.then(function(){for(var d=0;d<_;d++){for(var f=o[d].length,v=new Array(f),p=0;p<f;p++){var g=o[d][p],y=g.buffer,m=g.levelHeight,x=g.levelWidth,C=g.uncompressedByteLength;c&&(y=r.decode(y.slice(),C));var b=y.byteLength/_,A=y.byteOffset,S=n(l,new Uint8Array(y.buffer,A+d*b,b),x,m);if(S)v[p]={data:S.slice(),width:x,height:m};else throw"buffer decoded error"}u[d]=v}return u})},t,e=function(){function a(){}var o=a.prototype;return o.init=function(){return this._initPromise||(this._initPromise=fetch(a.WasmModuleURL).then(function(l){if(l.ok)return l.arrayBuffer();throw new Error("Could not fetch the wasm component for the Zstandard decompression lib: "+l.status+" - "+l.statusText)}).then(function(l){return WebAssembly.instantiate(l,a.IMPORT_OBJECT)}).then(this._init)),this._initPromise},o._init=function(l){a.instance=l.instance,a.IMPORT_OBJECT.env.emscripten_notify_memory_growth()},o.decode=function(l,_){if(_===void 0&&(_=0),!a.instance)throw new Error("ZSTDDecoder: Await .init() before decoding.");var u=a.instance.exports,h=l.byteLength,d=u.malloc(h);a.heap.set(l,d),_=_||Number(u.ZSTD_findDecompressedSize(d,h));var f=u.malloc(_),v=u.ZSTD_decompress(f,_,d,h),p=a.heap.slice(f,f+v);return u.free(d),u.free(f),p},a}();(function(){e.IMPORT_OBJECT={env:{emscripten_notify_memory_growth:function(){e.heap=new Uint8Array(e.instance.exports.memory.buffer)}}}})(),function(){e.WasmModuleURL="https://mdn.alipayobjects.com/rms/afts/file/A*awNJR7KqIAEAAAAAAAAAAAAAARQnAQ/zstddec.wasm"}();var r=new e;self.onmessage=function(o){var c=o.data;switch(c.type){case"init":s(c.transcoderWasm).then(function(){self.postMessage("init-completed")}).catch(function(l){self.postMessage({error:l})});break;case"transcode":t.then(function(l){i(c.data,c.needZstd,l).then(function(_){self.postMessage(_)}).catch(function(_){return self.postMessage({error:_})})});break}}}var So=function(n){ne(s,n);function s(t,e){var r;return r=n.call(this,t)||this,r.type=e,r}var i=s.prototype;return i._initTranscodeWorkerPool=function(){var e=this;return fetch(s.transcoderMap[this.type]).then(function(r){return r.arrayBuffer()}).then(function(r){var a=Xh.toString(),o=URL.createObjectURL(new Blob([a.substring(a.indexOf("{")+1,a.lastIndexOf("}"))],{type:"application/javascript"}));return e._createTranscodePool(o,r)})},i.transcode=function(e){for(var r=e.supercompressionScheme===xo.Zstd,a=e.levels.length,o=e.faceCount,c={width:e.pixelWidth,height:e.pixelHeight,mipmaps:null},l={type:"transcode",format:0,needZstd:r,data:new Array(o)},_=l.data,u=0;u<o;u++){for(var h=new Array(a),d=0;d<a;d++){var f=e.levels[d],v=Math.floor(e.pixelWidth/(1<<d))||1,p=Math.floor(e.pixelHeight/(1<<d))||1,g=f.levelData.buffer,y=f.levelData.byteOffset,m=f.levelData.byteLength;h[d]={buffer:new Uint8Array(g,y,m),levelWidth:v,levelHeight:p,uncompressedByteLength:f.uncompressedByteLength}}_[u]=h}return this._transcodeWorkerPool.postMessage(l).then(function(x){return c.faces=x,c.hasAlpha=!0,c})},s}(Zc);(function(){var n;So.transcoderMap=(n={},n[Le.ASTC]="https://mdn.alipayobjects.com/rms/afts/file/A*0jiKRK6D1-kAAAAAAAAAAAAAARQnAQ/uastc_astc.wasm",n)})();var ba,yt=(ba=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.initialize=function(e,r){if(r.ktx2Loader){var a=r.ktx2Loader;return a.priorityFormats&&(yt._priorityFormats.etc1s=a.priorityFormats,yt._priorityFormats.uastc=a.priorityFormats),a.transcoder===1?yt._getKhronosTranscoder(a.workerCount).init():yt._getBinomialLLCTranscoder(a.workerCount).init()}},i.load=function(e,r){var a=this;return new Pe(function(o,c,l,_){a.request(e.url,{type:"arraybuffer"}).onProgress(l,_).then(function(u){return yt._parseBuffer(new Uint8Array(u),r.engine,e.params).then(function(h){var d=h.engine,f=h.result,v=h.targetFormat,p=h.params;return yt._createTextureByBuffer(d,f,v,p)})}).then(o).catch(c)})},s.release=function(){this._binomialLLCTranscoder&&this._binomialLLCTranscoder.destroy(),this._khronosTranscoder&&this._khronosTranscoder.destroy(),this._binomialLLCTranscoder=null,this._khronosTranscoder=null,this._isBinomialInit=!1},s._parseBuffer=function(e,r,a){var o,c=new Uh(e),l,_=(l=(o=a)==null?void 0:o.priorityFormats)!=null?l:yt._priorityFormats[c.isUASTC?"uastc":"etc1s"],u=yt._decideTargetFormat(r,c,_),h;if(yt._isBinomialInit||!So.transcoderMap[u]||!c.isUASTC){var d=yt._getBinomialLLCTranscoder();h=d.init().then(function(){return d.transcode(e,u)})}else{var f=yt._getKhronosTranscoder();h=f.init().then(function(){return f.transcode(c)})}return h.then(function(v){return{engine:r,result:v,targetFormat:u,params:c.keyValue.GalaceanTextureParams}})},s._createTextureByBuffer=function(e,r,a,o){var c=r.width,l=r.height,_=r.faces,u=_.length,h=_[0],d=h.length>1,f=this._getEngineTextureFormat(a,r),v;if(u!==6){v=new Tt(e,c,l,f,d);for(var p=0;p<h.length;p++){var g=h[p].data;v.setPixelBuffer(g,p)}}else{v=new jt(e,l,f,d);for(var y=0;y<_.length;y++)for(var m=_[y],x=0;x<h.length;x++)v.setPixelBuffer(wr.PositiveX+y,m[x].data,x)}return o&&(v.wrapModeU=o[0],v.wrapModeV=o[1],v.filterMode=o[2],v.anisoLevel=o[3]),v},s._decideTargetFormat=function(e,r,a){var o=e._hardwareRenderer,c=this._detectSupportedFormat(o,a);return c===Le.PVRTC&&(!k.isPowerOf2(r.pixelWidth)||!k.isPowerOf2(r.pixelHeight)||r.pixelWidth!==r.pixelHeight)?(ve.warn("PVRTC image need power of 2 and width===height, downgrade to RGBA8"),Le.R8G8B8A8):c===null?(ve.warn("Can't support any compressed texture, downgrade to RGBA8"),Le.R8G8B8A8):c},s._detectSupportedFormat=function(e,r){for(var a=0;a<r.length;a++){var o=r[a],c=this._supportedMap[o];if(c){for(var l=0;l<c.length;l++)if(e.canIUse(c[l]))return o}else switch(r[a]){case Le.R8G8B8A8:return o;case Le.R8:case Le.R8G8:if(e.isWebGL2)return o}}return null},s._getBinomialLLCTranscoder=function(e){e===void 0&&(e=4),yt._isBinomialInit=!0;var r;return(r=this._binomialLLCTranscoder)!=null?r:this._binomialLLCTranscoder=new Wh(e)},s._getKhronosTranscoder=function(e){e===void 0&&(e=4);var r;return(r=this._khronosTranscoder)!=null?r:this._khronosTranscoder=new So(e,Le.ASTC)},s._getEngineTextureFormat=function(e,r){var a=r.hasAlpha;switch(e){case Le.ASTC:return G.ASTC_4x4;case Le.ETC:return a?G.ETC2_RGBA8:G.ETC2_RGB;case Le.BC7:return G.BC7;case Le.BC1_BC3:return a?G.BC3:G.BC1;case Le.PVRTC:return a?G.PVRTC_RGBA4:G.PVRTC_RGB4;case Le.R8G8B8A8:return G.R8G8B8A8}},s}(Be),function(){ba._isBinomialInit=!1}(),function(){ba._priorityFormats={etc1s:[Le.ETC,Le.BC7,Le.ASTC,Le.BC1_BC3,Le.PVRTC],uastc:[Le.ASTC,Le.BC7,Le.ETC,Le.BC1_BC3,Le.PVRTC]}}(),function(){var n;ba._supportedMap=(n={},n[Le.ASTC]=[K.astc],n[Le.ETC]=[K.etc],n[Le.BC7]=[K.bptc],n[Le.BC1_BC3]=[K.s3tc],n[Le.PVRTC]=[K.pvrtc,K.pvrtc_webkit],n)}(),ba);yt=le([Xe(Ve.KTX2,["ktx2"])],yt);var Fs;(function(n){n[n.BinomialLLC=0]="BinomialLLC",n[n.Khronos=1]="Khronos"})(Fs||(Fs={}));var jh=function(n){ne(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.bufferRequests=[],t.glbBufferSlices=[],t.bufferTextures=[],t.meshes=[],t}var i=s.prototype;return i.restoreContent=function(){var e=this;return new Pe(function(r,a){Promise.all(e.bufferRequests.map(function(o){return Qn(o.url,o.config)})).then(function(o){if(e.isGLB){var c=e.glbBufferSlices,l=o[0],_=c.length;o.length=_;for(var u=0;u<_;u++){var h=c[u];o[u]=l.slice(h.x,h.x+h.y)}}Pe.all(e.bufferTextures.map(function(d){var f=d.bufferView,v=o[f.buffer],p,g=new Uint8Array(v,(p=f.byteOffset)!=null?p:0,f.byteLength),y=d.texture;return d.mimeType==="image/ktx2"?yt._parseBuffer(g,y.engine).then(function(m){for(var x=m.result,C=x.faces,b=C[0],A=0;A<b.length;A++)y.setPixelBuffer(b[A].data,A)}):Ke.loadImageBuffer(g,d.mimeType).then(function(m){y.setImageSource(m),y.generateMipmaps()})})).then(function(){for(var d=ia(e.meshes),f;!(f=d()).done;){for(var v=f.value,p=v.mesh,g=ia(v.vertexBuffers),y;!(y=g()).done;){var m=y.value,x=e._getBufferData(o,m.data);m.buffer.setData(x)}if(v.indexBuffer){var C=e._getBufferData(o,v.indexBuffer);p.setIndices(C)}for(var b=ia(v.blendShapes),A;!(A=b()).done;){var S=A.value,w=S.blendShape.frames[0],E=S.position,P=e._getBufferData(o,E.buffer);if(w.deltaPositions=Ke.bufferToVector3Array(P,E.byteOffset,E.count,E.normalized,E.componentType),S.normal){var M=S.normal,D=e._getBufferData(o,M.buffer);w.deltaNormals=Ke.bufferToVector3Array(D,M.byteOffset,M.count,M.normalized,M.componentType)}if(S.tangent){var L=S.tangent,V=e._getBufferData(o,L.buffer);w.deltaTangents=Ke.bufferToVector3Array(V,L.byteOffset,L.count,L.normalized,L.componentType)}}p.uploadData(!0)}r(e.resource)}).catch(a)}).catch(a)})},i._getBufferData=function(e,r){var a=r.main,o;if(a){var c=e[a.bufferIndex];o=new a.TypedArray(c,a.byteOffset,a.length)}else o=new a.TypedArray(a.length);var l=r.sparseCount;if(l)for(var _=r.sparseIndices,u=e[_.bufferIndex],h=new _.TypedArray(u,_.byteOffset,_.length),d=r.sparseValues,f=e[d.bufferIndex],v=new d.TypedArray(f,d.byteOffset,d.length),p=r.typeSize,g=0;g<l;g++)for(var y=h[g],m=0;m<p;m++)o[y*p+m]=v[g*p+m];return o},s}(br),$c=function(s,i){this.url=s,this.config=i},el=function(s,i,t){this.texture=s,this.bufferView=i,this.mimeType=t},qh=function(){this.vertexBuffers=[],this.blendShapes=[]},Ns=function(s,i){this.buffer=s,this.data=i},to=function(s,i,t,e,r){this.main=s,this.typeSize=i,this.sparseCount=t,this.sparseIndices=e,this.sparseValues=r},Sa=function(s,i,t,e){this.bufferIndex=s,this.TypedArray=i,this.byteOffset=t,this.length=e},Yh=function(s,i,t,e){this.blendShape=s,this.position=i,this.normal=t,this.tangent=e},Qh=function(s,i,t,e,r){this.buffer=s,this.byteOffset=i,this.count=t,this.normalized=e,this.componentType=r},hr=function(){function n(){}var s=n.prototype;return s.createAndParse=function(t,e,r){for(var a=arguments.length,o=new Array(a>3?a-3:0),c=3;c<a;c++)o[c-3]=arguments[c];throw"Not implemented."},s.additiveParse=function(t,e,r,a){for(var o=arguments.length,c=new Array(o>4?o-4:0),l=4;l<o;l++)c[l-4]=arguments[l];throw"Not implemented."},n}(),At;(function(n){n[n.CreateAndParse=0]="CreateAndParse",n[n.AdditiveParse=1]="AdditiveParse"})(At||(At={}));var Fe=function(){function n(){}return n.executeExtensionsCreateAndParse=function(i,t,e){i===void 0&&(i={});for(var r=arguments.length,a=new Array(r>3?r-3:0),o=3;o<r;o++)a[o-3]=arguments[o];for(var c=null,l=Object.keys(i),_=l.length-1;_>=0;--_){var u,h=l[_],d=i[h];if(c=(u=n)._createAndParse.apply(u,[].concat(h,t,d,e,a)),c)return c}},n.executeExtensionsAdditiveAndParse=function(i,t,e,r){for(var a=arguments.length,o=new Array(a>4?a-4:0),c=4;c<a;c++)o[c-4]=arguments[c];for(var l in i){var _,u=i[l];(_=n)._additiveParse.apply(_,[].concat(l,t,e,u,r,o))}},n.hasExtensionParser=function(i){var t;return!!((t=n._extensionParsers[i])!=null&&t.length)},n.getExtensionParser=function(i,t){var e,r=n._extensionParsers[i],a=(e=r)==null?void 0:e.length;if(a)for(var o=a-1;o>=0;--o){var c=r[o];if(c._mode===t)return c}},n._addExtensionParser=function(i,t){n._extensionParsers[i]||(n._extensionParsers[i]=[]),n._extensionParsers[i].push(t)},n._createAndParse=function(i,t,e,r){for(var a=arguments.length,o=new Array(a>4?a-4:0),c=4;c<a;c++)o[c-4]=arguments[c];var l=n.getExtensionParser(i,At.CreateAndParse);if(l){var _;return(_=l).createAndParse.apply(_,[].concat(t,e,r,o))}},n._additiveParse=function(i,t,e,r,a){for(var o=arguments.length,c=new Array(o>5?o-5:0),l=5;l<o;l++)c[l-5]=arguments[l];var _=n.getExtensionParser(i,At.AdditiveParse);if(_){var u;(u=_).additiveParse.apply(u,[].concat(t,e,r,a,c))}},n}();(function(){Fe._extensionParsers={}})();function dr(n,s){return function(i){var t=new i;t._mode=s,Fe._addExtensionParser(n,t)}}var Is=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e){var r=e.glTFResource,a=e.contentRestorer,o=r.url,c=a.bufferRequests,l={type:"arraybuffer"};return Qn(o,l).onProgress(void 0,e._onTaskDetail).then(function(_){return c.push(new $c(o,l)),Ke.parseGLB(e,_)}).then(function(_){var u;return(u=_)!=null&&u.glTF?(a.isGLB=!0,e.buffers=_.buffers,_.glTF):(a.isGLB=!1,JSON.parse(Ue.decodeText(new Uint8Array(_.originBuffer))))})},s}(Fe);Is=le([Rr(pe.Schema)],Is);var Co=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){var a=e.glTF.animations[r],o=a.name,c=o===void 0?"AnimationClip"+r:o,l=Fe.executeExtensionsCreateAndParse(a.extensions,e,a)||Co._parseStandardProperty(e,new Vo(c),a);return Promise.resolve(l).then(function(_){return Fe.executeExtensionsAdditiveAndParse(a.extensions,e,_,a),_})},s._parseStandardProperty=function(e,r,a){for(var o=function(x,C){var b=d[x],A=_[b.input],S=_[b.output],w=Promise.all([Ke.getAccessorBuffer(e,u,A),Ke.getAccessorBuffer(e,u,S)]).then(function(E){var P=E[0].data,M=E[1].data;if(S.normalized){for(var D=Ke.getNormalizedComponentScale(S.componentType),L=new Float32Array(M.length),V=0,N=M.length;V<N;V++)L[V]=M[V]*D;M=L}var I=M.length/P.length,B,z=(B=b.interpolation)!=null?B:ta.Linear,U;switch(z){case ta.CubicSpine:U=xt.CubicSpine;break;case ta.Step:U=xt.Step;break;case ta.Linear:U=xt.Linear;break}P[P.length-1],v[x]={type:S.type,interpolation:U,input:P,output:M,outputSize:I}});g.push(w)},c=this,l=e.glTF,_=l.accessors,u=l.bufferViews,h=a.channels,d=a.samplers,f=d.length,v=new Array(f),p=e.get(pe.Entity),g=new Array,y=0,m=f;y<m;y++)o(y);return g.push(e.get(pe.Scene)),Promise.all(g).then(function(){for(var x=0,C=h.length;x<C;x++){for(var b=h[x],A=b.target,S=p[A.node],w="",E=S;E.parent;)w=w===""?""+E.name:E.name+"/"+w,E=E.parent;if(e.glTFResource.sceneRoots.indexOf(E)!==-1){var P=void 0,M=void 0;switch(A.path){case Dr.TRANSLATION:P=ge,M="position";break;case Dr.ROTATION:P=ge,M="rotationQuaternion";break;case Dr.SCALE:P=ge,M="scale";break;case Dr.WEIGHTS:P=Dt,M="blendShapeWeights";break}var D=c._addCurve(A.path,b,v);if(A.path===Dr.WEIGHTS)for(var L=l.nodes[A.node].mesh,V=0,N=l.meshes[L].primitives.length;V<N;V++)r.addCurveBinding(w,P,V,M,D);else r.addCurveBinding(w,P,M,D)}}return r})},s._addCurve=function(e,r,a){var o=a[r.sampler],c=o.input,l=o.output,_=o.outputSize;switch(e){case Dr.TRANSLATION:case Dr.SCALE:{for(var u=new Ia,h=u.interpolation=o.interpolation,d=0,f=0,v=c.length;f<v;f++){var p=new Ft;p.time=c[f],h===xt.CubicSpine?(p.inTangent=new R(l[d++],l[d++],l[d++]),p.value=new R(l[d++],l[d++],l[d++]),p.outTangent=new R(l[d++],l[d++],l[d++])):p.value=new R(l[d++],l[d++],l[d++]),u.addKey(p)}return u}case Dr.ROTATION:{for(var g=new fa,y=g.interpolation=o.interpolation,m=0,x=0,C=c.length;x<C;x++){var b=new Ft;b.time=c[x],y===xt.CubicSpine?(b.inTangent=new ie(l[m++],l[m++],l[m++],l[m++]),b.value=new Re(l[m++],l[m++],l[m++],l[m++]),b.outTangent=new ie(l[m++],l[m++],l[m++],l[m++])):b.value=new Re(l[m++],l[m++],l[m++],l[m++]),g.addKey(b)}return g}case Dr.WEIGHTS:{var A=new Na;A.interpolation=o.interpolation;for(var S=0,w=0,E=c.length;w<E;w++){var P=new Ft;P.time=c[w],A.interpolation===xt.CubicSpine?(P.inTangent=Array.from(l.subarray(S,S+_)),S+=_,P.value=l.slice(S,S+_),S+=_,P.outTangent=Array.from(l.subarray(S,S+_)),S+=_):(P.value=l.slice(S,S+_),S+=_),A.addKey(P)}return A}}},s}(Fe);Co=le([Rr(pe.Animation)],Co);var Os=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){var a=e.glTF.buffers;return e.buffers?Promise.resolve(e.buffers[r]):this._parseSingleBuffer(e,a[r])},i._parseSingleBuffer=function(e,r){var a=e.glTFResource,o=e.contentRestorer,c=a.url,l=o.bufferRequests,_={type:"arraybuffer"},u=Ue.resolveAbsoluteUrl(c,r.uri);l.push(new $c(u,_));var h=Qn(u,_).onProgress(void 0,e._onTaskDetail);return e._addTaskCompletePromise(h),h},s}(Fe);Os=le([Rr(pe.Buffer)],Os);var zs=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){var a=e.glTFResource,o=e.glTF.nodes[r],c=a.engine,l=o.matrix,_=o.translation,u=o.rotation,h=o.scale,d=o.extensions,f=new Yt(c,o.name||"_GLTF_ENTITY_"+r);f._markAsTemplate(a);var v=f.transform;if(l){var p=v.localMatrix;p.copyFromArray(l),v.localMatrix=p}else _&&v.setPosition(_[0],_[1],_[2]),u&&v.setRotationQuaternion(u[0],u[1],u[2],u[3]),h&&v.setScale(h[0],h[1],h[2]);var g=o.children;if(g)for(var y=0;y<g.length;y++){var m=g[y],x=e.get(pe.Entity,m);f.addChild(x)}return Fe.executeExtensionsAdditiveAndParse(d,e,f,o),f},s}(Fe);zs=le([Rr(pe.Entity)],zs);var bt=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){var a=e.glTF.materials[r],o=e.glTFResource,c=o.engine,l=Fe.executeExtensionsCreateAndParse(a.extensions,e,a);return l||(l=new Xr(c),l.name=a.name,bt._parseStandardProperty(e,l,a)),Promise.resolve(l).then(function(_){return _||(_=bt._getDefaultMaterial(c)),Fe.executeExtensionsAdditiveAndParse(a.extensions,e,_,a),_._associationSuperResource(o),_})},s._getDefaultMaterial=function(e){var r;return(r=bt)._defaultMaterial||(r._defaultMaterial=new Ga(e))},s._checkOtherTextureTransform=function(e,r){var a;(a=e.extensions)!=null&&a.KHR_texture_transform&&ve.warn(""+r+" texture always use the KHR_texture_transform of the base texture.")},s._parseStandardProperty=function(e,r,a){var o=a.pbrMetallicRoughness,c=a.normalTexture,l=a.occlusionTexture,_=a.emissiveTexture,u=a.emissiveFactor,h=a.alphaMode,d=a.alphaCutoff,f=a.doubleSided;if(o){var v=o.baseColorFactor,p=o.baseColorTexture,g=o.metallicFactor,y=o.roughnessFactor,m=o.metallicRoughnessTexture;v&&(r.baseColor=new q(q.linearToGammaSpace(v[0]),q.linearToGammaSpace(v[1]),q.linearToGammaSpace(v[2]),v[3])),p&&e.get(pe.Texture,p.index).then(function(w){r.baseTexture=w,Fe.executeExtensionsAdditiveAndParse(p.extensions,e,r,p)}),r.constructor===Xr&&(r.metallic=g??1,r.roughness=y??1,m&&(bt._checkOtherTextureTransform(m,"Roughness metallic"),e.get(pe.Texture,m.index).then(function(w){r.roughnessMetallicTexture=w})))}if(r.constructor===Xr||r.constructor===qn){if(_&&(bt._checkOtherTextureTransform(_,"Emissive"),e.get(pe.Texture,_.index).then(function(w){r.emissiveTexture=w})),u&&(r.emissiveColor=new q(q.linearToGammaSpace(u[0]),q.linearToGammaSpace(u[1]),q.linearToGammaSpace(u[2]))),c){var x=c.index,C=c.scale;bt._checkOtherTextureTransform(c,"Normal"),e.get(pe.Texture,x).then(function(w){r.normalTexture=w}),C!==void 0&&(r.normalTextureIntensity=C)}if(l){var b=l.index,A=l.strength,S=l.texCoord;bt._checkOtherTextureTransform(l,"Occlusion"),e.get(pe.Texture,b).then(function(w){r.occlusionTexture=w}),A!==void 0&&(r.occlusionTextureIntensity=A),S===Cn.UV1?r.occlusionTextureCoord=Cn.UV1:S>Cn.UV1&&ve.warn("Occlusion texture uv coordinate must be UV0 or UV1.")}}switch(f?r.renderFace=an.Double:r.renderFace=an.Front,h){case Aa.OPAQUE:r.isTransparent=!1;break;case Aa.BLEND:r.isTransparent=!0;break;case Aa.MASK:r.alphaCutoff=d??.5;break}},s}(Fe);bt=le([Rr(pe.Material)],bt);function Ao(n,s){return s!=null&&typeof Symbol<"u"&&s[Symbol.hasInstance]?!!s[Symbol.hasInstance](n):n instanceof s}var ro,wa=(ro=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){for(var a=function(f,v){var p=o.primitives[f];u[f]=new Promise(function(g){var y=Fe.executeExtensionsCreateAndParse(p.extensions,e,p,o);if(y)Ao(y,dt)?(y._associationSuperResource(l),g(y)):y.then(function(C){C._associationSuperResource(l),g(C)});else{var m=new dt(_,o.name||f+"");m._associationSuperResource(l);var x=new qh;x.mesh=m,e.contentRestorer.meshes.push(x),wa._parseMeshFromGLTFPrimitive(e,m,x,o,p,c,e.params.keepMeshData).then(g)}})},o=e.glTF.meshes[r],c=e.glTF,l=e.glTFResource,_=l.engine,u=new Array,h=0,d=o.primitives.length;h<d;h++)a(h);return Promise.all(u)},s._parseMeshFromGLTFPrimitive=function(e,r,a,o,c,l,_){var u=function(A){var S=h[d[A]],w=Ke.getAccessorBuffer(e,l.bufferViews,S).then(function(E){var P=Ke.getAccessorTypeSize(S.type),M=S.count,D=E.data,L,V=r.instanceId,N=E.vertexBindingInfos,I=S.normalized,B=Ke.getElementFormat(S.componentType,P,I),z;I&&(z=Ke.getNormalizedComponentScale(S.componentType));var U;if(E.interleaved){var Y=S.byteOffset||0,Q=E.stride;if(U=Y%Q,N[V]===void 0){L=new Te(A,U,B,x);var H=E.vertexBuffer;H||(H=new Jt(g,Mt.VertexBuffer,D,Je.Static,_),E.vertexBuffer=H,a.vertexBuffers.push(new Ns(H,E.restoreInfo))),r.setVertexBufferBinding(H,Q,x),N[V]=x++}else L=new Te(A,U,B,N[V])}else{U=0,L=new Te(A,U,B,x);var te=E.vertexBuffer;te||(te=new Jt(g,Mt.VertexBuffer,D,Je.Static,_),a.vertexBuffers.push(new Ns(te,E.restoreInfo))),r.setVertexBufferBinding(te,E.stride,x),N[V]=x++}if(y.push(L),A==="POSITION"){m=M;var Ce=r.bounds,de=Ce.min,ae=Ce.max;if(S.min&&S.max)de.copyFromArray(S.min),ae.copyFromArray(S.max);else{var Ae=wa._tempVector3;de.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),ae.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var je=U/D.BYTES_PER_ELEMENT,_t=D.length/M,xe=0;xe<M;xe++){var $e=je+xe*_t;Ae.copyFromArray(D,$e),R.min(de,Ae,de),R.max(ae,Ae,ae)}}I&&(de.scale(z),ae.scale(z))}});C.push(w)},h=l.accessors,d=c.attributes,f=c.targets,v=c.indices,p=c.mode,g=r.engine,y=new Array,m,x=0,C=new Array;for(var b in d)u(b);return Promise.all(C).then(function(){if(r.setVertexElements(y),v!==void 0){var A=l.accessors[v],S=Ke.getAccessorBuffer(e,l.bufferViews,A).then(function(w){r.setIndices(w.data),r.addSubMesh(0,A.count,p),a.indexBuffer=w.restoreInfo});C.push(S)}else r.addSubMesh(0,m,p);return f&&C.push(wa._createBlendShape(e,r,a,o,c,f)),Promise.all(C).then(function(){return r.uploadData(!_),r})})},s._getBlendShapeData=function(e,r,a){return Ke.getAccessorBuffer(e,r.bufferViews,a).then(function(o){var c=o.data,l,_=o.interleaved?((l=a.byteOffset)!=null?l:0)%o.stride:0,u=a.count,h=a.normalized,d=a.componentType,f=Ke.bufferToVector3Array(c,_,u,h,d),v=new Qh(o.restoreInfo,_,u,h,d);return{vertices:f,restoreInfo:v}})},s._createBlendShape=function(e,r,a,o,c,l){for(var _=this,u=function(m){var x={};g[m]=x;var C=f?f[m]:"blendShape"+m,b=c.targets[m],A=b.NORMAL,S=b.TANGENT,w=A!==void 0,E=S!==void 0,P=Promise.all([_._getBlendShapeData(e,h,d[b.POSITION]),w?_._getBlendShapeData(e,h,d[A]):null,E?_._getBlendShapeData(e,h,d[S]):null]).then(function(M){var D,L=M[0],V=M[1],N=M[2],I=new Mo(C);I.addFrame(1,L.vertices,w?V.vertices:null,E?N.vertices:null),x.blendShape=I,x.restoreInfo=new Yh(I,L.restoreInfo,w?V.restoreInfo:null,E?(D=N)==null?void 0:D.restoreInfo:null)});v.push(P)},h=e.glTF,d=h.accessors,f=o.extras?o.extras.targetNames:null,v=new Array,p=l.length,g=new Array(p),y=0;y<p;y++)u(y);return Promise.all(v).then(function(){for(var m=ia(g),x;!(x=m()).done;){var C=x.value;r.addBlendShape(C.blendShape),a.blendShapes.push(C.restoreInfo)}})},s}(Fe),function(){ro._tempVector3=new R}(),ro);wa=le([Rr(pe.Mesh)],wa);var Us=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){var a=e.glTF,o=a.scenes,c=a.scene,l=c===void 0?0:c,_=e.glTFResource,u=o[r],h=u.extensions,d=_.engine,f=l===r,v=u.nodes,p;if(v.length===1)p=e.get(pe.Entity,v[0]);else{p=new Yt(d,"GLTF_ROOT");for(var g=0;g<v.length;g++){var y=e.get(pe.Entity,v[g]);p.addChild(y)}}f&&(_._defaultSceneRoot=p);for(var m=new Array,x=0;x<v.length;x++)m.push(this._parseEntityComponent(e,v[x]));return Promise.all(m).then(function(){return Fe.executeExtensionsAdditiveAndParse(h,e,p,u),p})},i._parseEntityComponent=function(e,r){var a=this,o=e.glTF,c=e.glTFResource,l=o.nodes[r],_=l.camera,u=l.mesh,h=e.get(pe.Entity,r),d;return _!==void 0&&this._createCamera(c,o.cameras[_],h),u!==void 0&&(d=this._createRenderer(e,l,h)),Promise.resolve(d).then(function(){var f=[],v=l.children;if(v)for(var p=0;p<v.length;p++)f.push(a._parseEntityComponent(e,v[p]));return Promise.all(f)})},i._createCamera=function(e,r,a){var o,c=r.orthographic,l=r.perspective,_=r.type,u=a.addComponent(ze);if(_===Fi.ORTHOGRAPHIC){var h=c.xmag,d=c.ymag,f=c.zfar,v=c.znear;u.isOrthographic=!0,v!==void 0&&(u.nearClipPlane=v),f!==void 0&&(u.farClipPlane=f),u.orthographicSize=Math.max(d??0,h??0)/2}else if(_===Fi.PERSPECTIVE){var p=l.aspectRatio,g=l.yfov,y=l.zfar,m=l.znear;p!==void 0&&(u.aspectRatio=p),g!==void 0&&(u.fieldOfView=g*180/Math.PI),y!==void 0&&(u.farClipPlane=y),m!==void 0&&(u.nearClipPlane=m)}(o=e).cameras||(o.cameras=[]),e.cameras.push(u),u.enabled=!1},i._createRenderer=function(e,r,a){for(var o=this,c=r.mesh,l=r.skin,_=e.glTF.meshes[c],u=_.primitives,h=u.length,d=r.weights||_.weights,f=new Array(h),v=0;v<h;v++)f[v]=e.get(pe.Material,u[v].material);return Promise.all([e.get(pe.Mesh,c),l!==void 0&&e.get(pe.Skin,l),Promise.all(f)]).then(function(p){for(var g=function(b){var A=x[b]||bt._getDefaultMaterial(e.glTFResource.engine),S=u[b],w=y[b],E=void 0;if(m||d){var P=a.addComponent(Dt);P.mesh=w,m&&(o._computeLocalBounds(P,w,m.bones,m.rootBone,m.inverseBindMatrices),P.skin=m),d&&(P.blendShapeWeights=new Float32Array(d)),E=P}else E=a.addComponent(Ir),E.mesh=w;E.setMaterial(A),w.vertexElements.forEach(function(M){M.semantic==="COLOR_0"&&(E.enableVertexColor=!0)}),Fe.executeExtensionsAdditiveAndParse(S.extensions,e,E,S)},y=p[0],m=p[1],x=p[2],C=0;C<h;C++)g(C)})},i._computeLocalBounds=function(e,r,a,o,c){var l=a.indexOf(o);if(l!==-1)lr.transform(r.bounds,c[l],e.localBounds);else{var _=new Z(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),u=this._computeApproximateBindMatrix(a,c,o,_);u!==0?(Z.multiplyScalar(_,1/u,_),lr.transform(r.bounds,_,e.localBounds)):e.localBounds.copyFrom(r.bounds)}},i._computeApproximateBindMatrix=function(e,r,a,o){for(var c=0,l=a.children,_=0,u=l.length;_<u;_++){var h=l[_],d=e.indexOf(h);d!==-1?(Z.add(o,r[d],o),c++):c+=this._computeApproximateBindMatrix(e,r,h,o)}return c},s}(Fe);Us=le([Rr(pe.Scene)],Us);var ks=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){var a=this,o=e.glTF,c=o.skins[r],l=c.inverseBindMatrices,_=c.skeleton,u=c.joints,h=c.name,d=h===void 0?"SKIN_"+r:h,f=u.length,v=new Mn(d);v.inverseBindMatrices.length=f;var p=new Array(f),g=o.accessors[l],y=Ke.getAccessorBuffer(e,o.bufferViews,g).then(function(m){for(var x=e.get(pe.Entity),C=m.data,b=0;b<f;b++){var A=new Z;A.copyFromArray(C,b*16),v.inverseBindMatrices[b]=A;var S=x[u[b]];p[b]=S,v.joints[b]=S.name}if(v.bones=p,_!==void 0){var w=x[_];v.rootBone=w}else{var E=a._findSkeletonRootBone(u,x);if(E)v.rootBone=E;else throw"Failed to find skeleton root bone."}return v});return Promise.resolve(y)},i._findSkeletonRootBone=function(e,r){for(var a={},o=ia(e),c;!(c=o()).done;){for(var l=c.value,_=new Array,u=r[l];u;)_.unshift(u),u=u.parent;a[l]=_}for(var h=null,d=0;;d++){var f=a[e[0]];if(d>=f.length)return h;for(var v=f[d],p=1,g=e.length;p<g;p++)if(f=a[e[p]],d>=f.length||v!==f[d])return h;h=v}},s}(Fe);ks=le([Rr(pe.Skin)],ks);var no,Ii=(no=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){var a=e.glTF.textures[r],o=e.glTFResource,c=e.glTF,l=o.engine,_=o.url,u=a.sampler,h=a.source,d=h===void 0?0:h,f=a.name,v=a.extensions,p=c.images[d],g=p.uri,y=p.bufferView,m=p.mimeType,x=p.name,C=Fe.executeExtensionsCreateAndParse(v,e,a);if(!C){var b=u!==void 0,A=u!==void 0&&Ke.getSamplerInfo(c.samplers[u]);if(g){var S,w=g.lastIndexOf("."),E=g.substring(w+1),P=E.startsWith("ktx")?Ve.KTX:Ve.Texture2D;C=l.resourceManager.load({url:Ue.resolveAbsoluteUrl(_,g),type:P,params:{mipmap:(S=A)==null?void 0:S.mipmap}}).onProgress(void 0,e._onTaskDetail).then(function(D){return D.name=f||x||D.name||"texture_"+r,b&&Ke.parseSampler(D,A),D}),e._addTaskCompletePromise(C)}else{var M=c.bufferViews[y];C=e.get(pe.Buffer).then(function(D){var L=D[M.buffer],V=new Uint8Array(L,M.byteOffset,M.byteLength);return Ke.loadImageBuffer(V,m).then(function(N){var I,B=new Tt(l,N.width,N.height,void 0,(I=A)==null?void 0:I.mipmap);B.setImageSource(N),B.generateMipmaps(),B.name=f||x||"texture_"+r,b&&Ke.parseSampler(B,A);var z=new el(B,M,m);return e.contentRestorer.bufferTextures.push(z),B})})}}return Promise.resolve(C).then(function(D){return Fe.executeExtensionsAdditiveAndParse(v,e,D,a),D._associationSuperResource(o),D})},s}(Fe),function(){var n;no._wrapMap=(n={},n[Ea.CLAMP_TO_EDGE]=gt.Clamp,n[Ea.MIRRORED_REPEAT]=gt.Mirror,n[Ea.REPEAT]=gt.Repeat,n)}(),no);Ii=le([Rr(pe.Texture)],Ii);var Gs=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e){var r=e.glTF,a=r.asset.version,o=r.extensionsUsed,c=r.extensionsRequired,l=Number(a);if(!(l>=2&&l<3))throw"Only support glTF 2.x.";if(o){ve.info("extensionsUsed: ",o);for(var _=0;_<o.length;_++){var u=o[_];Fe.hasExtensionParser(u)||ve.warn("Extension "+u+" is not implemented, you can customize this extension in gltf.")}}if(c){ve.info("extensionsRequired: "+c);for(var h=0;h<c.length;h++){var d=c[h];Fe.hasExtensionParser(d)||ve.error("GLTF parser has not supported required extension "+d+".")}}return Promise.resolve(null)},s}(Fe);Gs=le([Rr(pe.Validator)],Gs);var Hs=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){var a=e.glTF.bufferViews[r],o=a.extensions,c=a.byteOffset,l=c===void 0?0:c,_=a.byteLength,u=a.buffer;return o?Fe.executeExtensionsCreateAndParse(o,e,a):e.get(pe.Buffer,u).then(function(h){return new Uint8Array(h,l,_)})},s}(Fe);Hs=le([Rr(pe.BufferView)],Hs);var Ws=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e){var r=this;return e.needAnimatorController?e.get(pe.Animation).then(function(a){var o=r._createAnimatorController(a);return Promise.resolve(o)}):Promise.resolve(null)},i._createAnimatorController=function(e){var r=new No,a=new Io("layer"),o=new Oo;if(r.addLayer(a),a.stateMachine=o,e)for(var c=0;c<e.length;c++){var l=e[c],_=l.name,u=o.makeUniqueStateName(_);u!==_&&console.warn("AnimatorState name is existed, name: "+_+" reset to "+u);var h=o.addState(u);h.clip=l}return r},s}(Fe);Ws=le([Rr(pe.AnimatorController)],Ws);var fi=function(){var n=function(p){for(var g=new Uint8Array(p.length),y=0;y<p.length;++y){var m=p.charCodeAt(y);g[y]=m>96?m-97:m>64?m-39:m+4}for(var x=0,C=0;C<p.length;++C)g[x++]=g[C]<60?o[g[C]]:(g[C]-60)*64+g[++C];return g.buffer.slice(0,x)},s=function(p,g,y,m,x,C){var b=l.exports.sbrk,A=y+3&-4,S=b(A*m),w=b(x.length),E=new Uint8Array(l.exports.memory.buffer);E.set(x,w);var P=p(S,y,m,w,x.length);if(P==0&&C&&C(S,A,m),g.set(E.subarray(S,S+y*m)),b(S-b(0)),P!=0)throw new Error("Malformed buffer data: "+P)},i=function(p){var g={object:new Worker(p),pending:0,requests:{}};return g.object.onmessage=function(y){var m=y.data;g.pending-=m.count,g.requests[m.id][m.action](m.value),delete g.requests[m.id]},g},t=function(p){for(var g="var instance; var ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(n(c))+`]), {}).then(function(result) {instance = result.instance; instance.exports.__wasm_call_ctors();});
self.onmessage = workerProcess;
function decode(fun, target, count, size, source, filter) {
        const sbrk = instance.exports.sbrk;
        const count4 = (count + 3) & ~3;
        const tp = sbrk(count4 * size);
        const sp = sbrk(source.length);
        const heap = new Uint8Array(instance.exports.memory.buffer);
        heap.set(source, sp);
        const res = fun(tp, count, size, sp, source.length);
        if (res == 0 && filter) {
          filter(tp, count4, size);
        }
        target.set(heap.subarray(tp, tp + count * size));
        sbrk(tp - sbrk(0));
        if (res != 0) {
          throw new Error("Malformed buffer data: " + res);
        }
      }
function workerProcess(event) {
        ready.then(function () {
          const data = event.data;
          try {
            const target = new Uint8Array(data.count * data.size);
            decode(instance.exports[data.mode], target, data.count, data.size, data.source, instance.exports[data.filter]);
            self.postMessage({ id: data.id, count: data.count, action: "resolve", value: target }, [target.buffer]);
          } catch (error) {
            self.postMessage({
              id: data.id,
              count: data.count,
              action: "reject",
              value: error
            });
          }
        });
      }`,y=new Blob([g],{type:"text/javascript"}),m=URL.createObjectURL(y),x=0;x<p;++x)d[x]=i(m);URL.revokeObjectURL(m)},e=function(p,g,y,m,x){for(var C=d[0],b=1;b<d.length;++b)d[b].pending<C.pending&&(C=d[b]);return new Promise(function(A,S){var w=new Uint8Array(y),E=f++;C.pending+=p,C.requests[E]={resolve:A,reject:S},C.object.postMessage({id:E,count:p,size:g,source:w,mode:m,filter:x},[w.buffer])})},r="b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:q;iekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq:P8Yqdbk;3sezu8Jjjjjbcj;eb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Radz1jjjbhwcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhDcbhqinaqae9pmeaDaeaq9RaqaDfae6Egkcsfgocl4cifcd4hxdndndndnaoc9WGgmTmbcbhPcehsawcjdfhzalhHinaraH9Rax6midnaraHaxfgl9RcK6mbczhoinawcj;cbfaogifgoc9WfhOdndndndndnaHaic9WfgAco4fRbbaAci4coG4ciGPlbedibkaO9cb83ibaOcwf9cb83ibxikaOalRblalRbbgAco4gCaCciSgCE86bbaocGfalclfaCfgORbbaAcl4ciGgCaCciSgCE86bbaocVfaOaCfgORbbaAcd4ciGgCaCciSgCE86bbaoc7faOaCfgORbbaAciGgAaAciSgAE86bbaoctfaOaAfgARbbalRbegOco4gCaCciSgCE86bbaoc91faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc4faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc93faAaCfgARbbaOciGgOaOciSgOE86bbaoc94faAaOfgARbbalRbdgOco4gCaCciSgCE86bbaoc95faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc96faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc97faAaCfgARbbaOciGgOaOciSgOE86bbaoc98faAaOfgORbbalRbiglco4gAaAciSgAE86bbaoc99faOaAfgORbbalcl4ciGgAaAciSgAE86bbaoc9:faOaAfgORbbalcd4ciGgAaAciSgAE86bbaocufaOaAfgoRbbalciGglalciSglE86bbaoalfhlxdkaOalRbwalRbbgAcl4gCaCcsSgCE86bbaocGfalcwfaCfgORbbaAcsGgAaAcsSgAE86bbaocVfaOaAfgORbbalRbegAcl4gCaCcsSgCE86bbaoc7faOaCfgORbbaAcsGgAaAcsSgAE86bbaoctfaOaAfgORbbalRbdgAcl4gCaCcsSgCE86bbaoc91faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc4faOaAfgORbbalRbigAcl4gCaCcsSgCE86bbaoc93faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc94faOaAfgORbbalRblgAcl4gCaCcsSgCE86bbaoc95faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc96faOaAfgORbbalRbvgAcl4gCaCcsSgCE86bbaoc97faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc98faOaAfgORbbalRbogAcl4gCaCcsSgCE86bbaoc99faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc9:faOaAfgORbbalRbrglcl4gAaAcsSgAE86bbaocufaOaAfgoRbbalcsGglalcsSglE86bbaoalfhlxekaOal8Pbb83bbaOcwfalcwf8Pbb83bbalczfhlkdnaiam9pmbaiczfhoaral9RcL0mekkaiam6mialTmidnakTmbawaPfRbbhOcbhoazhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkkazcefhzaPcefgPad6hsalhHaPad9hmexvkkcbhlasceGmdxikalaxad2fhCdnakTmbcbhHcehsawcjdfhminaral9Rax6mialTmdalaxfhlawaHfRbbhOcbhoamhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkamcefhmaHcefgHad6hsaHad9hmbkaChlxikcbhocehsinaral9Rax6mdalTmealaxfhlaocefgoad6hsadao9hmbkaChlxdkcbhlasceGTmekc9:hoxikabaqad2fawcjdfakad2z1jjjb8Aawawcjdfakcufad2fadz1jjjb8Aakaqfhqalmbkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;ebf8Kjjjjbaok;yzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;siliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabavcefciGaiVcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:Ohkxekcjjjj94hkkabavcdfciGaiVcetfak87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:Ohqxekcjjjj94hqkabavcufciGaiVcetfaq87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohqxekcjjjj94hqkabavciGaiVcetfaq87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2geTmbinababydbgdcwtcw91:Yadce91cjjj;8ifcjjj98G::NUdbabclfhbaecufgembkkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;LeeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiclfaeclfydbBdbaicwfaecwfydbBdbaicxfaecxfydbBdbaiczfhiaeczfheadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk;aeedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdbaicxfalBdbaicwfalBdbaiclfalBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkkkebcjwklz9Kbb",a="b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q;Aekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq;t9tqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk;h8JlHud97euo978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Rad;8qbbcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhwcbhDinaDae9pmeawaeaD9RaDawfae6Egqcsfgoc9WGgkci2hxakcethmaocl4cifcd4hPabaDad2fhscbhzdnincehHalhOcbhAdninaraO9RaP6miavcj;cbfaAak2fhCaOaPfhlcbhidnakc;ab6mbaral9Rc;Gb6mbcbhoinaCaofhidndndndndnaOaoco4fRbbgXciGPlbedibkaipxbbbbbbbbbbbbbbbbpklbxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklbalczfhlkdndndndndnaXcd4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklzxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklzalczfhlkdndndndndnaXcl4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklaxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklaalczfhlkdndndndndnaXco4Plbedibkaipxbbbbbbbbbbbbbbbbpkl8WxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalclfaYpQbfaXc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalcwfaYpQbfaXc:q:yjjbfRbbfhlxekaialpbbbpkl8Walczfhlkaoc;abfhiaocjefak0meaihoaral9Rc;Fb0mbkkdndnaiak9pmbaici4hoinaral9RcK6mdaCaifhXdndndndndnaOaico4fRbbaocoG4ciGPlbedibkaXpxbbbbbbbbbbbbbbbbpklbxikaXalpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaXalpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaXalpbbbpklbalczfhlkaocdfhoaiczfgiak6mbkkalTmbaAci6hHalhOaAcefgohAaoclSmdxekkcbhlaHceGmdkdnakTmbavcjdfazfhiavazfpbdbhYcbhXinaiavcj;cbfaXfgopblbgLcep9TaLpxeeeeeeeeeeeeeeeegQp9op9Hp9rgLaoakfpblbg8Acep9Ta8AaQp9op9Hp9rg8ApmbzeHdOiAlCvXoQrLgEaoamfpblbg3cep9Ta3aQp9op9Hp9rg3aoaxfpblbg5cep9Ta5aQp9op9Hp9rg5pmbzeHdOiAlCvXoQrLg8EpmbezHdiOAlvCXorQLgQaQpmbedibedibedibediaYp9UgYp9AdbbaiadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaEa8EpmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwKDYq8AkEx3m5P8Es8FgLa3a5pmwKDYq8AkEx3m5P8Es8Fg8ApmbezHdiOAlvCXorQLgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfhiaXczfgXak6mbkkazclfgzad6mbkasavcjdfaqad2;8qbbavavcjdfaqcufad2fad;8qbbaqaDfhDc9:hoalmexikkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;kbf8Kjjjjbaokwbz:bjjjbk;uzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:EPliuo97eue978Jjjjjbca9Rhidndnadcl9hmbdnaec98GglTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalae9pmeaiaeciGgvcdtgdVcbczad9R;8kbaiabalcdtfglad;8qbbdnavTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkalaiad;8qbbskdnaec98GgxTmbcbhvabhdinadczfglalpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oawaopmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgvax6mbkkaxae9pmbaiaeciGgvcitgdfcbcaad9R;8kbaiabaxcitfglad;8qbbdnavTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oawaopmbezHdiOAlvCXorQLp9qpklbkalaiad;8qbbkk;4wllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalae9pmbaiaeciGgvcitgofcbcaao9R;8kbaiabalcitfgwao;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkawaiao;8qbbkk:Pddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbhdabheinaeaepbbbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepkbbaeczfheadclfgdav6mbkkdnaval9pmbaialciGgdcdtgeVcbc;abae9R;8kbaiabavcdtfgvae;8qbbdnadTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepklbkavaiae;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz9Tbb",o=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]),c=jr._detectSIMDSupported()?a:r,l,_=WebAssembly.instantiate(n(c),{}).then(function(v){l=v.instance,l.exports.__wasm_call_ctors()}),u={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},h={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},d=[],f=0;return{workerCount:4,ready:_,useWorkers:function(){t(this.workerCount)},decodeGltfBuffer:function(p,g,y,m,x){return this.workerCount>0&&d.length===0&&this.useWorkers(),d.length>0?e(p,g,y,h[m],u[x]):_.then(function(){var C=new Uint8Array(p*g);return s(l.exports[h[m]],C,p,g,y,l.exports[u[x]]),C})},release:function(){for(var p=0;p<d.length;p++)d[p].object.terminate()}}}(),Xs=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.initialize=function(e,r){var a,o=(a=r.glTF)==null?void 0:a.meshOpt;return o&&(fi.workerCount=o.workerCount,fi.useWorkers()),Promise.resolve()},i.load=function(e,r){var a=e.url,o=e.params,c=new Oh(r.engine,a),l=new Go(c,r,Bt({keepMeshData:!1},o));return new Pe(function(_,u,h,d){l._setTaskCompleteProgress=h,l._setTaskDetailProgress=d,l.parse().then(_).catch(u)})},s.release=function(){fi.release()},s}(Be);Xs=le([Xe(Ve.GLTF,["gltf","glb"])],Xs);var fe,Zn=Math.PI,Ta=(fe=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Pe(function(o,c){var l=r.engine;a.request(e.url,{type:"arraybuffer"}).then(function(_){for(var u=new Uint8Array(_),h=Ta._parseHeader(u),d=h.width,f=h.height,v=h.dataPosition,p=Ta._readPixels(u.subarray(v),d,f),g=f>>1,y=Ta._convertToCubemap(p,d,f,g),m=new jt(l,g),x=0;x<6;x++)m.setPixelBuffer(wr.PositiveX+x,y[x],0);m.generateMipmaps(),o(m)}).catch(c)})},s._convertToCubemap=function(e,r,a,o){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=r*a*4)throw"ConvertPanoramaToCubemap: input size is wrong";var c=this._createCubemapData(o,this._faceRight,e,r,a),l=this._createCubemapData(o,this._faceLeft,e,r,a),_=this._createCubemapData(o,this._faceUp,e,r,a),u=this._createCubemapData(o,this._faceBottom,e,r,a),h=this._createCubemapData(o,this._faceFront,e,r,a),d=this._createCubemapData(o,this._faceBack,e,r,a);return[c,l,_,u,h,d]},s._createCubemapData=function(e,r,a,o,c){for(var l=new Uint8ClampedArray(e*e*4),_=this._tempVector3.set(0,0,0).add(r[1]).subtract(r[0]).scale(1/e),u=this._temp2Vector3.set(0,0,0).add(r[3]).subtract(r[2]).scale(1/e),h=1/e,d=0,f=0;f<e;f++){for(var v=this._temp3Vector3.set(0,0,0).add(r[0]),p=this._temp4Vector3.set(0,0,0).add(r[2]),g=0;g<e;g++){var y=this._temp5Vector3.set(0,0,0).add(p).subtract(v).scale(d).add(v);y.normalize();var m=this._calcProjectionSpherical(y,a,o,c);this._RGBEToLinear(m),this._linearToRGBM(m,5);var x=f*e*4+g*4;l[x]=m.r,l[x+1]=m.g,l[x+2]=m.b,l[x+3]=m.a,v.add(_),p.add(u)}d+=h}return l},s._calcProjectionSpherical=function(e,r,a,o){for(var c=Math.atan2(e.z,e.x),l=Math.acos(e.y);c<-Zn;)c+=2*Zn;for(;c>Zn;)c-=2*Zn;var _=c/Zn,u=l/Zn;_=_*.5+.5;var h=Math.round(_*a);h<0?h=0:h>=a&&(h=a-1);var d=Math.round(u*o);d<0?d=0:d>=o&&(d=o-1);var f=o-d-1,v=f*a*4+h*4,p=r[v],g=r[v+1],y=r[v+2],m=r[v+3];return new q(p,g,y,m)},s._readStringLine=function(e,r){for(var a="",o="",c=r;c<e.length-r&&(o=String.fromCharCode(e[c]),o!=`
`);c++)a+=o;return a},s._parseHeader=function(e){var r=0,a=0,o=this._readStringLine(e,0);if(o[0]!="#"||o[1]!="?")throw"Bad HDR Format.";var c=!1,l=!1,_=0;do _+=o.length+1,o=this._readStringLine(e,_),o=="FORMAT=32-bit_rle_rgbe"?l=!0:o.length==0&&(c=!0);while(!c);if(!l)throw"HDR Bad header format, unsupported FORMAT";_+=o.length+1,o=this._readStringLine(e,_);var u=/^\-Y (.*) \+X (.*)$/g,h=u.exec(o);if(!h||h.length<3)throw"HDR Bad header format, no size";if(a=parseInt(h[2]),r=parseInt(h[1]),a<8||a>32767)throw"HDR Bad header format, unsupported size";return _+=o.length+1,{height:r,width:a,dataPosition:_}},s._readPixels=function(e,r,a){for(var o=r,c=e.byteLength,l=new Uint8Array(4*r*a),_=0,u=0,h=4*o,d=new Uint8Array(h),f=a;f>0&&u<c;){var v=e[u++],p=e[u++],g=e[u++],y=e[u++];if(v!=2||p!=2||g&128||r<8||r>32767)return e;if((g<<8|y)!=o)throw"HDR Bad header format, wrong scan line width";for(var m=0,x=void 0;m<h&&u<c;){x=e[u++];var C=x>128;if(C&&(x-=128),x===0||m+x>h)throw"HDR Bad Format, bad scanline data (run)";if(C)for(var b=e[u++],A=0;A<x;A++)d[m++]=b;else d.set(e.subarray(u,u+x),m),m+=x,u+=x}for(var S=o,w=0;w<S;w++){var E=0;l[_]=d[w+E],E+=o,l[_+1]=d[w+E],E+=o,l[_+2]=d[w+E],E+=o,l[_+3]=d[w+E],_+=4}f--}return l},s._RGBEToLinear=function(e){var r=Math.pow(2,e.a-128)/255;e.r*=r,e.g*=r,e.b*=r,e.a=1},s._linearToRGBM=function(e,r){var a=Math.max(e.r,Math.max(e.g,e.b)),o=Math.min(a/r,1);o=Math.ceil(o*255);var c=65025/(o*r);e.r*=c,e.g*=c,e.b*=c,e.a*=o},s}(Be),function(){fe._rightBottomBack=new R(1,-1,-1)}(),function(){fe._rightBottomFront=new R(1,-1,1)}(),function(){fe._rightUpBack=new R(1,1,-1)}(),function(){fe._rightUpFront=new R(1,1,1)}(),function(){fe._leftBottomBack=new R(-1,-1,-1)}(),function(){fe._leftBottomFront=new R(-1,-1,1)}(),function(){fe._leftUpBack=new R(-1,1,-1)}(),function(){fe._leftUpFront=new R(-1,1,1)}(),function(){fe._faceRight=[fe._rightBottomBack,fe._rightBottomFront,fe._rightUpBack,fe._rightUpFront]}(),function(){fe._faceLeft=[fe._leftBottomFront,fe._leftBottomBack,fe._leftUpFront,fe._leftUpBack]}(),function(){fe._faceUp=[fe._leftBottomFront,fe._rightBottomFront,fe._leftBottomBack,fe._rightBottomBack]}(),function(){fe._faceBottom=[fe._leftUpBack,fe._rightUpBack,fe._leftUpFront,fe._rightUpFront]}(),function(){fe._faceFront=[fe._leftBottomBack,fe._rightBottomBack,fe._leftUpBack,fe._rightUpBack]}(),function(){fe._faceBack=[fe._rightBottomFront,fe._leftBottomFront,fe._rightUpFront,fe._leftUpFront]}(),function(){fe._tempVector3=new R}(),function(){fe._temp2Vector3=new R}(),function(){fe._temp3Vector3=new R}(),function(){fe._temp4Vector3=new R}(),function(){fe._temp5Vector3=new R}(),fe);Ta=le([Xe(Ve.HDR,["hdr"])],Ta);var js=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e){return this.request(e.url,Bt({},e,{type:"json"}))},s}(Be);js=le([Xe(Ve.JSON,["json"],!1)],js);var Kh=12+13*4,Jh=0;function Zh(n,s){for(var i=[],t=Kh+n.bytesOfKeyValueData,e=n.pixelWidth,r=n.pixelHeight,a=n.numberOfMipmapLevels,o=0;o<a;o++){var c=new Int32Array(n.buffer,t,1)[0];t+=4;for(var l=0;l<n.numberOfFaces;l++){var _=new Uint8Array(n.buffer,t,c);i.push({data:_,width:e,height:r}),t+=c,t+=3-(c+3)%4}e=Math.max(1,e*.5),r=Math.max(1,r*.5)}return i}function $h(n){if(n.byteLength>=12){var s=new Uint8Array(n,0,12);if(s[0]===171&&s[1]===75&&s[2]===84&&s[3]===88&&s[4]===32&&s[5]===49&&s[6]===49&&s[7]===187&&s[8]===13&&s[9]===10&&s[10]===26&&s[11]===10)return!0}return!1}function ed(n){switch(n){case _e.RGB_S3TC_DXT1_EXT:return G.BC1;case _e.RGBA_S3TC_DXT5_EXT:return G.BC3;case _e.RGBA_BPTC_UNORM_EXT:return G.BC7;case _e.RGB_ETC1_WEBGL:return G.ETC1_RGB;case _e.RGB8_ETC2:return G.ETC2_RGB;case _e.RGB8_PUNCHTHROUGH_ALPHA1_ETC2:return G.ETC2_RGBA5;case _e.RGBA8_ETC2_EAC:return G.ETC2_RGBA8;case _e.RGB_PVRTC_2BPPV1_IMG:return G.PVRTC_RGB2;case _e.RGBA_PVRTC_2BPPV1_IMG:return G.PVRTC_RGBA2;case _e.RGB_PVRTC_4BPPV1_IMG:return G.PVRTC_RGB4;case _e.RGBA_PVRTC_4BPPV1_IMG:return G.PVRTC_RGBA4;case _e.RGBA_ASTC_4X4_KHR:return G.ASTC_4x4;case _e.RGBA_ASTC_5X5_KHR:return G.ASTC_5x5;case _e.RGBA_ASTC_6X6_KHR:return G.ASTC_6x6;case _e.RGBA_ASTC_8X8_KHR:return G.ASTC_8x8;case _e.RGBA_ASTC_10X10_KHR:return G.ASTC_10x10;case _e.RGBA_ASTC_12X12_KHR:return G.ASTC_12x12;default:var s=_e[n];throw new Error("this format is not supported in Galacean Engine: "+s)}}var tl={parse:function(s,i,t,e){if(e===void 0&&(e=!1),!$h(s))throw new Error("khronosTextureContainerParser: invalid KTX file, texture missing KTX identifier");var r=Uint32Array.BYTES_PER_ELEMENT,a=new DataView(s,12,13*r),o=a.getUint32(0,!0),c=o===67305985,l={buffer:s,glType:a.getUint32(1*r,c),glTypeSize:a.getUint32(2*r,c),glFormat:a.getUint32(3*r,c),glInternalFormat:a.getUint32(4*r,c),glBaseInternalFormat:a.getUint32(5*r,c),pixelWidth:a.getUint32(6*r,c),pixelHeight:a.getUint32(7*r,c),pixelDepth:a.getUint32(8*r,c),numberOfArrayElements:a.getUint32(9*r,c),numberOfFaces:a.getUint32(10*r,c),numberOfMipmapLevels:a.getUint32(11*r,c),bytesOfKeyValueData:a.getUint32(12*r,c),loadType:Jh};if(l.glType!==0)throw new Error("only compressed formats currently supported");if(l.numberOfMipmapLevels=Math.max(1,l.numberOfMipmapLevels),l.pixelHeight===0||l.pixelDepth!==0)throw new Error("only 2D textures currently supported");if(l.numberOfArrayElements!==0)throw new Error("texture arrays not currently supported");if(l.numberOfFaces!==i)throw new Error("number of faces expected"+i+", but found "+l.numberOfFaces);return t&&(l.mipmaps=Zh(l)),e&&(l.engineFormat=ed(l.glInternalFormat)),l}};function td(n){var s=tl.parse(n,1,!0,!0);return{mipmaps:s.mipmaps,engineFormat:s.engineFormat,internalFormat:s.glInternalFormat,width:s.pixelWidth,height:s.pixelHeight}}function rd(n){for(var s=[],i,t,e,r,a=0;a<n.length;a++){var o=tl.parse(n[a],1,!0,!0);s.push(o.mipmaps),a===0&&(e=o.pixelWidth,r=o.pixelHeight,i=o.glInternalFormat,t=o.engineFormat)}return{mipmapsFaces:s,engineFormat:t,internalFormat:i,width:e,height:r}}var qs=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Pe(function(o,c){Promise.all(e.urls.map(function(l){return a.request(l,Bt({},e,{type:"arraybuffer"}))})).then(function(l){for(var _=rd(l),u=_.width,h=_.mipmapsFaces,d=_.engineFormat,f=h[0].length>1,v=new jt(r.engine,u,d,f),p=0;p<6;p++)for(var g=h[p].length,y=0;y<g;y++){var m=h[p][y],x=m.data,C=m.width,b=m.height;v.setPixelBuffer(wr.PositiveX+p,x,y,0,0,C,b)}o(v)}).catch(function(l){c(l)})})},s}(Be);qs=le([Xe(Ve.KTXCube,[])],qs);var Ys=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Pe(function(o,c){a.request(e.url,Bt({},e,{type:"arraybuffer"})).then(function(l){for(var _=td(l),u=_.width,h=_.height,d=_.mipmaps,f=_.engineFormat,v=d.length>1,p=new Tt(r.engine,u,h,f,v),g=0;g<d.length;g++){var y=d[g],m=y.width,x=y.height,C=y.data;p.setPixelBuffer(C,g,0,0,m,x)}o(p)}).catch(function(l){c(l)})})},s}(Be);Ys=le([Xe(Ve.KTX,["ktx"])],Ys);function rl(n,s,i){if(typeof i=="object")for(var t in i)rl(n[s],t,i[t]);else n[s]=i}var Qs=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Pe(function(o,c){a.request(e.url,Bt({},e,{type:"json"})).then(function(l){var _=function(E){var P=f[E],M=P.type,D=P.value;switch(M){case"Vector2":m.setVector2(E,new ee(D.x,D.y));break;case"Vector3":m.setVector3(E,new R(D.x,D.y,D.z));break;case"Vector4":m.setVector4(E,new ie(D.x,D.y,D.z,D.w));break;case"Color":m.setColor(E,new q(D.r,D.g,D.b,D.a));break;case"Float":m.setFloat(E,D);break;case"Texture":y.push(r.getResourceByRef(D).then(function(L){m.setTexture(E,L)}));break;case"Boolean":m.setInt(E,D?1:0);break;case"Integer":m.setInt(E,Number(D));break}},u=r.engine,h=l.name,d=l.shader,f=l.shaderData,v=l.macros,p=l.renderState,g=new Sr(u,Se.find(d));g.name=h;var y=new Array,m=g.shaderData;for(var x in f)_(x);for(var C=0,b=v.length;C<b;C++){var A=v[C],S=A.name,w=A.value;w==null?m.enableMacro(S):m.enableMacro(S,w)}return rl(g,"renderState",p),Promise.all(y).then(function(){o(g)})}).catch(c)})},s}(Be);Qs=le([Xe(Ve.Material,["json"])],Qs);var Ks=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Pe(function(o,c){a.request(e.url,Bt({},e,{type:"arraybuffer"})).then(function(l){return Qi(l,r.engine)}).then(function(l){o(l)}).catch(c)})},s}(Be);Ks=le([Xe(Ve.Mesh,["mesh"])],Ks);var Js=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=r.engine;return this.request(e.url,Bt({},e,{type:"json"})).then(function(o){switch(o.type){case"sphere":return at.createSubdivisionSurfaceSphere(a,o.sphereRadius,o.sphereStep);case"capsule":return at.createCapsule(a,o.capsuleRadius,o.capsuleHeight,o.capsuleRadialSegments,o.capsuleHeightSegments);case"cone":return at.createCone(a,o.coneRadius,o.coneHeight,o.coneRadialSegment,o.coneHeightSegment);case"cuboid":return at.createCuboid(a,o.cuboidWidth,o.cuboidHeight,o.cuboidDepth);case"cylinder":return at.createCylinder(a,o.cylinderRadiusTop,o.cylinderRadiusBottom,o.cylinderHeight,o.cylinderRadialSegment,o.cylinderHeightSegment);case"plane":return at.createPlane(a,o.planeWidth,o.planeHeight,o.planeHorizontalSegments,o.planeVerticalSegments);case"torus":return at.createTorus(a,o.torusRadius,o.torusTubeRadius,o.torusRadialSegments,o.torusTubularSegments,o.torusArc)}})},s}(Be);Js=le([Xe(Ve.PrimitiveMesh,["mesh"],!1)],Js);var Zs;(function(n){n.Sphere="sphere",n.Cuboid="cuboid",n.Plane="plane",n.Cylinder="cylinder",n.Torus="torus",n.Cone="cone",n.Capsule="capsule"})(Zs||(Zs={}));var $s=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this,o=r.engine;return new Pe(function(c,l){a.request(e.url,{type:"json"}).then(function(_){return o.resourceManager.initVirtualResources(_.files),r.load({type:Ve.Scene,url:_.scene}).then(function(u){o.sceneManager.activeScene=u,c()})}).catch(l)})},s}(Be);$s=le([Xe(Ve.Project,["proj"],!1)],$s);var ec=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Pe(function(o,c){var l=e.url;a._registerFont(l,l).then(function(){var _=new _a(r.engine,l);o(_)}).catch(function(_){c("load font "+l+" fail")})})},i._registerFont=function(e,r){return Ki(function(){var a;return qi(this,function(o){switch(o.label){case 0:return a=new FontFace(e,"url("+r+")"),[4,a.load()];case 1:return o.sent(),document.fonts.add(a),[2]}})})()},s}(Be);ec=le([Xe(Ve.SourceFont,["ttf","otf","woff"],!1)],ec);var tc=function(n){ne(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t._tempRect=new Gr,t._tempVec2=new ee,t._tempVec4=new ie,t}var i=s.prototype;return i.load=function(e,r){var a=this;return new Pe(function(o,c,l,_,u){var h=[];u(function(){for(var f=0;f<h.length;f++)h[f].cancel()});var d=a.request(e.url,Bt({},e,{type:"json"}));h.push(d),d.then(function(f){var v=function(P){var M=p[P];if(M.img){var D;h.push(r.load({url:Ue.resolveAbsoluteUrl(e.url,M.img),type:(D=M.type)!=null?D:Ve.Texture2D,params:{format:b,mipmap:g}}).then(function(V){y&&(V.anisoLevel=y),m!==void 0&&(V.filterMode=m),x!==void 0&&(V.wrapModeU=x),C!==void 0&&(V.wrapModeV=C);for(var N=0;N<M.sprites.length;N++)w._addSprite(a._makeSprite(S,M.sprites[N],V))}).catch(c))}else for(var L=0;L<M.sprites.length;L++)w._addSprite(a._makeSprite(S,M.sprites[L]))},p=f.atlasItems,g=f.mipmap,y=f.anisoLevel,m=f.filterMode,x=f.wrapModeU,C=f.wrapModeV,b=f.format,A=p?p.length:0,S=r.engine,w=new bc(S);if(A<0){o(w);return}h.length=0;for(var E=0;E<p.length;E++)v(E);Pe.all(h).then(function(){o(w)}).catch(c)}).catch(c)})},i._makeSprite=function(e,r,a){var o=r.region,c=r.atlasRegionOffset,l=r.atlasRegion,_=r.pivot,u=r.border,h=r.width,d=r.height,f=new vi(e,a,o?this._tempRect.set(o.x,o.y,o.w,o.h):void 0,_?this._tempVec2.set(_.x,_.y):void 0,u?this._tempVec4.set(u.x,u.y,u.z,u.w):void 0,r.name);if(a){var v=1/a.width,p=1/a.height;if(f.atlasRegion.set(l.x*v,l.y*p,l.w*v,l.h*p),c){var g=c.x,y=c.y,m=c.z,x=c.w;f.atlasRegionOffset.set(g*v,y*p,m*v,x*p)}r.atlasRotated&&(f.atlasRotated=!0)}return isNaN(h)||(f.width=h),isNaN(d)||(f.height=d),f},s}(Be);tc=le([Xe(Ve.SpriteAtlas,["atlas"],!1)],tc);var rc=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return this.request(e.url,Bt({},e,{type:"json"})).then(function(o){return o.belongToAtlas?a._loadFromAtlas(r,o):a._loadFromTexture(r,o)})},i._loadFromAtlas=function(e,r){var a=this;return e.getResourceByRef(r.belongToAtlas).then(function(o){return o.getSprite(r.fullPath)||a._loadFromTexture(e,r)})},i._loadFromTexture=function(e,r){return r.texture?e.getResourceByRef(r.texture).then(function(a){var o=new vi(e.engine,a,r.region,r.pivot,r.border),c=r.width,l=r.height;return isNaN(c)||(o.width=c),isNaN(l)||(o.height=l),o}):new Pe(function(a){var o=new vi(e.engine,null,r.region,r.pivot,r.border),c=r.width,l=r.height;isNaN(c)||(o.width=c),isNaN(l)||(o.height=l),a(o)})},s}(Be);rc=le([Xe(Ve.Sprite,["sprite"],!1)],rc);var nd=function(n){ne(s,n);function s(t,e,r){var a;return a=n.call(this,t)||this,a.url=e,a.requestConfig=r,a}var i=s.prototype;return i.restoreContent=function(){var e=this;return Qn(this.url,this.requestConfig).then(function(r){var a=e.resource;return a.setImageSource(r),a.generateMipmaps(),a})},s}(br),nc=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Pe(function(o,c,l,_){var u=e.url,h=Bt({},e,{type:"image"});a.request(u,h).onProgress(l,_).then(function(d){var f,v=(f=e.params)!=null?f:{},p=v.format,g=v.mipmap,y=v.anisoLevel,m=v.wrapModeU,x=v.wrapModeV,C=v.filterMode,b=new Tt(r.engine,d.width,d.height,p,g);if(b.anisoLevel=y??b.anisoLevel,b.filterMode=C??b.filterMode,b.wrapModeU=m??b.wrapModeU,b.wrapModeV=x??b.wrapModeV,b.setImageSource(d),b.generateMipmaps(),u.indexOf("data:")!==0){var A=u.lastIndexOf("/");b.name=u.substring(A+1)}r.addContentRestorer(new nd(b,u,h)),o(b)}).catch(function(d){c(d)})})},s}(Be);nc=le([Xe(Ve.Texture2D,["png","jpg","webp","jpeg"])],nc);var ad=function(n){ne(s,n);function s(t,e,r){var a;return a=n.call(this,t)||this,a.urls=e,a.requestConfig=r,a}var i=s.prototype;return i.restoreContent=function(){var e=this;return new Pe(function(r,a){Promise.all(e.urls.map(function(o){return Qn(o,e.requestConfig)})).then(function(o){for(var c=e.resource,l=0;l<6;l++)c.setImageSource(wr.PositiveX+l,o[l],0);c.generateMipmaps(),r(c)}).catch(function(o){a(o)})})},s}(br),ac=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Pe(function(o,c){var l=e.urls,_=Bt({},e,{type:"image"});Promise.all(l.map(function(u){return a.request(u,_)})).then(function(u){var h=u[0],d=h.width,f=h.height;if(d!==f){console.error("The cube texture must have the same width and height");return}for(var v=new jt(r.engine,d),p=0;p<6;p++)v.setImageSource(wr.PositiveX+p,u[p],0);v.generateMipmaps(),r.addContentRestorer(new ad(v,l,_)),o(v)}).catch(function(u){c(u)})})},s}(Be);ac=le([Xe(Ve.TextureCube,[""])],ac);var ic=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this,o=r.engine;return new Pe(function(c,l){a.request(e.url,{type:"json"}).then(function(_){return Nh.parse(o,_).then(function(u){var h=[],d=_.scene.ambient;if(d){var f=d.specularMode===mo.Custom,v=d.diffuseMode===Xn.SphericalHarmonics;u.ambientLight.diffuseIntensity=d.diffuseIntensity,u.ambientLight.specularIntensity=d.specularIntensity,u.ambientLight.diffuseMode=d.diffuseMode,u.ambientLight.diffuseSolidColor.copyFrom(d.diffuseSolidColor),u.ambientLight.specularTextureDecodeRGBM=!0,f&&d.customAmbientLight&&h.push(r.getResourceByRef(d.customAmbientLight).then(function(S){var w;u.ambientLight.specularTexture=(w=S)==null?void 0:w.specularTexture})),d.ambientLight&&(!f||v)&&h.push(r.getResourceByRef(d.ambientLight).then(function(S){if(!f){var w;u.ambientLight.specularTexture=(w=S)==null?void 0:w.specularTexture}if(v){var E;u.ambientLight.diffuseSphericalHarmonics=(E=S)==null?void 0:E.diffuseSphericalHarmonics}}))}var p=_.scene.background;switch(u.background.mode=p.mode,u.background.mode){case cn.SolidColor:u.background.solidColor.copyFrom(p.color);break;case cn.Sky:if(p.skyMesh&&p.skyMaterial){var g=r.getResourceByRef(p.skyMesh).then(function(S){u.background.sky.mesh=S}),y=r.getResourceByRef(p.skyMaterial).then(function(S){u.background.sky.material=S});h.push(g,y)}else ve.warn("Sky background mode requires skyMesh and skyMaterial");break;case cn.Texture:if(p.texture){var m=r.getResourceByRef(p.texture).then(function(S){u.background.texture=S});h.push(m)}break}var x=_.scene.shadow;if(x){x.castShadows!=null&&(u.castShadows=x.castShadows),x.shadowResolution!=null&&(u.shadowResolution=x.shadowResolution),x.shadowDistance!=null&&(u.shadowDistance=x.shadowDistance),x.shadowCascades!=null&&(u.shadowCascades=x.shadowCascades);var C;u.shadowTwoCascadeSplits=(C=x.shadowTwoCascadeSplits)!=null?C:u.shadowTwoCascadeSplits,x.shadowFourCascadeSplits&&u.shadowFourCascadeSplits.copyFrom(x.shadowFourCascadeSplits);var b;u.shadowFadeBorder=(b=x.shadowFadeBorder)!=null?b:u.shadowFadeBorder}var A=_.scene.fog;return A&&(A.fogMode!=null&&(u.fogMode=A.fogMode),A.fogStart!=null&&(u.fogStart=A.fogStart),A.fogEnd!=null&&(u.fogEnd=A.fogEnd),A.fogDensity!=null&&(u.fogDensity=A.fogDensity),A.fogColor!=null&&u.fogColor.copyFrom(A.fogColor)),Promise.all(h).then(function(){c(u)})})}).catch(l)})},s}(Be);ic=le([Xe(Ve.Scene,["scene"],!0)],ic);ko.registerCustomParseComponent("TextRenderer",Ki(function(n,s){var i;return qi(this,function(t){return i=s.props,i.font||(n.font=_a.createFromOS(n.engine,i.fontFamily||"Arial")),[2,n]})}));var oc=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.additiveParse=function(e,r,a){var o,c=e.glTF.extensions.KHR_lights_punctual.lights,l=c[a.light],_=l.color,u=l.intensity,h=u===void 0?1:u,d=l.type,f=l.range,v=l.spot,p=e.glTFResource,g;if(d==="directional"?g=r.addComponent(jn):d==="point"?g=r.addComponent(Yn):d==="spot"&&(g=r.addComponent(Fr)),_&&g.color.set(_[0],_[1],_[2],1),g.intensity=h,f&&!Ao(g,jn)&&(g.distance=f),v&&Ao(g,Fr)){var y=v.innerConeAngle,m=y===void 0?0:y,x=v.outerConeAngle,C=x===void 0?Math.PI/4:x;g.angle=m,g.penumbra=C-m}(o=p).lights||(o.lights=[]),p.lights.push(g)},s}(hr);oc=le([dr("KHR_lights_punctual",At.AdditiveParse)],oc);var sc=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.additiveParse=function(e,r,a){var o=a.clearcoatFactor,c=o===void 0?0:o,l=a.clearcoatTexture,_=a.clearcoatRoughnessFactor,u=_===void 0?0:_,h=a.clearcoatRoughnessTexture,d=a.clearcoatNormalTexture;r.clearCoat=c,r.clearCoatRoughness=u,l&&(bt._checkOtherTextureTransform(l,"Clear coat"),e.get(pe.Texture,l.index).then(function(f){r.clearCoatTexture=f})),h&&(bt._checkOtherTextureTransform(h,"Clear coat roughness"),e.get(pe.Texture,h.index).then(function(f){r.clearCoatRoughnessTexture=f})),d&&(bt._checkOtherTextureTransform(d,"Clear coat normal"),e.get(pe.Texture,d.index).then(function(f){r.clearCoatNormalTexture=f}))},s}(hr);sc=le([dr("KHR_materials_clearcoat",At.AdditiveParse)],sc);var cc=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.additiveParse=function(e,r,a){var o=a.ior,c=o===void 0?1.5:o;r.ior=c},s}(hr);cc=le([dr("KHR_materials_ior",At.AdditiveParse)],cc);var lc=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.createAndParse=function(e,r,a){var o=e.glTFResource.engine,c=new qn(o),l=r.diffuseFactor,_=r.diffuseTexture,u=r.specularFactor,h=r.glossinessFactor,d=r.specularGlossinessTexture;return l&&(c.baseColor=new q(q.linearToGammaSpace(l[0]),q.linearToGammaSpace(l[1]),q.linearToGammaSpace(l[2]),l[3])),_&&e.get(pe.Texture,_.index).then(function(f){c.baseTexture=f,Fe.executeExtensionsAdditiveAndParse(_.extensions,e,c,_)}),u&&(c.specularColor=new q(q.linearToGammaSpace(u[0]),q.linearToGammaSpace(u[1]),q.linearToGammaSpace(u[2]))),h!==void 0&&(c.glossiness=h),d&&(bt._checkOtherTextureTransform(d,"Specular glossiness"),e.get(pe.Texture,d.index).then(function(f){c.specularGlossinessTexture=f})),c.name=a.name,bt._parseStandardProperty(e,c,a),c},s}(hr);lc=le([dr("KHR_materials_pbrSpecularGlossiness",At.CreateAndParse)],lc);var _c=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.createAndParse=function(e,r,a){var o=e.glTFResource.engine,c=new Pc(o);return c.name=a.name,bt._parseStandardProperty(e,c,a),c},s}(hr);_c=le([dr("KHR_materials_unlit",At.CreateAndParse)],_c);var uc=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.additiveParse=function(e,r,a){var o=function(g){var y=f[g],m=y.material,x=y.variants;e.get(pe.Material,m).then(function(C){v.push({renderer:r,material:C,variants:x.map(function(b){return h[b].name})})})},c,l=e.glTF,_=l.extensions,u=_.KHR_materials_variants,h=u.variants,d=e.glTFResource,f=a.mappings;(c=d)._extensionsData||(c._extensionsData={});var v=[];d.extensionsData.variants=v;for(var p=0;p<f.length;p++)o(p)},s}(hr);uc=le([dr("KHR_materials_variants",At.AdditiveParse)],uc);var hc=function(n){ne(s,n);function s(){return n.apply(this,arguments)}return s}(hr);hc=le([dr("KHR_mesh_quantization",At.AdditiveParse)],hc);var dc=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.createAndParse=function(e,r,a){return Ki(function(){var o,c,l,_,u,h,d,f,v,p,g,y,m,x,C,b;return qi(this,function(A){return o=e.glTF,c=e.glTFResource,l=c.engine,_=c.url,u=a.sampler,h=a.name,d=r.source,f=o.images[d],v=f.uri,p=f.bufferView,g=f.mimeType,y=f.name,m=u!==void 0&&Ke.getSamplerInfo(o.samplers[u]),v?(x=v.lastIndexOf("."),C=l.resourceManager.load({url:Ue.resolveAbsoluteUrl(_,v),type:Ve.KTX2}).onProgress(void 0,e._onTaskDetail).then(function(S){return S.name||(S.name=h||y||"texture_"+x),u!==void 0&&Ke.parseSampler(S,m),S}),e._addTaskCompletePromise(C),[2,C]):(b=o.bufferViews[p],[2,e.get(pe.Buffer,b.buffer).then(function(S){var w=new Uint8Array(S,b.byteOffset,b.byteLength);return yt._parseBuffer(w,l).then(function(E){var P=E.engine,M=E.result,D=E.targetFormat,L=E.params;return yt._createTextureByBuffer(P,M,D,L)}).then(function(E){E.name=h||y||"texture_"+p,u!==void 0&&Ke.parseSampler(E,m);var P=new el(E,b,g);return e.contentRestorer.bufferTextures.push(P),E})})])})})()},s}(hr);dc=le([dr("KHR_texture_basisu",At.CreateAndParse)],dc);var fc=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.additiveParse=function(e,r,a){var o=a.offset,c=a.rotation,l=a.scale,_=a.texCoord;o&&(r.tilingOffset.z=o[0],r.tilingOffset.w=o[1]),l&&(r.tilingOffset.x=l[0],r.tilingOffset.y=l[1]),c&&ve.warn("rotation in KHR_texture_transform is not supported now"),_&&ve.warn("texCoord in KHR_texture_transform is not supported now")},s}(hr);fc=le([dr("KHR_texture_transform",At.AdditiveParse)],fc);var vc=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.createAndParse=function(e,r){var a=e.glTFResource.engine,o=a.resourceManager.getResourceByRef(r);return e._addTaskCompletePromise(o),o},s}(hr);vc=le([dr("GALACEAN_materials_remap",At.CreateAndParse)],vc);var pc=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.additiveParse=function(e,r,a){e.glTFResource.engine;var o=a.events;o.map(function(c){var l=new ji;l.functionName=c.functionName,l.time=c.time,l.parameter=c.parameter,r.addEvent(l)})},s}(hr);pc=le([dr("GALACEAN_animation_event",At.AdditiveParse)],pc);var gc=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.createAndParse=function(e,r){return e.get(pe.Buffer,r.buffer).then(function(a){return fi.decodeGltfBuffer(r.count,r.byteStride,new Uint8Array(a,r.byteOffset,r.byteLength),r.mode,r.filter)})},s}(hr);gc=le([dr("EXT_meshopt_compression",At.CreateAndParse)],gc);var mc=function(n){ne(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.additiveParse=function(e,r,a){var o=a.anisotropyStrength,c=o===void 0?0:o,l=a.anisotropyRotation,_=l===void 0?0:l,u=a.anisotropyTexture;r.anisotropy=c,r.anisotropyRotation=_,u&&(bt._checkOtherTextureTransform(u,"Anisotropy texture"),e.get(pe.Texture,u.index).then(function(h){r.anisotropyTexture=h}))},s}(hr);mc=le([dr("KHR_materials_anisotropy",At.AdditiveParse)],mc);var id="1.2.0-beta.5";console.log("Galacean engine version: "+id);for(var yc in vs)Be.registerClass(yc,vs[yc]);export{ht as $,Ve as A,Fc as B,ze as C,jn as D,Yt as E,qt as F,We as G,Fr as H,Zt as I,xi as J,na as K,ve as L,Ir as M,dt as N,K as O,Xr as P,Re as Q,Da as R,dn as S,Tt as T,Pc as U,R as V,od as W,un as X,Nc as Y,Wi as Z,lr as _,Kr as a,cn as a0,zt as a1,An as a2,ie as a3,gt as a4,oe as a5,vi as a6,mt as a7,rt as a8,at as b,uu as c,ou as d,Ht as e,q as f,_h as g,On as h,$t as i,hh as j,Xt as k,he as l,Yn as m,O as n,Se as o,il as p,Z as q,ee as r,ra as s,k as t,zr as u,ka as v,Hn as w,G as x,ye as y,vt as z};
