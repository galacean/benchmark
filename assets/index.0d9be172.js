var at;(function(n){n[n.Disjoint=0]="Disjoint",n[n.Contains=1]="Contains",n[n.Intersects=2]="Intersects"})(at||(at={}));var Ut;(function(n){n[n.Back=0]="Back",n[n.Front=1]="Front",n[n.Intersecting=2]="Intersecting"})(Ut||(Ut={}));var Ce;(function(n){n[n.Near=0]="Near",n[n.Far=1]="Far",n[n.Left=2]="Left",n[n.Right=3]="Right",n[n.Bottom=4]="Bottom",n[n.Top=5]="Top"})(Ce||(Ce={}));function _s(n,s){for(var i=0;i<s.length;i++){var t=s[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function Ea(n,s,i){return s&&_s(n.prototype,s),i&&_s(n,i),n}var k=function(){function n(){}return n.clamp=function(i,t,e){return Math.max(t,Math.min(e,i))},n.equals=function(i,t){return Math.abs(i-t)<=n.zeroTolerance},n.isPowerOf2=function(i){return(i&i-1)===0},n.radianToDegree=function(i){return i*n.radToDegreeFactor},n.degreeToRadian=function(i){return i*n.degreeToRadFactor},n}();(function(){k.zeroTolerance=1e-6})();(function(){k.radToDegreeFactor=180/Math.PI})();(function(){k.degreeToRadFactor=Math.PI/180})();var w=function(){function n(i,t,e){i===void 0&&(i=0),t===void 0&&(t=0),e===void 0&&(e=0),this._onValueChanged=null,this._x=i,this._y=t,this._z=e}var s=n.prototype;return s.set=function(t,e,r){return this._x=t,this._y=e,this._z=r,this._onValueChanged&&this._onValueChanged(),this},s.add=function(t){return this._x+=t._x,this._y+=t._y,this._z+=t._z,this._onValueChanged&&this._onValueChanged(),this},s.subtract=function(t){return this._x-=t._x,this._y-=t._y,this._z-=t._z,this._onValueChanged&&this._onValueChanged(),this},s.multiply=function(t){return this._x*=t._x,this._y*=t._y,this._z*=t._z,this._onValueChanged&&this._onValueChanged(),this},s.divide=function(t){return this._x/=t._x,this._y/=t._y,this._z/=t._z,this._onValueChanged&&this._onValueChanged(),this},s.length=function(){var t=this,e=t._x,r=t._y,a=t._z;return Math.sqrt(e*e+r*r+a*a)},s.lengthSquared=function(){var t=this,e=t._x,r=t._y,a=t._z;return e*e+r*r+a*a},s.negate=function(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._onValueChanged&&this._onValueChanged(),this},s.normalize=function(){return n.normalize(this,this),this},s.scale=function(t){return this._x*=t,this._y*=t,this._z*=t,this._onValueChanged&&this._onValueChanged(),this},s.transformNormal=function(t){return n.transformNormal(this,t,this),this},s.transformToVec3=function(t){return n.transformToVec3(this,t,this),this},s.transformCoordinate=function(t){return n.transformCoordinate(this,t,this),this},s.transformByQuat=function(t){return n.transformByQuat(this,t,this),this},s.clone=function(){return new n(this._x,this._y,this._z)},s.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._onValueChanged&&this._onValueChanged(),this},s.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._onValueChanged&&this._onValueChanged(),this},s.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z},s.toJSON=function(){return{x:this._x,y:this._y,z:this._z}},n.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._z=t._z+e._z,r._onValueChanged&&r._onValueChanged()},n.subtract=function(t,e,r){r._x=t._x-e._x,r._y=t._y-e._y,r._z=t._z-e._z,r._onValueChanged&&r._onValueChanged()},n.multiply=function(t,e,r){r._x=t._x*e._x,r._y=t._y*e._y,r._z=t._z*e._z,r._onValueChanged&&r._onValueChanged()},n.divide=function(t,e,r){r._x=t._x/e._x,r._y=t._y/e._y,r._z=t._z/e._z,r._onValueChanged&&r._onValueChanged()},n.dot=function(t,e){return t._x*e._x+t._y*e._y+t._z*e._z},n.cross=function(t,e,r){var a=t._x,o=t._y,l=t._z,c=e._x,_=e._y,u=e._z;r.set(o*u-l*_,l*c-a*u,a*_-o*c)},n.distance=function(t,e){var r=e._x-t._x,a=e._y-t._y,o=e._z-t._z;return Math.sqrt(r*r+a*a+o*o)},n.distanceSquared=function(t,e){var r=e._x-t._x,a=e._y-t._y,o=e._z-t._z;return r*r+a*a+o*o},n.equals=function(t,e){return k.equals(t._x,e._x)&&k.equals(t._y,e._y)&&k.equals(t._z,e._z)},n.lerp=function(t,e,r,a){var o=t._x,l=t._y,c=t._z;a._x=o+(e._x-o)*r,a._y=l+(e._y-l)*r,a._z=c+(e._z-c)*r,a._onValueChanged&&a._onValueChanged()},n.max=function(t,e,r){r._x=Math.max(t._x,e._x),r._y=Math.max(t._y,e._y),r._z=Math.max(t._z,e._z),r._onValueChanged&&r._onValueChanged()},n.min=function(t,e,r){r._x=Math.min(t._x,e._x),r._y=Math.min(t._y,e._y),r._z=Math.min(t._z,e._z),r._onValueChanged&&r._onValueChanged()},n.negate=function(t,e){e._x=-t._x,e._y=-t._y,e._z=-t._z,e._onValueChanged&&e._onValueChanged()},n.normalize=function(t,e){var r=t._x,a=t._y,o=t._z,l=Math.sqrt(r*r+a*a+o*o);l>k.zeroTolerance&&(l=1/l,e.set(r*l,a*l,o*l))},n.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._z=t._z*e,r._onValueChanged&&r._onValueChanged()},n.transformNormal=function(t,e,r){var a=t._x,o=t._y,l=t._z,c=e.elements;r._x=a*c[0]+o*c[4]+l*c[8],r._y=a*c[1]+o*c[5]+l*c[9],r._z=a*c[2]+o*c[6]+l*c[10],r._onValueChanged&&r._onValueChanged()},n.transformToVec3=function(t,e,r){var a=t._x,o=t._y,l=t._z,c=e.elements;r._x=a*c[0]+o*c[4]+l*c[8]+c[12],r._y=a*c[1]+o*c[5]+l*c[9]+c[13],r._z=a*c[2]+o*c[6]+l*c[10]+c[14],r._onValueChanged&&r._onValueChanged()},n.transformToVec4=function(t,e,r){var a=t._x,o=t._y,l=t._z,c=e.elements;r._x=a*c[0]+o*c[4]+l*c[8]+c[12],r._y=a*c[1]+o*c[5]+l*c[9]+c[13],r._z=a*c[2]+o*c[6]+l*c[10]+c[14],r._w=a*c[3]+o*c[7]+l*c[11]+c[15],r._onValueChanged&&r._onValueChanged()},n.transformCoordinate=function(t,e,r){var a=t._x,o=t._y,l=t._z,c=e.elements,_=a*c[3]+o*c[7]+l*c[11]+c[15];_=1/_,r._x=(a*c[0]+o*c[4]+l*c[8]+c[12])*_,r._y=(a*c[1]+o*c[5]+l*c[9]+c[13])*_,r._z=(a*c[2]+o*c[6]+l*c[10]+c[14])*_,r._onValueChanged&&r._onValueChanged()},n.transformByQuat=function(t,e,r){var a=t._x,o=t._y,l=t._z,c=e._x,_=e._y,u=e._z,d=e._w,h=d*a+_*l-u*o,f=d*o+u*a-c*l,v=d*l+c*o-_*a,p=-c*a-_*o-u*l;r._x=h*d-p*c-f*u+v*_,r._y=f*d-p*_-v*c+h*u,r._z=v*d-p*u-h*_+f*c,r._onValueChanged&&r._onValueChanged()},Ea(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this._onValueChanged&&this._onValueChanged()}}]),n}();(function(){w._zero=new w(0,0,0)})();(function(){w._one=new w(1,1,1)})();var ic=function(){function n(i,t){i===void 0&&(i=null),t===void 0&&(t=0),this.center=new w,this.radius=0,i&&this.center.copyFrom(i),this.radius=t}var s=n.prototype;return s.clone=function(){return new n(this.center,this.radius)},s.copyFrom=function(t){return this.center.copyFrom(t.center),this.radius=t.radius,this},n.fromPoints=function(t,e){if(!t||t.length===0)throw new Error("points must be array and length must > 0");var r=t.length,a=n._tempVec30;a.x=a.y=a.z=0;for(var o=0;o<r;++o)w.add(t[o],a,a);w.scale(a,1/r,e.center);for(var l=0,c=0;c<r;++c){var _=w.distanceSquared(a,t[c]);_>l&&(l=_)}e.radius=Math.sqrt(l)},n.fromBox=function(t,e){var r=e.center,a=t.min,o=t.max;r.x=(a.x+o.x)*.5,r.y=(a.y+o.y)*.5,r.z=(a.z+o.z)*.5,e.radius=w.distance(r,o)},n}();(function(){ic._tempVec30=new w})();var nr=function(){function n(i,t){i===void 0&&(i=null),t===void 0&&(t=null),this.min=new w,this.max=new w,i&&this.min.copyFrom(i),t&&this.max.copyFrom(t)}var s=n.prototype;return s.getCenter=function(t){var e=this,r=e.min,a=e.max,o=a._x+r._x,l=a._y+r._y,c=a._z+r._z;return t.set(isNaN(o)?0:o*.5,isNaN(l)?0:l*.5,isNaN(c)?0:c*.5),t},s.getExtent=function(t){var e=this,r=e.min,a=e.max,o=a._x-r._x,l=a._y-r._y,c=a._z-r._z;return t.set(isNaN(o)?0:o*.5,isNaN(l)?0:l*.5,isNaN(c)?0:c*.5),t},s.getCorners=function(t){t===void 0&&(t=[]);var e=this,r=e.min,a=e.max,o=r.x,l=r.y,c=r.z,_=a.x,u=a.y,d=a.z,h=t.length;if(h<8)for(var f=0,v=8-h;f<v;++f)t[h+f]=new w;return t[0].set(o,u,d),t[1].set(_,u,d),t[2].set(_,l,d),t[3].set(o,l,d),t[4].set(o,u,c),t[5].set(_,u,c),t[6].set(_,l,c),t[7].set(o,l,c),t},s.transform=function(t){return n.transform(this,t,this),this},s.clone=function(){return new n(this.min,this.max)},s.copyFrom=function(t){return this.min.copyFrom(t.min),this.max.copyFrom(t.max),this},n.fromCenterAndExtent=function(t,e,r){w.subtract(t,e,r.min),w.add(t,e,r.max)},n.fromPoints=function(t,e){if(!t||t.length===0)throw new Error("points must be array and length must > 0");var r=e.min,a=e.max;r.x=r.y=r.z=Number.MAX_VALUE,a.x=a.y=a.z=-Number.MAX_VALUE;for(var o=0,l=t.length;o<l;++o){var c=t[o];w.min(r,c,r),w.max(a,c,a)}},n.fromSphere=function(t,e){var r=t.center,a=t.radius,o=e.min,l=e.max;o.x=r.x-a,o.y=r.y-a,o.z=r.z-a,l.x=r.x+a,l.y=r.y+a,l.z=r.z+a},n.transform=function(t,e,r){var a=n._tempVec30,o=n._tempVec31;t.getCenter(a),t.getExtent(o),w.transformCoordinate(a,e,a);var l=o.x,c=o.y,_=o.z,u=e.elements,d=u[0],h=u[1],f=u[2],v=u[4],p=u[5],g=u[6],y=u[8],m=u[9],x=u[10];o.set((d===0?0:Math.abs(l*d))+(v===0?0:Math.abs(c*v))+(y===0?0:Math.abs(_*y)),(h===0?0:Math.abs(l*h))+(p===0?0:Math.abs(c*p))+(m===0?0:Math.abs(_*m)),(f===0?0:Math.abs(l*f))+(g===0?0:Math.abs(c*g))+(x===0?0:Math.abs(_*x))),w.subtract(a,o,r.min),w.add(a,o,r.max)},n.merge=function(t,e,r){return w.min(t.min,e.min,r.min),w.max(t.max,e.max,r.max),r},n}();(function(){nr._tempVec30=new w})();(function(){nr._tempVec31=new w})();var Dt=function(){function n(){}return n.intersectionPointThreePlanes=function(i,t,e,r){var a=i.normal,o=t.normal,l=e.normal;w.cross(o,l,n._tempVec30),w.cross(l,a,n._tempVec31),w.cross(a,o,n._tempVec32);var c=-w.dot(a,n._tempVec30),_=-w.dot(o,n._tempVec31),u=-w.dot(l,n._tempVec32);w.scale(n._tempVec30,i.distance/c,n._tempVec30),w.scale(n._tempVec31,t.distance/_,n._tempVec31),w.scale(n._tempVec32,e.distance/u,n._tempVec32),w.add(n._tempVec30,n._tempVec31,r),w.add(r,n._tempVec32,r)},n.distancePlaneAndPoint=function(i,t){return w.dot(i.normal,t)+i.distance},n.intersectsPlaneAndPoint=function(i,t){var e=n.distancePlaneAndPoint(i,t);return e>0?Ut.Front:e<0?Ut.Back:Ut.Intersecting},n.intersectsPlaneAndBox=function(i,t){var e=t.min,r=t.max,a=i.normal,o=n._tempVec30,l=n._tempVec31;return a.x>=0?(o.x=r.x,l.x=e.x):(o.x=e.x,l.x=r.x),a.y>=0?(o.y=r.y,l.y=e.y):(o.y=e.y,l.y=r.y),a.z>=0?(o.z=r.z,l.z=e.z):(o.z=e.z,l.z=r.z),n.distancePlaneAndPoint(i,o)<0?Ut.Back:n.distancePlaneAndPoint(i,l)>0?Ut.Front:Ut.Intersecting},n.intersectsPlaneAndSphere=function(i,t){var e=t.center,r=t.radius,a=n.distancePlaneAndPoint(i,e);return a>r?Ut.Front:a<-r?Ut.Back:Ut.Intersecting},n.intersectsRayAndPlane=function(i,t){var e=t.normal,r=k.zeroTolerance,a=w.dot(e,i.direction);if(Math.abs(a)<r)return-1;var o=w.dot(e,i.origin),l=(-t.distance-o)/a;if(l<0){if(l<-r)return-1;l=0}return l},n.intersectsRayAndBox=function(i,t){var e=k.zeroTolerance,r=i.origin,a=i.direction,o=t.min,l=t.max,c=a.x,_=a.y,u=a.z,d=r.x,h=r.y,f=r.z,v=0,p=Number.MAX_VALUE;if(Math.abs(c)<e){if(d<o.x||d>l.x)return-1}else{var g=1/c,y=(o.x-d)*g,m=(l.x-d)*g;if(y>m){var x=y;y=m,m=x}if(v=Math.max(y,v),p=Math.min(m,p),v>p)return-1}if(Math.abs(_)<e){if(h<o.y||h>l.y)return-1}else{var S=1/_,b=(o.y-h)*S,A=(l.y-h)*S;if(b>A){var C=b;b=A,A=C}if(v=Math.max(b,v),p=Math.min(A,p),v>p)return-1}if(Math.abs(u)<e){if(f<o.z||f>l.z)return-1}else{var E=1/u,T=(o.z-f)*E,B=(l.z-f)*E;if(T>B){var M=T;T=B,B=M}if(v=Math.max(T,v),p=Math.min(B,p),v>p)return-1}return v},n.intersectsRayAndSphere=function(i,t){var e=i.origin,r=i.direction,a=t.center,o=t.radius,l=n._tempVec30;w.subtract(e,a,l);var c=w.dot(l,r),_=w.dot(l,l)-o*o;if(c>0&&_>0)return-1;var u=c*c-_;if(u<0)return-1;var d=-c-Math.sqrt(u);return d<0&&(d=0),d},n.intersectsBoxAndBox=function(i,t){return i.min.x>t.max.x||t.min.x>i.max.x||i.min.y>t.max.y||t.min.y>i.max.y?!1:!(i.min.z>t.max.z||t.min.z>i.max.z)},n.intersectsSphereAndSphere=function(i,t){var e=i.radius+t.radius;return w.distanceSquared(i.center,t.center)<e*e},n.intersectsSphereAndBox=function(i,t){var e=i.center,r=t.max,a=t.min,o=n._tempVec30;o.set(Math.max(a.x,Math.min(e.x,r.x)),Math.max(a.y,Math.min(e.y,r.y)),Math.max(a.z,Math.min(e.z,r.z)));var l=w.distanceSquared(e,o);return l<=i.radius*i.radius},n.intersectsFrustumAndBox=function(i,t){for(var e=t.min,r=t.max,a=n._tempVec30,o=0;o<6;++o){var l=i.getPlane(o),c=l.normal;if(a.set(c.x>=0?r.x:e.x,c.y>=0?r.y:e.y,c.z>=0?r.z:e.z),w.dot(c,a)<-l.distance)return!1}return!0},n.frustumContainsPoint=function(i,t){var e=n.distancePlaneAndPoint(i.near,t);return Math.abs(e)<k.zeroTolerance?at.Intersects:e<0?at.Disjoint:(e=n.distancePlaneAndPoint(i.far,t),Math.abs(e)<k.zeroTolerance?at.Intersects:e<0?at.Disjoint:(e=n.distancePlaneAndPoint(i.left,t),Math.abs(e)<k.zeroTolerance?at.Intersects:e<0?at.Disjoint:(e=n.distancePlaneAndPoint(i.right,t),Math.abs(e)<k.zeroTolerance?at.Intersects:e<0?at.Disjoint:(e=n.distancePlaneAndPoint(i.top,t),Math.abs(e)<k.zeroTolerance?at.Intersects:e<0?at.Disjoint:(e=n.distancePlaneAndPoint(i.bottom,t),Math.abs(e)<k.zeroTolerance?at.Intersects:e<0?at.Disjoint:at.Contains)))))},n.frustumContainsBox=function(i,t){for(var e=t.min,r=t.max,a=n._tempVec30,o=n._tempVec31,l=at.Contains,c=0;c<6;++c){var _=i.getPlane(c),u=_.normal;if(u.x>=0?(a.x=r.x,o.x=e.x):(a.x=e.x,o.x=r.x),u.y>=0?(a.y=r.y,o.y=e.y):(a.y=e.y,o.y=r.y),u.z>=0?(a.z=r.z,o.z=e.z):(a.z=e.z,o.z=r.z),n.intersectsPlaneAndPoint(_,a)===Ut.Back)return at.Disjoint;n.intersectsPlaneAndPoint(_,o)===Ut.Back&&(l=at.Intersects)}return l},n.frustumContainsSphere=function(i,t){for(var e=at.Contains,r=0;r<6;++r){var a=i.getPlane(r),o=n.intersectsPlaneAndSphere(a,t);if(o===Ut.Back)return at.Disjoint;if(o===Ut.Intersecting){e=at.Intersects;break}}return e},n}();(function(){Dt._tempVec30=new w})();(function(){Dt._tempVec31=new w})();(function(){Dt._tempVec32=new w})();var Ge=function(){function n(i,t){i===void 0&&(i=null),t===void 0&&(t=0),this.normal=new w,this.distance=0,i&&this.normal.copyFrom(i),this.distance=t}var s=n.prototype;return s.normalize=function(){return n.normalize(this,this),this},s.clone=function(){var t=new n;return t.copyFrom(this),t},s.copyFrom=function(t){return this.normal.copyFrom(t.normal),this.distance=t.distance,this},n.normalize=function(t,e){var r=t.normal,a=1/r.length();w.scale(r,a,e.normal),e.distance=t.distance*a},n.fromPoints=function(t,e,r,a){var o=t.x,l=t.y,c=t.z,_=e.x-o,u=e.y-l,d=e.z-c,h=r.x-o,f=r.y-l,v=r.z-c,p=u*v-d*f,g=d*h-_*v,y=_*f-u*h,m=1/Math.sqrt(p*p+g*g+y*y),x=p*m,S=g*m,b=y*m,A=a.normal;A.x=x,A.y=S,A.z=b,a.distance=-(x*o+S*l+b*c)},n}(),oc=function(){function n(i){i===void 0&&(i=null),this.near=new Ge,this.far=new Ge,this.left=new Ge,this.right=new Ge,this.top=new Ge,this.bottom=new Ge,i&&this.calculateFromMatrix(i)}var s=n.prototype;return s.getPlane=function(t){switch(t){case Ce.Near:return this.near;case Ce.Far:return this.far;case Ce.Left:return this.left;case Ce.Right:return this.right;case Ce.Bottom:return this.bottom;case Ce.Top:return this.top;default:return null}},s.calculateFromMatrix=function(t){var e=t.elements,r=e[0],a=e[1],o=e[2],l=e[3],c=e[4],_=e[5],u=e[6],d=e[7],h=e[8],f=e[9],v=e[10],p=e[11],g=e[12],y=e[13],m=e[14],x=e[15],S=this.near.normal;S.set(l+o,d+u,p+v),this.near.distance=x+m,this.near.normalize();var b=this.far.normal;b.set(l-o,d-u,p-v),this.far.distance=x-m,this.far.normalize();var A=this.left.normal;A.set(l+r,d+c,p+h),this.left.distance=x+g,this.left.normalize();var C=this.right.normal;C.set(l-r,d-c,p-h),this.right.distance=x-g,this.right.normalize();var E=this.bottom.normal;E.set(l+a,d+_,p+f),this.bottom.distance=x+y,this.bottom.normalize();var T=this.top.normal;T.set(l-a,d-_,p-f),this.top.distance=x-y,this.top.normalize()},s.intersectsBox=function(t){return Dt.intersectsFrustumAndBox(this,t)},s.intersectsSphere=function(t){return Dt.frustumContainsSphere(this,t)!==at.Disjoint},s.clone=function(){var t=new n;return t.copyFrom(this),t},s.copyFrom=function(t){return this.near.copyFrom(t.near),this.far.copyFrom(t.far),this.left.copyFrom(t.left),this.right.copyFrom(t.right),this.bottom.copyFrom(t.bottom),this.top.copyFrom(t.top),this},n}(),da=function(){function n(i,t,e,r,a,o,l,c,_){i===void 0&&(i=1),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),a===void 0&&(a=1),o===void 0&&(o=0),l===void 0&&(l=0),c===void 0&&(c=0),_===void 0&&(_=1),this.elements=new Float32Array(9);var u=this.elements;u[0]=i,u[1]=t,u[2]=e,u[3]=r,u[4]=a,u[5]=o,u[6]=l,u[7]=c,u[8]=_}var s=n.prototype;return s.set=function(t,e,r,a,o,l,c,_,u){var d=this.elements;return d[0]=t,d[1]=e,d[2]=r,d[3]=a,d[4]=o,d[5]=l,d[6]=c,d[7]=_,d[8]=u,this},s.add=function(t){return n.add(this,t,this),this},s.subtract=function(t){return n.subtract(this,t,this),this},s.multiply=function(t){return n.multiply(this,t,this),this},s.determinant=function(){var t=this.elements,e=t[0],r=t[1],a=t[2],o=t[3],l=t[4],c=t[5],_=t[6],u=t[7],d=t[8],h=d*l-c*u,f=-d*o+c*_,v=u*o-l*_;return e*h+r*f+a*v},s.identity=function(){var t=this.elements;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this},s.invert=function(){return n.invert(this,this),this},s.rotate=function(t){return n.rotate(this,t,this),this},s.scale=function(t){return n.scale(this,t,this),this},s.translate=function(t){return n.translate(this,t,this),this},s.transpose=function(){return n.transpose(this,this),this},s.clone=function(){var t=this.elements,e=new n(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]);return e},s.copyFrom=function(t){var e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],this},s.copyFromArray=function(t,e){e===void 0&&(e=0);for(var r=this.elements,a=0;a<12;a++)r[a]=t[a+e];return this},s.copyToArray=function(t,e){e===void 0&&(e=0);var r=this.elements;t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8]},s.copyFromMatrix=function(t){var e=t.elements,r=this.elements;return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[4],r[4]=e[5],r[5]=e[6],r[6]=e[8],r[7]=e[9],r[8]=e[10],this},n.add=function(t,e,r){var a=t.elements,o=e.elements,l=r.elements;l[0]=a[0]+o[0],l[1]=a[1]+o[1],l[2]=a[2]+o[2],l[3]=a[3]+o[3],l[4]=a[4]+o[4],l[5]=a[5]+o[5],l[6]=a[6]+o[6],l[7]=a[7]+o[7],l[8]=a[8]+o[8]},n.subtract=function(t,e,r){var a=t.elements,o=e.elements,l=r.elements;l[0]=a[0]-o[0],l[1]=a[1]-o[1],l[2]=a[2]-o[2],l[3]=a[3]-o[3],l[4]=a[4]-o[4],l[5]=a[5]-o[5],l[6]=a[6]-o[6],l[7]=a[7]-o[7],l[8]=a[8]-o[8]},n.multiply=function(t,e,r){var a=t.elements,o=e.elements,l=r.elements,c=a[0],_=a[1],u=a[2],d=a[3],h=a[4],f=a[5],v=a[6],p=a[7],g=a[8],y=o[0],m=o[1],x=o[2],S=o[3],b=o[4],A=o[5],C=o[6],E=o[7],T=o[8];l[0]=c*y+d*m+v*x,l[1]=_*y+h*m+p*x,l[2]=u*y+f*m+g*x,l[3]=c*S+d*b+v*A,l[4]=_*S+h*b+p*A,l[5]=u*S+f*b+g*A,l[6]=c*C+d*E+v*T,l[7]=_*C+h*E+p*T,l[8]=u*C+f*E+g*T},n.equals=function(t,e){var r=t.elements,a=e.elements;return k.equals(r[0],a[0])&&k.equals(r[1],a[1])&&k.equals(r[2],a[2])&&k.equals(r[3],a[3])&&k.equals(r[4],a[4])&&k.equals(r[5],a[5])&&k.equals(r[6],a[6])&&k.equals(r[7],a[7])&&k.equals(r[8],a[8])},n.lerp=function(t,e,r,a){var o=t.elements,l=e.elements,c=a.elements,_=1-r;c[0]=o[0]*_+l[0]*r,c[1]=o[1]*_+l[1]*r,c[2]=o[2]*_+l[2]*r,c[3]=o[3]*_+l[3]*r,c[4]=o[4]*_+l[4]*r,c[5]=o[5]*_+l[5]*r,c[6]=o[6]*_+l[6]*r,c[7]=o[7]*_+l[7]*r,c[8]=o[8]*_+l[8]*r},n.rotationQuaternion=function(t,e){var r=e.elements,a=t._x,o=t._y,l=t._z,c=t._w,_=a+a,u=o+o,d=l+l,h=a*_,f=o*_,v=o*u,p=l*_,g=l*u,y=l*d,m=c*_,x=c*u,S=c*d;r[0]=1-v-y,r[3]=f-S,r[6]=p+x,r[1]=f+S,r[4]=1-h-y,r[7]=g-m,r[2]=p-x,r[5]=g+m,r[8]=1-h-v},n.scaling=function(t,e){var r=e.elements;r[0]=t._x,r[1]=0,r[2]=0,r[3]=0,r[4]=t._y,r[5]=0,r[6]=0,r[7]=0,r[8]=1},n.translation=function(i,t){var e=t.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=i._x,e[7]=i._y,e[8]=1},n.invert=function(t,e){var r=t.elements,a=e.elements,o=r[0],l=r[1],c=r[2],_=r[3],u=r[4],d=r[5],h=r[6],f=r[7],v=r[8],p=v*u-d*f,g=-v*_+d*h,y=f*_-u*h,m=o*p+l*g+c*y;!m||(m=1/m,a[0]=p*m,a[1]=(-v*l+c*f)*m,a[2]=(d*l-c*u)*m,a[3]=g*m,a[4]=(v*o-c*h)*m,a[5]=(-d*o+c*_)*m,a[6]=y*m,a[7]=(-f*o+l*h)*m,a[8]=(u*o-l*_)*m)},n.normalMatrix=function(t,e){var r=t.elements,a=e.elements,o=r[0],l=r[1],c=r[2],_=r[3],u=r[4],d=r[5],h=r[6],f=r[7],v=r[8],p=r[9],g=r[10],y=r[11],m=r[12],x=r[13],S=r[14],b=r[15],A=o*d-l*u,C=o*h-c*u,E=o*f-_*u,T=l*h-c*d,B=l*f-_*d,M=c*f-_*h,P=v*x-p*m,V=v*S-g*m,N=v*b-y*m,F=p*S-g*x,O=p*b-y*x,D=g*b-y*S,z=A*D-C*O+E*F+T*N-B*V+M*P;if(!z)return null;z=1/z,a[0]=(d*D-h*O+f*F)*z,a[1]=(h*N-u*D-f*V)*z,a[2]=(u*O-d*N+f*P)*z,a[3]=(c*O-l*D-_*F)*z,a[4]=(o*D-c*N+_*V)*z,a[5]=(l*N-o*O-_*P)*z,a[6]=(x*M-S*B+b*T)*z,a[7]=(S*E-m*M-b*C)*z,a[8]=(m*B-x*E+b*A)*z},n.rotate=function(t,e,r){var a=t.elements,o=r.elements,l=Math.sin(e),c=Math.cos(e),_=a[0],u=a[1],d=a[2],h=a[3],f=a[4],v=a[5],p=a[6],g=a[7],y=a[8];o[0]=c*_+l*h,o[1]=c*u+l*f,o[2]=c*d+l*v,o[3]=c*h-l*_,o[4]=c*f-l*u,o[5]=c*v-l*d,o[6]=p,o[7]=g,o[8]=y},n.scale=function(t,e,r){var a=e._x,o=e._y,l=t.elements,c=r.elements;c[0]=a*l[0],c[1]=a*l[1],c[2]=a*l[2],c[3]=o*l[3],c[4]=o*l[4],c[5]=o*l[5],c[6]=l[6],c[7]=l[7],c[8]=l[8]},n.translate=function(t,e,r){var a=e._x,o=e._y,l=t.elements,c=r.elements,_=l[0],u=l[1],d=l[2],h=l[3],f=l[4],v=l[5],p=l[6],g=l[7],y=l[8];c[0]=_,c[1]=u,c[2]=d,c[3]=h,c[4]=f,c[5]=v,c[6]=a*_+o*h+p,c[7]=a*u+o*f+g,c[8]=a*d+o*v+y},n.transpose=function(t,e){var r=t.elements,a=e.elements;if(e===t){var o=r[1],l=r[2],c=r[5];a[1]=r[3],a[2]=r[6],a[3]=o,a[5]=r[7],a[6]=l,a[7]=c}else a[0]=r[0],a[1]=r[3],a[2]=r[6],a[3]=r[1],a[4]=r[4],a[5]=r[7],a[6]=r[2],a[7]=r[5],a[8]=r[8]},n}(),ye=function(){function n(i,t,e,r){i===void 0&&(i=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=1),this._onValueChanged=null,this._x=i,this._y=t,this._z=e,this._w=r}var s=n.prototype;return s.set=function(t,e,r,a){return this._x=t,this._y=e,this._z=r,this._w=a,this._onValueChanged&&this._onValueChanged(),this},s.conjugate=function(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onValueChanged&&this._onValueChanged(),this},s.getAxisAngle=function(t){var e=this,r=e._x,a=e._y,o=e._z,l=r*r+a*a+o*o;if(l<k.zeroTolerance)return t._x=1,t._y=0,t._z=0,0;var c=1/l;return t._x=this._x*c,t._y=this._y*c,t._z=this._z*c,Math.acos(this._w)*2},s.identity=function(){return this._x=0,this._y=0,this._z=0,this._w=1,this._onValueChanged&&this._onValueChanged(),this},s.length=function(){var t=this,e=t._x,r=t._y,a=t._z,o=t._w;return Math.sqrt(e*e+r*r+a*a+o*o)},s.lengthSquared=function(){var t=this,e=t._x,r=t._y,a=t._z,o=t._w;return e*e+r*r+a*a+o*o},s.normalize=function(){return n.normalize(this,this),this},s.toEuler=function(t){this._toYawPitchRoll(t);var e=t._x;return t._x=t._y,t._y=e,t._onValueChanged&&t._onValueChanged(),t},s.toYawPitchRoll=function(t){return this._toYawPitchRoll(t),t._onValueChanged&&t._onValueChanged(),t},s.rotateX=function(t){return n.rotateX(this,t,this),this},s.rotateY=function(t){return n.rotateY(this,t,this),this},s.rotateZ=function(t){return n.rotateZ(this,t,this),this},s.rotationAxisAngle=function(t,e){return n.rotationAxisAngle(t,e,this),this},s.multiply=function(t){return n.multiply(this,t,this),this},s.invert=function(){return n.invert(this,this),this},s.dot=function(t){return n.dot(this,t)},s.lerp=function(t,e){return n.lerp(this,t,e,this),this},s.rotateAxisAngle=function(t,e){return n._tempQuat1.rotationAxisAngle(t,e),this.multiply(n._tempQuat1),this},s.clone=function(){return new n(this._x,this._y,this._z,this._w)},s.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onValueChanged&&this._onValueChanged(),this},s.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onValueChanged&&this._onValueChanged(),this},s.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w},s.toJSON=function(){return{x:this._x,y:this._y,z:this._z,w:this._w}},s._toYawPitchRoll=function(t){var e=this,r=e._x,a=e._y,o=e._z,l=e._w,c=r*r,_=a*a,u=o*o,d=l*l,h=c+_+u+d,f=2*(r*l-a*o);f>(1-k.zeroTolerance)*h?(t._x=Math.atan2(2*(l*a-r*o),c+d-_-u),t._y=Math.PI/2,t._z=0):f<-(1-k.zeroTolerance)*h?(t._x=Math.atan2(2*(l*a-r*o),c+d-_-u),t._y=-Math.PI/2,t._z=0):(t._x=Math.atan2(2*(o*r+a*l),u+d-_-c),t._y=Math.asin(f/h),t._z=Math.atan2(2*(r*a+o*l),_+d-u-c))},n.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._z=t._z+e._z,r._w=t._w+e._w,r._onValueChanged&&r._onValueChanged()},n.multiply=function(t,e,r){var a=t._x,o=t._y,l=t._z,c=t._w,_=e._x,u=e._y,d=e._z,h=e._w;r._x=a*h+c*_+o*d-l*u,r._y=o*h+c*u+l*_-a*d,r._z=l*h+c*d+a*u-o*_,r._w=c*h-a*_-o*u-l*d,r._onValueChanged&&r._onValueChanged()},n.conjugate=function(t,e){e._x=-t._x,e._y=-t._y,e._z=-t._z,e._w=t._w,e._onValueChanged&&e._onValueChanged()},n.dot=function(t,e){return t._x*e._x+t._y*e._y+t._z*e._z+t._w*e._w},n.equals=function(t,e){return k.equals(t._x,e._x)&&k.equals(t._y,e._y)&&k.equals(t._z,e._z)&&k.equals(t._w,e._w)},n.rotationAxisAngle=function(t,e,r){var a=n._tempVector3;w.normalize(t,a),e*=.5;var o=Math.sin(e);r._x=a._x*o,r._y=a._y*o,r._z=a._z*o,r._w=Math.cos(e),r._onValueChanged&&r._onValueChanged()},n.rotationEuler=function(t,e,r,a){n.rotationYawPitchRoll(e,t,r,a)},n.rotationYawPitchRoll=function(t,e,r,a){var o=r*.5,l=e*.5,c=t*.5,_=Math.sin(o),u=Math.cos(o),d=Math.sin(l),h=Math.cos(l),f=Math.sin(c),v=Math.cos(c),p=v*h,g=f*d;a._x=v*d*u+f*h*_,a._y=f*h*u-v*d*_,a._z=p*_-g*u,a._w=p*u+g*_,a._onValueChanged&&a._onValueChanged()},n.rotationMatrix3x3=function(t,e){var r=t.elements,a=r[0],o=r[1],l=r[2],c=r[3],_=r[4],u=r[5],d=r[6],h=r[7],f=r[8],v=a+_+f,p,g;v>0?(p=Math.sqrt(v+1),e._w=p*.5,p=.5/p,e._x=(u-h)*p,e._y=(d-l)*p,e._z=(o-c)*p):a>=_&&a>=f?(p=Math.sqrt(1+a-_-f),g=.5/p,e._x=.5*p,e._y=(o+c)*g,e._z=(l+d)*g,e._w=(u-h)*g):_>f?(p=Math.sqrt(1+_-a-f),g=.5/p,e._x=(c+o)*g,e._y=.5*p,e._z=(h+u)*g,e._w=(d-l)*g):(p=Math.sqrt(1+f-a-_),g=.5/p,e._x=(l+d)*g,e._y=(u+h)*g,e._z=.5*p,e._w=(o-c)*g),e._onValueChanged&&e._onValueChanged()},n.invert=function(t,e){var r=t._x,a=t._y,o=t._z,l=t._w,c=r*r+a*a+o*o+l*l;if(c>k.zeroTolerance){var _=1/c;e._x=-r*_,e._y=-a*_,e._z=-o*_,e._w=l*_,e._onValueChanged&&e._onValueChanged()}},n.lerp=function(t,e,r,a){var o=1-r;n.dot(t,e)>=0?(a._x=t._x*o+e._x*r,a._y=t._y*o+e._y*r,a._z=t._z*o+e._z*r,a._w=t._w*o+e._w*r):(a._x=t._x*o-e._x*r,a._y=t._y*o-e._y*r,a._z=t._z*o-e._z*r,a._w=t._w*o-e._w*r),a.normalize()},n.slerp=function(t,e,r,a){var o,l,c=n.dot(t,e);if(Math.abs(c)>1-k.zeroTolerance)l=1-r,o=r*Math.sign(c);else{var _=Math.acos(Math.abs(c)),u=1/Math.sin(_);l=Math.sin((1-r)*_)*u,o=Math.sin(r*_)*u*Math.sign(c)}a.x=l*t.x+o*e.x,a.y=l*t.y+o*e.y,a.z=l*t.z+o*e.z,a.w=l*t.w+o*e.w,a._onValueChanged&&a._onValueChanged()},n.normalize=function(t,e){var r=t._x,a=t._y,o=t._z,l=t._w,c=Math.sqrt(r*r+a*a+o*o+l*l);c>k.zeroTolerance&&(c=1/c,e._x=r*c,e._y=a*c,e._z=o*c,e._w=l*c,e._onValueChanged&&e._onValueChanged())},n.rotationX=function(t,e){t*=.5;var r=Math.sin(t),a=Math.cos(t);e._x=r,e._y=0,e._z=0,e._w=a,e._onValueChanged&&e._onValueChanged()},n.rotationY=function(t,e){t*=.5;var r=Math.sin(t),a=Math.cos(t);e._x=0,e._y=r,e._z=0,e._w=a,e._onValueChanged&&e._onValueChanged()},n.rotationZ=function(t,e){t*=.5;var r=Math.sin(t),a=Math.cos(t);e._x=0,e._y=0,e._z=r,e._w=a,e._onValueChanged&&e._onValueChanged()},n.rotateX=function(t,e,r){var a=t._x,o=t._y,l=t._z,c=t._w;e*=.5;var _=Math.sin(e),u=Math.cos(e);r._x=a*u+c*_,r._y=o*u+l*_,r._z=l*u-o*_,r._w=c*u-a*_,r._onValueChanged&&r._onValueChanged()},n.rotateY=function(t,e,r){var a=t._x,o=t._y,l=t._z,c=t._w;e*=.5;var _=Math.sin(e),u=Math.cos(e);r._x=a*u-l*_,r._y=o*u+c*_,r._z=l*u+a*_,r._w=c*u-o*_,r._onValueChanged&&r._onValueChanged()},n.rotateZ=function(t,e,r){var a=t._x,o=t._y,l=t._z,c=t._w;e*=.5;var _=Math.sin(e),u=Math.cos(e);r._x=a*u+o*_,r._y=o*u-a*_,r._z=l*u+c*_,r._w=c*u-l*_,r._onValueChanged&&r._onValueChanged()},n.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._z=t._z*e,r._w=t._w*e,r._onValueChanged&&r._onValueChanged()},Ea(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this._onValueChanged&&this._onValueChanged()}},{key:"normalized",get:function(){return Math.abs(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w-1)<k.zeroTolerance}},{key:"w",get:function(){return this._w},set:function(t){this._w=t,this._onValueChanged&&this._onValueChanged()}}]),n}();(function(){ye._tempVector3=new w})();(function(){ye._tempQuat1=new ye})();var J=function(){function n(i,t,e,r,a,o,l,c,_,u,d,h,f,v,p,g){i===void 0&&(i=1),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),a===void 0&&(a=0),o===void 0&&(o=1),l===void 0&&(l=0),c===void 0&&(c=0),_===void 0&&(_=0),u===void 0&&(u=0),d===void 0&&(d=1),h===void 0&&(h=0),f===void 0&&(f=0),v===void 0&&(v=0),p===void 0&&(p=0),g===void 0&&(g=1),this.elements=new Float32Array(16);var y=this.elements;y[0]=i,y[1]=t,y[2]=e,y[3]=r,y[4]=a,y[5]=o,y[6]=l,y[7]=c,y[8]=_,y[9]=u,y[10]=d,y[11]=h,y[12]=f,y[13]=v,y[14]=p,y[15]=g}var s=n.prototype;return s.set=function(t,e,r,a,o,l,c,_,u,d,h,f,v,p,g,y){var m=this.elements;return m[0]=t,m[1]=e,m[2]=r,m[3]=a,m[4]=o,m[5]=l,m[6]=c,m[7]=_,m[8]=u,m[9]=d,m[10]=h,m[11]=f,m[12]=v,m[13]=p,m[14]=g,m[15]=y,this},s.multiply=function(t){return n.multiply(this,t,this),this},s.determinant=function(){var t=this.elements,e=t[0],r=t[1],a=t[2],o=t[3],l=t[4],c=t[5],_=t[6],u=t[7],d=t[8],h=t[9],f=t[10],v=t[11],p=t[12],g=t[13],y=t[14],m=t[15],x=e*c-r*l,S=e*_-a*l,b=e*u-o*l,A=r*_-a*c,C=r*u-o*c,E=a*u-o*_,T=d*g-h*p,B=d*y-f*p,M=d*m-v*p,P=h*y-f*g,V=h*m-v*g,N=f*m-v*y;return x*N-S*V+b*P+A*M-C*B+E*T},s.decompose=function(t,e,r){var a=n._tempMat30,o=this.elements,l=a.elements,c=o[0],_=o[1],u=o[2],d=o[4],h=o[5],f=o[6],v=o[8],p=o[9],g=o[10];t.set(o[12],o[13],o[14]);var y=Math.sqrt(c*c+_*_+u*u),m=Math.sqrt(d*d+h*h+f*f),x=Math.sqrt(v*v+p*p+g*g);if(this.determinant()<0&&(y=-y),r.set(y,m,x),Math.abs(y)<k.zeroTolerance||Math.abs(m)<k.zeroTolerance||Math.abs(x)<k.zeroTolerance)return e.identity(),!1;var S=1/y,b=1/m,A=1/x;return l[0]=c*S,l[1]=_*S,l[2]=u*S,l[3]=d*b,l[4]=h*b,l[5]=f*b,l[6]=v*A,l[7]=p*A,l[8]=g*A,ye.rotationMatrix3x3(a,e),!0},s.getRotation=function(t){var e=this.elements,r=e[0]+e[5]+e[10];if(r>k.zeroTolerance){var a=Math.sqrt(r+1)*2;t._w=.25*a,t._x=(e[6]-e[9])/a,t._y=(e[8]-e[2])/a,t._z=(e[1]-e[4])/a}else if(e[0]>e[5]&&e[0]>e[10]){var o=Math.sqrt(1+e[0]-e[5]-e[10])*2;t._w=(e[6]-e[9])/o,t._x=.25*o,t._y=(e[1]+e[4])/o,t._z=(e[8]+e[2])/o}else if(e[5]>e[10]){var l=Math.sqrt(1+e[5]-e[0]-e[10])*2;t._w=(e[8]-e[2])/l,t._x=(e[1]+e[4])/l,t._y=.25*l,t._z=(e[6]+e[9])/l}else{var c=Math.sqrt(1+e[10]-e[0]-e[5])*2;t._w=(e[1]-e[4])/c,t._x=(e[8]+e[2])/c,t._y=(e[6]+e[9])/c,t._z=.25*c}return t._onValueChanged&&t._onValueChanged(),t},s.getScaling=function(t){var e=this.elements,r=e[0],a=e[1],o=e[2],l=e[4],c=e[5],_=e[6],u=e[8],d=e[9],h=e[10];return t.set(Math.sqrt(r*r+a*a+o*o),Math.sqrt(l*l+c*c+_*_),Math.sqrt(u*u+d*d+h*h)),t},s.getTranslation=function(t){var e=this.elements;return t.set(e[12],e[13],e[14]),t},s.identity=function(){var t=this.elements;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},s.invert=function(){return n.invert(this,this),this},s.rotateAxisAngle=function(t,e){return n.rotateAxisAngle(this,t,e,this),this},s.scale=function(t){return n.scale(this,t,this),this},s.translate=function(t){return n.translate(this,t,this),this},s.transpose=function(){return n.transpose(this,this),this},s.clone=function(){var t=this.elements,e=new n(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]);return e},s.copyFrom=function(t){var e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],this},s.copyFromArray=function(t,e){e===void 0&&(e=0);for(var r=this.elements,a=0;a<16;a++)r[a]=t[a+e];return this},s.copyToArray=function(t,e){e===void 0&&(e=0);var r=this.elements;t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t[e+9]=r[9],t[e+10]=r[10],t[e+11]=r[11],t[e+12]=r[12],t[e+13]=r[13],t[e+14]=r[14],t[e+15]=r[15]},n.multiply=function(t,e,r){var a=t.elements,o=e.elements,l=r.elements,c=a[0],_=a[1],u=a[2],d=a[3],h=a[4],f=a[5],v=a[6],p=a[7],g=a[8],y=a[9],m=a[10],x=a[11],S=a[12],b=a[13],A=a[14],C=a[15],E=o[0],T=o[1],B=o[2],M=o[3],P=o[4],V=o[5],N=o[6],F=o[7],O=o[8],D=o[9],z=o[10],U=o[11],Y=o[12],K=o[13],H=o[14],te=o[15];l[0]=c*E+h*T+g*B+S*M,l[1]=_*E+f*T+y*B+b*M,l[2]=u*E+v*T+m*B+A*M,l[3]=d*E+p*T+x*B+C*M,l[4]=c*P+h*V+g*N+S*F,l[5]=_*P+f*V+y*N+b*F,l[6]=u*P+v*V+m*N+A*F,l[7]=d*P+p*V+x*N+C*F,l[8]=c*O+h*D+g*z+S*U,l[9]=_*O+f*D+y*z+b*U,l[10]=u*O+v*D+m*z+A*U,l[11]=d*O+p*D+x*z+C*U,l[12]=c*Y+h*K+g*H+S*te,l[13]=_*Y+f*K+y*H+b*te,l[14]=u*Y+v*K+m*H+A*te,l[15]=d*Y+p*K+x*H+C*te},n.equals=function(t,e){var r=t.elements,a=e.elements;return k.equals(r[0],a[0])&&k.equals(r[1],a[1])&&k.equals(r[2],a[2])&&k.equals(r[3],a[3])&&k.equals(r[4],a[4])&&k.equals(r[5],a[5])&&k.equals(r[6],a[6])&&k.equals(r[7],a[7])&&k.equals(r[8],a[8])&&k.equals(r[9],a[9])&&k.equals(r[10],a[10])&&k.equals(r[11],a[11])&&k.equals(r[12],a[12])&&k.equals(r[13],a[13])&&k.equals(r[14],a[14])&&k.equals(r[15],a[15])},n.lerp=function(t,e,r,a){var o=t.elements,l=e.elements,c=a.elements,_=1-r;c[0]=o[0]*_+l[0]*r,c[1]=o[1]*_+l[1]*r,c[2]=o[2]*_+l[2]*r,c[3]=o[3]*_+l[3]*r,c[4]=o[4]*_+l[4]*r,c[5]=o[5]*_+l[5]*r,c[6]=o[6]*_+l[6]*r,c[7]=o[7]*_+l[7]*r,c[8]=o[8]*_+l[8]*r,c[9]=o[9]*_+l[9]*r,c[10]=o[10]*_+l[10]*r,c[11]=o[11]*_+l[11]*r,c[12]=o[12]*_+l[12]*r,c[13]=o[13]*_+l[13]*r,c[14]=o[14]*_+l[14]*r,c[15]=o[15]*_+l[15]*r},n.add=function(t,e,r){var a=t.elements,o=e.elements,l=r.elements;l[0]=a[0]+o[0],l[1]=a[1]+o[1],l[2]=a[2]+o[2],l[3]=a[3]+o[3],l[4]=a[4]+o[4],l[5]=a[5]+o[5],l[6]=a[6]+o[6],l[7]=a[7]+o[7],l[8]=a[8]+o[8],l[9]=a[9]+o[9],l[10]=a[10]+o[10],l[11]=a[11]+o[11],l[12]=a[12]+o[12],l[13]=a[13]+o[13],l[14]=a[14]+o[14],l[15]=a[15]+o[15]},n.multiplyScalar=function(t,e,r){var a=t.elements,o=r.elements;o[0]=a[0]*e,o[1]=a[1]*e,o[2]=a[2]*e,o[3]=a[3]*e,o[4]=a[4]*e,o[5]=a[5]*e,o[6]=a[6]*e,o[7]=a[7]*e,o[8]=a[8]*e,o[9]=a[9]*e,o[10]=a[10]*e,o[11]=a[11]*e,o[12]=a[12]*e,o[13]=a[13]*e,o[14]=a[14]*e,o[15]=a[15]*e},n.rotationQuaternion=function(t,e){var r=e.elements,a=t._x,o=t._y,l=t._z,c=t._w,_=a+a,u=o+o,d=l+l,h=a*_,f=o*_,v=o*u,p=l*_,g=l*u,y=l*d,m=c*_,x=c*u,S=c*d;r[0]=1-v-y,r[1]=f+S,r[2]=p-x,r[3]=0,r[4]=f-S,r[5]=1-h-y,r[6]=g+m,r[7]=0,r[8]=p+x,r[9]=g-m,r[10]=1-h-v,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},n.rotationAxisAngle=function(t,e,r){var a=r.elements,o=t._x,l=t._y,c=t._z,_=Math.sqrt(o*o+l*l+c*c),u,d,h;Math.abs(_)<k.zeroTolerance||(_=1/_,o*=_,l*=_,c*=_,u=Math.sin(e),d=Math.cos(e),h=1-d,a[0]=o*o*h+d,a[1]=l*o*h+c*u,a[2]=c*o*h-l*u,a[3]=0,a[4]=o*l*h-c*u,a[5]=l*l*h+d,a[6]=c*l*h+o*u,a[7]=0,a[8]=o*c*h+l*u,a[9]=l*c*h-o*u,a[10]=c*c*h+d,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1)},n.rotationTranslation=function(t,e,r){n.rotationQuaternion(t,r);var a=r.elements;a[12]=e._x,a[13]=e._y,a[14]=e._z},n.affineTransformation=function(t,e,r,a){var o=a.elements,l=e._x,c=e._y,_=e._z,u=e._w,d=l+l,h=c+c,f=_+_,v=l*d,p=l*h,g=l*f,y=c*h,m=c*f,x=_*f,S=u*d,b=u*h,A=u*f,C=t._x,E=t._y,T=t._z;o[0]=(1-(y+x))*C,o[1]=(p+A)*C,o[2]=(g-b)*C,o[3]=0,o[4]=(p-A)*E,o[5]=(1-(v+x))*E,o[6]=(m+S)*E,o[7]=0,o[8]=(g+b)*T,o[9]=(m-S)*T,o[10]=(1-(v+y))*T,o[11]=0,o[12]=r._x,o[13]=r._y,o[14]=r._z,o[15]=1},n.scaling=function(t,e){var r=e.elements;r[0]=t._x,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t._y,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=t._z,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},n.translation=function(i,t){var e=t.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=i._x,e[13]=i._y,e[14]=i._z,e[15]=1},n.invert=function(t,e){var r=t.elements,a=e.elements,o=r[0],l=r[1],c=r[2],_=r[3],u=r[4],d=r[5],h=r[6],f=r[7],v=r[8],p=r[9],g=r[10],y=r[11],m=r[12],x=r[13],S=r[14],b=r[15],A=o*d-l*u,C=o*h-c*u,E=o*f-_*u,T=l*h-c*d,B=l*f-_*d,M=c*f-_*h,P=v*x-p*m,V=v*S-g*m,N=v*b-y*m,F=p*S-g*x,O=p*b-y*x,D=g*b-y*S,z=A*D-C*O+E*F+T*N-B*V+M*P;if(!z)return null;z=1/z,a[0]=(d*D-h*O+f*F)*z,a[1]=(c*O-l*D-_*F)*z,a[2]=(x*M-S*B+b*T)*z,a[3]=(g*B-p*M-y*T)*z,a[4]=(h*N-u*D-f*V)*z,a[5]=(o*D-c*N+_*V)*z,a[6]=(S*E-m*M-b*C)*z,a[7]=(v*M-g*E+y*C)*z,a[8]=(u*O-d*N+f*P)*z,a[9]=(l*N-o*O-_*P)*z,a[10]=(m*B-x*E+b*A)*z,a[11]=(p*E-v*B-y*A)*z,a[12]=(d*V-u*F-h*P)*z,a[13]=(o*F-l*V+c*P)*z,a[14]=(x*C-m*T-S*A)*z,a[15]=(v*T-p*C+g*A)*z},n.lookAt=function(t,e,r,a){var o=a.elements,l=n._tempVec30,c=n._tempVec31,_=n._tempVec32;w.subtract(t,e,_),_.normalize(),w.cross(r,_,l),l.normalize(),w.cross(_,l,c),o[0]=l._x,o[1]=c._x,o[2]=_._x,o[3]=0,o[4]=l._y,o[5]=c._y,o[6]=_._y,o[7]=0,o[8]=l._z,o[9]=c._z,o[10]=_._z,o[11]=0,o[12]=-w.dot(l,t),o[13]=-w.dot(c,t),o[14]=-w.dot(_,t),o[15]=1},n.ortho=function(t,e,r,a,o,l,c){var _=c.elements,u=1/(t-e),d=1/(r-a),h=1/(o-l);_[0]=-2*u,_[1]=0,_[2]=0,_[3]=0,_[4]=0,_[5]=-2*d,_[6]=0,_[7]=0,_[8]=0,_[9]=0,_[10]=2*h,_[11]=0,_[12]=(t+e)*u,_[13]=(a+r)*d,_[14]=(l+o)*h,_[15]=1},n.perspective=function(t,e,r,a,o){var l=o.elements,c=1/Math.tan(t/2),_=1/(r-a);l[0]=c/e,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=c,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=(a+r)*_,l[11]=-1,l[12]=0,l[13]=0,l[14]=2*a*r*_,l[15]=0},n.rotateAxisAngle=function(t,e,r,a){var o=e._x,l=e._y,c=e._z,_=Math.sqrt(o*o+l*l+c*c);if(!(Math.abs(_)<k.zeroTolerance)){var u=t.elements,d=a.elements,h,f,v;_=1/_,o*=_,l*=_,c*=_,h=Math.sin(r),f=Math.cos(r),v=1-f;var p=u[0],g=u[1],y=u[2],m=u[3],x=u[4],S=u[5],b=u[6],A=u[7],C=u[8],E=u[9],T=u[10],B=u[11],M=o*o*v+f,P=l*o*v+c*h,V=c*o*v-l*h,N=o*l*v-c*h,F=l*l*v+f,O=c*l*v+o*h,D=o*c*v+l*h,z=l*c*v-o*h,U=c*c*v+f;d[0]=p*M+x*P+C*V,d[1]=g*M+S*P+E*V,d[2]=y*M+b*P+T*V,d[3]=m*M+A*P+B*V,d[4]=p*N+x*F+C*O,d[5]=g*N+S*F+E*O,d[6]=y*N+b*F+T*O,d[7]=m*N+A*F+B*O,d[8]=p*D+x*z+C*U,d[9]=g*D+S*z+E*U,d[10]=y*D+b*z+T*U,d[11]=m*D+A*z+B*U,t!==a&&(d[12]=u[12],d[13]=u[13],d[14]=u[14],d[15]=u[15])}},n.scale=function(t,e,r){var a=t.elements,o=r.elements,l=e._x,c=e._y,_=e._z;o[0]=a[0]*l,o[1]=a[1]*l,o[2]=a[2]*l,o[3]=a[3]*l,o[4]=a[4]*c,o[5]=a[5]*c,o[6]=a[6]*c,o[7]=a[7]*c,o[8]=a[8]*_,o[9]=a[9]*_,o[10]=a[10]*_,o[11]=a[11]*_,o[12]=a[12],o[13]=a[13],o[14]=a[14],o[15]=a[15]},n.translate=function(t,e,r){var a=t.elements,o=r.elements,l=e._x,c=e._y,_=e._z;if(t===r)o[12]=a[0]*l+a[4]*c+a[8]*_+a[12],o[13]=a[1]*l+a[5]*c+a[9]*_+a[13],o[14]=a[2]*l+a[6]*c+a[10]*_+a[14],o[15]=a[3]*l+a[7]*c+a[11]*_+a[15];else{var u=a[0],d=a[1],h=a[2],f=a[3],v=a[4],p=a[5],g=a[6],y=a[7],m=a[8],x=a[9],S=a[10],b=a[11];o[0]=u,o[1]=d,o[2]=h,o[3]=f,o[4]=v,o[5]=p,o[6]=g,o[7]=y,o[8]=m,o[9]=x,o[10]=S,o[11]=b,o[12]=u*l+v*c+m*_+a[12],o[13]=d*l+p*c+x*_+a[13],o[14]=h*l+g*c+S*_+a[14],o[15]=f*l+y*c+b*_+a[15]}},n.transpose=function(t,e){var r=t.elements,a=e.elements;if(e===t){var o=r[1],l=r[2],c=r[3],_=r[6],u=r[7],d=r[11];a[1]=r[4],a[2]=r[8],a[3]=r[12],a[4]=o,a[6]=r[9],a[7]=r[13],a[8]=l,a[9]=_,a[11]=r[14],a[12]=c,a[13]=u,a[14]=d}else a[0]=r[0],a[1]=r[4],a[2]=r[8],a[3]=r[12],a[4]=r[1],a[5]=r[5],a[6]=r[9],a[7]=r[13],a[8]=r[2],a[9]=r[6],a[10]=r[10],a[11]=r[14],a[12]=r[3],a[13]=r[7],a[14]=r[11],a[15]=r[15]},n}();(function(){J._tempVec30=new w})();(function(){J._tempVec31=new w})();(function(){J._tempVec32=new w})();(function(){J._tempMat30=new da})();(function(){J._identity=new J(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)})();var Qc=function(){function n(i,t){i===void 0&&(i=null),t===void 0&&(t=null),this.origin=new w,this.direction=new w,i&&this.origin.copyFrom(i),t&&this.direction.copyFrom(t)}var s=n.prototype;return s.intersectPlane=function(t){return Dt.intersectsRayAndPlane(this,t)},s.intersectSphere=function(t){return Dt.intersectsRayAndSphere(this,t)},s.intersectBox=function(t){return Dt.intersectsRayAndBox(this,t)},s.getPoint=function(t,e){return w.scale(this.direction,t,e),e.add(this.origin)},n}(),$=function(){function n(i,t){i===void 0&&(i=0),t===void 0&&(t=0),this._onValueChanged=null,this._x=i,this._y=t}var s=n.prototype;return s.set=function(t,e){return this._x=t,this._y=e,this._onValueChanged&&this._onValueChanged(),this},s.add=function(t){return this._x+=t._x,this._y+=t._y,this._onValueChanged&&this._onValueChanged(),this},s.subtract=function(t){return this._x-=t._x,this._y-=t._y,this._onValueChanged&&this._onValueChanged(),this},s.multiply=function(t){return this._x*=t._x,this._y*=t._y,this._onValueChanged&&this._onValueChanged(),this},s.divide=function(t){return this._x/=t._x,this._y/=t._y,this._onValueChanged&&this._onValueChanged(),this},s.length=function(){var t=this,e=t._x,r=t._y;return Math.sqrt(e*e+r*r)},s.lengthSquared=function(){var t=this,e=t._x,r=t._y;return e*e+r*r},s.negate=function(){return this._x=-this._x,this._y=-this._y,this._onValueChanged&&this._onValueChanged(),this},s.normalize=function(){return n.normalize(this,this),this},s.scale=function(t){return this._x*=t,this._y*=t,this._onValueChanged&&this._onValueChanged(),this},s.clone=function(){return new n(this._x,this._y)},s.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._onValueChanged&&this._onValueChanged(),this},s.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._onValueChanged&&this._onValueChanged(),this},s.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y},s.toJSON=function(){return{x:this._x,y:this._y}},n.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._onValueChanged&&r._onValueChanged()},n.subtract=function(t,e,r){r._x=t._x-e._x,r._y=t._y-e._y,r._onValueChanged&&r._onValueChanged()},n.multiply=function(t,e,r){r._x=t._x*e._x,r._y=t._y*e._y,r._onValueChanged&&r._onValueChanged()},n.divide=function(t,e,r){r._x=t._x/e._x,r._y=t._y/e._y,r._onValueChanged&&r._onValueChanged()},n.dot=function(t,e){return t._x*e._x+t._y*e._y},n.distance=function(t,e){var r=e._x-t._x,a=e._y-t._y;return Math.sqrt(r*r+a*a)},n.distanceSquared=function(t,e){var r=e._x-t._x,a=e._y-t._y;return r*r+a*a},n.equals=function(t,e){return k.equals(t._x,e._x)&&k.equals(t._y,e._y)},n.lerp=function(t,e,r,a){var o=t._x,l=t._y;a._x=o+(e._x-o)*r,a._y=l+(e._y-l)*r,a._onValueChanged&&a._onValueChanged()},n.max=function(t,e,r){r._x=Math.max(t._x,e._x),r._y=Math.max(t._y,e._y),r._onValueChanged&&r._onValueChanged()},n.min=function(t,e,r){r._x=Math.min(t._x,e._x),r._y=Math.min(t._y,e._y),r._onValueChanged&&r._onValueChanged()},n.negate=function(t,e){e._x=-t._x,e._y=-t._y,e._onValueChanged&&e._onValueChanged()},n.normalize=function(t,e){var r=t._x,a=t._y,o=Math.sqrt(r*r+a*a);o>k.zeroTolerance&&(o=1/o,e._x=r*o,e._y=a*o,e._onValueChanged&&e._onValueChanged())},n.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._onValueChanged&&r._onValueChanged()},Ea(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}}]),n}();(function(){$._zero=new $(0,0)})();(function(){$._one=new $(1,1)})();var ae=function(){function n(i,t,e,r){i===void 0&&(i=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),this._onValueChanged=null,this._x=i,this._y=t,this._z=e,this._w=r}var s=n.prototype;return s.set=function(t,e,r,a){return this._x=t,this._y=e,this._z=r,this._w=a,this._onValueChanged&&this._onValueChanged(),this},s.add=function(t){return this._x+=t._x,this._y+=t._y,this._z+=t._z,this._w+=t._w,this._onValueChanged&&this._onValueChanged(),this},s.subtract=function(t){return this._x-=t._x,this._y-=t._y,this._z-=t._z,this._w-=t._w,this._onValueChanged&&this._onValueChanged(),this},s.multiply=function(t){return this._x*=t._x,this._y*=t._y,this._z*=t._z,this._w*=t._w,this._onValueChanged&&this._onValueChanged(),this},s.divide=function(t){return this._x/=t._x,this._y/=t._y,this._z/=t._z,this._w/=t._w,this._onValueChanged&&this._onValueChanged(),this},s.length=function(){var t=this,e=t._x,r=t._y,a=t._z,o=t._w;return Math.sqrt(e*e+r*r+a*a+o*o)},s.lengthSquared=function(){var t=this,e=t._x,r=t._y,a=t._z,o=t._w;return e*e+r*r+a*a+o*o},s.negate=function(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._w=-this._w,this._onValueChanged&&this._onValueChanged(),this},s.normalize=function(){return n.normalize(this,this),this},s.scale=function(t){return this._x*=t,this._y*=t,this._z*=t,this._w*=t,this._onValueChanged&&this._onValueChanged(),this},s.clone=function(){var t=new n(this._x,this._y,this._z,this._w);return t},s.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onValueChanged&&this._onValueChanged(),this},s.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onValueChanged&&this._onValueChanged(),this},s.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w},s.toJSON=function(){return{x:this._x,y:this._y,z:this._z,w:this._w}},n.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._z=t._z+e._z,r._w=t._w+e._w,r._onValueChanged&&r._onValueChanged()},n.subtract=function(t,e,r){r._x=t._x-e._x,r._y=t._y-e._y,r._z=t._z-e._z,r._w=t._w-e._w,r._onValueChanged&&r._onValueChanged()},n.multiply=function(t,e,r){r._x=t._x*e._x,r._y=t._y*e._y,r._z=t._z*e._z,r._w=t._w*e._w,r._onValueChanged&&r._onValueChanged()},n.divide=function(t,e,r){r._x=t._x/e._x,r._y=t._y/e._y,r._z=t._z/e._z,r._w=t._w/e._w,r._onValueChanged&&r._onValueChanged()},n.dot=function(t,e){return t._x*e._x+t._y*e._y+t._z*e._z+t._w*e._w},n.distance=function(t,e){var r=e._x-t._x,a=e._y-t._y,o=e._z-t._z,l=e._w-t._w;return Math.sqrt(r*r+a*a+o*o+l*l)},n.distanceSquared=function(t,e){var r=e._x-t._x,a=e._y-t._y,o=e._z-t._z,l=e._w-t._w;return r*r+a*a+o*o+l*l},n.equals=function(t,e){return k.equals(t._x,e._x)&&k.equals(t._y,e._y)&&k.equals(t._z,e._z)&&k.equals(t._w,e._w)},n.lerp=function(t,e,r,a){var o=t._x,l=t._y,c=t._z,_=t._w;a._x=o+(e._x-o)*r,a._y=l+(e._y-l)*r,a._z=c+(e._z-c)*r,a._w=_+(e._w-_)*r,a._onValueChanged&&a._onValueChanged()},n.max=function(t,e,r){r._x=Math.max(t._x,e._x),r._y=Math.max(t._y,e._y),r._z=Math.max(t._z,e._z),r._w=Math.max(t._w,e._w),r._onValueChanged&&r._onValueChanged()},n.min=function(t,e,r){r._x=Math.min(t._x,e._x),r._y=Math.min(t._y,e._y),r._z=Math.min(t._z,e._z),r._w=Math.min(t._w,e._w),r._onValueChanged&&r._onValueChanged()},n.negate=function(t,e){e._x=-t._x,e._y=-t._y,e._z=-t._z,e._w=-t._w,e._onValueChanged&&e._onValueChanged()},n.normalize=function(t,e){var r=t._x,a=t._y,o=t._z,l=t._w,c=Math.sqrt(r*r+a*a+o*o+l*l);c>k.zeroTolerance&&(c=1/c,e._x=r*c,e._y=a*c,e._z=o*c,e._w=l*c,e._onValueChanged&&e._onValueChanged())},n.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._z=t._z*e,r._w=t._w*e,r._onValueChanged&&r._onValueChanged()},n.transform=function(t,e,r){var a=t._x,o=t._y,l=t._z,c=t._w,_=e.elements;r._x=a*_[0]+o*_[4]+l*_[8]+c*_[12],r._y=a*_[1]+o*_[5]+l*_[9]+c*_[13],r._z=a*_[2]+o*_[6]+l*_[10]+c*_[14],r._w=a*_[3]+o*_[7]+l*_[11]+c*_[15],r._onValueChanged&&r._onValueChanged()},n.transformByQuat=function(t,e,r){var a=t._x,o=t._y,l=t._z,c=t._w,_=e._x,u=e._y,d=e._z,h=e._w,f=h*a+u*l-d*o,v=h*o+d*a-_*l,p=h*l+_*o-u*a,g=-_*a-u*o-d*l;r._x=f*h-g*_-v*d+p*u,r._y=v*h-g*u-p*_+f*d,r._z=p*h-g*d-f*u+v*_,r._w=c,r._onValueChanged&&r._onValueChanged()},Ea(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this._onValueChanged&&this._onValueChanged()}},{key:"w",get:function(){return this._w},set:function(t){this._w=t,this._onValueChanged&&this._onValueChanged()}}]),n}();(function(){ae._zero=new ae(0,0,0,0)})();(function(){ae._one=new ae(1,1,1,1)})();var j=function(){function n(i,t,e,r){i===void 0&&(i=1),t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),this._onValueChanged=null,this._r=i,this._g=t,this._b=e,this._a=r}var s=n.prototype;return s.set=function(t,e,r,a){return this._r=t,this._g=e,this._b=r,this._a=a,this._onValueChanged&&this._onValueChanged(),this},s.add=function(t){return this._r+=t._r,this._g+=t._g,this._b+=t._b,this._a+=t._a,this._onValueChanged&&this._onValueChanged(),this},s.scale=function(t){return this._r*=t,this._g*=t,this._b*=t,this._a*=t,this._onValueChanged&&this._onValueChanged(),this},s.clone=function(){var t=new n(this._r,this._g,this._b,this._a);return t},s.copyFrom=function(t){return this._r=t.r,this._g=t.g,this._b=t.b,this._a=t.a,this._onValueChanged&&this._onValueChanged(),this},s.copyFromArray=function(t,e){return e===void 0&&(e=0),this._r=t[e],this._g=t[e+1],this._b=t[e+2],this._a=t[e+3],this._onValueChanged&&this._onValueChanged(),this},s.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._r,t[e+1]=this._g,t[e+2]=this._b,t[e+3]=this._a},s.toLinear=function(t){return t._r=n.gammaToLinearSpace(this._r),t._g=n.gammaToLinearSpace(this._g),t._b=n.gammaToLinearSpace(this._b),this._onValueChanged&&this._onValueChanged(),t},s.toGamma=function(t){return t._r=n.linearToGammaSpace(this._r),t._g=n.linearToGammaSpace(this._g),t._b=n.linearToGammaSpace(this._b),this._onValueChanged&&this._onValueChanged(),t},s.getBrightness=function(){var t=this.r,e=this.g,r=this.b,a=t,o=t;return e>a&&(a=e),r>a&&(a=r),e<o&&(o=e),r<o&&(o=r),(a+o)/2},s.toJSON=function(){return{r:this._r,g:this._g,b:this._b,a:this._a}},n.gammaToLinearSpace=function(t){return t<=0?0:t<=.04045?t/12.92:t<1?Math.pow((t+.055)/1.055,2.4):Math.pow(t,2.4)},n.linearToGammaSpace=function(t){return t<=0?0:t<.0031308?12.92*t:t<1?1.055*Math.pow(t,.41666)-.055:Math.pow(t,.41666)},n.equals=function(t,e){return k.equals(t._r,e._r)&&k.equals(t._g,e._g)&&k.equals(t._b,e._b)&&k.equals(t._a,e._a)},n.add=function(t,e,r){return r._r=t._r+e._r,r._g=t._g+e._g,r._b=t._b+e._b,r._a=t._a+e._a,r._onValueChanged&&r._onValueChanged(),r},n.subtract=function(t,e,r){r._r=t._r-e._r,r._g=t._g-e._g,r._b=t._b-e._b,r._a=t._a-e._a,r._onValueChanged&&r._onValueChanged()},n.scale=function(t,e,r){return r._r=t._r*e,r._g=t._g*e,r._b=t._b*e,r._a=t._a*e,r._onValueChanged&&r._onValueChanged(),r},n.lerp=function(t,e,r,a){var o=t._r,l=t._g,c=t._b,_=t._a;return a._r=o+(e._r-o)*r,a._g=l+(e._g-l)*r,a._b=c+(e._b-c)*r,a._a=_+(e._a-_)*r,a._onValueChanged&&a._onValueChanged(),a},Ea(n,[{key:"r",get:function(){return this._r},set:function(t){this._r=t,this._onValueChanged&&this._onValueChanged()}},{key:"g",get:function(){return this._g},set:function(t){this._g=t,this._onValueChanged&&this._onValueChanged()}},{key:"b",get:function(){return this._b},set:function(t){this._b=t,this._onValueChanged&&this._onValueChanged()}},{key:"a",get:function(){return this._a},set:function(t){this._a=t,this._onValueChanged&&this._onValueChanged()}}]),n}(),qr=function(){function n(i,t,e,r){i===void 0&&(i=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),this._onValueChanged=null,this._x=i,this._y=t,this._width=e,this._height=r}var s=n.prototype;return s.set=function(t,e,r,a){return this._x=t,this._y=e,this._width=r,this._height=a,this._onValueChanged&&this._onValueChanged(),this},s.clone=function(){return new n(this.x,this.y,this.width,this.height)},s.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._width=t.width,this._height=t.height,this._onValueChanged&&this._onValueChanged(),this},Ea(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._onValueChanged&&this._onValueChanged()}},{key:"height",get:function(){return this._height},set:function(t){this._height=t,this._onValueChanged&&this._onValueChanged()}}]),n}(),Kc=function(){function n(){this.coefficients=new Float32Array(27)}var s=n.prototype;return s.addLight=function(t,e,r){e.scale(r);var a=this.coefficients,o=t._x,l=t._y,c=t._z,_=e.r,u=e.g,d=e.b,h=.282095,f=-.488603*l,v=.488603*c,p=-.488603*o,g=1.092548*(o*l),y=-1.092548*(l*c),m=.315392*(3*c*c-1),x=-1.092548*(o*c),S=.546274*(o*o-l*l);a[0]+=_*h,a[1]+=u*h,a[2]+=d*h,a[3]+=_*f,a[4]+=u*f,a[5]+=d*f,a[6]+=_*v,a[7]+=u*v,a[8]+=d*v,a[9]+=_*p,a[10]+=u*p,a[11]+=d*p,a[12]+=_*g,a[13]+=u*g,a[14]+=d*g,a[15]+=_*y,a[16]+=u*y,a[17]+=d*y,a[18]+=_*m,a[19]+=u*m,a[20]+=d*m,a[21]+=_*x,a[22]+=u*x,a[23]+=d*x,a[24]+=_*S,a[25]+=u*S,a[26]+=d*S},s.evaluate=function(t,e){var r=this.coefficients,a=t._x,o=t._y,l=t._z,c=.886227,_=-1.023327*o,u=1.023327*l,d=-1.023327*a,h=.858086*o*a,f=-.858086*o*l,v=.247708*(3*l*l-1),p=-.858086*l*a,g=.429042*(a*a-o*o),y=r[0]*c,m=r[1]*c,x=r[2]*c;return y+=r[3]*_+r[6]*u+r[9]*d,m+=r[4]*_+r[7]*u+r[10]*d,x+=r[5]*_+r[8]*u+r[11]*d,y+=r[12]*h+r[15]*f+r[18]*v+r[21]*p+r[24]*g,m+=r[13]*h+r[16]*f+r[19]*v+r[22]*p+r[25]*g,x+=r[14]*h+r[17]*f+r[20]*v+r[23]*p+r[26]*g,e.set(y,m,x,1),e},s.scale=function(t){var e=this.coefficients;e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e[4]*=t,e[5]*=t,e[6]*=t,e[7]*=t,e[8]*=t,e[9]*=t,e[10]*=t,e[11]*=t,e[12]*=t,e[13]*=t,e[14]*=t,e[15]*=t,e[16]*=t,e[17]*=t,e[18]*=t,e[19]*=t,e[20]*=t,e[21]*=t,e[22]*=t,e[23]*=t,e[24]*=t,e[25]*=t,e[26]*=t},s.clone=function(){var t=new n;return t.copyFrom(this),t},s.copyFrom=function(t){return t.copyToArray(this.coefficients),this},s.copyFromArray=function(t,e){e===void 0&&(e=0);var r=this.coefficients;r[0]=t[e],r[1]=t[1+e],r[2]=t[2+e],r[3]=t[3+e],r[4]=t[4+e],r[5]=t[5+e],r[6]=t[6+e],r[7]=t[7+e],r[8]=t[8+e],r[9]=t[9+e],r[10]=t[10+e],r[11]=t[11+e],r[12]=t[12+e],r[13]=t[13+e],r[14]=t[14+e],r[15]=t[15+e],r[16]=t[16+e],r[17]=t[17+e],r[18]=t[18+e],r[19]=t[19+e],r[20]=t[20+e],r[21]=t[21+e],r[22]=t[22+e],r[23]=t[23+e],r[24]=t[24+e],r[25]=t[25+e],r[26]=t[26+e]},s.copyToArray=function(t,e){e===void 0&&(e=0);var r=this.coefficients;t[0+e]=r[0],t[1+e]=r[1],t[2+e]=r[2],t[3+e]=r[3],t[4+e]=r[4],t[5+e]=r[5],t[6+e]=r[6],t[7+e]=r[7],t[8+e]=r[8],t[9+e]=r[9],t[10+e]=r[10],t[11+e]=r[11],t[12+e]=r[12],t[13+e]=r[13],t[14+e]=r[14],t[15+e]=r[15],t[16+e]=r[16],t[17+e]=r[17],t[18+e]=r[18],t[19+e]=r[19],t[20+e]=r[20],t[21+e]=r[21],t[22+e]=r[22],t[23+e]=r[23],t[24+e]=r[24],t[25+e]=r[25],t[26+e]=r[26]},n}(),wr=function(){function n(i,t){this.reset(i,t)}var s=n.prototype;return s.randomInt32=function(){var t=this._state0,e=this._state1;return this._state0=e,t^=t<<23,t^=t>>>17,t^=e^e>>>26,this._state1=t,this._state0+this._state1>>>0},s.random=function(){return this.randomInt32()/4294967295},s.reset=function(t,e){this._state0=t>>>0,this._state1=e>>>0},n}(),Ht;(function(n){n[n.Android=0]="Android",n[n.IPhone=1]="IPhone",n[n.IPad=2]="IPad",n[n.Mac=3]="Mac",n[n.Unknown=4]="Unknown"})(Ht||(Ht={}));function ue(n){if(n===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}function us(n,s){for(var i=0;i<s.length;i++){var t=s[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function q(n,s,i){return s&&us(n.prototype,s),i&&us(n,i),n}function vo(n,s){return vo=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},vo(n,s)}function W(n,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(s&&s.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),s&&vo(n,s)}var ht;(function(n){n[n.None=0]="None",n[n.VisibleInsideMask=1]="VisibleInsideMask",n[n.VisibleOutsideMask=2]="VisibleOutsideMask"})(ht||(ht={}));var ha;(function(n){n[n.Layer0=1]="Layer0",n[n.Layer1=2]="Layer1",n[n.Layer2=4]="Layer2",n[n.Layer3=8]="Layer3",n[n.Layer4=16]="Layer4",n[n.Layer5=32]="Layer5",n[n.Layer6=64]="Layer6",n[n.Layer7=128]="Layer7",n[n.Layer8=256]="Layer8",n[n.Layer9=512]="Layer9",n[n.Layer10=1024]="Layer10",n[n.Layer11=2048]="Layer11",n[n.Layer12=4096]="Layer12",n[n.Layer13=8192]="Layer13",n[n.Layer14=16384]="Layer14",n[n.Layer15=32768]="Layer15",n[n.Layer16=65536]="Layer16",n[n.Layer17=131072]="Layer17",n[n.Layer18=262144]="Layer18",n[n.Layer19=524288]="Layer19",n[n.Layer20=1048576]="Layer20",n[n.Layer21=2097152]="Layer21",n[n.Layer22=4194304]="Layer22",n[n.Layer23=8388608]="Layer23",n[n.Layer24=16777216]="Layer24",n[n.Layer25=33554432]="Layer25",n[n.Layer26=67108864]="Layer26",n[n.Layer27=134217728]="Layer27",n[n.Layer28=268435456]="Layer28",n[n.Layer29=536870912]="Layer29",n[n.Layer30=1073741824]="Layer30",n[n.Layer31=2147483648]="Layer31",n[n.Everything=4294967295]="Everything"})(ha||(ha={}));var Xn;(function(n){n[n.Left=0]="Left",n[n.Center=1]="Center",n[n.Right=2]="Right"})(Xn||(Xn={}));var jn;(function(n){n[n.Top=0]="Top",n[n.Center=1]="Center",n[n.Bottom=2]="Bottom"})(jn||(jn={}));var Zn;(function(n){n[n.Overflow=0]="Overflow",n[n.Truncate=1]="Truncate"})(Zn||(Zn={}));var Bn;(function(n){n[n.None=0]="None",n[n.Bold=1]="Bold",n[n.Italic=2]="Italic"})(Bn||(Bn={}));function R(n,s,i,t){var e=arguments.length,r=e<3?s:t===null?t=Object.getOwnPropertyDescriptor(s,i):t,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(n,s,i,t);else for(var o=n.length-1;o>=0;o--)(a=n[o])&&(r=(e<3?a(r):e>3?a(s,i,r):a(s,i))||r);return e>3&&r&&Object.defineProperty(s,i,r),r}function ft(n,s){return s!=null&&typeof Symbol<"u"&&s[Symbol.hasInstance]?!!s[Symbol.hasInstance](n):n instanceof s}var fn;(function(n){n[n.Ignore=0]="Ignore",n[n.Assignment=1]="Assignment",n[n.Shallow=2]="Shallow",n[n.Deep=3]="Deep"})(fn||(fn={}));function I(n,s){Br.registerCloneMode(n,s,fn.Ignore)}function Pe(n,s){Br.registerCloneMode(n,s,fn.Assignment)}function zo(n,s){Br.registerCloneMode(n,s,fn.Shallow)}function Z(n,s){Br.registerCloneMode(n,s,fn.Deep)}var Br=function(){function n(){}return n.registerCloneMode=function(i,t,e){var r=n._subCloneModeMap.get(i.constructor);r||(r=Object.create(null),n._subCloneModeMap.set(i.constructor,r)),r[t]=e},n.getCloneMode=function(i){var t=n._cloneModeMap.get(i);if(!t){t=Object.create(null),n._cloneModeMap.set(i,t);for(var e=n._objectType,r=n._subCloneModeMap;i!==e;){var a=r.get(i);a&&Object.assign(t,a),i=Object.getPrototypeOf(i)}}return t},n.cloneProperty=function(i,t,e,r){if(r!==fn.Ignore){var a=i[e];if(ft(a,Object)){if(r===void 0||r===fn.Assignment){t[e]=a;return}var o=a.constructor;switch(o){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:var l=t[e];l==null||l.length!==a.length?t[e]=a.slice():l.set(a);break;case Array:var c=t[e],_=a.length;c==null?t[e]=c=new Array(_):c.length=_;for(var u=0;u<_;u++)n.cloneProperty(a,c,u,r);break;default:var d,h,f=(d=t)[h=e]||(d[h]=new a.constructor),v=n.getCloneMode(a.constructor);for(var p in a)n.cloneProperty(a,f,p,v[p]);a._cloneTo&&a._cloneTo(f),a.copyFrom&&f.copyFrom(a);break}}else t[e]=a}},n.deepCloneObject=function(i,t){for(var e in i)n.cloneProperty(i,t,e,fn.Deep)},n}();(function(){Br._subCloneModeMap=new Map})();(function(){Br._cloneModeMap=new Map})();(function(){Br._objectType=Object.getPrototypeOf(Object)})();var tn=function(){function n(i){this.instanceId=++n._instanceIdCounter,this._destroyed=!1,this._engine=i}var s=n.prototype;return s.destroy=function(){this._destroyed||(this._onDestroy(),this._destroyed=!0)},s._onDestroy=function(){var t=this._engine.resourceManager;t._deleteAsset(this),t._deleteContentRestorer(this)},q(n,[{key:"engine",get:function(){return this._engine}},{key:"destroyed",get:function(){return this._destroyed}}]),n}();(function(){tn._instanceIdCounter=0})();R([I],tn.prototype,"instanceId",void 0);R([I],tn.prototype,"_engine",void 0);var rn=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e.isGCIgnored=!1,e._refCount=0,e._superResources=null,t.resourceManager._addReferResource(ue(e)),e}var i=s.prototype;return i.destroy=function(e,r){if(e===void 0&&(e=!1),!e){var a;if(this._refCount!==0)return!1;var o=this._superResources;if((a=o)!=null&&a.length)if(r){for(var l=0,c=o.length;l<c;l++)if(o[l].refCount>0)return!1}else return!1}return n.prototype.destroy.call(this),!0},i._associationSuperResource=function(e){(this._superResources||(this._superResources=[])).push(e)},i._disassociationSuperResource=function(e){var r=this._superResources,a=r.indexOf(e);r.splice(a,1)},i._getReferCount=function(){return this._refCount},i._addReferCount=function(e){this._refCount+=e},i._addToResourceManager=function(e){this._engine.resourceManager._addAsset(e,this)},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._engine.resourceManager._deleteReferResource(this);var e=this._getReferCount();e>0&&this._addReferCount(-e)},q(s,[{key:"refCount",get:function(){return this._refCount}}]),s}(tn),sc=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._sprites=new Array,e._spriteNamesToIndex={},e}var i=s.prototype;return i.getSprite=function(e){var r=this._sprites[this._spriteNamesToIndex[e]];return r||console.warn("There is no sprite named "+e+" in the atlas."),r},i.getSprites=function(e,r){r.length=0;var a=this._spriteNamesToIndex[e];if(a!==void 0)for(var o=this._sprites;a>=0;a--){var l=o[a];l.name===e&&r.push(l)}else console.warn("The name of the sprite you want to find is not exit in SpriteAtlas.");return r},i._addSprite=function(e){this._spriteNamesToIndex[e.name]=this._sprites.push(e)-1,e._atlas=this,e.isGCIgnored=!0},i._onDestroy=function(){n.prototype._onDestroy.call(this);for(var e=this,r=e._sprites,a=0,o=r.length;a<o;a++)r[a].destroy();r.length=0,this._sprites=null,this._spriteNamesToIndex=null},q(s,[{key:"sprites",get:function(){return this._sprites}}]),s}(rn),br;(function(n){n[n.Simple=0]="Simple",n[n.Sliced=1]="Sliced",n[n.Tiled=2]="Tiled"})(br||(br={}));var Oa;(function(n){n[n.Continuous=0]="Continuous",n[n.Adaptive=1]="Adaptive"})(Oa||(Oa={}));var We=function(){function n(){}return n.removeFromArray=function(i,t){var e=i.indexOf(t);if(e<0)return!1;var r=i.length-1;if(e!==r){var a=i[r];i[e]=a}return i.length--,!0},n.decodeText=function(i){if(typeof TextDecoder<"u")return new TextDecoder().decode(i);for(var t="",e=0,r=i.length;e<r;e++)t+=String.fromCharCode(i[e]);return decodeURIComponent(encodeURIComponent(t))},n.isAbsoluteUrl=function(i){return/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(i)},n.isBase64Url=function(i){return/^data:.*,.*$/i.test(i)},n.objectValues=function(i){return Object.keys(i).map(function(t){return i[t]})},n.resolveAbsoluteUrl=function(i,t){return n.isAbsoluteUrl(t)||n.isBase64Url(t)?t:t?new URL(t,i).href:i},n._floatMatrixMultiply=function(i,t,e,r,a){var o=i.elements,l=o[0],c=o[1],_=o[2],u=o[3],d=o[4],h=o[5],f=o[6],v=o[7],p=o[8],g=o[9],y=o[10],m=o[11],x=o[12],S=o[13],b=o[14],A=o[15],C=t[e],E=t[e+1],T=t[e+2],B=t[e+3],M=t[e+4],P=t[e+5],V=t[e+6],N=t[e+7],F=t[e+8],O=t[e+9],D=t[e+10],z=t[e+11],U=t[e+12],Y=t[e+13],K=t[e+14],H=t[e+15];r[a]=l*C+d*E+p*T+x*B,r[a+1]=c*C+h*E+g*T+S*B,r[a+2]=_*C+f*E+y*T+b*B,r[a+3]=u*C+v*E+m*T+A*B,r[a+4]=l*M+d*P+p*V+x*N,r[a+5]=c*M+h*P+g*V+S*N,r[a+6]=_*M+f*P+y*V+b*N,r[a+7]=u*M+v*P+m*V+A*N,r[a+8]=l*F+d*O+p*D+x*z,r[a+9]=c*F+h*O+g*D+S*z,r[a+10]=_*F+f*O+y*D+b*z,r[a+11]=u*F+v*O+m*D+A*z,r[a+12]=l*U+d*Y+p*K+x*H,r[a+13]=c*U+h*Y+g*K+S*H,r[a+14]=_*U+f*Y+y*K+b*H,r[a+15]=u*U+v*Y+m*K+A*H},n._reflectGet=function(i,t){for(var e=this._stringToPath(t),r=i,a=0,o=e.length;r!=null&&a<o;)r=r[e[a++]];return a&&a==o?r:void 0},n._quickSort=function(i,t,e,r){for(;;){if(e-t<=10){this._insertionSort(i,t,e,r);return}var a=t+e>>1,o=i[t],l=i[e-1],c=i[a],_=r(o,l);if(_>0){var u=o;o=l,l=u}var d=r(o,c);if(d>=0){var h=o;o=c,c=l,l=h}else{var f=r(l,c);if(f>0){var v=l;l=c,c=v}}i[t]=o,i[e-1]=c;var p=l,g=t+1,y=e-1;i[a]=i[g],i[g]=p;e:for(var m=g+1;m<y;m++){var x=i[m],S=r(x,p);if(S<0)i[m]=i[g],i[g]=x,g++;else if(S>0){do{if(y--,y==m)break e;var b=i[y];S=r(b,p)}while(S>0);i[m]=i[y],i[y]=x,S<0&&(x=i[m],i[m]=i[g],i[g]=x,g++)}}e-y<g-t?(this._quickSort(i,y,e,r),e=g):(this._quickSort(i,t,g,r),t=y)}},n._stringToPath=function(i){var t=[];return i.charCodeAt(0)===Jc&&t.push(""),i.replace($c,function(e,r,a,o){var l=e;a?l=o.replace(Zc,"$1"):r&&(l=r.trim()),t.push(l)}),t},n._insertionSort=function(i,t,e,r){for(var a=t+1;a<e;a++){var o=void 0,l=i[a];for(o=a-1;o>=t;o--){var c=i[o],_=r(c,l);if(_>0)i[o+1]=c;else break}i[o+1]=l}},n}(),Jc=".".charCodeAt(0),Zc=/\\(\\)?/g,$c=RegExp(`[^.[\\]]+|\\[(?:([^"'][^[]*)|(["'])((?:(?!\\2)[^\\\\]|\\\\.)*?)\\2)\\]|(?=(?:\\.|\\[\\])(?:\\.|\\[\\]|$))`,"g"),zr=function(){function n(){this._updateFlags=[],this._listeners=[]}var s=n.prototype;return s.createFlag=function(t){var e=new t;return this.addFlag(e),e},s.addFlag=function(t){this._updateFlags.push(t),t._flagManagers.push(this)},s.removeFlag=function(t){var e=We.removeFromArray(this._updateFlags,t);e&&We.removeFromArray(t._flagManagers,this)},s.addListener=function(t){this._listeners.push(t)},s.removeListener=function(t){We.removeFromArray(this._listeners,t)},s.dispatch=function(t,e){for(var r=this._updateFlags,a=r.length-1;a>=0;a--)r[a].dispatch(t,e);for(var o=this._listeners,l=o.length-1;l>=0;l--)o[l](t,e)},n}(),Re;(function(n){n[n.texture=1]="texture",n[n.size=2]="size",n[n.atlasRotate=4]="atlasRotate",n[n.atlasRegion=8]="atlasRegion",n[n.atlasRegionOffset=16]="atlasRegionOffset",n[n.region=32]="region",n[n.pivot=64]="pivot",n[n.border=128]="border",n[n.destroy=256]="destroy"})(Re||(Re={}));var Ei=function(n){W(s,n);function s(t,e,r,a,o,l){e===void 0&&(e=null),r===void 0&&(r=null),a===void 0&&(a=null),o===void 0&&(o=null),l===void 0&&(l=null);var c;return c=n.call(this,t)||this,c._automaticWidth=0,c._automaticHeight=0,c._customWidth=void 0,c._customHeight=void 0,c._positions=[new $,new $,new $,new $],c._uvs=[new $,new $,new $,new $],c._bounds=new nr,c._texture=null,c._atlasRotated=!1,c._atlasRegion=new qr(0,0,1,1),c._atlasRegionOffset=new ae(0,0,0,0),c._region=new qr(0,0,1,1),c._pivot=new $(.5,.5),c._border=new ae(0,0,0,0),c._dirtyUpdateFlag=7,c._updateFlagManager=new zr,c._texture=e,c._onRegionChange=c._onRegionChange.bind(ue(c)),c._onPivotChange=c._onPivotChange.bind(ue(c)),c._onBorderChange=c._onBorderChange.bind(ue(c)),c._region._onValueChanged=c._onRegionChange,c._pivot._onValueChanged=c._onPivotChange,c._border._onValueChanged=c._onBorderChange,r&&c._region.copyFrom(r),a&&c._pivot.copyFrom(a),o&&c._border.copyFrom(o),c.name=l,c}var i=s.prototype;return i.clone=function(){var e=new s(this._engine,this._texture,this._region,this._pivot,this._border,this.name);return e._atlasRotated=this._atlasRotated,e._atlasRegion.copyFrom(this._atlasRegion),e._atlasRegionOffset.copyFrom(this._atlasRegionOffset),e},i._getPositions=function(){return this._dirtyUpdateFlag&1&&this._updatePositions(),this._positions},i._getUVs=function(){return this._dirtyUpdateFlag&2&&this._updateUVs(),this._uvs},i._getBounds=function(){return this._dirtyUpdateFlag&1&&this._updatePositions(),this._bounds},i._addReferCount=function(e){var r;n.prototype._addReferCount.call(this,e),(r=this._atlas)==null||r._addReferCount(e)},i._onDestroy=function(){this._dispatchSpriteChange(Re.destroy),n.prototype._onDestroy.call(this),this._positions.length=0,this._positions=null,this._uvs.length=0,this._uvs=null,this._atlasRegion=null,this._atlasRegionOffset=null,this._region=null,this._pivot=null,this._border=null,this._bounds=null,this._atlas=null,this._texture=null,this._updateFlagManager=null},i._calDefaultSize=function(){if(this._texture){var e=this,r=e._texture,a=e._atlasRegion,o=e._atlasRegionOffset,l=e._region,c=1/yn._pixelsPerUnit;this._automaticWidth=r.width*a.width/(1-o.x-o.z)*l.width*c,this._automaticHeight=r.height*a.height/(1-o.y-o.w)*l.height*c}else this._automaticWidth=this._automaticHeight=0;this._dirtyUpdateFlag&=-5},i._updatePositions=function(){var e=this._atlasRegionOffset,r=this._region,a=r.x,o=r.y,l=r.width,c=r.height,_=1-a-l,u=1-o-c,d=Math.max(e.x-a,0)/l,h=Math.max(e.w-o,0)/c,f=1-Math.max(e.z-_,0)/l,v=1-Math.max(e.y-u,0)/c,p=this._positions;p[0].set(d,h),p[1].set(f,h),p[2].set(d,v),p[3].set(f,v);var g=this._bounds,y=g.min,m=g.max;y.set(d,h,0),m.set(f,v,0),this._dirtyUpdateFlag&=-2},i._updateUVs=function(){var e=this,r=e._uvs,a=e._atlasRegionOffset,o=this._region,l=o.x,c=o.y,_=o.width,u=o.height,d=1-l-_,h=1-c-u,f=this._atlasRegion,v=f.x,p=f.y,g=f.width,y=f.height,m=a.x,x=a.y,S=a.z,b=a.w,A=g/(1-m-S),C=y/(1-x-b),E=Math.max(l-m,0)*A+v,T=Math.max(h-x,0)*C+p,B=g+v-Math.max(d-S,0)*A,M=y+p-Math.max(c-b,0)*C,P=this._border,V=P.x,N=P.y,F=P.z,O=P.w;r[0].set(E,M),r[1].set((l-m+V*_)*A+v,y+p-(c-b+N*u)*C),r[2].set(g+v-(d-S+F*_)*A,(h-x+O*u)*C+p),r[3].set(B,T),this._dirtyUpdateFlag&=-3},i._dispatchSpriteChange=function(e){switch(e){case Re.texture:this._dirtyUpdateFlag|=4;break;case Re.atlasRegionOffset:case Re.region:this._dirtyUpdateFlag|=7;break;case Re.atlasRegion:this._dirtyUpdateFlag|=6;break;case Re.border:this._dirtyUpdateFlag|=2;break}this._updateFlagManager.dispatch(e)},i._onRegionChange=function(){var e=this,r=e._region;r._onValueChanged=null;var a=k.clamp(r.x,0,1),o=k.clamp(r.y,0,1);r.set(a,o,k.clamp(r.width,0,1-a),k.clamp(r.height,0,1-o)),this._dispatchSpriteChange(Re.region),(this._customWidth===void 0||this._customHeight===void 0)&&this._dispatchSpriteChange(Re.size),r._onValueChanged=this._onRegionChange},i._onPivotChange=function(){this._dispatchSpriteChange(Re.pivot)},i._onBorderChange=function(){var e=this,r=e._border;r._onValueChanged=null;var a=k.clamp(r.x,0,1),o=k.clamp(r.y,0,1);r.set(a,o,k.clamp(r.z,0,1-a),k.clamp(r.w,0,1-o)),this._dispatchSpriteChange(Re.border),r._onValueChanged=this._onBorderChange},q(s,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture!==e&&(this._texture=e,this._dispatchSpriteChange(Re.texture),(this._customWidth===void 0||this._customHeight===void 0)&&this._dispatchSpriteChange(Re.size))}},{key:"width",get:function(){return this._customWidth!==void 0?this._customWidth:(this._dirtyUpdateFlag&4&&this._calDefaultSize(),this._automaticWidth)},set:function(e){this._customWidth!==e&&(this._customWidth=e,this._dispatchSpriteChange(Re.size))}},{key:"height",get:function(){return this._customHeight!==void 0?this._customHeight:(this._dirtyUpdateFlag&4&&this._calDefaultSize(),this._automaticHeight)},set:function(e){this._customHeight!==e&&(this._customHeight=e,this._dispatchSpriteChange(Re.size))}},{key:"atlasRotated",get:function(){return this._atlasRotated},set:function(e){this._atlasRotated!=e&&(this._atlasRotated=e)}},{key:"atlasRegion",get:function(){return this._atlasRegion},set:function(e){var r=k.clamp(e.x,0,1),a=k.clamp(e.y,0,1);this._atlasRegion.set(r,a,k.clamp(e.width,0,1-r),k.clamp(e.height,0,1-a)),this._dispatchSpriteChange(Re.atlasRegion),(this._customWidth===void 0||this._customHeight===void 0)&&this._dispatchSpriteChange(Re.size)}},{key:"atlasRegionOffset",get:function(){return this._atlasRegionOffset},set:function(e){var r=k.clamp(e.x,0,1),a=k.clamp(e.y,0,1);this._atlasRegionOffset.set(r,a,k.clamp(e.z,0,1-r),k.clamp(e.w,0,1-a)),this._dispatchSpriteChange(Re.atlasRegionOffset),(this._customWidth===void 0||this._customHeight===void 0)&&this._dispatchSpriteChange(Re.size)}},{key:"region",get:function(){return this._region},set:function(e){this._region!==e&&this._region.copyFrom(e)}},{key:"pivot",get:function(){return this._pivot},set:function(e){this._pivot!==e&&this._pivot.copyFrom(e)}},{key:"border",get:function(){return this._border},set:function(e){this._border!==e&&this._border.copyFrom(e)}}]),s}(rn),ds;(function(n){n[n.positions=1]="positions",n[n.uvs=2]="uvs",n[n.automaticSize=4]="automaticSize",n[n.all=7]="all"})(ds||(ds={}));var Uo=function(){function n(){this._events=Object.create(null),this._eventCount=0}var s=n.prototype;return s.hasEvent=function(t){return this._events[t]!=null},s.eventNames=function(){return this._eventCount===0?[]:Object.keys(this._events)},s.listenerCount=function(t){var e=this._events[t];return e?Array.isArray(e)?e.length:1:0},s.dispatch=function(t,e){if(!this._events[t])return!1;var r=this._events[t];if(Array.isArray(r)){var a=r.length,o=n._dispatchingListenersPool,l=o.length>0?o.pop():[];l.length=a;for(var c=0;c<a;c++)l[c]=r[c];for(var _=0;_<a;_++){var u=l[_];u.destroyed||(u.once&&this.off(t,u.fn),u.fn(e))}l.length=0,o.push(l)}else r.once&&this.off(t,r.fn),r.fn(e);return!0},s.on=function(t,e){return this._addEventListener(t,e)},s.once=function(t,e){return this._addEventListener(t,e,!0)},s.off=function(t,e){if(!this._events[t])return this;if(!e)return this._clearEvent(t),this;var r=this._events[t],a=Array.isArray(r);if(!a&&r.fn===e)this._clearEvent(t);else if(a){for(var o=r.length-1;o>=0;o--)r[o].fn===e&&(r[o].destroyed=!0,r.splice(o,1));r.length===0?this._clearEvent(t):r.length===1&&(this._events[t]=r[0])}return this},s.removeEventListener=function(t,e){return this.off(t,e)},s.removeAllEventListeners=function(t){t?this._events[t]&&this._clearEvent(t):(this._events=Object.create(null),this._eventCount=0)},s._addEventListener=function(t,e,r){var a={fn:e,once:r},o=this._events,l=o[t];return l?Array.isArray(l)?l.push(a):o[t]=[l,a]:(o[t]=a,this._eventCount++),this},s._clearEvent=function(t){--this._eventCount===0?this._events=Object.create(null):delete this._events[t]},n}();(function(){Uo._dispatchingListenersPool=[]})();var Rn=function(n){for(var s=arguments.length,i=new Array(s>1?s-1:0),t=1;t<s;t++)i[t-1]=arguments[t]},e_=console.log.bind(console),t_=console.info.bind(console),r_=console.warn.bind(console),n_=console.error.bind(console),ve={debug:Rn,info:Rn,warn:Rn,error:Rn,isEnabled:!1,enable:function(){this.debug=e_,this.info=t_,this.warn=r_,this.error=n_,this.isEnabled=!0},disable:function(){this.debug=Rn,this.info=Rn,this.warn=Rn,this.error=Rn,this.isEnabled=!1}},L=function(){function n(s){this.name=s,this._uniqueId=n._propertyNameCounter++}return n.getByName=function(i){var t=n._propertyNameMap;if(t[i]!=null)return t[i];var e=new n(i);return t[i]=e,n._propertyIdMap[e._uniqueId]=e,e},n._getShaderPropertyGroup=function(i){var t,e=n._propertyNameMap[i];return(t=e)==null?void 0:t._group},q(n,[{key:"type",get:function(){return this._type}}]),n}();(function(){L._propertyIdMap=Object.create(null)})();(function(){L._propertyNameCounter=0})();(function(){L._propertyNameMap=Object.create(null)})();var Yi=function(){function n(){this._frameCount=0,this._deltaTime=0,this._actualDeltaTime=0,this._elapsedTime=0,this._actualElapsedTime=0,this._elapsedTimeValue=new ae,this._deltaTimeValue=new ae,this.maximumDeltaTime=.333333,this.timeScale=1,this._lastSystemTime=performance.now()/1e3}var s=n.prototype;return s._reset=function(){this._lastSystemTime=performance.now()/1e3},s._update=function(){var t=performance.now()/1e3,e=t-this._lastSystemTime;this._actualDeltaTime=e,this._actualElapsedTime+=e;var r=Math.min(e,this.maximumDeltaTime)*this.timeScale;this._deltaTime=r,this._elapsedTime+=r,this._frameCount++,this._lastSystemTime=t},s._updateSceneShaderData=function(t){var e=this,r=e._elapsedTimeValue,a=e._deltaTimeValue,o=this._elapsedTime;r.set(o,Math.sin(o),Math.cos(o),0),t.setVector4(n._elapsedTimeProperty,r),a.set(this._deltaTime,0,0,0),t.setVector4(n._deltaTimeProperty,a)},q(n,[{key:"frameCount",get:function(){return this._frameCount}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"elapsedTime",get:function(){return this._elapsedTime}},{key:"actualDeltaTime",get:function(){return this._actualDeltaTime}},{key:"actualElapsedTime",get:function(){return this._actualElapsedTime}}]),n}();(function(){Yi._elapsedTimeProperty=L.getByName("scene_ElapsedTime")})();(function(){Yi._deltaTimeProperty=L.getByName("scene_DeltaTime")})();var Ue;(function(n){n[n.FLOAT=5126]="FLOAT",n[n.FLOAT_VEC2=35664]="FLOAT_VEC2",n[n.FLOAT_VEC3=35665]="FLOAT_VEC3",n[n.FLOAT_VEC4=35666]="FLOAT_VEC4",n[n.INT=5124]="INT",n[n.INT_VEC2=35667]="INT_VEC2",n[n.INT_VEC3=35668]="INT_VEC3",n[n.INT_VEC4=35669]="INT_VEC4",n[n.BOOL=35670]="BOOL",n[n.BOOL_VEC2=35671]="BOOL_VEC2",n[n.BOOL_VEC3=35672]="BOOL_VEC3",n[n.BOOL_VEC4=35673]="BOOL_VEC4",n[n.FLOAT_MAT2=35674]="FLOAT_MAT2",n[n.FLOAT_MAT3=35675]="FLOAT_MAT3",n[n.FLOAT_MAT4=35676]="FLOAT_MAT4",n[n.FLOAT_ARRAY=35677]="FLOAT_ARRAY",n[n.FLOAT_VEC2_ARRAY=1e5]="FLOAT_VEC2_ARRAY",n[n.FLOAT_VEC3_ARRAY=100001]="FLOAT_VEC3_ARRAY",n[n.FLOAT_VEC4_ARRAY=100002]="FLOAT_VEC4_ARRAY",n[n.INT_ARRAY=100003]="INT_ARRAY",n[n.INT_VEC2_ARRAY=100004]="INT_VEC2_ARRAY",n[n.INT_VEC3_ARRAY=100005]="INT_VEC3_ARRAY",n[n.INT_VEC4_ARRAY=100006]="INT_VEC4_ARRAY",n[n.FLOAT_MAT2_ARRAY=100007]="FLOAT_MAT2_ARRAY",n[n.FLOAT_MAT3_ARRAY=100008]="FLOAT_MAT3_ARRAY",n[n.FLOAT_MAT4_ARRAY=100009]="FLOAT_MAT4_ARRAY",n[n.SAMPLER_2D_ARRAY=100010]="SAMPLER_2D_ARRAY",n[n.SAMPLER_CUBE_ARRAY=100011]="SAMPLER_CUBE_ARRAY",n[n.SAMPLER_2D=35678]="SAMPLER_2D",n[n.SAMPLER_CUBE=35680]="SAMPLER_CUBE",n[n.BYTE=5120]="BYTE",n[n.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",n[n.SHORT=5122]="SHORT",n[n.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",n[n.UNSIGNED_INT=5125]="UNSIGNED_INT"})(Ue||(Ue={}));var Q;(function(n){n.shaderVertexID="shaderVertexID",n.standardDerivatives="OES_standard_derivatives",n.shaderTextureLod="EXT_shader_texture_lod",n.elementIndexUint="OES_element_index_uint",n.depthTexture="WEBGL_depth_texture",n.drawBuffers="WEBGL_draw_buffers",n.vertexArrayObject="OES_vertex_array_object",n.instancedArrays="ANGLE_instanced_arrays",n.multipleSample="multipleSampleOnlySupportedInWebGL2",n.textureFloat="OES_texture_float",n.textureFloatLinear="OES_texture_float_linear",n.textureHalfFloat="OES_texture_half_float",n.textureHalfFloatLinear="OES_texture_half_float_linear",n.WEBGL_colorBufferFloat="WEBGL_color_buffer_float",n.colorBufferFloat="EXT_color_buffer_float",n.colorBufferHalfFloat="EXT_color_buffer_half_float",n.textureFilterAnisotropic="EXT_texture_filter_anisotropic",n.blendMinMax="EXT_blend_minmax",n.fragDepth="EXT_frag_depth",n.astc="WEBGL_compressed_texture_astc",n.astc_webkit="WEBKIT_WEBGL_compressed_texture_astc",n.etc="WEBGL_compressed_texture_etc",n.etc_webkit="WEBKIT_WEBGL_compressed_texture_etc",n.etc1="WEBGL_compressed_texture_etc1",n.etc1_webkit="WEBKIT_WEBGL_compressed_texture_etc1",n.pvrtc="WEBGL_compressed_texture_pvrtc",n.pvrtc_webkit="WEBKIT_WEBGL_compressed_texture_pvrtc",n.s3tc="WEBGL_compressed_texture_s3tc",n.s3tc_webkit="WEBKIT_WEBGL_compressed_texture_s3tc",n.bptc="EXT_texture_compression_bptc",n.WEBGL_lose_context="WEBGL_lose_context"})(Q||(Q={}));var he;(function(n){n[n.None=0]="None",n[n.Scene=1]="Scene",n[n.Hierarchy=2]="Hierarchy",n[n.All=3]="All"})(he||(he={}));var Vt=function(n){W(s,n);function s(t){var e;return e=n.call(this,t.engine)||this,e._awoken=!1,e._phasedActiveInScene=!1,e._phasedActive=!1,e._enabled=!0,e._entity=t,e}var i=s.prototype;return i._onAwake=function(){},i._onEnable=function(){},i._onDisable=function(){},i._onEnableInScene=function(){},i._onDisableInScene=function(){},i._setActive=function(e,r){var a=this._entity;r&he.Scene&&(e?!this._phasedActiveInScene&&a._isActiveInScene&&this._enabled&&(this._phasedActiveInScene=!0,this._onEnableInScene()):this._phasedActiveInScene&&!(a._isActiveInScene&&this._enabled)&&(this._phasedActiveInScene=!1,this._onDisableInScene())),r&he.Hierarchy&&(e?(!this._awoken&&a._isActiveInHierarchy&&(this._awoken=!0,this._onAwake()),!this._phasedActive&&a._isActiveInHierarchy&&this._enabled&&(this._phasedActive=!0,this._onEnable())):this._phasedActive&&!(a._isActiveInHierarchy&&this._enabled)&&(this._phasedActive=!1,this._onDisable()))},i._addResourceReferCount=function(e,r){this._entity._isTemplate||e._addReferCount(r)},i._onDestroy=function(){n.prototype._onDestroy.call(this);var e=this._entity;e._removeComponent(this),this._enabled&&(e._isActiveInScene&&this._onDisableInScene(),e._isActiveInHierarchy&&this._onDisable())},q(s,[{key:"enabled",get:function(){return this._enabled},set:function(e){e!==this._enabled&&(this._enabled=e,this._entity._isActiveInScene&&(e?this._phasedActiveInScene||(this._phasedActiveInScene=!0,this._onEnableInScene()):this._phasedActiveInScene&&(this._phasedActiveInScene=!1,this._onDisableInScene())),this._entity.isActiveInHierarchy&&(e?this._phasedActive||(this._phasedActive=!0,this._onEnable()):this._phasedActive&&(this._phasedActive=!1,this._onDisable())))}},{key:"entity",get:function(){return this._entity}},{key:"scene",get:function(){return this._entity.scene}}]),s}(tn);R([I],Vt.prototype,"_entity",void 0);R([I],Vt.prototype,"_awoken",void 0);R([I],Vt.prototype,"_phasedActiveInScene",void 0);R([I],Vt.prototype,"_phasedActive",void 0);R([Pe],Vt.prototype,"_enabled",void 0);var fa=function(){function n(){}return n._addCheck=function(i,t){for(;t!==Vt;){var e=n._dependenciesMap.get(t);if(e)for(var r=e.components,a=e.mode,o=0,l=r.length;o<l;o++){var c=r[o];if(!i.getComponent(c))if(a===1)i.addComponent(c);else throw"Should add "+c.name+" before adding "+t.name}t=Object.getPrototypeOf(t)}},n._removeCheck=function(i,t){for(;t!==Vt;){var e=n._invDependenciesMap.get(t);if(e){for(var r=0,a=e.length;r<a;r++)if(i.getComponent(e[r]))throw"Should remove "+e[r].name+" before adding "+t.name}t=Object.getPrototypeOf(t)}},n._addDependency=function(i,t,e){var r=e.get(i);r?r.includes(t)||r.push(t):e.set(i,[t])},n._addInvDependency=function(i,t){var e=this._invDependenciesMap,r=e.get(i);r?r.includes(t)||r.push(t):e.set(i,[t])},n}();(function(){fa._invDependenciesMap=new Map})();(function(){fa._dependenciesMap=new Map})();function An(n,s){s===void 0&&(s=0);var i=Array.isArray(n)?n:[n];return function(t){fa._dependenciesMap.set(t,{mode:s,components:i}),i.forEach(function(e){return fa._addInvDependency(e,t)})}}var Ur;(function(n){n[n.CheckOnly=0]="CheckOnly",n[n.AutoAdd=1]="AutoAdd"})(Ur||(Ur={}));var a_=function(){function n(){this._flagManagers=[]}var s=n.prototype;return s.clearFromManagers=function(){this._removeFromManagers(),this._flagManagers.length=0},s.destroy=function(){this._removeFromManagers(),this._flagManagers=null},s._removeFromManagers=function(){for(var t=this._flagManagers,e=0,r=t.length;e<r;e++)We.removeFromArray(t[e]._updateFlags,this)},n}(),Qi=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.flag=!0,t}var i=s.prototype;return i.dispatch=function(){this.flag=!0},s}(a_),me=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._position=new w,e._rotation=new w,e._rotationQuaternion=new ye,e._scale=new w(1,1,1),e._worldPosition=new w,e._worldRotation=new w,e._worldRotationQuaternion=new ye,e._lossyWorldScale=new w(1,1,1),e._localMatrix=new J,e._worldMatrix=new J,e._worldForward=null,e._worldRight=null,e._worldUp=null,e._isParentDirty=!0,e._parentTransformCache=null,e._dirtyFlag=188,e._updateFlagManager=new zr,e._onPositionChanged=e._onPositionChanged.bind(ue(e)),e._onWorldPositionChanged=e._onWorldPositionChanged.bind(ue(e)),e._onRotationChanged=e._onRotationChanged.bind(ue(e)),e._onWorldRotationChanged=e._onWorldRotationChanged.bind(ue(e)),e._onRotationQuaternionChanged=e._onRotationQuaternionChanged.bind(ue(e)),e._onWorldRotationQuaternionChanged=e._onWorldRotationQuaternionChanged.bind(ue(e)),e._onScaleChanged=e._onScaleChanged.bind(ue(e)),e._position._onValueChanged=e._onPositionChanged,e._worldPosition._onValueChanged=e._onWorldPositionChanged,e._rotation._onValueChanged=e._onRotationChanged,e._worldRotation._onValueChanged=e._onWorldRotationChanged,e._rotationQuaternion._onValueChanged=e._onRotationQuaternionChanged,e._worldRotationQuaternion._onValueChanged=e._onWorldRotationQuaternionChanged,e._scale._onValueChanged=e._onScaleChanged,e}var i=s.prototype;return i.setPosition=function(e,r,a){this._position.set(e,r,a)},i.setRotation=function(e,r,a){this._rotation.set(e,r,a)},i.setRotationQuaternion=function(e,r,a,o){this._rotationQuaternion.set(e,r,a,o)},i.setScale=function(e,r,a){this._scale.set(e,r,a)},i.setWorldPosition=function(e,r,a){this._worldPosition.set(e,r,a)},i.setWorldRotation=function(e,r,a){this._worldRotation.set(e,r,a)},i.setWorldRotationQuaternion=function(e,r,a,o){this._worldRotationQuaternion.set(e,r,a,o)},i.translate=function(e,r,a,o){if(typeof e=="number"){var l=s._tempVec30;l.set(e,r,a),this._translate(l,o)}else this._translate(e,r)},i.rotate=function(e,r,a,o){typeof e=="number"?this._rotateXYZ(e,r,a,o):this._rotateXYZ(e.x,e.y,e.z,r)},i.rotateByAxis=function(e,r,a){a===void 0&&(a=!0);var o=r*k.degreeToRadFactor;ye.rotationAxisAngle(e,o,s._tempQuat0),this._rotateByQuat(s._tempQuat0,a)},i.lookAt=function(e,r){var a=s._tempVec30;w.subtract(this.worldPosition,e,a);var o=a.length();if(!(o<=k.zeroTolerance)){a.scale(1/o);var l=s._tempVec31;if(r?w.cross(r,a,l):l.set(a.z,0,-a.x),o=l.length(),!(o<=k.zeroTolerance)){l.scale(1/o);var c=s._tempVec32;w.cross(a,l,c);var _=s._tempMat41,u=_.elements;u[0]=l.x,u[1]=l.y,u[2]=l.z,u[4]=c.x,u[5]=c.y,u[6]=c.z,u[8]=a.x,u[9]=a.y,u[10]=a.z,_.getRotation(this._worldRotationQuaternion)}}},i.registerWorldChangeFlag=function(){return this._updateFlagManager.createFlag(Qi)},i._parentChange=function(){this._isParentDirty=!0,this._updateAllWorldFlag()},i._isFrontFaceInvert=function(){var e=this.lossyWorldScale,r=e.x<0;return e.y<0&&(r=!r),e.z<0&&(r=!r),r},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._worldPosition._onValueChanged=null,this._rotation._onValueChanged=null,this._worldRotation._onValueChanged=null,this._rotationQuaternion._onValueChanged=null,this._worldRotationQuaternion._onValueChanged=null,this._position._onValueChanged=null,this._scale._onValueChanged=null},i._updateWorldPositionFlag=function(){if(!this._isContainDirtyFlags(132)){this._worldAssociatedChange(132);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var o;(o=e[r].transform)==null||o._updateWorldPositionFlag()}}},i._updateWorldRotationFlag=function(){if(!this._isContainDirtyFlags(152)){this._worldAssociatedChange(152);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var o;(o=e[r].transform)==null||o._updateWorldPositionAndRotationFlag()}}},i._updateWorldPositionAndRotationFlag=function(){if(!this._isContainDirtyFlags(156)){this._worldAssociatedChange(156);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var o;(o=e[r].transform)==null||o._updateWorldPositionAndRotationFlag()}}},i._updateWorldScaleFlag=function(){if(!this._isContainDirtyFlags(160)){this._worldAssociatedChange(160);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var o;(o=e[r].transform)==null||o._updateWorldPositionAndScaleFlag()}}},i._updateWorldPositionAndScaleFlag=function(){if(!this._isContainDirtyFlags(164)){this._worldAssociatedChange(164);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var o;(o=e[r].transform)==null||o._updateWorldPositionAndScaleFlag()}}},i._updateAllWorldFlag=function(){if(!this._isContainDirtyFlags(188)){this._worldAssociatedChange(188);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var o;(o=e[r].transform)==null||o._updateAllWorldFlag()}}},i._getParentTransform=function(){if(!this._isParentDirty)return this._parentTransformCache;for(var e=null,r=this._entity.parent;r;){var a=r.transform;if(a){e=a;break}else r=r.parent}return this._parentTransformCache=e,this._isParentDirty=!1,e},i._getScaleMatrix=function(){var e=s._tempQuat0,r=s._tempMat30,a=s._tempMat31,o=s._tempMat32;return a.copyFromMatrix(this.worldMatrix),ye.invert(this.worldRotationQuaternion,e),da.rotationQuaternion(e,r),da.multiply(r,a,o),o},i._isContainDirtyFlags=function(e){return(this._dirtyFlag&e)===e},i._isContainDirtyFlag=function(e){return(this._dirtyFlag&e)!=0},i._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},i._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},i._worldAssociatedChange=function(e){this._dirtyFlag|=e,this._updateFlagManager.dispatch(128)},i._rotateByQuat=function(e,r){r?ye.multiply(this.rotationQuaternion,e,this._rotationQuaternion):ye.multiply(e,this.worldRotationQuaternion,this._worldRotationQuaternion)},i._translate=function(e,r){if(r===void 0&&(r=!0),r){var a=s._tempVec30;w.transformByQuat(e,this.worldRotationQuaternion,a),this.worldPosition.add(a)}else this.worldPosition.add(e)},i._rotateXYZ=function(e,r,a,o){o===void 0&&(o=!0);var l=k.degreeToRadFactor,c=s._tempQuat0;ye.rotationEuler(e*l,r*l,a*l,c),this._rotateByQuat(c,o)},i._onPositionChanged=function(){this._setDirtyFlagTrue(64),this._updateWorldPositionFlag()},i._onWorldPositionChanged=function(){var e=this._worldPosition,r=this._getParentTransform();r?(J.invert(r.worldMatrix,s._tempMat41),w.transformCoordinate(e,s._tempMat41,this._position)):this._position.copyFrom(e),this._setDirtyFlagFalse(4)},i._onRotationChanged=function(){this._setDirtyFlagTrue(66),this._setDirtyFlagFalse(1),this._updateWorldRotationFlag()},i._onWorldRotationChanged=function(){var e=this._worldRotation;ye.rotationEuler(k.degreeToRadian(e.x),k.degreeToRadian(e.y),k.degreeToRadian(e.z),this._worldRotationQuaternion),this._setDirtyFlagFalse(8)},i._onRotationQuaternionChanged=function(){this._setDirtyFlagTrue(65),this._setDirtyFlagFalse(2),this._updateWorldRotationFlag()},i._onWorldRotationQuaternionChanged=function(){var e=this._worldRotationQuaternion,r=this._getParentTransform();if(r){var a=s._tempQuat0;ye.invert(r.worldRotationQuaternion,a),ye.multiply(a,e,this._rotationQuaternion)}else this._rotationQuaternion.copyFrom(e);this._setDirtyFlagFalse(16)},i._onScaleChanged=function(){this._setDirtyFlagTrue(64),this._updateWorldScaleFlag()},q(s,[{key:"position",get:function(){return this._position},set:function(e){this._position!==e&&this._position.copyFrom(e)}},{key:"worldPosition",get:function(){var e=this._worldPosition;return this._isContainDirtyFlag(4)&&(e._onValueChanged=null,this._getParentTransform()?this.worldMatrix.getTranslation(e):e.copyFrom(this._position),e._onValueChanged=this._onWorldPositionChanged,this._setDirtyFlagFalse(4)),e},set:function(e){this._worldPosition!==e&&this._worldPosition.copyFrom(e)}},{key:"rotation",get:function(){var e=this._rotation;return this._isContainDirtyFlag(1)&&(e._onValueChanged=null,this._rotationQuaternion.toEuler(e),e.scale(k.radToDegreeFactor),e._onValueChanged=this._onRotationChanged,this._setDirtyFlagFalse(1)),e},set:function(e){this._rotation!==e&&this._rotation.copyFrom(e)}},{key:"worldRotation",get:function(){var e=this._worldRotation;return this._isContainDirtyFlag(8)&&(e._onValueChanged=null,this.worldRotationQuaternion.toEuler(e),e.scale(k.radToDegreeFactor),e._onValueChanged=this._onWorldRotationChanged,this._setDirtyFlagFalse(8)),e},set:function(e){this._worldRotation!==e&&this._worldRotation.copyFrom(e)}},{key:"rotationQuaternion",get:function(){var e=this._rotationQuaternion;return this._isContainDirtyFlag(2)&&(e._onValueChanged=null,ye.rotationEuler(k.degreeToRadian(this._rotation.x),k.degreeToRadian(this._rotation.y),k.degreeToRadian(this._rotation.z),e),e._onValueChanged=this._onRotationQuaternionChanged,this._setDirtyFlagFalse(2)),e},set:function(e){this._rotationQuaternion!==e?e.normalized?this._rotationQuaternion.copyFrom(e):ye.normalize(e,this._rotationQuaternion):e.normalized||e.normalize()}},{key:"worldRotationQuaternion",get:function(){var e=this._worldRotationQuaternion;if(this._isContainDirtyFlag(16)){e._onValueChanged=null;var r=this._getParentTransform();r!=null?ye.multiply(r.worldRotationQuaternion,this.rotationQuaternion,e):e.copyFrom(this.rotationQuaternion),e._onValueChanged=this._onWorldRotationQuaternionChanged,this._setDirtyFlagFalse(16)}return e},set:function(e){this._worldRotationQuaternion!==e&&(e.normalized?this._worldRotationQuaternion.copyFrom(e):ye.normalize(e,this._worldRotationQuaternion)),e.normalized||e.normalize()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale!==e&&this._scale.copyFrom(e)}},{key:"lossyWorldScale",get:function(){if(this._isContainDirtyFlag(32)){if(this._getParentTransform()){var e=this._getScaleMatrix(),r=e.elements;this._lossyWorldScale.set(r[0],r[4],r[8])}else this._lossyWorldScale.copyFrom(this._scale);this._setDirtyFlagFalse(32)}return this._lossyWorldScale}},{key:"localMatrix",get:function(){return this._isContainDirtyFlag(64)&&(J.affineTransformation(this._scale,this.rotationQuaternion,this._position,this._localMatrix),this._setDirtyFlagFalse(64)),this._localMatrix},set:function(e){this._localMatrix!==e&&this._localMatrix.copyFrom(e),this._position._onValueChanged=this._rotationQuaternion._onValueChanged=this._scale._onValueChanged=null,this._localMatrix.decompose(this._position,this._rotationQuaternion,this._scale),this._position._onValueChanged=this._onPositionChanged,this._rotationQuaternion._onValueChanged=this._onRotationQuaternionChanged,this._scale._onValueChanged=this._onScaleChanged,this._setDirtyFlagTrue(1),this._setDirtyFlagFalse(66),this._updateAllWorldFlag()}},{key:"worldMatrix",get:function(){if(this._isContainDirtyFlag(128)){var e=this._getParentTransform();e?J.multiply(e.worldMatrix,this.localMatrix,this._worldMatrix):this._worldMatrix.copyFrom(this.localMatrix),this._setDirtyFlagFalse(128)}return this._worldMatrix},set:function(e){this._worldMatrix!==e&&this._worldMatrix.copyFrom(e);var r=this._getParentTransform();r?(J.invert(r.worldMatrix,s._tempMat42),J.multiply(s._tempMat42,e,this._localMatrix)):this._localMatrix.copyFrom(e),this.localMatrix=this._localMatrix,this._setDirtyFlagFalse(128)}},{key:"worldForward",get:function(){var e=this._worldForward||(this._worldForward=new w),r=this.worldMatrix.elements;return e.set(-r[8],-r[9],-r[10]),e.normalize()}},{key:"worldRight",get:function(){var e=this._worldRight||(this._worldRight=new w),r=this.worldMatrix.elements;return e.set(r[0],r[1],r[2]),e.normalize()}},{key:"worldUp",get:function(){var e=this._worldUp||(this._worldUp=new w),r=this.worldMatrix.elements;return e.set(r[4],r[5],r[6]),e.normalize()}}]),s}(Vt);(function(){me._tempQuat0=new ye})();(function(){me._tempVec30=new w})();(function(){me._tempVec31=new w})();(function(){me._tempVec32=new w})();(function(){me._tempMat30=new da})();(function(){me._tempMat31=new da})();(function(){me._tempMat32=new da})();(function(){me._tempMat41=new J})();(function(){me._tempMat42=new J})();R([Z],me.prototype,"_position",void 0);R([Z],me.prototype,"_rotation",void 0);R([Z],me.prototype,"_rotationQuaternion",void 0);R([Z],me.prototype,"_scale",void 0);R([Z],me.prototype,"_worldPosition",void 0);R([Z],me.prototype,"_worldRotation",void 0);R([Z],me.prototype,"_worldRotationQuaternion",void 0);R([Z],me.prototype,"_lossyWorldScale",void 0);R([Z],me.prototype,"_localMatrix",void 0);R([Z],me.prototype,"_worldMatrix",void 0);R([I],me.prototype,"_worldForward",void 0);R([I],me.prototype,"_worldRight",void 0);R([I],me.prototype,"_worldUp",void 0);R([I],me.prototype,"_isParentDirty",void 0);R([I],me.prototype,"_parentTransformCache",void 0);R([I],me.prototype,"_updateFlagManager",void 0);R([I],me.prototype,"_onPositionChanged",null);R([I],me.prototype,"_onWorldPositionChanged",null);R([I],me.prototype,"_onRotationChanged",null);R([I],me.prototype,"_onWorldRotationChanged",null);R([I],me.prototype,"_onRotationQuaternionChanged",null);R([I],me.prototype,"_onWorldRotationQuaternionChanged",null);R([I],me.prototype,"_onScaleChanged",null);var hs;(function(n){n[n.LocalEuler=1]="LocalEuler",n[n.LocalQuat=2]="LocalQuat",n[n.WorldPosition=4]="WorldPosition",n[n.WorldEuler=8]="WorldEuler",n[n.WorldQuat=16]="WorldQuat",n[n.WorldScale=32]="WorldScale",n[n.LocalMatrix=64]="LocalMatrix",n[n.WorldMatrix=128]="WorldMatrix",n[n.WmWp=132]="WmWp",n[n.WmWeWq=152]="WmWeWq",n[n.WmWpWeWq=156]="WmWpWeWq",n[n.WmWs=160]="WmWs",n[n.WmWpWs=164]="WmWpWs",n[n.WmWpWeWqWs=188]="WmWpWeWqWs"})(hs||(hs={}));var Ae;(function(n){n[n.Zero=0]="Zero",n[n.One=1]="One",n[n.SourceColor=2]="SourceColor",n[n.OneMinusSourceColor=3]="OneMinusSourceColor",n[n.DestinationColor=4]="DestinationColor",n[n.OneMinusDestinationColor=5]="OneMinusDestinationColor",n[n.SourceAlpha=6]="SourceAlpha",n[n.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",n[n.DestinationAlpha=8]="DestinationAlpha",n[n.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",n[n.SourceAlphaSaturate=10]="SourceAlphaSaturate",n[n.BlendColor=11]="BlendColor",n[n.OneMinusBlendColor=12]="OneMinusBlendColor"})(Ae||(Ae={}));var Wt;(function(n){n[n.Add=0]="Add",n[n.Subtract=1]="Subtract",n[n.ReverseSubtract=2]="ReverseSubtract",n[n.Min=3]="Min",n[n.Max=4]="Max"})(Wt||(Wt={}));var Er;(function(n){n[n.None=0]="None",n[n.Red=1]="Red",n[n.Green=2]="Green",n[n.Blue=4]="Blue",n[n.Alpha=8]="Alpha",n[n.All=15]="All"})(Er||(Er={}));var Te;(function(n){n[n.Never=0]="Never",n[n.Less=1]="Less",n[n.Equal=2]="Equal",n[n.LessEqual=3]="LessEqual",n[n.Greater=4]="Greater",n[n.NotEqual=5]="NotEqual",n[n.GreaterEqual=6]="GreaterEqual",n[n.Always=7]="Always"})(Te||(Te={}));var Xt;(function(n){n[n.Off=0]="Off",n[n.Front=1]="Front",n[n.Back=2]="Back"})(Xt||(Xt={}));var re;(function(n){n[n.BlendStateEnabled0=0]="BlendStateEnabled0",n[n.BlendStateColorBlendOperation0=1]="BlendStateColorBlendOperation0",n[n.BlendStateAlphaBlendOperation0=2]="BlendStateAlphaBlendOperation0",n[n.BlendStateSourceColorBlendFactor0=3]="BlendStateSourceColorBlendFactor0",n[n.BlendStateSourceAlphaBlendFactor0=4]="BlendStateSourceAlphaBlendFactor0",n[n.BlendStateDestinationColorBlendFactor0=5]="BlendStateDestinationColorBlendFactor0",n[n.BlendStateDestinationAlphaBlendFactor0=6]="BlendStateDestinationAlphaBlendFactor0",n[n.BlendStateColorWriteMask0=7]="BlendStateColorWriteMask0",n[n.BlendStateBlendColor=8]="BlendStateBlendColor",n[n.BlendStateAlphaToCoverage=9]="BlendStateAlphaToCoverage",n[n.DepthStateEnabled=10]="DepthStateEnabled",n[n.DepthStateWriteEnabled=11]="DepthStateWriteEnabled",n[n.DepthStateCompareFunction=12]="DepthStateCompareFunction",n[n.StencilStateEnabled=13]="StencilStateEnabled",n[n.StencilStateReferenceValue=14]="StencilStateReferenceValue",n[n.StencilStateMask=15]="StencilStateMask",n[n.StencilStateWriteMask=16]="StencilStateWriteMask",n[n.StencilStateCompareFunctionFront=17]="StencilStateCompareFunctionFront",n[n.StencilStateCompareFunctionBack=18]="StencilStateCompareFunctionBack",n[n.StencilStatePassOperationFront=19]="StencilStatePassOperationFront",n[n.StencilStatePassOperationBack=20]="StencilStatePassOperationBack",n[n.StencilStateFailOperationFront=21]="StencilStateFailOperationFront",n[n.StencilStateFailOperationBack=22]="StencilStateFailOperationBack",n[n.StencilStateZFailOperationFront=23]="StencilStateZFailOperationFront",n[n.StencilStateZFailOperationBack=24]="StencilStateZFailOperationBack",n[n.RasterStateCullMode=25]="RasterStateCullMode",n[n.RasterStateDepthBias=26]="RasterStateDepthBias",n[n.RasterStateSlopeScaledDepthBias=27]="RasterStateSlopeScaledDepthBias",n[n.RenderQueueType=28]="RenderQueueType"})(re||(re={}));var mt;(function(n){n[n.Opaque=0]="Opaque",n[n.AlphaTest=1]="AlphaTest",n[n.Transparent=2]="Transparent"})(mt||(mt={}));var kt;(function(n){n[n.Float=0]="Float",n[n.Int=1]="Int",n[n.Vector2=2]="Vector2",n[n.Vector3=3]="Vector3",n[n.Vector4=4]="Vector4",n[n.Matrix=5]="Matrix",n[n.Color=6]="Color",n[n.Texture=7]="Texture",n[n.FloatArray=8]="FloatArray",n[n.IntArray=9]="IntArray",n[n.TextureArray=10]="TextureArray"})(kt||(kt={}));var Xe;(function(n){n[n.Keep=0]="Keep",n[n.Zero=1]="Zero",n[n.Replace=2]="Replace",n[n.IncrementSaturate=3]="IncrementSaturate",n[n.DecrementSaturate=4]="DecrementSaturate",n[n.Invert=5]="Invert",n[n.IncrementWrap=6]="IncrementWrap",n[n.DecrementWrap=7]="DecrementWrap"})(Xe||(Xe={}));var ie=function(){function n(s,i,t,e){this.name=s,this._maskIndex=t,this._maskValue=e,this.value=i;var r=n._macroNameIdMap,a=r[s];r[s]===void 0&&(r[s]=a=n._macroNameCounter++),this._nameId=a}return n.getByName=function(i,t){var e=t?i+" "+t:i,r=n._macroMap[e];if(!r){var a=n._macroMaskMap,o=n._macroCounter,l=Math.floor(o/32),c=o%32;r=new n(i,t,l,1<<c),n._macroMap[e]=r,l==a.length&&(a.length++,a[l]=new Array(32)),a[l][c]=e,n._macroCounter++}return r},n._getNamesByMacros=function(i,t){var e=n._macroMaskMap,r=i._mask;t.length=0;for(var a=0,o=i._length;a<o;a++)for(var l=e[a],c=r[a],_=c<0?32:Math.floor(Math.log2(c))+1,u=0;u<_;u++)c&1<<u&&t.push(l[u])},n}();(function(){ie._macroMaskMap=[]})();(function(){ie._macroNameIdMap=Object.create(null)})();(function(){ie._macroNameCounter=0})();(function(){ie._macroCounter=0})();(function(){ie._macroMap=Object.create(null)})();var ar=function(){function n(){this._mask=[],this._length=0}var s=n.prototype;return s.enable=function(t){var e=t._maskIndex,r=e+1,a=this._mask,o=this._length;if(o<r){for(a.length<r&&(a.length=r);o<e;o++)a[o]=0;a[e]=t._maskValue,this._length=r}else a[e]|=t._maskValue},s.disable=function(t){var e=t._maskIndex,r=this._mask,a=this._length-1;if(!(e>a)){var o=r[e]&~t._maskValue;e==a&&o===0?this._length--:r[e]=o}},s.unionCollection=function(t){var e=t._mask,r=t._length,a=this._mask,o=this._length;if(o<r){a.length<r&&(a.length=r);for(var l=0;l<o;l++)a[l]|=e[l];for(;l<r;l++)a[l]=e[l];this._length=r}else for(var c=0;c<r;c++)a[c]|=e[c]},s.complementaryCollection=function(t){for(var e=t._mask,r=this._mask,a=this._length-1,o=Math.min(t._length-1,a);o>=0;o--){var l=r[o]&~e[o];o==a&&l===0?(a--,this._length--):r[o]=l}},s.intersectionCollection=function(t){for(var e=t._mask,r=this._mask,a=this._length-1;a>=0;a--){var o=r[a]&e[a];o==0&&a==this._length-1?this._length--:r[a]=o}},s.isEnable=function(t){var e=t._maskIndex;return e>=this._length?!1:(this._mask[e]&t._maskValue)!==0},s.clear=function(){this._length=0},n.unionCollection=function(t,e,r){var a=r._mask,o,l,c,_;t._length<e._length?(o=t._length,l=e._length,c=t._mask,_=e._mask):(o=e._length,l=t._length,c=e._mask,_=t._mask);var u=0;for(a.length<l&&(a.length=l);u<o;u++)a[u]=c[u]|_[u];for(;u<l;u++)a[u]=_[u];r._length=l},n}(),jt;(function(n){n.DepthOnly="DepthOnly",n.ShadowCaster="ShadowCaster",n.Forward="Forward"})(jt||(jt={}));function po(){return po=Object.assign||function(s){for(var i=1;i<arguments.length;i++){var t=arguments[i];for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(s[e]=t[e])}return s},po.apply(this,arguments)}var i_=`#define GLSLIFY 1
uniform vec3 camera_Position;uniform vec3 camera_Forward;uniform vec4 camera_ProjectionParams;`,o_=`#define GLSLIFY 1
#define PI 3.14159265359
#define RECIPROCAL_PI 0.31830988618
#define EPSILON 1e-6
#define LOG2 1.442695
#define saturate( a ) clamp( a, 0.0, 1.0 )
float pow2(float x){return x*x;}vec4 RGBMToLinear(vec4 value,float maxRange){return vec4(value.rgb*value.a*maxRange,1.0);}vec4 gammaToLinear(vec4 srgbIn){return vec4(pow(srgbIn.rgb,vec3(2.2)),srgbIn.a);}vec4 linearToGamma(vec4 linearIn){return vec4(pow(linearIn.rgb,vec3(1.0/2.2)),linearIn.a);}uniform vec4 camera_DepthBufferParams;float remapDepthBufferLinear01(float z){return 1.0/(camera_DepthBufferParams.x*z+camera_DepthBufferParams.y);}
#ifdef GRAPHICS_API_WEBGL2
#define INVERSE_MAT(mat) inverse(mat)
#else
mat2 inverseMat(mat2 m){return mat2(m[1][1],-m[0][1],-m[1][0],m[0][0])/(m[0][0]*m[1][1]-m[0][1]*m[1][0]);}mat3 inverseMat(mat3 m){float a00=m[0][0],a01=m[0][1],a02=m[0][2];float a10=m[1][0],a11=m[1][1],a12=m[1][2];float a20=m[2][0],a21=m[2][1],a22=m[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}mat4 inverseMat(mat4 m){float a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;return mat4(a11*b11-a12*b10+a13*b09,a02*b10-a01*b11-a03*b09,a31*b05-a32*b04+a33*b03,a22*b04-a21*b05-a23*b03,a12*b08-a10*b11-a13*b07,a00*b11-a02*b08+a03*b07,a32*b02-a30*b05-a33*b01,a20*b05-a22*b02+a23*b01,a10*b10-a11*b08+a13*b06,a01*b08-a00*b10-a03*b06,a30*b04-a31*b02+a33*b00,a21*b02-a20*b04-a23*b00,a11*b07-a10*b09-a12*b06,a00*b09-a01*b07+a02*b06,a31*b01-a30*b03-a32*b00,a20*b03-a21*b01+a22*b00)/det;}
#define INVERSE_MAT(mat) inverseMat(mat)
#endif
`,s_=`#define GLSLIFY 1
attribute vec3 POSITION;
#ifdef RENDERER_HAS_UV
attribute vec2 TEXCOORD_0;
#endif
#ifdef RENDERER_HAS_UV1
attribute vec2 TEXCOORD_1;
#endif
#ifdef RENDERER_HAS_SKIN
attribute vec4 JOINTS_0;attribute vec4 WEIGHTS_0;
#ifdef RENDERER_USE_JOINT_TEXTURE
uniform sampler2D renderer_JointSampler;uniform float renderer_JointCount;mat4 getJointMatrix(sampler2D smp,float index){float base=index/renderer_JointCount;float hf=0.5/renderer_JointCount;float v=base+hf;vec4 m0=texture2D(smp,vec2(0.125,v));vec4 m1=texture2D(smp,vec2(0.375,v));vec4 m2=texture2D(smp,vec2(0.625,v));vec4 m3=texture2D(smp,vec2(0.875,v));return mat4(m0,m1,m2,m3);}
#else
uniform mat4 renderer_JointMatrix[RENDERER_JOINTS_NUM];
#endif
#endif
#ifdef RENDERER_ENABLE_VERTEXCOLOR
attribute vec4 COLOR_0;
#endif
#include <transform_declare>
#include <camera_declare>
uniform vec4 material_TilingOffset;
#ifndef MATERIAL_OMIT_NORMAL
#ifdef RENDERER_HAS_NORMAL
attribute vec3 NORMAL;
#endif
#ifdef RENDERER_HAS_TANGENT
attribute vec4 TANGENT;
#endif
#endif
`,l_=`#define GLSLIFY 1
uniform mat4 renderer_LocalMat;uniform mat4 renderer_ModelMat;uniform mat4 camera_ViewMat;uniform mat4 camera_ProjMat;uniform mat4 renderer_MVMat;uniform mat4 renderer_MVPMat;uniform mat4 renderer_NormalMat;`,c_=`#define GLSLIFY 1
#ifdef RENDERER_ENABLE_VERTEXCOLOR
varying vec4 v_color;
#endif
`,__=`#define GLSLIFY 1
#if SCENE_FOG_MODE != 0
varying vec3 v_positionVS;uniform vec4 scene_FogColor;uniform vec4 scene_FogParams;float ComputeFogIntensity(float fogDepth){
#if SCENE_FOG_MODE == 1
return clamp(fogDepth*scene_FogParams.x+scene_FogParams.y,0.0,1.0);
#elif SCENE_FOG_MODE == 2
return clamp(exp2(-fogDepth*scene_FogParams.z),0.0,1.0);
#elif SCENE_FOG_MODE == 3
float factor=fogDepth*scene_FogParams.w;return clamp(exp2(-factor*factor),0.0,1.0);
#endif
}
#endif
`,u_=`#define GLSLIFY 1
#if SCENE_FOG_MODE != 0
varying vec3 v_positionVS;
#endif
`,d_=`#define GLSLIFY 1
#ifndef MATERIAL_OMIT_NORMAL
#ifdef RENDERER_HAS_NORMAL
varying vec3 v_normal;
#if defined(RENDERER_HAS_TANGENT) && ( defined(MATERIAL_HAS_NORMALTEXTURE) || defined(MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE) || defined(MATERIAL_ENABLE_ANISOTROPY) )
varying mat3 v_TBN;
#endif
#endif
#endif
`,h_=`#define GLSLIFY 1
varying vec2 v_uv;
#ifdef RENDERER_HAS_UV1
varying vec2 v_uv1;
#endif
`,f_=`#define GLSLIFY 1
#ifdef MATERIAL_NEED_WORLD_POS
varying vec3 v_pos;
#endif
`,v_=`#define GLSLIFY 1
#ifndef MATERIAL_OMIT_NORMAL
#ifdef RENDERER_HAS_NORMAL
vec3 normal=vec3(NORMAL);
#endif
#ifdef RENDERER_HAS_TANGENT
vec4 tangent=vec4(TANGENT);
#endif
#endif
`,p_=`#define GLSLIFY 1
vec4 position=vec4(POSITION,1.0);`,g_=`#define GLSLIFY 1
#ifdef RENDERER_HAS_BLENDSHAPE
#ifdef RENDERER_BLENDSHAPE_USE_TEXTURE
uniform mediump sampler2DArray renderer_BlendShapeTexture;uniform ivec3 renderer_BlendShapeTextureInfo;uniform float renderer_BlendShapeWeights[RENDERER_BLENDSHAPE_COUNT];
#else
attribute vec3 POSITION_BS0;attribute vec3 POSITION_BS1;
#if defined( RENDERER_BLENDSHAPE_HAS_NORMAL ) && defined( RENDERER_BLENDSHAPE_HAS_TANGENT )
attribute vec3 NORMAL_BS0;attribute vec3 NORMAL_BS1;attribute vec3 TANGENT_BS0;attribute vec3 TANGENT_BS1;uniform float renderer_BlendShapeWeights[2];
#else
#if defined( RENDERER_BLENDSHAPE_HAS_NORMAL ) || defined( RENDERER_BLENDSHAPE_HAS_TANGENT )
attribute vec3 POSITION_BS2;attribute vec3 POSITION_BS3;
#ifdef RENDERER_BLENDSHAPE_HAS_NORMAL
attribute vec3 NORMAL_BS0;attribute vec3 NORMAL_BS1;attribute vec3 NORMAL_BS2;attribute vec3 NORMAL_BS3;
#endif
#ifdef RENDERER_BLENDSHAPE_HAS_TANGENT
attribute vec3 TANGENT_BS0;attribute vec3 TANGENT_BS1;attribute vec3 TANGENT_BS2;attribute vec3 TANGENT_BS3;
#endif
uniform float renderer_BlendShapeWeights[4];
#else
attribute vec3 POSITION_BS2;attribute vec3 POSITION_BS3;attribute vec3 POSITION_BS4;attribute vec3 POSITION_BS5;attribute vec3 POSITION_BS6;attribute vec3 POSITION_BS7;uniform float renderer_BlendShapeWeights[8];
#endif
#endif
#endif
#ifdef RENDERER_BLENDSHAPE_USE_TEXTURE
vec3 getBlendShapeVertexElement(int blendShapeIndex,int vertexElementIndex){int y=vertexElementIndex/renderer_BlendShapeTextureInfo.y;int x=vertexElementIndex-y*renderer_BlendShapeTextureInfo.y;ivec3 uv=ivec3(x,y,blendShapeIndex);return texelFetch(renderer_BlendShapeTexture,uv,0).xyz;}
#endif
#endif
`,m_=`#define GLSLIFY 1
#ifdef RENDERER_HAS_BLENDSHAPE
#ifdef RENDERER_BLENDSHAPE_USE_TEXTURE
int vertexOffset=gl_VertexID*renderer_BlendShapeTextureInfo.x;for(int i=0;i<RENDERER_BLENDSHAPE_COUNT;i++){int vertexElementOffset=vertexOffset;float weight=renderer_BlendShapeWeights[i];if(weight!=0.0){position.xyz+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;
#ifndef MATERIAL_OMIT_NORMAL
#if defined( RENDERER_HAS_NORMAL ) && defined( RENDERER_BLENDSHAPE_HAS_NORMAL )
vertexElementOffset+=1;normal+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;
#endif
#if defined( RENDERER_HAS_TANGENT ) && defined(RENDERER_BLENDSHAPE_HAS_TANGENT) && ( defined(MATERIAL_HAS_NORMALTEXTURE) || defined(MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE) )
vertexElementOffset+=1;tangent.xyz+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;
#endif
#endif
}}
#else
position.xyz+=POSITION_BS0*renderer_BlendShapeWeights[0];position.xyz+=POSITION_BS1*renderer_BlendShapeWeights[1];
#if defined( RENDERER_BLENDSHAPE_HAS_NORMAL ) && defined( RENDERER_BLENDSHAPE_HAS_TANGENT )
#ifndef MATERIAL_OMIT_NORMAL
#ifdef RENDERER_HAS_NORMAL
normal+=NORMAL_BS0*renderer_BlendShapeWeights[0];normal+=NORMAL_BS1*renderer_BlendShapeWeights[1];
#endif
#if defined( RENDERER_HAS_TANGENT ) && ( defined(MATERIAL_HAS_NORMALTEXTURE) || defined(MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE) )
tangent.xyz+=TANGENT_BS0*renderer_BlendShapeWeights[0];tangent.xyz+=TANGENT_BS1*renderer_BlendShapeWeights[1];
#endif
#endif
#else
#if defined( RENDERER_BLENDSHAPE_HAS_NORMAL ) || defined( RENDERER_BLENDSHAPE_HAS_TANGENT )
#ifndef MATERIAL_OMIT_NORMAL
position.xyz+=POSITION_BS2*renderer_BlendShapeWeights[2];position.xyz+=POSITION_BS3*renderer_BlendShapeWeights[3];
#if defined( RENDERER_BLENDSHAPE_HAS_NORMAL ) && defined( RENDERER_HAS_NORMAL )
normal+=NORMAL_BS0*renderer_BlendShapeWeights[0];normal+=NORMAL_BS1*renderer_BlendShapeWeights[1];normal+=NORMAL_BS2*renderer_BlendShapeWeights[2];normal+=NORMAL_BS3*renderer_BlendShapeWeights[3];
#endif
#if defined(RENDERER_BLENDSHAPE_HAS_TANGENT) && defined( RENDERER_HAS_TANGENT ) && ( defined(MATERIAL_HAS_NORMALTEXTURE) || defined(MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE) )
tangent.xyz+=TANGENT_BS0*renderer_BlendShapeWeights[0];tangent.xyz+=TANGENT_BS1*renderer_BlendShapeWeights[1];tangent.xyz+=TANGENT_BS2*renderer_BlendShapeWeights[2];tangent.xyz+=TANGENT_BS3*renderer_BlendShapeWeights[3];
#endif
#endif
#else
position.xyz+=POSITION_BS2*renderer_BlendShapeWeights[2];position.xyz+=POSITION_BS3*renderer_BlendShapeWeights[3];position.xyz+=POSITION_BS4*renderer_BlendShapeWeights[4];position.xyz+=POSITION_BS5*renderer_BlendShapeWeights[5];position.xyz+=POSITION_BS6*renderer_BlendShapeWeights[6];position.xyz+=POSITION_BS7*renderer_BlendShapeWeights[7];
#endif
#endif
#endif
#endif
`,y_=`#define GLSLIFY 1
#ifdef RENDERER_ENABLE_VERTEXCOLOR
v_color=COLOR_0;
#endif
`,x_=`#define GLSLIFY 1
#if SCENE_FOG_MODE != 0
vec4 positionVS=renderer_MVMat*position;v_positionVS=positionVS.xyz/positionVS.w;
#endif
`,b_=`#define GLSLIFY 1
#ifndef MATERIAL_OMIT_NORMAL
#ifdef RENDERER_HAS_NORMAL
v_normal=normalize(mat3(renderer_NormalMat)*normal);
#if defined(RENDERER_HAS_TANGENT) && ( defined(MATERIAL_HAS_NORMALTEXTURE) || defined(MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE) || defined(MATERIAL_ENABLE_ANISOTROPY) )
vec3 tangentW=normalize(mat3(renderer_NormalMat)*tangent.xyz);vec3 bitangentW=cross(v_normal,tangentW)*tangent.w;v_TBN=mat3(tangentW,bitangentW,v_normal);
#endif
#endif
#endif
`,C_=`#define GLSLIFY 1
gl_Position=renderer_MVPMat*position;`,S_=`#define GLSLIFY 1
#ifdef RENDERER_HAS_SKIN
#ifdef RENDERER_USE_JOINT_TEXTURE
mat4 skinMatrix=WEIGHTS_0.x*getJointMatrix(renderer_JointSampler,JOINTS_0.x)+WEIGHTS_0.y*getJointMatrix(renderer_JointSampler,JOINTS_0.y)+WEIGHTS_0.z*getJointMatrix(renderer_JointSampler,JOINTS_0.z)+WEIGHTS_0.w*getJointMatrix(renderer_JointSampler,JOINTS_0.w);
#else
mat4 skinMatrix=WEIGHTS_0.x*renderer_JointMatrix[int(JOINTS_0.x)]+WEIGHTS_0.y*renderer_JointMatrix[int(JOINTS_0.y)]+WEIGHTS_0.z*renderer_JointMatrix[int(JOINTS_0.z)]+WEIGHTS_0.w*renderer_JointMatrix[int(JOINTS_0.w)];
#endif
position=skinMatrix*position;
#if defined(RENDERER_HAS_NORMAL) && !defined(MATERIAL_OMIT_NORMAL)
mat3 skinNormalMatrix=INVERSE_MAT(mat3(skinMatrix));normal=normal*skinNormalMatrix;
#if defined(RENDERER_HAS_TANGENT) && ( defined(MATERIAL_HAS_NORMALTEXTURE) || defined(MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE) )
tangent.xyz=tangent.xyz*skinNormalMatrix;
#endif
#endif
#endif
`,A_=`#define GLSLIFY 1
#ifdef RENDERER_HAS_UV
v_uv=TEXCOORD_0;
#else
v_uv=vec2(0.,0.);
#endif
#ifdef RENDERER_HAS_UV1
v_uv1=TEXCOORD_1;
#endif
#ifdef MATERIAL_NEED_TILING_OFFSET
v_uv=v_uv*material_TilingOffset.xy+material_TilingOffset.zw;
#endif
`,w_=`#define GLSLIFY 1
#ifdef MATERIAL_NEED_WORLD_POS
vec4 temp_pos=renderer_ModelMat*position;v_pos=temp_pos.xyz/temp_pos.w;
#endif
`,E_=`#define GLSLIFY 1
#if SCENE_FOG_MODE != 0
float fogIntensity=ComputeFogIntensity(length(v_positionVS));gl_FragColor.rgb=mix(scene_FogColor.rgb,gl_FragColor.rgb,fogIntensity);
#endif
`,T_=`#define GLSLIFY 1
#ifdef SCENE_DIRECT_LIGHT_COUNT
struct DirectLight{vec3 color;vec3 direction;};uniform ivec2 scene_DirectLightCullingMask[SCENE_DIRECT_LIGHT_COUNT];uniform vec3 scene_DirectLightColor[SCENE_DIRECT_LIGHT_COUNT];uniform vec3 scene_DirectLightDirection[SCENE_DIRECT_LIGHT_COUNT];
#endif
#ifdef SCENE_POINT_LIGHT_COUNT
struct PointLight{vec3 color;vec3 position;float distance;};uniform ivec2 scene_PointLightCullingMask[SCENE_POINT_LIGHT_COUNT];uniform vec3 scene_PointLightColor[SCENE_POINT_LIGHT_COUNT];uniform vec3 scene_PointLightPosition[SCENE_POINT_LIGHT_COUNT];uniform float scene_PointLightDistance[SCENE_POINT_LIGHT_COUNT];
#endif
#ifdef SCENE_SPOT_LIGHT_COUNT
struct SpotLight{vec3 color;vec3 position;vec3 direction;float distance;float angleCos;float penumbraCos;};uniform ivec2 scene_SpotLightCullingMask[SCENE_SPOT_LIGHT_COUNT];uniform vec3 scene_SpotLightColor[SCENE_SPOT_LIGHT_COUNT];uniform vec3 scene_SpotLightPosition[SCENE_SPOT_LIGHT_COUNT];uniform vec3 scene_SpotLightDirection[SCENE_SPOT_LIGHT_COUNT];uniform float scene_SpotLightDistance[SCENE_SPOT_LIGHT_COUNT];uniform float scene_SpotLightAngleCos[SCENE_SPOT_LIGHT_COUNT];uniform float scene_SpotLightPenumbraCos[SCENE_SPOT_LIGHT_COUNT];
#endif
struct EnvMapLight{vec3 diffuse;float mipMapLevel;float diffuseIntensity;float specularIntensity;};uniform EnvMapLight scene_EnvMapLight;uniform ivec4 renderer_Layer;
#ifdef SCENE_USE_SH
uniform vec3 scene_EnvSH[9];
#endif
#ifdef SCENE_USE_SPECULAR_ENV
uniform samplerCube scene_EnvSpecularSampler;
#endif
#ifndef GRAPHICS_API_WEBGL2
bool isBitSet(float value,float mask,float bitIndex){return mod(floor(value/pow(2.0,bitIndex)),2.0)==1.0&&mod(floor(mask/pow(2.0,bitIndex)),2.0)==1.0;}
#endif
bool isRendererCulledByLight(ivec2 rendererLayer,ivec2 lightCullingMask){
#ifdef GRAPHICS_API_WEBGL2
return!((rendererLayer.x&lightCullingMask.x)!=0||(rendererLayer.y&lightCullingMask.y)!=0);
#else
for(int i=0;i<16;i++){if(isBitSet(float(rendererLayer.x),float(lightCullingMask.x),float(i))||isBitSet(float(rendererLayer.y),float(lightCullingMask.y),float(i))){return false;}}return true;
#endif
}`,R_=`#define GLSLIFY 1
uniform vec4 material_EmissiveColor;uniform vec4 material_BaseColor;uniform vec4 material_SpecularColor;uniform float material_Shininess;uniform float material_NormalIntensity;uniform float material_AlphaCutoff;
#ifdef MATERIAL_HAS_EMISSIVETEXTURE
uniform sampler2D material_EmissiveTexture;
#endif
#ifdef MATERIAL_HAS_BASETEXTURE
uniform sampler2D material_BaseTexture;
#endif
#ifdef MATERIAL_HAS_SPECULAR_TEXTURE
uniform sampler2D material_SpecularTexture;
#endif
#ifdef MATERIAL_HAS_NORMALTEXTURE
uniform sampler2D material_NormalTexture;
#endif
`,M_=`#define GLSLIFY 1
vec4 ambient=vec4(0.0);vec4 emission=material_EmissiveColor;vec4 diffuse=material_BaseColor;vec4 specular=material_SpecularColor;
#ifdef MATERIAL_HAS_EMISSIVETEXTURE
vec4 emissiveTextureColor=texture2D(material_EmissiveTexture,v_uv);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
emissiveTextureColor=gammaToLinear(emissiveTextureColor);
#endif
emission*=emissiveTextureColor;
#endif
#ifdef MATERIAL_HAS_BASETEXTURE
vec4 diffuseTextureColor=texture2D(material_BaseTexture,v_uv);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
diffuseTextureColor=gammaToLinear(diffuseTextureColor);
#endif
diffuse*=diffuseTextureColor;
#endif
#ifdef RENDERER_ENABLE_VERTEXCOLOR
diffuse*=v_color;
#endif
#ifdef MATERIAL_HAS_SPECULAR_TEXTURE
vec4 specularTextureColor=texture2D(material_SpecularTexture,v_uv);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
specularTextureColor=gammaToLinear(specularTextureColor);
#endif
specular*=specularTextureColor;
#endif
ambient=vec4(scene_EnvMapLight.diffuse*scene_EnvMapLight.diffuseIntensity,1.0)*diffuse;`,P_=`#define GLSLIFY 1
#ifdef CAMERA_ORTHOGRAPHIC
vec3 V=-camera_Forward;
#else
#ifdef MATERIAL_NEED_WORLD_POS
vec3 V=normalize(camera_Position-v_pos);
#endif
#endif
`,B_=`#define GLSLIFY 1
#ifdef MATERIAL_HAS_NORMALTEXTURE
mat3 tbn=getTBN(gl_FrontFacing);vec3 N=getNormalByNormalTexture(tbn,material_NormalTexture,material_NormalIntensity,v_uv,gl_FrontFacing);
#else
vec3 N=getNormal(gl_FrontFacing);
#endif
vec3 lightDiffuse=vec3(0.0,0.0,0.0);vec3 lightSpecular=vec3(0.0,0.0,0.0);float shadowAttenuation=1.0;
#ifdef SCENE_DIRECT_LIGHT_COUNT
shadowAttenuation=1.0;
#ifdef SCENE_IS_CALCULATE_SHADOWS
shadowAttenuation*=sampleShadowMap();
#endif
DirectLight directionalLight;for(int i=0;i<SCENE_DIRECT_LIGHT_COUNT;i++){if(!isRendererCulledByLight(renderer_Layer.xy,scene_DirectLightCullingMask[i])){directionalLight.color=scene_DirectLightColor[i];
#ifdef SCENE_IS_CALCULATE_SHADOWS
if(i==0){directionalLight.color*=shadowAttenuation;}
#endif
directionalLight.direction=scene_DirectLightDirection[i];float d=max(dot(N,-directionalLight.direction),0.0);lightDiffuse+=directionalLight.color*d;vec3 halfDir=normalize(V-directionalLight.direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),material_Shininess);lightSpecular+=directionalLight.color*s;}}
#endif
#ifdef SCENE_POINT_LIGHT_COUNT
PointLight pointLight;for(int i=0;i<SCENE_POINT_LIGHT_COUNT;i++){if(!isRendererCulledByLight(renderer_Layer.xy,scene_PointLightCullingMask[i])){pointLight.color=scene_PointLightColor[i];pointLight.position=scene_PointLightPosition[i];pointLight.distance=scene_PointLightDistance[i];vec3 direction=v_pos-pointLight.position;float dist=length(direction);direction/=dist;float decay=clamp(1.0-pow(dist/pointLight.distance,4.0),0.0,1.0);float d=max(dot(N,-direction),0.0)*decay;lightDiffuse+=pointLight.color*d;vec3 halfDir=normalize(V-direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),material_Shininess)*decay;lightSpecular+=pointLight.color*s;}}
#endif
#ifdef SCENE_SPOT_LIGHT_COUNT
SpotLight spotLight;for(int i=0;i<SCENE_SPOT_LIGHT_COUNT;i++){if(!isRendererCulledByLight(renderer_Layer.xy,scene_SpotLightCullingMask[i])){spotLight.color=scene_SpotLightColor[i];spotLight.position=scene_SpotLightPosition[i];spotLight.direction=scene_SpotLightDirection[i];spotLight.distance=scene_SpotLightDistance[i];spotLight.angleCos=scene_SpotLightAngleCos[i];spotLight.penumbraCos=scene_SpotLightPenumbraCos[i];vec3 direction=spotLight.position-v_pos;float lightDistance=length(direction);direction/=lightDistance;float angleCos=dot(direction,-spotLight.direction);float decay=clamp(1.0-pow(lightDistance/spotLight.distance,4.0),0.0,1.0);float spotEffect=smoothstep(spotLight.penumbraCos,spotLight.angleCos,angleCos);float decayTotal=decay*spotEffect;float d=max(dot(N,direction),0.0)*decayTotal;lightDiffuse+=spotLight.color*d;vec3 halfDir=normalize(V+direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),material_Shininess)*decayTotal;lightSpecular+=spotLight.color*s;}}
#endif
diffuse*=vec4(lightDiffuse,1.0);specular*=vec4(lightSpecular,1.0);
#ifdef MATERIAL_IS_ALPHA_CUTOFF
if(diffuse.a<material_AlphaCutoff){discard;}
#endif
`,D_=`#define GLSLIFY 1
#include <noise_cellular_2D>
#include <noise_cellular_3D>
#include <noise_cellular_2x2>
#include <noise_cellular_2x2x2>
`,L_=`#define GLSLIFY 1
vec2 cellular(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec3 oi=vec3(-1.0,0.0,1.0);vec3 of=vec3(-0.5,0.5,1.5);vec3 px=permute(Pi.x+oi);vec3 p=permute(px.x+Pi.y+oi);vec3 ox=fract(p*K)-Ko;vec3 oy=mod7(floor(p*K))*K-Ko;vec3 dx=Pf.x+0.5+jitter*ox;vec3 dy=Pf.y-of+jitter*oy;vec3 d1=dx*dx+dy*dy;p=permute(px.y+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-0.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d2=dx*dx+dy*dy;p=permute(px.z+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-1.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d3=dx*dx+dy*dy;vec3 d1a=min(d1,d2);d2=max(d1,d2);d2=min(d2,d3);d1=min(d1a,d2);d2=max(d1a,d2);d1.xy=(d1.x<d1.y)? d1.xy : d1.yx;d1.xz=(d1.x<d1.z)? d1.xz : d1.zx;d1.yz=min(d1.yz,d2.yz);d1.y=min(d1.y,d1.z);d1.y=min(d1.y,d2.x);return sqrt(d1.xy);}`,V_=`#define GLSLIFY 1
vec2 cellular2x2(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec4 Pfx=Pf.x+vec4(-0.5,-1.5,-0.5,-1.5);vec4 Pfy=Pf.y+vec4(-0.5,-0.5,-1.5,-1.5);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 ox=mod7(p)*K+Kd2;vec4 oy=mod7(floor(p*K))*K+Kd2;vec4 dx=Pfx+jitter1*ox;vec4 dy=Pfy+jitter1*oy;vec4 d=dx*dx+dy*dy;d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.y=min(d.y,d.z);d.y=min(d.y,d.w);return sqrt(d.xy);}`,N_=`#define GLSLIFY 1
vec2 cellular2x2x2(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P);vec4 Pfx=Pf.x+vec4(0.0,-1.0,0.0,-1.0);vec4 Pfy=Pf.y+vec4(0.0,0.0,-1.0,-1.0);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 p1=permute(p+Pi.z);vec4 p2=permute(p+Pi.z+vec4(1.0));vec4 ox1=fract(p1*K)-Ko;vec4 oy1=mod7(floor(p1*K))*K-Ko;vec4 oz1=floor(p1*K2)*Kz-Kzo;vec4 ox2=fract(p2*K)-Ko;vec4 oy2=mod7(floor(p2*K))*K-Ko;vec4 oz2=floor(p2*K2)*Kz-Kzo;vec4 dx1=Pfx+jitter1*ox1;vec4 dy1=Pfy+jitter1*oy1;vec4 dz1=Pf.z+jitter1*oz1;vec4 dx2=Pfx+jitter1*ox2;vec4 dy2=Pfy+jitter1*oy2;vec4 dz2=Pf.z-1.0+jitter1*oz2;vec4 d1=dx1*dx1+dy1*dy1+dz1*dz1;vec4 d2=dx2*dx2+dy2*dy2+dz2*dz2;vec4 d=min(d1,d2);d2=max(d1,d2);d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.yzw=min(d.yzw,d2.yzw);d.y=min(d.y,d.z);d.y=min(d.y,d.w);d.y=min(d.y,d2.x);return sqrt(d.xy);}`,I_=`#define GLSLIFY 1
vec2 cellular(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P)-0.5;vec3 Pfx=Pf.x+vec3(1.0,0.0,-1.0);vec3 Pfy=Pf.y+vec3(1.0,0.0,-1.0);vec3 Pfz=Pf.z+vec3(1.0,0.0,-1.0);vec3 p=permute(Pi.x+vec3(-1.0,0.0,1.0));vec3 p1=permute(p+Pi.y-1.0);vec3 p2=permute(p+Pi.y);vec3 p3=permute(p+Pi.y+1.0);vec3 p11=permute(p1+Pi.z-1.0);vec3 p12=permute(p1+Pi.z);vec3 p13=permute(p1+Pi.z+1.0);vec3 p21=permute(p2+Pi.z-1.0);vec3 p22=permute(p2+Pi.z);vec3 p23=permute(p2+Pi.z+1.0);vec3 p31=permute(p3+Pi.z-1.0);vec3 p32=permute(p3+Pi.z);vec3 p33=permute(p3+Pi.z+1.0);vec3 ox11=fract(p11*K)-Ko;vec3 oy11=mod7(floor(p11*K))*K-Ko;vec3 oz11=floor(p11*K2)*Kz-Kzo;vec3 ox12=fract(p12*K)-Ko;vec3 oy12=mod7(floor(p12*K))*K-Ko;vec3 oz12=floor(p12*K2)*Kz-Kzo;vec3 ox13=fract(p13*K)-Ko;vec3 oy13=mod7(floor(p13*K))*K-Ko;vec3 oz13=floor(p13*K2)*Kz-Kzo;vec3 ox21=fract(p21*K)-Ko;vec3 oy21=mod7(floor(p21*K))*K-Ko;vec3 oz21=floor(p21*K2)*Kz-Kzo;vec3 ox22=fract(p22*K)-Ko;vec3 oy22=mod7(floor(p22*K))*K-Ko;vec3 oz22=floor(p22*K2)*Kz-Kzo;vec3 ox23=fract(p23*K)-Ko;vec3 oy23=mod7(floor(p23*K))*K-Ko;vec3 oz23=floor(p23*K2)*Kz-Kzo;vec3 ox31=fract(p31*K)-Ko;vec3 oy31=mod7(floor(p31*K))*K-Ko;vec3 oz31=floor(p31*K2)*Kz-Kzo;vec3 ox32=fract(p32*K)-Ko;vec3 oy32=mod7(floor(p32*K))*K-Ko;vec3 oz32=floor(p32*K2)*Kz-Kzo;vec3 ox33=fract(p33*K)-Ko;vec3 oy33=mod7(floor(p33*K))*K-Ko;vec3 oz33=floor(p33*K2)*Kz-Kzo;vec3 dx11=Pfx+jitter*ox11;vec3 dy11=Pfy.x+jitter*oy11;vec3 dz11=Pfz.x+jitter*oz11;vec3 dx12=Pfx+jitter*ox12;vec3 dy12=Pfy.x+jitter*oy12;vec3 dz12=Pfz.y+jitter*oz12;vec3 dx13=Pfx+jitter*ox13;vec3 dy13=Pfy.x+jitter*oy13;vec3 dz13=Pfz.z+jitter*oz13;vec3 dx21=Pfx+jitter*ox21;vec3 dy21=Pfy.y+jitter*oy21;vec3 dz21=Pfz.x+jitter*oz21;vec3 dx22=Pfx+jitter*ox22;vec3 dy22=Pfy.y+jitter*oy22;vec3 dz22=Pfz.y+jitter*oz22;vec3 dx23=Pfx+jitter*ox23;vec3 dy23=Pfy.y+jitter*oy23;vec3 dz23=Pfz.z+jitter*oz23;vec3 dx31=Pfx+jitter*ox31;vec3 dy31=Pfy.z+jitter*oy31;vec3 dz31=Pfz.x+jitter*oz31;vec3 dx32=Pfx+jitter*ox32;vec3 dy32=Pfy.z+jitter*oy32;vec3 dz32=Pfz.y+jitter*oz32;vec3 dx33=Pfx+jitter*ox33;vec3 dy33=Pfy.z+jitter*oy33;vec3 dz33=Pfz.z+jitter*oz33;vec3 d11=dx11*dx11+dy11*dy11+dz11*dz11;vec3 d12=dx12*dx12+dy12*dy12+dz12*dz12;vec3 d13=dx13*dx13+dy13*dy13+dz13*dz13;vec3 d21=dx21*dx21+dy21*dy21+dz21*dz21;vec3 d22=dx22*dx22+dy22*dy22+dz22*dz22;vec3 d23=dx23*dx23+dy23*dy23+dz23*dz23;vec3 d31=dx31*dx31+dy31*dy31+dz31*dz31;vec3 d32=dx32*dx32+dy32*dy32+dz32*dz32;vec3 d33=dx33*dx33+dy33*dy33+dz33*dz33;vec3 d1a=min(d11,d12);d12=max(d11,d12);d11=min(d1a,d13);d13=max(d1a,d13);d12=min(d12,d13);vec3 d2a=min(d21,d22);d22=max(d21,d22);d21=min(d2a,d23);d23=max(d2a,d23);d22=min(d22,d23);vec3 d3a=min(d31,d32);d32=max(d31,d32);d31=min(d3a,d33);d33=max(d3a,d33);d32=min(d32,d33);vec3 da=min(d11,d21);d21=max(d11,d21);d11=min(da,d31);d31=max(da,d31);d11.xy=(d11.x<d11.y)? d11.xy : d11.yx;d11.xz=(d11.x<d11.z)? d11.xz : d11.zx;d12=min(d12,d21);d12=min(d12,d22);d12=min(d12,d31);d12=min(d12,d32);d11.yz=min(d11.yz,d12.xy);d11.y=min(d11.y,d12.z);d11.y=min(d11.y,d11.z);return sqrt(d11.xy);}`,F_=`#define GLSLIFY 1
vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec2 mod289(vec2 x){return x-floor(x*(1.0/289.0))*289.0;}float mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod7(vec4 x){return x-floor(x*(1.0/7.0))*7.0;}vec3 mod7(vec3 x){return x-floor(x*(1.0/7.0))*7.0;}vec4 permute(vec4 x){return mod289((34.0*x+1.0)*x);}vec3 permute(vec3 x){return mod289((34.0*x+1.0)*x);}float permute(float x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float taylorInvSqrt(float r){return 1.79284291400159-0.85373472095314*r;}vec4 fade(vec4 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec3 fade(vec3 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec2 fade(vec2 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}
#define K 0.142857142857
#define Ko 0.428571428571
#define K2 0.020408163265306
#define Kd2 0.0714285714285
#define Kz 0.166666666667
#define Kzo 0.416666666667
#define jitter 1.0
#define jitter1 0.8
`,O_=`#define GLSLIFY 1
#include <noise_perlin_2D>
#include <noise_perlin_3D>
#include <noise_perlin_4D>
`,z_=`#define GLSLIFY 1
float perlin(vec2 P){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}float perlin(vec2 P,vec2 rep){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod(Pi,rep.xyxy);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}`,U_=`#define GLSLIFY 1
float perlin(vec3 P){vec3 Pi0=floor(P);vec3 Pi1=Pi0+vec3(1.0);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}float perlin(vec3 P,vec3 rep){vec3 Pi0=mod(floor(P),rep);vec3 Pi1=mod(Pi0+vec3(1.0),rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}`,k_=`#define GLSLIFY 1
float perlin(vec4 P){vec4 Pi0=floor(P);vec4 Pi1=Pi0+1.0;Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}float perlin(vec4 P,vec4 rep){vec4 Pi0=mod(floor(P),rep);vec4 Pi1=mod(Pi0+1.0,rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}`,G_=`#define GLSLIFY 1
vec2 rgrad2(vec2 p,float rot){float u=permute(permute(p.x)+p.y)*0.0243902439+rot;u=fract(u)*6.28318530718;return vec2(cos(u),sin(u));}vec3 psrdnoise(vec2 pos,vec2 per,float rot){pos.y+=0.01;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 psdnoise(vec2 pos,vec2 per){return psrdnoise(pos,per,0.0);}float psrnoise(vec2 pos,vec2 per,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float psnoise(vec2 pos,vec2 per){return psrnoise(pos,per,0.0);}vec3 srdnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 sdnoise(vec2 pos){return srdnoise(pos,0.0);}float srnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float snoise(vec2 pos){return srnoise(pos,0.0);}`,H_=`#define GLSLIFY 1
#include <noise_simplex_2D>
#include <noise_simplex_3D>
#include <noise_simplex_3D_grad>
#include <noise_simplex_4D>
`,W_=`#define GLSLIFY 1
float simplex(vec2 v){const vec4 C=vec4(0.211324865405187,0.366025403784439,-0.577350269189626,0.024390243902439);vec2 i=floor(v+dot(v,C.yy));vec2 x0=v-i+dot(i,C.xx);vec2 i1;i1=(x0.x>x0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec4 x12=x0.xyxy+C.xxzz;x12.xy-=i1;i=mod289(i);vec3 p=permute(permute(i.y+vec3(0.0,i1.y,1.0))+i.x+vec3(0.0,i1.x,1.0));vec3 m=max(0.5-vec3(dot(x0,x0),dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)),0.0);m=m*m;m=m*m;vec3 x=2.0*fract(p*C.www)-1.0;vec3 h=abs(x)-0.5;vec3 ox=floor(x+0.5);vec3 a0=x-ox;m*=1.79284291400159-0.85373472095314*(a0*a0+h*h);vec3 g;g.x=a0.x*x0.x+h.x*x0.y;g.yz=a0.yz*x12.xz+h.yz*x12.yw;return 130.0*dot(m,g);}`,X_=`#define GLSLIFY 1
float simplex(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}`,j_=`#define GLSLIFY 1
float simplex(vec3 v,out vec3 gradient){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);vec4 m2=m*m;vec4 m4=m2*m2;vec4 pdotx=vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3));vec4 temp=m2*m*pdotx;gradient=-8.0*(temp.x*x0+temp.y*x1+temp.z*x2+temp.w*x3);gradient+=m4.x*p0+m4.y*p1+m4.z*p2+m4.w*p3;gradient*=42.0;return 42.0*dot(m4,pdotx);}`,q_=`#define GLSLIFY 1
vec4 grad4(float j,vec4 ip){const vec4 ones=vec4(1.0,1.0,1.0,-1.0);vec4 p,s;p.xyz=floor(fract(vec3(j)*ip.xyz)*7.0)*ip.z-1.0;p.w=1.5-dot(abs(p.xyz),ones.xyz);s=vec4(lessThan(p,vec4(0.0)));p.xyz=p.xyz+(s.xyz*2.0-1.0)*s.www;return p;}
#define F4 0.309016994374947451
float simplex(vec4 v){const vec4 C=vec4(0.138196601125011,0.276393202250021,0.414589803375032,-0.447213595499958);vec4 i=floor(v+dot(v,vec4(F4)));vec4 x0=v-i+dot(i,C.xxxx);vec4 i0;vec3 isX=step(x0.yzw,x0.xxx);vec3 isYZ=step(x0.zww,x0.yyz);i0.x=isX.x+isX.y+isX.z;i0.yzw=1.0-isX;i0.y+=isYZ.x+isYZ.y;i0.zw+=1.0-isYZ.xy;i0.z+=isYZ.z;i0.w+=1.0-isYZ.z;vec4 i3=clamp(i0,0.0,1.0);vec4 i2=clamp(i0-1.0,0.0,1.0);vec4 i1=clamp(i0-2.0,0.0,1.0);vec4 x1=x0-i1+C.xxxx;vec4 x2=x0-i2+C.yyyy;vec4 x3=x0-i3+C.zzzz;vec4 x4=x0+C.wwww;i=mod289(i);float j0=permute(permute(permute(permute(i.w)+i.z)+i.y)+i.x);vec4 j1=permute(permute(permute(permute(i.w+vec4(i1.w,i2.w,i3.w,1.0))+i.z+vec4(i1.z,i2.z,i3.z,1.0))+i.y+vec4(i1.y,i2.y,i3.y,1.0))+i.x+vec4(i1.x,i2.x,i3.x,1.0));vec4 ip=vec4(1.0/294.0,1.0/49.0,1.0/7.0,0.0);vec4 p0=grad4(j0,ip);vec4 p1=grad4(j1.x,ip);vec4 p2=grad4(j1.y,ip);vec4 p3=grad4(j1.z,ip);vec4 p4=grad4(j1.w,ip);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;p4*=taylorInvSqrt(dot(p4,p4));vec3 m0=max(0.6-vec3(dot(x0,x0),dot(x1,x1),dot(x2,x2)),0.0);vec2 m1=max(0.6-vec2(dot(x3,x3),dot(x4,x4)),0.0);m0=m0*m0;m1=m1*m1;return 49.0*(dot(m0*m0,vec3(dot(p0,x0),dot(p1,x1),dot(p2,x2)))+dot(m1*m1,vec2(dot(p3,x3),dot(p4,x4))));}`,Y_=`#define GLSLIFY 1
#define MIN_PERCEPTUAL_ROUGHNESS 0.045
#define MIN_ROUGHNESS 0.002025
uniform float material_AlphaCutoff;uniform vec4 material_BaseColor;uniform float material_Metal;uniform float material_Roughness;uniform float material_IOR;uniform vec3 material_PBRSpecularColor;uniform float material_Glossiness;uniform vec3 material_EmissiveColor;uniform float material_NormalIntensity;uniform float material_OcclusionIntensity;uniform float material_OcclusionTextureCoord;
#ifdef MATERIAL_ENABLE_CLEAR_COAT
uniform float material_ClearCoat;uniform float material_ClearCoatRoughness;
#ifdef MATERIAL_HAS_CLEAR_COAT_TEXTURE
uniform sampler2D material_ClearCoatTexture;
#endif
#ifdef MATERIAL_HAS_CLEAR_COAT_ROUGHNESS_TEXTURE
uniform sampler2D material_ClearCoatRoughnessTexture;
#endif
#ifdef MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE
uniform sampler2D material_ClearCoatNormalTexture;
#endif
#endif
#ifdef MATERIAL_ENABLE_ANISOTROPY
uniform vec3 material_AnisotropyInfo;
#ifdef MATERIAL_HAS_ANISOTROPY_TEXTURE
uniform sampler2D material_AnisotropyTexture;
#endif
#endif
#ifdef MATERIAL_HAS_BASETEXTURE
uniform sampler2D material_BaseTexture;
#endif
#ifdef MATERIAL_HAS_NORMALTEXTURE
uniform sampler2D material_NormalTexture;
#endif
#ifdef MATERIAL_HAS_EMISSIVETEXTURE
uniform sampler2D material_EmissiveTexture;
#endif
#ifdef MATERIAL_HAS_ROUGHNESS_METALLIC_TEXTURE
uniform sampler2D material_RoughnessMetallicTexture;
#endif
#ifdef MATERIAL_HAS_SPECULAR_GLOSSINESS_TEXTURE
uniform sampler2D material_SpecularGlossinessTexture;
#endif
#ifdef MATERIAL_HAS_OCCLUSION_TEXTURE
uniform sampler2D material_OcclusionTexture;
#endif
struct ReflectedLight{vec3 directDiffuse;vec3 directSpecular;vec3 indirectDiffuse;vec3 indirectSpecular;};struct Geometry{vec3 position;vec3 normal;vec3 viewDir;float dotNV;
#ifdef MATERIAL_ENABLE_CLEAR_COAT
vec3 clearCoatNormal;float clearCoatDotNV;
#endif
#ifdef MATERIAL_ENABLE_ANISOTROPY
vec3 anisotropicT;vec3 anisotropicB;vec3 anisotropicN;float anisotropy;
#endif
};struct Material{vec3 diffuseColor;float roughness;vec3 specularColor;float opacity;float f0;
#ifdef MATERIAL_ENABLE_CLEAR_COAT
float clearCoat;float clearCoatRoughness;
#endif
};`,Q_=`#define GLSLIFY 1
#include <normal_get>
float computeSpecularOcclusion(float ambientOcclusion,float roughness,float dotNV){return saturate(pow(dotNV+ambientOcclusion,exp2(-16.0*roughness-1.0))-1.0+ambientOcclusion);}float getAARoughnessFactor(vec3 normal){
#ifdef HAS_DERIVATIVES
vec3 dxy=max(abs(dFdx(normal)),abs(dFdy(normal)));return MIN_PERCEPTUAL_ROUGHNESS+max(max(dxy.x,dxy.y),dxy.z);
#else
return MIN_PERCEPTUAL_ROUGHNESS;
#endif
}
#ifdef MATERIAL_ENABLE_ANISOTROPY
vec3 getAnisotropicBentNormal(Geometry geometry,vec3 n,float roughness){vec3 anisotropyDirection=geometry.anisotropy>=0.0 ? geometry.anisotropicB : geometry.anisotropicT;vec3 anisotropicTangent=cross(anisotropyDirection,geometry.viewDir);vec3 anisotropicNormal=cross(anisotropicTangent,anisotropyDirection);vec3 bentNormal=normalize(mix(n,anisotropicNormal,abs(geometry.anisotropy)*saturate(5.0*roughness)));return bentNormal;}
#endif
void initGeometry(out Geometry geometry,bool isFrontFacing){geometry.position=v_pos;
#ifdef CAMERA_ORTHOGRAPHIC
geometry.viewDir=-camera_Forward;
#else
geometry.viewDir=normalize(camera_Position-v_pos);
#endif
#if defined(MATERIAL_HAS_NORMALTEXTURE) || defined(MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE) || defined(MATERIAL_ENABLE_ANISOTROPY)
mat3 tbn=getTBN(isFrontFacing);
#endif
#ifdef MATERIAL_HAS_NORMALTEXTURE
geometry.normal=getNormalByNormalTexture(tbn,material_NormalTexture,material_NormalIntensity,v_uv,isFrontFacing);
#else
geometry.normal=getNormal(isFrontFacing);
#endif
geometry.dotNV=saturate(dot(geometry.normal,geometry.viewDir));
#ifdef MATERIAL_ENABLE_CLEAR_COAT
#ifdef MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE
geometry.clearCoatNormal=getNormalByNormalTexture(tbn,material_ClearCoatNormalTexture,material_NormalIntensity,v_uv,isFrontFacing);
#else
geometry.clearCoatNormal=getNormal(isFrontFacing);
#endif
geometry.clearCoatDotNV=saturate(dot(geometry.clearCoatNormal,geometry.viewDir));
#endif
#ifdef MATERIAL_ENABLE_ANISOTROPY
float anisotropy=material_AnisotropyInfo.z;vec3 anisotropicDirection=vec3(material_AnisotropyInfo.xy,0.0);
#ifdef MATERIAL_HAS_ANISOTROPY_TEXTURE
vec3 anisotropyTextureInfo=texture2D(material_AnisotropyTexture,v_uv).rgb;anisotropy*=anisotropyTextureInfo.b;anisotropicDirection.xy*=anisotropyTextureInfo.rg*2.0-1.0;
#endif
geometry.anisotropy=anisotropy;geometry.anisotropicT=normalize(tbn*anisotropicDirection);geometry.anisotropicB=normalize(cross(geometry.normal,geometry.anisotropicT));
#endif
}void initMaterial(out Material material,inout Geometry geometry){vec4 baseColor=material_BaseColor;float metal=material_Metal;float roughness=material_Roughness;vec3 specularColor=material_PBRSpecularColor;float glossiness=material_Glossiness;float alphaCutoff=material_AlphaCutoff;float f0=pow2((material_IOR-1.0)/(material_IOR+1.0));material.f0=f0;
#ifdef MATERIAL_HAS_BASETEXTURE
vec4 baseTextureColor=texture2D(material_BaseTexture,v_uv);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
baseTextureColor=gammaToLinear(baseTextureColor);
#endif
baseColor*=baseTextureColor;
#endif
#ifdef RENDERER_ENABLE_VERTEXCOLOR
baseColor*=v_color;
#endif
#ifdef MATERIAL_IS_ALPHA_CUTOFF
if(baseColor.a<alphaCutoff){discard;}
#endif
#ifdef MATERIAL_HAS_ROUGHNESS_METALLIC_TEXTURE
vec4 metalRoughMapColor=texture2D(material_RoughnessMetallicTexture,v_uv);roughness*=metalRoughMapColor.g;metal*=metalRoughMapColor.b;
#endif
#ifdef MATERIAL_HAS_SPECULAR_GLOSSINESS_TEXTURE
vec4 specularGlossinessColor=texture2D(material_SpecularGlossinessTexture,v_uv);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
specularGlossinessColor=gammaToLinear(specularGlossinessColor);
#endif
specularColor*=specularGlossinessColor.rgb;glossiness*=specularGlossinessColor.a;
#endif
#ifdef IS_METALLIC_WORKFLOW
material.diffuseColor=baseColor.rgb*(1.0-metal);material.specularColor=mix(vec3(f0),baseColor.rgb,metal);material.roughness=roughness;
#else
float specularStrength=max(max(specularColor.r,specularColor.g),specularColor.b);material.diffuseColor=baseColor.rgb*(1.0-specularStrength);material.specularColor=specularColor;material.roughness=1.0-glossiness;
#endif
material.roughness=max(material.roughness,getAARoughnessFactor(geometry.normal));
#ifdef MATERIAL_ENABLE_CLEAR_COAT
material.clearCoat=material_ClearCoat;material.clearCoatRoughness=material_ClearCoatRoughness;
#ifdef MATERIAL_HAS_CLEAR_COAT_TEXTURE
material.clearCoat*=texture2D(material_ClearCoatTexture,v_uv).r;
#endif
#ifdef MATERIAL_HAS_CLEAR_COAT_ROUGHNESS_TEXTURE
material.clearCoatRoughness*=texture2D(material_ClearCoatRoughnessTexture,v_uv).g;
#endif
material.clearCoat=saturate(material.clearCoat);material.clearCoatRoughness=max(material.clearCoatRoughness,getAARoughnessFactor(geometry.clearCoatNormal));
#endif
#ifdef MATERIAL_IS_TRANSPARENT
material.opacity=baseColor.a;
#else
material.opacity=1.0;
#endif
#ifdef MATERIAL_ENABLE_ANISOTROPY
geometry.anisotropicN=getAnisotropicBentNormal(geometry,geometry.normal,material.roughness);
#endif
}
#include <brdf>
#include <direct_irradiance_frag_define>
#include <ibl_frag_define>
`,K_=`#define GLSLIFY 1
float F_Schlick(float f0,float dotLH){return f0+0.96*(pow(1.0-dotLH,5.0));}vec3 F_Schlick(vec3 specularColor,float dotLH){float fresnel=exp2((-5.55473*dotLH-6.98316)*dotLH);return(1.0-specularColor)*fresnel+specularColor;}float G_GGX_SmithCorrelated(float alpha,float dotNL,float dotNV){float a2=pow2(alpha);float gv=dotNL*sqrt(a2+(1.0-a2)*pow2(dotNV));float gl=dotNV*sqrt(a2+(1.0-a2)*pow2(dotNL));return 0.5/max(gv+gl,EPSILON);}
#ifdef MATERIAL_ENABLE_ANISOTROPY
float G_GGX_SmithCorrelated_Anisotropic(float at,float ab,float ToV,float BoV,float ToL,float BoL,float NoV,float NoL){float lambdaV=NoL*length(vec3(at*ToV,ab*BoV,NoV));float lambdaL=NoV*length(vec3(at*ToL,ab*BoL,NoL));return 0.5/max(lambdaV+lambdaL,EPSILON);}
#endif
float D_GGX(float alpha,float dotNH){float a2=pow2(alpha);float denom=pow2(dotNH)*(a2-1.0)+1.0;return RECIPROCAL_PI*a2/pow2(denom);}
#ifdef MATERIAL_ENABLE_ANISOTROPY
float D_GGX_Anisotropic(float at,float ab,float ToH,float BoH,float NoH){float a2=at*ab;highp vec3 d=vec3(ab*ToH,at*BoH,a2*NoH);highp float d2=dot(d,d);float b2=a2/d2;return a2*b2*b2*RECIPROCAL_PI;}
#endif
vec3 isotropicLobe(vec3 specularColor,float alpha,float dotNV,float dotNL,float dotNH,float dotLH){vec3 F=F_Schlick(specularColor,dotLH);float D=D_GGX(alpha,dotNH);float G=G_GGX_SmithCorrelated(alpha,dotNL,dotNV);return F*(G*D);}
#ifdef MATERIAL_ENABLE_ANISOTROPY
vec3 anisotropicLobe(vec3 h,vec3 l,Geometry geometry,vec3 specularColor,float alpha,float dotNV,float dotNL,float dotNH,float dotLH){vec3 t=geometry.anisotropicT;vec3 b=geometry.anisotropicB;vec3 v=geometry.viewDir;float dotTV=dot(t,v);float dotBV=dot(b,v);float dotTL=dot(t,l);float dotBL=dot(b,l);float dotTH=dot(t,h);float dotBH=dot(b,h);float at=max(alpha*(1.0+geometry.anisotropy),MIN_ROUGHNESS);float ab=max(alpha*(1.0-geometry.anisotropy),MIN_ROUGHNESS);vec3 F=F_Schlick(specularColor,dotLH);float D=D_GGX_Anisotropic(at,ab,dotTH,dotBH,dotNH);float G=G_GGX_SmithCorrelated_Anisotropic(at,ab,dotTV,dotBV,dotTL,dotBL,dotNV,dotNL);return F*(G*D);}
#endif
vec3 BRDF_Specular_GGX(vec3 incidentDirection,Geometry geometry,vec3 normal,vec3 specularColor,float roughness){float alpha=pow2(roughness);vec3 halfDir=normalize(incidentDirection+geometry.viewDir);float dotNL=saturate(dot(normal,incidentDirection));float dotNV=saturate(dot(normal,geometry.viewDir));float dotNH=saturate(dot(normal,halfDir));float dotLH=saturate(dot(incidentDirection,halfDir));
#ifdef MATERIAL_ENABLE_ANISOTROPY
return anisotropicLobe(halfDir,incidentDirection,geometry,specularColor,alpha,dotNV,dotNL,dotNH,dotLH);
#else
return isotropicLobe(specularColor,alpha,dotNV,dotNL,dotNH,dotLH);
#endif
}vec3 BRDF_Diffuse_Lambert(vec3 diffuseColor){return RECIPROCAL_PI*diffuseColor;}`,J_=`#define GLSLIFY 1
#include <ShadowFragmentDeclaration>
void addDirectRadiance(vec3 incidentDirection,vec3 color,Geometry geometry,Material material,inout ReflectedLight reflectedLight){float attenuation=1.0;
#ifdef MATERIAL_ENABLE_CLEAR_COAT
float clearCoatDotNL=saturate(dot(geometry.clearCoatNormal,incidentDirection));vec3 clearCoatIrradiance=clearCoatDotNL*color;reflectedLight.directSpecular+=material.clearCoat*clearCoatIrradiance*BRDF_Specular_GGX(incidentDirection,geometry,geometry.clearCoatNormal,vec3(0.04),material.clearCoatRoughness);attenuation-=material.clearCoat*F_Schlick(material.f0,geometry.clearCoatDotNV);
#endif
float dotNL=saturate(dot(geometry.normal,incidentDirection));vec3 irradiance=dotNL*color*PI;reflectedLight.directSpecular+=attenuation*irradiance*BRDF_Specular_GGX(incidentDirection,geometry,geometry.normal,material.specularColor,material.roughness);reflectedLight.directDiffuse+=attenuation*irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}
#ifdef SCENE_DIRECT_LIGHT_COUNT
void addDirectionalDirectLightRadiance(DirectLight directionalLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 color=directionalLight.color;vec3 direction=-directionalLight.direction;addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
#ifdef SCENE_POINT_LIGHT_COUNT
void addPointDirectLightRadiance(PointLight pointLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 lVector=pointLight.position-geometry.position;vec3 direction=normalize(lVector);float lightDistance=length(lVector);vec3 color=pointLight.color;color*=clamp(1.0-pow(lightDistance/pointLight.distance,4.0),0.0,1.0);addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
#ifdef SCENE_SPOT_LIGHT_COUNT
void addSpotDirectLightRadiance(SpotLight spotLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 lVector=spotLight.position-geometry.position;vec3 direction=normalize(lVector);float lightDistance=length(lVector);float angleCos=dot(direction,-spotLight.direction);float spotEffect=smoothstep(spotLight.penumbraCos,spotLight.angleCos,angleCos);float decayEffect=clamp(1.0-pow(lightDistance/spotLight.distance,4.0),0.0,1.0);vec3 color=spotLight.color;color*=spotEffect*decayEffect;addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
void addTotalDirectRadiance(Geometry geometry,Material material,inout ReflectedLight reflectedLight){float shadowAttenuation=1.0;
#ifdef SCENE_DIRECT_LIGHT_COUNT
shadowAttenuation=1.0;
#ifdef SCENE_IS_CALCULATE_SHADOWS
shadowAttenuation*=sampleShadowMap();
#endif
DirectLight directionalLight;for(int i=0;i<SCENE_DIRECT_LIGHT_COUNT;i++){if(!isRendererCulledByLight(renderer_Layer.xy,scene_DirectLightCullingMask[i])){directionalLight.color=scene_DirectLightColor[i];
#ifdef SCENE_IS_CALCULATE_SHADOWS
if(i==0){directionalLight.color*=shadowAttenuation;}
#endif
directionalLight.direction=scene_DirectLightDirection[i];addDirectionalDirectLightRadiance(directionalLight,geometry,material,reflectedLight);}}
#endif
#ifdef SCENE_POINT_LIGHT_COUNT
PointLight pointLight;for(int i=0;i<SCENE_POINT_LIGHT_COUNT;i++){if(!isRendererCulledByLight(renderer_Layer.xy,scene_PointLightCullingMask[i])){pointLight.color=scene_PointLightColor[i];pointLight.position=scene_PointLightPosition[i];pointLight.distance=scene_PointLightDistance[i];addPointDirectLightRadiance(pointLight,geometry,material,reflectedLight);}}
#endif
#ifdef SCENE_SPOT_LIGHT_COUNT
SpotLight spotLight;for(int i=0;i<SCENE_SPOT_LIGHT_COUNT;i++){if(!isRendererCulledByLight(renderer_Layer.xy,scene_SpotLightCullingMask[i])){spotLight.color=scene_SpotLightColor[i];spotLight.position=scene_SpotLightPosition[i];spotLight.direction=scene_SpotLightDirection[i];spotLight.distance=scene_SpotLightDistance[i];spotLight.angleCos=scene_SpotLightAngleCos[i];spotLight.penumbraCos=scene_SpotLightPenumbraCos[i];addSpotDirectLightRadiance(spotLight,geometry,material,reflectedLight);}}
#endif
}`,Z_=`#define GLSLIFY 1
vec3 getLightProbeIrradiance(vec3 sh[9],vec3 normal){normal.x=-normal.x;vec3 result=sh[0]+sh[1]*(normal.y)+sh[2]*(normal.z)+sh[3]*(normal.x)+sh[4]*(normal.y*normal.x)+sh[5]*(normal.y*normal.z)+sh[6]*(3.0*normal.z*normal.z-1.0)+sh[7]*(normal.z*normal.x)+sh[8]*(normal.x*normal.x-normal.y*normal.y);return max(result,vec3(0.0));}vec3 envBRDFApprox(vec3 specularColor,float roughness,float dotNV){const vec4 c0=vec4(-1,-0.0275,-0.572,0.022);const vec4 c1=vec4(1,0.0425,1.04,-0.04);vec4 r=roughness*c0+c1;float a004=min(r.x*r.x,exp2(-9.28*dotNV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}float getSpecularMIPLevel(float roughness,int maxMIPLevel){return roughness*float(maxMIPLevel);}vec3 getReflectedVector(Geometry geometry,vec3 n){
#ifdef MATERIAL_ENABLE_ANISOTROPY
vec3 r=reflect(-geometry.viewDir,geometry.anisotropicN);
#else
vec3 r=reflect(-geometry.viewDir,n);
#endif
return r;}vec3 getLightProbeRadiance(Geometry geometry,vec3 normal,float roughness,int maxMIPLevel,float specularIntensity){
#ifndef SCENE_USE_SPECULAR_ENV
return vec3(0);
#else
vec3 reflectVec=getReflectedVector(geometry,normal);reflectVec.x=-reflectVec.x;float specularMIPLevel=getSpecularMIPLevel(roughness,maxMIPLevel);
#ifdef HAS_TEX_LOD
vec4 envMapColor=textureCubeLodEXT(scene_EnvSpecularSampler,reflectVec,specularMIPLevel);
#else
vec4 envMapColor=textureCube(scene_EnvSpecularSampler,reflectVec,specularMIPLevel);
#endif
#ifdef SCENE_IS_DECODE_ENV_RGBM
envMapColor.rgb=RGBMToLinear(envMapColor,5.0).rgb;
#ifdef ENGINE_IS_COLORSPACE_GAMMA
envMapColor=linearToGamma(envMapColor);
#endif
#else
#ifndef ENGINE_IS_COLORSPACE_GAMMA
envMapColor=gammaToLinear(envMapColor);
#endif
#endif
return envMapColor.rgb*specularIntensity;
#endif
}`,$_=`#define GLSLIFY 1
Geometry geometry;Material material;ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));initGeometry(geometry,gl_FrontFacing);initMaterial(material,geometry);addTotalDirectRadiance(geometry,material,reflectedLight);
#ifdef SCENE_USE_SH
vec3 irradiance=getLightProbeIrradiance(scene_EnvSH,geometry.normal);
#ifdef ENGINE_IS_COLORSPACE_GAMMA
irradiance=linearToGamma(vec4(irradiance,1.0)).rgb;
#endif
irradiance*=scene_EnvMapLight.diffuseIntensity;
#else
vec3 irradiance=scene_EnvMapLight.diffuse*scene_EnvMapLight.diffuseIntensity;irradiance*=PI;
#endif
reflectedLight.indirectDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);vec3 radiance=getLightProbeRadiance(geometry,geometry.normal,material.roughness,int(scene_EnvMapLight.mipMapLevel),scene_EnvMapLight.specularIntensity);float radianceAttenuation=1.0;
#ifdef MATERIAL_ENABLE_CLEAR_COAT
vec3 clearCoatRadiance=getLightProbeRadiance(geometry,geometry.clearCoatNormal,material.clearCoatRoughness,int(scene_EnvMapLight.mipMapLevel),scene_EnvMapLight.specularIntensity);reflectedLight.indirectSpecular+=clearCoatRadiance*material.clearCoat*envBRDFApprox(vec3(0.04),material.clearCoatRoughness,geometry.clearCoatDotNV);radianceAttenuation-=material.clearCoat*F_Schlick(material.f0,geometry.clearCoatDotNV);
#endif
reflectedLight.indirectSpecular+=radianceAttenuation*radiance*envBRDFApprox(material.specularColor,material.roughness,geometry.dotNV);
#ifdef MATERIAL_HAS_OCCLUSION_TEXTURE
vec2 aoUV=v_uv;
#ifdef RENDERER_HAS_UV1
if(material_OcclusionTextureCoord==1.0){aoUV=v_uv1;}
#endif
float ambientOcclusion=(texture2D(material_OcclusionTexture,aoUV).r-1.0)*material_OcclusionIntensity+1.0;reflectedLight.indirectDiffuse*=ambientOcclusion;
#ifdef SCENE_USE_SPECULAR_ENV
reflectedLight.indirectSpecular*=computeSpecularOcclusion(ambientOcclusion,material.roughness,geometry.dotNV);
#endif
#endif
vec3 emissiveRadiance=material_EmissiveColor;
#ifdef MATERIAL_HAS_EMISSIVETEXTURE
vec4 emissiveColor=texture2D(material_EmissiveTexture,v_uv);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
emissiveColor=gammaToLinear(emissiveColor);
#endif
emissiveRadiance*=emissiveColor.rgb;
#endif
vec3 totalRadiance=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+emissiveRadiance;vec4 targetColor=vec4(totalRadiance,material.opacity);gl_FragColor=targetColor;`,eu={pbr_frag_define:Y_,pbr_helper:Q_,brdf:K_,direct_irradiance_frag_define:J_,ibl_frag_define:Z_,pbr_frag:$_},tu=`#define GLSLIFY 1
uniform mat4 scene_ShadowMatrices[SCENE_SHADOW_CASCADED_COUNT+1];uniform vec4 scene_ShadowSplitSpheres[4];mediump int computeCascadeIndex(vec3 positionWS){vec3 fromCenter0=positionWS-scene_ShadowSplitSpheres[0].xyz;vec3 fromCenter1=positionWS-scene_ShadowSplitSpheres[1].xyz;vec3 fromCenter2=positionWS-scene_ShadowSplitSpheres[2].xyz;vec3 fromCenter3=positionWS-scene_ShadowSplitSpheres[3].xyz;mediump vec4 comparison=vec4(dot(fromCenter0,fromCenter0)<scene_ShadowSplitSpheres[0].w,dot(fromCenter1,fromCenter1)<scene_ShadowSplitSpheres[1].w,dot(fromCenter2,fromCenter2)<scene_ShadowSplitSpheres[2].w,dot(fromCenter3,fromCenter3)<scene_ShadowSplitSpheres[3].w);comparison.yzw=clamp(comparison.yzw-comparison.xyz,0.0,1.0);mediump vec4 indexCoefficient=vec4(4.0,3.0,2.0,1.0);mediump int index=4-int(dot(comparison,indexCoefficient));return index;}vec3 getShadowCoord(){
#if SCENE_SHADOW_CASCADED_COUNT == 1
mediump int cascadeIndex=0;
#else
mediump int cascadeIndex=computeCascadeIndex(v_pos);
#endif
#ifdef GRAPHICS_API_WEBGL2
mat4 shadowMatrix=scene_ShadowMatrices[cascadeIndex];
#else
mat4 shadowMatrix;
#if SCENE_SHADOW_CASCADED_COUNT == 4
if(cascadeIndex==0){shadowMatrix=scene_ShadowMatrices[0];}else if(cascadeIndex==1){shadowMatrix=scene_ShadowMatrices[1];}else if(cascadeIndex==2){shadowMatrix=scene_ShadowMatrices[2];}else if(cascadeIndex==3){shadowMatrix=scene_ShadowMatrices[3];}else{shadowMatrix=scene_ShadowMatrices[4];}
#endif
#if SCENE_SHADOW_CASCADED_COUNT == 2
if(cascadeIndex==0){shadowMatrix=scene_ShadowMatrices[0];}else if(cascadeIndex==1){shadowMatrix=scene_ShadowMatrices[1];}else{shadowMatrix=scene_ShadowMatrices[2];}
#endif
#if SCENE_SHADOW_CASCADED_COUNT == 1
if(cascadeIndex==0){shadowMatrix=scene_ShadowMatrices[0];}else{shadowMatrix=scene_ShadowMatrices[1];}
#endif
#endif
vec4 shadowCoord=shadowMatrix*vec4(v_pos,1.0);return shadowCoord.xyz;}`,ru=`#define GLSLIFY 1
#if defined(SCENE_SHADOW_TYPE) && defined(RENDERER_IS_RECEIVE_SHADOWS)
#define SCENE_IS_CALCULATE_SHADOWS
#endif
#ifdef SCENE_IS_CALCULATE_SHADOWS
#if SCENE_SHADOW_CASCADED_COUNT == 1
varying vec3 v_shadowCoord;
#else
#include <ShadowCoord>
#endif
uniform vec4 scene_ShadowInfo;uniform vec4 scene_ShadowMapSize;
#ifdef GRAPHICS_API_WEBGL2
uniform mediump sampler2DShadow scene_ShadowMap;
#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) textureLod(textureName, coord3 , 0.0)
#define TEXTURE2D_SHADOW_PARAM(shadowMap) mediump sampler2DShadow shadowMap
#else
uniform sampler2D scene_ShadowMap;
#ifdef ENGINE_NO_DEPTH_TEXTURE
const vec4 bitShift=vec4(1.0,1.0/256.0,1.0/(256.0*256.0),1.0/(256.0*256.0*256.0));float unpack(const in vec4 rgbaDepth){return dot(rgbaDepth,bitShift);}
#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) (unpack(texture2D(textureName, coord3.xy)) < coord3.z ? 0.0 : 1.0)
#else
#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) (texture2D(textureName, coord3.xy).r < coord3.z ? 0.0 : 1.0)
#endif
#define TEXTURE2D_SHADOW_PARAM(shadowMap) mediump sampler2D shadowMap
#endif
#if SCENE_SHADOW_TYPE == 2
float sampleShadowMapFiltered4(TEXTURE2D_SHADOW_PARAM(shadowMap),vec3 shadowCoord,vec4 shadowMapSize){float attenuation;vec4 attenuation4;vec2 offset=shadowMapSize.xy/2.0;vec3 shadowCoord0=shadowCoord+vec3(-offset,0.0);vec3 shadowCoord1=shadowCoord+vec3(offset.x,-offset.y,0.0);vec3 shadowCoord2=shadowCoord+vec3(-offset.x,offset.y,0.0);vec3 shadowCoord3=shadowCoord+vec3(offset,0.0);attenuation4.x=SAMPLE_TEXTURE2D_SHADOW(shadowMap,shadowCoord0);attenuation4.y=SAMPLE_TEXTURE2D_SHADOW(shadowMap,shadowCoord1);attenuation4.z=SAMPLE_TEXTURE2D_SHADOW(shadowMap,shadowCoord2);attenuation4.w=SAMPLE_TEXTURE2D_SHADOW(shadowMap,shadowCoord3);attenuation=dot(attenuation4,vec4(0.25));return attenuation;}
#endif
#if SCENE_SHADOW_TYPE == 3
#include <shadow_sample_tent>
float sampleShadowMapFiltered9(TEXTURE2D_SHADOW_PARAM(shadowMap),vec3 shadowCoord,vec4 shadowmapSize){float attenuation;float fetchesWeights[9];vec2 fetchesUV[9];sampleShadowComputeSamplesTent5x5(shadowmapSize,shadowCoord.xy,fetchesWeights,fetchesUV);attenuation=fetchesWeights[0]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[0].xy,shadowCoord.z));attenuation+=fetchesWeights[1]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[1].xy,shadowCoord.z));attenuation+=fetchesWeights[2]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[2].xy,shadowCoord.z));attenuation+=fetchesWeights[3]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[3].xy,shadowCoord.z));attenuation+=fetchesWeights[4]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[4].xy,shadowCoord.z));attenuation+=fetchesWeights[5]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[5].xy,shadowCoord.z));attenuation+=fetchesWeights[6]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[6].xy,shadowCoord.z));attenuation+=fetchesWeights[7]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[7].xy,shadowCoord.z));attenuation+=fetchesWeights[8]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[8].xy,shadowCoord.z));return attenuation;}
#endif
float getShadowFade(vec3 positionWS){vec3 camToPixel=positionWS-camera_Position;float distanceCamToPixel2=dot(camToPixel,camToPixel);return saturate(distanceCamToPixel2*scene_ShadowInfo.z+scene_ShadowInfo.w);}float sampleShadowMap(){
#if SCENE_SHADOW_CASCADED_COUNT == 1
vec3 shadowCoord=v_shadowCoord;
#else
vec3 shadowCoord=getShadowCoord();
#endif
float attenuation=1.0;if(shadowCoord.z>0.0&&shadowCoord.z<1.0){
#if SCENE_SHADOW_TYPE == 1
attenuation=SAMPLE_TEXTURE2D_SHADOW(scene_ShadowMap,shadowCoord);
#endif
#if SCENE_SHADOW_TYPE == 2
attenuation=sampleShadowMapFiltered4(scene_ShadowMap,shadowCoord,scene_ShadowMapSize);
#endif
#if SCENE_SHADOW_TYPE == 3
attenuation=sampleShadowMapFiltered9(scene_ShadowMap,shadowCoord,scene_ShadowMapSize);
#endif
float shadowFade=getShadowFade(v_pos);attenuation=mix(1.0,mix(attenuation,1.0,shadowFade),scene_ShadowInfo.x);}return attenuation;}
#endif
`,nu=`#define GLSLIFY 1
float sampleShadowGetIRTriangleTexelArea(float triangleHeight){return triangleHeight-0.5;}void sampleShadowGetTexelAreasTent3x3(float offset,out vec4 computedArea,out vec4 computedAreaUncut){float a=offset+0.5;float offsetSquaredHalved=a*a*0.5;computedAreaUncut.x=computedArea.x=offsetSquaredHalved-offset;computedAreaUncut.w=computedArea.w=offsetSquaredHalved;computedAreaUncut.y=sampleShadowGetIRTriangleTexelArea(1.5-offset);float clampedOffsetLeft=min(offset,0.0);float areaOfSmallLeftTriangle=clampedOffsetLeft*clampedOffsetLeft;computedArea.y=computedAreaUncut.y-areaOfSmallLeftTriangle;computedAreaUncut.z=sampleShadowGetIRTriangleTexelArea(1.5+offset);float clampedOffsetRight=max(offset,0.0);float areaOfSmallRightTriangle=clampedOffsetRight*clampedOffsetRight;computedArea.z=computedAreaUncut.z-areaOfSmallRightTriangle;}void sampleShadowGetTexelWeightsTent5x5(float offset,out vec3 texelsWeightsA,out vec3 texelsWeightsB){vec4 areaFrom3texelTriangle;vec4 areaUncutFrom3texelTriangle;sampleShadowGetTexelAreasTent3x3(offset,areaFrom3texelTriangle,areaUncutFrom3texelTriangle);texelsWeightsA.x=0.16*(areaFrom3texelTriangle.x);texelsWeightsA.y=0.16*(areaUncutFrom3texelTriangle.y);texelsWeightsA.z=0.16*(areaFrom3texelTriangle.y+1.0);texelsWeightsB.x=0.16*(areaFrom3texelTriangle.z+1.0);texelsWeightsB.y=0.16*(areaUncutFrom3texelTriangle.z);texelsWeightsB.z=0.16*(areaFrom3texelTriangle.w);}void sampleShadowComputeSamplesTent5x5(vec4 shadowMapTextureTexelSize,vec2 coord,out float fetchesWeights[9],out vec2 fetchesUV[9]){vec2 tentCenterInTexelSpace=coord.xy*shadowMapTextureTexelSize.zw;vec2 centerOfFetchesInTexelSpace=floor(tentCenterInTexelSpace+0.5);vec2 offsetFromTentCenterToCenterOfFetches=tentCenterInTexelSpace-centerOfFetchesInTexelSpace;vec3 texelsWeightsUA,texelsWeightsUB;vec3 texelsWeightsVA,texelsWeightsVB;sampleShadowGetTexelWeightsTent5x5(offsetFromTentCenterToCenterOfFetches.x,texelsWeightsUA,texelsWeightsUB);sampleShadowGetTexelWeightsTent5x5(offsetFromTentCenterToCenterOfFetches.y,texelsWeightsVA,texelsWeightsVB);vec3 fetchesWeightsU=vec3(texelsWeightsUA.xz,texelsWeightsUB.y)+vec3(texelsWeightsUA.y,texelsWeightsUB.xz);vec3 fetchesWeightsV=vec3(texelsWeightsVA.xz,texelsWeightsVB.y)+vec3(texelsWeightsVA.y,texelsWeightsVB.xz);vec3 fetchesOffsetsU=vec3(texelsWeightsUA.y,texelsWeightsUB.xz)/fetchesWeightsU.xyz+vec3(-2.5,-0.5,1.5);vec3 fetchesOffsetsV=vec3(texelsWeightsVA.y,texelsWeightsVB.xz)/fetchesWeightsV.xyz+vec3(-2.5,-0.5,1.5);fetchesOffsetsU*=shadowMapTextureTexelSize.xxx;fetchesOffsetsV*=shadowMapTextureTexelSize.yyy;vec2 bilinearFetchOrigin=centerOfFetchesInTexelSpace*shadowMapTextureTexelSize.xy;fetchesUV[0]=bilinearFetchOrigin+vec2(fetchesOffsetsU.x,fetchesOffsetsV.x);fetchesUV[1]=bilinearFetchOrigin+vec2(fetchesOffsetsU.y,fetchesOffsetsV.x);fetchesUV[2]=bilinearFetchOrigin+vec2(fetchesOffsetsU.z,fetchesOffsetsV.x);fetchesUV[3]=bilinearFetchOrigin+vec2(fetchesOffsetsU.x,fetchesOffsetsV.y);fetchesUV[4]=bilinearFetchOrigin+vec2(fetchesOffsetsU.y,fetchesOffsetsV.y);fetchesUV[5]=bilinearFetchOrigin+vec2(fetchesOffsetsU.z,fetchesOffsetsV.y);fetchesUV[6]=bilinearFetchOrigin+vec2(fetchesOffsetsU.x,fetchesOffsetsV.z);fetchesUV[7]=bilinearFetchOrigin+vec2(fetchesOffsetsU.y,fetchesOffsetsV.z);fetchesUV[8]=bilinearFetchOrigin+vec2(fetchesOffsetsU.z,fetchesOffsetsV.z);fetchesWeights[0]=fetchesWeightsU.x*fetchesWeightsV.x;fetchesWeights[1]=fetchesWeightsU.y*fetchesWeightsV.x;fetchesWeights[2]=fetchesWeightsU.z*fetchesWeightsV.x;fetchesWeights[3]=fetchesWeightsU.x*fetchesWeightsV.y;fetchesWeights[4]=fetchesWeightsU.y*fetchesWeightsV.y;fetchesWeights[5]=fetchesWeightsU.z*fetchesWeightsV.y;fetchesWeights[6]=fetchesWeightsU.x*fetchesWeightsV.z;fetchesWeights[7]=fetchesWeightsU.y*fetchesWeightsV.z;fetchesWeights[8]=fetchesWeightsU.z*fetchesWeightsV.z;}`,au=`#define GLSLIFY 1
#if defined(SCENE_SHADOW_TYPE) && defined(RENDERER_IS_RECEIVE_SHADOWS)
#define SCENE_IS_CALCULATE_SHADOWS
#endif
#ifdef SCENE_IS_CALCULATE_SHADOWS
#if SCENE_SHADOW_CASCADED_COUNT==1
#include <ShadowCoord>
varying vec3 v_shadowCoord;
#endif
#endif
`,iu=`#define GLSLIFY 1
#ifdef SCENE_IS_CALCULATE_SHADOWS
#if SCENE_SHADOW_CASCADED_COUNT == 1
v_shadowCoord=getShadowCoord();
#endif
#endif
`,ou={ShadowCoord:tu,ShadowFragmentDeclaration:ru,shadow_sample_tent:nu,ShadowVertexDeclaration:au,ShadowVertex:iu},su=`#define GLSLIFY 1
vec3 rotationByEuler(in vec3 vector,in vec3 rot){float halfRoll=rot.z*0.5;float halfPitch=rot.x*0.5;float halfYaw=rot.y*0.5;float sinRoll=sin(halfRoll);float cosRoll=cos(halfRoll);float sinPitch=sin(halfPitch);float cosPitch=cos(halfPitch);float sinYaw=sin(halfYaw);float cosYaw=cos(halfYaw);float quaX=(cosYaw*sinPitch*cosRoll)+(sinYaw*cosPitch*sinRoll);float quaY=(sinYaw*cosPitch*cosRoll)-(cosYaw*sinPitch*sinRoll);float quaZ=(cosYaw*cosPitch*sinRoll)-(sinYaw*sinPitch*cosRoll);float quaW=(cosYaw*cosPitch*cosRoll)+(sinYaw*sinPitch*sinRoll);float x=quaX+quaX;float y=quaY+quaY;float z=quaZ+quaZ;float wx=quaW*x;float wy=quaW*y;float wz=quaW*z;float xx=quaX*x;float xy=quaX*y;float xz=quaX*z;float yy=quaY*y;float yz=quaY*z;float zz=quaZ*z;return vec3(((vector.x*((1.0-yy)-zz))+(vector.y*(xy-wz)))+(vector.z*(xz+wy)),((vector.x*(xy+wz))+(vector.y*((1.0-xx)-zz)))+(vector.z*(yz-wx)),((vector.x*(xz-wy))+(vector.y*(yz+wx)))+(vector.z*((1.0-xx)-yy)));}vec3 rotationByAxis(in vec3 vector,in vec3 axis,in float angle){float halfAngle=angle*0.5;float sin=sin(halfAngle);float quaX=axis.x*sin;float quaY=axis.y*sin;float quaZ=axis.z*sin;float quaW=cos(halfAngle);float x=quaX+quaX;float y=quaY+quaY;float z=quaZ+quaZ;float wx=quaW*x;float wy=quaW*y;float wz=quaW*z;float xx=quaX*x;float xy=quaX*y;float xz=quaX*z;float yy=quaY*y;float yz=quaY*z;float zz=quaZ*z;return vec3(((vector.x*((1.0-yy)-zz))+(vector.y*(xy-wz)))+(vector.z*(xz+wy)),((vector.x*(xy+wz))+(vector.y*((1.0-xx)-zz)))+(vector.z*(yz-wx)),((vector.x*(xz-wy))+(vector.y*(yz+wx)))+(vector.z*((1.0-xx)-yy)));}vec3 rotationByQuaternions(in vec3 v,in vec4 q){return v+2.0*cross(q.xyz,cross(q.xyz,v)+q.w*v);}float evaluateParticleCurve(in vec2 keys[4],in float normalizedAge){float value;for(int i=1;i<4;i++){vec2 key=keys[i];float time=key.x;if(time>=normalizedAge){vec2 lastKey=keys[i-1];float lastTime=lastKey.x;float age=(normalizedAge-lastTime)/(time-lastTime);value=mix(lastKey.y,key.y,age);break;}}return value;}float evaluateParticleCurveCumulative(in vec2 keys[4],in float normalizedAge){float cumulativeValue=0.0;for(int i=1;i<4;i++){vec2 key=keys[i];float time=key.x;vec2 lastKey=keys[i-1];float lastValue=lastKey.y;if(time>=normalizedAge){float lastTime=lastKey.x;float offsetTime=normalizedAge-lastTime;float age=offsetTime/(time-lastTime);cumulativeValue+=(lastValue+mix(lastValue,key.y,age))*0.5*offsetTime;break;}else{cumulativeValue+=(lastValue+key.y)*0.5*(time-lastKey.x);}}return cumulativeValue;}`,lu=`#define GLSLIFY 1
#if defined(RENDERER_VOL_CONSTANT) || defined(RENDERER_VOL_CURVE) || defined(RENDERER_VOL_RANDOM_CONSTANT) || defined(RENDERER_VOL_RANDOM_CURVE)
uniform int renderer_VOLSpace;
#if defined(RENDERER_VOL_CONSTANT) || defined(RENDERER_VOL_RANDOM_CONSTANT)
uniform vec3 renderer_VOLMaxConst;
#ifdef RENDERER_VOL_RANDOM_CONSTANT
uniform vec3 renderer_VOLMinConst;
#endif
#endif
#if defined(RENDERER_VOL_CURVE) || defined(RENDERER_VOL_RANDOM_CURVE)
uniform vec2 renderer_VOLMaxGradientX[4];uniform vec2 renderer_VOLMaxGradientY[4];uniform vec2 renderer_VOLMaxGradientZ[4];
#ifdef RENDERER_VOL_RANDOM_CURVE
uniform vec2 renderer_VOLMinGradientX[4];uniform vec2 renderer_VOLMinGradientY[4];uniform vec2 renderer_VOLMinGradientZ[4];
#endif
#endif
#endif
#if defined(RENDERER_VOL_CONSTANT) || defined(RENDERER_VOL_CURVE) || defined(RENDERER_VOL_RANDOM_CONSTANT) || defined(RENDERER_VOL_RANDOM_CURVE)
vec3 computeParticleLifeVelocity(in float normalizedAge){vec3 velocity;
#if defined(RENDERER_VOL_CONSTANT) || defined(RENDERER_VOL_RANDOM_CONSTANT)
velocity=renderer_VOLMaxConst;
#ifdef RENDERER_VOL_RANDOM_CONSTANT
velocity=mix(renderer_VOLMinConst,velocity,vec3(a_Random1.y,a_Random1.z,a_Random1.w));
#endif
#endif
#if defined(RENDERER_VOL_CURVE) || defined(RENDERER_VOL_RANDOM_CURVE)
velocity=vec3(evaluateParticleCurve(renderer_VOLMaxGradientX,normalizedAge),evaluateParticleCurve(renderer_VOLMaxGradientY,normalizedAge),evaluateParticleCurve(renderer_VOLMaxGradientZ,normalizedAge));
#endif
#ifdef RENDERER_VOL_RANDOM_CURVE
velocity=vec3(mix(velocity.x,evaluateParticleCurve(renderer_VOLMinGradientX,normalizedAge),a_Random1.y),mix(velocity.y,evaluateParticleCurve(renderer_VOLMinGradientY,normalizedAge),a_Random1.z),mix(velocity.z,evaluateParticleCurve(renderer_VOLMinGradientZ,normalizedAge),a_Random1.w));
#endif
return velocity;}
#endif
vec3 getStartPosition(vec3 startVelocity,float age,vec3 dragData){vec3 startPosition;float lastTime=min(startVelocity.x/dragData.x,age);startPosition=lastTime*(startVelocity-0.5*dragData*lastTime);return startPosition;}vec3 computeParticlePosition(in vec3 startVelocity,in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation,vec3 dragData){vec3 startPosition=getStartPosition(startVelocity,age,dragData);vec3 lifePosition;
#if defined(RENDERER_VOL_CONSTANT) || defined(RENDERER_VOL_CURVE) || defined(RENDERER_VOL_RANDOM_CONSTANT) || defined(RENDERER_VOL_RANDOM_CURVE)
#if defined(RENDERER_VOL_CONSTANT)|| defined(RENDERER_VOL_RANDOM_CONSTANT)
lifePosition=lifeVelocity*age;
#endif
#if defined(RENDERER_VOL_CURVE) || defined(RENDERER_VOL_RANDOM_CURVE)
lifePosition=vec3(evaluateParticleCurveCumulative(renderer_VOLMaxGradientX,normalizedAge)evaluateParticleCurveCumulative(renderer_VOLMaxGradientY,normalizedAge),evaluateParticleCurveCumulative(renderer_VOLMaxGradientZ,normalizedAge));
#ifdef RENDERER_VOL_RANDOM_CURVE
lifePosition=vec3(mix(evaluateParticleCurveCumulative(renderer_VOLMinGradientX,normalizedAge),lifePosition.x,a_Random1.y),mix(evaluateParticleCurveCumulative(renderer_VOLMinGradientY,normalizedAge),lifePosition.y,a_Random1.z),mix(evaluateParticleCurveCumulative(renderer_VOLMinGradientZ,normalizedAge),lifePosition.z,a_Random1.w));
#endif
lifePosition*=vec3(a_ShapePositionStartLifeTime.w);
#endif
vec3 finalPosition;if(renderer_VOLSpace==0){finalPosition=rotationByQuaternions(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);}else{finalPosition=rotationByQuaternions(a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;}
#else
vec3 finalPosition=rotationByQuaternions(a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);
#endif
if(renderer_SimulationSpace==0){finalPosition=finalPosition+renderer_WorldPosition;}else if(renderer_SimulationSpace==1){finalPosition=finalPosition+a_SimulationWorldPosition;}finalPosition+=0.5*gravityVelocity*age;return finalPosition;}`,cu=`#define GLSLIFY 1
#if defined(RENDERER_ROL_CONSTANT_MODE) || defined(RENDERER_ROL_CURVE_MODE)
#ifdef RENDERER_ROL_CURVE_MODE
uniform vec2 renderer_ROLMaxCurveZ[4];
#ifdef RENDERER_ROL_IS_RANDOM_TWO
uniform vec2 renderer_ROLMinCurveZ[4];
#endif
#else
uniform vec3 renderer_ROLMaxConst;
#ifdef RENDERER_ROL_IS_RANDOM_TWO
uniform vec3 renderer_ROLMinConst;
#endif
#endif
#endif
float computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge){
#if defined(RENDERER_ROL_CONSTANT_MODE) || defined(RENDERER_ROL_CURVE_MODE)
#ifdef RENDERER_ROL_CURVE_MODE
float lifeRotation=evaluateParticleCurveCumulative(renderer_ROLMaxCurveZ,normalizedAge);
#ifdef RENDERER_ROL_IS_RANDOM_TWO
lifeRotation=mix(evaluateParticleCurveCumulative(renderer_ROLMinCurveZ,normalizedAge),lifeRotation,a_Random0.w);
#endif
rotation+=lifeRotation*a_ShapePositionStartLifeTime.w;
#else
float lifeRotation=renderer_ROLMaxConst.z;
#ifdef RENDERER_ROL_IS_RANDOM_TWO
lifeRotation=mix(renderer_ROLMinConst.z,lifeRotation,a_Random0.w);
#endif
rotation+=lifeRotation*age;
#endif
#endif
return rotation;}
#if defined(RENDERER_MODE_MESH) && (defined(ROTATION_OVER_LIFETIME) || defined(ROTATION_OVER_LIFETIME_SEPARATE))
vec3 computeParticleRotationVec3(in vec3 rotation,in float age,in float normalizedAge){
#ifdef ROTATION_OVER_LIFETIME
#ifdef ROTATION_OVER_LIFETIME_CONSTANT
float ageRot=u_ROLAngularVelocityConst*age;rotation+=ageRot;
#endif
#ifdef ROTATION_OVER_LIFETIME_CURVE
rotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);
#endif
#ifdef ROTATION_OVER_LIFETIME_RANDOM_CONSTANTS
float ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;rotation+=ageRot;
#endif
#ifdef ROTATION_OVER_LIFETIME_RANDOM_CURVES
rotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);
#endif
#endif
#ifdef ROTATION_OVER_LIFETIME_SEPARATE
#ifdef ROTATION_OVER_LIFETIME_CONSTANT
vec3 ageRot=u_ROLAngularVelocityConstSeparate*age;rotation+=ageRot;
#endif
#ifdef ROTATION_OVER_LIFETIME_CURVE
rotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));
#endif
#ifdef ROTATION_OVER_LIFETIME_RANDOM_CONSTANTS
vec3 ageRot=mix(u_ROLAngularVelocityConstSeparate,renderer_ROLMaxConst,a_Random0.w)*age;rotation+=ageRot;
#endif
#ifdef ROTATION_OVER_LIFETIME_RANDOM_CURVES
rotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(renderer_ROLMaxCurveX,normalizedAge),a_Random0.w),mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(renderer_ROLMaxCurveY,normalizedAge),a_Random0.w),mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(renderer_ROLMaxCurveZ,normalizedAge),a_Random0.w));
#endif
#endif
return rotation;}
#endif
`,_u=`#define GLSLIFY 1
#ifdef RENDERER_SOL_CURVE_MODE
uniform vec2 renderer_SOLMaxCurveX[4];
#ifdef RENDERER_SOL_IS_SEPARATE
uniform vec2 renderer_SOLMaxCurveY[4];uniform vec2 renderer_SOLMaxCurveZ[4];
#endif
#ifdef RENDERER_SOL_IS_RANDOM_TWO
uniform vec2 renderer_SOLMinCurveX[4];
#ifdef RENDERER_SOL_IS_SEPARATE
uniform vec2 renderer_SOLMinCurveY[4];uniform vec2 renderer_SOLMinCurveZ[4];
#endif
#endif
#endif
vec2 computeParticleSizeBillboard(in vec2 size,in float normalizedAge){
#ifdef RENDERER_SOL_CURVE_MODE
float lifeSizeX=evaluateParticleCurve(renderer_SOLMaxCurveX,normalizedAge);
#ifdef RENDERER_SOL_IS_RANDOM_TWO
lifeSizeX=mix(evaluateParticleCurve(renderer_SOLMinCurveX,normalizedAge),lifeSizeX,a_Random0.z);
#endif
#ifdef RENDERER_SOL_IS_SEPARATE
float lifeSizeY=evaluateParticleCurve(renderer_SOLMaxCurveY,normalizedAge);
#ifdef RENDERER_SOL_IS_RANDOM_TWO
lifeSizeY=mix(evaluateParticleCurve(renderer_SOLMinCurveY,normalizedAge),lifeSizeY,a_Random0.z);
#endif
size*=vec2(lifeSizeX,lifeSizeY);
#else
size*=lifeSizeX;
#endif
#endif
return size;}
#ifdef RENDERER_MODE_MESH
vec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge){
#ifdef RENDERER_SOL_CURVE
size*=evaluateParticleCurve(renderer_SOLMaxCurveX,normalizedAge);
#endif
#ifdef RENDERER_SOL_RANDOM_CURVES
size*=mix(evaluateParticleCurve(renderer_SOLMaxCurveX,normalizedAge),evaluateParticleCurve(u_SOLSizeGradientMax,normalizedAge),a_Random0.z);
#endif
#ifdef RENDERER_SOL_CURVE_SEPARATE
size*=vec3(evaluateParticleCurve(renderer_SOLMinCurveX,normalizedAge),evaluateParticleCurve(renderer_SOLMinCurveY,normalizedAge),evaluateParticleCurve(renderer_SOLMinCurveZ,normalizedAge));
#endif
#ifdef RENDERER_SOL_RANDOM_CURVES_SEPARATE
size*=vec3(mix(evaluateParticleCurve(renderer_SOLMinCurveX,normalizedAge),evaluateParticleCurve(renderer_SOLMaxCurveX,normalizedAge),a_Random0.z),mix(evaluateParticleCurve(renderer_SOLMinCurveY,normalizedAge),evaluateParticleCurve(renderer_SOLMaxCurveY,normalizedAge),a_Random0.z),mix(evaluateParticleCurve(renderer_SOLMinCurveZ,normalizedAge),evaluateParticleCurve(renderer_SOLMaxCurveZ,normalizedAge),a_Random0.z));
#endif
return size;}
#endif
`,uu=`#define GLSLIFY 1
#if defined(RENDERER_COL_GRADIENT) || defined(RENDERER_COL_RANDOM_GRADIENTS)
uniform vec4 renderer_COLMaxGradientColor[4];uniform vec2 renderer_COLMaxGradientAlpha[4];
#ifdef RENDERER_COL_RANDOM_GRADIENTS
uniform vec4 renderer_COLMinGradientColor[4];uniform vec2 renderer_COLMinGradientAlpha[4];
#endif
uniform vec4 renderer_COLGradientKeysMaxTime;
#endif
#if defined(RENDERER_COL_GRADIENT) || defined(RENDERER_COL_RANDOM_GRADIENTS)
vec4 evaluateParticleGradient(in vec4 colorKeys[4],in float colorKeysMaxTime,in vec2 alphaKeys[4],in float alphaKeysMaxTime,in float normalizedAge){vec4 value;float alphaAge=min(normalizedAge,alphaKeysMaxTime);for(int i=0;i<4;i++){vec2 key=alphaKeys[i];float time=key.x;if(alphaAge<=time){if(i==0){value.a=colorKeys[0].y;}else{vec2 lastKey=alphaKeys[i-1];float lastTime=lastKey.x;float age=(alphaAge-lastTime)/(time-lastTime);value.a=mix(lastKey.y,key.y,age);}break;}}float colorAge=min(normalizedAge,colorKeysMaxTime);for(int i=0;i<4;i++){vec4 key=colorKeys[i];float time=key.x;if(colorAge<=time){if(i==0){value.rgb=colorKeys[0].yzw;}else{vec4 lastKey=colorKeys[i-1];float lastTime=lastKey.x;float age=(colorAge-lastTime)/(time-lastTime);value.rgb=mix(lastKey.yzw,key.yzw,age);}break;}}return value;}
#endif
vec4 computeParticleColor(in vec4 color,in float normalizedAge){
#if defined(RENDERER_COL_GRADIENT) || defined(RENDERER_COL_RANDOM_GRADIENTS)
vec4 gradientColor=evaluateParticleGradient(renderer_COLMaxGradientColor,renderer_COLGradientKeysMaxTime.z,renderer_COLMaxGradientAlpha,renderer_COLGradientKeysMaxTime.w,normalizedAge);
#endif
#ifdef RENDERER_COL_RANDOM_GRADIENTS
gradientColor=mix(evaluateParticleGradient(renderer_COLMinGradientColor,renderer_COLGradientKeysMaxTime.x,renderer_COLMinGradientAlpha,renderer_COLGradientKeysMaxTime.y,normalizedAge),gradientColor,a_Random0.y);
#endif
#if defined(RENDERER_COL_GRADIENT) || defined(RENDERER_COL_RANDOM_GRADIENTS)
color*=gradientColor;
#endif
return color;}`,du=`#define GLSLIFY 1
#if defined(RENDERER_TSA_FRAME_CURVE) || defined(RENDERER_TSA_FRAME_RANDOM_CURVES)
uniform float renderer_TSACycles;uniform vec3 renderer_TSATillingParams;uniform vec2 renderer_TSAFrameMaxCurve[4];
#endif
#ifdef RENDERER_TSA_FRAME_RANDOM_CURVES
uniform vec2 renderer_TSAFrameMinCurve[4];
#endif
vec2 computeParticleUV(in vec2 uv,in float normalizedAge){
#if defined(RENDERER_TSA_FRAME_CURVE) || defined(RENDERER_TSA_FRAME_RANDOM_CURVES)
float scaledNormalizedAge=normalizedAge*renderer_TSACycles;float cycleNormalizedAge=scaledNormalizedAge-floor(scaledNormalizedAge);float normalizedFrame=evaluateParticleCurve(renderer_TSAFrameMaxCurve,cycleNormalizedAge);
#ifdef RENDERER_TSA_FRAME_RANDOM_CURVES
normalizedFrame=mix(evaluateParticleCurve(renderer_TSAFrameMinCurve,cycleNormalizedAge),normalizedFrame,a_Random1.x);
#endif
float frame=floor(normalizedFrame*renderer_TSATillingParams.z);float totalULength=frame*renderer_TSATillingParams.x;float floorTotalULength=floor(totalULength);uv.x+=totalULength-floorTotalULength;uv.y+=floorTotalULength*renderer_TSATillingParams.y;
#endif
return uv;}`,hu=`#define GLSLIFY 1
#ifdef RENDERER_MODE_SPHERE_BILLBOARD
vec2 corner=a_CornerTextureCoordinate.xy+renderer_PivotOffset.xy;vec3 sideVector=normalize(cross(camera_Forward,camera_Up));vec3 upVector=normalize(cross(sideVector,camera_Forward));corner*=computeParticleSizeBillboard(a_StartSize.xy,normalizedAge);
#if defined(RENDERER_ROL_CONSTANT_MODE) || defined(RENDERER_ROL_CURVE_MODE)
if(renderer_ThreeDStartRotation){vec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));center+=renderer_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);}else{float rot=computeParticleRotationFloat(a_StartRotation0.x,age,normalizedAge);float c=cos(rot);float s=sin(rot);mat2 rotation=mat2(c,-s,s,c);corner=rotation*corner;center+=renderer_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);}
#else
if(renderer_ThreeDStartRotation){center+=renderer_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);}else{float c=cos(a_StartRotation0.x);float s=sin(a_StartRotation0.x);mat2 rotation=mat2(c,-s,s,c);corner=rotation*corner;center+=renderer_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);}
#endif
#endif
`,fu=`#define GLSLIFY 1
#ifdef RENDERER_MODE_STRETCHED_BILLBOARD
vec2 corner=a_CornerTextureCoordinate.xy+renderer_PivotOffset.xy;vec3 velocity;
#if defined(RENDERER_VOL_CONSTANT) || defined(RENDERER_VOL_CURVE) || defined(RENDERER_VOL_RANDOM_CONSTANT) || defined(RENDERER_VOL_RANDOM_CURVE)
if(renderer_VOLSpace==0){velocity=rotationByQuaternions(renderer_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;}else{velocity=rotationByQuaternions(renderer_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;}
#else
velocity=rotationByQuaternions(renderer_SizeScale*startVelocity,worldRotation)+gravityVelocity;
#endif
vec3 cameraUpVector=normalize(velocity);vec3 direction=normalize(center-camera_Position);vec3 sideVector=normalize(cross(direction,normalize(velocity)));sideVector=renderer_SizeScale.xzy*sideVector;cameraUpVector=length(vec3(renderer_SizeScale.x,0.0,0.0))*cameraUpVector;vec2 size=computeParticleSizeBillboard(a_StartSize.xy,normalizedAge);const mat2 rotationZHalfPI=mat2(0.0,-1.0,1.0,0.0);corner=rotationZHalfPI*corner;corner.y=corner.y-abs(corner.y);float speed=length(velocity);center+=sign(renderer_SizeScale.x)*(sign(renderer_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*renderer_StretchedBillboardSpeedScale+size.y*renderer_StretchedBillboardLengthScale)*corner.y*cameraUpVector);
#endif
`,vu=`#define GLSLIFY 1
#ifdef RENDERER_MODE_VERTICAL_BILLBOARD
vec2 corner=a_CornerTextureCoordinate.xy+renderer_PivotOffset.xy;const vec3 cameraUpVector=vec3(0.0,1.0,0.0);vec3 sideVector=normalize(cross(camera_Forward,cameraUpVector));float rot=computeParticleRotationFloat(a_StartRotation0.x,age,normalizedAge);float c=cos(rot);float s=sin(rot);mat2 rotation=mat2(c,-s,s,c);corner=rotation*corner*cos(0.78539816339744830961566084581988);corner*=computeParticleSizeBillboard(a_StartSize.xy,normalizedAge);center+=renderer_SizeScale.xzy*(corner.x*sideVector+corner.y*cameraUpVector);
#endif
`,pu=`#define GLSLIFY 1
#ifdef RENDERER_MODE_HORIZONTAL_BILLBOARD
vec2 corner=a_CornerTextureCoordinate.xy+renderer_PivotOffset.xy;const vec3 cameraUpVector=vec3(0.0,0.0,1.0);const vec3 sideVector=vec3(-1.0,0.0,0.0);float rot=computeParticleRotationFloat(a_StartRotation0.x,age,normalizedAge);float c=cos(rot);float s=sin(rot);mat2 rotation=mat2(c,-s,s,c);corner=rotation*corner*cos(0.78539816339744830961566084581988);corner*=computeParticleSizeBillboard(a_StartSize.xy,normalizedAge);center+=renderer_SizeScale.xzy*(corner.x*sideVector+corner.y*cameraUpVector);
#endif
`,gu=`#define GLSLIFY 1
#ifdef RENDERER_MODE_MESH
vec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);
#if defined(RENDERER_ROL_CONSTANT_MODE) || defined(RENDERER_ROL_CURVE_MODE)
if(renderer_ThreeDStartRotation){vec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));center+=rotationByQuaternions(renderer_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);}else{
#ifdef RENDERER_ROL_IS_SEPARATE
float angle=computeParticleRotationFloat(a_StartRotation0.x,age,normalizedAge);if(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){center+=(rotationByQuaternions(rotationByAxis(renderer_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));}else{
#ifdef SHAPE
center+=renderer_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));
#else
if(renderer_SimulationSpace==1)center+=rotationByAxis(renderer_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle);else if(renderer_SimulationSpace==0)center+=rotationByQuaternions(renderer_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation);
#endif
}
#endif
#ifdef ROTATION_OVER_LIFETIME_SEPARATE
vec3 angle=computeParticleRotationVec3(vec3(0.0,0.0,-a_StartRotation0.x),age,normalizedAge);center+=(rotationByQuaternions(rotationByEuler(renderer_SizeScale*a_MeshPosition*size,vec3(angle.x,angle.y,angle.z)),worldRotation));
#endif
}
#else
if(renderer_ThreeDStartRotation){center+=rotationByQuaternions(renderer_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);}else{if(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){if(renderer_SimulationSpace==1)center+=rotationByAxis(renderer_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);else if(renderer_SimulationSpace==0)center+=(rotationByQuaternions(renderer_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));}else{
#ifdef SHAPE
if(renderer_SimulationSpace==1)center+=renderer_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);else if(renderer_SimulationSpace==0)center+=rotationByQuaternions(renderer_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);
#else
if(renderer_SimulationSpace==1)center+=rotationByAxis(renderer_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);else if(renderer_SimulationSpace==0)center+=rotationByQuaternions(renderer_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);
#endif
}}
#endif
v_MeshColor=a_MeshColor;
#endif
`,mu={particle_common:su,velocity_over_lifetime_module:lu,rotation_over_lifetime_module:cu,size_over_lifetime_module:_u,color_over_lifetime_module:uu,texture_sheet_animation_module:du,sphere_billboard:hu,stretched_billboard:fu,vertical_billboard:vu,horizontal_billboard:pu,particle_mesh:gu},yu=`#define GLSLIFY 1
vec3 getNormal(bool isFrontFacing){
#ifdef RENDERER_HAS_NORMAL
vec3 normal=normalize(v_normal);
#elif defined(HAS_DERIVATIVES)
vec3 pos_dx=dFdx(v_pos);vec3 pos_dy=dFdy(v_pos);vec3 normal=normalize(cross(pos_dx,pos_dy));normal*=camera_ProjectionParams.x;
#else
vec3 normal=vec3(0,0,1);
#endif
normal*=float(isFrontFacing)*2.0-1.0;return normal;}vec3 getNormalByNormalTexture(mat3 tbn,sampler2D normalTexture,float normalIntensity,vec2 uv,bool isFrontFacing){vec3 normal=texture2D(normalTexture,uv).rgb;normal=normalize(tbn*((2.0*normal-1.0)*vec3(normalIntensity,normalIntensity,1.0)));normal*=float(isFrontFacing)*2.0-1.0;return normal;}mat3 getTBN(bool isFrontFacing){
#if defined(RENDERER_HAS_NORMAL) && defined(RENDERER_HAS_TANGENT) && ( defined(MATERIAL_HAS_NORMALTEXTURE) || defined(MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE) || defined(MATERIAL_ENABLE_ANISOTROPY) )
mat3 tbn=v_TBN;
#else
vec3 normal=getNormal(isFrontFacing);vec3 position=v_pos;vec2 uv=isFrontFacing? v_uv:-v_uv;
#ifdef HAS_DERIVATIVES
vec3 dp1=dFdx(position);vec3 dp2=dFdy(position);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;float denom=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=(denom==0.0)? 0.0 : camera_ProjectionParams.x/sqrt(denom);mat3 tbn=mat3(tangent*invmax,bitangent*invmax,normal);
#else
mat3 tbn=mat3(vec3(0.0),vec3(0.0),normal);
#endif
#endif
return tbn;}`,La=po({common:o_,common_vert:s_,transform_declare:l_,camera_declare:i_,color_share:c_,normal_share:d_,uv_share:h_,worldpos_share:f_,FogVertexDeclaration:u_,FogFragmentDeclaration:__,begin_normal_vert:v_,begin_position_vert:p_,position_vert:C_,color_vert:y_,normal_vert:b_,skinning_vert:S_,blendShape_input:g_,blendShape_vert:m_,uv_vert:A_,worldpos_vert:w_,FogVertex:x_,light_frag_define:T_,mobile_material_frag:R_,FogFragment:E_,begin_mobile_frag:M_,begin_viewdir_frag:P_,mobile_blinnphong_frag:B_,noise_common:F_,noise_cellular_2D:L_,noise_cellular_2x2:V_,noise_cellular_2x2x2:N_,noise_cellular_3D:I_,noise_cellular:D_,noise_perlin_2D:z_,noise_perlin_3D:U_,noise_perlin_4D:k_,noise_perlin:O_,noise_psrd_2D:G_,noise_simplex_2D:W_,noise_simplex_3D_grad:j_,noise_simplex_3D:X_,noise_simplex_4D:q_,noise_simplex:H_},ou,eu,{normal_get:yu},mu),_n=function(){function n(){}return n.parseCustomMacros=function(i){return i.map(function(t){return"#define "+t+`
`}).join("")},n.registerInclude=function(i,t){if(La[i])throw'The "'+i+'" shader include already exist';La[i]=t},n.unRegisterInclude=function(i){delete La[i]},n.parseIncludes=function(i,t){t===void 0&&(t=/^[ \t]*#include +<([\w\d.]+)>/gm);var e=function(a,o){var l=La[o];return l===void 0?(ve.error('Shader slice "'+a.trim()+'" not founded.'),""):n.parseIncludes(l,t)};return i.replace(t,e)},n.convertTo300=function(i,t){if(i=i.replace(/\bvarying\b/g,t?"in":"out"),i=i.replace(/\btexture(2D|Cube)\b/g,"texture"),i=i.replace(/\btexture2DProj\b/g,"textureProj"),t){if(i=i.replace(/\btexture(2D|Cube)LodEXT\b/g,"textureLod"),i=i.replace(/\btexture(2D|Cube)GradEXT\b/g,"textureGrad"),i=i.replace(/\btexture2DProjLodEXT\b/g,"textureProjLod"),i=i.replace(/\btexture2DProjGradEXT\b/g,"textureProjGrad"),i=i.replace(/\bgl_FragDepthEXT\b/g,"gl_FragDepth"),!n._has300Output(i)){var e=/\bgl_FragData\[.+?\]/g.test(i);if(e){i=i.replace(/\bgl_FragColor\b/g,"gl_FragData[0]");var r=i.match(/\bgl_FragData\[.+?\]/g);i=this._replaceMRTShader(i,r)}else i=i.replace(/void\s+?main\s*\(/g,`out vec4 glFragColor;
void main(`),i=i.replace(/\bgl_FragColor\b/g,"glFragColor")}}else i=i.replace(/\battribute\b/g,"in");return i},n._has300Output=function(i){return n._has300OutInFragReg.test(i)},n._replaceMRTShader=function(i,t){for(var e="",r=new Set,a=0;a<t.length;a++){var o=t[a].match(/\bgl_FragData\[(.+?)\]/);r.add(o[1])}return r.forEach(function(l){e+="layout(location="+l+") out vec4 fragOutColor"+l+`;
`}),e+="void main(",i=i.replace(/\bgl_FragData\[(.+?)\]/g,"fragOutColor$1"),i=i.replace(/void\s+?main\s*\(/g,e),i},n}();(function(){_n._shaderExtension=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives","GL_EXT_draw_buffers","GL_EXT_frag_depth"].map(function(n){return"#extension "+n+` : enable
`}).join("")})();(function(){_n._has300OutInFragReg=/\bout\s+(?:\w+\s+)?(?:vec4)\s+(?:\w+)\s*;/})();var vn=function(){function n(s){this.name=s,this._uniqueId=n._nameCounter++}return n.getByName=function(i){var t,e,r=n._nameMap;return(t=r)[e=i]||(t[e]=new n(i))},n}();(function(){vn._nameCounter=0})();(function(){vn._nameMap=Object.create(null)})();var lc=function(){function n(){this._tagsMap=Object.create(null)}var s=n.prototype;return s.setTag=function(t,e){var r=typeof t=="string"?vn.getByName(t):t,a=this._tagsMap;a[r._uniqueId]!==void 0&&ve.warn('The value of tag named "'+r.name+'" is being replaced.'),a[r._uniqueId]=e},s.deleteTag=function(t){delete this._tagsMap[(typeof t=="string"?vn.getByName(t):t)._uniqueId]},s.getTagValue=function(t){return this._tagsMap[typeof t=="string"?vn.getByName(t)._uniqueId:t._uniqueId]},q(n,[{key:"name",get:function(){return this._name}}]),n}(),dr;(function(n){n[n.Linear=0]="Linear",n[n.Gamma=1]="Gamma"})(dr||(dr={}));var xu=function(){function n(i){this.textureUseCompareMode=!1;var t=i._hardwareRenderer;this._rhi=t,this._gl=t.gl,this._colorSpace=i.settings.colorSpace}var s=n.prototype;return s.upload1f=function(t,e){this.cacheValue!==e&&(this._gl.uniform1f(t.location,e),this.cacheValue=e)},s.upload1fv=function(t,e){this._gl.uniform1fv(t.location,e)},s.upload2f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g)&&(this._colorSpace===dr.Linear?this._gl.uniform2f(t.location,j.gammaToLinearSpace(e.r),j.gammaToLinearSpace(e.g)):this._gl.uniform2f(t.location,e.r,e.g),r.x=e.r,r.y=e.g):(r.x!==e.x||r.y!==e.y)&&(this._gl.uniform2f(t.location,e.x,e.y),r.x=e.x,r.y=e.y)},s.upload2fv=function(t,e){this._gl.uniform2fv(t.location,e)},s.upload3f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b)&&(this._colorSpace===dr.Linear?this._gl.uniform3f(t.location,j.gammaToLinearSpace(e.r),j.gammaToLinearSpace(e.g),j.gammaToLinearSpace(e.b)):this._gl.uniform3f(t.location,e.r,e.g,e.b),r.x=e.r,r.y=e.g,r.z=e.b):(r.x!==e.x||r.y!==e.y||r.z!==e.z)&&(this._gl.uniform3f(t.location,e.x,e.y,e.z),r.x=e.x,r.y=e.y,r.z=e.z)},s.upload3fv=function(t,e){this._gl.uniform3fv(t.location,e)},s.upload4f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b||r.w!==e.a)&&(this._colorSpace===dr.Linear?this._gl.uniform4f(t.location,j.gammaToLinearSpace(e.r),j.gammaToLinearSpace(e.g),j.gammaToLinearSpace(e.b),e.a):this._gl.uniform4f(t.location,e.r,e.g,e.b,e.a),r.x=e.r,r.y=e.g,r.z=e.b,r.w=e.a):(r.x!==e.x||r.y!==e.y||r.z!==e.z||r.w!==e.w)&&(this._gl.uniform4f(t.location,e.x,e.y,e.z,e.w),r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w)},s.upload4fv=function(t,e){this._gl.uniform4fv(t.location,e)},s.upload1i=function(t,e){this.cacheValue!==e&&(this._gl.uniform1i(t.location,e),this.cacheValue=e)},s.upload1iv=function(t,e){this._gl.uniform1iv(t.location,e)},s.upload2i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g)&&(this._gl.uniform2i(t.location,e.r,e.g),r.x=e.r,r.y=e.g):(r.x!==e.x||r.y!==e.y)&&(this._gl.uniform2i(t.location,e.x,e.y),r.x=e.x,r.y=e.y)},s.upload2iv=function(t,e){this._gl.uniform2iv(t.location,e)},s.upload3i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b)&&(this._gl.uniform3i(t.location,e.r,e.g,e.b),r.x=e.r,r.y=e.g,r.z=e.b):(r.x!==e.x||r.y!==e.y||r.z!==e.z)&&(this._gl.uniform3i(t.location,e.x,e.y,e.z),r.x=e.x,r.y=e.y,r.z=e.z)},s.upload3iv=function(t,e){this._gl.uniform3iv(t.location,e)},s.upload4i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b||r.w!==e.a)&&(this._gl.uniform4i(t.location,e.r,e.g,e.b,e.a),r.x=e.r,r.y=e.g,r.z=e.b,r.w=e.a):(r.x!==e.x||r.y!==e.y||r.z!==e.z||r.w!==e.w)&&(this._gl.uniform4i(t.location,e.x,e.y,e.z,e.w),r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w)},s.upload4iv=function(t,e){this._gl.uniform4iv(t.location,e)},s.uploadMat4=function(t,e){this._gl.uniformMatrix4fv(t.location,!1,e.elements)},s.uploadMat4v=function(t,e){this._gl.uniformMatrix4fv(t.location,!1,e)},s.uploadTexture=function(t,e){var r=this._rhi;r.activeTexture(t.textureIndex),r.bindTexture(e._platformTexture),e._setUseDepthCompareMode(t.textureUseCompareMode)},s.uploadTextureArray=function(t,e){for(var r=this._rhi,a=t.textureIndex,o=0;o<e.length;o++){var l=e[o];r.activeTexture(a[o]),r.bindTexture(l._platformTexture),l._setUseDepthCompareMode(t.textureUseCompareMode)}},n}(),Ma=function(){this.constUniforms=[],this.textureUniforms=[]},Tr;(function(n){n[n.Scene=0]="Scene",n[n.Camera=1]="Camera",n[n.Renderer=2]="Renderer",n[n.Material=3]="Material"})(Tr||(Tr={}));var cc=function(){function n(i,t,e){this.sceneUniformBlock=new Ma,this.cameraUniformBlock=new Ma,this.rendererUniformBlock=new Ma,this.materialUniformBlock=new Ma,this.otherUniformBlock=new Ma,this._uploadRenderCount=-1,this._uploadSceneId=-1,this._uploadCameraId=-1,this._uploadRendererId=-1,this._uploadMaterialId=-1,this.attributeLocation=Object.create(null),this._activeTextureUint=0,this._engine=i,this._gl=i._hardwareRenderer.gl,this._glProgram=this._createProgram(t,e),this._glProgram?(this._isValid=!0,this._recordLocation()):this._isValid=!1,this.id=n._counter++}var s=n.prototype;return s.uploadAll=function(t,e){this.uploadUniforms(t,e),this.uploadTextures(t,e)},s.uploadUniforms=function(t,e){for(var r=e._propertyValueMap,a=t.constUniforms,o=0,l=a.length;o<l;o++){var c=a[o],_=r[c.propertyId];_!=null&&c.applyFunc(c,_)}},s.uploadTextures=function(t,e){var r=e._propertyValueMap,a=t.textureUniforms;if(a)for(var o=0,l=a.length;o<l;o++){var c=a[o],_=r[c.propertyId];_&&!_.destroyed?c.applyFunc(c,_):c.applyFunc(c,c.textureDefault)}},s.uploadUnGroupTextures=function(){var t=this.otherUniformBlock.textureUniforms;if(t)for(var e=0,r=t.length;e<r;e++){var a=t[e];a.applyFunc(a,a.textureDefault)}},s.groupingOtherUniformBlock=function(){var t=this.otherUniformBlock,e=t.constUniforms,r=t.textureUniforms;e.length>0&&this._groupingSubOtherUniforms(e,!1),r.length>0&&this._groupingSubOtherUniforms(r,!0)},s.bind=function(){var t=this._engine._hardwareRenderer;return t._currentBindShaderProgram!==this?(this._gl.useProgram(this._glProgram),t._currentBindShaderProgram=this,!0):!1},s.destroy=function(){var t=this._gl;this._glProgram&&t.deleteProgram(this._glProgram)},s._groupingSubOtherUniforms=function(t,e){for(var r=t.length-1;r>=0;r--){var a=t[r],o=L._getShaderPropertyGroup(a.name);o!==void 0&&(t.splice(t.indexOf(a),1),this._groupingUniform(a,o,e))}},s._groupingUniform=function(t,e,r){switch(e){case Tr.Scene:r?this.sceneUniformBlock.textureUniforms.push(t):this.sceneUniformBlock.constUniforms.push(t);break;case Tr.Camera:r?this.cameraUniformBlock.textureUniforms.push(t):this.cameraUniformBlock.constUniforms.push(t);break;case Tr.Renderer:r?this.rendererUniformBlock.textureUniforms.push(t):this.rendererUniformBlock.constUniforms.push(t);break;case Tr.Material:r?this.materialUniformBlock.textureUniforms.push(t):this.materialUniformBlock.constUniforms.push(t);break;default:r?this.otherUniformBlock.textureUniforms.push(t):this.otherUniformBlock.constUniforms.push(t)}},s._createProgram=function(t,e){var r=this._gl,a=this._createShader(r.VERTEX_SHADER,t);if(!a)return null;var o=this._createShader(r.FRAGMENT_SHADER,e);if(!o)return null;var l=r.createProgram();return l?(r.attachShader(l,a),r.attachShader(l,o),r.linkProgram(l),r.validateProgram(l),r.deleteShader(a),r.deleteShader(o),ve.isEnabled&&!r.getProgramParameter(l,r.LINK_STATUS)&&!r.isContextLost()?(ve.error(`Could not link WebGL program

`+("Shader error: "+r.getError()+`

`)+("Validate status: "+r.getProgramParameter(l,r.VALIDATE_STATUS)+`

`)+("Program information log: "+r.getProgramInfoLog(l))),r.deleteProgram(l),null):l):(console.warn("Context lost while create program."),null)},s._createShader=function(t,e){var r=this._gl,a=r.createShader(t);return a?(r.shaderSource(a,e),r.compileShader(a),ve.isEnabled&&!r.getShaderParameter(a,r.COMPILE_STATUS)&&!r.isContextLost()?(console.warn(`Could not compile WebGL shader

`+("Shader type: "+(t==r.VERTEX_SHADER?"vertex":"fragment")+`

`)+(`Shader information log:
`+r.getShaderInfoLog(a)+`
`)+(`Shader source:
`+n._addLineNum(e))),r.deleteShader(a),null):a):(console.warn("Context lost while create shader."),null)},s._recordLocation=function(){var t=this,e=this._gl,r=this._glProgram,a=this._getUniformInfos(),o=this._getAttributeInfos();a.forEach(function(l){var c=l.name,_=l.size,u=l.type,d=new xu(t._engine),h=!1,f=!1;c.indexOf("[0]")>0&&(c=c.substr(0,c.length-3),h=!0);var v=e.getUniformLocation(r,c);switch(d.name=c,d.propertyId=L.getByName(c)._uniqueId,d.location=v,u){case e.FLOAT:h?d.applyFunc=d.upload1fv:(d.applyFunc=d.upload1f,d.cacheValue=0);break;case e.FLOAT_VEC2:h?d.applyFunc=d.upload2fv:(d.applyFunc=d.upload2f,d.cacheValue=new $(0,0));break;case e.FLOAT_VEC3:h?d.applyFunc=d.upload3fv:(d.applyFunc=d.upload3f,d.cacheValue=new w(0,0,0));break;case e.FLOAT_VEC4:h?d.applyFunc=d.upload4fv:(d.applyFunc=d.upload4f,d.cacheValue=new ae(0,0,0,0));break;case e.BOOL:case e.INT:h?d.applyFunc=d.upload1iv:(d.applyFunc=d.upload1i,d.cacheValue=0);break;case e.BOOL_VEC2:case e.INT_VEC2:h?d.applyFunc=d.upload2iv:(d.applyFunc=d.upload2i,d.cacheValue=new $(0,0));break;case e.BOOL_VEC3:case e.INT_VEC3:h?d.applyFunc=d.upload3iv:(d.applyFunc=d.upload3i,d.cacheValue=new w(0,0,0));break;case e.BOOL_VEC4:case e.INT_VEC4:h?d.applyFunc=d.upload4iv:(d.applyFunc=d.upload4i,d.cacheValue=new ae(0,0,0));break;case e.FLOAT_MAT4:d.applyFunc=h?d.uploadMat4v:d.uploadMat4;break;case e.SAMPLER_2D:case e.SAMPLER_CUBE:case e.UNSIGNED_INT_SAMPLER_2D:case e.SAMPLER_2D_ARRAY:case e.SAMPLER_2D_SHADOW:var p;switch(u){case e.SAMPLER_2D:p=t._engine._magentaTexture2D;break;case e.SAMPLER_CUBE:p=t._engine._magentaTextureCube;break;case e.UNSIGNED_INT_SAMPLER_2D:p=t._engine._uintMagentaTexture2D;break;case e.SAMPLER_2D_ARRAY:p=t._engine._magentaTexture2DArray;break;case e.SAMPLER_2D_SHADOW:p=t._engine._depthTexture2D,d.textureUseCompareMode=!0;break}if(f=!0,h){for(var g=new Array(_),y=new Int32Array(_),m=new Array(_),x=0;x<_;x++)g[x]=p,y[x]=t._activeTextureUint,m[x]=e.TEXTURE0+t._activeTextureUint++;d.textureDefault=g,d.textureIndex=m,d.applyFunc=d.uploadTextureArray,t.bind(),e.uniform1iv(v,y)}else{var S=e.TEXTURE0+t._activeTextureUint;d.textureDefault=p,d.textureIndex=S,d.applyFunc=d.uploadTexture,t.bind(),e.uniform1i(v,t._activeTextureUint++)}break;default:throw new Error("Unsupported uniform type")}var b=L._getShaderPropertyGroup(c);t._groupingUniform(d,b,f)}),o.forEach(function(l){var c=l.name;t.attributeLocation[c]=e.getAttribLocation(r,c)})},s._getUniformInfos=function(){for(var t=this._gl,e=this._glProgram,r=t.getProgramParameter(e,t.ACTIVE_UNIFORMS),a=new Array(r),o=0;o<r;++o){var l=t.getActiveUniform(e,o);a[o]=l}return a},s._getAttributeInfos=function(){for(var t=this._gl,e=this._glProgram,r=new Array,a=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),o=0;o<a;++o){var l=t.getActiveAttrib(e,o);r[o]=l}return r},n._addLineNum=function(t){var e=t.split(`
`),r=(e.length+1).toString().length+6,a;return e.map(function(o,l){if(a="0:"+(l+1),a.length>=r)return a.substring(0,r)+o;for(var c=0;c<r-a.length;c++)a+=" ";return a+o}).join(`
`)},q(n,[{key:"isValid",get:function(){return this._isValid}}]),n}();(function(){cc._counter=0})();var gt=function(n){W(s,n);function s(t,e,r,a){var o;o=n.call(this)||this,o._shaderPassId=0,o._renderStateDataMap={},o._shaderProgramPools=[],o._shaderPassId=s._shaderPassCounter++,typeof r=="string"?(o._name=t,o._vertexSource=e,o._fragmentSource=r,a=a??{pipelineStage:jt.Forward}):(o._name="Default",o._vertexSource=t,o._fragmentSource=e,a=r??{pipelineStage:jt.Forward});for(var l in a)o.setTag(l,a[l]);return o}var i=s.prototype;return i._getShaderProgram=function(e,r){var a=e._getShaderProgramPool(this),o=a.get(r);if(o)return o;var l=e._hardwareRenderer.isWebGL2,c=[];ie._getNamesByMacros(r,c);var _=_n.parseCustomMacros(c),u=l?"#version 300 es":"#version 100",d=l?"#define GRAPHICS_API_WEBGL2":"#define GRAPHICS_API_WEBGL1",h=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
      precision highp float;
      precision highp int;
    #else
      precision mediump float;
      precision mediump int;
    #endif
    `;e._hardwareRenderer.canIUse(Q.shaderTextureLod)&&(h+=`#define HAS_TEX_LOD
`),e._hardwareRenderer.canIUse(Q.standardDerivatives)&&(h+=`#define HAS_DERIVATIVES
`);var f=" "+u+`
        `+d+`
        `+_+`
      `+_n.parseIncludes(this._vertexSource),v=" "+u+`
        `+d+`
        `+(l?"":_n._shaderExtension)+`
        `+h+`
        `+_+`
      `+_n.parseIncludes(this._fragmentSource);return l&&(f=_n.convertTo300(f),v=_n.convertTo300(v,!0)),o=new cc(e,f,v),a.cache(o),o},i._destroy=function(){for(var e=this._shaderProgramPools,r=0,a=e.length;r<a;r++)e[r]._destroy();e.length=0},s}(lc);(function(){gt._shaderPassCounter=0})();var Si=function(n){W(s,n);function s(i,t,e){var r;r=n.call(this)||this,r._name=i;var a=t.length;if(a<1)throw" count must large than 0.";r._passes=t.slice();for(var o in e)r.setTag(o,e[o]);return r}return q(s,[{key:"passes",get:function(){return this._passes}}]),s}(lc),_c=function(){this.enabled=!1,this.colorBlendOperation=Wt.Add,this.alphaBlendOperation=Wt.Add,this.sourceColorBlendFactor=Ae.One,this.sourceAlphaBlendFactor=Ae.One,this.destinationColorBlendFactor=Ae.Zero,this.destinationAlphaBlendFactor=Ae.Zero,this.colorWriteMask=Er.All},Ki=function(){function n(){this.targetBlendState=new _c,this.blendColor=new j(0,0,0,0),this.alphaToCoverage=!1}var s=n.prototype;return s._applyShaderDataValue=function(t,e){var r=this.targetBlendState,a=t[re.BlendStateEnabled0];if(a!==void 0){var o=e.getFloat(a);r.enabled=o!==void 0?!!o:!1}var l=t[re.BlendStateColorBlendOperation0];if(l!==void 0){var c;r.colorBlendOperation=(c=e.getFloat(l))!=null?c:Wt.Add}var _=t[re.BlendStateAlphaBlendOperation0];if(_!==void 0){var u;r.alphaBlendOperation=(u=e.getFloat(_))!=null?u:Wt.Add}var d=t[re.BlendStateSourceColorBlendFactor0];if(d!==void 0){var h;r.sourceColorBlendFactor=(h=e.getFloat(d))!=null?h:Ae.One}var f=t[re.BlendStateSourceAlphaBlendFactor0];if(f!==void 0){var v;r.sourceAlphaBlendFactor=(v=e.getFloat(f))!=null?v:Ae.One}var p=t[re.BlendStateDestinationColorBlendFactor0];if(p!==void 0){var g;r.destinationColorBlendFactor=(g=e.getFloat(p))!=null?g:Ae.Zero}var y=t[re.BlendStateDestinationAlphaBlendFactor0];if(y!==void 0){var m;r.destinationAlphaBlendFactor=(m=e.getFloat(y))!=null?m:Ae.Zero}var x=t[re.BlendStateColorWriteMask0];if(x!==void 0){var S;r.colorWriteMask=(S=e.getFloat(x))!=null?S:Er.All}var b=t[re.BlendStateBlendColor];if(b!==void 0){var A=e.getColor(b);A!==void 0&&this.blendColor.copyFrom(A)}var C=t[re.BlendStateAlphaToCoverage];if(C!==void 0){var E=e.getFloat(C);this.alphaToCoverage=E!==void 0?!!E:!1}},s._apply=function(t,e){this._platformApply(t,e.blendState)},s._platformApply=function(t,e){var r=t.gl,a=e.targetBlendState,o=this.targetBlendState,l=o.enabled,c=o.colorBlendOperation,_=o.alphaBlendOperation,u=o.sourceColorBlendFactor,d=o.destinationColorBlendFactor,h=o.sourceAlphaBlendFactor,f=o.destinationAlphaBlendFactor,v=o.colorWriteMask;if(l!==a.enabled&&(l?r.enable(r.BLEND):r.disable(r.BLEND),a.enabled=l),l){(u!==a.sourceColorBlendFactor||d!==a.destinationColorBlendFactor||h!==a.sourceAlphaBlendFactor||f!==a.destinationAlphaBlendFactor)&&(r.blendFuncSeparate(n._getGLBlendFactor(t,u),n._getGLBlendFactor(t,d),n._getGLBlendFactor(t,h),n._getGLBlendFactor(t,f)),a.sourceColorBlendFactor=u,a.destinationColorBlendFactor=d,a.sourceAlphaBlendFactor=h,a.destinationAlphaBlendFactor=f),(c!==a.colorBlendOperation||_!==a.alphaBlendOperation)&&(r.blendEquationSeparate(n._getGLBlendOperation(t,c),n._getGLBlendOperation(t,_)),a.colorBlendOperation=c,a.alphaBlendOperation=_);var p=this.blendColor;j.equals(e.blendColor,p)||(r.blendColor(p.r,p.g,p.b,p.a),e.blendColor.copyFrom(p))}v!==a.colorWriteMask&&(r.colorMask((v&Er.Red)!==0,(v&Er.Green)!==0,(v&Er.Blue)!==0,(v&Er.Alpha)!==0),a.colorWriteMask=v);var g=this.alphaToCoverage;g!==e.alphaToCoverage&&(g?r.enable(r.SAMPLE_ALPHA_TO_COVERAGE):r.disable(r.SAMPLE_ALPHA_TO_COVERAGE),e.alphaToCoverage=g)},n._getGLBlendFactor=function(t,e){var r=t.gl;switch(e){case Ae.Zero:return r.ZERO;case Ae.One:return r.ONE;case Ae.SourceColor:return r.SRC_COLOR;case Ae.OneMinusSourceColor:return r.ONE_MINUS_SRC_COLOR;case Ae.DestinationColor:return r.DST_COLOR;case Ae.OneMinusDestinationColor:return r.ONE_MINUS_DST_COLOR;case Ae.SourceAlpha:return r.SRC_ALPHA;case Ae.OneMinusSourceAlpha:return r.ONE_MINUS_SRC_ALPHA;case Ae.DestinationAlpha:return r.DST_ALPHA;case Ae.OneMinusDestinationAlpha:return r.ONE_MINUS_DST_ALPHA;case Ae.SourceAlphaSaturate:return r.SRC_ALPHA_SATURATE;case Ae.BlendColor:return r.CONSTANT_COLOR;case Ae.OneMinusBlendColor:return r.ONE_MINUS_CONSTANT_COLOR}},n._getGLBlendOperation=function(t,e){var r=t.gl;switch(e){case Wt.Add:return r.FUNC_ADD;case Wt.Subtract:return r.FUNC_SUBTRACT;case Wt.ReverseSubtract:return r.FUNC_REVERSE_SUBTRACT;case Wt.Min:if(!t.canIUse(Q.blendMinMax))throw new Error("BlendOperation.Min is not supported in this context");return r.MIN;case Wt.Max:if(!t.canIUse(Q.blendMinMax))throw new Error("BlendOperation.Max is not supported in this context");return r.MAX}},n}();R([Z],Ki.prototype,"targetBlendState",void 0);R([Z],Ki.prototype,"blendColor",void 0);var uc=function(){function n(){this.enabled=!0,this.compareFunction=Te.Less,this.writeEnabled=!0}var s=n.prototype;return s._applyShaderDataValue=function(t,e){var r=t[re.DepthStateEnabled];if(r!==void 0){var a=e.getFloat(r);this.enabled=a!==void 0?!!a:!1}var o=t[re.DepthStateWriteEnabled];if(o!==void 0){var l=e.getFloat(o);this.writeEnabled=l!==void 0?!!l:!1}var c=t[re.DepthStateCompareFunction];if(c!==void 0){var _;this.compareFunction=(_=e.getFloat(c))!=null?_:Te.Less}},s._apply=function(t,e){this._platformApply(t,e.depthState)},s._platformApply=function(t,e){var r=t.gl,a=this,o=a.enabled,l=a.compareFunction,c=a.writeEnabled;o!=e.enabled&&(o?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),e.enabled=o),o&&l!=e.compareFunction&&(r.depthFunc(n._getGLCompareFunction(t,l)),e.compareFunction=l),c!=e.writeEnabled&&(r.depthMask(c),e.writeEnabled=c)},n._getGLCompareFunction=function(t,e){var r=t.gl;switch(e){case Te.Never:return r.NEVER;case Te.Less:return r.LESS;case Te.Equal:return r.EQUAL;case Te.LessEqual:return r.LEQUAL;case Te.Greater:return r.GREATER;case Te.NotEqual:return r.NOTEQUAL;case Te.GreaterEqual:return r.GEQUAL;case Te.Always:return r.ALWAYS}},n}(),dc=function(){function n(){this.cullMode=Xt.Back,this.depthBias=0,this.slopeScaledDepthBias=0,this._cullFaceEnable=!0,this._frontFaceInvert=!1}var s=n.prototype;return s._applyShaderDataValue=function(t,e){var r=t[re.RasterStateCullMode];if(r!==void 0){var a;this.cullMode=(a=e.getFloat(r))!=null?a:Xt.Back}var o=t[re.RasterStateDepthBias];if(o!==void 0){var l;this.depthBias=(l=e.getFloat(o))!=null?l:0}var c=t[re.RasterStateSlopeScaledDepthBias];if(c!==void 0){var _;this.slopeScaledDepthBias=(_=e.getFloat(c))!=null?_:0}},s._apply=function(t,e,r){this._platformApply(t,e.rasterState,r)},s._platformApply=function(t,e,r){var a=t.gl,o=this,l=o.cullMode,c=o.depthBias,_=o.slopeScaledDepthBias,u=l!==Xt.Off;u!==e._cullFaceEnable&&(u?a.enable(a.CULL_FACE):a.disable(a.CULL_FACE),e._cullFaceEnable=u),u&&l!==e.cullMode&&(l==Xt.Back?a.cullFace(a.BACK):a.cullFace(a.FRONT),e.cullMode=l),r!==e._frontFaceInvert&&(r?a.frontFace(a.CW):a.frontFace(a.CCW),e._frontFaceInvert=r),t._enableGlobalDepthBias||(c!==e.depthBias||_!==e.slopeScaledDepthBias)&&(c!==0||_!==0?(a.enable(a.POLYGON_OFFSET_FILL),a.polygonOffset(_,c)):a.disable(a.POLYGON_OFFSET_FILL),e.depthBias=c,e.slopeScaledDepthBias=_)},n}(),hc=function(){function n(){this.enabled=!1,this.referenceValue=0,this.mask=255,this.writeMask=255,this.compareFunctionFront=Te.Always,this.compareFunctionBack=Te.Always,this.passOperationFront=Xe.Keep,this.passOperationBack=Xe.Keep,this.failOperationFront=Xe.Keep,this.failOperationBack=Xe.Keep,this.zFailOperationFront=Xe.Keep,this.zFailOperationBack=Xe.Keep}var s=n.prototype;return s._applyShaderDataValue=function(t,e){var r=t[re.StencilStateEnabled];if(r!==void 0){var a=e.getFloat(r);this.enabled=a!==void 0?!!a:!1}var o=t[re.StencilStateReferenceValue];if(o!==void 0){var l;this.referenceValue=(l=e.getFloat(o))!=null?l:0}var c=t[re.StencilStateMask];if(c!==void 0){var _;this.mask=(_=e.getFloat(c))!=null?_:255}var u=t[re.StencilStateWriteMask];if(u!==void 0){var d;this.writeMask=(d=e.getFloat(u))!=null?d:255}var h=t[re.StencilStateCompareFunctionFront];if(h!==void 0){var f;this.compareFunctionFront=(f=e.getFloat(h))!=null?f:Te.Always}var v=t[re.StencilStateCompareFunctionBack];if(v!==void 0){var p;this.compareFunctionBack=(p=e.getFloat(v))!=null?p:Te.Always}var g=t[re.StencilStatePassOperationFront];if(g!==void 0){var y;this.passOperationFront=(y=e.getFloat(g))!=null?y:Xe.Keep}var m=t[re.StencilStatePassOperationBack];if(m!==void 0){var x;this.passOperationBack=(x=e.getFloat(m))!=null?x:Xe.Keep}var S=t[re.StencilStateFailOperationFront];if(S!==void 0){var b;this.failOperationFront=(b=e.getFloat(S))!=null?b:Xe.Keep}var A=t[re.StencilStateFailOperationBack];if(A!==void 0){var C;this.failOperationBack=(C=e.getFloat(A))!=null?C:Xe.Keep}var E=t[re.StencilStateZFailOperationFront];if(E!==void 0){var T;this.zFailOperationFront=(T=e.getFloat(E))!=null?T:Xe.Keep}var B=t[re.StencilStateZFailOperationBack];if(B!==void 0){var M;this.zFailOperationBack=(M=e.getFloat(B))!=null?M:Xe.Keep}},s._apply=function(t,e){this._platformApply(t,e.stencilState)},s._platformApply=function(t,e){var r=t.gl,a=this,o=a.enabled,l=a.referenceValue,c=a.mask,_=a.compareFunctionFront,u=a.compareFunctionBack,d=a.failOperationFront,h=a.zFailOperationFront,f=a.passOperationFront,v=a.failOperationBack,p=a.zFailOperationBack,g=a.passOperationBack,y=a.writeMask;if(o!=e.enabled&&(o?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),e.enabled=o),o){var m=l!==e.referenceValue||c!==e.mask;(m||_!==e.compareFunctionFront)&&(r.stencilFuncSeparate(r.FRONT,n._getGLCompareFunction(t,_),l,c),e.compareFunctionFront=_),(m||u!==e.compareFunctionBack)&&(r.stencilFuncSeparate(r.BACK,n._getGLCompareFunction(t,u),l,c),e.compareFunctionBack=this.compareFunctionBack),m&&(e.referenceValue=this.referenceValue,e.mask=this.mask),(d!==e.failOperationFront||h!==e.zFailOperationFront||f!==e.passOperationFront)&&(r.stencilOpSeparate(r.FRONT,n._getGLStencilOperation(t,d),n._getGLStencilOperation(t,h),n._getGLStencilOperation(t,f)),e.failOperationFront=d,e.zFailOperationFront=h,e.passOperationFront=f),(v!==e.failOperationBack||p!==e.zFailOperationBack||g!==e.passOperationBack)&&(r.stencilOpSeparate(r.BACK,n._getGLStencilOperation(t,v),n._getGLStencilOperation(t,p),n._getGLStencilOperation(t,g)),e.failOperationBack=v,e.zFailOperationBack=p,e.passOperationBack=g),y!==e.writeMask&&(r.stencilMask(y),e.writeMask=y)}},n._getGLCompareFunction=function(t,e){var r=t.gl;switch(e){case Te.Never:return r.NEVER;case Te.Less:return r.LESS;case Te.Equal:return r.EQUAL;case Te.LessEqual:return r.LEQUAL;case Te.Greater:return r.GREATER;case Te.NotEqual:return r.NOTEQUAL;case Te.GreaterEqual:return r.GEQUAL;case Te.Always:return r.ALWAYS}},n._getGLStencilOperation=function(t,e){var r=t.gl;switch(e){case Xe.Keep:return r.KEEP;case Xe.Zero:return r.ZERO;case Xe.Replace:return r.REPLACE;case Xe.IncrementSaturate:return r.INCR;case Xe.DecrementSaturate:return r.DECR;case Xe.Invert:return r.INVERT;case Xe.IncrementWrap:return r.INCR_WRAP;case Xe.DecrementWrap:return r.DECR_WRAP}},n}(),en=function(){function n(){this.blendState=new Ki,this.depthState=new uc,this.stencilState=new hc,this.rasterState=new dc,this.renderQueueType=mt.Opaque}var s=n.prototype;return s._applyShaderDataValue=function(t,e){this.blendState._applyShaderDataValue(t,e),this.depthState._applyShaderDataValue(t,e),this.stencilState._applyShaderDataValue(t,e),this.rasterState._applyShaderDataValue(t,e);var r=t[re.RenderQueueType];if(r!==void 0){var a;this.renderQueueType=(a=e.getFloat(r))!=null?a:mt.Opaque}},s._apply=function(t,e,r,a){r&&this._applyShaderDataValue(r,a);var o=t._hardwareRenderer,l=t._lastRenderState,c=t._renderContext;this.blendState._apply(o,l),this.depthState._apply(o,l),this.stencilState._apply(o,l),this.rasterState._apply(o,l,c.flipProjection?!e:e)},n}();R([Z],en.prototype,"blendState",void 0);R([Z],en.prototype,"depthState",void 0);R([Z],en.prototype,"stencilState",void 0);R([Z],en.prototype,"rasterState",void 0);var ne=function(){function n(i,t){this.name=i,this._refCount=0,this._destroyed=!1,this.name=i,this._subShaders=t}var s=n.prototype;return s.compileVariant=function(t,e){var r=n._compileMacros;r.clear();for(var a=0,o=e.length;a<o;a++)r.enable(ie.getByName(e[a]));for(var l=!1,c=this._subShaders,_=0,u=c.length;_<u;_++)for(var d=c[_].passes,h=0,f=d.length;h<f;h++){var v=d[h]._getShaderProgram(t,r);l=(h===0||l)&&v.isValid}return l},s.destroy=function(t){if(t===void 0&&(t=!1),!t&&this._refCount!==0)return!1;for(var e=this._subShaders,r=0,a=e.length;r<a;r++)for(var o=e[r].passes,l=0,c=o.length;l<c;l++)o[l]._destroy();return delete n._shaderMap[this.name],this._destroyed=!0,!0},s._getReferCount=function(){return this._refCount},s._addReferCount=function(t){this._refCount+=t},n.create=function(t,e,r){var a,o=n._shaderMap;if(e){if(o[t])throw'Shader named "'+t+'" already exists.';if(typeof e=="string"){var _=new gt(e,r);a=new n(t,[new Si("Default",[_])])}else if(e.length>0)e[0].constructor===gt?a=new n(t,[new Si("Default",e)]):a=new n(t,e.slice());else throw"SubShader or ShaderPass count must large than 0."}else{if(!n._shaderLab)throw"ShaderLab has not been set up yet.";var l=n._shaderLab.parseShader(t);if(o[l.name])throw'Shader named "'+l.name+'" already exists.';var c=l.subShaders.map(function(u){var d=u.passes.map(function(h){if(typeof h=="string"){var f,v,p=h.split("/");return(v=n.find(p[0]))==null||(f=v.subShaders.find(function(E){return E.name===p[1]}))==null?void 0:f.passes.find(function(E){return E.name===p[2]})}var g=new gt(h.name,h.vertexSource,h.fragmentSource,h.tags),y=h.renderStates,m=new en;g._renderState=m;var x=y[0];for(var S in x)n._applyConstRenderStates(m,parseInt(S),x[S]);var b=y[1],A={};for(var C in b)A[C]=L.getByName(b[C]);return g._renderStateDataMap=A,g});return new Si(l.name,d,u.tags)});return a=new n(l.name,c),o[l.name]=a,a}return o[t]=a,a},n.find=function(t){return n._shaderMap[t]},n._applyConstRenderStates=function(t,e,r){switch(e){case re.BlendStateEnabled0:t.blendState.targetBlendState.enabled=r;break;case re.BlendStateColorBlendOperation0:t.blendState.targetBlendState.colorBlendOperation=r;break;case re.BlendStateAlphaBlendOperation0:t.blendState.targetBlendState.alphaBlendOperation=r;break;case re.BlendStateSourceColorBlendFactor0:t.blendState.targetBlendState.sourceColorBlendFactor=r;break;case re.BlendStateDestinationColorBlendFactor0:t.blendState.targetBlendState.destinationColorBlendFactor=r;break;case re.BlendStateSourceAlphaBlendFactor0:t.blendState.targetBlendState.sourceAlphaBlendFactor=r;break;case re.BlendStateDestinationAlphaBlendFactor0:t.blendState.targetBlendState.destinationAlphaBlendFactor=r;break;case re.BlendStateColorWriteMask0:t.blendState.targetBlendState.colorWriteMask=r;break;case re.DepthStateEnabled:t.depthState.enabled=r;break;case re.DepthStateWriteEnabled:t.depthState.writeEnabled=r;break;case re.DepthStateCompareFunction:t.depthState.compareFunction=r;break;case re.StencilStateEnabled:t.stencilState.enabled=r;break;case re.StencilStateReferenceValue:t.stencilState.referenceValue=r;break;case re.StencilStateMask:t.stencilState.mask=r;break;case re.StencilStateWriteMask:t.stencilState.writeMask=r;break;case re.StencilStateCompareFunctionFront:t.stencilState.compareFunctionFront=r;break;case re.StencilStateCompareFunctionBack:t.stencilState.compareFunctionBack=r;break;case re.StencilStatePassOperationFront:t.stencilState.passOperationFront=r;break;case re.StencilStatePassOperationBack:t.stencilState.passOperationBack=r;break;case re.StencilStateFailOperationFront:t.stencilState.failOperationFront=r;break;case re.StencilStateFailOperationBack:t.stencilState.failOperationBack=r;break;case re.StencilStateZFailOperationFront:t.stencilState.zFailOperationFront=r;break;case re.StencilStateZFailOperationBack:t.stencilState.zFailOperationBack=r;break;case re.RasterStateCullMode:t.rasterState.cullMode=r;break;case re.RasterStateDepthBias:t.rasterState.depthBias=r;break;case re.RasterStateSlopeScaledDepthBias:t.rasterState.slopeScaledDepthBias=r;break;case re.RenderQueueType:t.renderQueueType=r;break}},n.getMacroByName=function(t,e){return ie.getByName(t,e)},n.getPropertyByName=function(t){return L.getByName(t)},q(n,[{key:"subShaders",get:function(){return this._subShaders}},{key:"destroyed",get:function(){return this._destroyed}}]),n}();(function(){ne._compileMacros=new ar})();(function(){ne._shaderMap=Object.create(null)})();var Ji=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._isContentLost=!1,t.resourceManager._addGraphicResource(ue(e)),e}var i=s.prototype;return i._onDestroy=function(){n.prototype._onDestroy.call(this),this.engine.resourceManager._deleteGraphicResource(this)},q(s,[{key:"isContentLost",get:function(){return this._isContentLost}}]),s}(rn),ot;(function(n){n[n.Point=0]="Point",n[n.Bilinear=1]="Bilinear",n[n.Trilinear=2]="Trilinear"})(ot||(ot={}));var G;(function(n){n[n.R8G8B8=0]="R8G8B8",n[n.R8G8B8A8=1]="R8G8B8A8",n[n.R4G4B4A4=2]="R4G4B4A4",n[n.R5G5B5A1=3]="R5G5B5A1",n[n.R5G6B5=4]="R5G6B5",n[n.Alpha8=5]="Alpha8",n[n.LuminanceAlpha=6]="LuminanceAlpha",n[n.R16G16B16A16=7]="R16G16B16A16",n[n.R32G32B32A32=8]="R32G32B32A32",n[n.R32G32B32A32_UInt=9]="R32G32B32A32_UInt",n[n.BC1=10]="BC1",n[n.BC3=11]="BC3",n[n.BC7=12]="BC7",n[n.ETC1_RGB=13]="ETC1_RGB",n[n.ETC2_RGB=14]="ETC2_RGB",n[n.ETC2_RGBA5=15]="ETC2_RGBA5",n[n.ETC2_RGBA8=16]="ETC2_RGBA8",n[n.PVRTC_RGB2=17]="PVRTC_RGB2",n[n.PVRTC_RGBA2=18]="PVRTC_RGBA2",n[n.PVRTC_RGB4=19]="PVRTC_RGB4",n[n.PVRTC_RGBA4=20]="PVRTC_RGBA4",n[n.ASTC_4x4=21]="ASTC_4x4",n[n.ASTC_5x5=22]="ASTC_5x5",n[n.ASTC_6x6=23]="ASTC_6x6",n[n.ASTC_8x8=24]="ASTC_8x8",n[n.ASTC_10x10=25]="ASTC_10x10",n[n.ASTC_12x12=26]="ASTC_12x12",n[n.Depth=27]="Depth",n[n.Stencil=28]="Stencil",n[n.DepthStencil=29]="DepthStencil",n[n.Depth16=30]="Depth16",n[n.Depth24=31]="Depth24",n[n.Depth32=32]="Depth32",n[n.Depth24Stencil8=33]="Depth24Stencil8",n[n.Depth32Stencil8=34]="Depth32Stencil8",n[n.DXT1=10]="DXT1",n[n.DXT5=11]="DXT5"})(G||(G={}));var Kr=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t._isDepthTexture=!1,t._anisoLevel=1,t._useDepthCompareMode=!1,t}var i=s.prototype;return i.generateMipmaps=function(){!this._mipmap||this._platformTexture.generateMipmaps()},i._setUseDepthCompareMode=function(e){this._useDepthCompareMode!==e&&(this._platformTexture.setUseDepthCompareMode(e),this._useDepthCompareMode=e)},i._rebuild=function(){var e=this._platformTexture;e.wrapModeU=this._wrapModeU,e.wrapModeV=this._wrapModeV,e.filterMode=this._filterMode,e.anisoLevel=this._anisoLevel,this._engine._hardwareRenderer._isWebGL2&&(e.depthCompareFunction=this._depthCompareFunction,e.setUseDepthCompareMode(this._useDepthCompareMode))},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._platformTexture.destroy(),this._platformTexture=null},i._getMaxMiplevel=function(e){return Math.floor(Math.log2(e))},i._getMipmapCount=function(){return this._mipmap?Math.floor(Math.log2(Math.max(this._width,this._height)))+1:1},i._isIntFormat=function(){return G.R32G32B32A32_UInt===this._format},q(s,[{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"usage",get:function(){return this._usage}},{key:"wrapModeU",get:function(){return this._wrapModeU},set:function(e){e!==this._wrapModeU&&(this._wrapModeU=e,this._platformTexture.wrapModeU=e)}},{key:"wrapModeV",get:function(){return this._wrapModeV},set:function(e){e!==this._wrapModeV&&(this._wrapModeV=e,this._platformTexture.wrapModeV=e)}},{key:"mipmapCount",get:function(){return this._mipmapCount}},{key:"filterMode",get:function(){return this._filterMode},set:function(e){if(e!==this._filterMode){if(e!==ot.Point&&this._isIntFormat()){e=ot.Point,ve.warn("Int or UInt format texture only support TextureFilterMode.Point");return}this._filterMode=e,this._platformTexture.filterMode=e}}},{key:"anisoLevel",get:function(){return this._anisoLevel},set:function(e){var r=this._engine._hardwareRenderer.capability.maxAnisoLevel;e>r&&(ve.warn("anisoLevel:"+e+", exceeds the limit and is automatically downgraded to:"+r),e=r),e<1&&(ve.warn("anisoLevel:"+e+", must be greater than 0, and is automatically downgraded to 1"),e=1),e!==this._anisoLevel&&(this._anisoLevel=e,this._platformTexture.anisoLevel=e)}},{key:"depthCompareFunction",get:function(){return this._depthCompareFunction},set:function(e){if(!this._engine._hardwareRenderer._isWebGL2){console.warn("depthCompareFunction only support WebGL2");return}e!==this._depthCompareFunction&&(this._depthCompareFunction=e,this._platformTexture.depthCompareFunction=e)}}]),s}(Ji),Hr=function(){function n(i){this._propertyValueMap=Object.create(null),this._macroCollection=new ar,this._macroMap=Object.create(null),this._refCount=0,this._group=i}var s=n.prototype;return s.getFloat=function(t){return this.getPropertyValue(t)},s.setFloat=function(t,e){this._setPropertyValue(t,kt.Float,e)},s.getInt=function(t){return this.getPropertyValue(t)},s.setInt=function(t,e){this._setPropertyValue(t,kt.Int,e)},s.getFloatArray=function(t){return this.getPropertyValue(t)},s.setFloatArray=function(t,e){this._setPropertyValue(t,kt.FloatArray,e)},s.getIntArray=function(t){return this.getPropertyValue(t)},s.setIntArray=function(t,e){this._setPropertyValue(t,kt.IntArray,e)},s.getVector2=function(t){return this.getPropertyValue(t)},s.setVector2=function(t,e){this._setPropertyValue(t,kt.Vector2,e)},s.getVector3=function(t){return this.getPropertyValue(t)},s.setVector3=function(t,e){this._setPropertyValue(t,kt.Vector3,e)},s.getVector4=function(t){return this.getPropertyValue(t)},s.setVector4=function(t,e){this._setPropertyValue(t,kt.Vector4,e)},s.getMatrix=function(t){return this.getPropertyValue(t)},s.setMatrix=function(t,e){this._setPropertyValue(t,kt.Matrix,e)},s.getColor=function(t){return this.getPropertyValue(t)},s.setColor=function(t,e){this._setPropertyValue(t,kt.Color,e)},s.getTexture=function(t){return this.getPropertyValue(t)},s.setTexture=function(t,e){var r=this._refCount;if(r>0){var a=this.getPropertyValue(t);a&&a._addReferCount(-r),e&&e._addReferCount(r)}this._setPropertyValue(t,kt.Texture,e)},s.getTextureArray=function(t){return this.getPropertyValue(t)},s.setTextureArray=function(t,e){var r=this._refCount;if(r>0){var a=this.getPropertyValue(t);if(a)for(var o=0,l=a.length;o<l;o++)a[o]._addReferCount(-r);if(e)for(var c=0,_=e.length;c<_;c++)e[c]._addReferCount(r)}this._setPropertyValue(t,kt.TextureArray,e)},s.getPropertyValue=function(t){return typeof t=="string"&&(t=L.getByName(t)),this._propertyValueMap[t._uniqueId]},s.enableMacro=function(t,e){typeof t=="string"&&(t=ie.getByName(t,e));var r=t._nameId,a=this._macroMap[r];if(a!==t){var o=this._macroCollection;a&&o.disable(a),o.enable(t),this._macroMap[r]=t}},s.disableMacro=function(t){var e;if(typeof t=="string"){if(e=ie._macroNameIdMap[t],e===void 0)return}else e=t._nameId;var r=this._macroMap[e];r&&(this._macroCollection.disable(r),delete this._macroMap[e])},s.getMacros=function(t){if(t){var e=this._macroMap;t.length=0;for(var r in e)t.push(e[r])}else return Object.values(this._macroMap)},s.getProperties=function(t){var e;t?(t.length=0,e=t):e=[];var r=this._propertyValueMap,a=L._propertyIdMap;for(var o in r)e.push(a[o]);if(!t)return e},s.clone=function(){var t=new n(this._group);return this.cloneTo(t),t},s.cloneTo=function(t){Br.deepCloneObject(this._macroCollection,t._macroCollection),Object.assign(t._macroMap,this._macroMap);for(var e=t._getReferCount(),r=this._propertyValueMap,a=t._propertyValueMap,o=Object.keys(r),l=0,c=o.length;l<c;l++){var _=o[l],u=r[_];if(u!=null)if(typeof u=="number")a[_]=u;else if(ft(u,Kr))a[_]=u,e>0&&u._addReferCount(e);else if(ft(u,Array)||ft(u,Float32Array)||ft(u,Int32Array))a[_]=u.slice();else{var d=a[_];d?d.copyFrom(u):a[_]=u.clone()}else a[_]=u}},s._setPropertyValue=function(t,e,r){if(typeof t=="string"&&(t=L.getByName(t)),t._group!==this._group)if(t._group===void 0)t._group=this._group;else throw"Shader property "+t.name+" has been used as "+Tr[t._group]+" group.";if(t._type!==e)if(t._type===void 0)t._type=e;else throw"Shader property "+t.name+" has been used as "+kt[t._type]+" type.";this._propertyValueMap[t._uniqueId]=r},s._getReferCount=function(){return this._refCount},s._addReferCount=function(t){this._refCount+=t;var e=this._propertyValueMap;for(var r in e){var a=e[r];a&&ft(a,Kr)&&a._addReferCount(t)}},n}();R([I],Hr.prototype,"_group",void 0);R([I],Hr.prototype,"_propertyValueMap",void 0);R([I],Hr.prototype,"_macroCollection",void 0);R([I],Hr.prototype,"_macroMap",void 0);R([I],Hr.prototype,"_refCount",void 0);var Nr,be=(Nr=function(n){W(s,n);function s(t){var e;e=n.call(this,t)||this,e._onUpdateIndex=-1,e._rendererIndex=-1,e._globalShaderMacro=new ar,e._bounds=new nr,e._overrideUpdate=!1,e._materials=[],e._dirtyUpdateFlag=0,e._shaderData=new Hr(Tr.Renderer),e._mvMatrix=new J,e._mvpMatrix=new J,e._mvInvMatrix=new J,e._normalMatrix=new J,e._materialsInstanced=[],e._priority=0,e._receiveShadows=!0,e._rendererLayer=new ae,e.castShadows=!0;var r=be.prototype,a=e.shaderData;return e._overrideUpdate=e.update!==r.update,e._addResourceReferCount(e.shaderData,1),e._onTransformChanged=e._onTransformChanged.bind(ue(e)),e._registerEntityTransformListener(),a.enableMacro(be._receiveShadowMacro),a.setVector4(be._rendererLayerProperty,e._rendererLayer),e}var i=s.prototype;return i.getInstanceMaterial=function(e){e===void 0&&(e=0);var r=this._materials;if(r.length>e){var a=r[e];if(a)return this._materialsInstanced[e]?a:this._createInstanceMaterial(a,e)}return null},i.getMaterial=function(e){return e===void 0&&(e=0),this._materials[e]||null},i.setMaterial=function(e,r){r===void 0&&(r=null),typeof e=="number"?this._setMaterial(e,r):this._setMaterial(0,e)},i.getInstanceMaterials=function(){for(var e=this._materials,r=this._materialsInstanced,a=0,o=e.length;a<o;a++)r[a]||this._createInstanceMaterial(this._materials[a],a);return e},i.getMaterials=function(){return this._materials},i.setMaterials=function(e){for(var r=e.length,a=this._materials,o=this._materialsInstanced,l=r,c=a.length;l<c;l++){var _=a[l];_&&this._addResourceReferCount(_,-1)}a.length!==r&&(a.length=r),o.length!==0&&(o.length=0);for(var u=0;u<r;u++){var d=a[u],h=e[u];d!==h&&(a[u]=h,d&&this._addResourceReferCount(d,-1),h&&this._addResourceReferCount(h,1))}},i.update=function(e){},i._onEnableInScene=function(){var e=this.scene._componentsManager;this._overrideUpdate&&e.addOnUpdateRenderers(this),e.addRenderer(this)},i._onDisableInScene=function(){var e=this.scene._componentsManager;this._overrideUpdate&&e.removeOnUpdateRenderers(this),e.removeRenderer(this)},i._prepareRender=function(e){var r=e.virtualCamera,a=r.position,o=this.bounds.getCenter(be._tempVector0);r.isOrthographic?(w.subtract(o,a,o),this._distanceForSort=w.dot(o,r.forward)):this._distanceForSort=w.distanceSquared(o,a),this._updateShaderData(e,!1),this._render(e),ar.unionCollection(e.camera._globalShaderMacro,this.shaderData._macroCollection,this._globalShaderMacro)},i._cloneTo=function(e,r,a){for(var o=this._materials,l=0,c=o.length;l<c;l++)e._setMaterial(l,o[l])},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._unRegisterEntityTransformListener(),this._addResourceReferCount(this.shaderData,-1);for(var e=this._materials,r=0,a=e.length;r<a;r++){var o=e[r];o&&this._addResourceReferCount(o,-1)}this._entity=null,this._globalShaderMacro=null,this._bounds=null,this._materials=null,this._shaderData=null,this._mvMatrix=null,this._mvpMatrix=null,this._mvInvMatrix=null,this._normalMatrix=null,this._materialsInstanced=null,this._rendererLayer=null},i._updateShaderData=function(e,r){var a=this.entity,o=a.transform.worldMatrix;if(r){this._updateMVPShaderData(e,o);return}this._updateTransformShaderData(e,o);var l=a.layer;this._rendererLayer.set(l&65535,l>>>16&65535,0,0)},i._updateTransformShaderData=function(e,r){var a=this.shaderData,o=this._mvMatrix,l=this._mvInvMatrix,c=this._normalMatrix;J.multiply(e.viewMatrix,r,o),J.invert(o,l),J.invert(r,c),c.transpose(),a.setMatrix(be._localMatrixProperty,this.entity.transform.localMatrix),a.setMatrix(be._worldMatrixProperty,r),a.setMatrix(be._mvMatrixProperty,o),a.setMatrix(be._mvInvMatrixProperty,l),a.setMatrix(be._normalMatrixProperty,c),this._updateMVPShaderData(e,r)},i._updateMVPShaderData=function(e,r){var a=this._mvpMatrix;J.multiply(e.viewProjectionMatrix,r,a),this.shaderData.setMatrix(be._mvpMatrixProperty,a)},i._registerEntityTransformListener=function(){this.entity.transform._updateFlagManager.addListener(this._onTransformChanged)},i._unRegisterEntityTransformListener=function(){this.entity.transform._updateFlagManager.removeListener(this._onTransformChanged)},i._updateBounds=function(e){},i._render=function(e){throw"not implement"},i._createInstanceMaterial=function(e,r){var a=e.clone();return a.name=a.name+"(Instance)",this._addResourceReferCount(e,-1),this._addResourceReferCount(a,1),this._materialsInstanced[r]=!0,this._materials[r]=a,a},i._setMaterial=function(e,r){var a=this._materials;e>=a.length&&(a.length=e+1);var o=a[e];if(o!==r){var l=this._materialsInstanced;e<l.length&&(l[e]=!1),o&&this._addResourceReferCount(o,-1),r&&this._addResourceReferCount(r,1),a[e]=r}},i._onTransformChanged=function(e){this._dirtyUpdateFlag|=1},q(s,[{key:"shaderData",get:function(){return this._shaderData}},{key:"isCulled",get:function(){return!(this._renderFrameCount===void 0||this._renderFrameCount===this._engine.time.frameCount-1)}},{key:"receiveShadows",get:function(){return this._receiveShadows},set:function(e){this._receiveShadows!==e&&(e?this.shaderData.enableMacro(be._receiveShadowMacro):this.shaderData.disableMacro(be._receiveShadowMacro),this._receiveShadows=e)}},{key:"materialCount",get:function(){return this._materials.length},set:function(e){var r=this._materials,a=this._materialsInstanced;r.length!==e&&(r.length=e),a.length>e&&(a.length=e)}},{key:"bounds",get:function(){return this._dirtyUpdateFlag&1&&(this._updateBounds(this._bounds),this._dirtyUpdateFlag&=-2),this._bounds}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}}]),s}(Vt),function(){Nr._tempVector0=new w}(),function(){Nr._receiveShadowMacro=ie.getByName("RENDERER_IS_RECEIVE_SHADOWS")}(),function(){Nr._localMatrixProperty=L.getByName("renderer_LocalMat")}(),function(){Nr._worldMatrixProperty=L.getByName("renderer_ModelMat")}(),function(){Nr._mvMatrixProperty=L.getByName("renderer_MVMat")}(),function(){Nr._mvpMatrixProperty=L.getByName("renderer_MVPMat")}(),function(){Nr._mvInvMatrixProperty=L.getByName("renderer_MVInvMat")}(),function(){Nr._normalMatrixProperty=L.getByName("renderer_NormalMat")}(),function(){Nr._rendererLayerProperty=L.getByName("renderer_Layer")}(),Nr);R([I],be.prototype,"_distanceForSort",void 0);R([I],be.prototype,"_onUpdateIndex",void 0);R([I],be.prototype,"_rendererIndex",void 0);R([I],be.prototype,"_globalShaderMacro",void 0);R([I],be.prototype,"_bounds",void 0);R([I],be.prototype,"_renderFrameCount",void 0);R([I],be.prototype,"_overrideUpdate",void 0);R([I],be.prototype,"_materials",void 0);R([I],be.prototype,"_dirtyUpdateFlag",void 0);R([Z],be.prototype,"_shaderData",void 0);R([I],be.prototype,"_mvMatrix",void 0);R([I],be.prototype,"_mvpMatrix",void 0);R([I],be.prototype,"_mvInvMatrix",void 0);R([I],be.prototype,"_normalMatrix",void 0);R([I],be.prototype,"_materialsInstanced",void 0);R([Pe],be.prototype,"_priority",void 0);R([Pe],be.prototype,"_receiveShadows",void 0);R([I],be.prototype,"_rendererLayer",void 0);R([I],be.prototype,"_onTransformChanged",null);be=R([An(me,Ur.CheckOnly)],be);var $e;(function(n){n[n.WorldVolume=1]="WorldVolume"})($e||($e={}));function Yt(){return function(n){}}var ci,dn=(ci=function(){function n(){}return n.resetData=function(i){var t=i._verticesData,e=t.positions,r=t.uvs;t.vertexCount=e.length=r.length=4;for(var a=0;a<4;a++){var o,l,c,_;(o=e)[l=a]||(o[l]=new w),(c=r)[_=a]||(c[_]=new $)}t.triangles=dn._rectangleTriangles},n.updatePositions=function(i){var t=i.width,e=i.height,r=i.sprite,a=r.pivot,o=a.x,l=a.y,c=dn._worldMatrix,_=c.elements,u=i.entity.transform.worldMatrix,d=u.elements,h=i.flipX?-t:t,f=i.flipY?-e:e;_[0]=d[0]*h,_[1]=d[1]*h,_[2]=d[2]*h,_[4]=d[4]*f,_[5]=d[5]*f,_[6]=d[6]*f,_[8]=d[8],_[9]=d[9],_[10]=d[10],_[12]=d[12]-o*_[0]-l*_[4],_[13]=d[13]-o*_[1]-l*_[5],_[14]=d[14]-o*_[2]-l*_[6];for(var v=r._getPositions(),p=i._verticesData.positions,g=0;g<4;g++){var y=v[g],m=y.x,x=y.y;p[g].set(_[0]*m+_[4]*x+_[12],_[1]*m+_[5]*x+_[13],_[2]*m+_[6]*x+_[14])}nr.transform(r._getBounds(),c,i._bounds)},n.updateUVs=function(i){var t=i.sprite._getUVs(),e=i._verticesData.uvs,r=t[0],a=r.x,o=r.y,l=t[3],c=l.x,_=l.y;e[0].set(a,o),e[1].set(c,o),e[2].set(a,_),e[3].set(c,_)},n}(),function(){ci._rectangleTriangles=[0,1,2,2,1,3]}(),function(){ci._worldMatrix=new J}(),ci);dn=R([Yt()],dn);var _i,za=(_i=function(){function n(){}return n.resetData=function(i){var t=i._verticesData,e=t.positions,r=t.uvs;t.vertexCount=e.length=r.length=16;for(var a=0;a<16;a++){var o,l,c,_;(o=e)[l=a]||(o[l]=new w),(c=r)[_=a]||(c[_]=new $)}t.triangles=za._rectangleTriangles},n.updatePositions=function(i){var t=i.width,e=i.height,r=i.sprite,a=i._verticesData,o=a.positions,l=a.uvs,c=r.border,_=r._getUVs(),u=r._getPositions(),d=u[0],h=d.x,f=d.y,v=u[3],p=v.x,g=v.y,y=r.width,m=r.height,x=y*c.x,S=m*c.y,b=y*c.z,A=m*c.w,C,E;if(x+b>t){var T=t/(x+b);C=[y*h*T,x*T,x*T,t-y*(1-p)*T]}else C=[y*h,x,t-b,t-y*(1-p)];if(A+S>e){var B=e/(A+S);E=[m*f*B,S*B,S*B,e-m*(1-g)*B]}else E=[m*f,S,e-A,e-m*(1-g)];var M=i.sprite.pivot,P=M.x,V=M.y,N=i.width*P,F=i.height*V,O=za._worldMatrix,D=O.elements,z=i.entity.transform.worldMatrix,U=z.elements,Y=i.flipX?-1:1,K=i.flipY?-1:1;D[0]=U[0]*Y,D[1]=U[1]*Y,D[2]=U[2]*Y,D[4]=U[4]*K,D[5]=U[5]*K,D[6]=U[6]*K,D[8]=U[8],D[9]=U[9],D[10]=U[10],D[12]=U[12]-N*D[0]-F*D[4],D[13]=U[13]-N*D[1]-F*D[5],D[14]=U[14]-N*D[2]-F*D[6];for(var H=0;H<4;H++)for(var te=C[H],we=_[H].x,pe=0;pe<4;pe++){var oe=E[pe],Ee=H*4+pe;o[Ee].set(D[0]*te+D[4]*oe+D[12],D[1]*te+D[5]*oe+D[13],D[2]*te+D[6]*oe+D[14]),l[Ee].set(we,_[pe].y)}var Ke=i._bounds,vt=Ke.min,Se=Ke.max;vt.set(C[0],E[0],0),Se.set(C[3],E[3],0),i._bounds.transform(O)},n.updateUVs=function(i){},n}(),function(){_i._rectangleTriangles=[0,1,4,1,5,4,1,2,5,2,6,5,2,3,6,3,7,6,4,5,8,5,9,8,5,6,9,6,10,9,6,7,10,7,11,10,8,9,12,9,13,12,9,10,13,10,14,13,10,11,14,11,15,14]}(),function(){_i._worldMatrix=new J}(),_i);za=R([Yt()],za);var Ye=function(){function n(i){i===void 0&&(i=0),this.length=0,this._isLooping=!1,this._blankCount=0,this._elements=new Array(i)}var s=n.prototype;return s.add=function(t){this.length===this._elements.length?this._elements.push(t):this._elements[this.length]=t,this.length++},s.delete=function(t){var e=this._elements.indexOf(t);this.deleteByIndex(e)},s.set=function(t,e){if(t>=this.length)throw"Index is out of range.";this._elements[t]=e},s.get=function(t){if(t>=this.length)throw"Index is out of range.";return this._elements[t]},s.deleteByIndex=function(t){var e=this._elements,r;if(this._isLooping)this._elements[t]=null,this._blankCount++;else{var a=this.length-1;t!==a&&(r=e[a],e[t]=r),e[a]=null,this.length--}return r},s.forEach=function(t,e){this._startLoop();for(var r=this._elements,a=0,o=this.length;a<o;a++){var l=r[a];l&&t(l)}this._endLoop(e)},s.forEachAndClean=function(t){this._startLoop();for(var e=this._elements,r=0,a=this.length;r<a;r++){var o=e[r];o&&t(o)}this._endLoopAndClear()},s.sort=function(t){We._quickSort(this._elements,0,this.length,t)},s.garbageCollection=function(){this._elements.length=this.length},s._startLoop=function(){this._isLooping=!0},s._endLoop=function(t){if(this._isLooping=!1,this._blankCount){var e=0,r=this.length-1,a=this._elements;e:do{for(;a[e];)if(++e>=r)break e;for(;!a[r];)if(e>=--r)break e;var o=a[r];t(o,e),a[e++]=o,a[r--]=null}while(e<r);this.length-=this._blankCount,this._blankCount=0}},s._endLoopAndClear=function(){this._isLooping=!1,this.length=0,this._blankCount=0},n}(),tt;(function(n){n[n.Static=0]="Static",n[n.Dynamic=1]="Dynamic",n[n.Stream=2]="Stream"})(tt||(tt={}));var gn;(function(n){n[n.None=0]="None",n[n.Discard=1]="Discard"})(gn||(gn={}));var ir=function(n){W(s,n);function s(t,e,r,a,o){a===void 0&&(a=tt.Static),o===void 0&&(o=!1);var l;if(l=n.call(this,t)||this,l._dataUpdateManager=new zr,l._engine=t,l._type=e,l._bufferUsage=a,l._readable=o,typeof r=="number")l._byteLength=r,l._platformBuffer=t._hardwareRenderer.createPlatformBuffer(e,r,a),o&&(l._data=new Uint8Array(r));else{var c=r,_=c.byteLength;if(l._byteLength=_,l._platformBuffer=t._hardwareRenderer.createPlatformBuffer(e,_,a,c),o){var u=c.constructor===ArrayBuffer?c.slice(0):c.buffer.slice(c.byteOffset,c.byteOffset+_);l._data=new Uint8Array(u)}}return l}var i=s.prototype;return i.bind=function(){this._platformBuffer.bind()},i.setData=function(e,r,a,o,l){if(r===void 0&&(r=0),a===void 0&&(a=0),l===void 0&&(l=gn.None),this._platformBuffer.setData(this._byteLength,e,r,a,o,l),this._readable){var c=e.constructor===ArrayBuffer?e:e.buffer;if(this._data.buffer!==c){var _=e.BYTES_PER_ELEMENT||1,u=o?_*o:e.byteLength,d=e.byteOffset!==void 0,h=d?e.byteOffset+a*_:a,f=new Uint8Array(c,h,u);this._data.set(f,r)}}this._isContentLost=!1,this._dataUpdateManager.dispatch()},i.getData=function(e,r,a,o){r===void 0&&(r=0),a===void 0&&(a=0),this._platformBuffer.getData(e,r,a,o)},i.markAsUnreadable=function(){this._data=null,this._readable=!1},i._rebuild=function(){var e=this._engine._hardwareRenderer.createPlatformBuffer(this._type,this._byteLength,this._bufferUsage);this._platformBuffer=e},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._platformBuffer.destroy()},q(s,[{key:"type",get:function(){return this._type}},{key:"byteLength",get:function(){return this._byteLength}},{key:"bufferUsage",get:function(){return this._bufferUsage}},{key:"readable",get:function(){return this._readable}},{key:"data",get:function(){if(this._readable)return this._data;throw"Buffer is not readable."}}]),s}(Ji),Et;(function(n){n[n.UInt8=0]="UInt8",n[n.UInt16=1]="UInt16",n[n.UInt32=2]="UInt32"})(Et||(Et={}));var ee;(function(n){n[n.Float=0]="Float",n[n.Vector2=1]="Vector2",n[n.Vector3=2]="Vector3",n[n.Vector4=3]="Vector4",n[n.Byte4=4]="Byte4",n[n.UByte4=5]="UByte4",n[n.NormalizedByte4=6]="NormalizedByte4",n[n.NormalizedUByte4=7]="NormalizedUByte4",n[n.Short2=8]="Short2",n[n.UShort2=9]="UShort2",n[n.NormalizedShort2=10]="NormalizedShort2",n[n.NormalizedUShort2=11]="NormalizedUShort2",n[n.Short4=12]="Short4",n[n.UShort4=13]="UShort4",n[n.NormalizedShort4=14]="NormalizedShort4",n[n.NormalizedUShort4=15]="NormalizedUShort4"})(ee||(ee={}));var Ti=function(){function n(){}return n._getGLIndexType=function(i){switch(i){case Et.UInt8:return Ue.UNSIGNED_BYTE;case Et.UInt16:return Ue.UNSIGNED_SHORT;case Et.UInt32:return Ue.UNSIGNED_INT}},n._getGLIndexByteCount=function(i){switch(i){case Et.UInt8:return 1;case Et.UInt16:return 2;case Et.UInt32:return 4}},n._getElementInfo=function(i){var t,e,r=!1,a;switch(i){case ee.Float:t=1,e=Ue.FLOAT;break;case ee.Vector2:t=2,e=Ue.FLOAT;break;case ee.Vector3:t=3,e=Ue.FLOAT;break;case ee.Vector4:t=4,e=Ue.FLOAT;break;case ee.Byte4:t=4,e=Ue.BYTE;break;case ee.UByte4:t=4,e=Ue.UNSIGNED_BYTE;break;case ee.NormalizedByte4:t=4,e=Ue.BYTE,r=!0,a=1/127;break;case ee.NormalizedUByte4:t=4,e=Ue.UNSIGNED_BYTE,r=!0,a=1/255;break;case ee.Short2:t=2,e=Ue.SHORT;break;case ee.UShort2:t=2,e=Ue.UNSIGNED_SHORT;break;case ee.NormalizedShort2:t=2,e=Ue.SHORT,r=!0,a=1/32767;break;case ee.NormalizedUShort2:t=2,e=Ue.UNSIGNED_SHORT,r=!0,a=1/65535;break;case ee.Short4:t=4,e=Ue.SHORT;break;case ee.UShort4:t=4,e=Ue.UNSIGNED_SHORT;break;case ee.NormalizedShort4:t=4,e=Ue.SHORT,r=!0,a=1/32767;break;case ee.NormalizedUShort4:t=4,e=Ue.UNSIGNED_SHORT,r=!0,a=1/65535;break}return{size:t,type:e,normalized:r,normalizedScaleFactor:a}},n}(),Nt;(function(n){n[n.VertexBuffer=0]="VertexBuffer",n[n.IndexBuffer=1]="IndexBuffer"})(Nt||(Nt={}));var kr;(function(n){n[n.Points=0]="Points",n[n.Lines=1]="Lines",n[n.LineLoop=2]="LineLoop",n[n.LineStrip=3]="LineStrip",n[n.Triangles=4]="Triangles",n[n.TriangleStrip=5]="TriangleStrip",n[n.TriangleFan=6]="TriangleFan"})(kr||(kr={}));var Ua=function(){function n(s,i){this._buffer=s,this._format=i}return q(n,[{key:"buffer",get:function(){return this._buffer}},{key:"format",get:function(){return this._format}}]),n}(),Zi=function(){function n(i,t,e){i===void 0&&(i=0),t===void 0&&(t=0),e===void 0&&(e=kr.Triangles),this.start=i,this.count=t,this.topology=e}var s=n.prototype;return s.dispose=function(){},n}(),ko=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e.enableVAO=!0,e.instanceCount=0,e.vertexBufferBindings=[],e._vertexElementMap={},e._bufferStructChanged=!1,e._vertexElements=[],e._platformPrimitive=t._hardwareRenderer.createPlatformPrimitive(ue(e)),e}var i=s.prototype;return i.addVertexElement=function(e){var r=this._vertexElementMap,a=this._vertexElements,o=e.attribute,l=r[o];l&&(console.warn("VertexElement "+o+" already exists."),a.splice(a.indexOf(l),1)),r[o]=e,a.push(e),this._bufferStructChanged=!0},i.removeVertexElement=function(e){var r=this._vertexElements,a=r[e];r.splice(e,1),delete this._vertexElementMap[a.attribute],this._bufferStructChanged=!0},i.clearVertexElements=function(){this._vertexElements.length=0;var e=this._vertexElementMap;for(var r in e)delete e[r];this._bufferStructChanged=!0},i.setVertexElement=function(e,r){var a=this._vertexElementMap,o=this._vertexElements,l=o[e];l&&delete a[l.attribute],a[r.attribute]=r,o[e]=r,this._bufferStructChanged=!0},i.setVertexElementsLength=function(e){for(var r=this._vertexElementMap,a=this._vertexElements,o=e,l=a.length;o<l;o++){var c=a[o];delete r[c.attribute]}a.length=e},i.setVertexBufferBinding=function(e,r){var a=this._getReferCount(),o=this.vertexBufferBindings;if(a>0){var l,c;(l=o[e])==null||l.buffer._addReferCount(-a),(c=r)==null||c.buffer._addReferCount(a)}o[e]=r,this._bufferStructChanged=!0},i.setVertexBufferBindings=function(e,r){r===void 0&&(r=0);var a=this.vertexBufferBindings,o=e.length,l=r+o;a.length<l&&(a.length=l);for(var c=0;c<o;c++)this.setVertexBufferBinding(r+c,e[c])},i.setIndexBufferBinding=function(e){var r=this.indexBufferBinding,a=this._getReferCount();if(r!==e){var o,l,c;this._indexBufferBinding=e,a>0&&((o=r)==null||o.buffer._addReferCount(-a)),e?(a>0&&e.buffer._addReferCount(a),this._glIndexType=Ti._getGLIndexType(e.format),this._glIndexByteCount=Ti._getGLIndexByteCount(e.format)):this._glIndexType=void 0,this._bufferStructChanged=((l=r)==null?void 0:l.buffer)!==((c=e)==null?void 0:c.buffer)}},i.draw=function(e,r){this._platformPrimitive.draw(e,r),this._bufferStructChanged=!1},i._addReferCount=function(e){var r;n.prototype._addReferCount.call(this,e);for(var a=this.vertexBufferBindings,o=0,l=a.length;o<l;o++){var c;(c=a[o])==null||c.buffer._addReferCount(e)}(r=this.indexBufferBinding)==null||r._buffer._addReferCount(e)},i._rebuild=function(){this._engine._hardwareRenderer.createPlatformPrimitive(this),this._isContentLost=!1},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._platformPrimitive.destroy(),this._vertexElementMap=null},q(s,[{key:"vertexElements",get:function(){return this._vertexElements}},{key:"indexBufferBinding",get:function(){return this._indexBufferBinding}}]),s}(Ji),Go=function(n){W(s,n);function s(t,e){var r;r=n.call(this,t)||this,r._updateFlagManager=new zr,r._bounds=new nr,r._subMeshes=[],r.name=e,r._primitive=new ko(t),r._onBoundsChanged=r._onBoundsChanged.bind(ue(r));var a=r._bounds;return a.min._onValueChanged=r._onBoundsChanged,a.max._onValueChanged=r._onBoundsChanged,r}var i=s.prototype;return i.addSubMesh=function(e,r,a){return a===void 0&&(a=kr.Triangles),typeof e=="number"&&(e=new Zi(e,r,a)),this._subMeshes.push(e),e},i.removeSubMesh=function(e){var r=this._subMeshes,a=r.indexOf(e);a!==-1&&r.splice(a,1)},i.clearSubMesh=function(){this._subMeshes.length=0},i._clearVertexElements=function(){this._primitive.clearVertexElements(),this._updateFlagManager.dispatch(2)},i._addVertexElement=function(e){this._primitive.addVertexElement(e),this._updateFlagManager.dispatch(2)},i._removeVertexElement=function(e){this._primitive.removeVertexElement(e),this._updateFlagManager.dispatch(2)},i._setVertexElement=function(e,r){this._primitive.setVertexElement(e,r),this._updateFlagManager.dispatch(2)},i._setVertexElementsLength=function(e){this._primitive.setVertexElementsLength(e)},i._setVertexBufferBinding=function(e,r){this._primitive.setVertexBufferBinding(e,r)},i._addReferCount=function(e){n.prototype._addReferCount.call(this,e),this._primitive._addReferCount(e)},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._primitive.destroy()},i._setVertexElements=function(e){this._clearVertexElements();for(var r=0,a=e.length;r<a;r++)this._addVertexElement(e[r])},i._setIndexBufferBinding=function(e){this._primitive.setIndexBufferBinding(e)},i._onBoundsChanged=function(){this._updateFlagManager.dispatch(1)},q(s,[{key:"bounds",get:function(){return this._bounds},set:function(e){this._bounds!==e&&this._bounds.copyFrom(e)}},{key:"subMesh",get:function(){return this._subMeshes[0]||null}},{key:"subMeshes",get:function(){return this._subMeshes}}]),s}(rn),Ri;(function(n){n[n.Bounds=1]="Bounds",n[n.VertexElements=2]="VertexElements"})(Ri||(Ri={}));var $n=function(){function n(s,i){this._buffer=s,this._stride=i}return q(n,[{key:"buffer",get:function(){return this._buffer}},{key:"stride",get:function(){return this._stride}}]),n}(),Me=function(){function n(s,i,t,e,r){r===void 0&&(r=0),this._attributeName=s,this._offset=i,this._format=t,this._bindingIndex=e,this._formatMetaInfo=Ti._getElementInfo(this.format),this._instanceStepRate=Math.floor(r)}return q(n,[{key:"attribute",get:function(){return this._attributeName}},{key:"offset",get:function(){return this._offset},set:function(i){this._offset=i}},{key:"format",get:function(){return this._format}},{key:"bindingIndex",get:function(){return this._bindingIndex},set:function(i){this._bindingIndex=i}},{key:"instanceStepRate",get:function(){return this._instanceStepRate}},{key:"semantic",get:function(){return this.attribute}}]),n}(),fc=function(){function n(i,t,e,r){if(e===void 0&&(e=null),r===void 0&&(r=null),this._dataChangeManager=new zr,this._dirty=7,e&&e.length!==t.length)throw"deltaNormals length must same with deltaPositions length.";if(r&&r.length!==t.length)throw"deltaTangents length must same with deltaPositions length.";this.weight=i,this._deltaPositions=t,this._deltaNormals=e,this._deltaTangents=r}var s=n.prototype;return s._releaseData=function(){this._deltaPositions=null,this._deltaNormals=null,this._deltaTangents=null},q(n,[{key:"deltaPositions",get:function(){return this._deltaPositions},set:function(t){this._deltaPositions=t,this._dirty|=1,this._dataChangeManager.dispatch(this._dirty,this)}},{key:"deltaNormals",get:function(){return this._deltaNormals},set:function(t){this._deltaNormals=t,this._dirty|=2,this._dataChangeManager.dispatch(this._dirty,this)}},{key:"deltaTangents",get:function(){return this._deltaTangents},set:function(t){this._deltaTangents=t,this._dirty|=4,this._dataChangeManager.dispatch(this._dirty,this)}}]),n}(),go;(function(n){n[n.Position=1]="Position",n[n.Normal=2]="Normal",n[n.Tangent=4]="Tangent",n[n.All=7]="All"})(go||(go={}));var Ho=function(){function n(i){this._useBlendShapeNormal=!0,this._useBlendShapeTangent=!0,this._layoutChangeManager=new zr,this._dataChangeManager=new zr,this._frames=[],this.name=i,this._frameDataChangeListener=this._frameDataChangeListener.bind(this)}var s=n.prototype;return s.addFrame=function(t,e,r,a){if(typeof t=="number"){var o=new fc(t,e,r,a);return this._addFrame(o),o}else this._addFrame(t)},s.clearFrames=function(){for(var t=this._frames,e=0,r=t.length;e<r;e++)t[e]._dataChangeManager.removeListener(this._frameDataChangeListener);t.length=0,this._updateUseNormalAndTangent(!0,!0),this._dataChangeManager.dispatch()},s._releaseData=function(){for(var t=this._frames,e=0,r=t.length;e<r;e++)t[e]._releaseData()},s._addFrame=function(t){var e=this._frames,r=e.length;if(r>0&&t.deltaPositions.length!==e[r-1].deltaPositions.length)throw"Frame's deltaPositions length must same with before frame deltaPositions length.";this._frames.push(t),this._frameDataChangeListener(go.All,t),t._dataChangeManager.addListener(this._frameDataChangeListener)},s._updateUseNormalAndTangent=function(t,e){var r=this._useBlendShapeNormal&&t,a=this._useBlendShapeTangent&&e;(this._useBlendShapeNormal!==r||this._useBlendShapeTangent!==a)&&(this._useBlendShapeNormal=r,this._useBlendShapeTangent=a,this._layoutChangeManager.dispatch(0,this))},s._frameDataChangeListener=function(t,e){this._updateUseNormalAndTangent(!!e.deltaNormals,!!e.deltaTangents),this._dataChangeManager.dispatch()},q(n,[{key:"frames",get:function(){return this._frames}}]),n}(),Wo=function(n){W(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.setVertexElements=function(e){this._setVertexElements(e)},i.setVertexBufferBinding=function(e,r,a){r===void 0&&(r=0),a===void 0&&(a=0);var o=e,l=o.buffer!==void 0;l||(o=new $n(e,r));var c=this._primitive.vertexBufferBindings;c.length<=a&&(c.length=a+1),this._setVertexBufferBinding(l?r:a,o)},i.setVertexBufferBindings=function(e,r){r===void 0&&(r=0);var a=this._primitive.vertexBufferBindings,o=e.length,l=r+o;a.length<l&&(a.length=l);for(var c=0;c<o;c++)this._setVertexBufferBinding(r+c,e[c])},i.setIndexBufferBinding=function(e,r){var a=e;if(a){var o=a.buffer!==void 0;o||(a=new Ua(e,r))}this._setIndexBufferBinding(a)},q(s,[{key:"instanceCount",get:function(){return this._primitive.instanceCount},set:function(e){this._primitive.instanceCount=e}},{key:"vertexBufferBindings",get:function(){return this._primitive.vertexBufferBindings}},{key:"indexBufferBinding",get:function(){return this._primitive.indexBufferBinding}},{key:"vertexElements",get:function(){return this._primitive.vertexElements}}]),s}(Go),Rt=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._enableVertexColor=!1,e._onMeshChanged=e._onMeshChanged.bind(ue(e)),e}var i=s.prototype;return i._onDestroy=function(){var e=this._mesh;e&&(e.destroyed||this._addResourceReferCount(e,-1),e._updateFlagManager.removeListener(this._onMeshChanged),this._mesh=null),n.prototype._onDestroy.call(this)},i._cloneTo=function(e,r,a){n.prototype._cloneTo.call(this,e,r,a),e.mesh=this._mesh},i._prepareRender=function(e){if(!this._mesh){ve.error("mesh is null.");return}if(this._mesh.destroyed){ve.error("mesh is destroyed.");return}n.prototype._prepareRender.call(this,e)},i._updateBounds=function(e){var r=this._mesh;if(r){var a=r.bounds,o=this._entity.transform.worldMatrix;nr.transform(a,o,e)}else e.min.set(0,0,0),e.max.set(0,0,0)},i._render=function(e){var r=this._mesh;if(this._dirtyUpdateFlag&2){var a=this.shaderData,o=r._primitive.vertexElements;a.disableMacro(s._uvMacro),a.disableMacro(s._uv1Macro),a.disableMacro(s._normalMacro),a.disableMacro(s._tangentMacro),a.disableMacro(s._enableVertexColorMacro);for(var l=0,c=o.length;l<c;l++)switch(o[l].attribute){case"TEXCOORD_0":a.enableMacro(s._uvMacro);break;case"TEXCOORD_1":a.enableMacro(s._uv1Macro);break;case"NORMAL":a.enableMacro(s._normalMacro);break;case"TANGENT":a.enableMacro(s._tangentMacro);break;case"COLOR_0":this._enableVertexColor&&a.enableMacro(s._enableVertexColorMacro);break}this._dirtyUpdateFlag&=-3}for(var _=this._materials,u=r.subMeshes,d=e.camera._renderPipeline,h=this._engine._renderDataPool,f=0,v=u.length;f<v;f++){var p=_[f];if(!!p){(p.destroyed||p.shader.destroyed)&&(p=this.engine._meshMagentaMaterial);var g=h.getFromPool();g.setX(this,p,r._primitive,u[f]),d.pushRenderData(e,g)}}},i._setMesh=function(e){var r=this._mesh;r&&(this._addResourceReferCount(r,-1),r._updateFlagManager.removeListener(this._onMeshChanged)),e&&(this._addResourceReferCount(e,1),e._updateFlagManager.addListener(this._onMeshChanged),this._dirtyUpdateFlag|=3),this._mesh=e},i._onMeshChanged=function(e){e&Ri.Bounds&&(this._dirtyUpdateFlag|=$e.WorldVolume),e&Ri.VertexElements&&(this._dirtyUpdateFlag|=2)},q(s,[{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&this._setMesh(e)}},{key:"enableVertexColor",get:function(){return this._enableVertexColor},set:function(e){e!==this._enableVertexColor&&(this._dirtyUpdateFlag|=2,this._enableVertexColor=e)}}]),s}(be);(function(){Rt._uvMacro=ie.getByName("RENDERER_HAS_UV")})();(function(){Rt._uv1Macro=ie.getByName("RENDERER_HAS_UV1")})();(function(){Rt._normalMacro=ie.getByName("RENDERER_HAS_NORMAL")})();(function(){Rt._tangentMacro=ie.getByName("RENDERER_HAS_TANGENT")})();(function(){Rt._enableVertexColorMacro=ie.getByName("RENDERER_ENABLE_VERTEXCOLOR")})();R([I],Rt.prototype,"_mesh",void 0);R([I],Rt.prototype,"_onMeshChanged",null);var fs;(function(n){n[n.VertexElementMacro=2]="VertexElementMacro",n[n.All=3]="All"})(fs||(fs={}));var ka;(function(n){n[n.Depth=27]="Depth",n[n.Stencil=28]="Stencil",n[n.DepthStencil=29]="DepthStencil",n[n.Depth16=30]="Depth16",n[n.Depth24=31]="Depth24",n[n.Depth32=32]="Depth32",n[n.Depth24Stencil8=33]="Depth24Stencil8",n[n.Depth32Stencil8=34]="Depth32Stencil8"})(ka||(ka={}));var Dr;(function(n){n[n.PositiveX=0]="PositiveX",n[n.NegativeX=1]="NegativeX",n[n.PositiveY=2]="PositiveY",n[n.NegativeY=3]="NegativeY",n[n.PositiveZ=4]="PositiveZ",n[n.NegativeZ=5]="NegativeZ"})(Dr||(Dr={}));var Cr;(function(n){n[n.Never=0]="Never",n[n.Less=1]="Less",n[n.Equal=2]="Equal",n[n.LessEqual=3]="LessEqual",n[n.Greater=4]="Greater",n[n.NotEqual=5]="NotEqual",n[n.GreaterEqual=6]="GreaterEqual",n[n.Always=7]="Always"})(Cr||(Cr={}));var va;(function(n){n[n.Static=0]="Static",n[n.Dynamic=1]="Dynamic"})(va||(va={}));var yt;(function(n){n[n.Clamp=0]="Clamp",n[n.Repeat=1]="Repeat",n[n.Mirror=2]="Mirror"})(yt||(yt={}));var ea=function(n){W(s,n);function s(t,e,r,a,o,l){o===void 0&&(o=G.Depth),l===void 0&&(l=1);var c;if(c=n.call(this,t)||this,c._depthFormat=null,c._autoGenerateMipmaps=!0,c._depthTexture=null,c._width=e,c._height=r,c._antiAliasing=l,c._depth=o,a){for(var _=ft(a,Array)?a.slice():[a],u=0,d=_.length;u<d;u++){var h=_[u];if(h._isDepthTexture)throw"Render texture can't use depth format.";h._addReferCount(1)}c._colorTextures=_}else c._colorTextures=[];if(ft(o,Kr)){if(!o._isDepthTexture)throw"Depth texture must use depth format.";c._depthTexture=o,c._depthTexture._addReferCount(1),c._depthFormat=o.format}else typeof o=="number"&&(c._depthFormat=o);return c._platformRenderTarget=t._hardwareRenderer.createPlatformRenderTarget(ue(c)),c}var i=s.prototype;return i.getColorTexture=function(e){e===void 0&&(e=0);var r;return(r=this._colorTextures[e])!=null?r:null},i.generateMipmaps=function(){if(this._autoGenerateMipmaps){for(var e=this._colorTextures,r=0,a=e.length;r<a;r++){var o=e[r];o.generateMipmaps()}this._depthTexture&&this._depthTexture.generateMipmaps()}},i._onDestroy=function(){var e;n.prototype._onDestroy.call(this),this._platformRenderTarget.destroy();for(var r=this,a=r._colorTextures,o=0,l=a.length;o<l;o++)a[o]._addReferCount(-1);a.length=0,(e=this._depthTexture)==null||e._addReferCount(-1),this._depthTexture=null,this._depth=null},i._blitRenderTarget=function(){this._platformRenderTarget.blitRenderTarget()},i._rebuild=function(){this._platformRenderTarget=this._engine._hardwareRenderer.createPlatformRenderTarget(this)},q(s,[{key:"autoGenerateMipmaps",get:function(){return this._autoGenerateMipmaps},set:function(e){this._autoGenerateMipmaps=e}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorTextureCount",get:function(){return this._colorTextures.length}},{key:"depthTexture",get:function(){return this._depthTexture}},{key:"antiAliasing",get:function(){return this._antiAliasing}}]),s}(Ji),bt=function(n){W(s,n);function s(t,e,r,a,o,l){a===void 0&&(a=G.R8G8B8A8),o===void 0&&(o=!0),l===void 0&&(l=va.Static);var c;return c=n.call(this,t)||this,c._mipmap=o,c._width=e,c._height=r,c._usage=l,c._format=a,c._mipmapCount=c._getMipmapCount(),c._isDepthTexture=a==G.Depth||a==G.DepthStencil||a==G.Depth16||a==G.Depth24||a==G.Depth32||a==G.Depth24Stencil8||a==G.Depth32Stencil8,c._platformTexture=t._hardwareRenderer.createPlatformTexture2D(ue(c)),c.filterMode=c._isIntFormat()?ot.Point:ot.Bilinear,c.wrapModeU=c.wrapModeV=yt.Repeat,c}var i=s.prototype;return i.setPixelBuffer=function(e,r,a,o,l,c){r===void 0&&(r=0),a===void 0&&(a=0),o===void 0&&(o=0),this._platformTexture.setPixelBuffer(e,r,a,o,l,c),this._isContentLost=!1},i.setImageSource=function(e,r,a,o,l,c){r===void 0&&(r=0),a===void 0&&(a=!1),o===void 0&&(o=!1),l===void 0&&(l=0),c===void 0&&(c=0),this._platformTexture.setImageSource(e,r,a,o,l,c),this._isContentLost=!1},i.getPixelBuffer=function(e,r,a,o,l,c){var _=arguments.length;_===1?this._platformTexture.getPixelBuffer(0,0,this._width,this._height,0,e):_===2?this._platformTexture.getPixelBuffer(0,0,this._width>>e,this._height>>e,e,r):_===5?this._platformTexture.getPixelBuffer(e,r,a,o,0,l):_===6&&this._platformTexture.getPixelBuffer(e,r,a,o,l,c)},i._rebuild=function(){this._platformTexture=this._engine._hardwareRenderer.createPlatformTexture2D(this),n.prototype._rebuild.call(this)},s}(Kr),Xo=function(n){W(s,n);function s(t,e,r,a,o,l){o===void 0&&(o=G.R8G8B8A8),l===void 0&&(l=!0);var c;return c=n.call(this,t)||this,c._mipmap=l,c._width=e,c._height=r,c._length=a,c._format=o,c._mipmapCount=c._getMipmapCount(),c._platformTexture=t._hardwareRenderer.createPlatformTexture2DArray(ue(c)),c.filterMode=ot.Bilinear,c.wrapModeU=c.wrapModeV=yt.Repeat,c}var i=s.prototype;return i.setPixelBuffer=function(e,r,a,o,l,c,_,u){a===void 0&&(a=0),o===void 0&&(o=0),l===void 0&&(l=0),this._platformTexture.setPixelBuffer(e,r,a,o,l,c,_,u),this._isContentLost=!1},i.setImageSource=function(e,r,a,o,l,c,_){a===void 0&&(a=0),o===void 0&&(o=!1),l===void 0&&(l=!1),c===void 0&&(c=0),_===void 0&&(_=0),this._platformTexture.setImageSource(e,r,a,o,l,c,_),this._isContentLost=!1},i.getPixelBuffer=function(e,r,a,o,l,c,_){var u=arguments.length;u===1?this._platformTexture.getPixelBuffer(e,0,0,this._width,this._height,0,r):u===2?this._platformTexture.getPixelBuffer(e,0,0,this._width>>r,this._height>>r,r,a):u===5?this._platformTexture.getPixelBuffer(e,r,a,o,l,0,c):u===6&&this._platformTexture.getPixelBuffer(e,r,a,o,l,c,_)},i._rebuild=function(){this._platformTexture=this._engine._hardwareRenderer.createPlatformTexture2DArray(this),n.prototype._rebuild.call(this)},q(s,[{key:"length",get:function(){return this._length}}]),s}(Kr),tr=function(n){W(s,n);function s(t,e,r,a){r===void 0&&(r=G.R8G8B8A8),a===void 0&&(a=!0);var o;return o=n.call(this,t)||this,o._mipmap=a,o._width=e,o._height=e,o._format=r,o._mipmapCount=o._getMipmapCount(),o._platformTexture=t._hardwareRenderer.createPlatformTextureCube(ue(o)),o.filterMode=ot.Bilinear,o.wrapModeU=o.wrapModeV=yt.Clamp,o}var i=s.prototype;return i.setPixelBuffer=function(e,r,a,o,l,c,_){a===void 0&&(a=0),o===void 0&&(o=0),l===void 0&&(l=0),this._platformTexture.setPixelBuffer(e,r,a,o,l,c,_),this._isContentLost=!1},i.setImageSource=function(e,r,a,o,l,c,_){a===void 0&&(a=0),o===void 0&&(o=!1),l===void 0&&(l=!1),c===void 0&&(c=0),_===void 0&&(_=0),this._platformTexture.setImageSource(e,r,a,o,l,c,_),this._isContentLost=!1},i.getPixelBuffer=function(e,r,a,o,l,c,_){var u=arguments.length;u===2?this._platformTexture.getPixelBuffer(e,0,0,this._width,this._height,0,r):u===3?this._platformTexture.getPixelBuffer(e,0,0,this._width>>r,this._height>>r,r,a):u===6?this._platformTexture.getPixelBuffer(e,r,a,o,l,0,c):u===7&&this._platformTexture.getPixelBuffer(e,r,a,o,l,c,_)},i._rebuild=function(){this._platformTexture=this._engine._hardwareRenderer.createPlatformTextureCube(this),n.prototype._rebuild.call(this)},s}(Kr),Fn=function(){function n(i,t){this._blendShapeCount=0,this._blendShapes=[],this._subDataDirtyFlags=[],this._vertexBuffers=[],this._uniformOccupiesCount=0,this._bufferBindingOffset=-1,this._vertexElementOffset=0,this._useBlendNormal=!1,this._useBlendTangent=!1,this._vertexElementCount=0,this._storeInVertexBufferInfo=[],this._maxCountSingleVertexBuffer=0,this._lastHostCreatedInfo=new ae,this._canUseTextureStoreData=!0,this._dataTextureInfo=new w,this._engine=i,this._modelMesh=t,this._canUseTextureStoreData=this._engine._hardwareRenderer.capability.canUseFloatTextureBlendShape,this._updateLayoutChange=this._updateLayoutChange.bind(this)}var s=n.prototype;return s._addBlendShape=function(t){this._blendShapes.push(t),this._blendShapeCount++,t._layoutChangeManager.addListener(this._updateLayoutChange),this._updateLayoutChange(0,t),this._subDataDirtyFlags.push(t._dataChangeManager.createFlag(Qi))},s._clearBlendShapes=function(){for(var t=this._blendShapes,e=0,r=t.length;e<r;e++)t[e]._layoutChangeManager.removeListener(this._updateLayoutChange);this._useBlendNormal=!1,this._useBlendTangent=!1,this._vertexElementCount=0,this._blendShapes.length=0,this._blendShapeCount=0;for(var a=this._subDataDirtyFlags,o=0,l=a.length;o<l;o++)a[o].destroy();a.length=0},s._updateShaderData=function(t,e){var r=this._blendShapeCount;if(r>0){if(t.enableMacro(n._blendShapeMacro),this._useTextureMode())t.enableMacro(n._blendShapeTextureMacro),t.setTexture(n._blendShapeTextureProperty,this._vertexTexture),t.setVector3(n._blendShapeTextureInfoProperty,this._dataTextureInfo),t.setFloatArray(n._blendShapeWeightsProperty,e.blendShapeWeights),t.enableMacro("RENDERER_BLENDSHAPE_COUNT",r.toString()),this._uniformOccupiesCount=r+1;else{var a=this._getVertexBufferModeSupportCount();if(r>a){var o=e._condensedBlendShapeWeights;o||(o=new Float32Array(a),e._condensedBlendShapeWeights=o),this._filterCondensedBlendShapeWeights(e.blendShapeWeights,o),t.setFloatArray(n._blendShapeWeightsProperty,o),this._modelMesh._primitive.enableVAO=!1,r=a}else t.setFloatArray(n._blendShapeWeightsProperty,e.blendShapeWeights),this._modelMesh._primitive.enableVAO=!0;t.disableMacro(n._blendShapeTextureMacro),t.disableMacro("RENDERER_BLENDSHAPE_COUNT"),this._uniformOccupiesCount=r}this._useBlendNormal?t.enableMacro(n._blendShapeNormalMacro):t.disableMacro(n._blendShapeNormalMacro),this._useBlendTangent?t.enableMacro(n._blendShapeTangentMacro):t.disableMacro(n._blendShapeTangentMacro)}else t.disableMacro(n._blendShapeMacro),t.disableMacro("RENDERER_BLENDSHAPE_COUNT")},s._useTextureMode=function(){return this._canUseTextureStoreData?this._blendShapeCount>this._getVertexBufferModeSupportCount():!1},s._isCreateHost=function(t){var e=this._lastHostCreatedInfo;return e.x!==this._blendShapeCount||!!e.y!==this._useBlendNormal||!!e.z!==this._useBlendTangent||e.w!==t},s._vertexElementsNeedUpdate=function(){var t=this._getVertexBufferModeSupportCount(),e=this._lastHostCreatedInfo;return Math.min(e.x,t)!==Math.min(this._blendShapeCount,t)||!!e.y!==this._useBlendNormal||!!e.z!==this._useBlendTangent},s._needUpdateData=function(){for(var t=this._subDataDirtyFlags,e=0,r=t.length;e<r;e++)if(t[e].flag)return!0;return!1},s._updateVertexBufferIndex=function(){if(this._bufferBindingOffset===-1){for(var t=this._modelMesh,e=t._internalVertexBufferIndex,r=t._primitive.vertexBufferBindings,a=0,o=Math.max(r.length,e+1);a<o&&!(!r[a]&&a!==e);a++);this._bufferBindingOffset=a}},s._addVertexElements=function(t){this._updateVertexBufferIndex();for(var e=this._vertexElementOffset,r=this._bufferBindingOffset,a=0,o=0,l=Math.min(this._blendShapeCount,this._getVertexBufferModeSupportCount());o<l;o++)t._setVertexElement(e++,new Me("POSITION_BS"+o,a,ee.Vector3,r)),a+=12,this._useBlendNormal&&(t._setVertexElement(e++,new Me("NORMAL_BS"+o,a,ee.Vector3,r)),a+=12),this._useBlendTangent&&(t._setVertexElement(e++,new Me("TANGENT_BS"+o,a,ee.Vector3,r)),a+=12);return e},s._update=function(t){var e=this._modelMesh.vertexCount,r=this._useTextureMode(),a=this._isCreateHost(e);a&&(r?this._createTextureArray(e):this._createVertexBuffers(e,t),this._lastHostCreatedInfo.set(this._blendShapeCount,+this._useBlendNormal,+this._useBlendTangent,e)),this._needUpdateData()&&(r?this._updateTextureArray(e,a):this._updateVertexBuffers(e,a))},s._releaseMemoryCache=function(){for(var t=this._blendShapes,e=0,r=t.length;e<r;e++)t[e]._releaseData();this._vertices=null},s._createVertexBuffers=function(t,e){var r=this,a=r._engine,o=r._modelMesh,l=r._blendShapeCount,c=r._vertexBuffers,_=this._vertexElementCount*3,u=_*4,d=Math.floor(255/u),h=Math.ceil(l/d),f=_*t*Math.min(d,l);c.length=h,this._vertices=new Float32Array(f),this._maxCountSingleVertexBuffer=d,this._storeInVertexBufferInfo.length=l;for(var v=this._bufferBindingOffset,p=0;p<h;p++){var g=h-1,y=p===g?l-g*d:d,m=y*u,x=m*t,S=e?tt.Static:tt.Dynamic,b=new ir(a,Nt.VertexBuffer,x,S);o._setVertexBufferBinding(v+p,new $n(b,m)),c[p]=b}},s._createTextureArray=function(t){var e=this._engine._hardwareRenderer.capability.maxTextureSize,r=this._vertexElementCount,a=r*t,o=1;a>e&&(o=Math.ceil(a/e),a=e);var l=this._vertexTexture,c=this._blendShapes.length;l&&l.destroy(),l=new Xo(this._engine,a,o,c,G.R32G32B32A32,!1),l.filterMode=ot.Point,this._vertices=new Float32Array(c*a*o*4),this._vertexTexture=l,this._dataTextureInfo.set(r,a,o)},s._updateVertexBuffers=function(t,e){for(var r=this,a=r._blendShapes,o=r._maxCountSingleVertexBuffer,l=this,c=l._vertices,_=l._vertexBuffers,u=l._storeInVertexBufferInfo,d=this._subDataDirtyFlags,h=this._vertexElementCount*3,f=h*4,v=this._bufferBindingOffset,p=0,g=a.length;p<g;p++){var y=d[p];if(e||y.flag){var m=a[p].frames,x=m.length,S=m[x-1];if(x>0&&S.deltaPositions.length!==t)throw"BlendShape frame deltaPositions length must same with mesh vertexCount.";var b=Math.floor(p/o),A=p%o,C=_[b],E=C.byteLength/(t*4),T=A*h,B=u[p];B||(u[p]=B=new $),B.set(v+b,A*f);for(var M=S.deltaPositions,P=0;P<t;P++){var V=T+E*P,N=M[P];N&&(c[V]=N.x,c[V+1]=N.y,c[V+2]=N.z)}if(T+=3,this._useBlendNormal){var F=S.deltaNormals;if(F)for(var O=0;O<t;O++){var D=T+E*O,z=F[O];z&&(c[D]=z.x,c[D+1]=z.y,c[D+2]=z.z)}T+=3}if(this._useBlendTangent){var U=S.deltaTangents;if(U)for(var Y=0;Y<t;Y++){var K=T+E*Y,H=U[Y];H&&(c[K]=H.x,c[K+1]=H.y,c[K+2]=H.z)}T+=3}(A===o-1||p===g-1)&&C.setData(c,0,0,C.byteLength/4),y.flag=!1}}},s._updateTextureArray=function(t,e){for(var r=this,a=r._blendShapes,o=r._vertexTexture,l=r._vertices,c=r._subDataDirtyFlags,_=0,u=a.length;_<u;_++){var d=c[_],h=o.width*o.height*4;if(e||d.flag){var f=a[_].frames,v=f.length,p=f[v-1];if(v>0&&p.deltaPositions.length!==t)throw"BlendShape frame deltaPositions length must same with mesh vertexCount.";for(var g=p.deltaPositions,y=p.deltaNormals,m=p.deltaTangents,x=_*h,S=0;S<t;S++){var b=g[S];if(l[x]=b.x,l[x+1]=b.y,l[x+2]=b.z,x+=4,y){var A=y[S];l[x]=A.x,l[x+1]=A.y,l[x+2]=A.z,x+=4}if(m){var C=m[S];l[x]=C.x,l[x+1]=C.y,l[x+2]=C.z,x+=4}}d.flag=!1}}o.setPixelBuffer(0,l)},s._updateLayoutChange=function(t,e){var r=this._blendShapeCount>1,a=1,o=e._useBlendShapeNormal,l=e._useBlendShapeTangent;r&&(o&&(o=this._useBlendNormal),l&&(l=this._useBlendTangent)),o&&a++,l&&a++,this._useBlendNormal=o,this._useBlendTangent=l,this._vertexElementCount=a},s._attributeModeUpdateVertexElement=function(t,e,r,a){var o=this._vertexElementOffset+this._vertexElementCount*a,l=e[r],c=l.x,_=l.y,u=t[o];if(u.bindingIndex=c,u.offset=_,this._useBlendNormal){var d=t[++o];_+=12,d.bindingIndex=c,d.offset=_}if(this._useBlendTangent){var h=t[++o];_+=12,h.bindingIndex=c,h.offset=_}},s._getVertexBufferModeSupportCount=function(){return this._useBlendNormal&&this._useBlendTangent?2:this._useBlendNormal||this._useBlendTangent?4:8},s._filterCondensedBlendShapeWeights=function(t,e){for(var r=e.length,a=this._modelMesh._primitive.vertexElements,o=this._storeInVertexBufferInfo,l=Number.POSITIVE_INFINITY,c,_=0,u=Math.min(t.length,this._blendShapeCount);_<u;_++){var d=t[_];if(_<r)this._attributeModeUpdateVertexElement(a,o,_,_),e[_]=d,d<l&&(l=d,c=_);else if(d>l){this._attributeModeUpdateVertexElement(a,o,_,c),e[c]=d,l=Number.POSITIVE_INFINITY;for(var h=0;h<r;h++){var f=e[h];f<l&&(l=f,c=h)}}}},n}();(function(){Fn._blendShapeMacro=ie.getByName("RENDERER_HAS_BLENDSHAPE")})();(function(){Fn._blendShapeTextureMacro=ie.getByName("RENDERER_BLENDSHAPE_USE_TEXTURE")})();(function(){Fn._blendShapeNormalMacro=ie.getByName("RENDERER_BLENDSHAPE_HAS_NORMAL")})();(function(){Fn._blendShapeTangentMacro=ie.getByName("RENDERER_BLENDSHAPE_HAS_TANGENT")})();(function(){Fn._blendShapeWeightsProperty=L.getByName("renderer_BlendShapeWeights")})();(function(){Fn._blendShapeTextureProperty=L.getByName("renderer_BlendShapeTexture")})();(function(){Fn._blendShapeTextureInfoProperty=L.getByName("renderer_BlendShapeTextureInfo")})();var X;(function(n){n.Position="POSITION",n.Normal="NORMAL",n.Color="COLOR_0",n.Tangent="TANGENT",n.BoneWeight="WEIGHTS_0",n.BoneIndex="JOINTS_0",n.UV="TEXCOORD_0",n.UV1="TEXCOORD_1",n.UV2="TEXCOORD_2",n.UV3="TEXCOORD_3",n.UV4="TEXCOORD_4",n.UV5="TEXCOORD_5",n.UV6="TEXCOORD_6",n.UV7="TEXCOORD_7"})(X||(X={}));var ct=function(n){W(s,n);function s(t,e){var r;return r=n.call(this,t)||this,r._internalVertexBufferIndex=-1,r._vertexCount=0,r._vertexCountDirty=!1,r._dataVersionCounter=0,r._positions=null,r._normals=null,r._colors=null,r._tangents=null,r._uv=null,r._uv1=null,r._uv2=null,r._uv3=null,r._uv4=null,r._uv5=null,r._uv6=null,r._uv7=null,r._boneWeights=null,r._boneIndices=null,r._advancedElementUpdateFlag=0,r._advancedDataUpdateFlag=0,r._advancedVertexDataVersions=new Array(14),r._advancedDataSyncToBuffer=!1,r._internalVertexBufferStride=0,r._internalVertexBufferCreatedInfo=new w(0,0,-1),r._internalVertexElementsOffset=0,r._internalVertexElementsFlags=0,r._vertexBufferInfos=[],r._indices=null,r._indicesFormat=null,r._indicesChangeFlag=!1,r._accessible=!0,r.name=e,r._blendShapeManager=new Fn(t,ue(r)),r}var i=s.prototype;return i.setPositions=function(e){var r;if(!(!this._positions&&!e)){this._updateAdvancedVertexDataMarks(1,0),this._positions=e;var a;this._vertexCount=(a=(r=e)==null?void 0:r.length)!=null?a:0,this._vertexCountDirty=!1}},i.getPositions=function(){var e=this._getVertexElementData(this._positions,X.Position,0,this._readVector3VertexData);return this._positions=e,e},i.setNormals=function(e){this._beforeSetAdvancedVertexData(e,2,1),this._normals=e},i.getNormals=function(){var e=this._getVertexElementData(this._normals,X.Normal,1,this._readVector3VertexData);return this._normals=e,e},i.setColors=function(e){this._beforeSetAdvancedVertexData(e,4,2),this._colors=e},i.getColors=function(){var e=this._getVertexElementData(this._colors,X.Color,2,this._readColorVertexData);return this._colors=e,e},i.setBoneWeights=function(e){this._beforeSetAdvancedVertexData(e,16,4),this._boneWeights=e},i.getBoneWeights=function(){var e=this._getVertexElementData(this._boneWeights,X.BoneWeight,4,this._readVector4VertexData);return this._boneWeights=e,e},i.setBoneIndices=function(e){this._beforeSetAdvancedVertexData(e,32,5),this._boneIndices=e},i.getBoneIndices=function(){var e=this._getVertexElementData(this._boneIndices,X.BoneIndex,5,this._readVector4VertexData);return this._boneIndices=e,e},i.setTangents=function(e){this._beforeSetAdvancedVertexData(e,8,3),this._tangents=e},i.getTangents=function(){var e=this._getVertexElementData(this._tangents,X.Tangent,3,this._readVector4VertexData);return this._tangents=e,e},i.setUVs=function(e,r){switch(r=r??0,r){case 0:this._beforeSetAdvancedVertexData(e,64,6),this._uv=e;break;case 1:this._beforeSetAdvancedVertexData(e,128,7),this._uv1=e;break;case 2:this._beforeSetAdvancedVertexData(e,256,8),this._uv2=e;break;case 3:this._beforeSetAdvancedVertexData(e,512,9),this._uv3=e;break;case 4:this._beforeSetAdvancedVertexData(e,1024,10),this._uv4=e;break;case 5:this._beforeSetAdvancedVertexData(e,2048,11),this._uv5=e;break;case 6:this._beforeSetAdvancedVertexData(e,4096,12),this._uv6=e;break;case 7:this._beforeSetAdvancedVertexData(e,8192,13),this._uv7=e;break;default:throw"The index of channel needs to be in range [0 - 7]."}},i.getUVs=function(e){switch(e=e??0,e){case 0:var r=this._getVertexElementData(this._uv,X.UV,6,this._readVector2VertexData);return this._uv=r,r;case 1:var a=this._getVertexElementData(this._uv1,X.UV1,7,this._readVector2VertexData);return this._uv1=a,a;case 2:var o=this._getVertexElementData(this._uv2,X.UV2,8,this._readVector2VertexData);return this._uv2=o,o;case 3:var l=this._getVertexElementData(this._uv3,X.UV3,9,this._readVector2VertexData);return this._uv3=l,l;case 4:var c=this._getVertexElementData(this._uv4,X.UV4,10,this._readVector2VertexData);return this._uv4=c,c;case 5:var _=this._getVertexElementData(this._uv5,X.UV5,11,this._readVector2VertexData);return this._uv5=_,_;case 6:var u=this._getVertexElementData(this._uv6,X.UV6,12,this._readVector2VertexData);return this._uv6=u,u;case 7:var d=this._getVertexElementData(this._uv7,X.UV7,13,this._readVector2VertexData);return this._uv7=d,d}throw"The index of channel needs to be in range [0 - 7]."},i.setIndices=function(e){this._indices!==e&&(this._indices=e,ft(e,Uint8Array)?this._indicesFormat=Et.UInt8:ft(e,Uint16Array)?this._indicesFormat=Et.UInt16:ft(e,Uint32Array)&&(this._indicesFormat=Et.UInt32)),this._indicesChangeFlag=!0},i.getIndices=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._indices},i.setVertexElements=function(e){this._clearVertexElements();for(var r=e.length,a=0;a<r;a++)this._addVertexElement(e[a]);var o=this._primitive._vertexElementMap;o[X.Position]||this.setPositions(null),o[X.Normal]||this.setNormals(null),o[X.Color]||this.setColors(null),o[X.BoneWeight]||this.setBoneWeights(null),o[X.BoneIndex]||this.setBoneIndices(null),o[X.Tangent]||this.setTangents(null),o[X.UV]||this.setUVs(null,0),o[X.UV1]||this.setUVs(null,1),o[X.UV2]||this.setUVs(null,2),o[X.UV3]||this.setUVs(null,3),o[X.UV4]||this.setUVs(null,4),o[X.UV5]||this.setUVs(null,5),o[X.UV6]||this.setUVs(null,6),o[X.UV7]||this.setUVs(null,7);var l=this._internalVertexBufferCreatedInfo.z;if(l!==-1){var c;(c=this._primitive.vertexBufferBindings[l])==null||c.buffer.destroy(),this._setVertexBufferBinding(l,null),this._internalVertexBufferCreatedInfo.z=-1}this._internalVertexBufferStride=0,this._internalVertexElementsOffset=r,this._advancedElementUpdateFlag=0,this._vertexCountDirty=!0,this._blendShapeManager._bufferBindingOffset=-1,this._blendShapeManager._vertexElementOffset=r},i.setVertexBufferBinding=function(e,r,a){r===void 0&&(r=0),a===void 0&&(a=0);var o=e,l=o.buffer!==void 0;l||(o=new $n(e,r));var c=l?r:a,_=this._primitive.vertexBufferBindings,u=this._vertexBufferInfos,d=c+1;_.length<d&&(_.length=d,u.length=d),this._setVertexBufferBinding(c,o),c===this._internalVertexBufferIndex&&(this._internalVertexBufferIndex=-1),c===this._blendShapeManager._bufferBindingOffset&&(this._blendShapeManager._bufferBindingOffset=-1),this._vertexCountDirty=!0},i.setVertexBufferBindings=function(e,r){r===void 0&&(r=0);var a=e.length,o=this._primitive.vertexBufferBindings,l=this._vertexBufferInfos,c=r+a;o.length<c&&(o.length=c,l.length=c);for(var _=0;_<a;_++){var u=r+_;this._setVertexBufferBinding(u,e[_]),u===this._internalVertexBufferIndex&&(this._internalVertexBufferIndex=-1),u===this._blendShapeManager._bufferBindingOffset&&(this._blendShapeManager._bufferBindingOffset=-1)}this._vertexCountDirty=!0},i.getVertexElement=function(e){return this._updateVertexElements(),this._primitive._vertexElementMap[e]},i.addBlendShape=function(e){this._blendShapeManager._addBlendShape(e)},i.clearBlendShapes=function(){this._blendShapeManager._clearBlendShapes()},i.getBlendShapeName=function(e){var r=this._blendShapeManager._blendShapes;return r[e].name},i.uploadData=function(e){if(this._updateVertexElements(),this._advancedDataSyncToBuffer=!0,this._updateInternalVertexBuffer(e),this._advancedDataUpdateFlag&65535){this._updateAdvancedVertices();for(var r=this._vertexBufferInfos,a=this._primitive.vertexBufferBindings,o=0,l=a.length;o<l;o++){var c,_=r[o];if((c=_)!=null&&c.uploadAdvancedData){var u,d=(u=a[o])==null?void 0:u.buffer;d.setData(d.data),_.uploadAdvancedData=!1}}}if(this._advancedDataSyncToBuffer=!1,this._indicesChangeFlag){var h,f=this,v=f._indices,p=(h=this._primitive.indexBufferBinding)==null?void 0:h._buffer;if(v)if(!p||v.byteLength!=p.byteLength){var g;(g=p)==null||g.destroy();var y=new ir(this._engine,Nt.IndexBuffer,v);this._setIndexBufferBinding(new Ua(y,this._indicesFormat))}else p.setData(v),this._primitive.indexBufferBinding._format!==this._indicesFormat&&this._setIndexBufferBinding(new Ua(p,this._indicesFormat));else p&&(p.destroy(),this._setIndexBufferBinding(null));this._indicesChangeFlag=!1}var m=this._blendShapeManager;m._blendShapeCount>0&&m._update(e),e&&(this._accessible=!1,this._releaseCache(!1))},i.calculateTangents=function(){var e=this.getPositions(),r=this.getNormals(),a=this.getUVs();if(!r||!a)throw"Set normal and uv before calculation.";for(var o=this,l=o._indices,c=o.vertexCount,_=s._tempVec0,u=s._tempVec1,d=s._tempVec2,h=s._tempVec3,f=s._tempVec4,v=l?l.length/3:e.length/3,p=new Array(c),g=new Array(c),y=0;y<c;y++)p[y]=new ae,g[y]=new w;for(var m=0;m<v;m++){var x=3*m,S=3*m+1,b=3*m+2;l&&(x=l[x],S=l[S],b=l[b]);var A=e[x],C=e[S],E=e[b],T=a[x],B=a[S],M=a[b];w.subtract(C,A,_),w.subtract(E,A,u);var P=B.x-T.x,V=M.x-T.x,N=B.y-T.y,F=M.y-T.y,O=1/(P*F-V*N);w.scale(_,F*O,d),w.scale(u,N*O,f),w.subtract(d,f,d),w.scale(u,P*O,h),w.scale(_,V*O,f),w.subtract(h,f,h);var D=p[x];D.set(D.x+d.x,D.y+d.y,D.z+d.z,1),D=p[S],D.set(D.x+d.x,D.y+d.y,D.z+d.z,1),D=p[b],D.set(D.x+d.x,D.y+d.y,D.z+d.z,1),g[x].add(h),g[S].add(h),g[b].add(h)}for(var z=0;z<c;z++){var U=r[z],Y=g[z],K=p[z];d.set(K.x,K.y,K.z),w.cross(d,Y,f);var H=w.dot(f,U)>0?1:-1;w.scale(U,w.dot(d,U),f),w.subtract(d,f,d),d.normalize(),K.set(d.x,d.y,d.z,H)}this.setTangents(p)},i._setVertexBufferBinding=function(e,r){var a=this,o=this._primitive.vertexBufferBindings,l=this._vertexBufferInfos,c=function(){a._advancedDataSyncToBuffer||(l[e].dataVersion=a._dataVersionCounter++)},_=o[e];if(_&&_.buffer._dataUpdateManager.removeListener(c),n.prototype._setVertexBufferBinding.call(this,e,r),r){var u,d;r.buffer._dataUpdateManager.addListener(c),((u=l)[d=e]||(u[d]=new bu)).reset(),c()}else e+1==o.length&&o.length--},i._getVertexTypedArray=function(e,r){switch(r){case Ue.BYTE:return new Int8Array(e);case Ue.UNSIGNED_BYTE:return new Uint8Array(e);case Ue.SHORT:return new Int16Array(e);case Ue.UNSIGNED_SHORT:return new Uint16Array(e);case Ue.FLOAT:return new Float32Array(e)}},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._releaseCache(!0)},i._getVertexElementData=function(e,r,a,o){var l=this._advancedVertexDataVersions,c,_=(c=l[a])!=null?c:-1,u=this._primitive._vertexElementMap[r],d=u?this._vertexBufferInfos[u.bindingIndex].dataVersion:-1;return _>=d?e:(l[a]=d,o.call(this,r))},i._beforeSetAdvancedVertexData=function(e,r,a){if(e&&e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._updateAdvancedVertexDataMarks(r,a)},i._updateAdvancedVertexDataMarks=function(e,r){this._advancedElementUpdateFlag|=e,this._advancedDataUpdateFlag|=e,this._advancedVertexDataVersions[r]=this._dataVersionCounter++},i._updateInternalVertexBuffer=function(e){var r=this._internalVertexBufferStride,a=this.vertexCount,o=this._internalVertexBufferCreatedInfo,l=r*a;if(o.x*o.y!==l){var c=o.z;if(c!==-1){var _;(_=this._primitive.vertexBufferBindings[c])==null||_.buffer.destroy(),this._setVertexBufferBinding(c,null)}var u=this._internalVertexBufferIndex,d=r*this.vertexCount>0;if(d){this._advancedDataUpdateFlag|=this._internalVertexElementsFlags;var h=e?tt.Static:tt.Dynamic,f=new ir(this._engine,Nt.VertexBuffer,l,h,!0);this._setVertexBufferBinding(u,new $n(f,r))}o.set(r,a,d?u:-1)}},i._readVector2VertexData=function(e){return this._readVertexData(e,function(r,a){return new $(r[a],r[a+1])})},i._readVector3VertexData=function(e){return this._readVertexData(e,function(r,a){return new w(r[a],r[a+1],r[a+2])})},i._readVector4VertexData=function(e){return this._readVertexData(e,function(r,a){return new ae(r[a],r[a+1],r[a+2],r[a+3])})},i._readColorVertexData=function(e){return this._readVertexData(e,function(r,a){return new j(r[a],r[a+1],r[a+2],r[a+3])})},i._readVertexData=function(e,r){var a,o=this._primitive,l=o._vertexElementMap[e];if(!l)return null;var c=o.vertexBufferBindings[l.bindingIndex],_=(a=c)==null?void 0:a.buffer;if(!_)return null;if(!_.readable)throw"Not allowed to access data while vertex buffer readable is false.";for(var u=this.vertexCount,d=l._formatMetaInfo,h=new Array(u),f=this._getVertexTypedArray(_.data.buffer,d.type),v=l.offset,p=c.stride,g=0;g<u;g++){var y=(g*p+v)/f.BYTES_PER_ELEMENT,m=r(f,y);d.normalized&&m.scale(d.normalizedScaleFactor),h[g]=m}return h},i._updateAdvancedVertexElement=function(e,r,a){var o=this._primitive,l=o._vertexElementMap;if(e){if(!l[r]){var c=this._getAttributeFormat(r),_=this._internalVertexBufferStride,u=this._getInternalVertexBufferIndex();this._addVertexElement(new Me(r,_,c,u)),this._internalVertexBufferStride+=this._getAttributeByteLength(r),this._internalVertexElementsFlags|=a,this._blendShapeManager._vertexElementOffset++}}else{var d=l[r];if(d){var h=this._primitive.vertexElements.indexOf(d);h>=this._internalVertexElementsOffset?(this._internalVertexBufferStride-=this._getAttributeByteLength(r),this._internalVertexElementsFlags&=~a):this._internalVertexElementsOffset--,this._blendShapeManager._vertexElementOffset--,this._removeVertexElement(h)}}},i._updateAdvancedVertexElements=function(){var e=this._advancedElementUpdateFlag;e&1&&this._updateAdvancedVertexElement(this._positions,X.Position,1),e&2&&this._updateAdvancedVertexElement(this._normals,X.Normal,2),e&4&&this._updateAdvancedVertexElement(this._colors,X.Color,4),e&16&&this._updateAdvancedVertexElement(this._boneWeights,X.BoneWeight,16),e&32&&this._updateAdvancedVertexElement(this._boneIndices,X.BoneIndex,32),e&8&&this._updateAdvancedVertexElement(this._tangents,X.Tangent,8),e&64&&this._updateAdvancedVertexElement(this._uv,X.UV,64),e&128&&this._updateAdvancedVertexElement(this._uv1,X.UV1,128),e&256&&this._updateAdvancedVertexElement(this._uv2,X.UV2,256),e&512&&this._updateAdvancedVertexElement(this._uv3,X.UV3,512),e&1024&&this._updateAdvancedVertexElement(this._uv4,X.UV4,1024),e&2048&&this._updateAdvancedVertexElement(this._uv5,X.UV5,2048),e&4096&&this._updateAdvancedVertexElement(this._uv6,X.UV6,4096),e&8192&&this._updateAdvancedVertexElement(this._uv7,X.UV7,8192)},i._updateVertexElements=function(){var e=this._primitive.vertexElements,r=this._blendShapeManager,a=e.length,o=r._vertexElementOffset;this._advancedElementUpdateFlag&65535&&(this._updateAdvancedVertexElements(),this._advancedElementUpdateFlag=0);var l=!r._useTextureMode()&&r._vertexElementsNeedUpdate();if(o!==r._vertexElementOffset||l&&r._blendShapeCount>0){var c=r._addVertexElements(this);c<a&&this._setVertexElementsLength(c)}},i._writeVector2AdvancedVertexData=function(e,r,a){this._writeAdvancedVertexData(e,r,function(o,l,c){var _=a[c];_&&(o[l]=_.x,o[l+1]=_.y)})},i._writeVector3AdvancedVertexData=function(e,r,a){this._writeAdvancedVertexData(e,r,function(o,l,c){var _=a[c];_&&(o[l]=_.x,o[l+1]=_.y,o[l+2]=_.z)})},i._writeVector4AdvancedVertexData=function(e,r,a){this._writeAdvancedVertexData(e,r,function(o,l,c){var _=a[c];_&&(o[l]=_.x,o[l+1]=_.y,o[l+2]=_.z,o[l+3]=_.w)})},i._writeColorAdvancedVertexData=function(e,r,a){this._writeAdvancedVertexData(e,r,function(o,l,c){var _=a[c];_&&(o[l]=_.r,o[l+1]=_.g,o[l+2]=_.b,o[l+3]=_.a)})},i._writeAdvancedVertexData=function(e,r,a){var o,l=this._primitive,c=l._vertexElementMap[e],_=c.bindingIndex,u=l.vertexBufferBindings[_],d=(o=u)==null?void 0:o.buffer;if(!!d){if(!d.readable)throw"Vertex buffer is not readable, can't write vertex data.";var h,f=(h=this._advancedVertexDataVersions[r])!=null?h:-1,v=this._vertexBufferInfos[_];if(f>v.dataVersion){for(var p=c._formatMetaInfo,g=this._getVertexTypedArray(d.data.buffer,p.type),y=c.offset,m=u.stride,x=g.BYTES_PER_ELEMENT,S=p.normalized,b=p.size,A=p.normalizedScaleFactor,C=0,E=this._vertexCount;C<E;C++){var T=(C*m+y)/x;if(a(g,T,C),S)for(var B=0;B<b;B++)g[T+B]/=A}v.uploadAdvancedData=!0}}},i._updateAdvancedVertices=function(){var e=this,r=e._positions,a=e._normals,o=e._colors,l=e._advancedDataUpdateFlag,c=e._boneWeights,_=e._boneIndices,u=e._tangents,d=e._uv,h=e._uv1,f=e._uv2,v=e._uv3,p=e._uv4,g=e._uv5,y=e._uv6,m=e._uv7;l&1&&this._writeVector3AdvancedVertexData(X.Position,0,r),a&&l&2&&this._writeVector3AdvancedVertexData(X.Normal,1,a),o&&l&4&&this._writeColorAdvancedVertexData(X.Color,2,o),c&&l&16&&this._writeVector4AdvancedVertexData(X.BoneWeight,4,c),_&&l&32&&this._writeVector4AdvancedVertexData(X.BoneIndex,5,_),u&&l&8&&this._writeVector4AdvancedVertexData(X.Tangent,3,u),d&&l&64&&this._writeVector2AdvancedVertexData(X.UV,6,d),h&&l&128&&this._writeVector2AdvancedVertexData(X.UV1,7,h),f&&l&256&&this._writeVector2AdvancedVertexData(X.UV2,8,f),v&&l&512&&this._writeVector2AdvancedVertexData(X.UV3,9,v),p&&l&1024&&this._writeVector2AdvancedVertexData(X.UV4,10,p),g&&l&2048&&this._writeVector2AdvancedVertexData(X.UV5,11,g),y&&l&4096&&this._writeVector2AdvancedVertexData(X.UV6,12,y),m&&l&8192&&this._writeVector2AdvancedVertexData(X.UV7,13,m),this._advancedDataUpdateFlag=0},i._getInternalVertexBufferIndex=function(){var e=this._internalVertexBufferIndex;if(e!==-1)return e;for(var r=0,a=this._primitive.vertexBufferBindings,o=a.length;r<o&&a[r];r++);return this._internalVertexBufferIndex=r,r},i._getAttributeFormat=function(e){switch(e){case X.Position:case X.Normal:return ee.Vector3;case X.Color:case X.BoneWeight:case X.Tangent:return ee.Vector4;case X.BoneIndex:return ee.UByte4;case X.UV:case X.UV1:case X.UV2:case X.UV3:case X.UV4:case X.UV5:case X.UV6:case X.UV7:return ee.Vector2}},i._getAttributeByteLength=function(e){switch(e){case X.Position:case X.Normal:return 12;case X.Color:case X.BoneWeight:case X.Tangent:return 16;case X.BoneIndex:return 4;case X.UV:case X.UV1:case X.UV2:case X.UV3:case X.UV4:case X.UV5:case X.UV6:case X.UV7:return 8}},i._releaseCache=function(e){if(this._positions=null,this._tangents=null,this._normals=null,this._colors=null,this._boneIndices=null,this._boneWeights=null,this._uv=null,this._uv1=null,this._uv2=null,this._uv3=null,this._uv4=null,this._uv5=null,this._uv6=null,this._uv7=null,this._indices=null,this._blendShapeManager._releaseMemoryCache(),!e){var r;(r=this._primitive.vertexBufferBindings[this._internalVertexBufferIndex])==null||r.buffer.markAsUnreadable();for(var a=this._dataVersionCounter++,o=this._vertexBufferInfos,l=0,c=o.length;l<c;l++){var _=o[l];_&&(_.dataVersion=a)}}},q(s,[{key:"vertexCount",get:function(){if(this._vertexCountDirty){var e=0,r=this._primitive._vertexElementMap[X.Position];if(r){var a=this._primitive.vertexBufferBindings[r.bindingIndex];a&&(e=a.buffer.byteLength/a.stride)}this._vertexCount=e,this._vertexCountDirty=!1}return this._vertexCount}},{key:"vertexElements",get:function(){return this._updateVertexElements(),this._primitive.vertexElements}},{key:"vertexBufferBindings",get:function(){return this._primitive.vertexBufferBindings}},{key:"blendShapes",get:function(){return this._blendShapeManager._blendShapes}},{key:"blendShapeCount",get:function(){return this._blendShapeManager._blendShapeCount}},{key:"accessible",get:function(){return this._accessible}}]),s}(Go);(function(){ct._tempVec0=new w})();(function(){ct._tempVec1=new w})();(function(){ct._tempVec2=new w})();(function(){ct._tempVec3=new w})();(function(){ct._tempVec4=new w})();var bu=function(){function n(){this.dataVersion=-1,this.uploadAdvancedData=!1}var s=n.prototype;return s.reset=function(){this.uploadAdvancedData=!1},n}(),vs;(function(n){n[n.None=0]="None",n[n.Position=1]="Position",n[n.Normal=2]="Normal",n[n.Color=4]="Color",n[n.Tangent=8]="Tangent",n[n.BoneWeight=16]="BoneWeight",n[n.BoneIndex=32]="BoneIndex",n[n.UV=64]="UV",n[n.UV1=128]="UV1",n[n.UV2=256]="UV2",n[n.UV3=512]="UV3",n[n.UV4=1024]="UV4",n[n.UV5=2048]="UV5",n[n.UV6=4096]="UV6",n[n.UV7=8192]="UV7",n[n.All=65535]="All"})(vs||(vs={}));var ps;(function(n){n[n.Position=0]="Position",n[n.Normal=1]="Normal",n[n.Color=2]="Color",n[n.Tangent=3]="Tangent",n[n.BoneWeight=4]="BoneWeight",n[n.BoneIndex=5]="BoneIndex",n[n.UV=6]="UV",n[n.UV1=7]="UV1",n[n.UV2=8]="UV2",n[n.UV3=9]="UV3",n[n.UV4=10]="UV4",n[n.UV5=11]="UV5",n[n.UV6=12]="UV6",n[n.UV7=13]="UV7"})(ps||(ps={}));var Rr=function(s){this.resource=s},Mn=function(n){W(s,n);function s(t,e){var r;return r=n.call(this,t)||this,r.primitiveInfo=e,r}var i=s.prototype;return i.restoreContent=function(){var e=this.primitiveInfo;switch(e.type){case 0:var r=e;it._setSphereData(this.resource,r.radius,r.segments,r.noLongerAccessible,!0,r.vertexBuffer);break;case 7:var a=e;it._setSubdivisionSurfaceSphereData(this.resource,a.radius,a.step,a.noLongerAccessible,!0,a.vertexBuffer);break;case 1:var o=e;it._setCuboidData(this.resource,o.width,o.height,o.depth,o.noLongerAccessible,!0,o.vertexBuffer);break;case 2:var l=e;it._setPlaneData(this.resource,l.width,l.height,l.horizontalSegments,l.verticalSegments,l.noLongerAccessible,!0,l.vertexBuffer);break;case 3:var c=e;it._setCylinderData(this.resource,c.radiusTop,c.radiusBottom,c.height,c.radialSegments,c.heightSegments,c.noLongerAccessible,!0,c.vertexBuffer);break;case 4:var _=e;it._setTorusData(this.resource,_.radius,_.tubeRadius,_.radialSegments,_.tubularSegments,_.arc,_.noLongerAccessible,!0,_.vertexBuffer);break;case 5:var u=e;it._setConeData(this.resource,u.radius,u.height,u.radialSegments,u.heightSegments,u.noLongerAccessible,!0,u.vertexBuffer);break;case 6:var d=e;it._setCapsuleData(this.resource,d.radius,d.height,d.radialSegments,d.heightSegments,d.noLongerAccessible,!0,d.vertexBuffer);break}},s}(Rr),gs;(function(n){n[n.Sphere=0]="Sphere",n[n.Cuboid=1]="Cuboid",n[n.Plane=2]="Plane",n[n.Cylinder=3]="Cylinder",n[n.Torus=4]="Torus",n[n.Cone=5]="Cone",n[n.Capsule=6]="Capsule",n[n.CCSphere=7]="CCSphere"})(gs||(gs={}));var On=function(s,i,t){this.type=s,this.vertexBuffer=i,this.noLongerAccessible=t},Cu=function(n){W(s,n);function s(i,t,e,r){var a;return a=n.call(this,0,e,r)||this,a.radius=i,a.segments=t,a}return s}(On),Su=function(n){W(s,n);function s(i,t,e,r){var a;return a=n.call(this,7,e,r)||this,a.radius=i,a.step=t,a}return s}(On),Au=function(n){W(s,n);function s(i,t,e,r,a){var o;return o=n.call(this,1,r,a)||this,o.width=i,o.height=t,o.depth=e,o}return s}(On),wu=function(n){W(s,n);function s(i,t,e,r,a,o){var l;return l=n.call(this,2,a,o)||this,l.width=i,l.height=t,l.horizontalSegments=e,l.verticalSegments=r,l}return s}(On),Eu=function(n){W(s,n);function s(i,t,e,r,a,o,l){var c;return c=n.call(this,3,o,l)||this,c.radiusTop=i,c.radiusBottom=t,c.height=e,c.radialSegments=r,c.heightSegments=a,c}return s}(On),Tu=function(n){W(s,n);function s(i,t,e,r,a,o,l){var c;return c=n.call(this,4,o,l)||this,c.radius=i,c.tubeRadius=t,c.radialSegments=e,c.tubularSegments=r,c.arc=a,c}return s}(On),Ru=function(n){W(s,n);function s(i,t,e,r,a,o){var l;return l=n.call(this,5,a,o)||this,l.radius=i,l.height=t,l.radialSegments=e,l.heightSegments=r,l}return s}(On),Mu=function(n){W(s,n);function s(i,t,e,r,a,o){var l;return l=n.call(this,6,a,o)||this,l.radius=i,l.height=t,l.radialSegments=e,l.heightSegments=r,l}return s}(On),it=function(){function n(){}return n.createSphere=function(i,t,e,r){t===void 0&&(t=.5),e===void 0&&(e=18),r===void 0&&(r=!0);var a=new ct(i);n._setSphereData(a,t,e,r,!1);var o=a.vertexBufferBindings[0].buffer;return i.resourceManager.addContentRestorer(new Mn(a,new Cu(t,e,o,r))),a},n.createSubdivisionSurfaceSphere=function(i,t,e,r){t===void 0&&(t=.5),e===void 0&&(e=3),r===void 0&&(r=!0);var a=new ct(i);n._setSubdivisionSurfaceSphereData(a,t,e,r,!1);var o=a.vertexBufferBindings[0].buffer;return i.resourceManager.addContentRestorer(new Mn(a,new Su(t,e,o,r))),a},n.createCuboid=function(i,t,e,r,a){t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),a===void 0&&(a=!0);var o=new ct(i);n._setCuboidData(o,t,e,r,a,!1);var l=o.vertexBufferBindings[0].buffer;return i.resourceManager.addContentRestorer(new Mn(o,new Au(t,e,r,l,a))),o},n.createPlane=function(i,t,e,r,a,o){t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),a===void 0&&(a=1),o===void 0&&(o=!0);var l=new ct(i);n._setPlaneData(l,t,e,r,a,o,!1);var c=l.vertexBufferBindings[0].buffer;return i.resourceManager.addContentRestorer(new Mn(l,new wu(t,e,r,a,c,o))),l},n.createCylinder=function(i,t,e,r,a,o,l){t===void 0&&(t=.5),e===void 0&&(e=.5),r===void 0&&(r=2),a===void 0&&(a=20),o===void 0&&(o=1),l===void 0&&(l=!0);var c=new ct(i);n._setCylinderData(c,t,e,r,a,o,l,!1);var _=c.vertexBufferBindings[0].buffer;return i.resourceManager.addContentRestorer(new Mn(c,new Eu(t,e,r,a,o,_,l))),c},n.createTorus=function(i,t,e,r,a,o,l){t===void 0&&(t=.5),e===void 0&&(e=.1),r===void 0&&(r=30),a===void 0&&(a=30),o===void 0&&(o=360),l===void 0&&(l=!0);var c=new ct(i);n._setTorusData(c,t,e,r,a,o,l,!1);var _=c.vertexBufferBindings[0].buffer;return i.resourceManager.addContentRestorer(new Mn(c,new Tu(t,e,r,a,o,_,l))),c},n.createCone=function(i,t,e,r,a,o){t===void 0&&(t=.5),e===void 0&&(e=2),r===void 0&&(r=20),a===void 0&&(a=1),o===void 0&&(o=!0);var l=new ct(i);n._setConeData(l,t,e,r,a,o,!1);var c=l.vertexBufferBindings[0].buffer;return i.resourceManager.addContentRestorer(new Mn(l,new Ru(t,e,r,a,c,o))),l},n.createCapsule=function(i,t,e,r,a,o){t===void 0&&(t=.5),e===void 0&&(e=2),r===void 0&&(r=6),a===void 0&&(a=1),o===void 0&&(o=!0);var l=new ct(i);n._setCapsuleData(l,t,e,r,a,o,!1);var c=l.vertexBufferBindings[0].buffer;return i.resourceManager.addContentRestorer(new Mn(l,new Mu(t,e,r,a,c,o))),l},n._setSubdivisionSurfaceSphereData=function(i,t,e,r,a,o){e=k.clamp(Math.floor(e),1,6);var l=new Float32Array(3*(6*Math.pow(4,e)+2)),c=new Float32Array(24*Math.pow(4,e));n._subdiveCatmullClark(e,l,c);for(var _=l.length/3,u=c.length/4,d=_+Math.pow(2,e+1)-1,h=d+16,f=new Float32Array(h*8),v=n._generateIndices(i.engine,_,u*6),p=0,g={},y=0;y<_;y++){var m=3*y,x=l[m],S=l[m+1],b=l[m+2],A=1/Math.sqrt(x*x+S*S+b*b);if(x*=A,S*=A,b*=A,m=8*y,f[m]=x*t,f[m+1]=S*t,f[m+2]=b*t,f[m+3]=x,f[m+4]=S,f[m+5]=b,f[m+6]=(Math.PI-Math.atan2(b,x))/(2*Math.PI),f[m+7]=Math.acos(S)/Math.PI,f[m+6]===0){var C=8*(_+p++);f.set(f.subarray(m,m+8),C),f[C+6]=1,g[m/8]=C/8}}var E=0;this._spherePoleIdx=0;for(var T=0;T<u;T++){var B=4*T,M=c[B],P=c[B+1],V=c[B+2],N=c[B+3],F=8*M,O=8*P,D=8*V,z=8*N;f[F+2]+f[O+2]+f[D+2]<0&&(f[F+6]===0&&(M=g[M]),f[O+6]===0&&(P=g[P]),f[D+6]===0&&(V=g[V]),f[z+6]===0&&(N=g[N])),v[E]=M,v[E+1]=P,v[E+2]=V,this._generateAndReplacePoleUV(v,f,E,d),v[E+3]=M,v[E+4]=V,v[E+5]=N,this._generateAndReplacePoleUV(v,f,E+3,d),E+=6}if(!a){var U=i.bounds;U.min.set(-t,-t,-t),U.max.set(t,t,t)}n._initialize(i,f,v,r,a,o)},n._setSphereData=function(i,t,e,r,a,o){e=Math.max(2,Math.floor(e));for(var l=e+1,c=l*l,_=e*e,u=n._generateIndices(i.engine,c,_*6),d=Math.PI,h=d*2,f=1/l,v=1/e,p=8,g=new Float32Array(c*p),y=0;y<c;++y){var m=y%l,x=y*f|0,S=m*v,b=x*v,A=S*h,C=b*d,E=Math.sin(C),T=-t*Math.cos(A)*E,B=t*Math.cos(C),M=t*Math.sin(A)*E,P=y*p;g[P++]=T,g[P++]=B,g[P++]=M,g[P++]=T,g[P++]=B,g[P++]=M,g[P++]=S,g[P++]=b}for(var V=0,N=0;N<_;++N){var F=N%e,O=N*v|0,D=O*l+F,z=D+1,U=D+l,Y=U+1;u[V++]=z,u[V++]=D,u[V++]=Y,u[V++]=D,u[V++]=U,u[V++]=Y}if(!a){var K=i.bounds;K.min.set(-t,-t,-t),K.max.set(t,t,t)}n._initialize(i,g,u,r,a,o)},n._subdiveCatmullClark=function(i,t,e){var r=new Map,a=new Array;t.set(n._sphereSeedPositions),e.set(n._sphereSeedCells);for(var o=0;o<i;o++){var l=6*Math.pow(4,o),c=4*l+2;r.clear(),a.length=0;for(var _=0;_<l;_++){for(var u=a[_]={facePoint:new w,adjacentEdges:new Array(4)},d=0;d<4;d++){var h=3*e[4*_+d];u.facePoint.x+=.25*t[h],u.facePoint.y+=.25*t[h+1],u.facePoint.z+=.25*t[h+2]}for(var f=0;f<4;f++){var v=e[4*_+f],p=e[4*_+(f+1)%4],g=Math.min(v,p)*c+Math.max(v,p);if(!r.has(g)){var y={edgePoint:new w,edgePointIndex:void 0},m=3*v,x=3*p;y.edgePoint.set(.25*(t[m]+t[x]),.25*(t[m+1]+t[x+1]),.25*(t[m+2]+t[x+2])),r.set(g,y)}var S=r.get(g);u.adjacentEdges[f]=S;var b=S.edgePoint,A=u.facePoint;b.x+=.25*A.x,b.y+=.25*A.y,b.z+=.25*A.z}}var C=l+2,E=C+l,T=0;this._sphereEdgeIdx=0;for(var B=e.slice(0,4*l),M=0;M<l;M++){var P=a[M];P.facePoint.copyToArray(t,3*(C+M));for(var V=C+M,N=void 0,F=void 0,O=void 0,D=0;D<4;D++){var z=B[T++];switch(D){case 0:{var U=P.adjacentEdges[D%4],Y=P.adjacentEdges[(D+3)%4];F=this._calculateEdgeIndex(t,U,E),N=this._calculateEdgeIndex(t,Y,E),O=N;break}case 1:case 2:{var K=P.adjacentEdges[D%4];N=F,F=this._calculateEdgeIndex(t,K,E);break}case 3:{N=F,F=O;break}}var H=4*(4*M+D);e[H]=z,e[H+1]=F,e[H+2]=V,e[H+3]=N}}}},n._generateAndReplacePoleUV=function(i,t,e,r){var a=t[8*i[e]+7];if(a===0||a===1){var o=8*i[e],l=8*(r+this._spherePoleIdx);t.set(t.subarray(o,o+8),l),t[l+6]=.5*(t[o+6]+t[8*i[e+1]+6]+t[8*i[e+2]+6]-.5),i[e]=r+this._spherePoleIdx++}},n._calculateEdgeIndex=function(i,t,e){if(t.edgePointIndex!==void 0)return t.edgePointIndex;t.edgePoint.copyToArray(i,3*(e+n._sphereEdgeIdx));var r=e+n._sphereEdgeIdx++;return t.edgePointIndex=r,r},n._setCuboidData=function(i,t,e,r,a,o,l){var c=t/2,_=e/2,u=r/2,d=8,h=new Float32Array(24*d);h[0]=-c,h[1]=_,h[2]=-u,h[6]=0,h[7]=0,h[8]=c,h[9]=_,h[10]=-u,h[14]=1,h[15]=0,h[16]=c,h[17]=_,h[18]=u,h[22]=1,h[23]=1,h[24]=-c,h[25]=_,h[26]=u,h[30]=0,h[31]=1;for(var f=0;f<4;f++){var v=d*f+3;h[v++]=0,h[v++]=1,h[v++]=0}h[32]=-c,h[33]=-_,h[34]=-u,h[38]=0,h[39]=1,h[40]=c,h[41]=-_,h[42]=-u,h[46]=1,h[47]=1,h[48]=c,h[49]=-_,h[50]=u,h[54]=1,h[55]=0,h[56]=-c,h[57]=-_,h[58]=u,h[62]=0,h[63]=0;for(var p=0;p<4;p++){var g=d*p+35;h[g++]=0,h[g++]=-1,h[g++]=0}h[64]=-c,h[65]=_,h[66]=-u,h[70]=0,h[71]=0,h[72]=-c,h[73]=_,h[74]=u,h[78]=1,h[79]=0,h[80]=-c,h[81]=-_,h[82]=u,h[86]=1,h[87]=1,h[88]=-c,h[89]=-_,h[90]=-u,h[94]=0,h[95]=1;for(var y=0;y<4;y++){var m=d*y+67;h[m++]=-1,h[m++]=0,h[m++]=0}h[96]=c,h[97]=_,h[98]=-u,h[102]=1,h[103]=0,h[104]=c,h[105]=_,h[106]=u,h[110]=0,h[111]=0,h[112]=c,h[113]=-_,h[114]=u,h[118]=0,h[119]=1,h[120]=c,h[121]=-_,h[122]=-u,h[126]=1,h[127]=1;for(var x=0;x<4;x++){var S=d*x+99;h[S++]=1,h[S++]=0,h[S++]=0}h[128]=-c,h[129]=_,h[130]=u,h[134]=0,h[135]=0,h[136]=c,h[137]=_,h[138]=u,h[142]=1,h[143]=0,h[144]=c,h[145]=-_,h[146]=u,h[150]=1,h[151]=1,h[152]=-c,h[153]=-_,h[154]=u,h[158]=0,h[159]=1;for(var b=0;b<4;b++){var A=d*b+131;h[A++]=0,h[A++]=0,h[A++]=1}h[160]=-c,h[161]=_,h[162]=-u,h[166]=1,h[167]=0,h[168]=c,h[169]=_,h[170]=-u,h[174]=0,h[175]=0,h[176]=c,h[177]=-_,h[178]=-u,h[182]=0,h[183]=1,h[184]=-c,h[185]=-_,h[186]=-u,h[190]=1,h[191]=1;for(var C=0;C<4;C++){var E=d*C+163;h[E++]=0,h[E++]=0,h[E++]=-1}var T=new Uint16Array(36);if(T[0]=0,T[1]=2,T[2]=1,T[3]=2,T[4]=0,T[5]=3,T[6]=4,T[7]=6,T[8]=7,T[9]=6,T[10]=4,T[11]=5,T[12]=8,T[13]=10,T[14]=9,T[15]=10,T[16]=8,T[17]=11,T[18]=12,T[19]=14,T[20]=15,T[21]=14,T[22]=12,T[23]=13,T[24]=16,T[25]=18,T[26]=17,T[27]=18,T[28]=16,T[29]=19,T[30]=20,T[31]=22,T[32]=23,T[33]=22,T[34]=20,T[35]=21,!o){var B=i.bounds;B.min.set(-c,-_,-u),B.max.set(c,_,u)}n._initialize(i,h,T,a,o,l)},n._setPlaneData=function(i,t,e,r,a,o,l,c){r=Math.max(1,Math.floor(r)),a=Math.max(1,Math.floor(a));for(var _=r+1,u=a+1,d=t/2,h=e/2,f=t/r,v=e/a,p=_*u,g=a*r,y=n._generateIndices(i.engine,p,g*6),m=1/_,x=1/r,S=1/a,b=8,A=new Float32Array(p*b),C=0;C<p;++C){var E=C%_,T=C*m|0,B=C*b;A[B++]=E*f-d,A[B++]=0,A[B++]=T*v-h,A[B++]=0,A[B++]=1,A[B++]=0,A[B++]=E*x,A[B++]=T*S}for(var M=0,P=0;P<g;++P){var V=P%r,N=P*x|0,F=N*_+V,O=F+1,D=F+_,z=D+1;y[M++]=F,y[M++]=D,y[M++]=O,y[M++]=D,y[M++]=z,y[M++]=O}if(!l){var U=i.bounds;U.min.set(-d,0,-h),U.max.set(d,0,h)}n._initialize(i,A,y,o,l,c)},n._setCylinderData=function(i,t,e,r,a,o,l,c,_){t===void 0&&(t=.5),e===void 0&&(e=.5),r===void 0&&(r=2),a===void 0&&(a=20),o===void 0&&(o=1),a=Math.floor(a),o=Math.floor(o);for(var u=a+1,d=o+1,h=r*.5,f=r/o,v=u*d,p=a*o,g=a*2,y=v+2+g,m=n._generateIndices(i.engine,y,p*6+g*3),x=1/u,S=1/a,b=1/o,A=8,C=new Float32Array(y*A),E=0,T=Math.PI,B=Math.PI*2,M=e-t,P=M/r,V=M/o,N=0;N<v;++N){var F=N%u,O=N*x|0,D=F*S,z=O*b,U=T+D*B,Y=Math.sin(U),K=Math.cos(U),H=e-O*V,te=H*Y,we=O*f-h,pe=H*K,oe=N*A;C[oe++]=te,C[oe++]=we,C[oe++]=pe,C[oe++]=Y,C[oe++]=P,C[oe++]=K,C[oe++]=D,C[oe++]=1-z}for(var Ee=0;Ee<p;++Ee){var Ke=Ee%a,vt=Ee*S|0,Se=vt*u+Ke,nt=Se+1,Je=Se+u,pt=Je+1;m[E++]=nt,m[E++]=Je,m[E++]=Se,m[E++]=nt,m[E++]=pt,m[E++]=Je}var ce=v*A;C[ce++]=0,C[ce++]=-h,C[ce++]=0,C[ce++]=0,C[ce++]=-1,C[ce++]=0,C[ce++]=.5,C[ce++]=.5,C[ce++]=0,C[ce++]=h,C[ce++]=0,C[ce++]=0,C[ce++]=1,C[ce++]=0,C[ce++]=.5,C[ce++]=.5,ce=(v+2)*A;for(var _t=1/(t*2),lr=1/(e*2),an=u*o,Vr=0;Vr<a;++Vr){var Tn=Vr*A,on=C[Tn],Un=C[Tn+2];C[ce++]=on,C[ce++]=-h,C[ce++]=Un,C[ce++]=0,C[ce++]=-1,C[ce++]=0,C[ce++]=on*lr+.5,C[ce++]=.5-Un*lr;var oi=(Vr+an)*A;on=C[oi],Un=C[oi+2],C[ce++]=on,C[ce++]=h,C[ce++]=Un,C[ce++]=0,C[ce++]=1,C[ce++]=0,C[ce++]=on*_t+.5,C[ce++]=.5-Un*_t}for(var Yc=v+1,oo=v+2,ss=oo+1,si=0;si<a;++si){var so=si*2,ls=si===a-1?0:so+2;m[E++]=v,m[E++]=oo+ls,m[E++]=oo+so,m[E++]=Yc,m[E++]=ss+so,m[E++]=ss+ls}if(!c){var cs=i.bounds,li=Math.max(t,e);cs.min.set(-li,-h,-li),cs.max.set(li,h,li)}n._initialize(i,C,m,l,c,_)},n._setTorusData=function(i,t,e,r,a,o,l,c,_){r=Math.floor(r),a=Math.floor(a);var u=(r+1)*(a+1),d=r*a,h=n._generateIndices(i.engine,u,d*6),f=8,v=new Float32Array(u*f);o=o/180*Math.PI;for(var p=0,g=n._tempVec30,y=0;y<=r;y++)for(var m=0;m<=a;m++){var x=m/a*o,S=y/r*Math.PI*2,b=Math.cos(S),A=Math.sin(S),C=Math.cos(x),E=Math.sin(x),T=(t+e*b)*C,B=(t+e*b)*E,M=e*A;v[p++]=T,v[p++]=B,v[p++]=M;var P=t*C,V=t*E;g.set(T-P,B-V,M).normalize(),v[p++]=g.x,v[p++]=g.y,v[p++]=g.z,v[p++]=m/a,v[p++]=y/r}p=0;for(var N=1;N<=r;N++)for(var F=1;F<=a;F++){var O=(a+1)*N+F-1,D=(a+1)*(N-1)+F-1,z=(a+1)*(N-1)+F,U=(a+1)*N+F;h[p++]=O,h[p++]=D,h[p++]=U,h[p++]=D,h[p++]=z,h[p++]=U}if(!c){var Y=i.bounds,K=t+e;Y.min.set(-K,-K,-e),Y.max.set(K,K,e)}n._initialize(i,v,h,l,c,_)},n._setConeData=function(i,t,e,r,a,o,l,c){r=Math.floor(r),a=Math.floor(a);for(var _=r+1,u=a+1,d=e*.5,h=e/a,f=_*u,v=r*a,p=f+1+r,g=n._generateIndices(i.engine,p,v*6+r*3),y=1/_,m=1/r,x=1/a,S=8,b=new Float32Array(p*8),A=0,C=Math.PI,E=Math.PI*2,T=t/e,B=0;B<f;++B){var M=B%_,P=B*y|0,V=M*m,N=P*x,F=C+V*E,O=Math.sin(F),D=Math.cos(F),z=t-N*t,U=z*O,Y=P*h-d,K=z*D,H=B*S;b[H++]=U,b[H++]=Y,b[H++]=K,b[H++]=O,b[H++]=T,b[H++]=D,b[H++]=V,b[H++]=1-N}for(var te=0;te<v;++te){var we=te%r,pe=te*m|0,oe=pe*_+we,Ee=oe+1,Ke=oe+_,vt=Ke+1;g[A++]=Ee,g[A++]=Ke,g[A++]=oe,g[A++]=Ee,g[A++]=vt,g[A++]=Ke}var Se=f*S;b[Se++]=0,b[Se++]=-d,b[Se++]=0,b[Se++]=0,b[Se++]=-1,b[Se++]=0,b[Se++]=.5,b[Se++]=.5,Se=(f+1)*S;for(var nt=1/(t*2),Je=0;Je<r;++Je){var pt=b[Je*S],ce=b[Je*S+2];b[Se++]=pt,b[Se++]=-d,b[Se++]=ce,b[Se++]=0,b[Se++]=-1,b[Se++]=0,b[Se++]=pt*nt+.5,b[Se++]=.5-ce*nt}for(var _t=f+1,lr=0;lr<r;++lr){var an=lr,Vr=lr===r-1?0:an+1;g[A++]=f,g[A++]=_t+Vr,g[A++]=_t+an}if(!l){var Tn=i.bounds;Tn.min.set(-t,-d,-t),Tn.max.set(t,d,t)}n._initialize(i,b,g,o,l,c)},n._setCapsuleData=function(i,t,e,r,a,o,l,c){r=Math.max(2,Math.floor(r)),a=Math.floor(a);for(var _=r+1,u=a+1,d=e*.5,h=e/a,f=_*u,v=r*a,p=_*_,g=r*r,y=f+2*p,m=n._generateIndices(i.engine,y,(v+2*g)*6),x=1/_,S=1/r,b=1/a,A=Math.PI,C=Math.PI*2,E=8,T=new Float32Array(y*E),B=0,M=0;M<f;++M){var P=M%_,V=M*x|0,N=P*S,F=V*b,O=A+N*C,D=Math.sin(O),z=Math.cos(O),U=M*E;T[U++]=t*D,T[U++]=V*h-d,T[U++]=t*z,T[U++]=D,T[U++]=0,T[U++]=z,T[U++]=N,T[U++]=1-F}for(var Y=0;Y<v;++Y){var K=Y%r,H=Y*S|0,te=H*_+K,we=te+1,pe=te+_,oe=pe+1;m[B++]=we,m[B++]=pe,m[B++]=te,m[B++]=we,m[B++]=oe,m[B++]=pe}if(n._createCapsuleCap(t,e,r,A,C,f,1,T,m,B),n._createCapsuleCap(t,e,r,A,-C,f+p,-1,T,m,B+6*g),!l){var Ee=i.bounds;Ee.min.set(-t,-t-d,-t),Ee.max.set(t,t+d,t)}n._initialize(i,T,m,o,l,c)},n._initialize=function(i,t,e,r,a,o){if(a)o.setData(t),i.setIndices(e),i.uploadData(r);else{var l=[new Me(X.Position,0,ee.Vector3,0),new Me(X.Normal,12,ee.Vector3,0),new Me(X.UV,24,ee.Vector2,0)];i.setVertexElements(l);var c=new ir(i.engine,Nt.VertexBuffer,t,tt.Static,!0);i.setVertexBufferBinding(c,32,0),i.setIndices(e),i.calculateTangents(),i.uploadData(r),i.addSubMesh(0,e.length)}},n._generateIndices=function(i,t,e){var r=null;if(t>65535)if(i._hardwareRenderer.canIUse(Q.elementIndexUint))r=new Uint32Array(e);else throw Error("The vertex count is over limit.");else r=new Uint16Array(e);return r},n._createCapsuleCap=function(i,t,e,r,a,o,l,c,_,u){for(var d=e+1,h=t*.5*l,f=d*d,v=e*e,p=1/d,g=1/e,y=8,m=0;m<f;++m){var x=m%d,S=m*p|0,b=x*g,A=S*g,C=r+b*a,E=A*Math.PI*.5,T=Math.sin(E),B=i*Math.sin(C)*T,M=i*Math.cos(E)*l+h,P=i*Math.cos(C)*T,V=(m+o)*y;c[V++]=B,c[V++]=M,c[V++]=P,c[V++]=B,c[V++]=M-h,c[V++]=P,c[V++]=b,c[V++]=A}for(var N=0;N<v;++N){var F=N%e,O=N*g|0,D=O*d+F+o,z=D+1,U=D+d,Y=U+1;_[u++]=z,_[u++]=D,_[u++]=Y,_[u++]=D,_[u++]=U,_[u++]=Y}},n}();(function(){it._tempVec30=new w})();(function(){it._sphereSeedPositions=new Float32Array([-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,1,-1,-1,-1,-1,-1,1,-1])})();(function(){it._sphereSeedCells=new Float32Array([0,1,2,3,3,2,4,5,5,4,6,7,7,0,3,5,7,6,1,0,6,4,2,1])})();(function(){it._sphereEdgeIdx=0})();(function(){it._spherePoleIdx=0})();var vc=function(n){W(s,n);function s(i){var t;return t=n.call(this,null)||this,t.name=i,t._bones=[],t.inverseBindMatrices=[],t.joints=[],t.skeleton="none",t}return s}(tn),Pt=function(n){W(s,n);function s(t){var e;e=n.call(this,t)||this,e._localBounds=new nr,e._jointDataCreateCache=new $(-1,-1),e._skin=null;var r=e.entity.engine._hardwareRenderer,a=r.renderStates.getParameter(r.gl.MAX_VERTEX_UNIFORM_VECTORS);a=Math.min(a,r._options._maxAllowSkinUniformVectorCount),e._maxVertexUniformVectors=a,e._onLocalBoundsChanged=e._onLocalBoundsChanged.bind(ue(e));var o=e._localBounds;return o.min._onValueChanged=e._onLocalBoundsChanged,o.max._onValueChanged=e._onLocalBoundsChanged,e}var i=s.prototype;return i.update=function(){var e=this,r=e._skin,a=e._bones;if(r&&a)for(var o=this._jointMatrices,l=r.inverseBindMatrices,c,_=((c=this._rootBone)!=null?c:this.entity).getInvModelMatrix(),u=a.length-1;u>=0;u--){var d=a[u],h=u*16;d?We._floatMatrixMultiply(d.transform.worldMatrix,l[u].elements,0,o,h):o.set(l[u].elements,h),We._floatMatrixMultiply(_,o,h,o,h)}},i._updateShaderData=function(e,r){var a=this.entity,o,l=((o=this._rootBone)!=null?o:a).transform.worldMatrix;if(r){this._updateMVPShaderData(e,l);return}this._updateTransformShaderData(e,l);var c=this.shaderData,_=this.mesh,u=_._blendShapeManager;u._updateShaderData(c,this);var d=this._bones;if(d){var h=u._uniformOccupiesCount,f=d.length,v=this._jointDataCreateCache,p=f!==v.x;if(p||h!==v.y){var g=Math.ceil((this._maxVertexUniformVectors-(44+h))/4);if(f>g){var y=this.engine;if(y._hardwareRenderer.canIUseMoreJoints){if(p){var m;(m=this._jointTexture)==null||m.destroy(),this._jointTexture=new bt(y,4,f,G.R32G32B32A32,!1),this._jointTexture.filterMode=ot.Point,this._jointTexture.isGCIgnored=!0}c.disableMacro("RENDERER_JOINTS_NUM"),c.enableMacro("RENDERER_USE_JOINT_TEXTURE"),c.setTexture(s._jointSamplerProperty,this._jointTexture)}else ve.error("component's joints count("+f+") greater than device's MAX_VERTEX_UNIFORM_VECTORS number "+this._maxVertexUniformVectors+", and don't support jointTexture in this device. suggest joint count less than "+g+".",this)}else{var x;(x=this._jointTexture)==null||x.destroy(),c.disableMacro("RENDERER_USE_JOINT_TEXTURE"),c.enableMacro("RENDERER_JOINTS_NUM",g.toString()),c.setFloatArray(s._jointMatrixProperty,this._jointMatrices)}v.set(f,h)}this._jointTexture&&this._jointTexture.setPixelBuffer(this._jointMatrices)}var S=a.layer;this._rendererLayer.set(S&65535,S>>>16&65535,0,0)},i._onDestroy=function(){var e;n.prototype._onDestroy.call(this),this._rootBone=null,this._jointDataCreateCache=null,this._skin=null,this._blendShapeWeights=null,this._localBounds=null,this._jointMatrices=null,(e=this._jointTexture)==null||e.destroy(),this._jointTexture=null,this._bones=null},i._cloneTo=function(e,r,a){n.prototype._cloneTo.call(this,e,r,a);var o=new Array;if(this.rootBone){var l=this._getEntityHierarchyPath(r,this.rootBone,o);e.rootBone=l?this._getEntityByHierarchyPath(a,o):this.rootBone}var c=this._bones;if(c){for(var _=c.length,u=new Array(_),d=0;d<_;d++){var h=c[d],f=this._getEntityHierarchyPath(r,h,o);u[d]=f?this._getEntityByHierarchyPath(a,o):h}e.bones=u}this._blendShapeWeights&&(e._blendShapeWeights=this._blendShapeWeights.slice())},i._registerEntityTransformListener=function(){var e;((e=this._rootBone)!=null?e:this._entity).transform._updateFlagManager.addListener(this._onTransformChanged)},i._unRegisterEntityTransformListener=function(){var e;((e=this._rootBone)!=null?e:this._entity).transform._updateFlagManager.removeListener(this._onTransformChanged)},i._updateBounds=function(e){if(this._rootBone){var r=this._localBounds,a=this._rootBone.transform.worldMatrix;nr.transform(r,a,e)}else n.prototype._updateBounds.call(this,e)},i._checkBlendShapeWeightLength=function(){var e=this._mesh,r=e?e.blendShapeCount:0,a=this._blendShapeWeights;if(a){var o=a.length;if(o!==r){var l=new Float32Array(r);if(r>o)l.set(a);else for(var c=0;c<r;c++)l[c]=a[c];this._blendShapeWeights=l}}else this._blendShapeWeights=new Float32Array(r)},i._onLocalBoundsChanged=function(){this._dirtyUpdateFlag|=$e.WorldVolume},i._getEntityHierarchyPath=function(e,r,a){for(a.length=0;r!==e;){var o=r.parent;if(!o)return!1;a.push(r.siblingIndex),r=o}return!0},i._getEntityByHierarchyPath=function(e,r){for(var a=e,o=r.length-1;o>=0;o--)a=a.children[r[o]];return a},q(s,[{key:"blendShapeWeights",get:function(){return this._checkBlendShapeWeightLength(),this._blendShapeWeights},set:function(e){this._checkBlendShapeWeightLength();var r=this._blendShapeWeights;if(e.length<=r.length)r.set(e);else for(var a=0,o=r.length;a<o;a++)r[a]=e[a]}},{key:"localBounds",get:function(){return this._localBounds},set:function(e){this._localBounds!==e&&this._localBounds.copyFrom(e)}},{key:"rootBone",get:function(){return this._rootBone},set:function(e){this._rootBone!==e&&(this._unRegisterEntityTransformListener(),this._rootBone=e,this._registerEntityTransformListener(),this._dirtyUpdateFlag|=$e.WorldVolume)}},{key:"bones",get:function(){return this._bones},set:function(e){if(this._bones!==e){var r,a,o,l=(o=(r=this._bones)==null?void 0:r.length)!=null?o:0,c,_=(c=(a=e)==null?void 0:a.length)!=null?c:0;if(l!==_){var u=this.shaderData;_>0?(this._jointMatrices=new Float32Array(_*16),u.enableMacro("RENDERER_HAS_SKIN"),u.setInt(s._jointCountProperty,_)):(this._jointMatrices=null,u.disableMacro("RENDERER_HAS_SKIN"))}this._bones=e}}},{key:"skin",get:function(){return this._skin},set:function(e){this._skin=e}}]),s}(Rt);(function(){Pt._jointCountProperty=L.getByName("renderer_JointCount")})();(function(){Pt._jointSamplerProperty=L.getByName("renderer_JointSampler")})();(function(){Pt._jointMatrixProperty=L.getByName("renderer_JointMatrix")})();R([Z],Pt.prototype,"_localBounds",void 0);R([I],Pt.prototype,"_jointDataCreateCache",void 0);R([I],Pt.prototype,"_blendShapeWeights",void 0);R([I],Pt.prototype,"_maxVertexUniformVectors",void 0);R([I],Pt.prototype,"_rootBone",void 0);R([I],Pt.prototype,"_jointMatrices",void 0);R([I],Pt.prototype,"_jointTexture",void 0);R([I],Pt.prototype,"_bones",void 0);R([I],Pt.prototype,"_condensedBlendShapeWeights",void 0);R([I],Pt.prototype,"_onLocalBoundsChanged",null);var Wn=function(){function n(i){this._elementPoolIndex=0,this._elementPool=[],this._type=i}var s=n.prototype;return s.getFromPool=function(){var t=this,e=t._elementPoolIndex,r=t._elementPool;if(this._elementPoolIndex++,r.length===e){var a=new this._type;return r.push(a),a}else return r[e]},s.resetPool=function(){this._elementPoolIndex=0},s.garbageCollection=function(){for(var t=this,e=t._elementPool,r=e.length-1;r>=0;r--)e[r].dispose&&e[r].dispose()},n}(),Or=function(){function n(i){this._subMeshPool=new Wn(Zi),this._batchedQueue=[],this._meshes=[],this._meshCount=1,this._vertexBuffers=[],this._indiceBuffers=[],this._flushId=0,this._vertexCount=0,this._elementCount=0,this._engine=i,this._initMeshes(i)}var s=n.prototype;return s.drawElement=function(t,e){var r=t.data;if(r.multiRenderData)for(var a=r.charsData,o=e.engine._renderElementPool,l=0,c=a.length;l<c;++l){var _=o.getFromPool();_.set(a[l],t.shaderPasses),this._drawSubElement(_,e)}else this._drawSubElement(t,e)},s._initMeshes=function(t){var e=n.MAX_VERTEX_COUNT;this._vertices=new Float32Array(e*9),this._indices=new Uint16Array(e*3);for(var r=this,a=r._meshes,o=r._meshCount,l=0;l<o;l++)a[l]=this._createMesh(t,l)},s.flush=function(t){var e=this._batchedQueue;e.length!==0&&(this._updateData(this._engine),this.drawBatches(t),n._canUploadSameBuffer||this._flushId++,e.length=0,this._subMeshPool.resetPool(),this._vertexCount=0,this._elementCount=0)},s.clear=function(){this._flushId=0,this._vertexCount=0,this._elementCount=0,this._batchedQueue.length=0},s.destroy=function(){this._batchedQueue=null;for(var t=this,e=t._meshes,r=t._vertexBuffers,a=t._indiceBuffers,o=0,l=e.length;o<l;++o){var c=e[o];c._addReferCount(-1),c.destroy()}this._meshes=null;for(var _=0,u=r.length;_<u;++_)r[_].destroy();this._vertexBuffers=null;for(var d=0,h=a.length;d<h;++d)a[d].destroy();this._indiceBuffers=null},s._drawSubElement=function(t,e){var r=t.data.verticesData.vertexCount;this._vertexCount+r>n.MAX_VERTEX_COUNT&&this.flush(e),this._vertexCount+=r,this._batchedQueue[this._elementCount++]=t},s._createMesh=function(t,e){var r=n.MAX_VERTEX_COUNT,a=new Wo(t,"BufferMesh"+e);a._addReferCount(1);var o=[],l=this.createVertexElements(o),c=this._vertexBuffers[e]=new ir(t,Nt.VertexBuffer,r*l,tt.Dynamic),_=this._indiceBuffers[e]=new ir(t,Nt.IndexBuffer,r*6,tt.Dynamic);return a.setVertexBufferBinding(c,l),a.setIndexBufferBinding(_,Et.UInt16),a.setVertexElements(o),a},s._updateData=function(t){var e=this,r=e._meshes,a=e._flushId;!n._canUploadSameBuffer&&this._meshCount<=a&&(this._meshCount++,r[a]=this._createMesh(t,a));var o=this,l=o._batchedQueue,c=o._vertices,_=o._indices,u=r[a];u.clearSubMesh();for(var d=0,h=0,f=0,v=0,p=0,g=0,y=null,m=0,x=l.length;m<x;m++){var S=l[m],b=S.data;d=this.updateVertices(b,c,d);for(var A=b.verticesData.triangles,C=A.length,E=0;E<C;E++)_[h++]=A[E]+p;p+=b.verticesData.vertexCount,y===null||this.canBatch(y,S)?v+=C:(u.addSubMesh(this._getSubMeshFromPool(f,v)),f+=v,v=C,l[g++]=y),y=S}u.addSubMesh(this._getSubMeshFromPool(f,v)),l[g]=y,this._vertexBuffers[a].setData(c,0,0,d,gn.Discard),this._indiceBuffers[a].setData(_,0,0,h,gn.Discard)},s._getSubMeshFromPool=function(t,e){var r=this._subMeshPool.getFromPool();return r.start=t,r.count=e,r.topology=kr.Triangles,r},n}();(function(){Or._disableBatchTag=vn.getByName("spriteDisableBatching")})();(function(){Or.MAX_VERTEX_COUNT=4096})();(function(){Or._canUploadSameBuffer=!0})();var kn,Mi=(kn=function(){function n(){}return n.resetData=function(i){i._verticesData.triangles=[]},n.updatePositions=function(i){var t=i.width,e=i.height,r=i.sprite,a=i.tileMode,o=i.tiledAdaptiveThreshold,l=i._verticesData,c=l.positions,_=l.uvs,u=l.triangles,d=this,h=d._posRow,f=d._posColumn,v=d._uvRow,p=d._uvColumn;h.length=f.length=v.length=p.length=0,a===Oa.Adaptive?this._calculateAdaptiveDividing(r,t,e,o,h,f,v,p):this._calculateContinuousDividing(r,t,e,h,f,v,p);var g=i.sprite.pivot,y=g.x,m=g.y,x=i.width*y,S=i.height*m,b=Mi._worldMatrix,A=b.elements,C=i.entity.transform.worldMatrix,E=C.elements,T=i.flipX?-1:1,B=i.flipY?-1:1,M,P,V,N,F,O;M=A[0]=E[0]*T,P=A[1]=E[1]*T,V=A[2]=E[2]*T,N=A[4]=E[4]*B,F=A[5]=E[5]*B,O=A[6]=E[6]*B,A[8]=E[8],A[9]=E[9],A[10]=E[10];for(var D=A[12]=E[12]-x*A[0]-S*A[4],z=A[13]=E[13]-x*A[1]-S*A[5],U=A[14]=E[14]-x*A[2]-S*A[6],Y=h.length-1,K=f.length-1,H=0,te=0,we=0;we<K;we++)for(var pe=2*we,oe=0;oe<Y;oe++){var Ee=v.get(2*oe),Ke=p.get(pe),vt=v.get(2*oe+1),Se=p.get(pe+1);if(!(isNaN(Ee)||isNaN(Ee)||isNaN(vt)||isNaN(Se))){u[te++]=H,u[te++]=H+1,u[te++]=H+2,u[te++]=H+2,u[te++]=H+1,u[te++]=H+3;var nt=h.get(oe),Je=f.get(we),pt=h.get(oe+1),ce=f.get(we+1);_[H]?_[H].set(Ee,Ke):_[H]=new $(Ee,Ke);var _t=c[H];_t?_t.set(M*nt+N*Je+D,P*nt+F*Je+z,V*nt+O*Je+U):c[H]=new w(M*nt+N*Je+D,P*nt+F*Je+z,V*nt+O*Je+U),H++,_[H]?_[H].set(vt,Ke):_[H]=new $(vt,Ke),_t=c[H],_t?_t.set(M*pt+N*Je+D,P*pt+F*Je+z,V*pt+O*Je+U):c[H]=new w(M*pt+N*Je+D,P*pt+F*Je+z,V*pt+O*Je+U),H++,_[H]?_[H].set(Ee,Se):_[H]=new $(Ee,Se),_t=c[H],_t?_t.set(M*nt+N*ce+D,P*nt+F*ce+z,V*nt+O*ce+U):c[H]=new w(M*nt+N*ce+D,P*nt+F*ce+z,V*nt+O*ce+U),H++,_[H]?_[H].set(vt,Se):_[H]=new $(vt,Se),_t=c[H],_t?_t.set(M*pt+N*ce+D,P*pt+F*ce+z,V*pt+O*ce+U):c[H]=new w(M*pt+N*ce+D,P*pt+F*ce+z,V*pt+O*ce+U),H++}}i._verticesData.vertexCount=H,u.length=te;var lr=i._bounds,an=lr.min,Vr=lr.max;an.set(h.get(0),f.get(0),0),Vr.set(h.get(Y),f.get(K),0),i._bounds.transform(b)},n.updateUVs=function(i){},n._calculateAdaptiveDividing=function(i,t,e,r,a,o,l,c){var _=i.border,u=i._getPositions(),d=u[0],h=d.x,f=d.y,v=u[3],p=v.x,g=v.y,y=i._getUVs(),m=y[0],x=y[1],S=y[2],b=y[3],A=i.width,C=i.height,E=A*_.x,T=A*_.z,B=E+T,M=A-B,P=C*_.w,V=C*_.y,N=P+V,F=C-N,O,D,z,U,Y,K,H;if(B>=t?(U=3,D=0):M>k.zeroTolerance?(K=(t-B)/M,K=K%1>=r?Math.ceil(K):Math.floor(K),U=4+K-1,D=2):(U=4,D=1),N>=e?(Y=3,z=0):F>k.zeroTolerance?(H=(e-N)/F,H=H%1>=r?Math.ceil(H):Math.floor(H),Y=4+H-1,z=2):(Y=4,z=1),(U-1)*(Y-1)*4>Or.MAX_VERTEX_COUNT){a.add(t*h),a.add(t*p),o.add(e*f),o.add(e*g),l.add(m.x),l.add(b.x),c.add(m.y),c.add(b.y),ve.warn("The number of vertices exceeds the upper limit("+Or.MAX_VERTEX_COUNT+").");return}switch(D){case 0:O=t/B,a.add(A*h*O),a.add(E*O),a.add(t-A*(1-p)*O),l.add(m.x),l.add(x.x),l.add(S.x),l.add(b.x);break;case 1:a.add(A*h),a.add(E),a.add(t-T),a.add(t-A*(1-p)),l.add(m.x),l.add(x.x),l.add(NaN),l.add(NaN),l.add(S.x),l.add(b.x);break;case 2:O=t/(B+K*M),a.add(A*h*O),a.add(E*O),l.add(m.x),l.add(x.x),l.add(x.x);for(var te=0,we=K-1;te<we;te++)a.add(E+(te+1)*M*O),l.add(S.x),l.add(x.x);a.add(t-T*O),a.add(t-A*(1-p)*O),l.add(S.x),l.add(S.x),l.add(b.x);break}switch(z){case 0:O=e/N,o.add(C*f*O),o.add(V*O),o.add(e-C*(1-g)*O),c.add(m.y),c.add(x.y),c.add(S.y),c.add(b.y);break;case 1:o.add(C*f),o.add(V),o.add(e-P),o.add(e-C*(1-g)),c.add(m.y),c.add(x.y),c.add(NaN),c.add(NaN),c.add(S.y),c.add(b.y);break;case 2:O=e/(N+H*F),o.add(C*f*O),o.add(V*O),c.add(m.y),c.add(x.y),c.add(x.y);for(var pe=0,oe=H-1;pe<oe;pe++)o.add(V+(pe+1)*F*O),c.add(S.y),c.add(x.y);o.add(e-P*O),o.add(e-C*(1-g)*O),c.add(S.y),c.add(S.y),c.add(b.y);break}},n._calculateContinuousDividing=function(i,t,e,r,a,o,l){var c=i.border,_=i._getPositions(),u=_[0],d=u.x,h=u.y,f=_[3],v=f.x,p=f.y,g=i._getUVs(),y=g[0],m=g[1],x=g[2],S=g[3],b=i.width,A=i.height,C=b*c.x,E=b*c.z,T=C+E,B=b-T,M=A*c.w,P=A*c.y,V=M+P,N=A-V,F,O,D,z,U,Y;if(T>=t?(D=3,F=0):B>k.zeroTolerance?(U=(t-T)/B,D=4+(U|0),F=2):(D=4,F=1),V>=e?(z=3,O=0):N>k.zeroTolerance?(Y=(e-V)/N,z=4+(Y|0),O=2):(z=4,O=1),(D-1)*(z-1)*4>Or.MAX_VERTEX_COUNT){r.add(t*d),r.add(t*v),a.add(e*h),a.add(e*p),o.add(y.x),o.add(S.x),l.add(y.y),l.add(S.y),ve.warn("The number of vertices exceeds the upper limit("+Or.MAX_VERTEX_COUNT+").");return}switch(F){case 0:var K=t/T;r.add(b*d*K),r.add(C*K),r.add(t-b*(1-v)*K),o.add(y.x),o.add(m.x),o.add(x.x),o.add(S.x);break;case 1:r.add(b*d),r.add(C),r.add(t-E),r.add(t-b*(1-v)),o.add(y.x),o.add(m.x),o.add(NaN),o.add(NaN),o.add(x.x),o.add(S.x);break;case 2:r.add(b*d),r.add(C),o.add(y.x),o.add(m.x),o.add(m.x);for(var H=U|0,te=0;te<H;te++)r.add(C+(te+1)*B),o.add(x.x),o.add(m.x);r.add(t-E),r.add(t-b*(1-v)),o.add((x.x-m.x)*(U-H)+m.x),o.add(x.x),o.add(S.x);break}switch(O){case 0:var we=e/V;a.add(A*h*we),a.add(P*we),a.add(e-A*(1-p)*we),l.add(y.y),l.add(m.y),l.add(x.y),l.add(S.y);break;case 1:a.add(A*h),a.add(P),a.add(e-M),a.add(e-A*(1-p)),l.add(y.y),l.add(m.y),l.add(NaN),l.add(NaN),l.add(x.y),l.add(S.y);break;case 2:a.add(A*h),a.add(P),l.add(y.y),l.add(m.y),l.add(m.y);for(var pe=Y|0,oe=0;oe<pe;oe++)a.add(P+(oe+1)*N),l.add(x.y),l.add(m.y);a.add(e-M),a.add(e-A*(1-p)),l.add((x.y-m.y)*(Y-pe)+m.y),l.add(x.y),l.add(S.y);break}},n}(),function(){kn._worldMatrix=new J}(),function(){kn._posRow=new Ye}(),function(){kn._posColumn=new Ye}(),function(){kn._uvRow=new Ye}(),function(){kn._uvColumn=new Ye}(),kn);Mi=R([Yt()],Mi);var ms;(function(n){n[n.Compressed=0]="Compressed",n[n.WithoutTiled=1]="WithoutTiled",n[n.WithTiled=2]="WithTiled"})(ms||(ms={}));var jo=function(s,i,t,e,r){e===void 0&&(e=null),r===void 0&&(r=null),this.vertexCount=s,this.positions=i,this.uvs=t,this.triangles=e,this.color=r},Ct=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._tileMode=Oa.Continuous,e._tiledAdaptiveThreshold=.5,e._color=new j(1,1,1,1),e._sprite=null,e._automaticWidth=0,e._automaticHeight=0,e._customWidth=void 0,e._customHeight=void 0,e._flipX=!1,e._flipY=!1,e._maskLayer=ha.Layer0,e._maskInteraction=ht.None,e._verticesData=new jo(4,[],[],null,e._color),e.drawMode=br.Simple,e.setMaterial(e._engine._spriteDefaultMaterial),e._onSpriteChange=e._onSpriteChange.bind(ue(e)),e}var i=s.prototype;return i._cloneTo=function(e,r,a){n.prototype._cloneTo.call(this,e,r,a),e._assembler.resetData(e),e.sprite=this._sprite,e.drawMode=this._drawMode},i._updateShaderData=function(e,r){if(r){this._updateMVPShaderData(e,J._identity);return}this._updateTransformShaderData(e,J._identity)},i._updateBounds=function(e){this.sprite?this._assembler.updatePositions(this):(e.min.set(0,0,0),e.max.set(0,0,0))},i._render=function(e){var r;if(!(!((r=this.sprite)!=null&&r.texture)||!this.width||!this.height)){var a=this.getMaterial();if(!!a){a.destroyed&&(a=this._engine._spriteDefaultMaterials[this._maskInteraction]),this._dirtyUpdateFlag&$e.WorldVolume&&(this._assembler.updatePositions(this),this._dirtyUpdateFlag&=~$e.WorldVolume),this._dirtyUpdateFlag&2&&(this._assembler.updateUVs(this),this._dirtyUpdateFlag&=-3);var o=this.sprite.texture,l=this._engine._spriteRenderDataPool.getFromPool();l.set(this,a,this._verticesData,o),e.camera._renderPipeline.pushRenderData(e,l)}}},i._onDestroy=function(){var e=this._sprite;e&&(this._addResourceReferCount(e,-1),e._updateFlagManager.removeListener(this._onSpriteChange)),n.prototype._onDestroy.call(this),this._entity=null,this._color=null,this._sprite=null,this._assembler=null,this._verticesData=null},i._calDefaultSize=function(){var e=this._sprite;e?(this._automaticWidth=e.width,this._automaticHeight=e.height):this._automaticWidth=this._automaticHeight=0,this._dirtyUpdateFlag&=-5},i._updateStencilState=function(e,r){var a=this.getMaterial(),o=this._engine,l=o._spriteDefaultMaterials;if(a===l[e])this.setMaterial(l[r]);else{var c=a.renderState.stencilState;r===ht.None?(c.enabled=!1,c.writeMask=255,c.referenceValue=0,c.compareFunctionFront=c.compareFunctionBack=Te.Always):(c.enabled=!0,c.writeMask=0,c.referenceValue=1,c.compareFunctionFront=c.compareFunctionBack=r===ht.VisibleInsideMask?Te.LessEqual:Te.Greater)}},i._onSpriteChange=function(e){switch(e){case Re.texture:this.shaderData.setTexture(s._textureProperty,this.sprite.texture);break;case Re.size:var r=this,a=r._drawMode;this._dirtyUpdateFlag|=4,this._drawMode===br.Sliced?this._dirtyUpdateFlag|=$e.WorldVolume:a===br.Tiled?this._dirtyUpdateFlag|=3:(this._customWidth===void 0||this._customHeight===void 0)&&(this._dirtyUpdateFlag|=$e.WorldVolume);break;case Re.border:this._drawMode===br.Sliced&&(this._dirtyUpdateFlag|=3);break;case Re.region:case Re.atlasRegionOffset:this._dirtyUpdateFlag|=3;break;case Re.atlasRegion:this._dirtyUpdateFlag|=2;break;case Re.pivot:this._dirtyUpdateFlag|=$e.WorldVolume;break;case Re.destroy:this.sprite=null;break}},q(s,[{key:"drawMode",get:function(){return this._drawMode},set:function(e){if(this._drawMode!==e){switch(this._drawMode=e,e){case br.Simple:this._assembler=dn;break;case br.Sliced:this._assembler=za;break;case br.Tiled:this._assembler=Mi;break}this._assembler.resetData(this),this._dirtyUpdateFlag|=3}}},{key:"tileMode",get:function(){return this._tileMode},set:function(e){this._tileMode!==e&&(this._tileMode=e,this.drawMode===br.Tiled&&(this._dirtyUpdateFlag|=3))}},{key:"tiledAdaptiveThreshold",get:function(){return this._tiledAdaptiveThreshold},set:function(e){e!==this._tiledAdaptiveThreshold&&(e=k.clamp(e,0,1),this._tiledAdaptiveThreshold=e,this.drawMode===br.Tiled&&(this._dirtyUpdateFlag|=3))}},{key:"sprite",get:function(){return this._sprite},set:function(e){var r=this._sprite;r!==e&&(r&&(this._addResourceReferCount(r,-1),r._updateFlagManager.removeListener(this._onSpriteChange)),this._dirtyUpdateFlag|=7,e?(this._addResourceReferCount(e,1),e._updateFlagManager.addListener(this._onSpriteChange),this.shaderData.setTexture(s._textureProperty,e.texture)):this.shaderData.setTexture(s._textureProperty,null),this._sprite=e)}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.copyFrom(e)}},{key:"width",get:function(){return this._customWidth!==void 0?this._customWidth:(this._dirtyUpdateFlag&4&&this._calDefaultSize(),this._automaticWidth)},set:function(e){this._customWidth!==e&&(this._customWidth=e,this._dirtyUpdateFlag|=$e.WorldVolume)}},{key:"height",get:function(){return this._customHeight!==void 0?this._customHeight:(this._dirtyUpdateFlag&4&&this._calDefaultSize(),this._automaticHeight)},set:function(e){this._customHeight!==e&&(this._customHeight=e,this._dirtyUpdateFlag|=$e.WorldVolume)}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._dirtyUpdateFlag|=$e.WorldVolume)}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._dirtyUpdateFlag|=$e.WorldVolume)}},{key:"maskLayer",get:function(){return this._maskLayer},set:function(e){this._maskLayer=e}},{key:"maskInteraction",get:function(){return this._maskInteraction},set:function(e){this._maskInteraction!==e&&(this._updateStencilState(this._maskInteraction,e),this._maskInteraction=e)}}]),s}(be);(function(){Ct._textureProperty=L.getByName("renderer_SpriteTexture")})();R([I],Ct.prototype,"_verticesData",void 0);R([I],Ct.prototype,"_drawMode",void 0);R([Pe],Ct.prototype,"_assembler",void 0);R([Pe],Ct.prototype,"_tileMode",void 0);R([Pe],Ct.prototype,"_tiledAdaptiveThreshold",void 0);R([Z],Ct.prototype,"_color",void 0);R([I],Ct.prototype,"_sprite",void 0);R([I],Ct.prototype,"_automaticWidth",void 0);R([I],Ct.prototype,"_automaticHeight",void 0);R([Pe],Ct.prototype,"_customWidth",void 0);R([Pe],Ct.prototype,"_customHeight",void 0);R([Pe],Ct.prototype,"_flipX",void 0);R([Pe],Ct.prototype,"_flipY",void 0);R([Pe],Ct.prototype,"_maskLayer",void 0);R([Pe],Ct.prototype,"_maskInteraction",void 0);R([I],Ct.prototype,"_onSpriteChange",null);var ys;(function(n){n[n.UV=2]="UV",n[n.RenderData=3]="RenderData",n[n.AutomaticSize=4]="AutomaticSize",n[n.All=7]="All"})(ys||(ys={}));var It=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e.influenceLayers=ha.Everything,e._sprite=null,e._automaticWidth=0,e._automaticHeight=0,e._customWidth=void 0,e._customHeight=void 0,e._flipX=!1,e._flipY=!1,e._alphaCutoff=.5,e._verticesData=new jo(4,[],[]),dn.resetData(ue(e)),e.setMaterial(e._engine._spriteMaskDefaultMaterial),e.shaderData.setFloat(s._alphaCutoffProperty,e._alphaCutoff),e._onSpriteChange=e._onSpriteChange.bind(ue(e)),e}var i=s.prototype;return i._cloneTo=function(e,r,a){n.prototype._cloneTo.call(this,e,r,a),e.sprite=this._sprite},i._updateBounds=function(e){this.sprite?dn.updatePositions(this):(e.min.set(0,0,0),e.max.set(0,0,0))},i._render=function(e){var r;if(!(!((r=this.sprite)!=null&&r.texture)||!this.width||!this.height)){var a=this.getMaterial();if(!!a){var o=this,l=o._engine;a.destroyed&&(a=l._spriteMaskDefaultMaterial),this._dirtyUpdateFlag&$e.WorldVolume&&(dn.updatePositions(this),this._dirtyUpdateFlag&=~$e.WorldVolume),this._dirtyUpdateFlag&2&&(dn.updateUVs(this),this._dirtyUpdateFlag&=-3),e.camera._renderPipeline._allSpriteMasks.add(this);var c=l._spriteMaskRenderDataPool.getFromPool();c.set(this,a,this._verticesData);var _=l._renderElementPool.getFromPool();_.set(c,a.shader.subShaders[0].passes),this._maskElement=_}}},i._onDestroy=function(){var e=this._sprite;e&&(this._addResourceReferCount(e,-1),e._updateFlagManager.removeListener(this._onSpriteChange)),n.prototype._onDestroy.call(this),this._sprite=null,this._verticesData=null},i._calDefaultSize=function(){var e=this._sprite;e?(this._automaticWidth=e.width,this._automaticHeight=e.height):this._automaticWidth=this._automaticHeight=0,this._dirtyUpdateFlag&=-5},i._onSpriteChange=function(e){switch(e){case Re.texture:this.shaderData.setTexture(s._textureProperty,this.sprite.texture);break;case Re.size:this._dirtyUpdateFlag|=4,(this._customWidth===void 0||this._customHeight===void 0)&&(this._dirtyUpdateFlag|=$e.WorldVolume);break;case Re.region:case Re.atlasRegionOffset:this._dirtyUpdateFlag|=3;break;case Re.atlasRegion:this._dirtyUpdateFlag|=2;break;case Re.pivot:this._dirtyUpdateFlag|=$e.WorldVolume;break;case Re.destroy:this.sprite=null;break}},q(s,[{key:"width",get:function(){return this._customWidth!==void 0?this._customWidth:(this._dirtyUpdateFlag&4&&this._calDefaultSize(),this._automaticWidth)},set:function(e){this._customWidth!==e&&(this._customWidth=e,this._dirtyUpdateFlag|=$e.WorldVolume)}},{key:"height",get:function(){return this._customHeight!==void 0?this._customHeight:(this._dirtyUpdateFlag&4&&this._calDefaultSize(),this._automaticHeight)},set:function(e){this._customHeight!==e&&(this._customHeight=e,this._dirtyUpdateFlag|=$e.WorldVolume)}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._dirtyUpdateFlag|=$e.WorldVolume)}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._dirtyUpdateFlag|=$e.WorldVolume)}},{key:"sprite",get:function(){return this._sprite},set:function(e){var r=this._sprite;r!==e&&(r&&(this._addResourceReferCount(r,-1),r._updateFlagManager.removeListener(this._onSpriteChange)),this._dirtyUpdateFlag|=7,e?(this._addResourceReferCount(e,1),e._updateFlagManager.addListener(this._onSpriteChange),this.shaderData.setTexture(s._textureProperty,e.texture)):this.shaderData.setTexture(s._textureProperty,null),this._sprite=e)}},{key:"alphaCutoff",get:function(){return this._alphaCutoff},set:function(e){this._alphaCutoff!==e&&(this._alphaCutoff=e,this.shaderData.setFloat(s._alphaCutoffProperty,e))}}]),s}(be);(function(){It._textureProperty=L.getByName("renderer_MaskTexture")})();(function(){It._alphaCutoffProperty=L.getByName("renderer_MaskAlphaCutoff")})();R([Pe],It.prototype,"influenceLayers",void 0);R([I],It.prototype,"_verticesData",void 0);R([I],It.prototype,"_sprite",void 0);R([I],It.prototype,"_automaticWidth",void 0);R([I],It.prototype,"_automaticHeight",void 0);R([Pe],It.prototype,"_customWidth",void 0);R([Pe],It.prototype,"_customHeight",void 0);R([Pe],It.prototype,"_flipX",void 0);R([Pe],It.prototype,"_flipY",void 0);R([Pe],It.prototype,"_alphaCutoff",void 0);R([I],It.prototype,"_onSpriteChange",null);var xs;(function(n){n[n.UV=2]="UV",n[n.RenderData=3]="RenderData",n[n.AutomaticSize=4]="AutomaticSize",n[n.All=7]="All"})(xs||(xs={}));var Pu=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._charInfoMap={},e._space=1,e._curX=1,e._curY=1,e._nextY=1,e}var i=s.prototype;return i.uploadCharTexture=function(e){var r=e.w,a=e.h,o=e.data,l=this,c=l._space,_=l.texture,u=_.width,d=r+c,h=a+c;if(1+d>=u||1+h>=u)throw Error("The char fontSize is too large.");var f=this._curX+d;f>=u&&(this._curX=c,this._curY=this._nextY+c);var v=this._curY+h;if(v>this._nextY&&(this._nextY=v),v>=u)return!1;r>0&&a>0&&o&&(e.bufferOffset=new $(this._curX,this._curY),_.setPixelBuffer(o,0,this._curX,this._curY,r,a),_.generateMipmaps());var p=1/u,g=this._curX,y=this._curY,m=r,x=a,S=g*p,b=(g+m)*p,A=y*p,C=(y+x)*p;e.x=g,e.y=y;var E=e.uvs;return E[0].set(S,A),E[1].set(b,A),E[2].set(b,C),E[3].set(S,C),this._curX+=d+c,!0},i.addCharInfo=function(e,r){this._charInfoMap[e.charCodeAt(0)]=r},i.getCharInfo=function(e){return this._charInfoMap[e.charCodeAt(0)]},i._onDestroy=function(){n.prototype._onDestroy.call(this),this.texture.destroy(),this.texture=null,this._charInfoMap={}},s}(rn),hr=function(){function n(){}return n.textContext=function(){var i=n._textContext;if(!i){var t;try{t=new OffscreenCanvas(0,0)}catch{t=document.createElement("canvas")}var e=t.getContext("2d",{willReadFrequently:!0});i={canvas:t,context:e},n._textContext=i}return i},n.measureFont=function(i){var t=n._fontSizeInfoCache,e=t[i];return e||(e=n._measureFontOrChar(i),t[i]=e,e)},n.getNativeFontString=function(i,t,e){var r=e&Bn.Bold?"bold ":"";return e&Bn.Italic&&(r+="italic "),!/([\"\'])[^\'\"]+\1/.test(i)&&n._genericFontFamilies.indexOf(i)==-1&&(i='"'+i+'"'),r+=t+"px "+i,r},n.measureChar=function(i,t){return n._measureFontOrChar(t,i)},n.measureTextWithWrap=function(i){var t=i._subFont,e=t.nativeFontString,r=n.measureFont(e),a=i.text.split(/(?:\r\n|\r|\n)/),o=new Array,l=new Array,c=new Array,_=yn._pixelsPerUnit,u=r.size+i.lineSpacing*_,d=i.width*_,h=0;t.nativeFontString=e;for(var f=0,v=a.length;f<v;f++){var p=a[f];if(p.length===0){this._pushLine(o,l,c,"",0,0,0);continue}for(var g="",y=0,m=0,x=0,S="",b=0,A=0,C=0,E=!1,T=0,B=p.length;T<B;++T){var M=p[T],P=n._getCharInfo(M,e,t),V=M.charCodeAt(0),N=V===32;if(!(N&&E&&S.length===0&&g.length===0)){var F=N||V>=19968&&V<=40959,O=P.w,D=P.offsetY,z=P.h*.5,U=z+D,Y=z-D;F?(g.length>0&&(b+y>d?(b>0&&this._pushLine(o,l,c,S,b,A,C),h=Math.max(h,b),E=!0,S=g,b=y,A=m,C=x):(S+=g,b+=y,A=Math.max(A,m),C=Math.max(C,x)),g="",y=m=x=0),b+O>d&&b>0?(this._pushLine(o,l,c,S,b,A,C),h=Math.max(h,b),E=!0,N?(S="",b=A=C=0):(S=M,b=P.xAdvance,A=U,C=Y)):(S+=M,b+=P.xAdvance,A=Math.max(A,U),C=Math.max(C,Y))):y+P.w>d?(b>0&&(this._pushLine(o,l,c,S,b,A,C),h=Math.max(h,b),S="",b=A=C=0),y>0&&this._pushLine(o,l,c,g,y,m,x),h=Math.max(h,y),E=!0,g=M,y=P.xAdvance,m=U,x=Y):(g+=M,y+=P.xAdvance,m=Math.max(m,U),x=Math.max(x,Y))}}y>0&&(b+y>d?(b>0&&this._pushLine(o,l,c,S,b,A,C),h=Math.max(h,b),b=0,y>0&&this._pushLine(o,l,c,g,y,m,x),h=Math.max(h,y)):(S+=g,b+=y,A=Math.max(A,m),C=Math.max(C,x))),b>0&&(this._pushLine(o,l,c,S,b,A,C),h=Math.max(h,b))}var K=i.height*_;return i.overflowMode===Zn.Overflow&&(K=u*o.length),{width:h,height:K,lines:o,lineWidths:l,lineHeight:u,lineMaxSizes:c}},n.measureTextWithoutWrap=function(i){var t=i._subFont,e=t.nativeFontString,r=n.measureFont(e),a=i.text.split(/(?:\r\n|\r|\n)/),o=a.length,l=new Array,c=new Array,_=new Array,u=yn._pixelsPerUnit,d=r.size+i.lineSpacing*u,h=0;t.nativeFontString=e;for(var f=0;f<o;++f){for(var v=a[f],p=0,g=0,y=0,m=0,x=v.length;m<x;++m){var S=n._getCharInfo(v[m],e,t);p+=S.xAdvance;var b=S.offsetY,A=S.h*.5,C=A+b,E=A-b;g<C&&(g=C),y<E&&(y=E)}p>0&&(this._pushLine(l,c,_,v,p,g,y),h=Math.max(h,p))}var T=i.height*u;return i.overflowMode===Zn.Overflow&&(T=d*l.length),{width:h,height:T,lines:l,lineWidths:c,lineHeight:d,lineMaxSizes:_}},n.getNativeFontHash=function(i,t,e){var r=e&Bn.Bold?"bold":"";return e&Bn.Italic&&(r+="italic"),!/([\"\'])[^\'\"]+\1/.test(i)&&n._genericFontFamilies.indexOf(i)==-1&&(i=""+i),r+=t+"px"+i,r},n._measureFontOrChar=function(i,t){t===void 0&&(t="");var e=n.textContext(),r=e.canvas,a=e.context;a.font=i;var o=t||n._measureString,l=Math.max(1,Math.round(a.measureText(o).width)),c=Math.ceil(a.measureText(n._measureBaseline).width),_=c*n._heightMultiplier;c=n._baselineMultiplier*c|0;var u=n._extendHeight;_+=u,c+=u*.5,r.width=l,r.height=_,a.font=i,a.fillStyle="#000",a.clearRect(0,0,l,_),a.textBaseline="middle",a.fillStyle="#fff",a.fillText(o,0,c);for(var d=a.getImageData(0,0,l,_).data,h=d.length,f=-1,v=-1,p,g=0,y=0,m=0,x=r.width,S=1/x,b=0;b<h;b+=4)if(d[b+3]!==0){var A=b*.25;p=~~(A*S),f===-1&&(f=p),p>v&&(v=p)}else d[b]=d[b+1]=d[b+2]=255;f!==-1&&v!==-1&&(g=c-f,y=v-c+1,m=g+y);var C={ascent:g,descent:y,size:m};if(t){var E=null;if(m>0){var T=x*4;E=new Uint8Array(d.buffer,f*T,m*T)}return{char:t,x:0,y:0,w:l,h:m,offsetX:0,offsetY:(g-y)*.5,xAdvance:l,uvs:[new $,new $,new $,new $],ascent:g,descent:y,index:0,data:E}}else return C},n._getCharInfo=function(i,t,e){var r=e._getCharInfo(i);return r||(r=n.measureChar(i,t),e._uploadCharTexture(r),e._addCharInfo(i,r)),r},n._pushLine=function(i,t,e,r,a,o,l){i.push(r),t.push(a),e.push({ascent:o,descent:l,size:o+l})},n}();(function(){hr._genericFontFamilies=["serif","sans-serif","monospace","cursive","fantasy","system-ui","math","emoji","fangsong"]})();(function(){hr._extendHeight=0})();(function(){hr._measureString="|\xC9q\xC5"})();(function(){hr._measureBaseline="M"})();(function(){hr._heightMultiplier=2})();(function(){hr._baselineMultiplier=1.4})();(function(){hr._fontSizeInfoCache={}})();(function(){hr._textContext=null})();var Bu=function(){function n(i){this._fontAtlases=[],this._lastIndex=-1,this._engine=i}var s=n.prototype;return s.destroy=function(){for(var t=this._fontAtlases,e=0,r=t.length;e<r;++e)t[e].destroy(!0);t.length=0},s._uploadCharTexture=function(t){var e=this._fontAtlases,r=this._lastIndex;r===-1&&(this._createFontAtlas(),r++);var a=e[r];a.uploadCharTexture(t)||(a=this._createFontAtlas(),a.uploadCharTexture(t),r++),this._lastIndex=r,t.data=null},s._addCharInfo=function(t,e){var r=this._lastIndex;e.index=r,this._fontAtlases[r].addCharInfo(t,e)},s._getCharInfo=function(t){for(var e=this._fontAtlases,r=0,a=e.length;r<a;++r){var o=e[r],l=o.getCharInfo(t);if(l)return l}return null},s._getTextureByIndex=function(t){var e=this._fontAtlases[t];return e?e.texture:null},s._getLastIndex=function(){return this._lastIndex},s._createFontAtlas=function(){var t=this,e=t._engine,r=new Pu(e),a=new bt(e,256,256,G.R8G8B8A8,!1);a.filterMode=ot.Bilinear,r.texture=a,r.isGCIgnored=a.isGCIgnored=!0,this._fontAtlases.push(r);var o=this.nativeFontString;return e.resourceManager.addContentRestorer(new(function(l){W(c,l);function c(){return l.call(this,r)}var _=c.prototype;return _.restoreContent=function(){var d=this.resource,h=d._charInfoMap,f=d.texture;for(var v in h){var p=h[v],g=hr.measureChar(p.char,o).data;if(p.w>0&&p.h>0&&g){var y=p.bufferOffset;f.setPixelBuffer(g,0,y.x,y.y,p.w,p.h)}}f.generateMipmaps()},c}(Rr))),r},n}(),pa=function(n){W(s,n);function s(t,e){e===void 0&&(e="");var r;return r=n.call(this,t)||this,r._name="",r._subFontMap={},r._name=e,r}var i=s.prototype;return i._getSubFont=function(e,r){var a=e+"-"+r,o=this._subFontMap,l=o[a];return l||(l=new Bu(this.engine),o[a]=l,l)},i._onDestroy=function(){n.prototype._onDestroy.call(this);var e=this._subFontMap;for(var r in e)e[r].destroy();this._subFontMap=null,delete this.engine._fontMap[this._name]},s.createFromOS=function(e,r){if(r){var a=e._fontMap,o=a[r];return o||(o=new s(e,r),a[r]=o,o)}return null},q(s,[{key:"name",get:function(){return this._name}}]),s}(rn),pc=function n(){this.localPositions=new ae;var s=[new w,new w,new w,new w];this.renderData=new jo(4,s,null,n.triangles,null)};(function(){pc.triangles=[0,2,1,2,0,3]})();var Du=function(){function n(i,t){this._elements=[],this._type=i;for(var e=this._elements,r=0;r<t;++r)e[r]=new i}var s=n.prototype;return s.get=function(){return this._elements.length>0?this._elements.pop():new this._type},s.put=function(t){this._elements.push(t)},n}(),st=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._subFont=null,e._charRenderDatas=[],e._dirtyFlag=15,e._color=new j(1,1,1,1),e._text="",e._width=0,e._height=0,e._localBounds=new nr,e._font=null,e._fontSize=24,e._fontStyle=Bn.None,e._lineSpacing=0,e._horizontalAlignment=Xn.Center,e._verticalAlignment=jn.Center,e._enableWrapping=!1,e._overflowMode=Zn.Overflow,e._maskInteraction=ht.None,e._maskLayer=ha.Layer0,e._init(),e}var i=s.prototype;return i._init=function(){var e=this.engine;this._font=e._textDefaultFont,this._addResourceReferCount(this._font,1),this.setMaterial(e._spriteDefaultMaterial)},i._onDestroy=function(){this._font&&(this._addResourceReferCount(this._font,-1),this._font=null),n.prototype._onDestroy.call(this);for(var e=this._charRenderDatas,r=0,a=e.length;r<a;++r)s._charRenderDataPool.put(e[r]);e.length=0,this._subFont&&(this._subFont=null)},i._cloneTo=function(e,r,a){n.prototype._cloneTo.call(this,e,r,a),e.font=this._font,e._subFont=this._subFont},i._isContainDirtyFlag=function(e){return(this._dirtyFlag&e)!=0},i._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},i._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},i._updateShaderData=function(e,r){if(r){this._updateMVPShaderData(e,J._identity);return}this._updateTransformShaderData(e,J._identity)},i._updateBounds=function(e){nr.transform(this._localBounds,this._entity.transform.worldMatrix,e)},i._render=function(e){if(!this._isTextNoVisible()){this._isContainDirtyFlag(16)&&(this._updateStencilState(),this._setDirtyFlagFalse(16)),this._isContainDirtyFlag(1)&&(this._resetSubFont(),this._setDirtyFlagFalse(1)),this._isContainDirtyFlag(2)&&(this._updateLocalData(),this._setDirtyFlagFalse(2)),this._isContainDirtyFlag(4)&&(this._updatePosition(),this._setDirtyFlagFalse(4));var r=this._engine._spriteRenderDataPool,a=this._engine._textRenderDataPool.getFromPool(),o=a.charsData,l=this.getMaterial(),c=this._charRenderDatas,_=c.length;a.component=this,a.material=l,o.length=_;for(var u=0;u<_;++u){var d=c[u],h=r.getFromPool();h.set(this,l,d.renderData,d.texture,u),o[u]=h}e.camera._renderPipeline.pushRenderData(e,a)}},i._updateStencilState=function(){var e=this.getInstanceMaterial(),r=e.renderState.stencilState,a=this._maskInteraction;if(a===ht.None)r.enabled=!1,r.writeMask=255,r.referenceValue=0,r.compareFunctionFront=r.compareFunctionBack=Te.Always;else{r.enabled=!0,r.writeMask=0,r.referenceValue=1;var o=a===ht.VisibleInsideMask?Te.LessEqual:Te.Greater;r.compareFunctionFront=o,r.compareFunctionBack=o}},i._resetSubFont=function(){var e=this._font;this._subFont=e._getSubFont(this.fontSize,this.fontStyle),this._subFont.nativeFontString=hr.getNativeFontString(e.name,this.fontSize,this.fontStyle)},i._updatePosition=function(){for(var e=this.entity.transform,r=e.worldMatrix.elements,a=this._charRenderDatas,o=r[0],l=r[1],c=r[2],_=r[4],u=r[5],d=r[6],h=r[12],f=r[13],v=r[14],p=s._tempVec31.set(_,u,d),g=s._tempVec30.set(o,l,c),y=0,m=a.length;y<m;++y){var x=a[y],S=x.localPositions,b=x.renderData.positions,A=S.x,C=S.y,E=b[0];E.x=A*o+C*_+h,E.y=A*l+C*u+f,E.z=A*c+C*d+v;var T=b[1];w.scale(g,S.z-A,T),w.add(E,T,T);var B=b[2];w.scale(p,S.w-C,B),w.add(E,B,b[3]),w.add(T,B,B)}},i._updateLocalData=function(){var e=this._localBounds,r=e.min,a=e.max,o=this,l=o.color,c=o._charRenderDatas,_=o._subFont,u=this.enableWrapping?hr.measureTextWithWrap(this):hr.measureTextWithoutWrap(this),d=u.height,h=u.lines,f=u.lineWidths,v=u.lineHeight,p=u.lineMaxSizes,g=s._charRenderDataPool,y=h.length,m=0;if(y>0){var x=yn._pixelsPerUnit,S=this.horizontalAlignment,b=1/x,A=this.width*x,C=A*.5,E=this.height*x,T=v*.5,B=0,M=v*.5-p[0].ascent,P=v*.5-p[y-1].descent-1;switch(this.verticalAlignment){case jn.Top:B=E*.5-T+M;break;case jn.Center:B=d*.5-T-(P-M)*.5;break;case jn.Bottom:B=d-E*.5-T-P;break}for(var V=-1,N=Number.MAX_SAFE_INTEGER,F=Number.MAX_SAFE_INTEGER,O=Number.MIN_SAFE_INTEGER,D=Number.MIN_SAFE_INTEGER,z=0;z<y;++z){var U=f[z];if(U>0){var Y=h[z],K=0,H=-1;switch(V<0&&(V=z),S){case Xn.Left:K=-C;break;case Xn.Center:K=-U*.5;break;case Xn.Right:K=C-U;break}for(var te=0,we=Y.length;te<we;++te){var pe=Y[te],oe=_._getCharInfo(pe);if(oe.h>0){var Ee,Ke;H<0&&(H=te);var vt=(Ee=c)[Ke=m++]||(Ee[Ke]=g.get()),Se=vt.renderData,nt=vt.localPositions;vt.texture=_._getTextureByIndex(oe.index),Se.color=l,Se.uvs=oe.uvs;var Je=oe.w,pt=oe.ascent,ce=oe.descent,_t=K*b,lr=(K+Je)*b,an=(B+pt)*b,Vr=(B-ce)*b;nt.set(_t,an,lr,Vr),z===V&&(D=Math.max(D,an)),F=Math.min(F,Vr),te===H&&(N=Math.min(N,_t)),O=Math.max(O,lr)}K+=oe.xAdvance}}B-=v}V<0?(r.set(0,0,0),a.set(0,0,0)):(r.set(N,F,0),a.set(O,D,0))}else r.set(0,0,0),a.set(0,0,0);var Tn=c.length;if(Tn>m){for(var on=m;on<Tn;++on)g.put(c[on]);c.length=m}_._getLastIndex()>0&&c.sort(function(Un,oi){return Un.texture.instanceId-oi.texture.instanceId})},i._onTransformChanged=function(e){n.prototype._onTransformChanged.call(this,e),this._setDirtyFlagTrue(12)},i._isTextNoVisible=function(){return this._text===""||this._fontSize===0||this.enableWrapping&&this.width<=0||this.overflowMode===Zn.Truncate&&this.height<=0},q(s,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.copyFrom(e)}},{key:"text",get:function(){return this._text},set:function(e){e=e||"",this._text!==e&&(this._text=e,this._setDirtyFlagTrue(14))}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._setDirtyFlagTrue(14))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._height=e,this._setDirtyFlagTrue(14))}},{key:"font",get:function(){return this._font},set:function(e){var r=this._font;r!==e&&(r&&this._addResourceReferCount(r,-1),e&&this._addResourceReferCount(e,1),this._font=e,this._setDirtyFlagTrue(15))}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._setDirtyFlagTrue(15))}},{key:"fontStyle",get:function(){return this._fontStyle},set:function(e){this.fontStyle!==e&&(this._fontStyle=e,this._setDirtyFlagTrue(15))}},{key:"lineSpacing",get:function(){return this._lineSpacing},set:function(e){this._lineSpacing!==e&&(this._lineSpacing=e,this._setDirtyFlagTrue(14))}},{key:"horizontalAlignment",get:function(){return this._horizontalAlignment},set:function(e){this._horizontalAlignment!==e&&(this._horizontalAlignment=e,this._setDirtyFlagTrue(14))}},{key:"verticalAlignment",get:function(){return this._verticalAlignment},set:function(e){this._verticalAlignment!==e&&(this._verticalAlignment=e,this._setDirtyFlagTrue(14))}},{key:"enableWrapping",get:function(){return this._enableWrapping},set:function(e){this._enableWrapping!==e&&(this._enableWrapping=e,this._setDirtyFlagTrue(14))}},{key:"overflowMode",get:function(){return this._overflowMode},set:function(e){this._overflowMode!==e&&(this._overflowMode=e,this._setDirtyFlagTrue(14))}},{key:"maskInteraction",get:function(){return this._maskInteraction},set:function(e){this._maskInteraction!==e&&(this._maskInteraction=e,this._setDirtyFlagTrue(16))}},{key:"maskLayer",get:function(){return this._maskLayer},set:function(e){this._maskLayer=e}},{key:"bounds",get:function(){if(this._isTextNoVisible()){if(this._isContainDirtyFlag(8)){var e=this._localBounds;e.min.set(0,0,0),e.max.set(0,0,0),this._updateBounds(this._bounds),this._setDirtyFlagFalse(8)}return this._bounds}return this._isContainDirtyFlag(1)&&this._resetSubFont(),this._isContainDirtyFlag(2)&&this._updateLocalData(),this._isContainDirtyFlag(4)&&this._updatePosition(),this._isContainDirtyFlag(8)&&this._updateBounds(this._bounds),this._setDirtyFlagFalse(15),this._bounds}}]),s}(be);(function(){st._charRenderDataPool=new Du(pc,50)})();(function(){st._tempVec30=new w})();(function(){st._tempVec31=new w})();R([Pe],st.prototype,"_subFont",void 0);R([I],st.prototype,"_charRenderDatas",void 0);R([I],st.prototype,"_dirtyFlag",void 0);R([Z],st.prototype,"_color",void 0);R([Pe],st.prototype,"_text",void 0);R([Pe],st.prototype,"_width",void 0);R([Pe],st.prototype,"_height",void 0);R([I],st.prototype,"_localBounds",void 0);R([Pe],st.prototype,"_font",void 0);R([Pe],st.prototype,"_fontSize",void 0);R([Pe],st.prototype,"_fontStyle",void 0);R([Pe],st.prototype,"_lineSpacing",void 0);R([Pe],st.prototype,"_horizontalAlignment",void 0);R([Pe],st.prototype,"_verticalAlignment",void 0);R([Pe],st.prototype,"_enableWrapping",void 0);R([Pe],st.prototype,"_overflowMode",void 0);R([Pe],st.prototype,"_maskInteraction",void 0);R([Pe],st.prototype,"_maskLayer",void 0);var bs;(function(n){n[n.SubFont=1]="SubFont",n[n.LocalPositionBounds=2]="LocalPositionBounds",n[n.WorldPosition=4]="WorldPosition",n[n.WorldBounds=8]="WorldBounds",n[n.MaskInteraction=16]="MaskInteraction",n[n.Position=14]="Position",n[n.Font=15]="Font"})(bs||(bs={}));var qn;(function(n){n[n.Normal=0]="Normal",n[n.Additive=1]="Additive"})(qn||(qn={}));var hn;(function(n){n[n.Front=0]="Front",n[n.Back=1]="Back",n[n.Double=2]="Double"})(hn||(hn={}));var Mr=function(n){W(s,n);function s(t,e){var r;return r=n.call(this,t)||this,r._renderStates=[],r._priority=0,r._shaderData=new Hr(Tr.Material),r.shader=e,r}var i=s.prototype;return i.clone=function(){var e=new s(this._engine,this.shader);return this.cloneTo(e),e},i.cloneTo=function(e){e.shader=this.shader,this.shaderData.cloneTo(e.shaderData),Br.deepCloneObject(this.renderStates,e.renderStates)},i._addReferCount=function(e){this._destroyed||(n.prototype._addReferCount.call(this,e),this.shaderData._addReferCount(e),this._shader._addReferCount(e))},i._onDestroy=function(){n.prototype._onDestroy.call(this),this._shader=null,this._shaderData=null,this._renderStates.length=0,this._renderStates=null},q(s,[{key:"shaderData",get:function(){return this._shaderData}},{key:"shader",get:function(){return this._shader},set:function(e){var r=this._getReferCount();if(r>0){var a;(a=this._shader)==null||a._addReferCount(-r),e._addReferCount(r)}this._shader=e;for(var o=this._renderStates,l=o.length,c=0,_=e.subShaders,u=0;u<_.length;u++)c=Math.max(_[u].passes.length,c);if(l<c)for(var d=l;d<c;d++)o.push(new en);else o.length=c}},{key:"renderState",get:function(){return this._renderStates[0]}},{key:"renderStates",get:function(){return this._renderStates}}]),s}(rn),ke=function(n){W(s,n);function s(t,e){var r;return r=n.call(this,t,e)||this,r._renderFace=hn.Front,r._isTransparent=!1,r._blendMode=qn.Normal,r.shaderData.setFloat(s._alphaCutoffProp,0),r}var i=s.prototype;return i.setIsTransparent=function(e,r){var a=this.renderStates;if(a.length<e)throw"Pass should less than pass count.";var o=a[e];r?(o.blendState.targetBlendState.enabled=!0,o.depthState.writeEnabled=!1,o.renderQueueType=mt.Transparent,this.shaderData.enableMacro(s._transparentMacro)):(o.blendState.targetBlendState.enabled=!1,o.depthState.writeEnabled=!0,o.renderQueueType=this.shaderData.getFloat(s._alphaCutoffProp)?mt.AlphaTest:mt.Opaque,this.shaderData.disableMacro(s._transparentMacro))},i.setBlendMode=function(e,r){var a=this.renderStates;if(a.length<e)throw"Pass should less than pass count.";var o=a[e].blendState,l=o.targetBlendState;switch(r){case qn.Normal:l.sourceColorBlendFactor=Ae.SourceAlpha,l.destinationColorBlendFactor=Ae.OneMinusSourceAlpha,l.sourceAlphaBlendFactor=Ae.One,l.destinationAlphaBlendFactor=Ae.OneMinusSourceAlpha,l.colorBlendOperation=l.alphaBlendOperation=Wt.Add;break;case qn.Additive:l.sourceColorBlendFactor=Ae.SourceAlpha,l.destinationColorBlendFactor=Ae.One,l.sourceAlphaBlendFactor=Ae.One,l.destinationAlphaBlendFactor=Ae.OneMinusSourceAlpha,l.colorBlendOperation=l.alphaBlendOperation=Wt.Add;break}},i.setRenderFace=function(e,r){var a=this.renderStates;if(a.length<e)throw"Pass should less than pass count.";switch(r){case hn.Front:a[e].rasterState.cullMode=Xt.Back;break;case hn.Back:a[e].rasterState.cullMode=Xt.Front;break;case hn.Double:a[e].rasterState.cullMode=Xt.Off;break}},i.clone=function(){var e=new s(this._engine,this.shader);return this.cloneTo(e),e},i.cloneTo=function(e){n.prototype.cloneTo.call(this,e),e._renderFace=this._renderFace,e._isTransparent=this._isTransparent,e._blendMode=this._blendMode},q(s,[{key:"shader",get:function(){return this._shader},set:function(e){var r=this._getReferCount();if(r>0){var a;(a=this._shader)==null||a._addReferCount(-r),e._addReferCount(r)}this._shader=e;for(var o=this._renderStates,l=o.length,c=0,_=e.subShaders,u=0;u<_.length;u++)c=Math.max(_[u].passes.length,c);if(l<c)for(var d=l;d<c;d++)o.push(new en),this.setBlendMode(d,qn.Normal);else o.length=c}},{key:"isTransparent",get:function(){return this._isTransparent},set:function(e){e!==this._isTransparent&&(this.setIsTransparent(0,e),this._isTransparent=e)}},{key:"blendMode",get:function(){return this._blendMode},set:function(e){e!==this._blendMode&&(this.setBlendMode(0,e),this._blendMode=e)}},{key:"alphaCutoff",get:function(){return this.shaderData.getFloat(s._alphaCutoffProp)},set:function(e){var r=this.shaderData;if(r.getFloat(s._alphaCutoffProp)!==e){e?r.enableMacro(s._alphaCutoffMacro):r.disableMacro(s._alphaCutoffMacro);for(var a=this.renderStates,o=0,l=a.length;o<l;o++){var c=a[o];e>0?c.renderQueueType=c.blendState.targetBlendState.enabled?mt.Transparent:mt.AlphaTest:c.renderQueueType=c.blendState.targetBlendState.enabled?mt.Transparent:mt.Opaque}r.setFloat(s._alphaCutoffProp,e)}}},{key:"renderFace",get:function(){return this._renderFace},set:function(e){e!==this._renderFace&&(this.setRenderFace(0,e),this._renderFace=e)}}]),s}(Mr);(function(){ke._baseTextureMacro=ie.getByName("MATERIAL_HAS_BASETEXTURE")})();(function(){ke._normalTextureMacro=ie.getByName("MATERIAL_HAS_NORMALTEXTURE")})();(function(){ke._emissiveTextureMacro=ie.getByName("MATERIAL_HAS_EMISSIVETEXTURE")})();(function(){ke._transparentMacro=ie.getByName("MATERIAL_IS_TRANSPARENT")})();(function(){ke._baseColorProp=L.getByName("material_BaseColor")})();(function(){ke._baseTextureProp=L.getByName("material_BaseTexture")})();(function(){ke._tilingOffsetProp=L.getByName("material_TilingOffset")})();(function(){ke._normalTextureProp=L.getByName("material_NormalTexture")})();(function(){ke._normalIntensityProp=L.getByName("material_NormalIntensity")})();(function(){ke._emissiveColorProp=L.getByName("material_EmissiveColor")})();(function(){ke._emissiveTextureProp=L.getByName("material_EmissiveTexture")})();(function(){ke._alphaCutoffProp=L.getByName("material_AlphaCutoff")})();(function(){ke._alphaCutoffMacro=ie.getByName("MATERIAL_IS_ALPHA_CUTOFF")})();var Ka=function(n){W(s,n);function s(t){var e;e=n.call(this,t,ne.find("blinn-phong"))||this;var r=e.shaderData;return r.enableMacro("MATERIAL_NEED_WORLD_POS"),r.enableMacro("MATERIAL_NEED_TILING_OFFSET"),r.setColor(s._baseColorProp,new j(1,1,1,1)),r.setColor(s._specularColorProp,new j(1,1,1,1)),r.setColor(s._emissiveColorProp,new j(0,0,0,1)),r.setVector4(s._tilingOffsetProp,new ae(1,1,0,0)),r.setFloat(s._shininessProp,16),r.setFloat(s._normalIntensityProp,1),e}var i=s.prototype;return i.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},q(s,[{key:"baseColor",get:function(){return this.shaderData.getColor(s._baseColorProp)},set:function(e){var r=this.shaderData.getColor(s._baseColorProp);e!==r&&r.copyFrom(e)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(s._baseTextureProp)},set:function(e){this.shaderData.setTexture(s._baseTextureProp,e),e?this.shaderData.enableMacro(s._baseTextureMacro):this.shaderData.disableMacro(s._baseTextureMacro)}},{key:"specularColor",get:function(){return this.shaderData.getColor(s._specularColorProp)},set:function(e){var r=this.shaderData.getColor(s._specularColorProp);e!==r&&r.copyFrom(e)}},{key:"specularTexture",get:function(){return this.shaderData.getTexture(s._specularTextureProp)},set:function(e){this.shaderData.setTexture(s._specularTextureProp,e),e?this.shaderData.enableMacro("MATERIAL_HAS_SPECULAR_TEXTURE"):this.shaderData.disableMacro("MATERIAL_HAS_SPECULAR_TEXTURE")}},{key:"emissiveColor",get:function(){return this.shaderData.getColor(s._emissiveColorProp)},set:function(e){var r=this.shaderData.getColor(s._emissiveColorProp);e!==r&&r.copyFrom(e)}},{key:"emissiveTexture",get:function(){return this.shaderData.getTexture(s._emissiveTextureProp)},set:function(e){this.shaderData.setTexture(s._emissiveTextureProp,e),e?this.shaderData.enableMacro(s._emissiveTextureMacro):this.shaderData.disableMacro(s._emissiveTextureMacro)}},{key:"normalTexture",get:function(){return this.shaderData.getTexture(s._normalTextureProp)},set:function(e){this.shaderData.setTexture(s._normalTextureProp,e),e?this.shaderData.enableMacro(s._normalTextureMacro):this.shaderData.disableMacro(s._normalTextureMacro)}},{key:"normalIntensity",get:function(){return this.shaderData.getFloat(s._normalIntensityProp)},set:function(e){this.shaderData.setFloat(s._normalIntensityProp,e)}},{key:"shininess",get:function(){return this.shaderData.getFloat(s._shininessProp)},set:function(e){this.shaderData.setFloat(s._shininessProp,Math.max(e,1e-4))}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(s._tilingOffsetProp)},set:function(e){var r=this.shaderData.getVector4(s._tilingOffsetProp);e!==r&&r.copyFrom(e)}}]),s}(ke);(function(){Ka._specularColorProp=L.getByName("material_SpecularColor")})();(function(){Ka._shininessProp=L.getByName("material_Shininess")})();(function(){Ka._specularTextureProp=L.getByName("material_SpecularTexture")})();var Vn;(function(n){n[n.UV0=0]="UV0",n[n.UV1=1]="UV1",n[n.UV2=2]="UV2",n[n.UV3=3]="UV3",n[n.UV4=4]="UV4",n[n.UV5=5]="UV5",n[n.UV6=6]="UV6",n[n.UV7=7]="UV7"})(Vn||(Vn={}));var Wr=function(n){W(s,n);function s(i,t){var e;e=n.call(this,i,t)||this;var r=e.shaderData;return r.enableMacro("MATERIAL_NEED_WORLD_POS"),r.enableMacro("MATERIAL_NEED_TILING_OFFSET"),r.setColor(s._baseColorProp,new j(1,1,1,1)),r.setColor(s._emissiveColorProp,new j(0,0,0,1)),r.setVector4(s._tilingOffsetProp,new ae(1,1,0,0)),r.setFloat(s._normalIntensityProp,1),r.setFloat(s._occlusionTextureIntensityProp,1),r.setFloat(s._occlusionTextureCoordProp,Vn.UV0),r.setFloat(s._clearCoatProp,0),r.setFloat(s._clearCoatRoughnessProp,0),e}return q(s,[{key:"baseColor",get:function(){return this.shaderData.getColor(s._baseColorProp)},set:function(t){var e=this.shaderData.getColor(s._baseColorProp);t!==e&&e.copyFrom(t)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(s._baseTextureProp)},set:function(t){this.shaderData.setTexture(s._baseTextureProp,t),t?this.shaderData.enableMacro(s._baseTextureMacro):this.shaderData.disableMacro(s._baseTextureMacro)}},{key:"normalTexture",get:function(){return this.shaderData.getTexture(s._normalTextureProp)},set:function(t){this.shaderData.setTexture(s._normalTextureProp,t),t?this.shaderData.enableMacro(s._normalTextureMacro):this.shaderData.disableMacro(s._normalTextureMacro)}},{key:"normalTextureIntensity",get:function(){return this.shaderData.getFloat(s._normalIntensityProp)},set:function(t){this.shaderData.setFloat(s._normalIntensityProp,t)}},{key:"emissiveColor",get:function(){return this.shaderData.getColor(s._emissiveColorProp)},set:function(t){var e=this.shaderData.getColor(s._emissiveColorProp);t!==e&&e.copyFrom(t)}},{key:"emissiveTexture",get:function(){return this.shaderData.getTexture(s._emissiveTextureProp)},set:function(t){this.shaderData.setTexture(s._emissiveTextureProp,t),t?this.shaderData.enableMacro(s._emissiveTextureMacro):this.shaderData.disableMacro(s._emissiveTextureMacro)}},{key:"occlusionTexture",get:function(){return this.shaderData.getTexture(s._occlusionTextureProp)},set:function(t){this.shaderData.setTexture(s._occlusionTextureProp,t),t?this.shaderData.enableMacro("MATERIAL_HAS_OCCLUSION_TEXTURE"):this.shaderData.disableMacro("MATERIAL_HAS_OCCLUSION_TEXTURE")}},{key:"occlusionTextureIntensity",get:function(){return this.shaderData.getFloat(s._occlusionTextureIntensityProp)},set:function(t){this.shaderData.setFloat(s._occlusionTextureIntensityProp,t)}},{key:"occlusionTextureCoord",get:function(){return this.shaderData.getFloat(s._occlusionTextureCoordProp)},set:function(t){t>Vn.UV1&&ve.warn("Occlusion texture uv coordinate must be UV0 or UV1."),this.shaderData.setFloat(s._occlusionTextureCoordProp,t)}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(s._tilingOffsetProp)},set:function(t){var e=this.shaderData.getVector4(s._tilingOffsetProp);t!==e&&e.copyFrom(t)}},{key:"clearCoat",get:function(){return this.shaderData.getFloat(s._clearCoatProp)},set:function(t){!!this.shaderData.getFloat(s._clearCoatProp)!=!!t&&(t===0?this.shaderData.disableMacro("MATERIAL_ENABLE_CLEAR_COAT"):this.shaderData.enableMacro("MATERIAL_ENABLE_CLEAR_COAT")),this.shaderData.setFloat(s._clearCoatProp,t)}},{key:"clearCoatTexture",get:function(){return this.shaderData.getTexture(s._clearCoatTextureProp)},set:function(t){this.shaderData.setTexture(s._clearCoatTextureProp,t),t?this.shaderData.enableMacro("MATERIAL_HAS_CLEAR_COAT_TEXTURE"):this.shaderData.disableMacro("MATERIAL_HAS_CLEAR_COAT_TEXTURE")}},{key:"clearCoatRoughness",get:function(){return this.shaderData.getFloat(s._clearCoatRoughnessProp)},set:function(t){this.shaderData.setFloat(s._clearCoatRoughnessProp,t)}},{key:"clearCoatRoughnessTexture",get:function(){return this.shaderData.getTexture(s._clearCoatRoughnessTextureProp)},set:function(t){this.shaderData.setTexture(s._clearCoatRoughnessTextureProp,t),t?this.shaderData.enableMacro("MATERIAL_HAS_CLEAR_COAT_ROUGHNESS_TEXTURE"):this.shaderData.disableMacro("MATERIAL_HAS_CLEAR_COAT_ROUGHNESS_TEXTURE")}},{key:"clearCoatNormalTexture",get:function(){return this.shaderData.getTexture(s._clearCoatNormalTextureProp)},set:function(t){this.shaderData.setTexture(s._clearCoatNormalTextureProp,t),t?this.shaderData.enableMacro("MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE"):this.shaderData.disableMacro("MATERIAL_HAS_CLEAR_COAT_NORMAL_TEXTURE")}}]),s}(ke);(function(){Wr._occlusionTextureIntensityProp=L.getByName("material_OcclusionIntensity")})();(function(){Wr._occlusionTextureCoordProp=L.getByName("material_OcclusionTextureCoord")})();(function(){Wr._occlusionTextureProp=L.getByName("material_OcclusionTexture")})();(function(){Wr._clearCoatProp=L.getByName("material_ClearCoat")})();(function(){Wr._clearCoatTextureProp=L.getByName("material_ClearCoatTexture")})();(function(){Wr._clearCoatRoughnessProp=L.getByName("material_ClearCoatRoughness")})();(function(){Wr._clearCoatRoughnessTextureProp=L.getByName("material_ClearCoatRoughnessTexture")})();(function(){Wr._clearCoatNormalTextureProp=L.getByName("material_ClearCoatNormalTexture")})();var Jr=function(n){W(s,n);function s(t){var e;e=n.call(this,t,ne.find("pbr"))||this,e._anisotropyRotation=0;var r=e.shaderData;return r.setFloat(s._metallicProp,1),r.setFloat(s._roughnessProp,1),r.setFloat(s._iorProp,1.5),r.setVector3(s._anisotropyInfoProp,new w(1,0,0)),e}var i=s.prototype;return i.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},q(s,[{key:"ior",get:function(){return this.shaderData.getFloat(s._iorProp)},set:function(e){this.shaderData.setFloat(s._iorProp,Math.max(e,0))}},{key:"metallic",get:function(){return this.shaderData.getFloat(s._metallicProp)},set:function(e){this.shaderData.setFloat(s._metallicProp,e)}},{key:"roughness",get:function(){return this.shaderData.getFloat(s._roughnessProp)},set:function(e){this.shaderData.setFloat(s._roughnessProp,e)}},{key:"roughnessMetallicTexture",get:function(){return this.shaderData.getTexture(s._roughnessMetallicTextureProp)},set:function(e){this.shaderData.setTexture(s._roughnessMetallicTextureProp,e),e?this.shaderData.enableMacro("MATERIAL_HAS_ROUGHNESS_METALLIC_TEXTURE"):this.shaderData.disableMacro("MATERIAL_HAS_ROUGHNESS_METALLIC_TEXTURE")}},{key:"anisotropy",get:function(){return this.shaderData.getVector3(s._anisotropyInfoProp).z},set:function(e){var r=this.shaderData.getVector3(s._anisotropyInfoProp);!!r.z!=!!e&&(e===0?this.shaderData.disableMacro("MATERIAL_ENABLE_ANISOTROPY"):this.shaderData.enableMacro("MATERIAL_ENABLE_ANISOTROPY")),r.z=e}},{key:"anisotropyRotation",get:function(){return this._anisotropyRotation},set:function(e){if(this._anisotropyRotation!==e){this._anisotropyRotation=e;var r=this.shaderData.getVector3(s._anisotropyInfoProp),a=k.degreeToRadFactor*e;r.x=Math.cos(a),r.y=Math.sin(a)}}},{key:"anisotropyTexture",get:function(){return this.shaderData.getTexture(s._anisotropyTextureProp)},set:function(e){this.shaderData.setTexture(s._anisotropyTextureProp,e),e?this.shaderData.enableMacro("MATERIAL_HAS_ANISOTROPY_TEXTURE"):this.shaderData.disableMacro("MATERIAL_HAS_ANISOTROPY_TEXTURE")}}]),s}(Wr);(function(){Jr._metallicProp=L.getByName("material_Metal")})();(function(){Jr._roughnessProp=L.getByName("material_Roughness")})();(function(){Jr._roughnessMetallicTextureProp=L.getByName("material_RoughnessMetallicTexture")})();(function(){Jr._iorProp=L.getByName("material_IOR")})();(function(){Jr._anisotropyInfoProp=L.getByName("material_AnisotropyInfo")})();(function(){Jr._anisotropyTextureProp=L.getByName("material_AnisotropyTexture")})();var na=function(n){W(s,n);function s(t){var e;return e=n.call(this,t,ne.find("pbr-specular"))||this,e.shaderData.setColor(s._specularColorProp,new j(1,1,1,1)),e.shaderData.setFloat(s._glossinessProp,1),e}var i=s.prototype;return i.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},q(s,[{key:"specularColor",get:function(){return this.shaderData.getColor(s._specularColorProp)},set:function(e){var r=this.shaderData.getColor(s._specularColorProp);e!==r&&r.copyFrom(e)}},{key:"glossiness",get:function(){return this.shaderData.getFloat(s._glossinessProp)},set:function(e){this.shaderData.setFloat(s._glossinessProp,e)}},{key:"specularGlossinessTexture",get:function(){return this.shaderData.getTexture(s._specularGlossinessTextureProp)},set:function(e){this.shaderData.setTexture(s._specularGlossinessTextureProp,e),e?this.shaderData.enableMacro(s._specularGlossinessTextureMacro):this.shaderData.disableMacro(s._specularGlossinessTextureMacro)}}]),s}(Wr);(function(){na._specularColorProp=L.getByName("material_PBRSpecularColor")})();(function(){na._glossinessProp=L.getByName("material_Glossiness")})();(function(){na._specularGlossinessTextureProp=L.getByName("material_SpecularGlossinessTexture")})();(function(){na._specularGlossinessTextureMacro=ie.getByName("MATERIAL_HAS_SPECULAR_GLOSSINESS_TEXTURE")})();var gc=function(n){W(s,n);function s(t){var e;e=n.call(this,t,ne.find("unlit"))||this;var r=e.shaderData;return r.enableMacro("MATERIAL_OMIT_NORMAL"),r.enableMacro("MATERIAL_NEED_TILING_OFFSET"),r.setColor(s._baseColorProp,new j(1,1,1,1)),r.setVector4(s._tilingOffsetProp,new ae(1,1,0,0)),e}var i=s.prototype;return i.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},q(s,[{key:"baseColor",get:function(){return this.shaderData.getColor(s._baseColorProp)},set:function(e){var r=this.shaderData.getColor(s._baseColorProp);e!==r&&r.copyFrom(e)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(s._baseTextureProp)},set:function(e){this.shaderData.setTexture(s._baseTextureProp,e),e?this.shaderData.enableMacro(s._baseTextureMacro):this.shaderData.disableMacro(s._baseTextureMacro)}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(s._tilingOffsetProp)},set:function(e){var r=this.shaderData.getVector4(s._tilingOffsetProp);e!==r&&r.copyFrom(e)}}]),s}(ke),Lu=function(){function n(i){var t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),e=new Float32Array([1,-1,1,0,-1,-1,0,0,1,1,1,1,-1,1,0,1]),r=new Mr(i,ne.find("blit"));r._addReferCount(1),r.renderState.depthState.enabled=!1,r.renderState.depthState.writeEnabled=!1,this.blitMesh=this._createBlitMesh(i,t),this.flipYBlitMesh=this._createBlitMesh(i,e),this.blitMaterial=r}var s=n.prototype;return s._createBlitMesh=function(t,e){var r=new ct(t);return r._addReferCount(1),r.setVertexElements([new Me("POSITION_UV",0,ee.Vector4,0)]),r.setVertexBufferBinding(new ir(t,Nt.VertexBuffer,e,tt.Static),16),r.addSubMesh(0,4,kr.TriangleStrip),r},n}(),mn;(function(n){n[n.Layer0=1]="Layer0",n[n.Layer1=2]="Layer1",n[n.Layer2=4]="Layer2",n[n.Layer3=8]="Layer3",n[n.Layer4=16]="Layer4",n[n.Layer5=32]="Layer5",n[n.Layer6=64]="Layer6",n[n.Layer7=128]="Layer7",n[n.Layer8=256]="Layer8",n[n.Layer9=512]="Layer9",n[n.Layer10=1024]="Layer10",n[n.Layer11=2048]="Layer11",n[n.Layer12=4096]="Layer12",n[n.Layer13=8192]="Layer13",n[n.Layer14=16384]="Layer14",n[n.Layer15=32768]="Layer15",n[n.Layer16=65536]="Layer16",n[n.Layer17=131072]="Layer17",n[n.Layer18=262144]="Layer18",n[n.Layer19=524288]="Layer19",n[n.Layer20=1048576]="Layer20",n[n.Layer21=2097152]="Layer21",n[n.Layer22=4194304]="Layer22",n[n.Layer23=8388608]="Layer23",n[n.Layer24=16777216]="Layer24",n[n.Layer25=33554432]="Layer25",n[n.Layer26=67108864]="Layer26",n[n.Layer27=134217728]="Layer27",n[n.Layer28=268435456]="Layer28",n[n.Layer29=536870912]="Layer29",n[n.Layer30=1073741824]="Layer30",n[n.Layer31=2147483648]="Layer31",n[n.Everything=4294967295]="Everything",n[n.Nothing=0]="Nothing"})(mn||(mn={}));var Vu=function(){function n(){}return n.cloneComponent=function(i,t,e,r){var a=Br.getCloneMode(i.constructor);for(var o in i)Br.cloneProperty(i,t,o,a[o]);i._cloneTo&&i._cloneTo(t,e,r)},n}(),Qr=function(n){W(s,n);function s(t,e){var r;return r=n.call(this,t)||this,r.layer=mn.Layer0,r._isActiveInHierarchy=!1,r._isActiveInScene=!1,r._components=[],r._scripts=new Ye,r._children=[],r._isRoot=!1,r._isActive=!0,r._siblingIndex=-1,r._isTemplate=!1,r._parent=null,r._invModelMatrix=new J,r.name=e,r.transform=r.addComponent(me),r._inverseWorldMatFlag=r.transform.registerWorldChangeFlag(),r}var i=s.prototype;return i.addComponent=function(e){fa._addCheck(this,e);var r=new e(this);return this._components.push(r),r._setActive(!0,he.All),r},i.getComponent=function(e){for(var r=this._components,a=0,o=r.length;a<o;a++){var l=r[a];if(ft(l,e))return l}return null},i.getComponents=function(e,r){r.length=0;for(var a=this._components,o=0,l=a.length;o<l;o++){var c=a[o];ft(c,e)&&r.push(c)}return r},i.getComponentsIncludeChildren=function(e,r){return r.length=0,this._getComponentsInChildren(e,r),r},i.addChild=function(e,r){var a;if(typeof e=="number"?a=e:(a=void 0,r=e),r._isRoot){r._scene._removeFromEntityList(r),r._isRoot=!1,this._addToChildrenList(a,r),r._parent=this;var o=r._scene,l=this._scene,c=he.None;this._isActiveInHierarchy||r._isActiveInHierarchy&&(c|=he.Hierarchy),r._isActiveInScene&&(this._isActiveInScene?o!==l&&(c|=he.Scene):c|=he.Scene),c&&r._processInActive(c),r._scene!==l&&s._traverseSetOwnerScene(r,l);var _=he.None;r._isActive&&(this._isActiveInHierarchy&&!r._isActiveInHierarchy&&(_|=he.Hierarchy),this._isActiveInScene&&(!r._isActiveInScene||o!==l)&&(_|=he.Scene)),_&&r._processActive(_),r._setTransformDirty()}else r._setParent(this,a)},i.removeChild=function(e){e._setParent(null)},i.getChild=function(e){return this._children[e]},i.findByName=function(e){if(e===this.name)return this;for(var r=this._children,a=0,o=r.length;a<o;a++){var l=r[a].findByName(e);if(l)return l}return null},i.findByPath=function(e){for(var r=e.split("/"),a=this,o=0,l=r.length;o<l;++o){var c=r[o];if(c&&(a=s._findChildByName(a,c),!a))return null}return a},i.createChild=function(e){var r=new s(this.engine,e);return r.layer=this.layer,r.parent=this,r},i.clearChildren=function(){for(var e=this._children,r=e.length-1;r>=0;r--){var a=e[r];a._parent=null;var o=he.None;a._isActiveInHierarchy&&(o|=he.Hierarchy),a._isActiveInScene&&(o|=he.Scene),o&&a._processInActive(o),s._traverseSetOwnerScene(a,null)}e.length=0},i.clone=function(){var e=this._createCloneEntity(this);return this._parseCloneEntity(this,e,this,e),e},i._markAsTemplate=function(e){this._isTemplate=!0,this._templateResource=e},i._createCloneEntity=function(e){var r=new s(e._engine,e.name),a=this._templateResource;a&&(r._templateResource=a,a._addReferCount(1)),r.layer=e.layer,r._isActive=e._isActive;var o=r.transform,l=e.transform;o.position=l.position,o.rotation=l.rotation,o.scale=l.scale;for(var c=e._children,_=0,u=e._children.length;_<u;_++)r.addChild(this._createCloneEntity(c[_]));return r},i._parseCloneEntity=function(e,r,a,o){for(var l=e._children,c=r._children,_=0,u=l.length;_<u;_++)this._parseCloneEntity(l[_],c[_],a,o);for(var d=e._components,h=0,f=d.length;h<f;h++){var v=d[h];if(!ft(v,me)){var p=r.addComponent(v.constructor);Vu.cloneComponent(v,p,a,o)}}},i.destroy=function(){if(!this._destroyed){n.prototype.destroy.call(this),this._templateResource&&(this._isTemplate||this._templateResource._addReferCount(-1),this._templateResource=null);for(var e=this._components,r=e.length-1;r>=0;r--)e[r].destroy();this._components.length=0;for(var a=this._children;a.length>0;)a[0].destroy();this._isRoot?this._scene.removeRootEntity(this):this._setParent(null),this.isActive=!1}},i._removeComponent=function(e){fa._removeCheck(this,e.constructor);var r=this._components;r.splice(r.indexOf(e),1)},i._addScript=function(e){e._entityScriptsIndex=this._scripts.length,this._scripts.add(e)},i._removeScript=function(e){var r=this._scripts.deleteByIndex(e._entityScriptsIndex);r&&(r._entityScriptsIndex=e._entityScriptsIndex),e._entityScriptsIndex=-1},i._removeFromParent=function(){var e=this._parent;if(e!=null){var r=e._children,a=this._siblingIndex;r.splice(a,1);for(var o=r.length;a<o;a++)r[a]._siblingIndex--;this._parent=null,this._siblingIndex=-1}},i._processActive=function(e){if(this._activeChangedComponents)throw"Note: can't set the 'main inActive entity' active in hierarchy, if the operation is in main inActive entity or it's children script's onDisable Event.";this._activeChangedComponents=this._scene._componentsManager.getActiveChangedTempList(),this._setActiveInHierarchy(this._activeChangedComponents,e),this._setActiveComponents(!0,e)},i._processInActive=function(e){if(this._activeChangedComponents)throw"Note: can't set the 'main active entity' inActive in hierarchy, if the operation is in main active entity or it's children script's onEnable Event.";this._activeChangedComponents=this._scene._componentsManager.getActiveChangedTempList(),this._setInActiveInHierarchy(this._activeChangedComponents,e),this._setActiveComponents(!1,e)},i._addToChildrenList=function(e,r){var a=this._children,o=a.length;if(e===void 0)r._siblingIndex=o,a.push(r);else{if(e<0||e>o)throw"The index "+e+" is out of child list bounds "+o;r._siblingIndex=e,a.splice(e,0,r);for(var l=e+1,c=o+1;l<c;l++)a[l]._siblingIndex++}},i._setParent=function(e,r){var a=this._parent;if(e!==a){if(this._removeFromParent(),this._parent=e,e){e._addToChildrenList(r,this);var o=this._scene,l=e._scene,c=he.None;e._isActiveInHierarchy||this._isActiveInHierarchy&&(c|=he.Hierarchy),e._isActiveInScene?this._isActiveInScene&&o!==l&&(c|=he.Scene):this._isActiveInScene&&(c|=he.Scene),c&&this._processInActive(c),o!==l&&s._traverseSetOwnerScene(this,l);var _=he.None;this._isActive&&(e._isActiveInHierarchy&&!this._isActiveInHierarchy&&(_|=he.Hierarchy),e._isActiveInScene&&(!this._isActiveInScene||o!==l)&&(_|=he.Scene)),_&&this._processActive(_)}else{var u=he.None;this._isActiveInHierarchy&&(u|=he.Hierarchy),this._isActiveInScene&&(u|=he.Scene),u&&this._processInActive(u),a&&s._traverseSetOwnerScene(this,null)}this._setTransformDirty()}},i._getComponentsInChildren=function(e,r){for(var a=this._components.length-1;a>=0;a--){var o=this._components[a];ft(o,e)&&r.push(o)}for(var l=this._children.length-1;l>=0;l--)this._children[l]._getComponentsInChildren(e,r)},i._setActiveComponents=function(e,r){for(var a=this._activeChangedComponents,o=0,l=a.length;o<l;++o)a[o]._setActive(e,r);this._scene._componentsManager.putActiveChangedTempList(a),this._activeChangedComponents=null},i._setActiveInHierarchy=function(e,r){r&he.Hierarchy&&(this._isActiveInHierarchy=!0),r&he.Scene&&(this._isActiveInScene=!0);for(var a=this._components,o=0,l=a.length;o<l;o++){var c=a[o];(c.enabled||!c._awoken)&&e.push(c)}for(var _=this._children,u=0,d=_.length;u<d;u++){var h=_[u];h.isActive&&h._setActiveInHierarchy(e,r)}},i._setInActiveInHierarchy=function(e,r){r&he.Hierarchy&&(this._isActiveInHierarchy=!1),r&he.Scene&&(this._isActiveInScene=!1);for(var a=this._components,o=0,l=a.length;o<l;o++){var c=a[o];c.enabled&&e.push(c)}for(var _=this._children,u=0,d=_.length;u<d;u++){var h=_[u];h.isActive&&h._setInActiveInHierarchy(e,r)}},i._setTransformDirty=function(){if(this.transform)this.transform._parentChange();else for(var e=0,r=this._children.length;e<r;e++)this._children[e]._setTransformDirty()},i._setSiblingIndex=function(e,r){if(r=Math.min(r,e.length-1),r<0)throw"Sibling index "+r+" should large than 0";if(this._siblingIndex!==r){var a=this._siblingIndex;if(r<a)for(var o=a;o>=r;o--){var l=o==r?this:e[o-1];e[o]=l,l._siblingIndex=o}else for(var c=a;c<=r;c++){var _=c==r?this:e[c+1];e[c]=_,_._siblingIndex=c}}},i.getInvModelMatrix=function(){return this._inverseWorldMatFlag.flag&&(J.invert(this.transform.worldMatrix,this._invModelMatrix),this._inverseWorldMatFlag.flag=!1),this._invModelMatrix},s._findChildByName=function(e,r){for(var a=e._children,o=a.length-1;o>=0;o--){var l=a[o];if(l.name===r)return l}return null},s._traverseSetOwnerScene=function(e,r){e._scene=r;for(var a=e._children,o=a.length-1;o>=0;o--)this._traverseSetOwnerScene(a[o],r)},q(s,[{key:"isActive",get:function(){return this._isActive},set:function(e){if(e!==this._isActive)if(this._isActive=e,e){var r=this._parent,a=he.None;if(this._isRoot&&this._scene._isActiveInEngine)a|=he.All;else{var o,l;(o=r)!=null&&o._isActiveInHierarchy&&(a|=he.Hierarchy),(l=r)!=null&&l._isActiveInScene&&(a|=he.Scene)}a&&this._processActive(a)}else{var c=he.None;this._isActiveInHierarchy&&(c|=he.Hierarchy),this._isActiveInScene&&(c|=he.Scene),c&&this._processInActive(c)}}},{key:"isActiveInHierarchy",get:function(){return this._isActiveInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this._setParent(e)}},{key:"children",get:function(){return this._children}},{key:"childCount",get:function(){return this._children.length}},{key:"scene",get:function(){return this._scene}},{key:"siblingIndex",get:function(){return this._siblingIndex},set:function(e){if(this._siblingIndex===-1)throw"The entity "+this.name+" is not in the hierarchy";this._setSiblingIndex(this._isRoot?this._scene._rootEntities:this._parent._children,e)}}]),s}(tn),rr=function(){function n(){this._projectionParams=new ae,this.flipProjection=!1}var s=n.prototype;return s.applyVirtualCamera=function(t,e){this.virtualCamera=t,this.flipProjection=e;var r=this.camera.shaderData,a=t.viewMatrix,o=t.projectionMatrix,l=t.viewProjectionMatrix;e&&(J.multiply(n._flipYMatrix,o,n._flipYProjectionMatrix),J.multiply(n._flipYProjectionMatrix,a,n._flipYViewProjectionMatrix),o=n._flipYProjectionMatrix,l=n._flipYViewProjectionMatrix),this.viewMatrix=a,this.projectionMatrix=o,this.viewProjectionMatrix=l,r.setMatrix(n._viewMatrixProperty,a),r.setMatrix(n._projectionMatrixProperty,o),r.setMatrix(n.vpMatrixProperty,l);var c=this._projectionParams;c.set(e?-1:1,t.nearClipPlane,t.farClipPlane,0),r.setVector4(n._cameraProjectionProperty,c)},s.garbageCollection=function(){this.camera=null},n}();(function(){rr.vpMatrixProperty=L.getByName("camera_VPMat")})();(function(){rr.pipelineStageKey=vn.getByName("pipelineStage")})();(function(){rr._flipYMatrix=new J(1,0,0,0,0,-1)})();(function(){rr._cameraProjectionProperty=L.getByName("camera_ProjectionParams")})();(function(){rr._viewMatrixProperty=L.getByName("camera_ViewMat")})();(function(){rr._projectionMatrixProperty=L.getByName("camera_ProjMat")})();(function(){rr._flipYProjectionMatrix=new J})();(function(){rr._flipYViewProjectionMatrix=new J})();var $i=function(){function n(){}var s=n.prototype;return s.setX=function(t,e,r,a){this.component=t,this.material=e,this.primitive=r,this.subPrimitive=a},s.dispose=function(){this.component=null,this.material=null,this.primitive=null,this.subPrimitive=null},n}(),Nu=function(){function n(){}var s=n.prototype;return s.set=function(t,e){this.data=t,this.shaderPasses=e},s.dispose=function(){this.data=this.shaderPasses=null},n}(),Iu=function(n){W(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.createVertexElements=function(e){return e[0]=new Me("POSITION",0,ee.Vector3,0),e[1]=new Me("TEXCOORD_0",12,ee.Vector2,0),20},i.canBatch=function(e,r){var a=e.data,o=r.data;if(a.isAdd!==o.isAdd)return!1;var l=a.component.shaderData,c=o.component.shaderData,_=It._textureProperty,u=It._alphaCutoffProperty;return l.getTexture(_)===c.getTexture(_)&&l.getTexture(u)===c.getTexture(u)},i.updateVertices=function(e,r,a){for(var o=e.verticesData,l=o.positions,c=o.uvs,_=o.vertexCount,u=0;u<_;u++){var d=l[u],h=c[u];r[a++]=d.x,r[a++]=d.y,r[a++]=d.z,r[a++]=h.x,r[a++]=h.y}return a},i.drawBatches=function(e){for(var r=this,a=r._engine,o=r._batchedQueue,l=this._meshes[this._flushId],c=l.subMeshes,_=l._primitive,u=e.scene.shaderData,d=e.shaderData,h=0,f=c.length;h<f;h++){var v=c[h],p=o[h],g=p.data;if(!v||!p)return;var y=g.component,m=g.material,x=ne._compileMacros;ar.unionCollection(y._globalShaderMacro,m.shaderData._macroCollection,x);var S=m.renderState.stencilState,b=g.isAdd?Xe.IncrementSaturate:Xe.DecrementSaturate;S.passOperationFront=b,S.passOperationBack=b;var A=m.shader.subShaders[0].passes[0],C=A._getShaderProgram(a,x);if(!C.isValid)return;C.bind(),C.groupingOtherUniformBlock(),C.uploadAll(C.sceneUniformBlock,u),C.uploadAll(C.cameraUniformBlock,d),C.uploadAll(C.rendererUniformBlock,y.shaderData),C.uploadAll(C.materialUniformBlock,m.shaderData),(A._renderState||m.renderState)._apply(a,!1,A._renderStateDataMap,m.shaderData),a._hardwareRenderer.drawPrimitive(_,v,C)}},s}(Or),Fu=function(){function n(i){this._preMaskLayer=0,this._batcher=new Iu(i)}var s=n.prototype;return s.clear=function(){this._preMaskLayer=0,this._batcher.clear()},s.preRender=function(t,e){e.maskInteraction!==ht.None&&(this._batcher.clear(),this._processMasksDiff(t,e),this._batcher.flush(t))},s.postRender=function(t){t.maskInteraction!==ht.None&&(this._preMaskLayer=t.maskLayer)},s.destroy=function(){this._batcher.destroy(),this._batcher=null},s._processMasksDiff=function(t,e){var r=this._preMaskLayer,a=e.maskLayer;if(r!==a)for(var o=t._renderPipeline._allSpriteMasks,l=r&a,c=a&~r,_=r&~a,u=o._elements,d=0,h=o.length;d<h;d++){var f=u[d],v=f.influenceLayers;if(!(v&l)){if(v&c){var p=f._maskElement;p.data.isAdd=!0,this._batcher.drawElement(p,t);continue}if(v&_){var g=f._maskElement;g.data.isAdd=!1,this._batcher.drawElement(g,t)}}}},n}(),Ou=function(n){W(s,n);function s(){var t;return t=n.call(this)||this,t.isAdd=!0,t.multiRenderData=!1,t}var i=s.prototype;return i.set=function(e,r,a){this.component=e,this.material=r,this.verticesData=a},i.dispose=function(){this.component=this.material=this.verticesData=null},s}($i),zu=function(n){W(s,n);function s(){var t;return t=n.call(this)||this,t.multiRenderData=!1,t}var i=s.prototype;return i.set=function(e,r,a,o,l){l===void 0&&(l=0),this.component=e,this.material=r,this.verticesData=a,this.texture=o,this.dataIndex=l},i.dispose=function(){this.component=this.material=this.verticesData=this.texture=null},s}($i),Uu=function(n){W(s,n);function s(){var t;return t=n.call(this)||this,t.charsData=[],t.multiRenderData=!0,t}var i=s.prototype;return i.dispose=function(){this.component=this.material=null,this.charsData.length=0},s}($i),Fe;(function(n){n.Text="Text",n.JSON="JSON",n.Buffer="Buffer",n.Texture2D="Texture2D",n.TextureCube="TextureCube",n.Material="Material",n.Mesh="Mesh",n.AnimationClip="AnimationClip",n.AnimatorController="AnimatorController",n.GLTF="GLTF",n.KTX="KTX",n.KTXCube="KTXCube",n.KTX2="KTX2",n.Sprite="Sprite",n.PrimitiveMesh="PrimitiveMesh",n.SpriteAtlas="SpriteAtlas",n.Env="Environment",n.Scene="Scene",n.HDR="HDR",n.Font="Font",n.SourceFont="SourceFont",n.Project="project"})(Fe||(Fe={}));var ku=function(){function n(){this._array=[],this._loopArray=[],this._loopArrayDirty=!1}var s=n.prototype;return s.push=function(t){this._array.push(t),this._loopArrayDirty=!0},s.add=function(t,e){this._array.splice(t,0,e),this._loopArrayDirty=!0},s.removeByIndex=function(t){this._array.splice(t,1),this._loopArrayDirty=!0},s.indexOf=function(t){return this._array.indexOf(t)},s.getArray=function(){return this._array},s.getLoopArray=function(){var t=this._loopArray;if(this._loopArrayDirty){var e=this._array,r=e.length;t.length=r;for(var a=0;a<r;a++)t[a]=e[a];this._loopArrayDirty=!1}return t},q(n,[{key:"length",get:function(){return this._array.length}}]),n}(),mc=function(){function n(i){this.engine=i,this._allCreatedScenes=[],this._scenes=new ku}var s=n.prototype;return s.addScene=function(t,e){var r=this._scenes,a;if(typeof t=="number"){if(t<0||t>r.length)throw"The index is out of range.";a=t}else a=r.length,e=t;if(e.engine!==this.engine)throw"The scene is not belong to this engine.";if(e._sceneManager){var o=r.indexOf(e);o!==a&&(r.removeByIndex(o),r.add(a,e))}else e._sceneManager=this,r.add(a,e),e.isActive&&e._processActive(!0)},s.removeScene=function(t){var e=this._scenes,r=e.indexOf(t);if(r!==-1){var a=e.getArray()[r];e.removeByIndex(r),t._sceneManager=null,a.isActive&&a._processActive(!1)}},s.loadScene=function(t,e){e===void 0&&(e=!0);var r=this,a=this.engine.resourceManager.load({url:t,type:Fe.Scene});return a.then(function(o){if(e)for(var l=r._scenes.getArray(),c=0,_=l.length;c<_;c++)l[c].destroy();r.addScene(o)}),a},s.mergeScenes=function(t,e){for(var r=t.rootEntities;r.length>0;)e.addRootEntity(r[0])},s._destroyAllScene=function(){for(var t=this._allCreatedScenes;t.length>0;)t[0].destroy()},q(n,[{key:"scenes",get:function(){return this._scenes.getArray()}},{key:"activeScene",get:function(){return this._scenes.getArray()[0]},set:function(t){var e=this.scenes[0];e&&this.removeScene(e),t&&this.addScene(0,t)}}]),n}(),Be=function(){function n(i){var t=this;this._state="pending",this._onTaskCompleteCallbacks=[],this._onTaskDetailCallbacks=[],this._promise=new Promise(function(e,r){t._reject=r;var a=function(u){t._state==="pending"&&(e(u),t._state="fulfilled",t._onTaskCompleteCallbacks=void 0,t._onTaskDetailCallbacks=void 0)},o=function(u){t._state==="pending"&&(r(u),t._state="rejected",t._onTaskCompleteCallbacks=void 0,t._onTaskDetailCallbacks=void 0)},l=function(u){t._state==="pending"&&(t._onCancelHandler=u)},c=function(u,d){if(t._state==="pending"){var h=t._taskCompleteProgress||(t._taskCompleteProgress={loaded:u,total:d});h.loaded=u,h.total=d,t._onTaskCompleteCallbacks.forEach(function(f){return f(u,d)})}},_=function(u,d,h){if(t._state==="pending"){var f,v;t._taskDetailProgress||(t._taskDetailProgress={});var p=(f=t._taskDetailProgress)[v=u]||(f[v]={loaded:d,total:h});p.loaded=d,p.total=h,t._onTaskDetailCallbacks.forEach(function(g){return g(u,d,h)})}};i(a,o,c,_,l)})}var s=n.prototype;return s.onProgress=function(t,e){var r=this._taskCompleteProgress,a=this._taskDetailProgress;if(r&&t(r.loaded,r.total),a)for(var o in a){var l=a[o],c=l.loaded,_=l.total;e(o,c,_)}return this._state==="pending"&&(t&&this._onTaskCompleteCallbacks.push(t),e&&this._onTaskDetailCallbacks.push(e)),this},s.then=function(t,e){var r=this;return new n(function(a,o){r._promise.then(t,e).then(a).catch(o)})},s.catch=function(t){var e=this;return new n(function(r,a){e._promise.catch(t).then(r).catch(a)})},s.finally=function(t){return this._promise.finally(t)},s.cancel=function(){if(this._state==="pending")return this._state="canceled",this._reject("canceled"),this._onCancelHandler&&this._onCancelHandler(),this},n.all=function(t){return new n(function(e,r,a){var o=function(f,v){u++,_[f]=v,a(u,c),u===c&&e(_)},l=function(f,v){ft(f,Promise)||ft(f,n)?f.then(function(p){o(v,p)},r):Promise.resolve().then(function(){o(v,f)})},c=t.length,_=new Array(c),u=0;if(c===0)return e(_);for(var d=0;d<c;d++)l(t[d],d)})},q(n,[{key:Symbol.toStringTag,get:function(){return"AssetPromise"}}]),n}(),Cs;(function(n){n.Pending="pending",n.Fulfilled="fulfilled",n.Rejected="rejected",n.Canceled="canceled"})(Cs||(Cs={}));var ga=function(){function n(i){this.engine=i,this.retryCount=1,this.retryInterval=0,this.timeout=1/0,this.baseUrl=null,this._loadingPromises={},this._assetPool=Object.create(null),this._assetUrlPool=Object.create(null),this._referResourcePool=Object.create(null),this._graphicResourcePool=Object.create(null),this._contentRestorerPool=Object.create(null),this._subAssetPromiseCallbacks={},this._objectPool=Object.create(null),this._editorResourceConfig=Object.create(null),this._virtualPathMap=Object.create(null)}var s=n.prototype;return s.load=function(t){var e=this;if(!Array.isArray(t))return this._loadSingleItem(t);var r=t.map(function(a){return e._loadSingleItem(a)});return Be.all(r)},s.getFromCache=function(t){var e;return(e=this._assetUrlPool[t])!=null?e:null},s.findResourcesByType=function(t){var e=new Array,r=this._referResourcePool;for(var a in r){var o=r[a];ft(o,t)&&e.push(o)}return e},s.getAssetPath=function(t){return this._assetPool[t]},s.cancelNotLoaded=function(t){var e=this;if(!t)We.objectValues(this._loadingPromises).forEach(function(a){a.cancel()});else if(typeof t=="string"){var r;(r=this._loadingPromises[t])==null||r.cancel()}else t.forEach(function(a){var o;(o=e._loadingPromises[a])==null||o.cancel()})},s.gc=function(){this._gc(!1),this.engine._pendingGC()},s.addContentRestorer=function(t){this._contentRestorerPool[t.resource.instanceId]=t},s._onSubAssetSuccess=function(t,e){var r;(r=this._subAssetPromiseCallbacks[t])==null||r.resolve(e),delete this._subAssetPromiseCallbacks[t]},s._onSubAssetFail=function(t,e){var r;(r=this._subAssetPromiseCallbacks[t])==null||r.reject(e),delete this._subAssetPromiseCallbacks[t]},s._addAsset=function(t,e){this._assetPool[e.instanceId]=t,this._assetUrlPool[t]=e},s._deleteAsset=function(t){var e=t.instanceId,r=this._assetPool[e];r&&(delete this._assetPool[e],delete this._assetUrlPool[r])},s._addReferResource=function(t){this._referResourcePool[t.instanceId]=t},s._deleteReferResource=function(t){delete this._referResourcePool[t.instanceId]},s._addGraphicResource=function(t){this._graphicResourcePool[t.instanceId]=t},s._deleteGraphicResource=function(t){delete this._graphicResourcePool[t.instanceId]},s._deleteContentRestorer=function(t){delete this._contentRestorerPool[t.instanceId]},s._restoreGraphicResources=function(){var t=this._graphicResourcePool;for(var e in t)t[e]._rebuild()},s._lostGraphicResources=function(){var t=this._graphicResourcePool;for(var e in t)t[e]._isContentLost=!0},s._restoreResourcesContent=function(){var t=this._contentRestorerPool,e=new Array;for(var r in t){var a=t[r],o=a.restoreContent();o&&e.push(o)}return Promise.all(e)},s._destroy=function(){this.cancelNotLoaded(),this._gc(!0),this._assetPool=null,this._assetUrlPool=null,this._referResourcePool=null,this._graphicResourcePool=null,this._contentRestorerPool=null,this._loadingPromises=null},s._assignDefaultOptions=function(t){var e;if(t.type=(e=t.type)!=null?e:n._getTypeByUrl(t.url),t.type===void 0)throw"asset type should be specified: "+t.url;var r;t.retryCount=(r=t.retryCount)!=null?r:this.retryCount;var a;t.timeout=(a=t.timeout)!=null?a:this.timeout;var o;t.retryInterval=(o=t.retryInterval)!=null?o:this.retryInterval;var l;return t.url=(l=t.url)!=null?l:t.urls.join(","),t},s._loadSingleItem=function(t){var e=this,r=this._assignDefaultOptions(typeof t=="string"?{url:t}:t),a=r.url,o=this._virtualPathMap[a]?this._virtualPathMap[a]:a;!We.isAbsoluteUrl(o)&&this.baseUrl&&(o=We.resolveAbsoluteUrl(this.baseUrl,o));var l=this._parseURL(o),c=l.assetBaseURL,_=l.queryPath,u=_?this._parseQueryPath(_):[],d=this._assetUrlPool[c];if(d)return new Be(function(x){x(e._getResolveResource(d,u))});var h=c;if(_){h+="?q="+u.shift();for(var f;f=u.shift();)h+="["+f+"]"}var v=this._loadingPromises,p=v[h];if(p)return new Be(function(x,S,b,A){p.onProgress(b,A).then(function(C){x(C)}).catch(function(C){S(C)})});var g=n._loaders[r.type];if(!g)throw"loader not found: "+r.type;r.url=c;var y=g.load(r,this);if(v[c]=y,y.then(function(x){g.useCache&&e._addAsset(c,x),delete v[c]},function(){return delete v[c]}),_){var m=new Be(function(x,S){e._pushSubAssetPromiseCallback(h,x,S)});return v[h]=m,m.then(function(){delete v[h]},function(){return delete v[h]}),y.catch(function(x){e._onSubAssetFail(h,x)}),m}return y},s._pushSubAssetPromiseCallback=function(t,e,r){this._subAssetPromiseCallbacks[t]={resolve:e,reject:r}},s._gc=function(t){for(var e=We.objectValues(this._referResourcePool),r=0,a=e.length;r<a;r++){var o=e[r];(!o.isGCIgnored||t)&&o.destroy(t,!0)}},s._getResolveResource=function(t,e){var r=t;if(e)for(var a=0,o=e.length;a<o;a++){var l=e[a];r=r[l]}return r},s._parseURL=function(t){var e=t.split("?"),r=e[0],a=e[1],o=void 0,l=r;if(a){for(var c=a.split("&"),_=0;_<c.length;_++){var u=c[_];if(u.startsWith("q=")){o=decodeURIComponent(u.split("=")[1]),c.splice(_,1);break}}l=c.length>0?r+"?"+c.join("&"):r}return{assetBaseURL:l,queryPath:o}},s._parseQueryPath=function(t){var e=[];return t.charCodeAt(0)===Gu&&e.push(""),t.replace(Wu,function(r,a,o,l){var c=r;o?c=l.replace(Hu,"$1"):a&&(c=a.trim()),e.push(c)}),e},s.getResourceByRef=function(t){var e=t.refId,r=t.key,a=t.isClone,o=this._objectPool[e],l;if(o)l=Promise.resolve(o);else{var c,_=(c=this._editorResourceConfig[e])==null?void 0:c.path;if(!_)return ve.warn("refId:"+e+" is not find in this._editorResourceConfig."),Promise.resolve(null);_=r?""+_+(_.indexOf("?")>-1?"&":"?")+"q="+r:_,l=this.load({url:_,type:this._editorResourceConfig[e].type})}return l.then(function(u){return a?u.clone():u})},s.initVirtualResources=function(t){var e=this;t.forEach(function(r){e._virtualPathMap[r.virtualPath]=r.path,e._editorResourceConfig[r.id]=r})},n._addLoader=function(t,e,r){this._loaders[t]=e;for(var a=0,o=r.length;a<o;a++)this._extTypeMapping[r[a].toLowerCase()]=t},n._getTypeByUrl=function(t){var e=t.split("?")[0];return this._extTypeMapping[e.substring(e.lastIndexOf(".")+1).toLowerCase()]},n}();(function(){ga._loaders={}})();(function(){ga._extTypeMapping={}})();function Qe(n,s,i){return i===void 0&&(i=!0),function(t){var e=new t(i);ga._addLoader(n,e,s)}}var Gu=".".charCodeAt(0),Hu=/\\(\\)?/g,Wu=RegExp(`[^.[\\]]+|\\[(?:([^"'][^[]*)|(["'])((?:(?!\\2)[^\\\\]|\\\\.)*?)\\2)\\]|(?=(?:\\.|\\[\\])(?:\\.|\\[\\]|$))`,"g"),_r;(function(n){n[n.Down=0]="Down",n[n.Move=1]="Move",n[n.Stationary=2]="Stationary",n[n.Up=3]="Up",n[n.Leave=4]="Leave"})(_r||(_r={}));var yc=function(){function n(i){this.phase=_r.Leave,this.position=new $,this.deltaPosition=new $,this._events=[],this._upMap=[],this._downMap=[],this._upList=new Ye,this._downList=new Ye,this.id=i}var s=n.prototype;return s._firePointerExitAndEnter=function(t){var e=this;this._currentEnteredEntity!==t&&(this._currentEnteredEntity&&this._currentEnteredEntity._scripts.forEach(function(r){r.onPointerExit(e)},function(r,a){r._entityScriptsIndex=a}),t&&t._scripts.forEach(function(r){r.onPointerEnter(e)},function(r,a){r._entityScriptsIndex=a}),this._currentEnteredEntity=t)},s._firePointerDown=function(t){var e=this;t&&t._scripts.forEach(function(r){r.onPointerDown(e)},function(r,a){r._entityScriptsIndex=a}),this._currentPressedEntity=t},s._firePointerDrag=function(){var t=this;this._currentPressedEntity&&this._currentPressedEntity._scripts.forEach(function(e){e.onPointerDrag(t)},function(e,r){e._entityScriptsIndex=r})},s._firePointerUpAndClick=function(t){var e=this,r=this,a=r._currentPressedEntity;if(a){var o=a===t;a._scripts.forEach(function(l){o&&l.onPointerClick(e),l.onPointerUp(e)},function(l,c){l._entityScriptsIndex=c}),this._currentPressedEntity=null}},n}(),er;(function(n){n[n.None=0]="None",n[n.Primary=1]="Primary",n[n.Secondary=2]="Secondary",n[n.Auxiliary=4]="Auxiliary",n[n.XButton1=8]="XButton1",n[n.XButton2=16]="XButton2",n[n.XButton3=32]="XButton3",n[n.XButton4=64]="XButton4",n[n.XButton5=128]="XButton5",n[n.XButton6=256]="XButton6",n[n.XButton7=512]="XButton7",n[n.XButton8=1024]="XButton8"})(er||(er={}));var Xu=[1,4,2,8,16,32,64,128,256,512,1024],Ss={1:0,2:2,4:1,8:3,16:4,32:5,64:6,128:7,256:8,512:9,1024:10},Zr=function(){function n(){}return n._initialize=function(){{if(typeof navigator>"u")return;var i=navigator.userAgent;/iPhone/i.test(i)?n.platform=Ht.IPhone:/iPad/i.test(i)?n.platform=Ht.IPad:/Android/i.test(i)?n.platform=Ht.Android:/Macintosh/i.test(i)&&(n.platform=Ht.Mac);var t;switch(n.platform){case Ht.IPhone:t=i.match(/OS (\d+)_?(\d+)?_?(\d+)?/),this.operatingSystem=t?"iPhone OS "+t[1]+"."+(t[2]||0)+"."+(t[3]||0):"iPhone OS";break;case Ht.IPad:t=i.match(/OS (\d+)_?(\d+)?_?(\d+)?/),this.operatingSystem=t?"iPad OS "+t[1]+"."+(t[2]||0)+"."+(t[3]||0):"iPad OS";break;case Ht.Android:t=i.match(/Android (\d+).?(\d+)?.?(\d+)?/),this.operatingSystem=t?"Android "+t[1]+"."+(t[2]||0)+"."+(t[3]||0):"Android";break;case Ht.Mac:t=i.match(/Mac OS X (\d+)_?(\d+)?_?(\d+)?/),this.operatingSystem=t?"Mac OS X "+t[1]+"."+(t[2]||0)+"."+(t[3]||0):"Mac OS X";break}}},n._detectSIMDSupported=function(){return this._simdSupported===null&&(this._simdSupported=WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]))),this._simdSupported},q(n,null,[{key:"devicePixelRatio",get:function(){return window.devicePixelRatio}}]),n}();(function(){Zr.platform=Ht.Unknown})();(function(){Zr.operatingSystem=""})();(function(){Zr._simdSupported=null})();Zr._initialize();var Ie;(function(n){n[n.Backquote=0]="Backquote",n[n.Backslash=1]="Backslash",n[n.Backspace=2]="Backspace",n[n.BracketLeft=3]="BracketLeft",n[n.BracketRight=4]="BracketRight",n[n.Comma=5]="Comma",n[n.Digit0=6]="Digit0",n[n.Digit1=7]="Digit1",n[n.Digit2=8]="Digit2",n[n.Digit3=9]="Digit3",n[n.Digit4=10]="Digit4",n[n.Digit5=11]="Digit5",n[n.Digit6=12]="Digit6",n[n.Digit7=13]="Digit7",n[n.Digit8=14]="Digit8",n[n.Digit9=15]="Digit9",n[n.Equal=16]="Equal",n[n.IntlBackslash=17]="IntlBackslash",n[n.IntlRo=18]="IntlRo",n[n.IntlYen=19]="IntlYen",n[n.KeyA=20]="KeyA",n[n.KeyB=21]="KeyB",n[n.KeyC=22]="KeyC",n[n.KeyD=23]="KeyD",n[n.KeyE=24]="KeyE",n[n.KeyF=25]="KeyF",n[n.KeyG=26]="KeyG",n[n.KeyH=27]="KeyH",n[n.KeyI=28]="KeyI",n[n.KeyJ=29]="KeyJ",n[n.KeyK=30]="KeyK",n[n.KeyL=31]="KeyL",n[n.KeyM=32]="KeyM",n[n.KeyN=33]="KeyN",n[n.KeyO=34]="KeyO",n[n.KeyP=35]="KeyP",n[n.KeyQ=36]="KeyQ",n[n.KeyR=37]="KeyR",n[n.KeyS=38]="KeyS",n[n.KeyT=39]="KeyT",n[n.KeyU=40]="KeyU",n[n.KeyV=41]="KeyV",n[n.KeyW=42]="KeyW",n[n.KeyX=43]="KeyX",n[n.KeyY=44]="KeyY",n[n.KeyZ=45]="KeyZ",n[n.Minus=46]="Minus",n[n.Period=47]="Period",n[n.Quote=48]="Quote",n[n.Semicolon=49]="Semicolon",n[n.Slash=50]="Slash",n[n.AltLeft=51]="AltLeft",n[n.AltRight=52]="AltRight",n[n.CapsLock=53]="CapsLock",n[n.ContextMenu=54]="ContextMenu",n[n.ControlLeft=55]="ControlLeft",n[n.ControlRight=56]="ControlRight",n[n.Enter=57]="Enter",n[n.MetaLeft=58]="MetaLeft",n[n.MetaRight=59]="MetaRight",n[n.ShiftLeft=60]="ShiftLeft",n[n.ShiftRight=61]="ShiftRight",n[n.Space=62]="Space",n[n.Tab=63]="Tab",n[n.Convert=64]="Convert",n[n.KanaMode=65]="KanaMode",n[n.Lang1=66]="Lang1",n[n.Lang2=67]="Lang2",n[n.Lang3=68]="Lang3",n[n.Lang4=69]="Lang4",n[n.Lang5=70]="Lang5",n[n.NonConvert=71]="NonConvert",n[n.Delete=72]="Delete",n[n.End=73]="End",n[n.Help=74]="Help",n[n.Home=75]="Home",n[n.Insert=76]="Insert",n[n.PageDown=77]="PageDown",n[n.PageUp=78]="PageUp",n[n.ArrowDown=79]="ArrowDown",n[n.ArrowLeft=80]="ArrowLeft",n[n.ArrowRight=81]="ArrowRight",n[n.ArrowUp=82]="ArrowUp",n[n.NumLock=83]="NumLock",n[n.Numpad0=84]="Numpad0",n[n.Numpad1=85]="Numpad1",n[n.Numpad2=86]="Numpad2",n[n.Numpad3=87]="Numpad3",n[n.Numpad4=88]="Numpad4",n[n.Numpad5=89]="Numpad5",n[n.Numpad6=90]="Numpad6",n[n.Numpad7=91]="Numpad7",n[n.Numpad8=92]="Numpad8",n[n.Numpad9=93]="Numpad9",n[n.NumpadAdd=94]="NumpadAdd",n[n.NumpadBackspace=95]="NumpadBackspace",n[n.NumpadClear=96]="NumpadClear",n[n.NumpadClearEntry=97]="NumpadClearEntry",n[n.NumpadComma=98]="NumpadComma",n[n.NumpadDecimal=99]="NumpadDecimal",n[n.NumpadDivide=100]="NumpadDivide",n[n.NumpadEnter=101]="NumpadEnter",n[n.NumpadEqual=102]="NumpadEqual",n[n.NumpadHash=103]="NumpadHash",n[n.NumpadMemoryAdd=104]="NumpadMemoryAdd",n[n.NumpadMemoryClear=105]="NumpadMemoryClear",n[n.NumpadMemoryRecall=106]="NumpadMemoryRecall",n[n.NumpadMemoryStore=107]="NumpadMemoryStore",n[n.NumpadMemorySubtract=108]="NumpadMemorySubtract",n[n.NumpadMultiply=109]="NumpadMultiply",n[n.NumpadParenLeft=110]="NumpadParenLeft",n[n.NumpadParenRight=111]="NumpadParenRight",n[n.NumpadStar=112]="NumpadStar",n[n.NumpadSubtract=113]="NumpadSubtract",n[n.Escape=114]="Escape",n[n.F1=115]="F1",n[n.F2=116]="F2",n[n.F3=117]="F3",n[n.F4=118]="F4",n[n.F5=119]="F5",n[n.F6=120]="F6",n[n.F7=121]="F7",n[n.F8=122]="F8",n[n.F9=123]="F9",n[n.F10=124]="F10",n[n.F11=125]="F11",n[n.F12=126]="F12",n[n.F13=127]="F13",n[n.F14=128]="F14",n[n.F15=129]="F15",n[n.Fn=130]="Fn",n[n.FnLock=131]="FnLock",n[n.PrintScreen=132]="PrintScreen",n[n.ScrollLock=133]="ScrollLock",n[n.Pause=134]="Pause",n[n.BrowserBack=135]="BrowserBack",n[n.BrowserFavorites=136]="BrowserFavorites",n[n.BrowserForward=137]="BrowserForward",n[n.BrowserHome=138]="BrowserHome",n[n.BrowserRefresh=139]="BrowserRefresh",n[n.BrowserSearch=140]="BrowserSearch",n[n.BrowserStop=141]="BrowserStop",n[n.Eject=142]="Eject",n[n.LaunchApp1=143]="LaunchApp1",n[n.LaunchApp2=144]="LaunchApp2",n[n.LaunchMail=145]="LaunchMail",n[n.MediaPlayPause=146]="MediaPlayPause",n[n.MediaSelect=147]="MediaSelect",n[n.MediaStop=148]="MediaStop",n[n.MediaTrackNext=149]="MediaTrackNext",n[n.MediaTrackPrevious=150]="MediaTrackPrevious",n[n.Power=151]="Power",n[n.Sleep=152]="Sleep",n[n.AudioVolumeDown=153]="AudioVolumeDown",n[n.AudioVolumeMute=154]="AudioVolumeMute",n[n.AudioVolumeUp=155]="AudioVolumeUp",n[n.WakeUp=156]="WakeUp",n[n.Hyper=157]="Hyper",n[n.Super=158]="Super",n[n.Turbo=159]="Turbo",n[n.Abort=160]="Abort",n[n.Resume=161]="Resume",n[n.Suspend=162]="Suspend",n[n.Again=163]="Again",n[n.Copy=164]="Copy",n[n.Cut=165]="Cut",n[n.Find=166]="Find",n[n.Open=167]="Open",n[n.Paste=168]="Paste",n[n.Props=169]="Props",n[n.Select=170]="Select",n[n.Undo=171]="Undo",n[n.Hiragana=172]="Hiragana",n[n.Katakana=173]="Katakana",n[n.Unidentified=174]="Unidentified"})(Ie||(Ie={}));var ju=function(){function n(i,t){this._curHeldDownKeyToIndexMap=[],this._upKeyToFrameCountMap=[],this._downKeyToFrameCountMap=[],this._curFrameHeldDownList=new Ye,this._curFrameDownList=new Ye,this._curFrameUpList=new Ye,this._nativeEvents=[],this._engine=i,this._onBlur=this._onBlur.bind(this),this._onKeyEvent=this._onKeyEvent.bind(this),this._target=t,this._addEventListener()}var s=n.prototype;return s._update=function(){var t=this,e=t._nativeEvents,r=t._curFrameDownList,a=t._curFrameUpList;if(r.length=0,a.length=0,e.length>0){for(var o=this._engine.time.frameCount,l=this,c=l._curHeldDownKeyToIndexMap,_=l._curFrameHeldDownList,u=l._downKeyToFrameCountMap,d=l._upKeyToFrameCountMap,h=0,f=e.length;h<f;h++){var v=e[h],p=Ie[v.code];switch(v.type){case"keydown":c[p]==null&&(r.add(p),_.add(p),c[p]=_.length-1,u[p]=o);break;case"keyup":var g=c[p];if(g!=null){c[p]=null;var y=_.deleteByIndex(g);y&&(c[y]=g)}if(a.add(p),d[p]=o,Zr.platform===Ht.Mac&&(p===Ie.MetaLeft||p===Ie.MetaRight)){for(var m=0,x=_.length;m<x;m++)c[_.get(m)]=null;_.length=0}break}}e.length=0}},s._destroy=function(){this._removeEventListener(),this._curHeldDownKeyToIndexMap.length=0,this._curHeldDownKeyToIndexMap=null,this._upKeyToFrameCountMap.length=0,this._upKeyToFrameCountMap=null,this._downKeyToFrameCountMap.length=0,this._downKeyToFrameCountMap=null,this._nativeEvents.length=0,this._nativeEvents=null,this._curFrameHeldDownList.length=0,this._curFrameHeldDownList=null,this._curFrameDownList.length=0,this._curFrameDownList=null,this._curFrameUpList.length=0,this._curFrameUpList=null,this._engine=null},s._onBlur=function(){this._curHeldDownKeyToIndexMap.length=0,this._curFrameHeldDownList.length=0,this._curFrameDownList.length=0,this._curFrameUpList.length=0,this._nativeEvents.length=0},s._onKeyEvent=function(t){this._nativeEvents.push(t)},s._addEventListener=function(){var t=this,e=t._target;e.addEventListener("keydown",this._onKeyEvent),e.addEventListener("keyup",this._onKeyEvent),e.addEventListener("blur",this._onBlur)},s._removeEventListener=function(){var t=this,e=t._target;e.removeEventListener("keydown",this._onKeyEvent),e.removeEventListener("keyup",this._onKeyEvent),e.removeEventListener("blur",this._onBlur)},n}(),Lt;(function(n){n[n.None=0]="None",n[n.Color=1]="Color",n[n.Depth=2]="Depth",n[n.Stencil=4]="Stencil",n[n.ColorDepth=3]="ColorDepth",n[n.ColorStencil=5]="ColorStencil",n[n.DepthStencil=6]="DepthStencil",n[n.All=7]="All"})(Lt||(Lt={}));var Ft=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._index=-1,e._shapes=[],e._updateFlag=e.entity.transform.registerWorldChangeFlag(),e}var i=s.prototype;return i.addShape=function(e){var r=e._collider;r!==this&&(r&&r.removeShape(e),this._shapes.push(e),e._collider=this,this._nativeCollider.addShape(e._nativeShape),this._phasedActiveInScene&&this.scene.physics._addColliderShape(e))},i.removeShape=function(e){var r=this._shapes.indexOf(e);r!==-1&&(this._shapes.splice(r,1),this._phasedActiveInScene&&this.scene.physics._removeColliderShape(e),e._collider=null,this._nativeCollider.removeShape(e._nativeShape))},i.clearShapes=function(){for(var e=this._shapes,r=0,a=e.length;r<a;r++){var o=e[r];this._phasedActiveInScene&&this.scene.physics._removeColliderShape(o),o._destroy(),this._nativeCollider.removeShape(o._nativeShape)}e.length=0},i._onUpdate=function(){if(this._updateFlag.flag){var e=this.entity.transform;this._nativeCollider.setWorldTransform(e.worldPosition,e.worldRotationQuaternion);for(var r=e.lossyWorldScale,a=0,o=this.shapes.length;a<o;a++)this.shapes[a]._nativeShape.setWorldScale(r);this._updateFlag.flag=!1}},i._onLateUpdate=function(){},i._onEnableInScene=function(){var e=this.scene.physics;e._addCollider(this);for(var r=this.shapes,a=0,o=r.length;a<o;a++)e._addColliderShape(r[a])},i._onDisableInScene=function(){var e=this.scene.physics;e._removeCollider(this);for(var r=this.shapes,a=0,o=r.length;a<o;a++)e._removeColliderShape(r[a])},i._cloneTo=function(e){for(var r=e._shapes,a=0,o=r.length;a<o;a++)e._addPhysicsShape(r[a])},i._onDestroy=function(){n.prototype._onDestroy.call(this),this.clearShapes(),this._nativeCollider.destroy()},i._addPhysicsShape=function(e){e._collider=this,this._nativeCollider.addShape(e._nativeShape),this._phasedActiveInScene&&this.scene.physics._addColliderShape(e)},q(s,[{key:"shapes",get:function(){return this._shapes}}]),s}(Vt);R([I],Ft.prototype,"_index",void 0);R([I],Ft.prototype,"_nativeCollider",void 0);R([I],Ft.prototype,"_updateFlag",void 0);R([Z],Ft.prototype,"_shapes",void 0);Ft=R([An(me,Ur.CheckOnly)],Ft);var qu=function(){},Qt=function(){function n(i){var t=this;this._restTime=0,this._fixedTimeStep=1/60,this._colliders=new Ye,this._gravity=new w(0,-9.81,0),this._onContactEnter=function(r,a){var o=t._scene.engine._physicalObjectsMap,l=o[r],c=o[a];l.collider.entity._scripts.forEach(function(_){var u=n._collision;u.shape=c,_.onCollisionEnter(u)},function(_,u){_._entityScriptsIndex=u}),c.collider.entity._scripts.forEach(function(_){var u=n._collision;u.shape=l,_.onCollisionEnter(u)},function(_,u){_._entityScriptsIndex=u})},this._onContactExit=function(r,a){var o=t._scene.engine._physicalObjectsMap,l=o[r],c=o[a];l.collider.entity._scripts.forEach(function(_){var u=n._collision;u.shape=c,_.onCollisionExit(u)},function(_,u){_._entityScriptsIndex=u}),c.collider.entity._scripts.forEach(function(_){var u=n._collision;u.shape=l,_.onCollisionExit(u)},function(_,u){_._entityScriptsIndex=u})},this._onContactStay=function(r,a){var o=t._scene.engine._physicalObjectsMap,l=o[r],c=o[a];l.collider.entity._scripts.forEach(function(_){var u=n._collision;u.shape=c,_.onCollisionStay(u)},function(_,u){_._entityScriptsIndex=u}),c.collider.entity._scripts.forEach(function(_){var u=n._collision;u.shape=l,_.onCollisionStay(u)},function(_,u){_._entityScriptsIndex=u})},this._onTriggerEnter=function(r,a){var o=t._scene.engine._physicalObjectsMap,l=o[r],c=o[a];l.collider.entity._scripts.forEach(function(_){_.onTriggerEnter(c)},function(_,u){_._entityScriptsIndex=u}),c.collider.entity._scripts.forEach(function(_){_.onTriggerEnter(l)},function(_,u){_._entityScriptsIndex=u})},this._onTriggerExit=function(r,a){var o=t._scene.engine._physicalObjectsMap,l=o[r],c=o[a];l.collider.entity._scripts.forEach(function(_){_.onTriggerExit(c)},function(_,u){_._entityScriptsIndex=u}),c.collider.entity._scripts.forEach(function(_){_.onTriggerExit(l)},function(_,u){_._entityScriptsIndex=u})},this._onTriggerStay=function(r,a){var o=t._scene.engine._physicalObjectsMap,l=o[r],c=o[a];l.collider.entity._scripts.forEach(function(_){_.onTriggerStay(c)},function(_,u){_._entityScriptsIndex=u}),c.collider.entity._scripts.forEach(function(_){_.onTriggerStay(l)},function(_,u){_._entityScriptsIndex=u})},this._scene=i,this._setGravity=this._setGravity.bind(this),this._gravity._onValueChanged=this._setGravity;var e=i.engine;e._physicsInitialized&&(this._nativePhysicsScene=n._nativePhysics.createPhysicsScene(e._nativePhysicsManager,this._onContactEnter,this._onContactExit,this._onContactStay,this._onTriggerEnter,this._onTriggerExit,this._onTriggerStay))}var s=n.prototype;return s.raycast=function(t,e,r,a){var o=this,l,c=Number.MAX_VALUE;typeof e=="number"?c=e:e!=null&&(l=e);var _=mn.Everything;typeof r=="number"?_=r:r!=null&&(l=r),a&&(l=a);var u=function(h){var f=o._scene.engine._physicalObjectsMap[h];return f?f.collider.entity.layer&_&&f.isSceneQuery:!1};if(l!=null){var d=this._nativePhysicsScene.raycast(t,c,u,function(h,f,v,p){var g=o._scene.engine._physicalObjectsMap[h];l.entity=g._collider.entity,l.shape=g,l.distance=f,l.normal.copyFrom(p),l.point.copyFrom(v)});return d?!0:(l.entity=null,l.shape=null,l.distance=0,l.point.set(0,0,0),l.normal.set(0,0,0),!1)}else return this._nativePhysicsScene.raycast(t,c,u)},s._update=function(t){var e=this,r=e._fixedTimeStep,a=e._nativePhysicsScene,o=this._scene._componentsManager,l=this._restTime+t,c=Math.floor(l/r);this._restTime=l-c*r;for(var _=0;_<c;_++)o.callScriptOnPhysicsUpdate(),this._callColliderOnUpdate(),a.update(r),this._callColliderOnLateUpdate()},s._addColliderShape=function(t){this._scene.engine._physicalObjectsMap[t.id]=t,this._nativePhysicsScene.addColliderShape(t._nativeShape)},s._removeColliderShape=function(t){delete this._scene.engine._physicalObjectsMap[t.id],this._nativePhysicsScene.removeColliderShape(t._nativeShape)},s._addCollider=function(t){t._index===-1&&(t._index=this._colliders.length,this._colliders.add(t)),this._nativePhysicsScene.addCollider(t._nativeCollider)},s._addCharacterController=function(t){t._index===-1&&(t._index=this._colliders.length,this._colliders.add(t)),this._nativePhysicsScene.addCharacterController(t._nativeCollider)},s._removeCollider=function(t){var e=this._colliders.deleteByIndex(t._index);e&&(e._index=t._index),t._index=-1,this._nativePhysicsScene.removeCollider(t._nativeCollider)},s._removeCharacterController=function(t){var e=this._colliders.deleteByIndex(t._index);e&&(e._index=t._index),t._index=-1,this._nativePhysicsScene.removeCharacterController(t._nativeCollider)},s._callColliderOnUpdate=function(){for(var t=this._colliders._elements,e=this._colliders.length-1;e>=0;--e)t[e]._onUpdate()},s._callColliderOnLateUpdate=function(){for(var t=this._colliders._elements,e=this._colliders.length-1;e>=0;--e)t[e]._onLateUpdate()},s._gc=function(){this._colliders.garbageCollection()},s._setGravity=function(){this._nativePhysicsScene.setGravity(this._gravity)},q(n,[{key:"gravity",get:function(){return this._gravity},set:function(t){var e=this._gravity;e!==t&&e.copyFrom(t)}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(t){this._fixedTimeStep=Math.max(t,k.zeroTolerance)}}]),n}();(function(){Qt._collision=new qu})();var Pi;(function(n){n[n.PreventClimbing=0]="PreventClimbing",n[n.PreventClimbingAndForceSliding=1]="PreventClimbingAndForceSliding"})(Pi||(Pi={}));var Yu=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._stepOffset=.5,e._nonWalkableMode=Pi.PreventClimbing,e._upDirection=new w(0,1,0),e._slopeLimit=.707,e._nativeCollider=Qt._nativePhysics.createCharacterController(),e._setUpDirection=e._setUpDirection.bind(ue(e)),e._upDirection._onValueChanged=e._setUpDirection,e}var i=s.prototype;return i.move=function(e,r,a){return this._nativeCollider.move(e,r,a)},i.addShape=function(e){if(this._shapes.length>0)throw"only allow single shape on controller!";n.prototype.addShape.call(this,e),this._updateFlag.flag=!0},i.clearShapes=function(){this._shapes.length>0&&n.prototype.removeShape.call(this,this._shapes[0])},i._onUpdate=function(){if(this._updateFlag.flag){var e=this.entity.transform,r=this.shapes;this._nativeCollider.setWorldPosition(e.worldPosition);for(var a=e.lossyWorldScale,o=0,l=r.length;o<l;o++)r[o]._nativeShape.setWorldScale(a);this._updateFlag.flag=!1}},i._onLateUpdate=function(){var e=this.entity.transform.worldPosition;this._nativeCollider.getWorldPosition(e),this._updateFlag.flag=!1},i._onEnableInScene=function(){var e=this.scene.physics;e._addCharacterController(this);for(var r=this.shapes,a=0,o=r.length;a<o;a++)e._addColliderShape(r[a])},i._onDisableInScene=function(){var e=this.scene.physics;e._removeCharacterController(this);for(var r=this.shapes,a=0,o=r.length;a<o;a++)e._removeColliderShape(r[a])},i._setUpDirection=function(){this._nativeCollider.setUpDirection(this._upDirection)},q(s,[{key:"stepOffset",get:function(){return this._stepOffset},set:function(e){this._stepOffset!==e&&(this._stepOffset=e,this._nativeCollider.setStepOffset(e))}},{key:"nonWalkableMode",get:function(){return this._nonWalkableMode},set:function(e){this._nonWalkableMode!==e&&(this._nonWalkableMode=e,this._nativeCollider.setNonWalkableMode(e))}},{key:"upDirection",get:function(){return this._upDirection},set:function(e){this._upDirection!==e&&this._upDirection.copyFrom(e)}},{key:"slopeLimit",get:function(){return this._slopeLimit},set:function(e){this._slopeLimit!==e&&(this._slopeLimit=e,this._nativeCollider.setSlopeLimit(e))}}]),s}(Ft),Kt=function(n){W(s,n);function s(t){var e;e=n.call(this,t)||this,e._linearDamping=0,e._angularDamping=.05,e._linearVelocity=new w,e._angularVelocity=new w,e._mass=1,e._centerOfMass=new w,e._inertiaTensor=new w(1,1,1),e._maxAngularVelocity=100,e._maxDepenetrationVelocity=1e3,e._solverIterations=4,e._isKinematic=!1,e._constraints=0,e._collisionDetectionMode=0,e._sleepThreshold=.005;var r=e.entity.transform;return e._nativeCollider=Qt._nativePhysics.createDynamicCollider(r.worldPosition,r.worldRotationQuaternion),e._setLinearVelocity=e._setLinearVelocity.bind(ue(e)),e._setAngularVelocity=e._setAngularVelocity.bind(ue(e)),e._setCenterOfMass=e._setCenterOfMass.bind(ue(e)),e._setInertiaTensor=e._setInertiaTensor.bind(ue(e)),e._linearVelocity._onValueChanged=e._setLinearVelocity,e._angularVelocity._onValueChanged=e._setAngularVelocity,e._centerOfMass._onValueChanged=e._setCenterOfMass,e._inertiaTensor._onValueChanged=e._setInertiaTensor,e}var i=s.prototype;return i.applyForce=function(e){this._nativeCollider.addForce(e)},i.applyTorque=function(e){this._nativeCollider.addTorque(e)},i.move=function(e,r){this._nativeCollider.move(e,r)},i.sleep=function(){this._nativeCollider.sleep()},i.wakeUp=function(){this._nativeCollider.wakeUp()},i._onLateUpdate=function(){var e=this.entity.transform,r=e.worldPosition,a=e.worldRotationQuaternion;this._nativeCollider.getWorldTransform(r,a),this._updateFlag.flag=!1},i._cloneTo=function(e){n.prototype._cloneTo.call(this,e),e.linearDamping=this.linearDamping,e.angularDamping=this.angularDamping,e.linearVelocity=this.linearVelocity,e.angularVelocity=this.angularVelocity,e.mass=this.mass,e.centerOfMass=this.centerOfMass,e.inertiaTensor=this.inertiaTensor,e.maxAngularVelocity=this.maxAngularVelocity,e.maxDepenetrationVelocity=this.maxDepenetrationVelocity,e.sleepThreshold=this.sleepThreshold,e.solverIterations=this.solverIterations,e.isKinematic=this.isKinematic,e.constraints=this.constraints,e.collisionDetectionMode=this.collisionDetectionMode},i._setLinearVelocity=function(){this._nativeCollider.setLinearVelocity(this._linearVelocity)},i._setAngularVelocity=function(){this._nativeCollider.setAngularVelocity(this._angularVelocity)},i._setCenterOfMass=function(){this._nativeCollider.setCenterOfMass(this._centerOfMass)},i._setInertiaTensor=function(){this._nativeCollider.setInertiaTensor(this._inertiaTensor)},q(s,[{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping!==e&&(this._linearDamping=e,this._nativeCollider.setLinearDamping(e))}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping!==e&&(this._angularDamping=e,this._nativeCollider.setAngularDamping(e))}},{key:"linearVelocity",get:function(){return this._linearVelocity},set:function(e){this._linearVelocity!==e&&this._linearVelocity.copyFrom(e)}},{key:"angularVelocity",get:function(){return this._angularVelocity},set:function(e){this._angularVelocity!==e&&this._angularVelocity.copyFrom(e)}},{key:"mass",get:function(){return this._mass},set:function(e){this._mass!==e&&(this._mass=e,this._nativeCollider.setMass(e))}},{key:"centerOfMass",get:function(){return this._centerOfMass},set:function(e){this._centerOfMass!==e&&this._centerOfMass.copyFrom(e)}},{key:"inertiaTensor",get:function(){return this._inertiaTensor},set:function(e){this._inertiaTensor!==e&&this._inertiaTensor.copyFrom(e)}},{key:"maxAngularVelocity",get:function(){return this._maxAngularVelocity},set:function(e){this._maxAngularVelocity!==e&&(this._maxAngularVelocity=e,this._nativeCollider.setMaxAngularVelocity(e))}},{key:"maxDepenetrationVelocity",get:function(){return this._maxDepenetrationVelocity},set:function(e){this._maxDepenetrationVelocity!==e&&(this._maxDepenetrationVelocity=e,this._nativeCollider.setMaxDepenetrationVelocity(e))}},{key:"sleepThreshold",get:function(){return this._sleepThreshold},set:function(e){e!==this._sleepThreshold&&(this._sleepThreshold=e,this._nativeCollider.setSleepThreshold(e))}},{key:"solverIterations",get:function(){return this._solverIterations},set:function(e){this._solverIterations!==e&&(this._solverIterations=e,this._nativeCollider.setSolverIterations(e))}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic!==e&&(this._isKinematic=e,this._nativeCollider.setIsKinematic(e))}},{key:"constraints",get:function(){return this._constraints},set:function(e){this._constraints!==e&&(this._constraints=e,this._nativeCollider.setConstraints(e))}},{key:"collisionDetectionMode",get:function(){return this._collisionDetectionMode},set:function(e){this._collisionDetectionMode!==e&&(this._collisionDetectionMode=e,this._nativeCollider.setCollisionDetectionMode(e))}}]),s}(Ft);R([I],Kt.prototype,"_linearDamping",void 0);R([I],Kt.prototype,"_angularDamping",void 0);R([I],Kt.prototype,"_linearVelocity",void 0);R([I],Kt.prototype,"_angularVelocity",void 0);R([I],Kt.prototype,"_mass",void 0);R([I],Kt.prototype,"_centerOfMass",void 0);R([I],Kt.prototype,"_inertiaTensor",void 0);R([I],Kt.prototype,"_maxAngularVelocity",void 0);R([I],Kt.prototype,"_maxDepenetrationVelocity",void 0);R([I],Kt.prototype,"_solverIterations",void 0);R([I],Kt.prototype,"_isKinematic",void 0);R([I],Kt.prototype,"_constraints",void 0);R([I],Kt.prototype,"_collisionDetectionMode",void 0);R([I],Kt.prototype,"_sleepThreshold",void 0);var mo;(function(n){n[n.Discrete=0]="Discrete",n[n.Continuous=1]="Continuous",n[n.ContinuousDynamic=2]="ContinuousDynamic",n[n.ContinuousSpeculative=3]="ContinuousSpeculative"})(mo||(mo={}));var yo;(function(n){n[n.None=0]="None",n[n.FreezePositionX=1]="FreezePositionX",n[n.FreezePositionY=2]="FreezePositionY",n[n.FreezePositionZ=4]="FreezePositionZ",n[n.FreezeRotationX=8]="FreezeRotationX",n[n.FreezeRotationY=16]="FreezeRotationY",n[n.FreezeRotationZ=32]="FreezeRotationZ"})(yo||(yo={}));var xc=function(){this.entity=null,this.distance=0,this.point=new w,this.normal=new w,this.shape=null},Ga;(function(n){n[n.Average=0]="Average",n[n.Minimum=1]="Minimum",n[n.Multiply=2]="Multiply",n[n.Maximum=3]="Maximum"})(Ga||(Ga={}));var bc=function(){function n(){this._bounciness=.1,this._dynamicFriction=.1,this._staticFriction=.1,this._bounceCombine=Ga.Average,this._frictionCombine=Ga.Average,this._nativeMaterial=Qt._nativePhysics.createPhysicsMaterial(this._staticFriction,this._dynamicFriction,this._bounciness,this._bounceCombine,this._frictionCombine)}var s=n.prototype;return s._destroy=function(){!this._destroyed&&this._nativeMaterial.destroy(),this._destroyed=!0},q(n,[{key:"bounciness",get:function(){return this._bounciness},set:function(t){this._bounciness!==t&&(this._bounciness=t,this._nativeMaterial.setBounciness(t))}},{key:"dynamicFriction",get:function(){return this._dynamicFriction},set:function(t){this._dynamicFriction!==t&&(this._dynamicFriction=t,this._nativeMaterial.setDynamicFriction(t))}},{key:"staticFriction",get:function(){return this._staticFriction},set:function(t){this._staticFriction!==t&&(this._staticFriction=t,this._nativeMaterial.setStaticFriction(t))}},{key:"bounceCombine",get:function(){return this._bounceCombine},set:function(t){this._bounceCombine!==t&&(this._bounceCombine=t,this._nativeMaterial.setBounceCombine(t))}},{key:"frictionCombine",get:function(){return this._frictionCombine},set:function(t){this._frictionCombine!==t&&(this._frictionCombine=t,this._nativeMaterial.setFrictionCombine(t))}}]),n}(),Qu=function(n){W(s,n);function s(i){var t;t=n.call(this,i)||this;var e=t.entity.transform;return t._nativeCollider=Qt._nativePhysics.createStaticCollider(e.worldPosition,e.worldRotationQuaternion),t}return s}(Ft),Kn;(function(n){n[n.X=0]="X",n[n.Y=1]="Y",n[n.Z=2]="Z"})(Kn||(Kn={}));var xo;(function(n){n[n.Sides=1]="Sides",n[n.Up=2]="Up",n[n.Down=4]="Down"})(xo||(xo={}));var Gr=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._colliderInfo=new As,e._connectedColliderInfo=new As,e._force=0,e._torque=0,e._connectedColliderInfo.localPosition=new w,e}var i=s.prototype;return i._cloneTo=function(e){e.connectedCollider=this.connectedCollider,e.connectedAnchor=this.connectedAnchor,e.connectedMassScale=this.connectedMassScale,e.connectedInertiaScale=this.connectedInertiaScale,e.massScale=this.massScale,e.inertiaScale=this.inertiaScale,e.breakForce=this.breakForce,e.breakTorque=this.breakTorque},q(s,[{key:"connectedCollider",get:function(){return this._connectedColliderInfo.collider},set:function(e){this._connectedColliderInfo.collider!==e&&(this._connectedColliderInfo.collider=e,this._nativeJoint.setConnectedCollider(e._nativeCollider))}},{key:"connectedAnchor",get:function(){return this._connectedColliderInfo.localPosition},set:function(e){var r=this._connectedColliderInfo.localPosition;e!==r&&r.copyFrom(e),this._nativeJoint.setConnectedAnchor(e)}},{key:"connectedMassScale",get:function(){return this._connectedColliderInfo.massScale},set:function(e){e!==this._connectedColliderInfo.massScale&&(this._connectedColliderInfo.massScale=e,this._nativeJoint.setConnectedMassScale(e))}},{key:"connectedInertiaScale",get:function(){return this._connectedColliderInfo.inertiaScale},set:function(e){e!==this._connectedColliderInfo.inertiaScale&&(this._connectedColliderInfo.inertiaScale=e,this._nativeJoint.setConnectedInertiaScale(e))}},{key:"massScale",get:function(){return this._colliderInfo.massScale},set:function(e){e!==this._colliderInfo.massScale&&(this._colliderInfo.massScale=e,this._nativeJoint.setMassScale(e))}},{key:"inertiaScale",get:function(){return this._colliderInfo.inertiaScale},set:function(e){e!==this._colliderInfo.inertiaScale&&(this._colliderInfo.inertiaScale=e,this._nativeJoint.setInertiaScale(e))}},{key:"breakForce",get:function(){return this._force},set:function(e){e!==this._force&&(this._force=e,this._nativeJoint.setBreakForce(e))}},{key:"breakTorque",get:function(){return this._torque},set:function(e){e!==this._torque&&(this._torque=e,this._nativeJoint.setBreakTorque(e))}}]),s}(Vt);R([I],Gr.prototype,"_colliderInfo",void 0);R([I],Gr.prototype,"_connectedColliderInfo",void 0);R([I],Gr.prototype,"_nativeJoint",void 0);R([I],Gr.prototype,"_force",void 0);R([I],Gr.prototype,"_torque",void 0);Gr=R([An(Ft,Ur.CheckOnly)],Gr);var As=function(){this.collider=null,this.massScale=0,this.inertiaScale=0},Ku=function(n){W(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i._onAwake=function(){var e=this._colliderInfo;e.collider=this.entity.getComponent(Ft),this._nativeJoint=Qt._nativePhysics.createFixedJoint(e.collider._nativeCollider)},s}(Gr),Zt;(function(n){n[n.None=0]="None",n[n.LimitEnabled=1]="LimitEnabled",n[n.DriveEnabled=2]="DriveEnabled",n[n.DriveFreeSpin=4]="DriveFreeSpin"})(Zt||(Zt={}));var Ta=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t._axis=new w(1,0,0),t._hingeFlags=Zt.None,t._useSpring=!1,t}var i=s.prototype;return i._onAwake=function(){var e=this._colliderInfo;e.localPosition=new w,e.collider=this.entity.getComponent(Ft),this._nativeJoint=Qt._nativePhysics.createHingeJoint(e.collider._nativeCollider)},i._cloneTo=function(e){e.axis=this.axis,e.swingOffset=this.swingOffset,e.useLimits=this.useLimits,e.useMotor=this.useMotor,e.useSpring=this.useSpring,e.motor=this.motor,e.limits=this.limits},q(s,[{key:"axis",get:function(){return this._axis},set:function(e){var r=this._axis;e!==r&&r.copyFrom(e),this._nativeJoint.setAxis(r)}},{key:"swingOffset",get:function(){return this._colliderInfo.localPosition},set:function(e){var r=this._colliderInfo.localPosition;e!==r&&r.copyFrom(e),this._nativeJoint.setSwingOffset(r)}},{key:"angle",get:function(){return this._nativeJoint.getAngle()}},{key:"velocity",get:function(){return this._nativeJoint.getVelocity()}},{key:"useLimits",get:function(){return(this._hingeFlags&Zt.LimitEnabled)==Zt.LimitEnabled},set:function(e){e!==this.useLimits&&(e?this._hingeFlags|=Zt.LimitEnabled:this._hingeFlags&=~Zt.LimitEnabled,this._nativeJoint.setHingeJointFlag(Zt.LimitEnabled,e))}},{key:"useMotor",get:function(){return(this._hingeFlags&Zt.DriveEnabled)==Zt.DriveEnabled},set:function(e){e!==this.useMotor&&(e?this._hingeFlags|=Zt.DriveEnabled:this._hingeFlags&=~Zt.DriveEnabled,this._nativeJoint.setHingeJointFlag(Zt.DriveEnabled,e))}},{key:"useSpring",get:function(){return this._useSpring},set:function(e){this._useSpring!==e&&(this._useSpring=e,this.limits=this._limits)}},{key:"motor",get:function(){return this._jointMonitor},set:function(e){this._jointMonitor!==e&&(this._jointMonitor=e,this._nativeJoint.setDriveVelocity(e.targetVelocity),this._nativeJoint.setDriveForceLimit(e.forceLimit),this._nativeJoint.setDriveGearRatio(e.gearRation),this._nativeJoint.setHingeJointFlag(Zt.DriveFreeSpin,e.freeSpin))}},{key:"limits",get:function(){return this._limits},set:function(e){this._limits!==e&&(this._limits=e,this.useSpring?this._nativeJoint.setSoftLimit(e.min,e.max,e.stiffness,e.damping):this._nativeJoint.setHardLimit(e.min,e.max,e.contactDistance))}}]),s}(Gr);R([I],Ta.prototype,"_axis",void 0);R([I],Ta.prototype,"_hingeFlags",void 0);R([I],Ta.prototype,"_useSpring",void 0);R([I],Ta.prototype,"_jointMonitor",void 0);R([I],Ta.prototype,"_limits",void 0);var Ju=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t._minDistance=0,t._maxDistance=0,t._tolerance=.25,t._stiffness=0,t._damping=0,t}var i=s.prototype;return i._onAwake=function(){var e=this._colliderInfo;e.localPosition=new w,e.collider=this.entity.getComponent(Ft),this._nativeJoint=Qt._nativePhysics.createSpringJoint(e.collider._nativeCollider)},i._cloneTo=function(e){e.swingOffset=this.swingOffset,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.tolerance=this.tolerance,e.stiffness=this.stiffness,e.damping=this.damping},q(s,[{key:"swingOffset",get:function(){return this._colliderInfo.localPosition},set:function(e){var r=this._colliderInfo.localPosition;e!==r&&r.copyFrom(e),this._nativeJoint.setSwingOffset(e)}},{key:"minDistance",get:function(){return this._minDistance},set:function(e){this._minDistance!==e&&(this._minDistance=e,this._nativeJoint.setMinDistance(e))}},{key:"maxDistance",get:function(){return this._maxDistance},set:function(e){this._maxDistance!==e&&(this._maxDistance=e,this._nativeJoint.setMaxDistance(e))}},{key:"tolerance",get:function(){return this._tolerance},set:function(e){this._tolerance!==e&&(this._tolerance=e,this._nativeJoint.setTolerance(e))}},{key:"stiffness",get:function(){return this._stiffness},set:function(e){this._stiffness!==e&&(this._stiffness=e,this._nativeJoint.setStiffness(e))}},{key:"damping",get:function(){return this._damping},set:function(e){this._damping!==e&&(this._damping=e,this._nativeJoint.setDamping(e))}}]),s}(Gr),Zu=function(){this.max=0,this.min=0,this.contactDistance=-1,this.stiffness=0,this.damping=0},$u=function(){this.targetVelocity=0,this.forceLimit=Number.MAX_VALUE,this.gearRation=1,this.freeSpin=!1},or=function(){function n(){this._isTrigger=!1,this._rotation=new w,this._position=new w,this._contactOffset=.02,this.isSceneQuery=!0,this._material=new bc,this._id=n._idGenerator++,this._setRotation=this._setRotation.bind(this),this._setPosition=this._setPosition.bind(this),this._rotation._onValueChanged=this._setRotation,this._position._onValueChanged=this._setPosition}var s=n.prototype;return s._cloneTo=function(t){t.contactOffset=this.contactOffset,t.rotation=this.rotation,t.position=this.position,t.isTrigger=this.isTrigger,t.material=this.material},s._destroy=function(){this._material._destroy(),this._nativeShape.destroy()},s._setPosition=function(){this._nativeShape.setPosition(this._position)},s._setRotation=function(){this._nativeShape.setRotation(this._rotation)},q(n,[{key:"collider",get:function(){return this._collider}},{key:"id",get:function(){return this._id}},{key:"contactOffset",get:function(){return this._contactOffset},set:function(t){this._contactOffset!==t&&(this._contactOffset=t,this._nativeShape.setContactOffset(t))}},{key:"material",get:function(){return this._material},set:function(t){this._material!==t&&(this._material=t,this._nativeShape.setMaterial(t._nativeMaterial))}},{key:"rotation",get:function(){return this._rotation},set:function(t){this._rotation!=t&&this._rotation.copyFrom(t)}},{key:"position",get:function(){return this._position},set:function(t){this._position!==t&&this._position.copyFrom(t)}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(t){this._isTrigger!==t&&(this._isTrigger=t,this._nativeShape.setIsTrigger(t))}}]),n}();(function(){or._idGenerator=0})();R([I],or.prototype,"_collider",void 0);R([I],or.prototype,"_nativeShape",void 0);R([I],or.prototype,"_id",void 0);R([I],or.prototype,"_material",void 0);R([I],or.prototype,"_isTrigger",void 0);R([I],or.prototype,"_rotation",void 0);R([I],or.prototype,"_position",void 0);R([I],or.prototype,"_contactOffset",void 0);var qo=function(n){W(s,n);function s(){var t;return t=n.call(this)||this,t._size=new w(1,1,1),t._nativeShape=Qt._nativePhysics.createBoxColliderShape(t._id,t._size,t._material._nativeMaterial),t._setSize=t._setSize.bind(ue(t)),t._size._onValueChanged=t._setSize,t}var i=s.prototype;return i._cloneTo=function(e){n.prototype._cloneTo.call(this,e),e.size=this.size},i._setSize=function(){this._nativeShape.setSize(this._size)},q(s,[{key:"size",get:function(){return this._size},set:function(e){this._size!==e&&this._size.copyFrom(e)}}]),s}(or);R([I],qo.prototype,"_size",void 0);var Yo=function(n){W(s,n);function s(){var t;return t=n.call(this)||this,t._radius=1,t._nativeShape=Qt._nativePhysics.createSphereColliderShape(t._id,t._radius,t._material._nativeMaterial),t}var i=s.prototype;return i._cloneTo=function(e){n.prototype._cloneTo.call(this,e),e.radius=this.radius},q(s,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=e,this._nativeShape.setRadius(e))}}]),s}(or);R([I],Yo.prototype,"_radius",void 0);var ed=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._nativeShape=Qt._nativePhysics.createPlaneColliderShape(i._id,i._material._nativeMaterial),i}return s}(or),Ja=function(n){W(s,n);function s(){var t;return t=n.call(this)||this,t._radius=1,t._height=2,t._upAxis=Kn.Y,t._nativeShape=Qt._nativePhysics.createCapsuleColliderShape(t._id,t._radius,t._height,t._material._nativeMaterial),t}var i=s.prototype;return i._cloneTo=function(e){n.prototype._cloneTo.call(this,e),e.radius=this.radius,e.height=this.height,e.upAxis=this.upAxis},q(s,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=e,this._nativeShape.setRadius(e))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._height=e,this._nativeShape.setHeight(e))}},{key:"upAxis",get:function(){return this._upAxis},set:function(e){this._upAxis!==e&&(this._upAxis=e,this._nativeShape.setUpAxis(e))}}]),s}(or);R([I],Ja.prototype,"_radius",void 0);R([I],Ja.prototype,"_height",void 0);R([I],Ja.prototype,"_upAxis",void 0);var eo=function(){function n(i,t){if(this._pointers=[],this._multiPointerEnabled=!0,this._buttons=er.None,this._upMap=[],this._downMap=[],this._upList=new Ye,this._downList=new Ye,this._nativeEvents=[],typeof Window<"u"&&ft(t,Window))throw"Do not set window as target because window cannot listen to pointer leave event.";this._engine=i,this._target=t,this._canvas=i.canvas,this._htmlCanvas=i._canvas._webCanvas,this._pointerPool=new Array(11),this._onPointerEvent=this._onPointerEvent.bind(this),this._addEventListener()}var s=n.prototype;return s._update=function(){for(var t=this,e=t._pointers,r=t._nativeEvents,a=t._htmlCanvas,o=this._canvas,l=o.width,c=o.height,_=a.clientWidth,u=a.clientHeight,d=a.getBoundingClientRect(),h=d.left,f=d.top,v=l/_,p=c/u,g=e.length-1;g>=0;g--)e[g].phase===_r.Leave&&e.splice(g,1);for(var y=0,m=r.length;y<m;y++){var x=r[y],S=x.pointerId,b=this._getPointerByID(S);if(b)b._events.push(x);else{var A=e.length;if(A===0||this._multiPointerEnabled){for(var C,E,T=this,B=T._pointerPool,M=0;M<A&&!(e[M].id>M);M++);b=(C=B)[E=M]||(C[E]=new yc(M)),b._uniqueID=S,b._events.push(x),b.position.set((x.clientX-h)*v,(x.clientY-f)*p),e.splice(M,0,b)}}}r.length=0,this._upList.length=this._downList.length=0,this._buttons=er.None;for(var P=this._engine.time.frameCount,V=0,N=e.length;V<N;V++){var F=e[V];F._upList.length=F._downList.length=0,this._updatePointerInfo(P,F,h,f,v,p),this._buttons|=F.pressedButtons}},s._firePointerScript=function(t){for(var e=this,r=e._pointers,a=e._canvas,o=0,l=r.length;o<l;o++){var c=r[o],_=c._events,u=c.position;c._firePointerDrag();var d=this._pointerRayCast(t,u.x/a.width,u.y/a.height);c._firePointerExitAndEnter(d);var h=_.length;if(h>0){for(var f=0;f<h;f++){var v=_[f];switch(v.type){case"pointerdown":c.phase=_r.Down,c._firePointerDown(d);break;case"pointerup":c.phase=_r.Up,c._firePointerUpAndClick(d);break;case"pointerleave":case"pointercancel":c.phase=_r.Leave,c._firePointerExitAndEnter(null);break}}_.length=0}}},s._destroy=function(){this._removeEventListener(),this._pointerPool.length=0,this._nativeEvents.length=0,this._downMap.length=0,this._upMap.length=0},s._onPointerEvent=function(t){this._nativeEvents.push(t)},s._getPointerByID=function(t){for(var e=this,r=e._pointers,a=r.length-1;a>=0;a--)if(r[a]._uniqueID===t)return r[a];return null},s._updatePointerInfo=function(t,e,r,a,o,l){var c=e._events,_=e.position,u=c.length;if(u>0){var d=this,h=d._upList,f=d._upMap,v=d._downList,p=d._downMap,g=c[u-1],y=(g.clientX-r)*o,m=(g.clientY-a)*l;e.deltaPosition.set(y-_.x,m-_.y),_.set(y,m);for(var x=0;x<u;x++){var S=c[x],b=S.button;switch(e.button=Xu[b]||er.None,e.pressedButtons=S.buttons,S.type){case"pointerdown":v.add(b),p[b]=t,e._downList.add(b),e._downMap[b]=t,e.phase=_r.Down;break;case"pointerup":h.add(b),f[b]=t,e._upList.add(b),e._upMap[b]=t,e.phase=_r.Up;break;case"pointermove":e.phase=_r.Move;break;case"pointerleave":case"pointercancel":e.phase=_r.Leave}}this._engine._physicsInitialized||(c.length=0)}else e.deltaPosition.set(0,0),e.phase=_r.Stationary},s._pointerRayCast=function(t,e,r){for(var a=n._tempPoint,o=n._tempRay,l=n._tempHitResult,c=t.length-1;c>=0;c--){var _=t[c];if(!(!_.isActive||_.destroyed))for(var u=_._componentsManager,d=u._activeCameras,h=d._elements,f=d.length-1;f>=0;f--){var v=h[f];if(!v.renderTarget){var p=v.viewport,g=p.x,y=p.y,m=p.z,x=p.w;if(e>=g&&r>=y&&e-g<=m&&r-y<=x){if(a.set((e-g)/m,(r-y)/x),_.physics.raycast(v.viewportPointToRay(a,o),Number.MAX_VALUE,v.cullingMask,l))return l.entity;if(v.clearFlags&Lt.Color)return null}}}}return null},s._addEventListener=function(){var t=this,e=t._target,r=t._onPointerEvent;e.addEventListener("pointerdown",r),e.addEventListener("pointerup",r),e.addEventListener("pointerleave",r),e.addEventListener("pointermove",r),e.addEventListener("pointercancel",r)},s._removeEventListener=function(){var t=this,e=t._target,r=t._onPointerEvent;e.removeEventListener("pointerdown",r),e.removeEventListener("pointerup",r),e.removeEventListener("pointerleave",r),e.removeEventListener("pointermove",r),e.removeEventListener("pointercancel",r),this._nativeEvents.length=0,this._pointers.length=0,this._downList.length=0,this._upList.length=0},n}();(function(){eo._tempRay=new Qc})();(function(){eo._tempPoint=new $})();(function(){eo._tempHitResult=new xc})();var td=function(){function n(i,t){this._delta=new w,this._nativeEvents=[],this._onWheelEvent=this._onWheelEvent.bind(this),this._target=t,this._addEventListener()}var s=n.prototype;return s._update=function(){var t=this,e=t._delta;e.set(0,0,0);var r=this,a=r._nativeEvents;if(a.length>0){for(var o=a.length-1;o>=0;o--){var l=a[o];e.x+=l.deltaX,e.y+=l.deltaY,e.z+=l.deltaZ}a.length=0}},s._addEventListener=function(){this._target.addEventListener("wheel",this._onWheelEvent)},s._removeEventListener=function(){this._target.removeEventListener("wheel",this._onWheelEvent),this._nativeEvents.length=0,this._delta.set(0,0,0)},s._destroy=function(){this._removeEventListener(),this._nativeEvents=null,this._delta=null},s._onWheelEvent=function(t){this._nativeEvents.push(t)},n}(),Cc=function(){function n(i,t){this._initialized=!1,this._engine=i;var e=i._canvas._webCanvas;if(typeof OffscreenCanvas>"u"||!ft(e,OffscreenCanvas)){var r,a,o,l;this._wheelManager=new td(i,(l=(r=t)==null?void 0:r.wheelTarget)!=null?l:e);var c;this._pointerManager=new eo(i,(c=(a=t)==null?void 0:a.pointerTarget)!=null?c:e);var _;this._keyboardManager=new ju(i,(_=(o=t)==null?void 0:o.keyboardTarget)!=null?_:window),this._initialized=!0}}var s=n.prototype;return s.isKeyHeldDown=function(t){return this._initialized?t===void 0?this._keyboardManager._curFrameHeldDownList.length>0:this._keyboardManager._curHeldDownKeyToIndexMap[t]!=null:!1},s.isKeyDown=function(t){return this._initialized?t===void 0?this._keyboardManager._curFrameDownList.length>0:this._keyboardManager._downKeyToFrameCountMap[t]===this._engine.time.frameCount:!1},s.isKeyUp=function(t){return this._initialized?t===void 0?this._keyboardManager._curFrameUpList.length>0:this._keyboardManager._upKeyToFrameCountMap[t]===this._engine.time.frameCount:!1},s.isPointerHeldDown=function(t){return this._initialized?t===void 0?this._pointerManager._buttons!==0:(this._pointerManager._buttons&t)!==0:!1},s.isPointerDown=function(t){return this._initialized?t===void 0?this._pointerManager._downList.length>0:this._pointerManager._downMap[Ss[t]]===this._engine.time.frameCount:!1},s.isPointerUp=function(t){return this._initialized?t===void 0?this._pointerManager._upList.length>0:this._pointerManager._upMap[Ss[t]]===this._engine.time.frameCount:!1},s._update=function(){this._initialized&&(this._wheelManager._update(),this._pointerManager._update(),this._keyboardManager._update())},s._firePointerScript=function(t){this._initialized&&this._pointerManager._firePointerScript(t)},s._destroy=function(){this._initialized&&(this._wheelManager._destroy(),this._wheelManager=null,this._pointerManager._destroy(),this._pointerManager=null,this._keyboardManager._destroy(),this._keyboardManager=null)},q(n,[{key:"pointers",get:function(){return this._initialized?this._pointerManager._pointers:[]}},{key:"multiPointerEnabled",get:function(){return this._initialized?this._pointerManager._multiPointerEnabled:!1},set:function(t){this._initialized&&(this._pointerManager._multiPointerEnabled=t)}},{key:"wheelDelta",get:function(){return this._initialized?this._wheelManager._delta:null}}]),n}(),bo;(function(n){n.cornerTextureCoordinate="a_CornerTextureCoordinate"})(bo||(bo={}));var cr;(function(n){n.ShapePositionStartLifeTime="a_ShapePositionStartLifeTime",n.DirectionTime="a_DirectionTime",n.StartColor="a_StartColor",n.StartSize="a_StartSize",n.StartRotation0="a_StartRotation0",n.StartSpeed="a_StartSpeed",n.Random0="a_Random0",n.Random1="a_Random1",n.SimulationWorldPosition="a_SimulationWorldPosition",n.SimulationWorldRotation="a_SimulationWorldRotation",n.SimulationUV="a_SimulationUV"})(cr||(cr={}));var rd=function(s){this.billboardVertexElement=new Me(bo.cornerTextureCoordinate,0,ee.Vector4,0),this.instanceVertexElements=[new Me(cr.ShapePositionStartLifeTime,0,ee.Vector4,1,1),new Me(cr.DirectionTime,16,ee.Vector4,1,1),new Me(cr.StartColor,32,ee.Vector4,1,1),new Me(cr.StartSize,48,ee.Vector3,1,1),new Me(cr.StartRotation0,60,ee.Vector3,1,1),new Me(cr.StartSpeed,72,ee.Float,1,1),new Me(cr.Random0,76,ee.Vector4,1,1),new Me(cr.Random1,92,ee.Vector4,1,1),new Me(cr.SimulationWorldPosition,108,ee.Vector3,1,1),new Me(cr.SimulationWorldRotation,120,ee.Vector4,1,1),new Me(cr.SimulationUV,136,ee.Vector4,1,1)],this.instanceVertexStride=152,this.instanceVertexFloatStride=this.instanceVertexStride/4,this.startLifeTimeOffset=3,this.timeOffset=7,this.simulationUVOffset=34,this.billboardIndexCount=6;var i=16,t=new ir(s,Nt.VertexBuffer,i*4,tt.Static,!1);t.isGCIgnored=!0,this.billboardVertexBufferBinding=new $n(t,i);var e=new ir(s,Nt.IndexBuffer,this.billboardIndexCount,tt.Static,!1);e.isGCIgnored=!0,this.billboardIndexBufferBinding=new Ua(e,Et.UInt8);var r=new Float32Array([-.5,-.5,0,1,.5,-.5,1,1,.5,.5,1,0,-.5,.5,0,0]),a=new Uint8Array([0,2,3,0,1,2]);t.setData(r),e.setData(a),s.resourceManager.addContentRestorer(new(function(o){W(l,o);function l(){return o.call(this,t)}var c=l.prototype;return c.restoreContent=function(){t.setData(r)},l}(Rr))),s.resourceManager.addContentRestorer(new(function(o){W(l,o);function l(){return o.call(this,e)}var c=l.prototype;return c.restoreContent=function(){},l}(Rr)))},nd=`#define GLSLIFY 1
uniform mediump sampler2D renderer_BlitTexture;
#ifdef HAS_TEX_LOD
uniform float renderer_BlitMipLevel;
#endif
varying vec2 v_uv;void main(){
#ifdef HAS_TEX_LOD
gl_FragColor=texture2DLodEXT(renderer_BlitTexture,v_uv,renderer_BlitMipLevel);
#else
gl_FragColor=texture2D(renderer_BlitTexture,v_uv);
#endif
}`,ad=`#define GLSLIFY 1
attribute vec4 POSITION_UV;varying vec2 v_uv;void main(){gl_Position=vec4(POSITION_UV.xy,0.0,1.0);v_uv=POSITION_UV.zw;}`,id=`#define GLSLIFY 1
#include <common>
const float MIE_G=-0.990;const float MIE_G2=0.9801;const float SKY_GROUND_THRESHOLD=0.02;uniform float material_SunSize;uniform float material_SunSizeConvergence;uniform vec4 scene_SunlightColor;uniform vec3 scene_SunlightDirection;varying vec3 v_GroundColor;varying vec3 v_SkyColor;
#ifdef MATERIAL_SUN_HIGH_QUALITY
varying vec3 v_Vertex;
#elif defined(MATERIAL_SUN_SIMPLE)
varying vec3 v_RayDir;
#else
varying float v_SkyGroundFactor;
#endif
#if defined(MATERIAL_SUN_HIGH_QUALITY)||defined(MATERIAL_SUN_SIMPLE)
varying vec3 v_SunColor;
#endif
#if defined(ENGINE_IS_COLORSPACE_GAMMA)
#define LINEAR_2_OUTPUT(color) sqrt(color)
#endif
float getMiePhase(float eyeCos,float eyeCos2){float temp=1.0+MIE_G2-2.0*MIE_G*eyeCos;temp=pow(temp,pow(material_SunSize,0.65)*10.0);temp=max(temp,1.0e-4);temp=1.5*((1.0-MIE_G2)/(2.0+MIE_G2))*(1.0+eyeCos2)/temp;return temp;}float calcSunAttenuation(vec3 lightPos,vec3 ray){
#ifdef MATERIAL_SUN_HIGH_QUALITY
float focusedEyeCos=pow(clamp(dot(lightPos,ray),0.0,1.0),material_SunSizeConvergence);return getMiePhase(-focusedEyeCos,focusedEyeCos*focusedEyeCos);
#else
vec3 delta=lightPos-ray;float dist=length(delta);float spot=1.0-smoothstep(0.0,material_SunSize,dist);return spot*spot;
#endif
}void main(){vec3 col=vec3(0.0,0.0,0.0);
#ifdef MATERIAL_SUN_HIGH_QUALITY
vec3 ray=normalize(v_Vertex);float y=ray.y/SKY_GROUND_THRESHOLD;
#elif defined(MATERIAL_SUN_SIMPLE)
vec3 ray=v_RayDir;float y=ray.y/SKY_GROUND_THRESHOLD;
#else
float y=v_SkyGroundFactor;
#endif
col=mix(v_SkyColor,v_GroundColor,clamp(y,0.0,1.0));
#if defined(MATERIAL_SUN_HIGH_QUALITY)||defined(MATERIAL_SUN_SIMPLE)
if(y<0.0)col+=v_SunColor*calcSunAttenuation(-scene_SunlightDirection,-ray);
#endif
#ifdef ENGINE_IS_COLORSPACE_GAMMA
col=LINEAR_2_OUTPUT(col);
#endif
gl_FragColor=vec4(col,1.0);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
}`,od=`#define GLSLIFY 1
#define OUTER_RADIUS 1.025
#define RAYLEIGH (mix(0.0, 0.0025, pow(material_AtmosphereThickness,2.5)))
#define MIE 0.0010
#define SUN_BRIGHTNESS 20.0
#define MAX_SCATTER 50.0
const float SKY_GROUND_THRESHOLD=0.02;const float outerRadius=OUTER_RADIUS;const float outerRadius2=OUTER_RADIUS*OUTER_RADIUS;const float innerRadius=1.0;const float innerRadius2=1.0;const float cameraHeight=0.0001;const float HDSundiskIntensityFactor=15.0;const float simpleSundiskIntensityFactor=27.0;const float sunScale=400.0*SUN_BRIGHTNESS;const float kmESun=MIE*SUN_BRIGHTNESS;const float km4PI=MIE*4.0*3.14159265;const float scale=1.0/(OUTER_RADIUS-1.0);const float scaleDepth=0.25;const float scaleOverScaleDepth=(1.0/(OUTER_RADIUS-1.0))/0.25;const float samples=2.0;const vec3 c_DefaultScatteringWavelength=vec3(0.65,0.57,0.475);const vec3 c_VariableRangeForScatteringWavelength=vec3(0.15,0.15,0.15);attribute vec4 POSITION;uniform mat4 camera_VPMat;uniform vec3 material_SkyTint;uniform vec3 material_GroundTint;uniform float material_Exposure;uniform float material_AtmosphereThickness;uniform vec4 scene_SunlightColor;uniform vec3 scene_SunlightDirection;varying vec3 v_GroundColor;varying vec3 v_SkyColor;
#ifdef MATERIAL_SUN_HIGH_QUALITY
varying vec3 v_Vertex;
#elif defined(MATERIAL_SUN_SIMPLE)
varying vec3 v_RayDir;
#else
varying float v_SkyGroundFactor;
#endif
#if defined(MATERIAL_SUN_HIGH_QUALITY)||defined(MATERIAL_SUN_SIMPLE)
varying vec3 v_SunColor;
#endif
#if defined(ENGINE_IS_COLORSPACE_GAMMA)
#define COLOR_2_GAMMA(color) color
#define COLOR_2_LINEAR(color) color*color
#else
#define GAMMA 2.2
#define COLOR_2_GAMMA(color) pow(color,vec3(1.0/GAMMA))
#define COLOR_2_LINEAR(color) color
#endif
float getRayleighPhase(vec3 light,vec3 ray){float eyeCos=dot(light,ray);return 0.75+0.75*eyeCos*eyeCos;}float scaleAngle(float inCos){float x=1.0-inCos;return 0.25*exp(-0.00287+x*(0.459+x*(3.83+x*(-6.80+x*5.25))));}void main(){gl_Position=camera_VPMat*vec4(POSITION.xyz,1.0);vec3 skyTintInGammaSpace=COLOR_2_GAMMA(material_SkyTint);vec3 scatteringWavelength=mix(c_DefaultScatteringWavelength-c_VariableRangeForScatteringWavelength,c_DefaultScatteringWavelength+c_VariableRangeForScatteringWavelength,vec3(1.0)-skyTintInGammaSpace);vec3 invWavelength=1.0/pow(scatteringWavelength,vec3(4.0));float krESun=RAYLEIGH*SUN_BRIGHTNESS;float kr4PI=RAYLEIGH*4.0*3.14159265;vec3 cameraPos=vec3(0.0,innerRadius+cameraHeight,0.0);vec3 eyeRay=normalize(POSITION.xyz);float far=0.0;vec3 cIn,cOut;if(eyeRay.y>=0.0){far=sqrt(outerRadius2+innerRadius2*eyeRay.y*eyeRay.y-innerRadius2)-innerRadius*eyeRay.y;float height=innerRadius+cameraHeight;float depth=exp(scaleOverScaleDepth*-cameraHeight);float startAngle=dot(eyeRay,cameraPos)/height;float startOffset=depth*scaleAngle(startAngle);float sampleLength=far/samples;float scaledLength=sampleLength*scale;vec3 sampleRay=eyeRay*sampleLength;vec3 samplePoint=cameraPos+sampleRay*0.5;vec3 frontColor=vec3(0.0);{float height=length(samplePoint);float depth=exp(scaleOverScaleDepth*(innerRadius-height));float lightAngle=dot(-scene_SunlightDirection,samplePoint)/height;float cameraAngle=dot(eyeRay,samplePoint)/height;float scatter=(startOffset+depth*(scaleAngle(lightAngle)-scaleAngle(cameraAngle)));vec3 attenuate=exp(-clamp(scatter,0.0,MAX_SCATTER)*(invWavelength*kr4PI+km4PI));frontColor+=attenuate*(depth*scaledLength);samplePoint+=sampleRay;}{float height=length(samplePoint);float depth=exp(scaleOverScaleDepth*(innerRadius-height));float lightAngle=dot(-scene_SunlightDirection,samplePoint)/height;float cameraAngle=dot(eyeRay,samplePoint)/height;float scatter=(startOffset+depth*(scaleAngle(lightAngle)-scaleAngle(cameraAngle)));vec3 attenuate=exp(-clamp(scatter,0.0,MAX_SCATTER)*(invWavelength*kr4PI+km4PI));frontColor+=attenuate*(depth*scaledLength);samplePoint+=sampleRay;}cIn=frontColor*(invWavelength*krESun);cOut=frontColor*kmESun;}else{far=(-cameraHeight)/(min(-0.001,eyeRay.y));vec3 pos=cameraPos+far*eyeRay;float depth=exp((-cameraHeight)*(1.0/scaleDepth));float cameraAngle=dot(-eyeRay,pos);float lightAngle=dot(-scene_SunlightDirection,pos);float cameraScale=scaleAngle(cameraAngle);float lightScale=scaleAngle(lightAngle);float cameraOffset=depth*cameraScale;float temp=lightScale+cameraScale;float sampleLength=far/samples;float scaledLength=sampleLength*scale;vec3 sampleRay=eyeRay*sampleLength;vec3 samplePoint=cameraPos+sampleRay*0.5;vec3 frontColor=vec3(0.0,0.0,0.0);vec3 attenuate;{float height=length(samplePoint);float depth=exp(scaleOverScaleDepth*(innerRadius-height));float scatter=depth*temp-cameraOffset;attenuate=exp(-clamp(scatter,0.0,MAX_SCATTER)*(invWavelength*kr4PI+km4PI));frontColor+=attenuate*(depth*scaledLength);samplePoint+=sampleRay;}cIn=frontColor*(invWavelength*krESun+kmESun);cOut=clamp(attenuate,0.0,1.0);}
#ifdef MATERIAL_SUN_HIGH_QUALITY
v_Vertex=-POSITION.xyz;
#elif defined(MATERIAL_SUN_SIMPLE)
v_RayDir=-eyeRay;
#else
v_SkyGroundFactor=-eyeRay.y/SKY_GROUND_THRESHOLD;
#endif
v_GroundColor=material_Exposure*(cIn+COLOR_2_LINEAR(material_GroundTint)*cOut);v_SkyColor=material_Exposure*(cIn*getRayleighPhase(-scene_SunlightDirection,-eyeRay));float lightColorIntensity=clamp(length(scene_SunlightColor.xyz),0.25,1.0);
#ifdef MATERIAL_SUN_HIGH_QUALITY
v_SunColor=HDSundiskIntensityFactor*clamp(cOut,0.0,1.0)*scene_SunlightColor.xyz/lightColorIntensity;
#elif defined(MATERIAL_SUN_SIMPLE)
v_SunColor=simpleSundiskIntensityFactor*clamp(cOut*sunScale,0.0,1.0)*scene_SunlightColor.xyz/lightColorIntensity;
#endif
}`,sd=`#define GLSLIFY 1
uniform sampler2D material_BaseTexture;varying vec2 v_uv;void main(){gl_FragColor=texture2D(material_BaseTexture,v_uv);}`,ld=`#define GLSLIFY 1
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`,cd=`#define GLSLIFY 1
#include <common>
#include <camera_declare>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <ShadowFragmentDeclaration>
#include <mobile_material_frag>
#include <FogFragmentDeclaration>
#include <normal_get>
void main(){
#include <begin_mobile_frag>
#include <begin_viewdir_frag>
#include <mobile_blinnphong_frag>
gl_FragColor=emission+ambient+diffuse+specular;
#ifdef MATERIAL_IS_TRANSPARENT
gl_FragColor.a=diffuse.a;
#else
gl_FragColor.a=1.0;
#endif
#include <FogFragment>
#ifndef ENGINE_IS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
}`,_d=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <color_share>
#include <normal_share>
#include <worldpos_share>
#include <ShadowVertexDeclaration>
#include <FogVertexDeclaration>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <color_vert>
#include <normal_vert>
#include <worldpos_vert>
#include <position_vert>
#include <ShadowVertex>
#include <FogVertex>
}`,ud=`#define GLSLIFY 1
void main(){}`,dd=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
uniform mat4 camera_VPMat;void main(){
#include <begin_position_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <position_vert>
}`,hd=`#define GLSLIFY 1
#include <common>
varying vec4 v_Color;varying vec2 v_TextureCoordinate;uniform sampler2D material_BaseTexture;uniform vec4 material_BaseColor;
#ifdef RENDERER_MODE_MESH
varying vec4 v_MeshColor;
#endif
void main(){vec4 color=material_BaseColor*v_Color;
#ifdef RENDERER_MODE_MESH
color*=v_MeshColor;
#endif
#ifdef MATERIAL_HAS_BASETEXTURE
vec4 textureColor=texture2D(material_BaseTexture,v_TextureCoordinate);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
textureColor=gammaToLinear(textureColor);
#endif
color*=textureColor;
#endif
gl_FragColor=color;
#ifndef ENGINE_IS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
}`,fd=`#define GLSLIFY 1
#if defined(RENDERER_MODE_SPHERE_BILLBOARD) || defined(RENDERER_MODE_STRETCHED_BILLBOARD) || defined(RENDERER_MODE_HORIZONTAL_BILLBOARD) || defined(RENDERER_MODE_VERTICAL_BILLBOARD)
attribute vec4 a_CornerTextureCoordinate;
#endif
#ifdef RENDERER_MODE_MESH
attribute vec3 a_MeshPosition;attribute vec4 a_MeshColor;attribute vec2 a_MeshTextureCoordinate;varying vec4 v_MeshColor;
#endif
attribute vec4 a_ShapePositionStartLifeTime;attribute vec4 a_DirectionTime;attribute vec4 a_StartColor;attribute vec3 a_StartSize;attribute vec3 a_StartRotation0;attribute float a_StartSpeed;attribute vec4 a_Random0;
#if defined(RENDERER_TSA_FRAME_RANDOM_CURVES) || defined(RENDERER_VOL_RANDOM_CONSTANT) || defined(RENDERER_VOL_RANDOM_CURVE)
attribute vec4 a_Random1;
#endif
attribute vec3 a_SimulationWorldPosition;attribute vec4 a_SimulationWorldRotation;varying vec4 v_Color;
#ifdef MATERIAL_HAS_BASETEXTURE
attribute vec4 a_SimulationUV;varying vec2 v_TextureCoordinate;
#endif
uniform float renderer_CurrentTime;uniform vec3 renderer_Gravity;uniform vec2 u_DragConstant;uniform vec3 renderer_WorldPosition;uniform vec4 renderer_WorldRotation;uniform bool renderer_ThreeDStartRotation;uniform int renderer_ScalingMode;uniform vec3 renderer_PositionScale;uniform vec3 renderer_SizeScale;uniform vec3 renderer_PivotOffset;uniform mat4 camera_ViewMat;uniform mat4 camera_ProjMat;
#ifdef RENDERER_MODE_STRETCHED_BILLBOARD
uniform vec3 camera_Position;
#endif
uniform vec3 camera_Forward;uniform vec3 camera_Up;uniform float renderer_StretchedBillboardLengthScale;uniform float renderer_StretchedBillboardSpeedScale;uniform int renderer_SimulationSpace;
#include <particle_common>
#include <velocity_over_lifetime_module>
#include <color_over_lifetime_module>
#include <size_over_lifetime_module>
#include <rotation_over_lifetime_module>
#include <texture_sheet_animation_module>
void main(){float age=renderer_CurrentTime-a_DirectionTime.w;float normalizedAge=age/a_ShapePositionStartLifeTime.w;vec3 lifeVelocity;if(normalizedAge<1.0){vec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;
#if defined(RENDERER_VOL_CONSTANT) || defined(RENDERER_VOL_CURVE) || defined(RENDERER_VOL_RANDOM_CONSTANT) || defined(RENDERER_VOL_RANDOM_CURVE)
lifeVelocity=computeParticleLifeVelocity(normalizedAge);
#endif
vec3 gravityVelocity=renderer_Gravity*age;vec4 worldRotation;if(renderer_SimulationSpace==0){worldRotation=renderer_WorldRotation;}else{worldRotation=a_SimulationWorldRotation;}vec3 dragData=a_DirectionTime.xyz*mix(u_DragConstant.x,u_DragConstant.y,a_Random0.x);vec3 center=computeParticlePosition(startVelocity,lifeVelocity,age,normalizedAge,gravityVelocity,worldRotation,dragData);
#include <sphere_billboard>
#include <stretched_billboard>
#include <horizontal_billboard>
#include <vertical_billboard>
#include <particle_mesh>
gl_Position=camera_ProjMat*camera_ViewMat*vec4(center,1.0);v_Color=computeParticleColor(a_StartColor,normalizedAge);
#ifdef MATERIAL_HAS_BASETEXTURE
vec2 simulateUV;
#if defined(RENDERER_MODE_SPHERE_BILLBOARD) || defined(RENDERER_MODE_STRETCHED_BILLBOARD) || defined(RENDERER_MODE_HORIZONTAL_BILLBOARD) || defined(RENDERER_MODE_VERTICAL_BILLBOARD)
simulateUV=a_CornerTextureCoordinate.zw*a_SimulationUV.xy+a_SimulationUV.zw;v_TextureCoordinate=computeParticleUV(simulateUV,normalizedAge);
#endif
#ifdef RENDERER_MODE_MESH
simulateUV=a_SimulationUV.xy+a_MeshTextureCoordinate*a_SimulationUV.zw;v_TextureCoordinate=computeParticleUV(simulateUV,normalizedAge);
#endif
#endif
}else{gl_Position=vec4(2.0,2.0,2.0,1.0);}}`,vd=`#define GLSLIFY 1
#include <common>
#include <camera_declare>
#include <FogFragmentDeclaration>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <pbr_frag_define>
#include <pbr_helper>
void main(){
#include <pbr_frag>
#include <FogFragment>
#ifndef ENGINE_IS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
}`,pd=`#define GLSLIFY 1
#define IS_METALLIC_WORKFLOW
#include <common>
#include <camera_declare>
#include <FogFragmentDeclaration>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <pbr_frag_define>
#include <pbr_helper>
void main(){
#include <pbr_frag>
#include <FogFragment>
#ifndef ENGINE_IS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
}`,ws=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <color_share>
#include <normal_share>
#include <worldpos_share>
#include <ShadowVertexDeclaration>
#include <FogVertexDeclaration>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <color_vert>
#include <normal_vert>
#include <worldpos_vert>
#include <position_vert>
#include <ShadowVertex>
#include <FogVertex>
}`,gd=`#define GLSLIFY 1
#ifdef ENGINE_NO_DEPTH_TEXTURE
vec4 pack(float depth){const vec4 bitShift=vec4(1.0,256.0,256.0*256.0,256.0*256.0*256.0);const vec4 bitMask=vec4(1.0/256.0,1.0/256.0,1.0/256.0,0.0);vec4 rgbaDepth=fract(depth*bitShift);rgbaDepth-=rgbaDepth.gbaa*bitMask;return rgbaDepth;}
#endif
void main(){
#ifdef ENGINE_NO_DEPTH_TEXTURE
gl_FragColor=pack(gl_FragCoord.z);
#else
gl_FragColor=vec4(0.0,0.0,0.0,0.0);
#endif
}`,md=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <normal_share>
uniform mat4 camera_VPMat;uniform vec2 scene_ShadowBias;uniform vec3 scene_LightDirection;vec3 applyShadowBias(vec3 positionWS){positionWS-=scene_LightDirection*scene_ShadowBias.x;return positionWS;}vec3 applyShadowNormalBias(vec3 positionWS,vec3 normalWS){float invNdotL=1.0-clamp(dot(-scene_LightDirection,normalWS),0.0,1.0);float scale=invNdotL*scene_ShadowBias.y;positionWS+=normalWS*vec3(scale);return positionWS;}void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
vec4 positionWS=renderer_ModelMat*position;positionWS.xyz=applyShadowBias(positionWS.xyz);
#ifndef MATERIAL_OMIT_NORMAL
#ifdef RENDERER_HAS_NORMAL
vec3 normalWS=normalize(mat3(renderer_NormalMat)*normal);positionWS.xyz=applyShadowNormalBias(positionWS.xyz,normalWS);
#endif
#endif
vec4 positionCS=camera_VPMat*positionWS;positionCS.z=max(positionCS.z,-1.0);gl_Position=positionCS;}`,yd=`#define GLSLIFY 1
#include <common>
uniform samplerCube material_CubeTexture;varying vec3 v_cubeUV;uniform float material_Exposure;uniform vec4 material_TintColor;void main(){vec4 textureColor=textureCube(material_CubeTexture,v_cubeUV);
#ifdef MATERIAL_IS_DECODE_SKY_RGBM
textureColor=RGBMToLinear(textureColor,5.0);
#elif !defined(ENGINE_IS_COLORSPACE_GAMMA)
textureColor=gammaToLinear(textureColor);
#endif
textureColor.rgb*=material_Exposure*material_TintColor.rgb;gl_FragColor=textureColor;
#if defined(MATERIAL_IS_DECODE_SKY_RGBM) || !defined(ENGINE_IS_COLORSPACE_GAMMA)
gl_FragColor=linearToGamma(gl_FragColor);
#endif
}`,xd=`#define GLSLIFY 1
#include <common_vert>
uniform mat4 camera_VPMat;varying vec3 v_cubeUV;uniform float material_Rotation;vec4 rotateY(vec4 v,float angle){const float deg2rad=3.1415926/180.0;float radian=angle*deg2rad;float sina=sin(radian);float cosa=cos(radian);mat2 m=mat2(cosa,-sina,sina,cosa);return vec4(m*v.xz,v.yw).xzyw;}void main(){v_cubeUV=vec3(-POSITION.x,POSITION.yz);gl_Position=camera_VPMat*rotateY(vec4(POSITION,1.0),material_Rotation);}`,bd=`#define GLSLIFY 1
uniform sampler2D renderer_MaskTexture;uniform float renderer_MaskAlphaCutoff;varying vec2 v_uv;void main(){vec4 color=texture2D(renderer_MaskTexture,v_uv);if(color.a<renderer_MaskAlphaCutoff){discard;}gl_FragColor=color;}`,Cd=`#define GLSLIFY 1
uniform mat4 camera_VPMat;attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=camera_VPMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`,Sd=`#define GLSLIFY 1
uniform sampler2D renderer_SpriteTexture;varying vec2 v_uv;varying vec4 v_color;void main(){vec4 baseColor=texture2D(renderer_SpriteTexture,v_uv);gl_FragColor=baseColor*v_color;}`,Ad=`#define GLSLIFY 1
uniform mat4 renderer_MVPMat;attribute vec3 POSITION;attribute vec2 TEXCOORD_0;attribute vec4 COLOR_0;varying vec2 v_uv;varying vec4 v_color;void main(){gl_Position=renderer_MVPMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;v_color=COLOR_0;}`,wd=`#define GLSLIFY 1
#include <common>
#include <uv_share>
#include <FogFragmentDeclaration>
uniform vec4 material_BaseColor;uniform float material_AlphaCutoff;
#ifdef MATERIAL_HAS_BASETEXTURE
uniform sampler2D material_BaseTexture;
#endif
void main(){vec4 baseColor=material_BaseColor;
#ifdef MATERIAL_HAS_BASETEXTURE
vec4 textureColor=texture2D(material_BaseTexture,v_uv);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
textureColor=gammaToLinear(textureColor);
#endif
baseColor*=textureColor;
#endif
#ifdef MATERIAL_IS_ALPHA_CUTOFF
if(baseColor.a<material_AlphaCutoff){discard;}
#endif
gl_FragColor=baseColor;
#ifndef MATERIAL_IS_TRANSPARENT
gl_FragColor.a=1.0;
#endif
#include <FogFragment>
#ifndef ENGINE_IS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
}`,Ed=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <FogVertexDeclaration>
void main(){
#include <begin_position_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <position_vert>
#include <FogVertex>
}`,Td=function(){function n(){}return n.init=function(){var i=new gt("ShadowCaster",md,gd,{pipelineStage:jt.ShadowCaster}),t=new gt("DepthOnly",dd,ud,{pipelineStage:jt.DepthOnly}),e=[i,t],r={pipelineStage:jt.Forward};ne.create("blinn-phong",[].concat(new gt("Forward",_d,cd,r),e)),ne.create("pbr",[].concat(new gt("Forward",ws,pd,r),e)),ne.create("pbr-specular",[].concat(new gt("Forward",ws,vd,r),e)),ne.create("unlit",[].concat(new gt("Forward",Ed,wd,r),e)),ne.create("blit",[new gt("Forward",ad,nd,r)]),ne.create("skybox",[new gt("Forward",xd,yd,r)]),ne.create("SkyProcedural",[new gt("Forward",od,id,r)]),ne.create("particle-shader",[new gt("Forward",fd,hd,r)]),ne.create("SpriteMask",[new gt("Forward",Cd,bd,r)]),ne.create("Sprite",[new gt("Forward",Ad,Sd,r)]),ne.create("background-texture",[new gt("Forward",ld,sd,r)])},n}(),Rd=function(){function n(){this._cacheHierarchyDepth=1,this._cacheMap=Object.create(null)}var s=n.prototype;return s.get=function(t){var e=this._cacheMap,r=t._length,a=this._cacheHierarchyDepth;r>a&&(this._resizeCacheMapHierarchy(e,0,a,r-a),this._cacheHierarchyDepth=r);for(var o=t._mask,l=t._length-1,c=this._cacheHierarchyDepth-1,_=0;_<c;_++){var u=l<_?0:o[_],d=e[u];d||(e[u]=d=Object.create(null)),e=d}var h=l<c?0:o[c],f=e[h];return f||(this._lastQueryKey=h,this._lastQueryMap=e),f},s.cache=function(t){this._lastQueryMap[this._lastQueryKey]=t},s._destroy=function(){this._recursiveDestroy(0,this._cacheMap),this._cacheMap=Object.create(null)},s._recursiveDestroy=function(t,e){if(t===this._cacheHierarchyDepth-1){for(var r in e)e[r].destroy();return}++t;for(var a in e)this._recursiveDestroy(t,e[a])},s._resizeCacheMapHierarchy=function(t,e,r,a){if(e==r-1)for(var o in t){for(var l=t[o],c=t,_=0;_<a;_++)c[_==0?o:0]=c=Object.create(null);c[0]=l}else{e++;for(var u in t)this._resizeCacheMapHierarchy(t[u],e,r,a)}},n}(),Sc=function(){function n(){}var s=n.prototype;return s._initialize=function(t,e){},s._update=function(){},s._destroy=function(){},s._getRequestAnimationFrame=function(){return null},s._getCancelAnimationFrame=function(){return null},s._getCameraClearFlagsMask=function(t){return Lt.None},n}();Td.init();var yn=function(n){W(s,n);function s(t,e,r){var a;a=n.call(this)||this,a._physicsInitialized=!1,a._physicalObjectsMap={},a._lastRenderState=new en,a._renderElementPool=new Wn(Nu),a._renderDataPool=new Wn($i),a._spriteRenderDataPool=new Wn(zu),a._spriteMaskRenderDataPool=new Wn(Ou),a._textRenderDataPool=new Wn(Uu),a._spriteDefaultMaterials=[],a._renderContext=new rr,a._renderCount=0,a._shaderProgramPools=[],a._canSpriteBatch=!0,a._fontMap={},a._macroCollection=new ar,a._settings={},a._resourceManager=new ga(ue(a)),a._sceneManager=new mc(ue(a)),a._vSyncCount=1,a._targetFrameRate=60,a._time=new Yi,a._isPaused=!0,a._vSyncCounter=1,a._targetFrameInterval=1e3/60,a._destroyed=!1,a._frameInProcess=!1,a._waitingDestroy=!1,a._isDeviceLost=!1,a._waitingGC=!1,a._animate=function(){if(a._vSyncCount){var v,p=((v=a.xrManager)==null?void 0:v._getRequestAnimationFrame())||requestAnimationFrame;a._requestId=p(a._animate),a._vSyncCounter++%a._vSyncCount===0&&(a.update(),a._vSyncCounter=1)}else a._timeoutId=window.setTimeout(a._animate,a._targetFrameInterval),a.update()},a._hardwareRenderer=e,a._hardwareRenderer.init(t,a._onDeviceLost.bind(ue(a)),a._onDeviceRestored.bind(ue(a))),a._canvas=t,a._spriteMaskManager=new Fu(ue(a));var o=ue(a),l=o._spriteDefaultMaterials;a._spriteDefaultMaterial=l[ht.None]=a._createSpriteMaterial(ht.None),l[ht.VisibleInsideMask]=a._createSpriteMaterial(ht.VisibleInsideMask),l[ht.VisibleOutsideMask]=a._createSpriteMaterial(ht.VisibleOutsideMask),a._spriteMaskDefaultMaterial=a._createSpriteMaskMaterial(),a._textDefaultFont=pa.createFromOS(ue(a),"Arial"),a._textDefaultFont.isGCIgnored=!0,a.inputManager=new Cc(ue(a),r.input);var c=r.xrDevice;if(c&&(a.xrManager=new Sc,a.xrManager._initialize(ue(a),c)),a._initMagentaTextures(e),!e.canIUse(Q.depthTexture))a._macroCollection.enable(s._noDepthTextureMacro);else{var _=new bt(ue(a),1,1,G.Depth16,!1);_.isGCIgnored=!0,a._depthTexture2D=_}var u=new Mr(ue(a),ne.find("unlit"));u.isGCIgnored=!0,u.shaderData.setColor("material_BaseColor",new j(1,0,1.01,1)),a._meshMagentaMaterial=u;var d=new Mr(ue(a),ne.find("particle-shader"));d.isGCIgnored=!0,d.shaderData.setColor("material_BaseColor",new j(1,0,1.01,1)),a._particleMagentaMaterial=d;var h=a._settings,f=r.colorSpace||dr.Linear;return f===dr.Gamma&&a._macroCollection.enable(s._gammaMacro),h.colorSpace=f,a._basicResources=new Lu(ue(a)),a._particleBufferUtils=new rd(ue(a)),a}var i=s.prototype;return i.createEntity=function(e){return new Qr(this,e)},i.pause=function(){var e;this._isPaused=!0;var r=((e=this.xrManager)==null?void 0:e._getCancelAnimationFrame())||cancelAnimationFrame;r(this._requestId),clearTimeout(this._timeoutId)},i.resume=function(){if(!!this._isPaused)if(this._isPaused=!1,this.time._reset(),this._vSyncCount){var e,r=((e=this.xrManager)==null?void 0:e._getRequestAnimationFrame())||requestAnimationFrame;this._requestId=r(this._animate)}else this._timeoutId=window.setTimeout(this._animate,this._targetFrameInterval)},i.update=function(){var e,r=this._time;r._update();var a=r.deltaTime;this._frameInProcess=!0,this._renderElementPool.resetPool(),this._renderDataPool.resetPool(),this._spriteRenderDataPool.resetPool(),this._spriteMaskRenderDataPool.resetPool(),this._textRenderDataPool.resetPool(),(e=this.xrManager)==null||e._update();var o=this,l=o.inputManager,c=o._physicsInitialized;l._update();for(var _=this._sceneManager._scenes.getLoopArray(),u=_.length,d=0;d<u;d++){var h=_[d];if(!(!h.isActive||h.destroyed)){var f=h._componentsManager;f.sortCameras(),f.callScriptOnStart()}}if(c)for(var v=0;v<u;v++){var p=_[v];!p.isActive||p.destroyed||p.physics._update(a)}c&&l._firePointerScript(_);for(var g=0;g<u;g++){var y=_[g];!y.isActive||y.destroyed||y._componentsManager.callScriptOnUpdate(a)}for(var m=0;m<u;m++){var x=_[m];!x.isActive||x.destroyed||x._componentsManager.callAnimationUpdate(a)}for(var S=0;S<u;S++){var b=_[S];!b.isActive||b.destroyed||b._componentsManager.callScriptOnLateUpdate(a)}if(this._isDeviceLost||this._render(_),this._waitingDestroy)this._destroy();else for(var A=0;A<u;A++){var C=_[A];!C.isActive||C.destroyed||C._componentsManager.handlingInvalidScripts()}this._waitingGC&&(this._gc(),this._waitingGC=!1),this._frameInProcess=!1},i.run=function(){this.resume(),this.dispatch("run",this)},i.forceLoseDevice=function(){this._hardwareRenderer.forceLoseDevice()},i.forceRestoreDevice=function(){this._hardwareRenderer.forceRestoreDevice()},i._destroy=function(){var e;this._sceneManager._destroyAllScene(),this._resourceManager._destroy(),this._textDefaultFont=null,this._fontMap=null,this.inputManager._destroy(),(e=this.xrManager)==null||e._destroy(),this.dispatch("shutdown",this),this.pause(),this._spriteMaskManager.destroy(),this._hardwareRenderer.destroy(),this.removeAllEventListeners(),this._animate=null,this._sceneManager=null,this._resourceManager=null,this._canvas=null,this._time=null,this._waitingDestroy=!1,this._destroyed=!0},i.destroy=function(){this._destroyed||(this._frameInProcess?this._waitingDestroy=!0:this._destroy())},i._getShaderProgramPool=function(e){var r=e._shaderPassId,a=this._shaderProgramPools,o=a[r];if(!o){var l=r+1;l>a.length&&(a.length=l),a[r]=o=new Rd,e._shaderProgramPools.push(o)}return o},i._render=function(e){for(var r=function(h,f){var v=e[h];if(!v.isActive||v.destroyed)return"continue";var p=v._componentsManager._activeCameras;if(p.length===0)return ve.debug("No active camera in scene."),"continue";p.forEach(function(g){var y=v._componentsManager;y.callCameraOnBeginRender(g),g.render(),y.callCameraOnEndRender(g),a._hardwareRenderer._options._forceFlush&&a._hardwareRenderer.flush()},function(g,y){g._cameraIndex=y})},a=this,o=this.time.deltaTime,l=0,c=e.length;l<c;l++){var _=e[l];!_.isActive||_.destroyed||(_._componentsManager.callRendererOnUpdate(o),_._updateShaderData())}for(var u=0,d=e.length;u<d;u++)r(u)},i._initMagentaTextures=function(e){var r=new Uint8Array([255,255,255,255]),a=new bt(this,1,1,G.R8G8B8A8,!1);a.setPixelBuffer(r),a.isGCIgnored=!0;var o=new Uint8Array([255,0,255,255]),l=new bt(this,1,1,G.R8G8B8A8,!1);l.setPixelBuffer(o),l.isGCIgnored=!0,this.resourceManager.addContentRestorer(new(function(f){W(v,f);function v(){return f.call(this,l)}var p=v.prototype;return p.restoreContent=function(){this.resource.setPixelBuffer(o)},v}(Rr)));for(var c=new tr(this,1,G.R8G8B8A8,!1),_=0;_<6;_++)c.setPixelBuffer(Dr.PositiveX+_,o);if(c.isGCIgnored=!0,this.resourceManager.addContentRestorer(new(function(f){W(v,f);function v(){return f.call(this,c)}var p=v.prototype;return p.restoreContent=function(){for(var y=0;y<6;y++)this.resource.setPixelBuffer(Dr.PositiveX+y,o)},v}(Rr))),this._whiteTexture2D=a,this._magentaTexture2D=l,this._magentaTextureCube=c,e.isWebGL2){var u=new Uint32Array([255,0,255,255]),d=new bt(this,1,1,G.R32G32B32A32_UInt,!1);d.setPixelBuffer(u),d.isGCIgnored=!0,this.resourceManager.addContentRestorer(new(function(f){W(v,f);function v(){return f.call(this,d)}var p=v.prototype;return p.restoreContent=function(){this.resource.setPixelBuffer(u)},v}(Rr)));var h=new Xo(this,1,1,1,G.R8G8B8A8,!1);h.setPixelBuffer(0,o),h.isGCIgnored=!0,this.resourceManager.addContentRestorer(new(function(f){W(v,f);function v(){return f.call(this,h)}var p=v.prototype;return p.restoreContent=function(){this.resource.setPixelBuffer(0,o)},v}(Rr))),this._uintMagentaTexture2D=d,this._magentaTexture2DArray=h}},i._pendingGC=function(){this._frameInProcess?this._waitingGC=!0:this._gc()},i._initialize=function(e){var r=this,a=e.shaderLab,o=e.physics;a&&(ne._shaderLab=a);var l=new Array;o&&l.push(o.initialize().then(function(){return Qt._nativePhysics=o,r._nativePhysicsManager=o.createPhysicsManager(),r._physicsInitialized=!0,r}));var c=ga._loaders;for(var _ in c){var u=c[_];u.initialize&&l.push(u.initialize(this,e))}return Promise.all(l).then(function(){return r})},i._createSpriteMaterial=function(e){var r=new Mr(this,ne.find("Sprite")),a=r.renderState,o=a.blendState.targetBlendState;if(o.enabled=!0,o.sourceColorBlendFactor=Ae.SourceAlpha,o.destinationColorBlendFactor=Ae.OneMinusSourceAlpha,o.sourceAlphaBlendFactor=Ae.One,o.destinationAlphaBlendFactor=Ae.OneMinusSourceAlpha,o.colorBlendOperation=o.alphaBlendOperation=Wt.Add,e!==ht.None){var l=a.stencilState;l.enabled=!0,l.writeMask=0,l.referenceValue=1;var c=e===ht.VisibleInsideMask?Te.LessEqual:Te.Greater;l.compareFunctionFront=c,l.compareFunctionBack=c}return a.depthState.writeEnabled=!1,a.rasterState.cullMode=Xt.Off,a.renderQueueType=mt.Transparent,r.isGCIgnored=!0,r},i._createSpriteMaskMaterial=function(){var e=new Mr(this,ne.find("SpriteMask")),r=e.renderState;return r.blendState.targetBlendState.colorWriteMask=Er.None,r.rasterState.cullMode=Xt.Off,r.stencilState.enabled=!0,r.depthState.enabled=!1,e.isGCIgnored=!0,e},i._onDeviceLost=function(){this._isDeviceLost=!0,this.resourceManager._lostGraphicResources(),console.log("Device lost."),this.dispatch("devicelost",this)},i._onDeviceRestored=function(){var e=this;this._hardwareRenderer.resetState(),this._lastRenderState=new en,this._shaderProgramPools.length=0;var r=this.resourceManager;r._restoreGraphicResources(),console.log("Graphic resource restored."),r._restoreResourcesContent().then(function(){console.log(`Graphic resource content restored.

Device restored.`),e.dispatch("devicerestored",e),e._isDeviceLost=!1}).catch(function(a){console.error(a)})},i._gc=function(){this._renderElementPool.garbageCollection(),this._renderDataPool.garbageCollection(),this._spriteRenderDataPool.garbageCollection(),this._spriteMaskRenderDataPool.garbageCollection(),this._textRenderDataPool.garbageCollection(),this._renderContext.garbageCollection()},q(s,[{key:"settings",get:function(){return this._settings}},{key:"canvas",get:function(){return this._canvas}},{key:"resourceManager",get:function(){return this._resourceManager}},{key:"sceneManager",get:function(){return this._sceneManager}},{key:"time",get:function(){return this._time}},{key:"isPaused",get:function(){return this._isPaused}},{key:"vSyncCount",get:function(){return this._vSyncCount},set:function(e){this._vSyncCount=Math.max(0,Math.floor(e))}},{key:"targetFrameRate",get:function(){return this._targetFrameRate},set:function(e){e=Math.max(1e-6,e),this._targetFrameRate=e,this._targetFrameInterval=1e3/e}},{key:"destroyed",get:function(){return this._destroyed}},{key:"physicsManager",get:function(){var e;return(e=this.sceneManager.scenes[0])==null?void 0:e.physics}}]),s}(Uo);(function(){yn._gammaMacro=ie.getByName("ENGINE_IS_COLORSPACE_GAMMA")})();(function(){yn._noDepthTextureMacro=ie.getByName("ENGINE_NO_DEPTH_TEXTURE")})();(function(){yn._pixelsPerUnit=100})();var Ac=function(){function n(){this._sizeUpdateFlagManager=new zr}return q(n,[{key:"width",get:function(){return this._width},set:function(i){this._width!==i&&(this._width=i,this._onWidthChanged(i),this._sizeUpdateFlagManager.dispatch())}},{key:"height",get:function(){return this._height},set:function(i){this._height!==i&&(this._height=i,this._onHeightChange(i),this._sizeUpdateFlagManager.dispatch())}}]),n}(),$r;(function(n){n[n.SolidColor=0]="SolidColor",n[n.Sky=1]="Sky",n[n.Texture=2]="Texture"})($r||($r={}));var Dn;(function(n){n[n.AspectFitWidth=0]="AspectFitWidth",n[n.AspectFitHeight=1]="AspectFitHeight",n[n.Fill=2]="Fill"})(Dn||(Dn={}));var ma=function(){function n(){}var s=n.prototype;return s.destroy=function(){this.mesh=null,this.material=null},s._render=function(t){var e=this,r=e.material,a=e.mesh;if(!r){ve.warn("The material of sky is not defined.");return}if(r.destroyed){ve.warn("The material of sky is destroyed.");return}if(!a){ve.warn("The mesh of sky is not defined.");return}if(a.destroyed){ve.warn("The mesh of sky is destroyed.");return}var o=t.camera,l=o.engine,c=o.scene,_=o.aspectRatio,u=o.fieldOfView,d=o.viewMatrix,h=o.shaderData,f=c.shaderData,v=n._viewProjMatrix,p=n._projectionMatrix,g=l._hardwareRenderer,y=r.shaderData,m=r.shader,x=r.renderState;v.copyFrom(d);var S=v.elements;S[12]=S[13]=S[14]=0;var b=1/Math.tan(k.degreeToRadian(u)/2);p.elements[0]=b/_,p.elements[5]=b,J.multiply(p,v,v);var A=h.getMatrix(rr.vpMatrixProperty);t.flipProjection&&J.multiply(rr._flipYMatrix,v,v),h.setMatrix(rr.vpMatrixProperty,v);var C=ne._compileMacros;ar.unionCollection(t.camera._globalShaderMacro,y._macroCollection,C);var E=m.subShaders[0].passes[0],T=E._getShaderProgram(l,C);T.bind(),T.groupingOtherUniformBlock(),T.uploadAll(T.sceneUniformBlock,f),T.uploadAll(T.cameraUniformBlock,h),T.uploadAll(T.materialUniformBlock,y),T.uploadUnGroupTextures(),x._apply(l,!1,E._renderStateDataMap,y),g.drawPrimitive(a._primitive,a.subMesh,T),h.setMatrix(rr.vpMatrixProperty,A)},q(n,[{key:"material",get:function(){return this._material},set:function(t){if(this._material!==t){var e,r;(e=t)==null||e._addReferCount(1),(r=this._material)==null||r._addReferCount(-1),this._material=t}}},{key:"mesh",get:function(){return this._mesh},set:function(t){if(this._mesh!==t){var e,r;(e=t)==null||e._addReferCount(1),(r=this._mesh)==null||r._addReferCount(-1),this._mesh=t}}}]),n}();(function(){ma._epsilon=1e-6})();(function(){ma._viewProjMatrix=new J})();(function(){ma._projectionMatrix=new J(1,0,0,0,0,1,0,0,0,0,ma._epsilon-1,-1,0,0,0,0)})();var wc=function(){function n(i){this._engine=i,this.mode=$r.SolidColor,this.solidColor=new j(.25,.25,.25,1),this.sky=new ma,this._textureFillMode=Dn.AspectFitHeight,this._texture=null,this._initMesh(i),this._initMaterial(i)}var s=n.prototype;return s.destroy=function(){this.texture=null,this._mesh._addReferCount(-1),this._mesh=null,this._material._addReferCount(-1),this._material=null,this.solidColor=null,this.sky.destroy()},s._resizeBackgroundTexture=function(){var t=this,e=t._texture,r=t._mesh;if(!!this._texture){var a=this._engine.canvas,o=a.width,l=a.height,c=r.getPositions();switch(this._textureFillMode){case Dn.Fill:c[0].set(-1,-1,1),c[1].set(1,-1,1),c[2].set(-1,1,1),c[3].set(1,1,1);break;case Dn.AspectFitWidth:var _=e.height*o/e.width/l;c[0].set(-1,-_,1),c[1].set(1,-_,1),c[2].set(-1,_,1),c[3].set(1,_,1);break;case Dn.AspectFitHeight:var u=e.width*l/e.height/o;c[0].set(-u,-1,1),c[1].set(u,-1,1),c[2].set(-u,1,1),c[3].set(u,1,1);break}r.setPositions(c),r.uploadData(!1)}},s._initMesh=function(t){this._mesh=this._createPlane(t),this._mesh._addReferCount(1)},s._initMaterial=function(t){var e=this._material=new Mr(t,ne.find("background-texture"));e.renderState.depthState.compareFunction=Te.LessEqual,e._addReferCount(1)},s._createPlane=function(t){for(var e=new ct(t),r=new Uint8Array([1,2,0,1,3,2]),a=new Array(4),o=new Array(4),l=0;l<4;++l)a[l]=new w,o[l]=new $(l%2,1-(l*.5|0));return e.setPositions(a),e.setUVs(o),e.setIndices(r),e.uploadData(!1),e.addSubMesh(0,r.length),e},q(n,[{key:"texture",get:function(){return this._texture},set:function(t){if(this._texture!==t){var e,r;(e=t)==null||e._addReferCount(1),(r=this._texture)==null||r._addReferCount(-1),this._texture=t,this._material.shaderData.setTexture("material_BaseTexture",t),this._resizeBackgroundTexture()}}},{key:"textureFillMode",get:function(){return this._textureFillMode},set:function(t){t!==this._textureFillMode&&(this._textureFillMode=t,this._resizeBackgroundTexture())}}]),n}(),Md=function(){function n(){this._cameraNeedSorting=!1,this._activeCameras=new Ye,this._renderers=new Ye,this._onStartScripts=new Ye,this._onUpdateScripts=new Ye,this._onLateUpdateScripts=new Ye,this._onPhysicsUpdateScripts=new Ye,this._pendingDestroyScripts=[],this._disposeDestroyScripts=[],this._onUpdateAnimations=new Ye,this._onUpdateRenderers=new Ye,this._componentsContainerPool=[]}var s=n.prototype;return s.addCamera=function(t){t._cameraIndex=this._activeCameras.length,this._activeCameras.add(t),this._cameraNeedSorting=!0},s.removeCamera=function(t){var e=this._activeCameras.deleteByIndex(t._cameraIndex);e&&(e._cameraIndex=t._cameraIndex),t._cameraIndex=-1,this._cameraNeedSorting=!0},s.sortCameras=function(){if(this._cameraNeedSorting){var t=this._activeCameras;t.sort(function(a,o){return a.priority-o.priority});for(var e=0,r=t.length;e<r;e++)t.get(e)._cameraIndex=e;this._cameraNeedSorting=!1}},s.addRenderer=function(t){t._rendererIndex=this._renderers.length,this._renderers.add(t)},s.removeRenderer=function(t){var e=this._renderers.deleteByIndex(t._rendererIndex);e&&(e._rendererIndex=t._rendererIndex),t._rendererIndex=-1},s.addOnStartScript=function(t){t._onStartIndex=this._onStartScripts.length,this._onStartScripts.add(t)},s.removeOnStartScript=function(t){var e=this._onStartScripts.deleteByIndex(t._onStartIndex);e&&(e._onStartIndex=t._onStartIndex),t._onStartIndex=-1},s.addOnUpdateScript=function(t){t._onUpdateIndex=this._onUpdateScripts.length,this._onUpdateScripts.add(t)},s.removeOnUpdateScript=function(t){var e=this._onUpdateScripts.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},s.addOnLateUpdateScript=function(t){t._onLateUpdateIndex=this._onLateUpdateScripts.length,this._onLateUpdateScripts.add(t)},s.removeOnLateUpdateScript=function(t){var e=this._onLateUpdateScripts.deleteByIndex(t._onLateUpdateIndex);e&&(e._onLateUpdateIndex=t._onLateUpdateIndex),t._onLateUpdateIndex=-1},s.addOnPhysicsUpdateScript=function(t){t._onPhysicsUpdateIndex=this._onPhysicsUpdateScripts.length,this._onPhysicsUpdateScripts.add(t)},s.removeOnPhysicsUpdateScript=function(t){var e=this._onPhysicsUpdateScripts.deleteByIndex(t._onPhysicsUpdateIndex);e&&(e._onPhysicsUpdateIndex=t._onPhysicsUpdateIndex),t._onPhysicsUpdateIndex=-1},s.addOnUpdateAnimations=function(t){t._onUpdateIndex=this._onUpdateAnimations.length,this._onUpdateAnimations.add(t)},s.removeOnUpdateAnimations=function(t){var e=this._onUpdateAnimations.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},s.addOnUpdateRenderers=function(t){t._onUpdateIndex=this._onUpdateRenderers.length,this._onUpdateRenderers.add(t)},s.removeOnUpdateRenderers=function(t){var e=this._onUpdateRenderers.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},s.addPendingDestroyScript=function(t){this._pendingDestroyScripts.push(t)},s.callScriptOnStart=function(){var t=this,e=this._onStartScripts;e.length>0&&e.forEachAndClean(function(r){r._started=!0,t.removeOnStartScript(r),r.onStart()})},s.callScriptOnUpdate=function(t){this._onUpdateScripts.forEach(function(e){e._started&&e.onUpdate(t)},function(e,r){e._onUpdateIndex=r})},s.callScriptOnLateUpdate=function(t){this._onLateUpdateScripts.forEach(function(e){e._started&&e.onLateUpdate(t)},function(e,r){e._onLateUpdateIndex=r})},s.callScriptOnPhysicsUpdate=function(){this._onPhysicsUpdateScripts.forEach(function(t){t._started&&t.onPhysicsUpdate()},function(t,e){t._onPhysicsUpdateIndex=e})},s.callAnimationUpdate=function(t){this._onUpdateAnimations.forEach(function(e){e.engine.time.frameCount>e._playFrameCount&&e.update(t)},function(e,r){e._onUpdateIndex=r})},s.callRendererOnUpdate=function(t){this._onUpdateRenderers.forEach(function(e){e.update(t)},function(e,r){e._onUpdateIndex=r})},s.handlingInvalidScripts=function(){var t=this,e=t._disposeDestroyScripts,r=t._pendingDestroyScripts;this._disposeDestroyScripts=r,this._pendingDestroyScripts=e;var a=r.length;if(a>0){for(var o=a-1;o>=0;o--)r[o].onDestroy();r.length=0}},s.callCameraOnBeginRender=function(t){t.entity._scripts.forEach(function(e){e.onBeginRender(t)},function(e,r){e._entityScriptsIndex=r})},s.callCameraOnEndRender=function(t){t.entity._scripts.forEach(function(e){e.onEndRender(t)},function(e,r){e._entityScriptsIndex=r})},s.getActiveChangedTempList=function(){return this._componentsContainerPool.length?this._componentsContainerPool.pop():[]},s.putActiveChangedTempList=function(t){t.length=0,this._componentsContainerPool.push(t)},s._gc=function(){this._renderers.garbageCollection(),this._onStartScripts.garbageCollection(),this._onUpdateScripts.garbageCollection(),this._onLateUpdateScripts.garbageCollection(),this._onPhysicsUpdateScripts.garbageCollection(),this._onUpdateAnimations.garbageCollection(),this._onUpdateRenderers.garbageCollection(),this._activeCameras.garbageCollection()},n}(),Bi;(function(n){n[n.None=0]="None",n[n.Linear=1]="Linear",n[n.Exponential=2]="Exponential",n[n.ExponentialSquared=3]="ExponentialSquared"})(Bi||(Bi={}));var ta;(function(n){n[n.SolidColor=0]="SolidColor",n[n.SphericalHarmonics=1]="SphericalHarmonics"})(ta||(ta={}));var Lr=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._diffuseSolidColor=new j(.212,.227,.259),e._diffuseIntensity=1,e._specularIntensity=1,e._diffuseMode=ta.SolidColor,e._shArray=new Float32Array(27),e._scenes=[],e._specularTextureDecodeRGBM=!1,e}var i=s.prototype;return i._addToScene=function(e){this._addReferCount(1),this._scenes.push(e);var r=e.shaderData;r.setColor(s._diffuseColorProperty,this._diffuseSolidColor),r.setFloat(s._diffuseIntensityProperty,this._diffuseIntensity),r.setFloat(s._specularIntensityProperty,this._specularIntensity),r.setFloatArray(s._diffuseSHProperty,this._shArray),this._setDiffuseMode(r),this._setSpecularTextureDecodeRGBM(r),this._setSpecularTexture(r)},i._removeFromScene=function(e){this._addReferCount(-1);var r=this._scenes,a=r.indexOf(e);r.splice(a,1);var o=e.shaderData;o.setTexture(s._specularTextureProperty,null),o.disableMacro(s._specularMacro)},i._setDiffuseMode=function(e){this._diffuseMode===ta.SphericalHarmonics?e.enableMacro(s._shMacro):e.disableMacro(s._shMacro)},i._setSpecularTexture=function(e){this._specularTexture?(e.setTexture(s._specularTextureProperty,this._specularTexture),e.setFloat(s._mipLevelProperty,this._specularTexture.mipmapCount-1),e.enableMacro(s._specularMacro)):e.disableMacro(s._specularMacro)},i._setSpecularTextureDecodeRGBM=function(e){this._specularTextureDecodeRGBM?e.enableMacro(s._decodeRGBMMacro):e.disableMacro(s._decodeRGBMMacro)},i._preComputeSH=function(e,r){var a=e.coefficients;r[0]=a[0]*.886227,r[1]=a[1]*.886227,r[2]=a[2]*.886227,r[3]=a[3]*-1.023327,r[4]=a[4]*-1.023327,r[5]=a[5]*-1.023327,r[6]=a[6]*1.023327,r[7]=a[7]*1.023327,r[8]=a[8]*1.023327,r[9]=a[9]*-1.023327,r[10]=a[10]*-1.023327,r[11]=a[11]*-1.023327,r[12]=a[12]*.858086,r[13]=a[13]*.858086,r[14]=a[14]*.858086,r[15]=a[15]*-.858086,r[16]=a[16]*-.858086,r[17]=a[17]*-.858086,r[18]=a[18]*.247708,r[19]=a[19]*.247708,r[20]=a[20]*.247708,r[21]=a[21]*-.858086,r[22]=a[22]*-.858086,r[23]=a[23]*-.858086,r[24]=a[24]*.429042,r[25]=a[25]*.429042,r[26]=a[26]*.429042},q(s,[{key:"specularTextureDecodeRGBM",get:function(){return this._specularTextureDecodeRGBM},set:function(e){this._specularTextureDecodeRGBM=e;for(var r=this._scenes,a=0,o=r.length;a<o;a++)this._setSpecularTextureDecodeRGBM(r[a].shaderData)}},{key:"diffuseMode",get:function(){return this._diffuseMode},set:function(e){this._diffuseMode=e;for(var r=this._scenes,a=0,o=r.length;a<o;a++)this._setDiffuseMode(r[a].shaderData)}},{key:"diffuseSolidColor",get:function(){return this._diffuseSolidColor},set:function(e){e!==this._diffuseSolidColor&&this._diffuseSolidColor.copyFrom(e)}},{key:"diffuseSphericalHarmonics",get:function(){return this._diffuseSphericalHarmonics},set:function(e){if(this._diffuseSphericalHarmonics=e,e){this._preComputeSH(e,this._shArray);for(var r=this._scenes,a=0,o=r.length;a<o;a++)r[a].shaderData.setFloatArray(s._diffuseSHProperty,this._shArray)}}},{key:"diffuseIntensity",get:function(){return this._diffuseIntensity},set:function(e){this._diffuseIntensity=e;for(var r=this._scenes,a=0,o=r.length;a<o;a++)r[a].shaderData.setFloat(s._diffuseIntensityProperty,e)}},{key:"specularTexture",get:function(){return this._specularTexture},set:function(e){this._specularTexture=e;for(var r=this._scenes,a=0,o=r.length;a<o;a++)this._setSpecularTexture(r[a].shaderData)}},{key:"specularIntensity",get:function(){return this._specularIntensity},set:function(e){this._specularIntensity=e;for(var r=0,a=this._scenes.length;r<a;r++)this._scenes[r].shaderData.setFloat(s._specularIntensityProperty,e)}}]),s}(rn);(function(){Lr._shMacro=ie.getByName("SCENE_USE_SH")})();(function(){Lr._specularMacro=ie.getByName("SCENE_USE_SPECULAR_ENV")})();(function(){Lr._decodeRGBMMacro=ie.getByName("SCENE_IS_DECODE_ENV_RGBM")})();(function(){Lr._diffuseColorProperty=L.getByName("scene_EnvMapLight.diffuse")})();(function(){Lr._diffuseSHProperty=L.getByName("scene_EnvSH")})();(function(){Lr._diffuseIntensityProperty=L.getByName("scene_EnvMapLight.diffuseIntensity")})();(function(){Lr._specularTextureProperty=L.getByName("scene_EnvSpecularSampler")})();(function(){Lr._specularIntensityProperty=L.getByName("scene_EnvMapLight.specularIntensity")})();(function(){Lr._mipLevelProperty=L.getByName("scene_EnvMapLight.mipMapLevel")})();var Sr;(function(n){n[n.NoCascades=1]="NoCascades",n[n.TwoCascades=2]="TwoCascades",n[n.FourCascades=4]="FourCascades"})(Sr||(Sr={}));var Ln;(function(n){n[n.Low=0]="Low",n[n.Medium=1]="Medium",n[n.High=2]="High",n[n.VeryHigh=3]="VeryHigh"})(Ln||(Ln={}));var xn;(function(n){n[n.None=0]="None",n[n.Hard=1]="Hard",n[n.SoftLow=2]="SoftLow",n[n.SoftHigh=3]="SoftHigh"})(xn||(xn={}));var Za=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.intensity=1,t.cullingMask=mn.Everything,t.shadowType=xn.None,t.shadowBias=1,t.shadowNormalBias=1,t.shadowNearPlane=.1,t.shadowStrength=1,t._lightIndex=-1,t._lightColor=new j,t._color=new j(1,1,1,1),t}var i=s.prototype;return i._getLightIntensityColor=function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor},q(s,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.copyFrom(e)}},{key:"viewMatrix",get:function(){return this._viewMat||(this._viewMat=new J),J.invert(this.entity.transform.worldMatrix,this._viewMat),this._viewMat}},{key:"inverseViewMatrix",get:function(){return this._inverseViewMat||(this._inverseViewMat=new J),J.invert(this.viewMatrix,this._inverseViewMat),this._inverseViewMat}}]),s}(Vt);R([I],Za.prototype,"_lightIndex",void 0);var bn=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t._reverseDirection=new w,t}var i=s.prototype;return i._appendData=function(e,r){var a=e*2,o=e*3,l=e*3,c=this._getLightIntensityColor(),_=this.direction,u=this.cullingMask;r.cullingMask[a]=u&65535,r.cullingMask[a+1]=u>>>16&65535,this.engine.settings.colorSpace===dr.Linear?(r.color[o]=j.gammaToLinearSpace(c.r),r.color[o+1]=j.gammaToLinearSpace(c.g),r.color[o+2]=j.gammaToLinearSpace(c.b)):(r.color[o]=c.r,r.color[o+1]=c.g,r.color[o+2]=c.b),r.direction[l]=_.x,r.direction[l+1]=_.y,r.direction[l+2]=_.z},i._onEnableInScene=function(){this.scene._lightManager._attachDirectLight(this)},i._onDisableInScene=function(){this.scene._lightManager._detachDirectLight(this)},s._updateShaderData=function(e,r){e.setIntArray(s._cullingMaskProperty,r.cullingMask),e.setFloatArray(s._colorProperty,r.color),e.setFloatArray(s._directionProperty,r.direction)},q(s,[{key:"direction",get:function(){return this.entity.transform.worldForward}},{key:"reverseDirection",get:function(){return w.scale(this.direction,-1,this._reverseDirection),this._reverseDirection}},{key:"_shadowProjectionMatrix",get:function(){throw"Unknown!"}}]),s}(Za);(function(){bn._cullingMaskProperty=L.getByName("scene_DirectLightCullingMask")})();(function(){bn._colorProperty=L.getByName("scene_DirectLightColor")})();(function(){bn._directionProperty=L.getByName("scene_DirectLightDirection")})();var Cn=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.distance=100,t}var i=s.prototype;return i._appendData=function(e,r){var a=e*2,o=e*3,l=e*3,c=e,_=this._getLightIntensityColor(),u=this.position,d=this.cullingMask;r.cullingMask[a]=d&65535,r.cullingMask[a+1]=d>>>16&65535,this.engine.settings.colorSpace===dr.Linear?(r.color[o]=j.gammaToLinearSpace(_.r),r.color[o+1]=j.gammaToLinearSpace(_.g),r.color[o+2]=j.gammaToLinearSpace(_.b)):(r.color[o]=_.r,r.color[o+1]=_.g,r.color[o+2]=_.b),r.position[l]=u.x,r.position[l+1]=u.y,r.position[l+2]=u.z,r.distance[c]=this.distance},i._onEnableInScene=function(){this.scene._lightManager._attachPointLight(this)},i._onDisableInScene=function(){this.scene._lightManager._detachPointLight(this)},s._updateShaderData=function(e,r){e.setIntArray(s._cullingMaskProperty,r.cullingMask),e.setFloatArray(s._colorProperty,r.color),e.setFloatArray(s._positionProperty,r.position),e.setFloatArray(s._distanceProperty,r.distance)},q(s,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"_shadowProjectionMatrix",get:function(){throw"Unknown!"}}]),s}(Za);(function(){Cn._cullingMaskProperty=L.getByName("scene_PointLightCullingMask")})();(function(){Cn._colorProperty=L.getByName("scene_PointLightColor")})();(function(){Cn._positionProperty=L.getByName("scene_PointLightPosition")})();(function(){Cn._distanceProperty=L.getByName("scene_PointLightDistance")})();var vr=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.distance=100,t.angle=Math.PI/6,t.penumbra=Math.PI/12,t._inverseDirection=new w,t._projectMatrix=new J,t}var i=s.prototype;return i._appendData=function(e,r){var a=e*2,o=e*3,l=e*3,c=e*3,_=e,u=e,d=e,h=this._getLightIntensityColor(),f=this.position,v=this.direction,p=this.cullingMask;r.cullingMask[a]=p&65535,r.cullingMask[a+1]=p>>>16&65535,this.engine.settings.colorSpace===dr.Linear?(r.color[o]=j.gammaToLinearSpace(h.r),r.color[o+1]=j.gammaToLinearSpace(h.g),r.color[o+2]=j.gammaToLinearSpace(h.b)):(r.color[o]=h.r,r.color[o+1]=h.g,r.color[o+2]=h.b),r.position[l]=f.x,r.position[l+1]=f.y,r.position[l+2]=f.z,r.direction[c]=v.x,r.direction[c+1]=v.y,r.direction[c+2]=v.z,r.distance[_]=this.distance,r.angleCos[d]=Math.cos(this.angle),r.penumbraCos[u]=Math.cos(this.angle+this.penumbra)},i._onEnableInScene=function(){this.scene._lightManager._attachSpotLight(this)},i._onDisableInScene=function(){this.scene._lightManager._detachSpotLight(this)},s._updateShaderData=function(e,r){e.setIntArray(s._cullingMaskProperty,r.cullingMask),e.setFloatArray(s._colorProperty,r.color),e.setFloatArray(s._positionProperty,r.position),e.setFloatArray(s._directionProperty,r.direction),e.setFloatArray(s._distanceProperty,r.distance),e.setFloatArray(s._angleCosProperty,r.angleCos),e.setFloatArray(s._penumbraCosProperty,r.penumbraCos)},q(s,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"direction",get:function(){return this.entity.transform.worldForward}},{key:"reverseDirection",get:function(){return w.scale(this.direction,-1,this._inverseDirection),this._inverseDirection}},{key:"_shadowProjectionMatrix",get:function(){var e=this._projectMatrix,r=Math.min(Math.PI/2,this.angle*2*Math.sqrt(2));return J.perspective(r,1,this.shadowNearPlane,this.distance+this.shadowNearPlane,e),e}}]),s}(Za);(function(){vr._cullingMaskProperty=L.getByName("scene_SpotLightCullingMask")})();(function(){vr._colorProperty=L.getByName("scene_SpotLightColor")})();(function(){vr._positionProperty=L.getByName("scene_SpotLightPosition")})();(function(){vr._directionProperty=L.getByName("scene_SpotLightDirection")})();(function(){vr._distanceProperty=L.getByName("scene_SpotLightDistance")})();(function(){vr._angleCosProperty=L.getByName("scene_SpotLightAngleCos")})();(function(){vr._penumbraCosProperty=L.getByName("scene_SpotLightPenumbraCos")})();var Yn=function(){function n(){this._spotLights=new Ye,this._pointLights=new Ye,this._directLights=new Ye,this._directData={cullingMask:new Int32Array(n._maxLight*2),color:new Float32Array(n._maxLight*3),direction:new Float32Array(n._maxLight*3)},this._pointData={cullingMask:new Int32Array(n._maxLight*2),color:new Float32Array(n._maxLight*3),position:new Float32Array(n._maxLight*3),distance:new Float32Array(n._maxLight)},this._spotData={cullingMask:new Int32Array(n._maxLight*2),color:new Float32Array(n._maxLight*3),position:new Float32Array(n._maxLight*3),direction:new Float32Array(n._maxLight*3),distance:new Float32Array(n._maxLight),angleCos:new Float32Array(n._maxLight),penumbraCos:new Float32Array(n._maxLight)}}var s=n.prototype;return s._attachSpotLight=function(t){t._lightIndex=this._spotLights.length,this._spotLights.add(t)},s._detachSpotLight=function(t){var e=this._spotLights.deleteByIndex(t._lightIndex);e&&(e._lightIndex=t._lightIndex),t._lightIndex=-1},s._attachPointLight=function(t){t._lightIndex=this._pointLights.length,this._pointLights.add(t)},s._detachPointLight=function(t){var e=this._pointLights.deleteByIndex(t._lightIndex);e&&(e._lightIndex=t._lightIndex),t._lightIndex=-1},s._attachDirectLight=function(t){t._lightIndex=this._directLights.length,this._directLights.add(t)},s._detachDirectLight=function(t){var e=this._directLights.deleteByIndex(t._lightIndex);e&&(e._lightIndex=t._lightIndex),t._lightIndex=-1},s._updateShaderData=function(t){for(var e=this,r=e._spotLights,a=e._pointLights,o=e._directLights,l=this,c=l._spotData,_=l._pointData,u=l._directData,d=r.length,h=a.length,f=o.length,v=0;v<d;v++)r.get(v)._appendData(v,c);for(var p=0;p<h;p++)a.get(p)._appendData(p,_);for(var g=0;g<f;g++)o.get(g)._appendData(g,u);f?(bn._updateShaderData(t,u),t.enableMacro("SCENE_DIRECT_LIGHT_COUNT",f.toString())):t.disableMacro("SCENE_DIRECT_LIGHT_COUNT"),h?(Cn._updateShaderData(t,_),t.enableMacro("SCENE_POINT_LIGHT_COUNT",h.toString())):t.disableMacro("SCENE_POINT_LIGHT_COUNT"),d?(vr._updateShaderData(t,c),t.enableMacro("SCENE_SPOT_LIGHT_COUNT",d.toString())):t.disableMacro("SCENE_SPOT_LIGHT_COUNT")},s._gc=function(){this._spotLights.garbageCollection(),this._pointLights.garbageCollection(),this._directLights.garbageCollection()},s._updateSunlightIndex=function(t){var e=this._directLights,r=t._lightIndex;if(r>0){var a=e.get(0),o=e.get(r);e.set(0,o),e.set(r,a),o._lightIndex=0,a._lightIndex=r}},s._getMaxBrightestSunlight=function(){for(var t=this._directLights,e=null,r=Number.NEGATIVE_INFINITY,a=!1,o=0,l=t.length;o<l;o++){var c=t.get(o);c.shadowType!==xn.None&&!a&&(r=Number.NEGATIVE_INFINITY,a=!0);var _=c.intensity*c.color.getBrightness();a?c.shadowType!==xn.None&&r<_&&(r=_,e=c):r<_&&(r=_,e=c)}return e},n}();(function(){Yn._sunlightColorProperty=L.getByName("scene_SunlightColor")})();(function(){Yn._sunlightDirectionProperty=L.getByName("scene_SunlightDirection")})();(function(){Yn._maxLight=10})();var $a=function(n){W(s,n);function s(t,e){var r;r=n.call(this,t)||this,r.physics=new Qt(ue(r)),r.castShadows=!0,r.shadowResolution=Ln.Medium,r.shadowTwoCascadeSplits=1/3,r.shadowFourCascadeSplits=new w(1/15,3/15,7/15),r.shadowDistance=50,r.shadowFadeBorder=.1,r._lightManager=new Yn,r._componentsManager=new Md,r._isActiveInEngine=!1,r._globalShaderMacro=new ar,r._rootEntities=[],r._background=new wc(r._engine),r._shaderData=new Hr(Tr.Scene),r._shadowCascades=Sr.NoCascades,r._fogMode=Bi.None,r._fogColor=new j(.5,.5,.5,1),r._fogStart=0,r._fogEnd=300,r._fogDensity=.01,r._fogParams=new ae,r._isActive=!0,r.name=e||"";var a=r.shaderData;return a._addReferCount(1),r.ambientLight=new Lr(t),t.sceneManager._allCreatedScenes.push(ue(r)),a.enableMacro("SCENE_FOG_MODE",r._fogMode.toString()),a.enableMacro("SCENE_SHADOW_CASCADED_COUNT",r.shadowCascades.toString()),a.setColor(s._fogColorProperty,r._fogColor),a.setVector4(s._fogParamsProperty,r._fogParams),r._computeLinearFogParams(r._fogStart,r._fogEnd),r._computeExponentialFogParams(r._fogDensity),r}var i=s.prototype;return i.createRootEntity=function(e){var r=new Qr(this._engine,e);return this.addRootEntity(r),r},i.addRootEntity=function(e,r){var a;typeof e=="number"?a=e:(a=void 0,r=e);var o=r._isRoot;o||(r._isRoot=!0,r._removeFromParent());var l=r._scene;l!==this?(l&&o&&l._removeFromEntityList(r),this._addToRootEntityList(a,r)):o||this._addToRootEntityList(a,r);var c=he.None;r._isActiveInHierarchy&&(this._isActiveInEngine||(c|=he.Hierarchy)),r._isActiveInScene&&l!==this&&(c|=he.Scene),c&&r._processInActive(c),l!==this&&Qr._traverseSetOwnerScene(r,this);var _=he.None;r._isActive&&(this._isActiveInEngine&&!r._isActiveInHierarchy&&(_|=he.Hierarchy),(!r._isActiveInScene||l!==this)&&(_|=he.Scene)),_&&r._processActive(_)},i.removeRootEntity=function(e){if(e._isRoot&&e._scene==this){this._removeFromEntityList(e),e._isRoot=!1;var r=he.None;this._isActiveInEngine&&e._isActiveInHierarchy&&(r|=he.Hierarchy),e._isActiveInScene&&(r|=he.Scene),r&&e._processInActive(r),Qr._traverseSetOwnerScene(e,null)}},i.getRootEntity=function(e){return e===void 0&&(e=0),this._rootEntities[e]},i.findEntityByName=function(e){for(var r=this._rootEntities,a=0,o=r.length;a<o;a++){var l=r[a].findByName(e);if(l)return l}return null},i.findEntityByPath=function(e){for(var r=e.split("/").filter(Boolean),a=0,o=this.rootEntitiesCount;a<o;a++){var l=this.getRootEntity(a);if(l.name==r[0]){for(var c=1,_=r.length;c<_&&(l=Qr._findChildByName(l,r[c]),!!l);++c);return l}}return null},i._processActive=function(e){this._isActiveInEngine=e;for(var r=this._rootEntities,a=r.length-1;a>=0;a--){var o=r[a];o._isActive&&(e?o._processActive(he.Hierarchy):o._processInActive(he.Hierarchy))}},i._updateShaderData=function(){var e=this.shaderData,r=this._engine,a=this._lightManager;r.time._updateSceneShaderData(e),a._updateShaderData(this.shaderData);var o=this._lightManager._sunlight=this._getSunlight();o?(a._updateSunlightIndex(o),e.setColor(Yn._sunlightColorProperty,o._lightColor),e.setVector3(Yn._sunlightDirectionProperty,o.direction)):e.setVector3(Yn._sunlightDirectionProperty,w._zero),this.castShadows&&o&&o.shadowType!==xn.None?e.enableMacro("SCENE_SHADOW_TYPE",o.shadowType.toString()):e.disableMacro("SCENE_SHADOW_TYPE"),ar.unionCollection(this.engine._macroCollection,e._macroCollection,this._globalShaderMacro)},i._removeFromEntityList=function(e){var r=this._rootEntities,a=e._siblingIndex;r.splice(a,1);for(var o=r.length;a<o;a++)r[a]._siblingIndex--;e._siblingIndex=-1},i._onDestroy=function(){n.prototype._onDestroy.call(this);var e=this._engine.sceneManager;for(e.removeScene(this);this.rootEntitiesCount>0;)this._rootEntities[0].destroy();this.background.destroy(),this._ambientLight&&this._ambientLight._removeFromScene(this),this.shaderData._addReferCount(-1),this._componentsManager.handlingInvalidScripts();var r=e._allCreatedScenes;r.splice(r.indexOf(this),1)},i._addToRootEntityList=function(e,r){var a=this._rootEntities,o=a.length;if(e===void 0)r._siblingIndex=o,a.push(r);else{if(e<0||e>o)throw"The index "+e+" is out of child list bounds "+o;r._siblingIndex=e,a.splice(e,0,r);for(var l=e+1,c=o+1;l<c;l++)a[l]._siblingIndex++}},i._computeLinearFogParams=function(e,r){var a=r-e,o=this._fogParams;o.x=-1/a,o.y=r/a},i._computeExponentialFogParams=function(e){this._fogParams.z=e/Math.LN2,this._fogParams.w=e/Math.sqrt(Math.LN2)},i._getSunlight=function(){var e=null;return this._sun?e=this._sun.enabled?this._sun:null:e=this._lightManager._getMaxBrightestSunlight(),e},q(s,[{key:"isActive",get:function(){return this._isActive},set:function(e){this._isActive!==e&&(this._isActive=e,e?this._sceneManager&&this._processActive(!0):this._sceneManager&&this._processActive(!1))}},{key:"shaderData",get:function(){return this._shaderData}},{key:"background",get:function(){return this._background}},{key:"shadowCascades",get:function(){return this._shadowCascades},set:function(e){this._shadowCascades!==e&&(this.shaderData.enableMacro("SCENE_SHADOW_CASCADED_COUNT",e.toString()),this._shadowCascades=e)}},{key:"ambientLight",get:function(){return this._ambientLight},set:function(e){if(!e){ve.warn("The scene must have one ambient light");return}var r=this._ambientLight;r!==e&&(r&&r._removeFromScene(this),e._addToScene(this),this._ambientLight=e)}},{key:"fogMode",get:function(){return this._fogMode},set:function(e){this._fogMode!==e&&(this.shaderData.enableMacro("SCENE_FOG_MODE",e.toString()),this._fogMode=e)}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor!==e&&this._fogColor.copyFrom(e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart!==e&&(this._computeLinearFogParams(e,this._fogEnd),this._fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd!==e&&(this._computeLinearFogParams(this._fogStart,e),this._fogEnd=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity!==e&&(this._computeExponentialFogParams(e),this._fogDensity=e)}},{key:"rootEntitiesCount",get:function(){return this._rootEntities.length}},{key:"rootEntities",get:function(){return this._rootEntities}},{key:"sun",get:function(){return this._sun},set:function(e){this._sun=e}}]),s}(tn);(function(){$a._fogColorProperty=L.getByName("scene_FogColor")})();(function(){$a._fogParamsProperty=L.getByName("scene_FogParams")})();var Jt=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t._started=!1,t._onStartIndex=-1,t._onUpdateIndex=-1,t._onLateUpdateIndex=-1,t._onPhysicsUpdateIndex=-1,t._onPreRenderIndex=-1,t._onPostRenderIndex=-1,t._entityScriptsIndex=-1,t}var i=s.prototype;return i.onAwake=function(){},i.onEnable=function(){},i.onStart=function(){},i.onUpdate=function(e){},i.onLateUpdate=function(e){},i.onBeginRender=function(e){},i.onEndRender=function(e){},i.onPhysicsUpdate=function(){},i.onTriggerEnter=function(e){},i.onTriggerExit=function(e){},i.onTriggerStay=function(e){},i.onCollisionEnter=function(e){},i.onCollisionExit=function(e){},i.onCollisionStay=function(e){},i.onPointerDown=function(e){},i.onPointerUp=function(e){},i.onPointerClick=function(e){},i.onPointerEnter=function(e){},i.onPointerExit=function(e){},i.onPointerDrag=function(e){},i.onDisable=function(){},i.onDestroy=function(){},i._onAwake=function(){this.onAwake()},i._onEnable=function(){this.onEnable()},i._onDisable=function(){this.onDisable()},i._onEnableInScene=function(){var e=this.scene,r=e._componentsManager,a=s.prototype;this._started||r.addOnStartScript(this),this.onUpdate!==a.onUpdate&&r.addOnUpdateScript(this),this.onLateUpdate!==a.onLateUpdate&&r.addOnLateUpdateScript(this),this.onPhysicsUpdate!==a.onPhysicsUpdate&&r.addOnPhysicsUpdateScript(this),this._entity._addScript(this)},i._onDisableInScene=function(){var e=this.scene._componentsManager,r=s.prototype;this._started||e.removeOnStartScript(this),this.onUpdate!==r.onUpdate&&e.removeOnUpdateScript(this),this.onLateUpdate!==r.onLateUpdate&&e.removeOnLateUpdateScript(this),this.onPhysicsUpdate!==r.onPhysicsUpdate&&e.removeOnPhysicsUpdateScript(this),this._entity._removeScript(this)},i._onDestroy=function(){n.prototype._onDestroy.call(this),this.scene?this.scene._componentsManager.addPendingDestroyScript(this):this.onDestroy()},s}(Vt);R([I],Jt.prototype,"_started",void 0);R([I],Jt.prototype,"_onStartIndex",void 0);R([I],Jt.prototype,"_onUpdateIndex",void 0);R([I],Jt.prototype,"_onLateUpdateIndex",void 0);R([I],Jt.prototype,"_onPhysicsUpdateIndex",void 0);R([I],Jt.prototype,"_onPreRenderIndex",void 0);R([I],Jt.prototype,"_onPostRenderIndex",void 0);R([I],Jt.prototype,"_entityScriptsIndex",void 0);var Ha;(function(n){n[n.None=0]="None",n[n.PrePass=1]="PrePass"})(Ha||(Ha={}));var Qo=function(s){this._engine=s},fr=function(){function n(){}return n.recreateTextureIfNeeded=function(i,t,e,r,a,o){if(t)if(t.width!==e||t.height!==r||t.format!==a||t.mipmapCount>1!==o){t.destroy(!0);var l=new bt(i,e,r,a,o);return l.isGCIgnored=!0,l}else return t;else{var c=new bt(i,e,r,a,o);return c.isGCIgnored=!0,c}},n.recreateRenderTargetIfNeeded=function(i,t,e,r,a,o,l,c,_){var u,d=(u=t)==null?void 0:u.getColorTexture(0),h=a?n.recreateTextureIfNeeded(i,d,e,r,a,c):null;if(l){var f,v=(f=t)==null?void 0:f.depthTexture,p=o?n.recreateTextureIfNeeded(i,v,e,r,o,c):null;if(d!==h||v!==p){var g;(g=t)==null||g.destroy(!0),t=new ea(i,e,r,h,p,_),t.isGCIgnored=!0}}else{var y,m=o;if(d!==h||((y=t)==null?void 0:y._depthFormat)!==m){var x;(x=t)==null||x.destroy(!0),t=new ea(i,e,r,h,m,_),t.isGCIgnored=!0}}return t},n.blitTexture=function(i,t,e,r,a){r===void 0&&(r=0);var o=i._basicResources,l=e?o.flipYBlitMesh:o.blitMesh,c=o.blitMaterial,_=i._hardwareRenderer,u=i._renderContext;u.flipProjection=!!e,_.activeRenderTarget(e,a??n.defaultViewport,u.flipProjection,0);var d=n._rendererShaderData,h=c.shader.subShaders[0].passes[0],f=h._getShaderProgram(i,ne._compileMacros);d.setTexture(n._blitTextureProperty,t),d.setFloat(n._blitMipLevelProperty,r),f.bind(),f.groupingOtherUniformBlock(),f.uploadAll(f.rendererUniformBlock,d),f.uploadAll(f.materialUniformBlock,c.shaderData),f.uploadUnGroupTextures(),(h._renderState||c.renderState)._apply(i,!1,h._renderStateDataMap,c.shaderData),_.drawPrimitive(l._primitive,l.subMesh,f)},n}();(function(){fr._blitTextureProperty=L.getByName("renderer_BlitTexture")})();(function(){fr._blitMipLevelProperty=L.getByName("renderer_BlitMipLevel")})();(function(){fr._rendererShaderData=new Hr(Tr.Renderer)})();(function(){fr.defaultViewport=new ae(0,0,1,1)})();var Ec=function(n){W(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.createVertexElements=function(e){return e[0]=new Me("POSITION",0,ee.Vector3,0),e[1]=new Me("TEXCOORD_0",12,ee.Vector2,0),e[2]=new Me("COLOR_0",20,ee.Vector4,0),36},i.canBatch=function(e,r){if(!this._engine._canSpriteBatch||r.shaderPasses[0].getTagValue(Or._disableBatchTag)===!0)return!1;var a=e.data,o=r.data,l=a.component,c=o.component;return!this.checkBatchWithMask(l,c)||a.texture!==o.texture?!1:a.material===o.material},i.checkBatchWithMask=function(e,r){var a=e.maskInteraction;return a!==r.maskInteraction?!1:a===ht.None?!0:e.maskLayer===r.maskLayer},i.updateVertices=function(e,r,a){for(var o=e.verticesData,l=o.positions,c=o.uvs,_=o.color,u=o.vertexCount,d=0;d<u;d++){var h=l[d],f=c[d];r[a++]=h.x,r[a++]=h.y,r[a++]=h.z,r[a++]=f.x,r[a++]=f.y,r[a++]=_.r,r[a++]=_.g,r[a++]=_.b,r[a++]=_.a}return a},i.drawBatches=function(e){for(var r=this,a=r._engine,o=r._batchedQueue,l=this._meshes[this._flushId],c=l.subMeshes,_=l._primitive,u=a._spriteMaskManager,d=e.scene.shaderData,h=e.shaderData,f=0,v=c.length;f<v;f++){var p=c[f],g=o[f],y=g.data;if(!p||!g)return;var m=y.component,x=y.material;u.preRender(e,m);var S=ne._compileMacros;ar.unionCollection(m._globalShaderMacro,x.shaderData._macroCollection,S);var b=g.shaderPasses[0],A=b._getShaderProgram(a,S);if(!A.isValid)return;m.shaderData.setTexture(s._textureProperty,y.texture),A.bind(),A.groupingOtherUniformBlock(),A.uploadAll(A.sceneUniformBlock,d),A.uploadAll(A.cameraUniformBlock,h),A.uploadAll(A.rendererUniformBlock,m.shaderData),A.uploadAll(A.materialUniformBlock,x.shaderData),(b._renderState||x.renderState)._apply(a,!1,b._renderStateDataMap,x.shaderData),a._hardwareRenderer.drawPrimitive(_,p,A),u.postRender(m)}},s}(Or);(function(){Ec._textureProperty=L.getByName("renderer_SpriteTexture")})();var un=function(){function n(i,t){this.elements=[],this._initSpriteBatcher(i),this._renderQueueType=t}var s=n.prototype;return s.pushRenderElement=function(t){this.elements.push(t)},s.render=function(t,e){var r=this.elements;if(r.length!==0){for(var a=t.engine,o=t.instanceId,l=t.shaderData,c=t.scene,_=c.shaderData,u=c.instanceId,d=a._renderCount,h=a._hardwareRenderer,f=rr.pipelineStageKey,v=this._renderQueueType,p=0,g=r.length;p<g;p++){var y=r[p],m=y.data,x=y.shaderPasses;if(m.primitive){this._spriteBatcher.flush(t);var S=ne._compileMacros,b=m.primitive,A=m.component,C=m.material,E=A.shaderData,T=A.instanceId,B=C.shaderData,M=C.instanceId,P=C.renderStates;ar.unionCollection(A._globalShaderMacro,B._macroCollection,S);for(var V=0,N=x.length;V<N;V++){var F=x[V];if(F.getTagValue(f)===e){var O;if(((O=F._renderState)!=null?O:P[V]).renderQueueType===v){var D=F._getShaderProgram(a,S);if(!!D.isValid){var z=D.bind(),U=d!==D._uploadRenderCount;U?(D.groupingOtherUniformBlock(),D.uploadAll(D.sceneUniformBlock,_),D.uploadAll(D.cameraUniformBlock,l),D.uploadAll(D.rendererUniformBlock,E),D.uploadAll(D.materialUniformBlock,B),D.uploadUnGroupTextures(),D._uploadSceneId=u,D._uploadCameraId=o,D._uploadRendererId=T,D._uploadMaterialId=M,D._uploadRenderCount=d):(D._uploadSceneId!==u?(D.uploadAll(D.sceneUniformBlock,_),D._uploadSceneId=u):z&&D.uploadTextures(D.sceneUniformBlock,_),D._uploadCameraId!==o?(D.uploadAll(D.cameraUniformBlock,l),D._uploadCameraId=o):z&&D.uploadTextures(D.cameraUniformBlock,l),D._uploadRendererId!==T?(D.uploadAll(D.rendererUniformBlock,E),D._uploadRendererId=T):z&&D.uploadTextures(D.rendererUniformBlock,E),D._uploadMaterialId!==M?(D.uploadAll(D.materialUniformBlock,B),D._uploadMaterialId=M):z&&D.uploadTextures(D.materialUniformBlock,B),z&&D.uploadUnGroupTextures());var Y,K=(Y=F._renderState)!=null?Y:P[V];K._apply(a,A.entity.transform._isFrontFaceInvert(),F._renderStateDataMap,C.shaderData),h.drawPrimitive(b,m.subPrimitive,D)}}}}}else this._spriteBatcher.drawElement(y,t)}this._spriteBatcher.flush(t)}},s.clear=function(){this.elements.length=0,this._spriteBatcher.clear()},s.destroy=function(){this._spriteBatcher.destroy(),this._spriteBatcher=null},s.sort=function(t){We._quickSort(this.elements,0,this.elements.length,t)},s._initSpriteBatcher=function(t){this._spriteBatcher=new Ec(t)},n._compareFromNearToFar=function(t,e){var r=t.data,a=e.data,o=r.component,l=a.component,c=o.priority-l.priority;if(c!==0)return c;if(o.instanceId===l.instanceId)return r.material._priority-a.material._priority;var _=o._distanceForSort-l._distanceForSort;return _===0?o.instanceId-l.instanceId:_},n._compareFromFarToNear=function(t,e){var r=t.data,a=e.data,o=r.component,l=a.component,c=o.priority-l.priority;if(c!==0)return c;if(o.instanceId===l.instanceId)return r.material._priority-a.material._priority;var _=l._distanceForSort-o._distanceForSort;return _===0?o.instanceId-l.instanceId:_},n}(),Tc=function(){this.position=new w,this.isOrthographic=!1,this.viewMatrix=new J,this.projectionMatrix=new J,this.viewProjectionMatrix=new J,this.nearClipPlane=.1,this.farClipPlane=100,this.forward=new w},Pd=function(){this.virtualCamera=new Tc,this.cullPlanes=[new Ge(new w),new Ge(new w),new Ge(new w),new Ge(new w),new Ge(new w),new Ge(new w),new Ge(new w),new Ge(new w),new Ge(new w),new Ge(new w)],this.splitBoundSphere=new ic(new w,0)},Es;(function(n){n[n.FarBottomLeft=0]="FarBottomLeft",n[n.FarTopLeft=1]="FarTopLeft",n[n.FarTopRight=2]="FarTopRight",n[n.FarBottomRight=3]="FarBottomRight",n[n.nearBottomLeft=4]="nearBottomLeft",n[n.nearTopLeft=5]="nearTopLeft",n[n.nearTopRight=6]="nearTopRight",n[n.nearBottomRight=7]="nearBottomRight",n[n.unknown=8]="unknown"})(Es||(Es={}));var dt=function(){function n(){}return n.shadowResolution=function(i){switch(i){case Ln.Low:return 512;case Ln.Medium:return 1024;case Ln.High:return 2048;case Ln.VeryHigh:return 4096}},n.shadowDepthFormat=function(i,t){return t?G.Depth16:G.R8G8B8A8},n.cullingRenderBounds=function(i,t,e){for(var r=i.min,a=i.max,o=0;o<t;o++){var l=e[o],c=l.normal;if(c.x*(c.x>=0?a.x:r.x)+c.y*(c.y>=0?a.y:r.y)+c.z*(c.z>=0?a.z:r.z)<-l.distance)return!1}return!0},n.shadowCullFrustum=function(i,t,e,r){var a=e._entity.layer;i.camera.cullingMask&a&&t.cullingMask&a&&e.castShadows&&n.cullingRenderBounds(e.bounds,r.cullPlaneCount,r.cullPlanes)&&(e._renderFrameCount=e.engine.time.frameCount,e._prepareRender(i))},n.getBoundSphereByFrustum=function(i,t,e,r,a){var o=e.aspectRatio,l=e.fieldOfView,c,_,u=Math.sqrt(1+o*o)*Math.tan(k.degreeToRadian(l)/2),d=u*u,h=t-i,f=t+i;d>h/f?(c=t,_=t*u):(c=.5*f*(1+d),_=.5*Math.sqrt(h*h+2*(t*t+i*i)*d+f*f*d*d));var v=a.splitBoundSphere.center;a.splitBoundSphere.radius=_,w.scale(r,c,v),w.add(e.entity.transform.worldPosition,v,v),a.sphereCenterZ=c},n.getDirectionLightShadowCullPlanes=function(i,t,e,r,a){var o=n._frustumCorners,l=n._backPlaneFaces,c=n._frustumPlaneNeighbors,_=n._frustumTwoPlaneCorners,u=n._edgePlanePoint2,d=a.cullPlanes,h=i.getPlane(Ce.Near),f=i.getPlane(Ce.Far),v=i.getPlane(Ce.Left),p=i.getPlane(Ce.Right),g=i.getPlane(Ce.Bottom),y=i.getPlane(Ce.Top),m=t-e,x=n._adjustNearPlane,S=n._adjustFarPlane;x.normal.copyFrom(h.normal),S.normal.copyFrom(f.normal),x.distance=h.distance-m,S.distance=Math.min(-h.distance+a.sphereCenterZ+a.splitBoundSphere.radius,f.distance),Dt.intersectionPointThreePlanes(x,g,p,o[7]),Dt.intersectionPointThreePlanes(x,y,p,o[6]),Dt.intersectionPointThreePlanes(x,y,v,o[5]),Dt.intersectionPointThreePlanes(x,g,v,o[4]),Dt.intersectionPointThreePlanes(S,g,p,o[3]),Dt.intersectionPointThreePlanes(S,y,p,o[2]),Dt.intersectionPointThreePlanes(S,y,v,o[1]),Dt.intersectionPointThreePlanes(S,g,v,o[0]);for(var b=0,A=0;A<6;A++){var C=void 0;switch(A){case Ce.Near:C=x;break;case Ce.Far:C=S;break;default:C=i.getPlane(A);break}w.dot(C.normal,r)<0&&(d[b].copyFrom(C),l[b]=A,b++)}for(var E=b,T=0;T<b;T++)for(var B=l[T],M=c[B],P=0;P<4;P++){for(var V=M[P],N=!0,F=0;F<b;F++)if(V==l[F]){N=!1;break}if(N){var O=_[B][V],D=o[O[0]],z=o[O[1]];w.add(D,r,u),Ge.fromPoints(D,z,u,d[E++])}}a.cullPlaneCount=E},n.getDirectionalLightMatrices=function(i,t,e,r,a,o,l,c){var _=l.splitBoundSphere;l.resolution=o;var u=_.center,d=_.radius,h=o/2,f=d*h/(h-n.atlasBorderSize),v=f*2,p=o/v,g=v/o,y=Math.ceil(w.dot(u,i)*p)*g,m=Math.ceil(w.dot(u,t)*p)*g,x=w.dot(u,e);u.x=i.x*y+t.x*m+e.x*x,u.y=i.y*y+t.y*m+e.y*x,u.z=i.z*y+t.z*m+e.z*x;var S=l.virtualCamera,b=S.position,A=S.viewMatrix,C=S.projectionMatrix;w.scale(e,d+a,b),w.subtract(u,b,b),J.lookAt(b,u,i,A),J.ortho(-f,f,-f,f,0,d*2+a,C);var E=S.viewProjectionMatrix;J.multiply(C,A,E),We._floatMatrixMultiply(n._shadowMapCoordMatrix,E.elements,0,c,r*16)},n.getMaxTileResolutionInAtlas=function(i,t,e){for(var r=Math.min(i,t),a=Math.floor(i/r)*Math.floor(t/r);a<e;)r=Math.floor(r>>1),a=Math.floor(i/r)*Math.floor(t/r);return r},n.getShadowBias=function(i,t,e,r){var a=2/t.elements[0],o=a/e,l=-i.shadowBias*o,c=-i.shadowNormalBias*o;if(i.shadowType==xn.SoftHigh){var _=2.5;l*=_,c*=_}r.set(l,c)},n.applySliceTransform=function(i,t,e,r,a,o){var l=n._tempMatrix0,c=l.elements,_=1/t,u=1/e,d=i*_,h=i*u,f=a.x*_,v=a.y*u;c[0]=d,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=h,c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[10]=1,c[11]=0,c[12]=f,c[13]=v,c[14]=0,c[15]=1;var p=r*16;We._floatMatrixMultiply(l,o,p,o,p)},n.getScaleAndBiasForLinearDistanceFade=function(i,t,e){if(t<1e-4){var r=1e3;e.z=r,e.w=-i*r;return}t=1-t,t*=t;var a=t*i,o=i-a;e.z=1/o,e.w=-a/o},n}();(function(){dt._tempMatrix0=new J})();(function(){dt._shadowMapCoordMatrix=new J(.5,0,0,0,0,-.5,0,0,0,0,.5,0,.5,.5,.5,1)})();(function(){dt._frustumCorners=[new w,new w,new w,new w,new w,new w,new w,new w]})();(function(){dt._adjustNearPlane=new Ge(new w)})();(function(){dt._adjustFarPlane=new Ge(new w)})();(function(){dt._backPlaneFaces=new Array(5)})();(function(){dt._edgePlanePoint2=new w})();(function(){dt._frustumPlaneNeighbors=[[Ce.Left,Ce.Right,Ce.Top,Ce.Bottom],[Ce.Left,Ce.Right,Ce.Top,Ce.Bottom],[Ce.Near,Ce.Far,Ce.Top,Ce.Bottom],[Ce.Near,Ce.Far,Ce.Top,Ce.Bottom],[Ce.Near,Ce.Far,Ce.Left,Ce.Right],[Ce.Near,Ce.Far,Ce.Left,Ce.Right]]})();(function(){dt._frustumTwoPlaneCorners=[[[8,8],[8,8],[4,5],[6,7],[7,4],[5,6]],[[8,8],[8,8],[1,0],[3,2],[0,3],[2,1]],[[5,4],[0,1],[8,8],[8,8],[4,0],[1,5]],[[7,6],[2,3],[8,8],[8,8],[3,7],[6,2]],[[4,7],[3,0],[0,4],[7,3],[8,8],[8,8]],[[6,5],[1,2],[5,1],[2,6],[8,8],[8,8]]]})();(function(){dt.atlasBorderSize=4})();var qt=function(n){W(s,n);function s(t){var e;return e=n.call(this,t.engine)||this,e._shadowMapSize=new ae,e._shadowBias=new $,e._shadowSliceData=new Pd,e._lightUp=new w,e._lightSide=new w,e._splitBoundSpheres=new Float32Array(s._maxCascades*4),e._shadowMatrices=new Float32Array((s._maxCascades+1)*16),e._shadowInfos=new ae,e._viewportOffsets=[new $,new $,new $,new $],e._camera=t,e._supportDepthTexture=t.engine._hardwareRenderer.canIUse(Q.depthTexture),e._shadowSliceData.virtualCamera.isOrthographic=!0,e}var i=s.prototype;return i.onRender=function(e){var r=this._camera.scene._lightManager._sunlight;this._updateShadowSettings(),this._renderDirectShadowMap(e,r),this._updateReceiversShaderData(r)},i._renderDirectShadowMap=function(e,r){var a=this,o=a._engine,l=a._camera,c=a._viewportOffsets,_=a._shadowSliceData,u=a._splitBoundSpheres,d=a._shadowMatrices,h=l._renderPipeline._cullingResults,f=h.opaqueQueue,v=h.alphaTestQueue,p=h.transparentQueue,g=l.scene,y=g._componentsManager,m=o._hardwareRenderer,x=g.shadowCascades,S=s._cascadesSplitDistance,b=_.splitBoundSphere,A=s._tempMatrix0,C=A.elements,E=this._lightUp,T=this._lightSide,B=_.virtualCamera.forward,M=this._shadowMapSize,P=M.z,V=M.w,N=this._shadowMapFormat,F,O;this._supportDepthTexture?(F=fr.recreateRenderTargetIfNeeded(o,this._renderTarget,P,V,null,N,!0,!1,1),O=F.depthTexture):(F=fr.recreateRenderTargetIfNeeded(o,this._renderTarget,P,V,N,null,!1,!1,1),O=F.getColorTexture(0)),O.wrapModeU=O.wrapModeV=yt.Clamp,o._hardwareRenderer._isWebGL2&&(O.depthCompareFunction=Cr.Less),this._renderTarget=F,this._depthTexture=O,m.activeRenderTarget(F,s._viewport,e.flipProjection,0),this._supportDepthTexture?m.clearRenderTarget(o,Lt.Depth,null):m.clearRenderTarget(o,Lt.All,s._clearColor),J.rotationQuaternion(r.entity.transform.worldRotationQuaternion,A),T.set(C[0],C[1],C[2]),E.set(C[4],C[5],C[6]),B.set(-C[8],-C[9],-C[10]);var D=s._tempVector;D.copyFrom(l.entity.transform.worldForward);for(var z=this._shadowTileResolution,U=0;U<x;U++){dt.getBoundSphereByFrustum(S[U],S[U+1],l,D,_),dt.getDirectionLightShadowCullPlanes(l._frustum,S[U],l.nearClipPlane,B,_),dt.getDirectionalLightMatrices(E,T,B,U,r.shadowNearPlane,z,_,d),x>1&&dt.applySliceTransform(z,P,V,U,this._viewportOffsets[U],d),this._updateSingleShadowCasterShaderData(r,_,e);var Y=b.center,K=b.radius,H=U*4;u[H]=Y.x,u[H+1]=Y.y,u[H+2]=Y.z,u[H+3]=K*K,f.clear(),v.clear(),p.clear();for(var te=y._renderers,we=te._elements,pe=te.length-1;pe>=0;--pe)dt.shadowCullFrustum(e,r,we[pe],_);if(f.elements.length||v.elements.length){f.sort(un._compareFromNearToFar),v.sort(un._compareFromNearToFar);var oe=c[U],Ee=oe.x,Ke=oe.y;m.setGlobalDepthBias(1,1),m.viewport(Ee,Ke,z,z),m.scissor(Ee+1,Ke+1,z-2,z-2),o._renderCount++,f.render(l,jt.ShadowCaster),v.render(l,jt.ShadowCaster),m.setGlobalDepthBias(0,0)}}},i._updateReceiversShaderData=function(e){var r=this._camera,a=r.scene,o=this._splitBoundSpheres,l=this._shadowMatrices,c=a.shadowCascades,_=Math.min(a.shadowDistance,r.farClipPlane);if(dt.getScaleAndBiasForLinearDistanceFade(Math.pow(_,2),a.shadowFadeBorder,this._shadowInfos),this._shadowInfos.x=e.shadowStrength,c>1)for(var u=c*4,d=o.length;u<d;u++)o[u]=0;for(var h=c*16,f=l.length;h<f;h++)l[h]=0;var v=a.shaderData;v.setFloatArray(s._shadowMatricesProperty,this._shadowMatrices),v.setVector4(s._shadowInfosProperty,this._shadowInfos),v.setTexture(s._shadowMapsProperty,this._depthTexture),v.setFloatArray(s._shadowSplitSpheresProperty,this._splitBoundSpheres),v.setVector4(s._shadowMapSize,this._shadowMapSize)},i._getCascadesSplitDistance=function(e){var r=s._cascadesSplitDistance,a=this._camera.scene,o=a.shadowTwoCascadeSplits,l=a.shadowFourCascadeSplits,c=a.shadowCascades,_=this._camera,u=_.nearClipPlane,d=_.aspectRatio,h=_.fieldOfView;r[0]=u;var f=e-u,v=Math.tan(k.degreeToRadian(h)*.5),p=1+v*v*(d*d+1);switch(c){case Sr.NoCascades:r[1]=this._getFarWithRadius(e,p);break;case Sr.TwoCascades:r[1]=this._getFarWithRadius(u+f*o,p),r[2]=this._getFarWithRadius(e,p);break;case Sr.FourCascades:r[1]=this._getFarWithRadius(u+f*l.x,p),r[2]=this._getFarWithRadius(u+f*l.y,p),r[3]=this._getFarWithRadius(u+f*l.z,p),r[4]=this._getFarWithRadius(e,p);break}},i._getFarWithRadius=function(e,r){return Math.sqrt(e*e/r)},i._updateShadowSettings=function(){var e=this._camera,r=e.scene,a=dt.shadowDepthFormat(r.shadowResolution,this._supportDepthTexture),o=dt.shadowResolution(r.shadowResolution),l=r.shadowCascades,c=Math.min(r.shadowDistance,e.farClipPlane);if(this._getCascadesSplitDistance(c),a!==this._shadowMapFormat||o!==this._shadowMapResolution||l!==this._shadowCascadeMode){if(this._shadowMapFormat=a,this._shadowMapResolution=o,this._shadowCascadeMode=l,l==Sr.NoCascades)this._shadowTileResolution=o,this._shadowMapSize.set(1/o,1/o,o,o);else{var _=dt.getMaxTileResolutionInAtlas(o,o,l);this._shadowTileResolution=_;var u=_*2,d=l==Sr.TwoCascades?_:_*2;this._shadowMapSize.set(1/u,1/d,u,d)}this._renderTarget=null;var h=this._viewportOffsets,f=this._shadowTileResolution;switch(l){case Sr.NoCascades:h[0].set(0,0);break;case Sr.TwoCascades:h[0].set(0,0),h[1].set(f,0);break;case Sr.FourCascades:h[0].set(0,0),h[1].set(f,0),h[2].set(0,f),h[3].set(f,f)}}},i._updateSingleShadowCasterShaderData=function(e,r,a){var o=r.virtualCamera;dt.getShadowBias(e,o.projectionMatrix,this._shadowTileResolution,this._shadowBias);var l=this._camera.scene.shaderData;l.setVector2(s._lightShadowBiasProperty,this._shadowBias),l.setVector3(s._lightDirectionProperty,e.direction),a.applyVirtualCamera(o,!0)},s}(Qo);(function(){qt._lightShadowBiasProperty=L.getByName("scene_ShadowBias")})();(function(){qt._lightDirectionProperty=L.getByName("scene_LightDirection")})();(function(){qt._shadowMatricesProperty=L.getByName("scene_ShadowMatrices")})();(function(){qt._shadowMapSize=L.getByName("scene_ShadowMapSize")})();(function(){qt._shadowInfosProperty=L.getByName("scene_ShadowInfo")})();(function(){qt._shadowMapsProperty=L.getByName("scene_ShadowMap")})();(function(){qt._shadowSplitSpheresProperty=L.getByName("scene_ShadowSplitSpheres")})();(function(){qt._maxCascades=4})();(function(){qt._cascadesSplitDistance=new Array(qt._maxCascades+1)})();(function(){qt._viewport=new ae(0,0,1,1)})();(function(){qt._clearColor=new j(1,1,1,1)})();(function(){qt._tempVector=new w})();(function(){qt._tempMatrix0=new J})();var Bd=function(){function n(i){this.opaqueQueue=new un(i,mt.Opaque),this.transparentQueue=new un(i,mt.Transparent),this.alphaTestQueue=new un(i,mt.AlphaTest)}var s=n.prototype;return s.reset=function(){this.opaqueQueue.clear(),this.transparentQueue.clear(),this.alphaTestQueue.clear()},s.sort=function(){this.opaqueQueue.sort(un._compareFromNearToFar),this.alphaTestQueue.sort(un._compareFromNearToFar),this.transparentQueue.sort(un._compareFromFarToNear)},s.destroy=function(){this.opaqueQueue.destroy(),this.transparentQueue.destroy(),this.alphaTestQueue.destroy()},n}(),Dd=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e._supportDepthTexture=t._hardwareRenderer.canIUse(Q.depthTexture),e}var i=s.prototype;return i.onConfig=function(e){var r=this._engine,a=e.pixelViewport,o=a.width,l=a.height,c=fr.recreateRenderTargetIfNeeded(r,this._renderTarget,o,l,null,G.Depth16,!0,!1,1),_=c.depthTexture;_.wrapModeU=_.wrapModeV=yt.Clamp,_.filterMode=ot.Point,this._renderTarget=c},i.onRender=function(e,r){var a=this._engine,o=this._renderTarget,l=e.camera,c=a._hardwareRenderer;c.activeRenderTarget(o,l.viewport,e.flipProjection,0),c.viewport(0,0,o.width,o.height),c.scissor(0,0,o.width,o.height),c.clearRenderTarget(a,Lt.Depth,null),r.opaqueQueue.render(l,jt.DepthOnly),r.alphaTestQueue.render(l,jt.DepthOnly),l.shaderData.setTexture(Ne._cameraDepthTextureProperty,this._renderTarget.depthTexture)},s}(Qo),ya;(function(n){n[n.None=1]="None",n[n.TwoX=2]="TwoX",n[n.FourX=4]="FourX"})(ya||(ya={}));var Ld=function(n){W(s,n);function s(t){return n.call(this,t)}var i=s.prototype;return i.onConfig=function(e,r){this._cameraColorTexture=r;var a=e.opaqueTextureDownsampling,o=a===ya.None,l=e.pixelViewport,c=o?1:a===ya.TwoX?.5:.25,_=fr.recreateRenderTargetIfNeeded(this._engine,this._renderTarget,l.width*c,l.height*c,G.R8G8B8A8,null,!1,!1,1),u=_.getColorTexture(0);u.wrapModeU=u.wrapModeV=yt.Clamp,u.filterMode=o?ot.Point:ot.Bilinear,this._renderTarget=_},i.onRender=function(e,r){fr.blitTexture(this._engine,this._cameraColorTexture,this._renderTarget),e.camera.shaderData.setTexture(Ne._cameraOpaqueTextureProperty,this._renderTarget.getColorTexture(0))},s}(Qo),Rc=function(){function n(i){this._allSpriteMasks=new Ye,this._lastCanvasSize=new $,this._internalColorTarget=null,this._camera=i;var t=i.engine;this._cullingResults=new Bd(t),this._cascadedShadowCasterPass=new qt(i),this._depthOnlyPass=new Dd(t),this._opaqueTexturePass=new Ld(t)}var s=n.prototype;return s.destroy=function(){this._cullingResults.destroy(),this._allSpriteMasks=null,this._camera=null},s.render=function(t,e,r,a){var o=this._camera,l=o.scene,c=o.engine,_=this._cullingResults,u=l._lightManager._sunlight,d=this._depthOnlyPass,h=o.depthTextureMode===Ha.PrePass&&d._supportDepthTexture;o.engine._spriteMaskManager.clear(),l.castShadows&&u&&u.shadowType!==xn.None&&this._cascadedShadowCasterPass.onRender(t),_.reset(),this._allSpriteMasks.length=0,t.applyVirtualCamera(o._virtualCamera,h),this._prepareRender(t),_.sort(),h?(d.onConfig(o),d.onRender(t,_)):o.shaderData.setTexture(Ne._cameraDepthTextureProperty,c._whiteTexture2D);var f=o.independentCanvasEnabled;if(f){var v=o.pixelViewport,p=fr.recreateRenderTargetIfNeeded(c,this._internalColorTarget,v.width,v.height,G.R8G8B8A8,G.Depth24Stencil8,!1,!1,o.msaaSamples),g=p.getColorTexture(0);g.wrapModeU=g.wrapModeV=yt.Clamp,this._internalColorTarget=p}else{var y=this._internalColorTarget;if(y){var m;(m=y.getColorTexture(0))==null||m.destroy(!0),y.destroy(!0),this._internalColorTarget=null}}this._drawRenderPass(t,o,e,r,a)},s._drawRenderPass=function(t,e,r,a,o){var l,c,_=this._cullingResults,u=_.opaqueQueue,d=_.alphaTestQueue,h=_.transparentQueue,f=e.engine,v=e.scene,p=v.background,g=this._internalColorTarget,y=f._hardwareRenderer,m,x=(m=e.renderTarget)!=null?m:g,S=g?fr.defaultViewport:e.viewport,b=e.renderTarget&&r==null||g!==null;t.flipProjection!==b&&(t.applyVirtualCamera(e._virtualCamera,b),this._updateMVPShaderData(t),f._renderCount++),y.activeRenderTarget(x,S,t.flipProjection,a,r);var A=e.clearFlags&~(o??Lt.None),C=p.solidColor;if(A!==Lt.None&&y.clearRenderTarget(e.engine,A,C),u.render(e,jt.Forward),d.render(e,jt.Forward),A&Lt.Color&&(p.mode===$r.Sky?p.sky._render(t):p.mode===$r.Texture&&p.texture&&this._drawBackgroundTexture(f,p)),e.opaqueTextureEnabled){x._blitRenderTarget();var E=this._opaqueTexturePass;E.onConfig(e,x.getColorTexture(0)),E.onRender(t,_),y.activeRenderTarget(x,S,t.flipProjection,a,r)}else e.shaderData.setTexture(Ne._cameraOpaqueTextureProperty,null);h.render(e,jt.Forward),(l=x)==null||l._blitRenderTarget(),(c=x)==null||c.generateMipmaps(),g&&fr.blitTexture(f,g.getColorTexture(0),null,0,e.viewport)},s.pushRenderData=function(t,e){var r=e.material,a=r.renderStates,o=r.shader.subShaders[0],l=t.replacementShader;if(l){var c=l.subShaders,_=t.replacementTag;if(_)for(var u=0,d=c.length;u<d;u++){var h=c[u];if(h.getTagValue(_)===o.getTagValue(_)){this.pushRenderDataWithShader(t,e,h.passes,a);break}}else this.pushRenderDataWithShader(t,e,c[0].passes,a)}else this.pushRenderDataWithShader(t,e,o.passes,a)},s.pushRenderDataWithShader=function(t,e,r,a){for(var o=this._cullingResults,l=o.opaqueQueue,c=o.alphaTestQueue,_=o.transparentQueue,u=t.camera.engine._renderElementPool,d=0,h=0,f=r.length;h<f;h++){var v,p=((v=r[h]._renderState)!=null?v:a[h]).renderQueueType;if(!(d&1<<p)){var g=u.getFromPool();switch(g.set(e,r),p){case mt.Opaque:l.pushRenderElement(g),d|=1;break;case mt.AlphaTest:c.pushRenderElement(g),d|=2;break;case mt.Transparent:_.pushRenderElement(g),d|=4;break}}}},s._drawBackgroundTexture=function(t,e){var r=t._hardwareRenderer,a=t.canvas,o=e._material,l=e._mesh;(this._lastCanvasSize.x!==a.width||this._lastCanvasSize.y!==a.height)&&e._textureFillMode!==Dn.Fill&&(this._lastCanvasSize.set(a.width,a.height),e._resizeBackgroundTexture());var c=o.shader.subShaders[0].passes[0],_=c._getShaderProgram(t,ne._compileMacros);_.bind(),_.uploadAll(_.materialUniformBlock,o.shaderData),_.uploadUnGroupTextures(),(c._renderState||o.renderState)._apply(t,!1,c._renderStateDataMap,o.shaderData),r.drawPrimitive(l._primitive,l.subMesh,_)},s._prepareRender=function(t){for(var e=t.camera,r=e.engine,a=e.scene._componentsManager._renderers,o=a._elements,l=a.length-1;l>=0;--l){var c=o[l];!(e.cullingMask&c._entity.layer)||e.enableFrustumCulling&&!e._frustum.intersectsBox(c.bounds)||(c._renderFrameCount=r.time.frameCount,c._prepareRender(t))}},s._updateMVPShaderData=function(t){for(var e=t.camera,r=e.scene._componentsManager._renderers,a=r._elements,o=r.length-1;o>=0;--o){var l=a[o];l._updateShaderData(t,!0)}},n}(),Ts;(function(n){n[n.None=0]="None",n[n.Opaque=1]="Opaque",n[n.AlphaTest=2]="AlphaTest",n[n.Transparent=4]="Transparent"})(Ts||(Ts={}));var Wa;(function(n){n[n.Normal=0]="Normal",n[n.XRCenterCamera=1]="XRCenterCamera",n[n.XRLeftCamera=2]="XRLeftCamera",n[n.XRRightCamera=4]="XRRightCamera"})(Wa||(Wa={}));var Di;(function(n){n[n.None=1]="None",n[n.TwoX=2]="TwoX",n[n.FourX=4]="FourX",n[n.EightX=8]="EightX"})(Di||(Di={}));var sn,Qn=function(){};(function(){Qn.tempVec4=new ae})();(function(){Qn.tempVec3=new w})();(function(){Qn.tempVec2=new $})();var Ne=(sn=function(n){W(s,n);function s(t){var e;e=n.call(this,t)||this,e.enableFrustumCulling=!0,e.clearFlags=Lt.All,e.cullingMask=mn.Everything,e.depthTextureMode=Ha.None,e.opaqueTextureDownsampling=ya.TwoX,e.msaaSamples=Di.None,e._cameraType=Wa.Normal,e._globalShaderMacro=new ar,e._frustum=new oc,e._virtualCamera=new Tc,e._replacementShader=null,e._replacementSubShaderTag=null,e._cameraIndex=-1,e._priority=0,e._shaderData=new Hr(Tr.Camera),e._isCustomViewMatrix=!1,e._isCustomProjectionMatrix=!1,e._fieldOfView=45,e._orthographicSize=10,e._isProjectionDirty=!0,e._isInvProjMatDirty=!0,e._customAspectRatio=void 0,e._renderTarget=null,e._depthBufferParams=new ae,e._opaqueTextureEnabled=!1,e._viewport=new ae(0,0,1,1),e._pixelViewport=new qr(0,0,0,0),e._inverseProjectionMatrix=new J,e._invViewProjMat=new J;var r=e.entity.transform;return e._transform=r,e._isViewMatrixDirty=r.registerWorldChangeFlag(),e._isInvViewProjDirty=r.registerWorldChangeFlag(),e._frustumChangeFlag=r.registerWorldChangeFlag(),e._renderPipeline=new Rc(ue(e)),e._addResourceReferCount(e.shaderData,1),e._updatePixelViewport(),e._onPixelViewportChanged=e._onPixelViewportChanged.bind(ue(e)),e._viewport._onValueChanged=e._onPixelViewportChanged,e.engine.canvas._sizeUpdateFlagManager.addListener(e._onPixelViewportChanged),e}var i=s.prototype;return i.resetViewMatrix=function(){this._isCustomViewMatrix=!1,this._viewMatrixChange()},i.resetProjectionMatrix=function(){this._isCustomProjectionMatrix=!1,this._projectionMatrixChange()},i.resetAspectRatio=function(){this._customAspectRatio=void 0,this._projectionMatrixChange()},i.worldToViewportPoint=function(e,r){var a=Qn.tempVec3,o=Qn.tempVec4;w.transformCoordinate(e,this.viewMatrix,a),w.transformToVec4(a,this.projectionMatrix,o);var l=o.w;return r.set((o.x/l+1)*.5,(1-o.y/l)*.5,-a.z),r},i.viewportToWorldPoint=function(e,r){var a=this,o=a.nearClipPlane,l=a.farClipPlane,c=1/(o-l),_;if(this.isOrthographic)_=-e.z*2*c,_+=(l+o)*c;else{var u=e.z;_=-u*(o+l)*c,_+=2*o*l*c,_=_/u}return this._innerViewportToWorldPoint(e.x,e.y,(_+1)/2,this._getInvViewProjMat(),r),r},i.viewportPointToRay=function(e,r){var a=this._getInvViewProjMat(),o=this._innerViewportToWorldPoint(e.x,e.y,0,a,r.origin),l=this._innerViewportToWorldPoint(e.x,e.y,1-k.zeroTolerance,a,r.direction);return w.subtract(l,o,l),l.normalize(),r},i.screenToViewportPoint=function(e,r){var a=this.engine.canvas,o=this.viewport;return r.x=(e.x/a.width-o.x)/o.z,r.y=(e.y/a.height-o.y)/o.w,e.z!==void 0&&(r.z=e.z),r},i.viewportToScreenPoint=function(e,r){var a=this.engine.canvas,o=this.viewport;return r.x=(o.x+e.x*o.z)*a.width,r.y=(o.y+e.y*o.w)*a.height,e.z!==void 0&&(r.z=e.z),r},i.worldToScreenPoint=function(e,r){return this.worldToViewportPoint(e,r),this.viewportToScreenPoint(r,r)},i.screenToWorldPoint=function(e,r){return this.screenToViewportPoint(e,r),this.viewportToWorldPoint(r,r)},i.screenPointToRay=function(e,r){var a=Qn.tempVec2;return this.screenToViewportPoint(e,a),this.viewportPointToRay(a,r)},i.render=function(e,r){r===void 0&&(r=0);var a=this.engine._renderContext,o=this._virtualCamera,l=this.entity.transform;J.multiply(this.projectionMatrix,this.viewMatrix,o.viewProjectionMatrix),o.position.copyFrom(l.worldPosition),o.isOrthographic&&o.forward.copyFrom(l.worldForward),a.camera=this,a.virtualCamera=o,a.replacementShader=this._replacementShader,a.replacementTag=this._replacementSubShaderTag,this.enableFrustumCulling&&this._frustumChangeFlag.flag&&(this._frustum.calculateFromMatrix(o.viewProjectionMatrix),this._frustumChangeFlag.flag=!1),this._updateShaderData(),ar.unionCollection(this.scene._globalShaderMacro,this.shaderData._macroCollection,this._globalShaderMacro),r>0&&!this.engine._hardwareRenderer.isWebGL2&&(r=0,ve.error("mipLevel only take effect in WebGL2.0"));var c;this._cameraType!==Wa.Normal&&(c=this.engine.xrManager._getCameraClearFlagsMask(this._cameraType)),this._renderPipeline.render(a,e,r,c),this._engine._renderCount++},i.setReplacementShader=function(e,r){this._replacementShader=e,this._replacementSubShaderTag=typeof r=="string"?vn.getByName(r):r},i.resetReplacementShader=function(){this._replacementShader=null,this._replacementSubShaderTag=null},i._onEnableInScene=function(){this.scene._componentsManager.addCamera(this)},i._onDisableInScene=function(){this.scene._componentsManager.removeCamera(this)},i._onDestroy=function(){var e;n.prototype._onDestroy.call(this),(e=this._renderPipeline)==null||e.destroy(),this._isInvViewProjDirty.destroy(),this._isViewMatrixDirty.destroy(),this._addResourceReferCount(this.shaderData,-1),this._viewport._onValueChanged=null,this.engine.canvas._sizeUpdateFlagManager.removeListener(this._onPixelViewportChanged),this._entity=null,this._globalShaderMacro=null,this._frustum=null,this._renderPipeline=null,this._virtualCamera=null,this._shaderData=null,this._frustumChangeFlag=null,this._transform=null,this._isViewMatrixDirty=null,this._isInvViewProjDirty=null,this._viewport=null,this._inverseProjectionMatrix=null,this._invViewProjMat=null},i._updatePixelViewport=function(){var e,r,a=this._renderTarget;if(a)e=a.width,r=a.height;else{var o=this.engine.canvas;e=o.width,r=o.height}var l=this._viewport;this._pixelViewport.set(l.x*e,l.y*r,l.z*e,l.w*r)},i._viewMatrixChange=function(){this._isViewMatrixDirty.flag=!0,this._isInvViewProjDirty.flag=!0,this._frustumChangeFlag.flag=!0},i._projectionMatrixChange=function(){this._isProjectionDirty=!0,this._isInvProjMatDirty=!0,this._isInvViewProjDirty.flag=!0,this._frustumChangeFlag.flag=!0},i._innerViewportToWorldPoint=function(e,r,a,o,l){var c=Qn.tempVec3;return c.set(e*2-1,1-r*2,a*2-1),w.transformCoordinate(c,o,l),l},i._updateShaderData=function(){var e=this.shaderData,r=this._transform;e.setMatrix(Ne._inverseViewMatrixProperty,r.worldMatrix),e.setVector3(Ne._cameraPositionProperty,r.worldPosition),e.setVector3(Ne._cameraForwardProperty,r.worldForward),e.setVector3(Ne._cameraUpProperty,r.worldUp);var a=this._depthBufferParams,o=this.farClipPlane/this.nearClipPlane;a.set(1-o,o,0,0),e.setVector4(Ne._cameraDepthBufferParamsProperty,a)},i._getInvViewProjMat=function(){return this._isInvViewProjDirty.flag&&(this._isInvViewProjDirty.flag=!1,J.multiply(this._transform.worldMatrix,this._getInverseProjectionMatrix(),this._invViewProjMat)),this._invViewProjMat},i._getInverseProjectionMatrix=function(){return this._isInvProjMatDirty&&(this._isInvProjMatDirty=!1,J.invert(this.projectionMatrix,this._inverseProjectionMatrix)),this._inverseProjectionMatrix},i._forceUseInternalCanvas=function(){return this.opaqueTextureEnabled},i._onPixelViewportChanged=function(){this._updatePixelViewport();var e;(e=this._customAspectRatio)!=null||this._projectionMatrixChange(),this._checkMainCanvasAntialiasWaste()},i._checkMainCanvasAntialiasWaste=function(){this.independentCanvasEnabled&&ae.equals(this._viewport,fr.defaultViewport)&&console.warn("Camera use independent canvas and viewport cover the whole screen, it is recommended to disable antialias, depth and stencil to save memory when create engine.")},q(s,[{key:"opaqueTextureEnabled",get:function(){return this._opaqueTextureEnabled},set:function(e){this._opaqueTextureEnabled!==e&&(this._opaqueTextureEnabled=e,this._checkMainCanvasAntialiasWaste())}},{key:"independentCanvasEnabled",get:function(){return this._renderTarget?!1:this._forceUseInternalCanvas()}},{key:"shaderData",get:function(){return this._shaderData}},{key:"nearClipPlane",get:function(){return this._virtualCamera.nearClipPlane},set:function(e){this._virtualCamera.nearClipPlane=e,this._projectionMatrixChange()}},{key:"farClipPlane",get:function(){return this._virtualCamera.farClipPlane},set:function(e){this._virtualCamera.farClipPlane=e,this._projectionMatrixChange()}},{key:"fieldOfView",get:function(){return this._fieldOfView},set:function(e){this._fieldOfView=e,this._projectionMatrixChange()}},{key:"aspectRatio",get:function(){var e=this.pixelViewport,r;return(r=this._customAspectRatio)!=null?r:e.width/e.height},set:function(e){this._customAspectRatio=e,this._projectionMatrixChange()}},{key:"viewport",get:function(){return this._viewport},set:function(e){e!==this._viewport&&this._viewport.copyFrom(e)}},{key:"pixelViewport",get:function(){return this._pixelViewport}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this._phasedActiveInScene&&(this.scene._componentsManager._cameraNeedSorting=!0),this._priority=e)}},{key:"isOrthographic",get:function(){return this._virtualCamera.isOrthographic},set:function(e){this._virtualCamera.isOrthographic=e,this._projectionMatrixChange(),e?this.shaderData.enableMacro("CAMERA_ORTHOGRAPHIC"):this.shaderData.disableMacro("CAMERA_ORTHOGRAPHIC")}},{key:"orthographicSize",get:function(){return this._orthographicSize},set:function(e){this._orthographicSize=e,this._projectionMatrixChange()}},{key:"viewMatrix",get:function(){var e=this._virtualCamera.viewMatrix;if(!this._isViewMatrixDirty.flag||this._isCustomViewMatrix)return e;this._isViewMatrixDirty.flag=!1;var r=this._transform;return J.rotationTranslation(r.worldRotationQuaternion,r.worldPosition,e),e.invert(),e},set:function(e){this._virtualCamera.viewMatrix.copyFrom(e),this._isCustomViewMatrix=!0,this._viewMatrixChange()}},{key:"projectionMatrix",get:function(){var e=this._virtualCamera,r=e.projectionMatrix;if(!this._isProjectionDirty||this._isCustomProjectionMatrix)return r;this._isProjectionDirty=!1;var a=this.aspectRatio;if(!e.isOrthographic)J.perspective(k.degreeToRadian(this._fieldOfView),a,this.nearClipPlane,this.farClipPlane,r);else{var o=this._orthographicSize*a,l=this._orthographicSize;J.ortho(-o,o,-l,l,this.nearClipPlane,this.farClipPlane,r)}return r},set:function(e){this._virtualCamera.projectionMatrix.copyFrom(e),this._isCustomProjectionMatrix=!0,this._projectionMatrixChange()}},{key:"enableHDR",get:function(){return console.log("not implementation"),!1},set:function(e){console.log("not implementation")}},{key:"renderTarget",get:function(){return this._renderTarget},set:function(e){this._renderTarget!==e&&(this._renderTarget&&this._addResourceReferCount(this._renderTarget,-1),e&&this._addResourceReferCount(e,1),this._renderTarget=e,this._onPixelViewportChanged(),this._checkMainCanvasAntialiasWaste())}}]),s}(Vt),function(){sn._cameraDepthTextureProperty=L.getByName("camera_DepthTexture")}(),function(){sn._cameraOpaqueTextureProperty=L.getByName("camera_OpaqueTexture")}(),function(){sn._inverseViewMatrixProperty=L.getByName("camera_ViewInvMat")}(),function(){sn._cameraPositionProperty=L.getByName("camera_Position")}(),function(){sn._cameraForwardProperty=L.getByName("camera_Forward")}(),function(){sn._cameraUpProperty=L.getByName("camera_Up")}(),function(){sn._cameraDepthBufferParamsProperty=L.getByName("camera_DepthBufferParams")}(),sn);R([Z],Ne.prototype,"_frustum",void 0);R([I],Ne.prototype,"_renderPipeline",void 0);R([I],Ne.prototype,"_virtualCamera",void 0);R([I],Ne.prototype,"_cameraIndex",void 0);R([I],Ne.prototype,"_frustumChangeFlag",void 0);R([I],Ne.prototype,"_transform",void 0);R([I],Ne.prototype,"_isViewMatrixDirty",void 0);R([I],Ne.prototype,"_isInvViewProjDirty",void 0);R([Z],Ne.prototype,"_viewport",void 0);R([Z],Ne.prototype,"_pixelViewport",void 0);R([Z],Ne.prototype,"_inverseProjectionMatrix",void 0);R([Z],Ne.prototype,"_invViewProjMat",void 0);R([I],Ne.prototype,"_onPixelViewportChanged",null);Ne=R([An(me,Ur.CheckOnly)],Ne);var Vd={json:"json",gltf:"json",mtl:"json",prefab:"json",txt:"text",bin:"arraybuffer",png:"image",webp:"image",jpg:"image"},Nd=1,Id=1/0,Fd=500;function aa(n,s){return s===void 0&&(s={}),new Be(function(i,t,e,r){var a,o=(a=s.retryCount)!=null?a:Nd,l,c=(l=s.retryInterval)!=null?l:Fd,_;s.timeout=(_=s.timeout)!=null?_:Id;var u;s.type=(u=s.type)!=null?u:zd(n);var d=new Ud(function(){return Od(n,s).onProgress(e,r)},o,c);d.start().onError(t).onComplete(i)})}function Od(n,s){return new Be(function(i,t,e,r){var a=new XMLHttpRequest,o=s.type==="image";a.timeout=s.timeout;var l;s.method=(l=s.method)!=null?l:"get",a.onload=function(){if(a.status<200||a.status>=300){t(new Error("request failed from: "+n));return}var _,u=(_=a.response)!=null?_:a.responseText;if(o){var d=new Image;d.onload=function(){requestAnimationFrame(function(){e(1,1),i(d),d.onload=null,d.onerror=null,d.onabort=null,URL.revokeObjectURL(d.src)})},d.onerror=d.onabort=function(){t(new Error("request "+d.src+" fail")),URL.revokeObjectURL(d.src)},d.crossOrigin="anonymous",d.src=URL.createObjectURL(u)}else e(1,1),i(u)},a.onerror=function(){t(new Error("request failed from: "+n))},a.ontimeout=function(){t(new Error("request timeout from: "+n))},a.onprogress=function(_){_.lengthComputable&&r(n,_.loaded,_.total)},a.open(s.method,n,!0),a.withCredentials=s.credentials==="include",a.responseType=o?"blob":s.type;var c=s.headers;c&&Object.keys(c).forEach(function(_){a.setRequestHeader(_,c[_])}),a.send(s.body)})}function zd(n){var s=n.substring(n.lastIndexOf(".")+1);return Vd[s]}var Ud=function(){function n(i,t,e){this.execFunc=i,this.totalCount=t,this.interval=e,this._timeoutId=-100,this._currentCount=0,this.exec=this.exec.bind(this)}var s=n.prototype;return s.start=function(){return this.exec(),this},s.onComplete=function(t){return this._onComplete=t,this},s.onError=function(t){return this._onError=t,this},s.cancel=function(){window.clearTimeout(this._timeoutId)},s.exec=function(){var t=this;if(this._currentCount>=this.totalCount){this._onError&&this._onError(this._error);return}this._currentCount++,this.execFunc(this._currentCount).then(function(e){return t._onComplete&&t._onComplete(e)}).catch(function(e){t._error=e,t._timeoutId=window.setTimeout(t.exec,t.interval)})},n}(),De=function(){function n(s){this.useCache=s,this.request=aa}return n.registerClass=function(i,t){this._engineObjects[i]=t,this._classNameMap.set(t,i)},n.getClass=function(i){return this._engineObjects[i]},n.getClassName=function(i){return this._classNameMap.get(i)},n}();(function(){De._engineObjects={}})();(function(){De._classNameMap=new Map})();var kd=function(){function n(){}var s=n.prototype;return s.initialize=function(t){var e=t.component,r=t.property.split(".");if(t.getProperty){var a=t.getProperty.split(".");this._initializeMounted(e,a,1),this._initializeMounted(e,r,2)}else this._initializeMounted(e,r,3)},s.getTargetValue=function(){switch(this._getType){case 2:return this._getMounted[this._getArrayIndex];case 1:return this._getMounted[this._getValueName].apply(this._getMounted,this._getArgs);case 0:return this._getMounted[this._getValueName]}},s.setTargetValue=function(t){switch(this._setType){case 2:this._setMounted[this._setArrayIndex]=t;break;case 1:var e=this._setArgs;e[this._replaceValueIndex]=t,this._setMounted[this._setValueName].apply(this._setMounted,e);break;case 0:this._setMounted[this._setValueName]=t;break}},s._initializeMounted=function(t,e,r){for(var a=e.length-1,o=0;o<a;o++){var l=e[o];if(l.indexOf("[")>-1){var c=l.indexOf("[");t=t[l.slice(0,c)],t=t[parseInt(l.slice(c+1,-1))]}else if(l.endsWith(")")){var _=l.slice(0,l.indexOf("(")),u=l.match(/\w+\(([^)]*)\)/)[1].split(",").map(function(m){return m.trim().replace(/['"]+/g,"")}).filter(function(m){return m!==""});t=t[_].apply(t,u)}else t=t[l]}var d=e[a],h,f,v,p;if(d.indexOf("[")>-1){var g=d.indexOf("[");h=2,t=t[d.slice(0,g)],f=parseInt(d.slice(g+1,-1))}else if(d.endsWith(")")){if(v=d.slice(0,d.indexOf("(")),p=d.match(/\w+\(([^)]*)\)/)[1].split(",").map(function(m){return m.trim().replace(/['"]+/g,"")}).filter(function(m){return m!==""}),h=1,r&2){var y=p.indexOf("$value");this._replaceValueIndex=y>-1?y:p.length}}else h=0;r&2&&(this._setMounted=t,this._setType=h,this._setArrayIndex=f,this._setValueName=d,v&&(this._setValueName=v),this._setArgs=p),r&1&&(this._getMounted=t,this._getType=h,this._getArrayIndex=f,this._getValueName=d,v&&(this._getValueName=v),this._getArgs=p)},n}(),Rs;(function(n){n[n.Property=0]="Property",n[n.Method=1]="Method",n[n.Array=2]="Array"})(Rs||(Rs={}));var Ms;(function(n){n[n.Get=1]="Get",n[n.Set=2]="Set",n[n.Both=3]="Both"})(Ms||(Ms={}));var wn=function(){function n(i,t,e,r,a,o){this.baseEvaluateData={curKeyframeIndex:0,value:null},this.crossEvaluateData={curKeyframeIndex:0,value:null},this.updateMark=0,this.target=i,this.property=r,this.getProperty=a,this.component=e,this.cureType=o;var l=n.getAssemblerType(t,r);this._assembler=new l,this._assembler.initialize(this),o._isCopyMode&&(this.referenceTargetValue=this._assembler.getTargetValue())}var s=n.prototype;return s.evaluateValue=function(t,e,r){return r?t._evaluateAdditive(e,this.baseEvaluateData):t._evaluate(e,this.baseEvaluateData)},s.evaluateCrossFadeValue=function(t,e,r,a,o,l){if(!this.cureType._supportInterpolationMode)return this.evaluateValue(e,a,!1);var c=t&&t.keys.length?l?t._evaluateAdditive(r,this.baseEvaluateData):t._evaluate(r,this.baseEvaluateData):l?this.cureType._getZeroValue(this.baseEvaluateData.value):this.defaultValue,_=e&&e.keys.length?l?e._evaluateAdditive(a,this.crossEvaluateData):e._evaluate(a,this.crossEvaluateData):l?this.cureType._getZeroValue(this.crossEvaluateData.value):this.defaultValue;return this._lerpValue(c,_,o)},s.crossFadeFromPoseAndApplyValue=function(t,e,r,a){if(!this.cureType._supportInterpolationMode)return this.evaluateValue(t,e,!1);var o=a?this.cureType._subtractValue(this.fixedPoseValue,this.defaultValue,this.baseEvaluateData.value):this.fixedPoseValue,l=t&&t.keys.length?a?t._evaluateAdditive(e,this.crossEvaluateData):t._evaluate(e,this.crossEvaluateData):a?this.cureType._getZeroValue(this.crossEvaluateData.value):this.defaultValue;return this._lerpValue(o,l,r)},s.revertDefaultValue=function(){this._assembler.setTargetValue(this.defaultValue)},s.getEvaluateValue=function(t){return this.cureType._isCopyMode?(this.cureType._setValue(this.baseEvaluateData.value,t),t):this.baseEvaluateData.value},s.saveDefaultValue=function(){this.cureType._isCopyMode?this.cureType._setValue(this.referenceTargetValue,this.defaultValue):this.defaultValue=this._assembler.getTargetValue()},s.saveFixedPoseValue=function(){this.cureType._isCopyMode?this.cureType._setValue(this.referenceTargetValue,this.fixedPoseValue):this.fixedPoseValue=this._assembler.getTargetValue()},s.applyValue=function(t,e,r){var a=this.cureType;if(r){var o=this._assembler;if(a._isCopyMode)a._additiveValue(t,e,this.referenceTargetValue);else{var l=o.getTargetValue(),c=a._additiveValue(t,e,l);o.setTargetValue(c)}}else if(e===1)a._isCopyMode?a._setValue(t,this.referenceTargetValue):this._assembler.setTargetValue(t);else if(a._isCopyMode){var _=this.referenceTargetValue;a._lerpValue(_,t,e,_)}else{var u=this._assembler.getTargetValue(),d=a._lerpValue(u,t,e);this._assembler.setTargetValue(d)}},s._lerpValue=function(t,e,r){return this.cureType._isCopyMode?this.cureType._lerpValue(t,e,r,this.baseEvaluateData.value):(this.baseEvaluateData.value=this.cureType._lerpValue(t,e,r),this.baseEvaluateData.value)},n.registerAssembler=function(t,e,r){var a=n._assemblerMap.get(t);a||(a={},n._assemblerMap.set(t,a)),a[e]=r},n.getAssemblerType=function(t,e){var r=n._assemblerMap.get(t),a=r?r[e]:void 0;return a??kd},n}();(function(){wn._components=[]})();(function(){wn._assemblerMap=new Map})();var Gd=function(){function n(){}var s=n.prototype;return s.initialize=function(t){this._transform=t.target.transform},s.getTargetValue=function(){return this._transform.position},s.setTargetValue=function(t){this._transform.position=t},n}();wn.registerAssembler(me,"position",Gd);var Hd=function(){function n(){}var s=n.prototype;return s.initialize=function(t){this._transform=t.target.transform},s.getTargetValue=function(){return this._transform.rotationQuaternion},s.setTargetValue=function(t){this._transform.rotationQuaternion=t},n}();wn.registerAssembler(me,"rotationQuaternion",Hd);var Wd=function(){function n(){}var s=n.prototype;return s.initialize=function(t){this._transform=t.target.transform},s.getTargetValue=function(){return this._transform.scale},s.setTargetValue=function(t){this._transform.scale=t},n}();wn.registerAssembler(me,"scale",Wd);var Xd=function(){function n(){}var s=n.prototype;return s.initialize=function(t){this._skinnedMeshRenderer=t.component},s.getTargetValue=function(){return this._skinnedMeshRenderer.blendShapeWeights},s.setTargetValue=function(t){this._skinnedMeshRenderer.blendShapeWeights=t},n}();wn.registerAssembler(Pt,"blendShapeWeights",Xd);var jd=function(){function n(){this.crossCurveMark=0,this.isActive=!0}var s=n.prototype;return s.initFinalValue=function(){var t=this.curveOwner,e=t.cureType,r=t.defaultValue;e._isCopyMode?e._setValue(r,this.finalValue):this.finalValue=r},s.saveFinalValue=function(){this.finalValue=this.curveOwner.getEvaluateValue(this.finalValue)},n}(),Mc=function(){function n(){this.typeIndex=0,this._tempCurveOwner={}}var s=n.prototype;return s._createCurveOwner=function(t,e){var r=this.curve.constructor,a=new wn(t,this.type,e,this.property,this.getProperty,r);return r._initializeOwner(a),a.saveDefaultValue(),a},s._createCurveLayerOwner=function(t){var e=this.curve.constructor,r=new jd;return r.curveOwner=t,e._initializeLayerOwner(r),r.initFinalValue(),r},s._getTempCurveOwner=function(t,e){var r=t.instanceId;return this._tempCurveOwner[r]||(this._tempCurveOwner[r]=this._createCurveOwner(t,e)),this._tempCurveOwner[r]},n}(),to=function(){},Ko=function(n){W(s,n);function s(t){var e;return e=n.call(this,null)||this,e.name=t,e._curveBindings=[],e._updateFlagManager=new zr,e._length=0,e._events=[],e}var i=s.prototype;return i.addEvent=function(e,r,a){var o;if(typeof e=="string"){var l=new to;l.functionName=e,l.time=r,l.parameter=a,o=l}else o=e;var c=this._events,_=c.length,u=o.time,d=_?c[_-1].time:0;if(u>=d)c.push(o);else{for(var h=_;--h>=0&&u<c[h].time;);c.splice(h+1,0,o)}this._updateFlagManager.dispatch()},i.clearEvents=function(){this._events.length=0,this._updateFlagManager.dispatch()},i.addCurveBinding=function(e,r,a,o,l,c){var _=new Mc;_.relativePath=e,_.type=r,typeof a=="number"?(_.typeIndex=a,_.property=o,typeof l=="string"?(_.getProperty=l,_.curve=c):_.curve=l):(_.property=a,typeof o=="string"?(_.getProperty=o,_.curve=l):_.curve=o),this._length=Math.max(this._length,_.curve.length),this._curveBindings.push(_)},i.clearCurveBindings=function(){this._curveBindings.length=0,this._length=0},i._sampleAnimation=function(e,r){for(var a=this,o=a._curveBindings,l=o.length-1;l>=0;l--){var c=o[l],_=e.findByPath(c.relativePath);if(_){var u=c.typeIndex>0?_.getComponents(c.type,wn._components)[c.typeIndex]:_.getComponent(c.type);if(!u)continue;var d=c._getTempCurveOwner(_,u);if(d&&c.curve.keys.length){var h=d.evaluateValue(c.curve,r,!1);d.applyValue(h,1,!1)}}}},q(s,[{key:"events",get:function(){return this._events}},{key:"curveBindings",get:function(){return this._curveBindings}},{key:"length",get:function(){return this._length}}]),s}(tn),At;(function(n){n[n.Linear=0]="Linear",n[n.CubicSpine=1]="CubicSpine",n[n.Step=2]="Step",n[n.Hermite=3]="Hermite"})(At||(At={}));var pr=function(){function n(){this.keys=[],this._evaluateData={curKeyframeIndex:0,value:null},this._length=0;var i=this.constructor;this._interpolation=i._supportInterpolationMode?At.Linear:At.Step,this._type=i}var s=n.prototype;return s.addKey=function(t){var e=t.time,r=this.keys;if(e>=this._length)r.push(t),this._length=e;else{for(var a=r.length;--a>=0&&e<r[a].time;);r.splice(a+1,0,t)}},s.evaluate=function(t){return this._evaluate(t,this._evaluateData)},s.removeKey=function(t){this.keys.splice(t,1);for(var e=this.keys,r=0,a=e.length-1;a>=0;a--){var o=e[a];o.time>this._length&&(r=o.time)}this._length=r},s._evaluate=function(t,e){var r=this.keys.length;if(!r){console.warn("This curve don't have any keyframes: ",this);return}var a=this,o=a.keys,l=a.interpolation,c=e.curKeyframeIndex;c!==-1&&(c>=r||t<o[c].time)&&(c=-1);for(var _=c+1;_<r&&!(t<o[_].time);)c++,_++;e.curKeyframeIndex=c;var u;if(c===-1)u=this._type._setValue(o[0].value,e.value);else if(_===r)u=this._type._setValue(o[c].value,e.value);else{var d=o[c],h=o[_],f=d.time,v=h.time-f,p=(t-f)/v;switch(l){case At.Linear:u=this._type._lerpValue(d.value,h.value,p,e.value);break;case At.Step:u=this._type._setValue(d.value,e.value);break;case At.CubicSpine:case At.Hermite:u=this._type._hermiteInterpolationValue(d,h,p,v,e.value);break}}return e.value=u,u},s._evaluateAdditive=function(t,e){var r=this._evaluate(t,e);return this._type._subtractValue(r,this.keys[0].value,e.value)},q(n,[{key:"interpolation",get:function(){return this._interpolation},set:function(t){!this._type._supportInterpolationMode&&t!==At.Step?(this._interpolation=At.Step,console.warn("The interpolation type must be `InterpolationType.Step`.")):this._interpolation=t}},{key:"length",get:function(){return this._length}}]),n}(),ui,Li=(ui=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=[],i}return s._initializeOwner=function(t){t.defaultValue=[],t.fixedPoseValue=[],t.baseEvaluateData.value=[],t.crossEvaluateData.value=[]},s._initializeLayerOwner=function(t){t.finalValue=[]},s._lerpValue=function(t,e,r,a){for(var o=0,l=a.length;o<l;++o){var c=t[o];a[o]=c+(e[o]-c)*r}return a},s._subtractValue=function(t,e,r){for(var a=0,o=t.length;a<o;a++)r[a]=t[a]-e[a];return r},s._getZeroValue=function(t){for(var e=0,r=t.length;e<r;e++)t[e]=0;return t},s._additiveValue=function(t,e,r){for(var a=0,o=r.length;a<o;++a)r[a]+=t[a]*e;return r},s._setValue=function(t,e){for(var r=0,a=e.length;r<a;++r)e[r]=t[r];return e},s._hermiteInterpolationValue=function(t,e,r,a,o){for(var l=t.outTangent,c=e.inTangent,_=t.value,u=e.value,d=r*r,h=d*r,f=2*h-3*d+1,v=h-2*d+r,p=h-d,g=-2*h+3*d,y=0,m=_.length;y<m;++y)Number.isFinite(l[y])&&Number.isFinite(c[y])?o[y]=f*_[y]+v*l[y]*a+p*c[y]*a+g*u[y]:o[y]=t.value[y];return o},s}(pr),function(){ui._isCopyMode=!0}(),function(){ui._supportInterpolationMode=!0}(),ui);Li=R([Yt()],Li);var di,Vi=(di=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=!1,i}return s._initializeOwner=function(t){t.defaultValue=!1,t.fixedPoseValue=!1,t.baseEvaluateData.value=!1,t.crossEvaluateData.value=!1},s._initializeLayerOwner=function(t){t.finalValue=!1},s._lerpValue=function(t,e){return t},s._subtractValue=function(t,e,r){return t},s._getZeroValue=function(){return!1},s._additiveValue=function(t,e,r){return t},s._setValue=function(t){return t},s._hermiteInterpolationValue=function(t){return t.value},s}(pr),function(){di._isCopyMode=!1}(),function(){di._supportInterpolationMode=!1}(),di);Vi=R([Yt()],Vi);var hi,Ni=(hi=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=new j,i}return s._initializeOwner=function(t){t.defaultValue=new j,t.fixedPoseValue=new j,t.baseEvaluateData.value=new j,t.crossEvaluateData.value=new j},s._initializeLayerOwner=function(t){t.finalValue=new j},s._lerpValue=function(t,e,r,a){return j.lerp(t,e,r,a),a},s._subtractValue=function(t,e,r){return j.subtract(t,e,r),r},s._getZeroValue=function(t){return t.set(0,0,0,0),t},s._additiveValue=function(t,e,r){return j.scale(t,e,t),j.add(r,t,r),r},s._setValue=function(t,e){return e.copyFrom(t),e},s._hermiteInterpolationValue=function(t,e,r,a,o){var l=t.value,c=t.outTangent,_=e.value,u=e.inTangent,d=r*r,h=d*r,f=2*h-3*d+1,v=h-2*d+r,p=h-d,g=-2*h+3*d,y=c.x,m=u.x;return Number.isFinite(y)&&Number.isFinite(m)?o.r=f*l.r+v*y*a+p*m*a+g*_.r:o.r=l.r,y=c.y,m=u.y,Number.isFinite(y)&&Number.isFinite(m)?o.g=f*l.g+v*y*a+p*m*a+g*_.g:o.g=l.g,y=c.z,m=u.z,Number.isFinite(y)&&Number.isFinite(m)?o.b=f*l.b+v*y*a+p*m*a+g*_.b:o.b=l.b,y=c.w,m=u.w,Number.isFinite(y)&&Number.isFinite(m)?o.a=f*l.a+v*y*a+p*m*a+g*_.a:o.a=l.a,o},s}(pr),function(){hi._isCopyMode=!0}(),function(){hi._supportInterpolationMode=!0}(),hi);Ni=R([Yt()],Ni);var fi,Xa=(fi=function(n){W(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.addKey=function(e){n.prototype.addKey.call(this,e);var r=this._evaluateData;if(!r.value||r.value.length!==e.value.length){var a=e.value.length;r.value=new Float32Array(a)}},s._initializeOwner=function(e){var r=e.referenceTargetValue.length;e.defaultValue=new Float32Array(r),e.fixedPoseValue=new Float32Array(r),e.baseEvaluateData.value=new Float32Array(r),e.crossEvaluateData.value=new Float32Array(r)},s._initializeLayerOwner=function(e){var r=e.curveOwner.referenceTargetValue.length;e.finalValue=new Float32Array(r)},s._lerpValue=function(e,r,a,o){for(var l=0,c=o.length;l<c;++l){var _=e[l];o[l]=_+(r[l]-_)*a}return o},s._subtractValue=function(e,r,a){for(var o=0,l=e.length;o<l;o++)a[o]=e[o]-r[o];return a},s._getZeroValue=function(e){for(var r=0,a=e.length;r<a;r++)e[r]=0;return e},s._additiveValue=function(e,r,a){for(var o=0,l=a.length;o<l;++o)a[o]+=e[o]*r;return a},s._setValue=function(e,r){for(var a=0,o=r.length;a<o;++a)r[a]=e[a];return r},s._hermiteInterpolationValue=function(e,r,a,o,l){for(var c=e.outTangent,_=r.inTangent,u=e.value,d=r.value,h=a*a,f=h*a,v=2*f-3*h+1,p=f-2*h+a,g=f-h,y=-2*f+3*h,m=0,x=u.length;m<x;++m)Number.isFinite(c[m])&&Number.isFinite(_[m])?l[m]=v*u[m]+p*c[m]*o+g*_[m]*o+y*d[m]:l[m]=e.value[m];return l},s}(pr),function(){fi._isCopyMode=!0}(),function(){fi._supportInterpolationMode=!0}(),fi);Xa=R([Yt()],Xa);var vi,Ii=(vi=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=0,i}return s._initializeOwner=function(t){t.defaultValue=0,t.fixedPoseValue=0,t.baseEvaluateData.value=0,t.crossEvaluateData.value=0},s._initializeLayerOwner=function(t){t.finalValue=0},s._lerpValue=function(t,e,r){return t+(e-t)*r},s._additiveValue=function(t,e,r){return r+=t*e},s._subtractValue=function(t,e){return t-e},s._getZeroValue=function(){return 0},s._setValue=function(t){return t},s._hermiteInterpolationValue=function(t,e,r,a){var o=t.outTangent,l=e.inTangent;if(Number.isFinite(o)&&Number.isFinite(l)){var c=r*r,_=c*r,u=2*_-3*c+1,d=_-2*c+r,h=_-c,f=-2*_+3*c;return u*t.value+d*o*a+h*l*a+f*e.value}else return t.value},s}(pr),function(){vi._isCopyMode=!1}(),function(){vi._supportInterpolationMode=!0}(),vi);Ii=R([Yt()],Ii);var Pa,xa=(Pa=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=new ye,i}return s._initializeOwner=function(t){t.defaultValue=new ye,t.fixedPoseValue=new ye,t.baseEvaluateData.value=new ye,t.crossEvaluateData.value=new ye},s._initializeLayerOwner=function(t){t.finalValue=new ye},s._lerpValue=function(t,e,r,a){return ye.slerp(t,e,r,a),a},s._additiveValue=function(t,e,r){return t.x=t.x*e,t.y=t.y*e,t.z=t.z*e,t.normalize(),r.multiply(t),r},s._subtractValue=function(t,e,r){var a=xa._tempConjugateQuat;return ye.conjugate(e,a),ye.multiply(a,t,r),r},s._getZeroValue=function(t){return t.set(0,0,0,1),t},s._setValue=function(t,e){return e.copyFrom(t),e},s._hermiteInterpolationValue=function(t,e,r,a,o){var l=t.value,c=t.outTangent,_=e.value,u=e.inTangent,d=r*r,h=d*r,f=2*h-3*d+1,v=h-2*d+r,p=h-d,g=-2*h+3*d,y=c.x,m=u.x;return Number.isFinite(y)&&Number.isFinite(m)?o.x=f*l.x+v*y*a+p*m*a+g*_.x:o.x=l.x,y=c.y,m=u.y,Number.isFinite(y)&&Number.isFinite(m)?o.y=f*l.y+v*y*a+p*m*a+g*_.y:o.y=l.y,y=c.z,m=u.z,Number.isFinite(y)&&Number.isFinite(m)?o.z=f*l.z+v*y*a+p*m*a+g*_.z:o.z=l.z,y=c.w,m=u.w,Number.isFinite(y)&&Number.isFinite(m)?o.w=f*l.w+v*y*a+p*m*a+g*_.w:o.w=l.w,o},s}(pr),function(){Pa._supportInterpolationMode=!0}(),function(){Pa._isCopyMode=!0}(),function(){Pa._tempConjugateQuat=new ye}(),Pa);xa=R([Yt()],xa);var pi,Fi=(pi=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=new $,i}return s._initializeOwner=function(t){t.defaultValue=new $,t.fixedPoseValue=new $,t.baseEvaluateData.value=new $,t.crossEvaluateData.value=new $},s._initializeLayerOwner=function(t){t.finalValue=new $},s._lerpValue=function(t,e,r,a){return $.lerp(t,e,r,a),a},s._additiveValue=function(t,e,r){return $.scale(t,e,t),$.add(r,t,r),r},s._subtractValue=function(t,e,r){return $.subtract(t,e,r),r},s._getZeroValue=function(t){return t.set(0,0),t},s._setValue=function(t,e){return e.copyFrom(t),e},s._hermiteInterpolationValue=function(t,e,r,a,o){var l=t.value,c=t.outTangent,_=e.value,u=e.inTangent,d=r*r,h=d*r,f=2*h-3*d+1,v=h-2*d+r,p=h-d,g=-2*h+3*d,y=c.x,m=u.x;return Number.isFinite(y)&&Number.isFinite(m)?o.x=f*l.x+v*y*a+p*m*a+g*_.x:o.x=l.x,y=c.y,m=u.y,Number.isFinite(y)&&Number.isFinite(m)?o.y=f*l.y+v*y*a+p*m*a+g*_.y:o.y=l.y,o},s}(pr),function(){pi._isCopyMode=!0}(),function(){pi._supportInterpolationMode=!0}(),pi);Fi=R([Yt()],Fi);var gi,ja=(gi=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=new w,i}return s._initializeOwner=function(t){t.defaultValue=new w,t.fixedPoseValue=new w,t.baseEvaluateData.value=new w,t.crossEvaluateData.value=new w},s._initializeLayerOwner=function(t){t.finalValue=new w},s._lerpValue=function(t,e,r,a){return w.lerp(t,e,r,a),a},s._relativeBaseValue=function(t,e){return w.subtract(e,t,e),e},s._additiveValue=function(t,e,r){return w.scale(t,e,t),w.add(r,t,r),r},s._subtractValue=function(t,e,r){return w.subtract(t,e,r),r},s._getZeroValue=function(t){return t.set(0,0,0),t},s._setValue=function(t,e){return e.copyFrom(t),e},s._hermiteInterpolationValue=function(t,e,r,a,o){var l=t.value,c=t.outTangent,_=e.value,u=e.inTangent,d=r*r,h=d*r,f=2*h-3*d+1,v=h-2*d+r,p=h-d,g=-2*h+3*d,y=c.x,m=u.x;return Number.isFinite(y)&&Number.isFinite(m)?o.x=f*l.x+v*y*a+p*m*a+g*_.x:o.x=l.x,y=c.y,m=u.y,Number.isFinite(y)&&Number.isFinite(m)?o.y=f*l.y+v*y*a+p*m*a+g*_.y:o.y=l.y,y=c.z,m=u.z,Number.isFinite(y)&&Number.isFinite(m)?o.z=f*l.z+v*y*a+p*m*a+g*_.z:o.z=l.z,o},s}(pr),function(){gi._isCopyMode=!0}(),function(){gi._supportInterpolationMode=!0}(),gi);ja=R([Yt()],ja);var mi,Oi=(mi=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=new ae,i}return s._initializeOwner=function(t){t.defaultValue=new ae,t.fixedPoseValue=new ae,t.baseEvaluateData.value=new ae,t.crossEvaluateData.value=new ae},s._initializeLayerOwner=function(t){t.finalValue=new ae},s._lerpValue=function(t,e,r,a){return ae.lerp(t,e,r,a),a},s._additiveValue=function(t,e,r){return ae.scale(t,e,t),ae.add(r,t,r),r},s._subtractValue=function(t,e,r){return ae.subtract(t,e,r),r},s._getZeroValue=function(t){return t.set(0,0,0,0),t},s._setValue=function(t,e){return e.copyFrom(t),e},s._hermiteInterpolationValue=function(t,e,r,a,o){var l=t.value,c=t.outTangent,_=e.value,u=e.inTangent,d=r*r,h=d*r,f=2*h-3*d+1,v=h-2*d+r,p=h-d,g=-2*h+3*d,y=c.x,m=u.x;return Number.isFinite(y)&&Number.isFinite(m)?o.x=f*l.x+v*y*a+p*m*a+g*_.x:o.x=l.x,y=c.y,m=u.y,Number.isFinite(y)&&Number.isFinite(m)?o.y=f*l.y+v*y*a+p*m*a+g*_.y:o.y=l.y,y=c.z,m=u.z,Number.isFinite(y)&&Number.isFinite(m)?o.z=f*l.z+v*y*a+p*m*a+g*_.z:o.z=l.z,y=c.w,m=u.w,Number.isFinite(y)&&Number.isFinite(m)?o.w=f*l.w+v*y*a+p*m*a+g*_.w:o.w=l.w,o},s}(pr),function(){mi._isCopyMode=!0}(),function(){mi._supportInterpolationMode=!0}(),mi);Oi=R([Yt()],Oi);var yi,zi=(yi=function(n){W(s,n);function s(){return n.call(this)}return s._initializeOwner=function(t){},s._initializeLayerOwner=function(t){},s._setValue=function(t){return t},s}(pr),function(){yi._isCopyMode=!1}(),function(){yi._supportInterpolationMode=!1}(),yi);zi=R([Yt()],zi);var xi,Co=(xi=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value=new qr,i}return s._initializeOwner=function(t){t.defaultValue=new qr,t.fixedPoseValue=new qr,t.baseEvaluateData.value=new qr,t.crossEvaluateData.value=new qr},s._initializeLayerOwner=function(t){t.finalValue=new qr},s._setValue=function(t,e){return e.copyFrom(t),e},s}(pr),function(){xi._isCopyMode=!0}(),function(){xi._supportInterpolationMode=!1}(),xi);Co=R([Yt()],Co);var bi,Ui=(bi=function(n){W(s,n);function s(){var i;return i=n.call(this)||this,i._evaluateData.value="",i}return s._initializeOwner=function(t){t.defaultValue="",t.fixedPoseValue="",t.baseEvaluateData.value="",t.crossEvaluateData.value=""},s._initializeLayerOwner=function(t){t.finalValue=""},s._lerpValue=function(t,e){return t},s._subtractValue=function(t,e,r){return t},s._getZeroValue=function(){return""},s._additiveValue=function(t,e,r){return t},s._setValue=function(t){return t},s._hermiteInterpolationValue=function(t){return t.value},s}(pr),function(){bi._isCopyMode=!1}(),function(){bi._supportInterpolationMode=!1}(),bi);Ui=R([Yt()],Ui);var qa;(function(n){n[n.None=0]="None",n[n.Complete=1]="Complete"})(qa||(qa={}));var Ya;(function(n){n[n.Override=0]="Override",n[n.Additive=1]="Additive"})(Ya||(Ya={}));var xt;(function(n){n[n.UnStarted=0]="UnStarted",n[n.Playing=1]="Playing",n[n.Finished=2]="Finished"})(xt||(xt={}));var Ze;(function(n){n[n.Standby=0]="Standby",n[n.Playing=1]="Playing",n[n.CrossFading=2]="CrossFading",n[n.FixedCrossFading=3]="FixedCrossFading",n[n.Finished=4]="Finished"})(Ze||(Ze={}));var qd=function(){function n(){this.handlers=[]}var s=n.prototype;return s.dispose=function(){},n}(),Jo=function(){this.duration=0,this.offset=0,this.exitTime=1},Qa;(function(n){n[n.Once=0]="Once",n[n.Loop=1]="Loop"})(Qa||(Qa={}));var Ps=function(){function n(){}var s=n.prototype;return s.reset=function(t,e,r){this.state=t,this.frameTime=r,this.stateData=e,this.playState=xt.UnStarted,this.clipTime=t.clipStartTime*t.clip.length,this.currentEventIndex=0,this.currentTransitionIndex=0},s.update=function(t){var e=this.state,r=this.frameTime,a=e._getDuration();this.playState=xt.Playing,e.wrapMode===Qa.Loop?r=a?r%a:0:Math.abs(r)>a&&(r=r<0?-a:a,this.playState=xt.Finished),t&&r===0?this.clipTime=e.clipEndTime*e.clip.length:(r<0&&(r+=a),this.clipTime=r+e.clipStartTime*e.clip.length)},n}(),Yd=function(){function n(){this.curveOwnerPool=Object.create(null),this.animatorStateDataMap={},this.srcPlayData=new Ps,this.destPlayData=new Ps,this.layerState=Ze.Standby,this.crossCurveMark=0,this.manuallyTransition=new Jo,this.crossLayerOwnerCollection=[]}var s=n.prototype;return s.switchPlayData=function(){var t=this.destPlayData,e=this.srcPlayData;this.srcPlayData=t,this.destPlayData=e},n}(),Qd=function(){this.curveLayerOwner=[],this.eventHandlers=[]},nn=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e.cullingMode=qa.None,e.speed=1,e._playFrameCount=-1,e._onUpdateIndex=-1,e._updateMark=0,e._animatorLayersData=[],e._curveOwnerPool=Object.create(null),e._animationEventHandlerPool=new Wn(qd),e._tempAnimatorStateInfo={layerIndex:-1,state:null},e._controlledRenderers=[],e}var i=s.prototype;return i.play=function(e,r,a){r===void 0&&(r=-1),a===void 0&&(a=0);var o;(o=this._controllerUpdateFlag)!=null&&o.flag&&this._reset(),this._playFrameCount=this.engine.time.frameCount;var l=this._getAnimatorStateInfo(e,r),c=l.state,_=l.layerIndex;if(!!c){if(!c.clip){ve.warn("The state named "+e+" has no AnimationClip data.");return}var u=this._getAnimatorLayerData(_),d=this._getAnimatorStateData(e,c,u,_);this._preparePlay(u,c),u.layerState=Ze.Playing,u.srcPlayData.reset(c,d,c._getDuration()*a),this.update(0)}},i.crossFade=function(e,r,a,o){a===void 0&&(a=-1),o===void 0&&(o=0);var l;(l=this._controllerUpdateFlag)!=null&&l.flag&&this._reset(),this._playFrameCount=this.engine.time.frameCount;var c=this._getAnimatorStateInfo(e,a),_=c.state,u=c.layerIndex,d=this._getAnimatorLayerData(u).manuallyTransition;d.duration=r,d.offset=o,d.destinationState=_,this._crossFadeByTransition(d,u)&&this.update(0)},i.update=function(e){var r,a;if(this.cullingMode===qa.Complete){a=!1;for(var o=this._controlledRenderers,l=0,c=o.length;l<c;l++)if(!o[l].isCulled){a=!0;break}}else a=!0;var _=this,u=_._animatorController;if(!!u){if((r=this._controllerUpdateFlag)!=null&&r.flag){this._checkAutoPlay();return}this._updateMark++;for(var d=0,h=u.layers.length;d<h;d++){var f=this._getAnimatorLayerData(d);f.layerState!==Ze.Standby&&this._updateLayer(d,d===0,e,a)}}},i.getCurrentAnimatorState=function(e){var r,a;return(a=this._animatorLayersData[e])==null||(r=a.srcPlayData)==null?void 0:r.state},i.findAnimatorState=function(e,r){return r===void 0&&(r=-1),this._getAnimatorStateInfo(e,r).state},i._onEnable=function(){this.animatorController&&this._checkAutoPlay(),this._entity.getComponentsIncludeChildren(be,this._controlledRenderers)},i._onEnableInScene=function(){this.scene._componentsManager.addOnUpdateAnimations(this)},i._onDisableInScene=function(){this.scene._componentsManager.removeOnUpdateAnimations(this)},i._reset=function(){var e=this,r=e._curveOwnerPool;for(var a in r){var o=r[a];for(var l in o){var c=o[l];c.revertDefaultValue()}}this._animatorLayersData.length=0,this._curveOwnerPool={},this._animationEventHandlerPool.resetPool(),this._controllerUpdateFlag&&(this._controllerUpdateFlag.flag=!1)},i._getAnimatorStateInfo=function(e,r){var a=this,o=a._animatorController,l=a._tempAnimatorStateInfo,c=null;if(o){var _=o.layers;if(r===-1){for(var u=0,d=_.length;u<d;u++)if(c=_[u].stateMachine.findStateByName(e),c){r=u;break}}else c=_[r].stateMachine.findStateByName(e)}return l.layerIndex=r,l.state=c,l},i._getAnimatorStateData=function(e,r,a,o){var l=a.animatorStateDataMap,c=l[e];return c||(c=new Qd,l[e]=c,this._saveAnimatorStateData(r,c,a,o),this._saveAnimatorEventHandlers(r,c)),c},i._saveAnimatorStateData=function(e,r,a,o){for(var l=this,c=l.entity,_=l._curveOwnerPool,u=this._animatorController.layers[o].mask,d=r.curveLayerOwner,h=e.clip,f=h._curveBindings,v=a.curveOwnerPool,p=f.length-1;p>=0;p--){var g=f[p],y=g.relativePath,m=g.relativePath===""?c:c.findByPath(g.relativePath);if(m){var x,S,b,A,C,E,T,B,M=""+g.typeIndex+"."+g.property,P=g.typeIndex>0?m.getComponents(g.type,wn._components)[g.typeIndex]:m.getComponent(g.type);if(!P)continue;var V=g.property,N=m.instanceId,F=(x=_)[S=N]||(x[S]=Object.create(null)),O=(b=F)[A=V]||(b[A]=g._createCurveOwner(m,P)),D=(C=v)[E=N]||(C[E]=Object.create(null)),z=(T=D)[B=M]||(T[B]=g._createCurveLayerOwner(O));if(u&&u.pathMasks.length){var U,Y;z.isActive=(Y=(U=u.getPathMask(y))==null?void 0:U.active)!=null?Y:!0}d[p]=z}else d[p]=null,ve.warn("The entity don't have the child entity which path is "+g.relativePath+".")}},i._saveAnimatorEventHandlers=function(e,r){var a=this,o=this._animationEventHandlerPool,l=[],c=r.eventHandlers,_=function(){a._entity.getComponents(Jt,l);var u=l.length,d=e.clip.events;c.length=0;for(var h=0,f=d.length;h<f;h++){var v=d[h],p=o.getFromPool(),g=v.functionName,y=p.handlers;p.event=v,y.length=0;for(var m=u-1;m>=0;m--){var x=l[m][g];x&&y.push(x)}c.push(p)}};_(),e._updateFlagManager.addListener(_)},i._clearCrossData=function(e){e.crossCurveMark++,e.crossLayerOwnerCollection.length=0},i._addCrossOwner=function(e,r,a,o){r.crossSrcCurveIndex=a,r.crossDestCurveIndex=o,e.crossLayerOwnerCollection.push(r)},i._prepareCrossFading=function(e){this._prepareSrcCrossData(e,!1),this._prepareDestCrossData(e,!1)},i._prepareStandbyCrossFading=function(e){e.srcPlayData.state&&this._prepareSrcCrossData(e,!0),this._prepareDestCrossData(e,!0)},i._prepareFixedPoseCrossFading=function(e){for(var r=e.crossLayerOwnerCollection,a=r.length-1;a>=0;a--){var o=r[a];!o||(o.curveOwner.saveFixedPoseValue(),o.crossDestCurveIndex=-1)}this._prepareDestCrossData(e,!0)},i._prepareSrcCrossData=function(e,r){for(var a=e.srcPlayData.stateData.curveLayerOwner,o=a.length-1;o>=0;o--){var l=a[o];!l||(l.crossCurveMark=e.crossCurveMark,r&&l.curveOwner.saveFixedPoseValue(),this._addCrossOwner(e,l,o,-1))}},i._prepareDestCrossData=function(e,r){for(var a=e.destPlayData.stateData.curveLayerOwner,o=a.length-1;o>=0;o--){var l=a[o];if(!!l)if(l.crossCurveMark===e.crossCurveMark)l.crossDestCurveIndex=o;else{var c=l.curveOwner;r&&c.saveFixedPoseValue(),l.crossCurveMark=e.crossCurveMark,this._addCrossOwner(e,l,-1,o)}}},i._getAnimatorLayerData=function(e){var r=this._animatorLayersData[e];return r||(this._animatorLayersData[e]=r=new Yd),r},i._updateLayer=function(e,r,a,o){var l=this._animatorController.layers[e],c=l.blendingMode,_=l.weight,u=this._animatorLayersData[e],d=u.srcPlayData,h=u.destPlayData,f=c===Ya.Additive;switch(r&&(_=1),u.layerState){case Ze.Playing:this._updatePlayingState(d,u,e,_,a,f,o);break;case Ze.FixedCrossFading:this._updateCrossFadeFromPose(h,u,e,_,a,f,o);break;case Ze.CrossFading:this._updateCrossFade(d,h,u,e,_,a,f,o);break;case Ze.Finished:this._updateFinishedState(d,_,f,o);break}},i._updatePlayingState=function(e,r,a,o,l,c,_){var u=e.stateData,d=u.curveLayerOwner,h=u.eventHandlers,f=e.state,v=e.playState,p=e.clipTime,g=f.transitions,y=f.clip,m=y._curveBindings,x=f.speed*this.speed;e.frameTime+=x*l,e.update(x<0);var S=e.clipTime,b=e.playState,A=b===xt.Finished;if(_||A)for(var C=m.length-1;C>=0;C--){var E,T=d[C],B=(E=T)==null?void 0:E.curveOwner;if(!(!B||!T.isActive)){var M=m[C].curve;if(M.keys.length){this._checkRevertOwner(B,c);var P=B.evaluateValue(M,S,c);_&&B.applyValue(P,o,c),A&&T.saveFinalValue()}}}if(b===xt.Finished&&(r.layerState=Ze.Finished),h.length&&this._fireAnimationEvents(e,h,p,S),v===xt.UnStarted&&this._callAnimatorScriptOnEnter(f,a),b===xt.Finished?this._callAnimatorScriptOnExit(f,a):this._callAnimatorScriptOnUpdate(f,a),g.length){var V=r.layerState;V!==Ze.CrossFading&&V!==Ze.FixedCrossFading&&this._checkTransition(e,g,a,p,S)}},i._updateCrossFade=function(e,r,a,o,l,c,_,u){var d=this.speed,h=a.crossLayerOwnerCollection,f=e.state.clip,v=f._curveBindings,p=e.state,g=e.stateData,y=e.playState,m=g.eventHandlers,x=r.state,S=r.stateData,b=r.playState,A=S.eventHandlers,C=x.clip,E=C._curveBindings,T=e.clipTime,B=r.clipTime,M=x._getDuration()*a.crossFadeTransition.duration,P=Math.abs(r.frameTime)/M;(P>=1||M===0)&&(P=1);var V=p.speed*d,N=x.speed*d;e.frameTime+=V*c,r.frameTime+=N*c,e.update(V<0),r.update(N<0);var F=e.clipTime,O=e.playState,D=r.clipTime,z=r.playState,U=r.playState===xt.Finished;if(u||U)for(var Y=h.length-1;Y>=0;Y--){var K,H=h[Y],te=(K=H)==null?void 0:K.curveOwner;if(!!te){var we=H.crossSrcCurveIndex,pe=H.crossDestCurveIndex;this._checkRevertOwner(te,_);var oe=te.evaluateCrossFadeValue(we>=0?v[we].curve:null,pe>=0?E[pe].curve:null,F,D,P,_);u&&te.applyValue(oe,l,_),U&&H.saveFinalValue()}}this._updateCrossFadeData(a,P),m.length&&this._fireAnimationEvents(e,m,T,F),A.length&&this._fireAnimationEvents(r,A,B,D),y===xt.UnStarted&&this._callAnimatorScriptOnEnter(p,o),P===1||O===xt.Finished?this._callAnimatorScriptOnExit(p,o):this._callAnimatorScriptOnUpdate(p,o),b===xt.UnStarted&&this._callAnimatorScriptOnEnter(x,o),z===xt.Finished?this._callAnimatorScriptOnExit(x,o):this._callAnimatorScriptOnUpdate(x,o)},i._updateCrossFadeFromPose=function(e,r,a,o,l,c,_){var u=r.crossLayerOwnerCollection,d=e.state,h=e.stateData,f=e.playState,v=h.eventHandlers,p=d.clip,g=p._curveBindings,y=e.clipTime,m=d._getDuration()*r.crossFadeTransition.duration,x=Math.abs(e.frameTime)/m;(x>=1||m===0)&&(x=1);var S=d.speed*this.speed;e.frameTime+=S*l,e.update(S<0);var b=e.clipTime,A=e.playState,C=A===xt.Finished;if(_||C)for(var E=u.length-1;E>=0;E--){var T,B=u[E],M=(T=B)==null?void 0:T.curveOwner;if(!!M){var P=B.crossDestCurveIndex;this._checkRevertOwner(M,c);var V=B.curveOwner.crossFadeFromPoseAndApplyValue(P>=0?g[P].curve:null,b,x,c);_&&M.applyValue(V,o,c),C&&B.saveFinalValue()}}this._updateCrossFadeData(r,x),v.length&&this._fireAnimationEvents(e,v,y,b),f===xt.UnStarted&&this._callAnimatorScriptOnEnter(d,a),A===xt.Finished?this._callAnimatorScriptOnExit(d,a):this._callAnimatorScriptOnUpdate(d,a)},i._updateFinishedState=function(e,r,a,o){if(!!o)for(var l=e.stateData.curveLayerOwner,c=e.state.clip,_=c._curveBindings,u=_.length-1;u>=0;u--){var d,h=l[u],f=(d=h)==null?void 0:d.curveOwner;!f||(this._checkRevertOwner(f,a),f.applyValue(h.finalValue,r,a))}},i._updateCrossFadeData=function(e,r){var a=e.destPlayData;r===1&&(a.playState===xt.Finished?e.layerState=Ze.Finished:e.layerState=Ze.Playing,e.switchPlayData(),e.crossFadeTransition=null)},i._preparePlay=function(e,r){if(e.layerState===Ze.Playing){var a=e.srcPlayData;if(a.state!==r)for(var o=a.stateData.curveLayerOwner,l=o.length-1;l>=0;l--){var c;(c=o[l])==null||c.curveOwner.revertDefaultValue()}}else for(var _=e.crossLayerOwnerCollection,u=_.length-1;u>=0;u--)_[u].curveOwner.revertDefaultValue()},i._checkTransition=function(e,r,a,o,l){var c=e.state,_=c.clip.length;this.speed*c.speed>=0?l<o?(this._checkSubTransition(e,r,a,o,c.clipEndTime*_),e.currentTransitionIndex=0,this._checkSubTransition(e,r,a,c.clipStartTime*_,l)):this._checkSubTransition(e,r,a,o,l):l>o?(this._checkBackwardsSubTransition(e,r,a,o,c.clipStartTime*_),e.currentTransitionIndex=r.length-1,this._checkBackwardsSubTransition(e,r,a,l,c.clipEndTime*_)):this._checkBackwardsSubTransition(e,r,a,o,l)},i._checkSubTransition=function(e,r,a,o,l){for(var c=e.currentTransitionIndex,_=e.state._getDuration(),u=r.length;c<u;c++){var d=r[c],h=d.exitTime*_;if(h>l)break;h>=o&&(this._crossFadeByTransition(d,a),e.currentTransitionIndex=Math.min(c+1,u-1))}},i._checkBackwardsSubTransition=function(e,r,a,o,l){for(var c=e.currentTransitionIndex,_=e.state._getDuration();c>=0;c--){var u=r[c],d=u.exitTime*_;if(d<l)break;d<=o&&(this._crossFadeByTransition(u,a),e.currentTransitionIndex=Math.max(c-1,0))}},i._crossFadeByTransition=function(e,r){var a=e.destinationState;if(!a)return!1;if(!a.clip)return ve.warn("The state named "+name+" has no AnimationClip data."),!1;var o=this._getAnimatorLayerData(r),l=o.layerState,c=o.destPlayData,_=this._getAnimatorStateData(a.name,a,o,r),u=a._getDuration(),d=u*e.offset;switch(c.reset(a,_,d),l){case Ze.Standby:case Ze.Finished:o.layerState=Ze.FixedCrossFading,this._clearCrossData(o),this._prepareStandbyCrossFading(o);break;case Ze.Playing:o.layerState=Ze.CrossFading,this._clearCrossData(o),this._prepareCrossFading(o);break;case Ze.CrossFading:o.layerState=Ze.FixedCrossFading,this._prepareFixedPoseCrossFading(o);break;case Ze.FixedCrossFading:this._prepareFixedPoseCrossFading(o);break}return o.crossFadeTransition=e,!0},i._fireAnimationEvents=function(e,r,a,o){var l=e.state,c=l.clip.length;this.speed*l.speed>=0?o<a?(this._fireSubAnimationEvents(e,r,a,l.clipEndTime*c),e.currentEventIndex=0,this._fireSubAnimationEvents(e,r,l.clipStartTime*c,o)):this._fireSubAnimationEvents(e,r,a,o):o>a?(this._fireBackwardSubAnimationEvents(e,r,a,l.clipStartTime*c),e.currentEventIndex=r.length-1,this._fireBackwardSubAnimationEvents(e,r,l.clipEndTime*c,o)):this._fireBackwardSubAnimationEvents(e,r,a,o)},i._fireSubAnimationEvents=function(e,r,a,o){for(var l=e.currentEventIndex,c=r.length;l<c;l++){var _=r[l],u=_.event,d=u.time,h=u.parameter;if(d>o)break;var f=_.handlers;if(d>=a){for(var v=f.length-1;v>=0;v--)f[v](h);e.currentEventIndex=Math.min(l+1,c-1)}}},i._fireBackwardSubAnimationEvents=function(e,r,a,o){for(var l=e.currentEventIndex;l>=0;l--){var c=r[l],_=c.event,u=_.time,d=_.parameter;if(u<o)break;if(u<=a){for(var h=c.handlers,f=h.length-1;f>=0;f--)h[f](d);e.currentEventIndex=Math.max(l-1,0)}}},i._callAnimatorScriptOnEnter=function(e,r){for(var a=e._onStateEnterScripts,o=0,l=a.length;o<l;o++)a[o].onStateEnter(this,e,r)},i._callAnimatorScriptOnUpdate=function(e,r){for(var a=e._onStateUpdateScripts,o=0,l=a.length;o<l;o++)a[o].onStateUpdate(this,e,r)},i._callAnimatorScriptOnExit=function(e,r){for(var a=e._onStateExitScripts,o=0,l=a.length;o<l;o++)a[o].onStateExit(this,e,r)},i._checkAutoPlay=function(){for(var e=this._animatorController.layers,r=0,a=e.length;r<a;++r){var o,l=e[r].stateMachine;(o=l)!=null&&o.defaultState&&this.play(l.defaultState.name,r)}},i._checkRevertOwner=function(e,r){r&&e.updateMark!==this._updateMark&&e.revertDefaultValue(),e.updateMark=this._updateMark},q(s,[{key:"animatorController",get:function(){return this._animatorController},set:function(e){e!==this._animatorController&&(this._reset(),this._controllerUpdateFlag&&this._controllerUpdateFlag.destroy(),this._controllerUpdateFlag=e&&e._registerChangeFlag(),this._animatorController=e)}}]),s}(Vt);R([Pe],nn.prototype,"speed",void 0);R([I],nn.prototype,"_controllerUpdateFlag",void 0);R([I],nn.prototype,"_updateMark",void 0);R([I],nn.prototype,"_animatorLayersData",void 0);R([I],nn.prototype,"_curveOwnerPool",void 0);R([I],nn.prototype,"_animationEventHandlerPool",void 0);R([I],nn.prototype,"_tempAnimatorStateInfo",void 0);R([I],nn.prototype,"_controlledRenderers",void 0);var Zo=function(){function n(){this._updateFlagManager=new zr,this._layers=[],this._layersMap={}}var s=n.prototype;return s.findLayerByName=function(t){return this._layersMap[t]},s.addLayer=function(t){this._layers.push(t),this._layersMap[t.name]=t,this._updateFlagManager.dispatch()},s.removeLayer=function(t){var e=this.layers[t];this._layers.splice(t,1),delete this._layersMap[e.name],this._updateFlagManager.dispatch()},s.clearLayers=function(){this._layers.length=0;for(var t in this._layersMap)delete this._layersMap[t];this._updateFlagManager.dispatch()},s._registerChangeFlag=function(){return this._updateFlagManager.createFlag(Qi)},q(n,[{key:"layers",get:function(){return this._layers}}]),n}(),$o=function(s){this.name=s,this.weight=1,this.blendingMode=Ya.Override},So=function(){function n(){this._destroyed=!1}var s=n.prototype;return s.onStateEnter=function(t,e,r){},s.onStateUpdate=function(t,e,r){},s.onStateExit=function(t,e,r){},s.destroy=function(){this._destroyed||(this._state._removeStateMachineScript(this),this._destroyed=!0)},n}(),Pc=function(){function n(i){this.name=i,this.speed=1,this.wrapMode=Qa.Loop,this._onStateEnterScripts=[],this._onStateUpdateScripts=[],this._onStateExitScripts=[],this._updateFlagManager=new zr,this._clipStartTime=0,this._clipEndTime=1,this._transitions=[],this._onClipChanged=this._onClipChanged.bind(this)}var s=n.prototype;return s.addTransition=function(t){var e=this._transitions,r=e.length,a=t.exitTime,o=r?e[r-1].exitTime:0;if(a>=o)e.push(t);else{for(var l=r;--l>=0&&a<e[l].exitTime;);e.splice(l+1,0,t)}},s.removeTransition=function(t){var e=this._transitions.indexOf(t);e!==-1&&this._transitions.splice(e,1)},s.addStateMachineScript=function(t){var e=new t;e._state=this;var r=So.prototype;return e.onStateEnter!==r.onStateEnter&&this._onStateEnterScripts.push(e),e.onStateUpdate!==r.onStateUpdate&&this._onStateUpdateScripts.push(e),e.onStateExit!==r.onStateExit&&this._onStateExitScripts.push(e),e},s.clearTransitions=function(){this._transitions.length=0},s._getDuration=function(){return this.clip?(this._clipEndTime-this._clipStartTime)*this.clip.length:null},s._removeStateMachineScript=function(t){var e=So.prototype;if(t.onStateEnter!==e.onStateEnter){var r=this._onStateEnterScripts.indexOf(t);r!==-1&&this._onStateEnterScripts.splice(r,1)}if(t.onStateUpdate!==e.onStateUpdate){var a=this._onStateUpdateScripts.indexOf(t);a!==-1&&this._onStateUpdateScripts.splice(a,1)}if(t.onStateExit!==e.onStateExit){var o=this._onStateExitScripts.indexOf(t);o!==-1&&this._onStateExitScripts.splice(o,1)}},s._onClipChanged=function(){this._updateFlagManager.dispatch()},q(n,[{key:"transitions",get:function(){return this._transitions}},{key:"clip",get:function(){return this._clip},set:function(t){var e=this._clip;e!==t&&(e&&e._updateFlagManager.removeListener(this._onClipChanged),this._clip=t,this._clipEndTime=Math.min(this._clipEndTime,1),this._onClipChanged(),t&&t._updateFlagManager.addListener(this._onClipChanged))}},{key:"clipStartTime",get:function(){return this._clipStartTime},set:function(t){this._clipStartTime=Math.max(t,0)}},{key:"clipEndTime",get:function(){return this._clipEndTime},set:function(t){this._clipEndTime=Math.min(t,1)}}]),n}(),es=function(){function n(){this.states=[],this._statesMap={}}var s=n.prototype;return s.addState=function(t){var e=this.findStateByName(t);return e?console.warn("The state named "+t+" has existed."):(e=new Pc(t),this.states.push(e),this._statesMap[t]=e),e},s.removeState=function(t){var e=t.name,r=this.states.indexOf(t);r>-1&&this.states.splice(r,1),delete this._statesMap[e]},s.findStateByName=function(t){return this._statesMap[t]},s.makeUniqueStateName=function(t){for(var e=this._statesMap,r=t,a=0;e[t];)t=r+" "+a,a++;return t},n}(),Ao;(function(n){n[n.If=0]="If",n[n.IfNot=1]="IfNot",n[n.Greater=2]="Greater",n[n.Less=3]="Less",n[n.Equals=4]="Equals",n[n.NotEquals=5]="NotEquals"})(Ao||(Ao={}));var Gt=function(){},Kd=function(){},Jd=function(){function n(){this._pathMasks=[],this._pathMaskMap={}}var s=n.prototype;return s.addPathMask=function(t){var e=this._pathMaskMap[t];if(e)return e;var r=new Kd;return r.path=t,r.active=!0,this._pathMasks.push(r),this._pathMaskMap[t]=r,r},s.removePathMask=function(t){for(var e=this,r=e._pathMasks,a=0,o=this._pathMasks.length;a<o;++a)if(r[a].path===t){r.splice(a,1),delete this._pathMaskMap[t];break}},s.getPathMask=function(t){return this._pathMaskMap[t]},s.setPathMaskActive=function(t,e,r){r===void 0&&(r=!1);var a=this._pathMaskMap[t];if(a&&(a.active=e),r)for(var o in this._pathMaskMap)o.startsWith(t)&&(this._pathMaskMap[o].active=e)},n.createByEntity=function(t){var e=new n;return e.addPathMask(""),n._addPathMaskWithChildren(e,t,""),e},n._addPathMaskWithChildren=function(t,e,r){for(var a=e.children,o=0,l=a.length;o<l;++o){var c=a[o],_=r?r+"/"+c.name:c.name;t.addPathMask(_),n._addPathMaskWithChildren(t,c,_)}},q(n,[{key:"pathMasks",get:function(){return this._pathMasks}}]),n}(),Ra=function(n){W(s,n);function s(t){var e;return e=n.call(this,t,ne.find("skybox"))||this,e._textureDecodeRGBM=!1,e._tintColor=new j(1,1,1,1),e.renderState.rasterState.cullMode=Xt.Off,e.renderState.depthState.compareFunction=Te.LessEqual,e.shaderData.setFloat(s._rotationProp,0),e.shaderData.setFloat(s._exposureProp,1),e.shaderData.setColor(s._tintColorProp,e._tintColor),e}var i=s.prototype;return i.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},q(s,[{key:"textureDecodeRGBM",get:function(){return this._textureDecodeRGBM},set:function(e){this._textureDecodeRGBM=e,e?this.shaderData.enableMacro(s._decodeSkyRGBMMacro):this.shaderData.disableMacro(s._decodeSkyRGBMMacro)}},{key:"texture",get:function(){return this.shaderData.getTexture(s._textureCubeProp)},set:function(e){this.shaderData.setTexture(s._textureCubeProp,e)}},{key:"rotation",get:function(){return this.shaderData.getFloat(s._rotationProp)},set:function(e){this.shaderData.setFloat(s._rotationProp,e)}},{key:"exposure",get:function(){return this.shaderData.getFloat(s._exposureProp)},set:function(e){this.shaderData.setFloat(s._exposureProp,e)}},{key:"tintColor",get:function(){return this._tintColor},set:function(e){this._tintColor!=e&&this._tintColor.copyFrom(e)}}]),s}(Mr);(function(){Ra._tintColorProp=L.getByName("material_TintColor")})();(function(){Ra._textureCubeProp=L.getByName("material_CubeTexture")})();(function(){Ra._rotationProp=L.getByName("material_Rotation")})();(function(){Ra._exposureProp=L.getByName("material_Exposure")})();(function(){Ra._decodeSkyRGBMMacro=ie.getByName("MATERIAL_IS_DECODE_SKY_RGBM")})();var wo;(function(n){n[n.None=0]="None",n[n.Simple=1]="Simple",n[n.HighQuality=2]="HighQuality"})(wo||(wo={}));var En=function(n){W(s,n);function s(t){var e;return e=n.call(this,t,ne.find("SkyProcedural"))||this,e.sunMode=2,e.sunSize=.04,e.sunSizeConvergence=5,e.atmosphereThickness=1,e.skyTint=new j(.5,.5,.5,1),e.groundTint=new j(.369,.349,.341,1),e.exposure=1.3,e.renderState.rasterState.cullMode=Xt.Off,e.renderState.depthState.compareFunction=Te.LessEqual,e}var i=s.prototype;return i.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},q(s,[{key:"sunMode",get:function(){return this._sunDisk},set:function(e){var r=this.shaderData;switch(e){case 2:r.disableMacro(s._sunSimpleMacro),r.enableMacro(s._sunHighQualityMacro);break;case 1:r.disableMacro(s._sunHighQualityMacro),r.enableMacro(s._sunSimpleMacro);break;case 0:r.disableMacro(s._sunHighQualityMacro),r.disableMacro(s._sunSimpleMacro);break;default:throw"SkyBoxProceduralMaterial: unknown sun value."}this._sunDisk=e}},{key:"sunSize",get:function(){return this.shaderData.getFloat(s._sunSizeProp)},set:function(e){this.shaderData.setFloat(s._sunSizeProp,Math.min(Math.max(0,e),1))}},{key:"sunSizeConvergence",get:function(){return this.shaderData.getFloat(s._sunSizeConvergenceProp)},set:function(e){this.shaderData.setFloat(s._sunSizeConvergenceProp,Math.min(Math.max(0,e),20))}},{key:"atmosphereThickness",get:function(){return this.shaderData.getFloat(s._atmosphereThicknessProp)},set:function(e){this.shaderData.setFloat(s._atmosphereThicknessProp,Math.min(Math.max(0,e),5))}},{key:"skyTint",get:function(){return this.shaderData.getColor(s._skyTintProp)},set:function(e){this.shaderData.setColor(s._skyTintProp,e)}},{key:"groundTint",get:function(){return this.shaderData.getColor(s._groundTintProp)},set:function(e){this.shaderData.setColor(s._groundTintProp,e)}},{key:"exposure",get:function(){return this.shaderData.getFloat(s._exposureProp)},set:function(e){this.shaderData.setFloat(s._exposureProp,Math.min(Math.max(0,e),8))}}]),s}(Mr);(function(){En._sunSizeProp=L.getByName("material_SunSize")})();(function(){En._sunSizeConvergenceProp=L.getByName("material_SunSizeConvergence")})();(function(){En._atmosphereThicknessProp=L.getByName("material_AtmosphereThickness")})();(function(){En._skyTintProp=L.getByName("material_SkyTint")})();(function(){En._groundTintProp=L.getByName("material_GroundTint")})();(function(){En._exposureProp=L.getByName("material_Exposure")})();(function(){En._sunHighQualityMacro=ie.getByName("MATERIAL_SUN_HIGH_QUALITY")})();(function(){En._sunSimpleMacro=ie.getByName("MATERIAL_SUN_SIMPLE")})();var Zd=function(){},Ar;(function(n){n[n.Billboard=0]="Billboard",n[n.StretchBillboard=1]="StretchBillboard",n[n.HorizontalBillboard=2]="HorizontalBillboard",n[n.VerticalBillboard=3]="VerticalBillboard",n[n.Mesh=4]="Mesh",n[n.None=5]="None"})(Ar||(Ar={}));var ba;(function(n){n[n.StopEmittingAndClear=0]="StopEmittingAndClear",n[n.StopEmitting=1]="StopEmitting"})(ba||(ba={}));var Ot=function(n){W(s,n);function s(t){var e;return e=n.call(this,t)||this,e.generator=new ze(ue(e)),e.velocityScale=0,e.lengthScale=2,e.pivot=new w,e._currentRenderModeMacro=s._billboardModeMacro,e.shaderData.enableMacro(s._billboardModeMacro),e._supportInstancedArrays=e.engine._hardwareRenderer.canIUse(Q.instancedArrays),e._dirtyUpdateFlag|=$e.WorldVolume,e}var i=s.prototype;return i._onEnable=function(){this.generator.main.playOnEnabled&&this.generator.play(!1)},i._onDisable=function(){this.generator.stop(!1,ba.StopEmittingAndClear)},i._prepareRender=function(e){if(!!this._supportInstancedArrays){var r=this.generator;r._update(this.engine.time.deltaTime),r._firstActiveElement!==r._firstFreeElement&&n.prototype._prepareRender.call(this,e)}},i._updateBounds=function(e){e.min.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),e.max.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},i._updateShaderData=function(e,r){var a=this.shaderData;a.setFloat(s._lengthScale,this.lengthScale),a.setFloat(s._speedScale,this.velocityScale),a.setFloat(s._currentTime,this.generator._playTime),a.setVector3(s._pivotOffsetProperty,this.pivot),this.generator._updateShaderData(a)},i._render=function(e){var r=this.generator;r._primitive.instanceCount=r._getAliveParticleCount();var a=this.getMaterial();if(!!a){(a.destroyed||a.shader.destroyed)&&(a=this.engine._particleMagentaMaterial);var o=this._engine._renderDataPool.getFromPool();o.setX(this,a,r._primitive,r._subPrimitive),e.camera._renderPipeline.pushRenderData(e,o)}},i._onDestroy=function(){n.prototype._onDestroy.call(this);var e=this._mesh;e&&(e.destroyed||this._addResourceReferCount(e,-1)),this.generator._destroy()},q(s,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){if(this._renderMode!==e){var r=this._renderMode;this._renderMode=e;var a=null,o=this.shaderData;switch(e){case Ar.Billboard:a=s._billboardModeMacro;break;case Ar.StretchBillboard:a=s._stretchedBillboardModeMacro;break;case Ar.HorizontalBillboard:throw"Not implemented";case Ar.VerticalBillboard:throw"Not implemented";case Ar.Mesh:throw"Not implemented"}this._currentRenderModeMacro!==a&&(this._currentRenderModeMacro&&o.disableMacro(this._currentRenderModeMacro),a&&o.enableMacro(a),this._currentRenderModeMacro=a),r!==Ar.Mesh!=(e===Ar.Mesh)&&this.generator._reorganizeGeometryBuffers()}}},{key:"mesh",get:function(){return this._mesh},set:function(e){var r=this._mesh;r!==e&&(this._mesh=e,r&&this._addResourceReferCount(r,-1),e&&this._addResourceReferCount(e,1),this.renderMode===Ar.Mesh&&this.generator._reorganizeGeometryBuffers())}}]),s}(be);(function(){Ot._billboardModeMacro=ie.getByName("RENDERER_MODE_SPHERE_BILLBOARD")})();(function(){Ot._stretchedBillboardModeMacro=ie.getByName("RENDERER_MODE_STRETCHED_BILLBOARD")})();(function(){Ot._horizontalBillboardModeMacro=ie.getByName("RENDERER_MODE_HORIZONTAL_BILLBOARD")})();(function(){Ot._verticalBillboardModeMacro=ie.getByName("RENDERER_MODE_VERTICAL_BILLBOARD")})();(function(){Ot._renderModeMeshMacro=ie.getByName("RENDERER_MODE_MESH")})();(function(){Ot._pivotOffsetProperty=L.getByName("renderer_PivotOffset")})();(function(){Ot._lengthScale=L.getByName("renderer_StretchedBillboardLengthScale")})();(function(){Ot._speedScale=L.getByName("renderer_StretchedBillboardSpeedScale")})();(function(){Ot._currentTime=L.getByName("renderer_CurrentTime")})();R([Z],Ot.prototype,"generator",void 0);R([zo],Ot.prototype,"pivot",void 0);var fe;(function(n){n[n.Constant=0]="Constant",n[n.TwoConstants=1]="TwoConstants",n[n.Curve=2]="Curve",n[n.TwoCurves=3]="TwoCurves"})(fe||(fe={}));var $t;(function(n){n[n.Constant=0]="Constant",n[n.TwoConstants=1]="TwoConstants",n[n.Gradient=2]="Gradient",n[n.TwoGradients=3]="TwoGradients"})($t||($t={}));var pn;(function(n){n[n.Local=0]="Local",n[n.World=1]="World"})(pn||(pn={}));var je;(function(n){n[n.Burst=592910910]="Burst",n[n.StartDelay=322376503]="StartDelay",n[n.StartColor=306581307]="StartColor",n[n.StartSize=1793934638]="StartSize",n[n.StartRotation=3737431713]="StartRotation",n[n.randomizeRotationDirection=2527743459]="randomizeRotationDirection",n[n.StartLifetime=2368504881]="StartLifetime",n[n.StartSpeed=4085612399]="StartSpeed",n[n.VelocityOverLifetime=3774601268]="VelocityOverLifetime",n[n.ColorOverLifetime=326370691]="ColorOverLifetime",n[n.SizeOverLifetime=1494990940]="SizeOverLifetime",n[n.RotationOverLifetime=1089181156]="RotationOverLifetime",n[n.TextureSheetAnimation=197469413]="TextureSheetAnimation",n[n.Shape=2941263940]="Shape",n[n.GravityModifier=2759560269]="GravityModifier"})(je||(je={}));var Nn=function(){function n(i,t){if(i===void 0&&(i=null),t===void 0&&(t=null),this._colorKeys=[],this._alphaKeys=[],this._colorTypeArrayDirty=!1,this._alphaTypeArrayDirty=!1,i)for(var e=0,r=i.length;e<r;e++){var a=i[e];this.addColorKey(a)}if(t)for(var o=0,l=t.length;o<l;o++){var c=t[o];this.addAlphaKey(c)}}var s=n.prototype;return s.addColorKey=function(t,e){var r=this._colorKeys;if(r.length===4)throw new Error("Gradient can only have 4 color keys");var a=typeof t=="number"?new ki(t,e):t;a._onValueChanged=this._setColorTypeArrayDirty.bind(this),this._addKey(r,a),this._colorTypeArrayDirty=!0},s.addAlphaKey=function(t,e){var r=this._alphaKeys;if(r.length===4)throw new Error("Gradient can only have 4 alpha keys");var a=typeof t=="number"?new Gi(t,e):t;a._onValueChanged=this._setAlphaTypeArrayDirty.bind(this),this._addKey(r,a),this._alphaTypeArrayDirty=!0},s.removeColorKey=function(t){this._colorKeys[t]._onValueChanged=null,this._removeKey(this._colorKeys,t),this._colorTypeArrayDirty=!0},s.removeAlphaKey=function(t){this._alphaKeys[t]._onValueChanged=null,this._removeKey(this._alphaKeys,t),this._alphaTypeArrayDirty=!0},s.setKeys=function(t,e){for(var r=this._colorKeys,a=this._alphaKeys,o=0,l=r.length;o<l;o++)r[o]._onValueChanged=null;for(var c=0,_=a.length;c<_;c++)a[c]._onValueChanged=null;r.length=0,a.length=0;for(var u=0,d=t.length;u<d;u++)this._addKey(r,t[u]);for(var h=0,f=e.length;h<f;h++)this._addKey(a,e[h]);this._alphaTypeArrayDirty=!0,this._colorTypeArrayDirty=!0},s._getColorTypeArray=function(t){var e=this._colorTypeArray||(this._colorTypeArray=new Float32Array(16));if(this._colorTypeArrayDirty){for(var r=this._colorKeys,a=0,o=Math.min(r.length,4);a<o;a++){var l=a*4,c=r[a];e[l]=c.time;var _=c.color;t===dr.Linear?(e[l+1]=j.gammaToLinearSpace(_.r),e[l+2]=j.gammaToLinearSpace(_.g),e[l+3]=j.gammaToLinearSpace(_.b)):(e[l+1]=_.r,e[l+2]=_.g,e[l+3]=_.b)}this._colorTypeArrayDirty=!1}return e},s._getAlphaTypeArray=function(){var t=this._alphaTypeArray||(this._alphaTypeArray=new Float32Array(8));if(this._alphaTypeArrayDirty){for(var e=this._alphaKeys,r=0,a=Math.min(e.length,4);r<a;r++){var o=r*2,l=e[r];t[o]=l.time,t[o+1]=l.alpha}this._alphaTypeArrayDirty=!1}return t},s._addKey=function(t,e){var r=e.time,a=t.length,o=a?t[a-1].time:0;if(r>=o)t.push(e);else{for(var l=a;--l>=0&&r<t[l].time;);t.splice(l+1,0,e)}},s._removeKey=function(t,e){t.splice(e,1)},s._setColorTypeArrayDirty=function(){this._colorTypeArrayDirty=!0},s._setAlphaTypeArrayDirty=function(){this._alphaTypeArrayDirty=!0},q(n,[{key:"colorKeys",get:function(){return this._colorKeys}},{key:"alphaKeys",get:function(){return this._alphaKeys}}]),n}();R([Z],Nn.prototype,"_colorKeys",void 0);R([Z],Nn.prototype,"_alphaKeys",void 0);R([I],Nn.prototype,"_colorTypeArray",void 0);R([I],Nn.prototype,"_alphaTypeArray",void 0);var ki=function(){function n(s,i){this._onValueChanged=null,this._color=new j,this._time=s,i&&this._color.copyFrom(i),this._color._onValueChanged=this._onValueChanged}return q(n,[{key:"time",get:function(){return this._time},set:function(i){this._time=i,this._onValueChanged&&this._onValueChanged()}},{key:"color",get:function(){return this._color},set:function(i){this._color!==i&&this._color.copyFrom(i)}}]),n}(),Gi=function(){function n(s,i){this._onValueChanged=null,this._time=s,this._alpha=i}return q(n,[{key:"time",get:function(){return this._time},set:function(i){this._time=i,this._onValueChanged&&this._onValueChanged()}},{key:"alpha",get:function(){return this._alpha},set:function(i){this._alpha=i,this._onValueChanged&&this._onValueChanged()}}]),n}(),ia=function(){function n(i,t){this.mode=$t.Constant,this.constantMin=new j,this.constantMax=new j,this.gradientMin=new Nn,this.gradientMax=new Nn,i.constructor===j?t?(this.constantMin.copyFrom(i),this.constantMax.copyFrom(t),this.mode=$t.TwoConstants):(this.constant.copyFrom(i),this.mode=$t.Constant):t?(this.gradientMin=i,this.gradientMax=t,this.mode=$t.TwoGradients):(this.gradient=i,this.mode=$t.Gradient)}var s=n.prototype;return s.evaluate=function(t,e,r){switch(this.mode){case $t.Constant:r.copyFrom(this.constant);break;case $t.TwoConstants:j.lerp(this.constantMin,this.constantMax,e,r);break}},q(n,[{key:"constant",get:function(){return this.constantMax},set:function(t){this.constantMax=t}},{key:"gradient",get:function(){return this.gradientMax},set:function(t){this.gradientMax=t}}]),n}();R([Z],ia.prototype,"constantMin",void 0);R([Z],ia.prototype,"constantMax",void 0);R([Z],ia.prototype,"gradientMin",void 0);R([Z],ia.prototype,"gradientMax",void 0);var oa=function(){function n(i){this.enabled=!1,this._generator=i}var s=n.prototype;return s._enableMacro=function(t,e,r){return e!==r&&(e&&t.disableMacro(e),r&&t.enableMacro(r)),r},n}();R([I],oa.prototype,"_generator",void 0);var gr=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.color=new ia(new Nn([new ki(0,new j(1,1,1)),new ki(1,new j(1,1,1))],[new Gi(0,1),new Gi(1,1)])),t._colorGradientRand=new wr(0,je.ColorOverLifetime),t._gradientKeysCount=new ae(0,0,0,0),t}var i=s.prototype;return i._updateShaderData=function(e){var r=null;if(this.enabled){var a=this.color.mode;if(a!==$t.Gradient&&a!==$t.TwoGradients)throw new Error("Invalid color mode, only gradient and two gradients are supported in color over lifetime.");var o=this.color,l=this._generator._renderer.engine.settings.colorSpace;e.setFloatArray(s._maxGradientColor,o.gradientMax._getColorTypeArray(l)),e.setFloatArray(s._maxGradientAlpha,o.gradientMax._getAlphaTypeArray()),a===$t.Gradient?r=s._gradientMacro:(e.setFloatArray(s._minGradientColor,o.gradientMin._getColorTypeArray(l)),e.setFloatArray(s._minGradientAlpha,o.gradientMin._getAlphaTypeArray()),r=s._randomGradientsMacro);var c=o.gradientMin.colorKeys,_=o.gradientMin.alphaKeys,u=o.gradientMax.colorKeys,d=o.gradientMax.alphaKeys;this._gradientKeysCount.set(c.length?c[c.length-1].time:0,_.length?_[_.length-1].time:0,u.length?u[u.length-1].time:0,d.length?d[d.length-1].time:0),e.setVector4(s._gradientKeysCount,this._gradientKeysCount)}this._colorMacro=this._enableMacro(e,this._colorMacro,r)},i._resetRandomSeed=function(e){this._colorGradientRand.reset(e,je.ColorOverLifetime)},s}(oa);(function(){gr._gradientMacro=ie.getByName("RENDERER_COL_GRADIENT")})();(function(){gr._randomGradientsMacro=ie.getByName("RENDERER_COL_RANDOM_GRADIENTS")})();(function(){gr._minGradientColor=L.getByName("renderer_COLMinGradientColor")})();(function(){gr._minGradientAlpha=L.getByName("renderer_COLMinGradientAlpha")})();(function(){gr._maxGradientColor=L.getByName("renderer_COLMaxGradientColor")})();(function(){gr._maxGradientAlpha=L.getByName("renderer_COLMaxGradientAlpha")})();(function(){gr._gradientKeysCount=L.getByName("renderer_COLGradientKeysMaxTime")})();R([Z],gr.prototype,"color",void 0);R([I],gr.prototype,"_colorGradientRand",void 0);R([I],gr.prototype,"_gradientKeysCount",void 0);R([I],gr.prototype,"_colorMacro",void 0);var He=function(){function n(i,t){this.mode=fe.Constant,this.constantMin=0,this.constantMax=0,typeof i=="number"?t?(this.constantMin=i,this.constantMax=t,this.mode=fe.TwoConstants):(this.constant=i,this.mode=fe.Constant):t?(this.curveMin=i,this.curveMax=t,this.mode=fe.TwoCurves):(this.curve=i,this.mode=fe.Curve)}var s=n.prototype;return s.evaluate=function(t,e){switch(this.mode){case fe.Constant:return this.constant;case fe.TwoConstants:return this.constantMin+(this.constantMax-this.constantMin)*e}},q(n,[{key:"constant",get:function(){return this.constantMax},set:function(t){this.constantMax=t}},{key:"curve",get:function(){return this.curveMax},set:function(t){this.curveMax=t}}]),n}();R([Z],He.prototype,"curveMin",void 0);R([Z],He.prototype,"curveMax",void 0);var zn=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.rateOverTime=new He(10),t.rateOverDistance=new He(0),t._shapeRand=new wr(0,je.Shape),t._frameRateTime=0,t._bursts=[],t._currentBurstIndex=0,t._burstRand=new wr(0,je.Burst),t}var i=s.prototype;return i.addBurst=function(e){for(var r=this._bursts,a=r.length;--a>=0&&e.time<r[a].time;);r.splice(a+1,0,e)},i.removeBurst=function(e){var r=this._bursts.indexOf(e);r!==-1&&this._bursts.splice(r,1)},i.removeBurstByIndex=function(e){this._bursts.splice(e,1)},i.clearBurst=function(){this._bursts.length=0},i._emit=function(e,r){this._emitByRateOverTime(r),this._emitByBurst(e,r)},i._resetRandomSeed=function(e){this._burstRand.reset(e,je.Burst),this._shapeRand.reset(e,je.Shape)},i._reset=function(){this._frameRateTime=0,this._currentBurstIndex=0},i._emitByRateOverTime=function(e){var r=this.rateOverTime.evaluate(void 0,void 0);if(r>0)for(var a=this._generator,o=1/r,l=e-this._frameRateTime;l>=o;)l-=o,this._frameRateTime+=o,a._emit(this._frameRateTime,1)},i._emitByBurst=function(e,r){var a=this._generator.main,o=a.duration,l=Math.floor((r-e)/o);if(a.isLoop&&(l>0||r%o<e%o)){var c=Math.ceil(e/o)*o;this._emitBySubBurst(e,c,o),this._currentBurstIndex=0;for(var _=0;_<l;_++){var u=c;c+=o,this._emitBySubBurst(u,c,o),this._currentBurstIndex=0}this._emitBySubBurst(c,r,o)}else this._emitBySubBurst(e,r,o)},i._emitBySubBurst=function(e,r,a){for(var o=this._generator,l=this._burstRand,c=this.bursts,_=Math.floor(e/a)*a,u=e%a,d=u+(r-e),h=this._currentBurstIndex,f=c.length;h<f;h++){var v=c[h],p=v.time;if(p>d)break;if(p>=u){var g=v.count.evaluate(void 0,l.random());o._emit(_+p,g)}}this._currentBurstIndex=h},q(s,[{key:"bursts",get:function(){return this._bursts}}]),s}(oa);R([Z],zn.prototype,"rateOverTime",void 0);R([Z],zn.prototype,"rateOverDistance",void 0);R([Z],zn.prototype,"shape",void 0);R([I],zn.prototype,"_shapeRand",void 0);R([Z],zn.prototype,"_bursts",void 0);R([I],zn.prototype,"_burstRand",void 0);var jr;(function(n){n[n.Hierarchy=0]="Hierarchy",n[n.Local=1]="Local",n[n.World=2]="World"})(jr||(jr={}));var Le=function(){function n(i){this.duration=5,this.isLoop=!0,this.startDelay=new He(0),this.startLifetime=new He(5),this.startSpeed=new He(5),this.startSize3D=!1,this.startSizeX=new He(1),this.startSizeY=new He(1),this.startSizeZ=new He(1),this.startRotation3D=!1,this.startRotationX=new He(0),this.startRotationY=new He(0),this.startRotationZ=new He(0),this.flipRotation=0,this.startColor=new ia(new j(1,1,1,1)),this.gravityModifier=new He(0),this.simulationSpace=pn.Local,this.simulationSpeed=1,this.scalingMode=jr.Local,this.playOnEnabled=!0,this._maxParticleBuffer=1e3,this._startSpeedRand=new wr(0,je.StartSpeed),this._startLifeTimeRand=new wr(0,je.StartLifetime),this._startColorRand=new wr(0,je.StartColor),this._startSizeRand=new wr(0,je.StartSize),this._startRotationRand=new wr(0,je.StartRotation),this._gravityModifierRand=new wr(0,je.GravityModifier),this._gravity=new w,this._generator=i}var s=n.prototype;return s._resetRandomSeed=function(t){this._startSpeedRand.reset(t,je.StartSpeed),this._startLifeTimeRand.reset(t,je.StartLifetime),this._startColorRand.reset(t,je.StartColor),this._startSizeRand.reset(t,je.StartSize),this._startRotationRand.reset(t,je.StartRotation)},s._getPositionScale=function(){var t=this._generator._renderer.entity.transform;switch(this.scalingMode){case jr.Hierarchy:case jr.World:return t.lossyWorldScale;case jr.Local:return t.scale}},s._updateShaderData=function(t){var e=this._generator._renderer,r=e.entity.transform;switch(this.simulationSpace){case pn.Local:t.setVector3(n._worldPosition,r.worldPosition);var a=r.worldRotationQuaternion,o=n._tempVector40;o.copyFrom(a),t.setVector4(n._worldRotation,o);break;case pn.World:break;default:throw new Error("ParticleRenderer: SimulationSpace value is invalid.")}switch(this.scalingMode){case jr.Hierarchy:var l=r.lossyWorldScale;t.setVector3(n._positionScale,l),t.setVector3(n._sizeScale,l);break;case jr.Local:var l=r.scale;t.setVector3(n._positionScale,l),t.setVector3(n._sizeScale,l);break;case jr.World:t.setVector3(n._positionScale,r.lossyWorldScale),t.setVector3(n._sizeScale,n._vector3One);break}var c=this._gravity,_=this.gravityModifier.evaluate(void 0,this._gravityModifierRand.random());w.scale(e.scene.physics.gravity,_,c),t.setVector3(n._gravity,c),t.setInt(n._simulationSpace,this.simulationSpace),t.setFloat(n._startRotation3D,+this.startRotation3D),t.setInt(n._scaleMode,this.scalingMode)},s._cloneTo=function(t){t.maxParticles=this.maxParticles},q(n,[{key:"maxParticles",get:function(){return this._maxParticleBuffer-1},set:function(t){this._maxParticleBuffer=t+1}},{key:"startSize",get:function(){return this.startSizeX},set:function(t){this.startSizeX=t}}]),n}();(function(){Le._tempVector40=new ae})();(function(){Le._vector3One=new w(1,1,1)})();(function(){Le._positionScale=L.getByName("renderer_PositionScale")})();(function(){Le._sizeScale=L.getByName("renderer_SizeScale")})();(function(){Le._worldPosition=L.getByName("renderer_WorldPosition")})();(function(){Le._worldRotation=L.getByName("renderer_WorldRotation")})();(function(){Le._gravity=L.getByName("renderer_Gravity")})();(function(){Le._simulationSpace=L.getByName("renderer_SimulationSpace")})();(function(){Le._startRotation3D=L.getByName("renderer_ThreeDStartRotation")})();(function(){Le._scaleMode=L.getByName("renderer_ScalingMode")})();R([Z],Le.prototype,"startDelay",void 0);R([Z],Le.prototype,"startLifetime",void 0);R([Z],Le.prototype,"startSpeed",void 0);R([Z],Le.prototype,"startSizeX",void 0);R([Z],Le.prototype,"startSizeY",void 0);R([Z],Le.prototype,"startSizeZ",void 0);R([Z],Le.prototype,"startRotationX",void 0);R([Z],Le.prototype,"startRotationY",void 0);R([Z],Le.prototype,"startRotationZ",void 0);R([Z],Le.prototype,"startColor",void 0);R([Z],Le.prototype,"gravityModifier",void 0);R([I],Le.prototype,"_maxParticleBuffer",void 0);R([I],Le.prototype,"_startSpeedRand",void 0);R([I],Le.prototype,"_startLifeTimeRand",void 0);R([I],Le.prototype,"_startColorRand",void 0);R([I],Le.prototype,"_startSizeRand",void 0);R([I],Le.prototype,"_startRotationRand",void 0);R([I],Le.prototype,"_gravityModifierRand",void 0);R([I],Le.prototype,"_generator",void 0);R([I],Le.prototype,"_gravity",void 0);var rt=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.separateAxes=!1,t.rotationX=new He(0),t.rotationY=new He(0),t.rotationZ=new He(45),t._rotationRand=new wr(0,je.RotationOverLifetime),t._rotationMinConstant=new w,t._rotationMaxConstant=new w,t}var i=s.prototype;return i._updateShaderData=function(e){var r=null,a=null,o=null;if(this.enabled){var l=this.rotationX,c=this.rotationY,_=this.rotationZ,u=this.separateAxes,d=u?l.mode===fe.TwoCurves&&c.mode===fe.TwoCurves&&_.mode===fe.TwoCurves:_.mode===fe.TwoCurves,h=d||u?l.mode===fe.Curve&&c.mode===fe.Curve&&_.mode===fe.Curve:_.mode===fe.Curve;if(h)e.setFloatArray(s._maxCurveZProperty,_.curveMax._getTypeArray()),u&&(e.setFloatArray(s._maxCurveXProperty,l.curveMax._getTypeArray()),e.setFloatArray(s._maxCurveYProperty,c.curveMax._getTypeArray())),d&&(e.setFloatArray(s._minCurveZProperty,_.curveMin._getTypeArray()),u&&(e.setFloatArray(s._minCurveXProperty,l.curveMin._getTypeArray()),e.setFloatArray(s._minCurveYProperty,c.curveMin._getTypeArray())),o=s._isRandomTwoMacro),a=s._curveModeMacro;else{var f=this._rotationMaxConstant;if(f.set(k.degreeToRadian(l.constantMax),k.degreeToRadian(c.constantMax),k.degreeToRadian(_.constantMax)),e.setVector3(s._maxConstantProperty,f),u?l.mode===fe.TwoConstants&&c.mode===fe.TwoConstants&&_.mode===fe.TwoConstants:_.mode===fe.TwoConstants){var v=this._rotationMinConstant;v.set(k.degreeToRadian(l.constantMin),k.degreeToRadian(c.constantMin),k.degreeToRadian(_.constantMin)),e.setVector3(s._minConstantProperty,v),o=s._isRandomTwoMacro}a=s._constantModeMacro}u&&(r=s._isSeparateMacro)}this._enableSeparateMacro=this._enableMacro(e,this._enableSeparateMacro,r),this._isCurveMacro=this._enableMacro(e,this._isCurveMacro,a),this._isRandomTwoMacro=this._enableMacro(e,this._isRandomTwoMacro,o)},i._resetRandomSeed=function(e){this._rotationRand.reset(e,je.RotationOverLifetime)},s}(oa);(function(){rt._constantModeMacro=ie.getByName("RENDERER_ROL_CONSTANT_MODE")})();(function(){rt._curveModeMacro=ie.getByName("RENDERER_ROL_CURVE_MODE")})();(function(){rt._isSeparateMacro=ie.getByName("RENDERER_ROL_IS_SEPARATE")})();(function(){rt._isRandomTwoMacro=ie.getByName("RENDERER_ROL_IS_RANDOM_TWO")})();(function(){rt._minConstantProperty=L.getByName("renderer_ROLMinConst")})();(function(){rt._minCurveXProperty=L.getByName("renderer_ROLMinCurveX")})();(function(){rt._minCurveYProperty=L.getByName("renderer_ROLMinCurveY")})();(function(){rt._minCurveZProperty=L.getByName("renderer_ROLMinCurveZ")})();(function(){rt._maxConstantProperty=L.getByName("renderer_ROLMaxConst")})();(function(){rt._maxCurveXProperty=L.getByName("renderer_ROLMaxCurveX")})();(function(){rt._maxCurveYProperty=L.getByName("renderer_ROLMaxCurveY")})();(function(){rt._maxCurveZProperty=L.getByName("renderer_ROLMaxCurveZ")})();R([Z],rt.prototype,"rotationX",void 0);R([Z],rt.prototype,"rotationY",void 0);R([Z],rt.prototype,"rotationZ",void 0);R([I],rt.prototype,"_rotationRand",void 0);R([I],rt.prototype,"_rotationMinConstant",void 0);R([I],rt.prototype,"_rotationMaxConstant",void 0);R([I],rt.prototype,"_enableSeparateMacro",void 0);R([I],rt.prototype,"_isCurveMacro",void 0);R([I],rt.prototype,"_isRandomTwoMacro",void 0);var Jn=function(){function n(){for(var i=arguments.length,t=new Array(i),e=0;e<i;e++)t[e]=arguments[e];this._keys=[],this._typeArrayDirty=!1;for(var r=0,a=t.length;r<a;r++){var o=t[r];this.addKey(o)}}var s=n.prototype;return s.addKey=function(t,e){var r=this._keys;if(r.length===4)throw new Error("Curve can only have 4 keys");var a=typeof t=="number"?new Yr(t,e):t;this._addKey(r,a),this._typeArrayDirty=!0},s.removeKey=function(t){this._keys.splice(t,1),this._typeArrayDirty=!0},s.setKeys=function(t){this._keys.length=0;for(var e=0,r=t.length;e<r;e++)this.addKey(t[e]);this._typeArrayDirty=!0},s._getTypeArray=function(){var t=this._typeArray||(this._typeArray=new Float32Array(8));if(this._typeArrayDirty){for(var e=this._keys,r=0,a=Math.min(e.length,4);r<a;r++){var o=r*2,l=e[r];t[o]=l.time,t[o+1]=l.value}this._typeArrayDirty=!1}return t},s._addKey=function(t,e){var r=t.length,a=e.time,o=r?t[r-1].time:0;if(a>=o)t.push(e);else{for(var l=r;--l>=0&&a<t[l].time;);t.splice(l+1,0,e)}},q(n,[{key:"keys",get:function(){return this._keys}}]),n}();R([Z],Jn.prototype,"_keys",void 0);R([I],Jn.prototype,"_typeArray",void 0);var Yr=function(s,i){this.time=s,this.value=i},Bt=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.separateAxes=!1,t.sizeX=new He(new Jn(new Yr(0,0),new Yr(1,1))),t.sizeY=new He(new Jn(new Yr(0,0),new Yr(1,1))),t.sizeZ=new He(new Jn(new Yr(0,0),new Yr(1,1))),t}var i=s.prototype;return i._updateShaderData=function(e){var r=null,a=null,o=null;if(this.enabled){var l=this.sizeX,c=this.sizeY,_=this.sizeZ,u=this.separateAxes,d=u?l.mode===fe.TwoCurves&&c.mode===fe.TwoCurves&&_.mode===fe.TwoCurves:l.mode===fe.TwoCurves,h=d||u?l.mode===fe.Curve&&c.mode===fe.Curve&&_.mode===fe.Curve:l.mode===fe.Curve;h&&(e.setFloatArray(s._maxCurveXProperty,l.curveMax._getTypeArray()),u&&(e.setFloatArray(s._maxCurveYProperty,c.curveMax._getTypeArray()),e.setFloatArray(s._maxCurveZProperty,_.curveMax._getTypeArray())),d&&(e.setFloatArray(s._minCurveXProperty,l.curveMin._getTypeArray()),u&&(e.setFloatArray(s._minCurveYProperty,c.curveMin._getTypeArray()),e.setFloatArray(s._minCurveZProperty,_.curveMin._getTypeArray())),o=s._isRandomTwoMacro),a=s._curveModeMacro),u&&(r=s._isSeparateMacro)}this._enableSeparateMacro=this._enableMacro(e,this._enableSeparateMacro,r),this._isCurveMacro=this._enableMacro(e,this._isCurveMacro,a),this._isRandomTwoMacro=this._enableMacro(e,this._isRandomTwoMacro,o)},q(s,[{key:"size",get:function(){return this.sizeX},set:function(e){this.sizeX=e}}]),s}(oa);(function(){Bt._curveModeMacro=ie.getByName("RENDERER_SOL_CURVE_MODE")})();(function(){Bt._isSeparateMacro=ie.getByName("RENDERER_SOL_IS_SEPARATE")})();(function(){Bt._isRandomTwoMacro=ie.getByName("RENDERER_SOL_IS_RANDOM_TWO")})();(function(){Bt._minCurveXProperty=L.getByName("renderer_SOLMinCurveX")})();(function(){Bt._minCurveYProperty=L.getByName("renderer_SOLMinCurveY")})();(function(){Bt._minCurveZProperty=L.getByName("renderer_SOLMinCurveZ")})();(function(){Bt._maxCurveXProperty=L.getByName("renderer_SOLMaxCurveX")})();(function(){Bt._maxCurveYProperty=L.getByName("renderer_SOLMaxCurveY")})();(function(){Bt._maxCurveZProperty=L.getByName("renderer_SOLMaxCurveZ")})();R([Z],Bt.prototype,"sizeX",void 0);R([Z],Bt.prototype,"sizeY",void 0);R([Z],Bt.prototype,"sizeZ",void 0);R([I],Bt.prototype,"_enableSeparateMacro",void 0);R([I],Bt.prototype,"_isCurveMacro",void 0);R([I],Bt.prototype,"_isRandomTwoMacro",void 0);var sr=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.startFrame=new He(0),t.frameOverTime=new He(new Jn(new Yr(0,0),new Yr(1,1))),t.type=0,t.cycleCount=1,t._tillingInfo=new w(1,1,1),t._frameOverTimeRand=new wr(0,je.TextureSheetAnimation),t._tiling=new $(1,1),t}var i=s.prototype;return i._updateShaderData=function(e){var r=null;if(this.enabled){var a=this.frameOverTime.mode;if(a===fe.Curve||a===fe.TwoCurves){var o=this.frameOverTime;e.setFloatArray(s._frameMaxCurveProperty,o.curveMax._getTypeArray()),a===fe.Curve?r=s._frameCurveMacro:(e.setFloatArray(s._frameMinCurveProperty,o.curveMin._getTypeArray()),r=s._frameRandomCurvesMacro),e.setFloat(s._cycleCountProperty,this.cycleCount),e.setVector3(s._tillingParamsProperty,this._tillingInfo)}}this._textureSheetMacro=this._enableMacro(e,this._textureSheetMacro,r)},i._resetRandomSeed=function(e){this._frameOverTimeRand.reset(e,je.TextureSheetAnimation)},q(s,[{key:"tiling",get:function(){return this._tiling},set:function(e){this._tiling=e,this._tillingInfo.set(1/e.x,1/e.y,e.x*e.y)}}]),s}(oa);(function(){sr._frameCurveMacro=ie.getByName("RENDERER_TSA_FRAME_CURVE")})();(function(){sr._frameRandomCurvesMacro=ie.getByName("RENDERER_TSA_FRAME_RANDOM_CURVES")})();(function(){sr._cycleCountProperty=L.getByName("renderer_TSACycles")})();(function(){sr._tillingParamsProperty=L.getByName("renderer_TSATillingParams")})();(function(){sr._frameMinCurveProperty=L.getByName("renderer_TSAFrameMinCurve")})();(function(){sr._frameMaxCurveProperty=L.getByName("renderer_TSAFrameMaxCurve")})();R([Z],sr.prototype,"startFrame",void 0);R([Z],sr.prototype,"frameOverTime",void 0);R([zo],sr.prototype,"_tillingInfo",void 0);R([I],sr.prototype,"_frameOverTimeRand",void 0);R([Z],sr.prototype,"_tiling",void 0);R([I],sr.prototype,"_textureSheetMacro",void 0);var Bs;(function(n){n[n.WholeSheet=0]="WholeSheet",n[n.SingleRow=1]="SingleRow"})(Bs||(Bs={}));var lt=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.velocityX=new He(0),t.velocityY=new He(0),t.velocityZ=new He(0),t.space=pn.Local,t._velocityRand=new wr(0,je.VelocityOverLifetime),t._velocityMinConstant=new w,t._velocityMaxConstant=new w,t}var i=s.prototype;return i._updateShaderData=function(e){var r=null;if(this.enabled){var a=this.velocityX,o=this.velocityY,l=this.velocityZ,c=a.mode===fe.TwoCurves&&o.mode===fe.TwoCurves&&l.mode===fe.TwoCurves;if(c||a.mode===fe.Curve&&o.mode===fe.Curve&&l.mode===fe.Curve)e.setFloatArray(s._maxGradientXProperty,a.curveMax._getTypeArray()),e.setFloatArray(s._maxGradientYProperty,o.curveMax._getTypeArray()),e.setFloatArray(s._maxGradientZProperty,l.curveMax._getTypeArray()),c?(e.setFloatArray(s._minGradientXProperty,a.curveMin._getTypeArray()),e.setFloatArray(s._minGradientYProperty,o.curveMin._getTypeArray()),e.setFloatArray(s._minGradientZProperty,l.curveMin._getTypeArray()),r=s._randomCurveMacro):r=s._curveMacro;else{var _=this._velocityMaxConstant;if(_.set(a.constantMax,o.constantMax,l.constantMax),e.setVector3(s._maxConstantProperty,_),a.mode===fe.TwoConstants&&o.mode===fe.TwoConstants&&l.mode===fe.TwoConstants){var u=this._velocityMinConstant;u.set(a.constantMin,o.constantMin,l.constantMin),e.setVector3(s._minConstantProperty,u),r=s._randomConstantMacro}else r=s._constantMacro}e.setInt(s._spaceProperty,this.space)}this._velocityMacro=this._enableMacro(e,this._velocityMacro,r)},i._resetRandomSeed=function(e){this._velocityRand.reset(e,je.VelocityOverLifetime)},s}(oa);(function(){lt._constantMacro=ie.getByName("RENDERER_VOL_CONSTANT")})();(function(){lt._curveMacro=ie.getByName("RENDERER_VOL_CURVE")})();(function(){lt._randomConstantMacro=ie.getByName("RENDERER_VOL_RANDOM_CONSTANT")})();(function(){lt._randomCurveMacro=ie.getByName("RENDERER_VOL_RANDOM_CURVE")})();(function(){lt._minConstantProperty=L.getByName("renderer_VOLMinConst")})();(function(){lt._maxConstantProperty=L.getByName("renderer_VOLMaxConst")})();(function(){lt._minGradientXProperty=L.getByName("renderer_VOLMinGradientX")})();(function(){lt._minGradientYProperty=L.getByName("renderer_VOLMinGradientY")})();(function(){lt._minGradientZProperty=L.getByName("renderer_VOLMinGradientZ")})();(function(){lt._maxGradientXProperty=L.getByName("renderer_VOLMaxGradientX")})();(function(){lt._maxGradientYProperty=L.getByName("renderer_VOLMaxGradientY")})();(function(){lt._maxGradientZProperty=L.getByName("renderer_VOLMaxGradientZ")})();(function(){lt._spaceProperty=L.getByName("renderer_VOLSpace")})();R([Z],lt.prototype,"velocityX",void 0);R([Z],lt.prototype,"velocityY",void 0);R([Z],lt.prototype,"velocityZ",void 0);R([I],lt.prototype,"_velocityRand",void 0);R([I],lt.prototype,"_velocityMinConstant",void 0);R([I],lt.prototype,"_velocityMaxConstant",void 0);R([I],lt.prototype,"_velocityMacro",void 0);var ze=function(){function n(i){this.useAutoRandomSeed=!0,this.main=new Le(this),this.emission=new zn(this),this.velocityOverLifetime=new lt(this),this.sizeOverLifetime=new Bt(this),this.rotationOverLifetime=new rt(this),this.colorOverLifetime=new gr(this),this.textureSheetAnimation=new sr(this),this._currentParticleCount=0,this._playTime=0,this._firstNewElement=0,this._firstActiveElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._vertexBufferBindings=new Array,this._subPrimitive=new Zi(0,0,kr.Triangles),this._isPlaying=!1,this._instanceBufferResized=!1,this._waitProcessRetiredElementCount=0,this._randomSeed=0,this._renderer=i;var t=new Zd;t.start=0,this._primitive=new ko(i.engine),this._reorganizeGeometryBuffers(),this._resizeInstanceBuffer(!0,n._particleIncreaseCount),this.emission.enabled=!0}var s=n.prototype;return s.play=function(t){if(t===void 0&&(t=!0),t)for(var e=this._renderer.entity.getComponentsIncludeChildren(Ot,n._tempParticleRenderers),r=0,a=e.length;r<a;r++){var o=e[r];o.generator.play(!1)}else this._isPlaying=!0,this.useAutoRandomSeed&&this._resetGlobalRandSeed(Math.floor(Math.random()*4294967295))},s.stop=function(t,e){if(t===void 0&&(t=!0),e===void 0&&(e=ba.StopEmitting),t)for(var r=this._renderer.entity.getComponentsIncludeChildren(Ot,n._tempParticleRenderers),a=0,o=r.length;a<o;a++){var l=r[a];l.generator.stop(!1,e)}else if(this._isPlaying=!1,e===ba.StopEmittingAndClear){var c=this._firstFreeElement;this._firstRetiredElement=c,this._firstActiveElement=c,this._firstNewElement=c,this._playTime=0,this.emission._reset()}},s.emit=function(t){this._emit(this._playTime,t)},s._emit=function(t,e){if(this.emission.enabled){if(this.main._maxParticleBuffer<this._currentParticleCount)return;for(var r=n._tempVector30,a=n._tempVector31,o=this._renderer.entity.transform,l=this.emission.shape,c=0;c<e;c++){var _;if((_=l)!=null&&_.enabled){l._generatePositionAndDirection(this.emission._shapeRand,t,r,a);var u=this.main._getPositionScale();r.multiply(u),a.normalize().multiply(u)}else r.set(0,0,0),a.set(0,0,-1);this._addNewParticle(r,a,o,t)}}},s._update=function(t){var e=this,r=e.main,a=e.emission,o=r.duration,l=this._playTime;if(this._playTime+=t*r.simulationSpeed,this._retireActiveParticles(),this._freeRetiredParticles(),a.enabled&&this._isPlaying){if(this._currentParticleCount>r._maxParticleBuffer){var c=this._getNotRetiredParticleCount();c<r._maxParticleBuffer&&this._resizeInstanceBuffer(!1)}a._emit(l,this._playTime),!r.isLoop&&this._playTime>o&&(this._isPlaying=!1)}if(!this.isAlive){var _=Math.min(a._frameRateTime,Math.floor(this._playTime/o)*o);this._playTime-=_,a._frameRateTime-=_}(this._firstNewElement!=this._firstFreeElement||this._waitProcessRetiredElementCount>0||this._instanceBufferResized||this._instanceVertexBufferBinding._buffer.isContentLost)&&this._addActiveParticlesToVertexBuffer()},s._reorganizeGeometryBuffers=function(){var t=this._renderer,e=t.engine._particleBufferUtils,r=this._primitive,a=this._vertexBufferBindings;if(r.clearVertexElements(),a.length=0,t.renderMode===Ar.Mesh){var o=t.mesh;if(!o)return;var l=o.getVertexElement(X.Position),c=o.getVertexElement(X.Color),_=o.getVertexElement(X.UV),u=l?o.vertexBufferBindings[l.bindingIndex]:null,d=c?o.vertexBufferBindings[c.bindingIndex]:null,h=_?o.vertexBufferBindings[_.bindingIndex]:null;if(u){var f=this._addVertexBufferBindingsFilterDuplicate(u,a);r.addVertexElement(new Me(X.Position,l.offset,l.format,f))}if(d){var v=this._addVertexBufferBindingsFilterDuplicate(d,a);r.addVertexElement(new Me(X.Color,c.offset,c.format,v))}if(h){var p=this._addVertexBufferBindingsFilterDuplicate(h,a);r.addVertexElement(new Me(X.UV,_.offset,_.format,p))}var g=o._primitive.indexBufferBinding;r.setIndexBufferBinding(g),this._subPrimitive.count=g.buffer.byteLength/r._glIndexByteCount}else r.addVertexElement(e.billboardVertexElement),a.push(e.billboardVertexBufferBinding),r.setIndexBufferBinding(e.billboardIndexBufferBinding),this._subPrimitive.count=e.billboardIndexCount;r.setVertexBufferBindings(a);for(var y=e.instanceVertexElements,m=a.length,x=0,S=y.length;x<S;x++){var b=y[x];r.addVertexElement(new Me(b.attribute,b.offset,b.format,m,b.instanceStepRate))}},s._resizeInstanceBuffer=function(t,e){var r;(r=this._instanceVertexBufferBinding)==null||r.buffer.destroy();var a=this._renderer.engine._particleBufferUtils,o=a.instanceVertexStride,l=t?this._currentParticleCount+e:this.main._maxParticleBuffer,c=o*l,_=this._renderer.engine,u=new ir(_,Nt.VertexBuffer,c,tt.Dynamic,!1);u.isGCIgnored=!0;var d=this._primitive.vertexBufferBindings,h=new $n(u,o),f=new Float32Array(c/4),v=this._instanceVertices;if(v){var p=a.instanceVertexFloatStride,g=this._firstFreeElement,y=this._firstRetiredElement;if(t){var m=this._firstFreeElement*p;f.set(new Float32Array(v.buffer,0,m));var x=(this._firstFreeElement+e)*p;f.set(new Float32Array(v.buffer,m*4),x),this._firstNewElement>g&&(this._firstNewElement+=e),this._firstActiveElement>g&&(this._firstActiveElement+=e),y>g&&(this._firstRetiredElement+=e)}else{var S,b;y<=g?(S=g-y,b=0,this._firstFreeElement-=y,this._firstNewElement-=y,this._firstActiveElement-=y,this._firstRetiredElement=0):(S=this._currentParticleCount-y,b=g,this._firstNewElement>g&&(this._firstNewElement-=g),this._firstActiveElement>g&&(this._firstActiveElement-=g),y>g&&(this._firstRetiredElement-=g)),f.set(new Float32Array(v.buffer,y*p*4,S*p),b*p)}this._instanceBufferResized=!0}this._primitive.setVertexBufferBinding(v?d.length-1:d.length,h),this._instanceVertices=f,this._instanceVertexBufferBinding=h,this._currentParticleCount=l},s._updateShaderData=function(t){this.main._updateShaderData(t),this.velocityOverLifetime._updateShaderData(t),this.textureSheetAnimation._updateShaderData(t),this.sizeOverLifetime._updateShaderData(t),this.rotationOverLifetime._updateShaderData(t),this.colorOverLifetime._updateShaderData(t)},s._resetGlobalRandSeed=function(t){this._randomSeed=t,this.main._resetRandomSeed(t),this.emission._resetRandomSeed(t),this.textureSheetAnimation._resetRandomSeed(t),this.velocityOverLifetime._resetRandomSeed(t),this.rotationOverLifetime._resetRandomSeed(t),this.colorOverLifetime._resetRandomSeed(t)},s._getAliveParticleCount=function(){if(this._firstActiveElement<=this._firstFreeElement)return this._firstFreeElement-this._firstActiveElement;var t=this._currentParticleCount-this._firstActiveElement;return this._firstFreeElement>0&&(t+=this._firstFreeElement),t},s._getNotRetiredParticleCount=function(){if(this._firstRetiredElement<=this._firstFreeElement)return this._firstFreeElement-this._firstRetiredElement;var t=this._currentParticleCount-this._firstRetiredElement;return this._firstFreeElement>0&&(t+=this._firstFreeElement),t},s._destroy=function(){this._instanceVertexBufferBinding.buffer.destroy(),this._primitive.destroy()},s._addNewParticle=function(t,e,r,a){var o=this._firstFreeElement,l=o+1;l>=this._currentParticleCount&&(l=0);var c=this.main;if(l===this._firstRetiredElement){var _=Math.min(n._particleIncreaseCount,c._maxParticleBuffer-this._currentParticleCount);if(_===0)return;this._resizeInstanceBuffer(!0,_),l=o+1}var u,d;c.simulationSpace===pn.World&&(u=r.worldPosition,d=r.worldRotationQuaternion);var h=this._renderer.engine._particleBufferUtils,f=c.startSpeed.evaluate(void 0,c._startSpeedRand.random()),v=this._instanceVertices,p=o*h.instanceVertexFloatStride;v[p]=t.x,v[p+1]=t.y,v[p+2]=t.z,v[p+h.startLifeTimeOffset]=c.startLifetime.evaluate(void 0,c._startLifeTimeRand.random()),v[p+4]=e.x,v[p+5]=e.y,v[p+6]=e.z,v[p+h.timeOffset]=a;var g=n._tempColor0;c.startColor.evaluate(void 0,c._startColorRand.random(),g),this._renderer.engine.settings.colorSpace===dr.Linear&&g.toLinear(g),v[p+8]=g.r,v[p+9]=g.g,v[p+10]=g.b,v[p+11]=g.a;var y=c._startSizeRand;if(c.startSize3D)v[p+12]=c.startSizeX.evaluate(void 0,y.random()),v[p+13]=c.startSizeY.evaluate(void 0,y.random()),v[p+14]=c.startSizeZ.evaluate(void 0,y.random());else{var m=c.startSize.evaluate(void 0,y.random());v[p+12]=m,v[p+13]=m,v[p+14]=m}var x=c._startRotationRand;c.startRotation3D?(v[p+15]=k.degreeToRadian(c.startRotationX.evaluate(void 0,x.random())),v[p+16]=k.degreeToRadian(c.startRotationY.evaluate(void 0,x.random())),v[p+17]=k.degreeToRadian(c.startRotationZ.evaluate(void 0,x.random()))):v[p+15]=k.degreeToRadian(c.startRotationZ.evaluate(void 0,x.random())),v[p+18]=f;var S=this.colorOverLifetime;S.enabled&&S.color.mode===$t.TwoGradients&&(v[p+20]=S._colorGradientRand.random());var b=this.rotationOverLifetime;b.enabled&&b.rotationZ.mode===fe.TwoConstants&&(v[p+22]=b._rotationRand.random());var A=this.textureSheetAnimation;A.enabled&&A.frameOverTime.mode===fe.TwoCurves&&(v[p+23]=A._frameOverTimeRand.random());var C=this.velocityOverLifetime;if(C.enabled&&C.velocityX.mode===fe.TwoConstants&&C.velocityY.mode===fe.TwoConstants&&C.velocityZ.mode===fe.TwoConstants){var E=C._velocityRand;v[p+24]=E.random(),v[p+25]=E.random(),v[p+26]=E.random()}if(this.main.simulationSpace===pn.World&&(v[p+27]=u.x,v[p+28]=u.y,v[p+29]=u.z,v[p+30]=d.x,v[p+31]=d.y,v[p+32]=d.z,v[p+33]=d.w),this.textureSheetAnimation.enabled){var T=this.textureSheetAnimation._tillingInfo;v[p+h.simulationUVOffset]=T.x,v[p+35]=T.y,v[p+36]=0,v[p+37]=0}else v[p+h.simulationUVOffset]=1,v[p+35]=1,v[p+36]=0,v[p+37]=0;this._firstFreeElement=l},s._retireActiveParticles=function(){for(var t=this._renderer.engine,e=t._particleBufferUtils,r=t.time.frameCount,a=this._instanceVertices;this._firstActiveElement!==this._firstNewElement;){var o=this._firstActiveElement*e.instanceVertexFloatStride,l=o+e.timeOffset,c=this._playTime-a[l];if(Math.fround(c)<a[o+e.startLifeTimeOffset])break;a[l]=r,++this._firstActiveElement>=this._currentParticleCount&&(this._firstActiveElement=0),this._waitProcessRetiredElementCount++}},s._freeRetiredParticles=function(){for(var t=this._renderer.engine._particleBufferUtils,e=this._renderer.engine.time.frameCount;this._firstRetiredElement!==this._firstActiveElement;){var r=this._firstRetiredElement*t.instanceVertexFloatStride+t.startLifeTimeOffset,a=e-this._instanceVertices[r];if(a<0)break;++this._firstRetiredElement>=this._currentParticleCount&&(this._firstRetiredElement=0)}},s._addActiveParticlesToVertexBuffer=function(){var t=this._firstActiveElement,e=this._firstFreeElement;if(t!==e){var r=this._renderer.engine._particleBufferUtils.instanceVertexStride,a=t*r,o=this._instanceVertexBufferBinding.buffer,l=this._instanceVertices.buffer;if(t<e)o.setData(l,0,a,(e-t)*r,gn.Discard);else{var c=(this._currentParticleCount-t)*r;o.setData(l,0,a,c,gn.Discard),e>0&&o.setData(l,c,0,e*r)}this._firstNewElement=e,this._waitProcessRetiredElementCount=0,this._instanceBufferResized=!1}},s._addVertexBufferBindingsFilterDuplicate=function(t,e){for(var r=0,a=e.length;r<a;r++)if(e[r]===t)return r;return e.push(t),r},q(n,[{key:"isAlive",get:function(){return this._isPlaying?!0:this._firstActiveElement!==this._firstFreeElement}},{key:"randomSeed",get:function(){return this._randomSeed},set:function(t){this._resetGlobalRandSeed(t),this.useAutoRandomSeed=!1}}]),n}();(function(){ze._tempVector30=new w})();(function(){ze._tempVector31=new w})();(function(){ze._tempColor0=new j})();(function(){ze._tempParticleRenderers=new Array})();(function(){ze._particleIncreaseCount=128})();R([Z],ze.prototype,"main",void 0);R([Z],ze.prototype,"emission",void 0);R([Z],ze.prototype,"velocityOverLifetime",void 0);R([Z],ze.prototype,"sizeOverLifetime",void 0);R([Z],ze.prototype,"rotationOverLifetime",void 0);R([Z],ze.prototype,"colorOverLifetime",void 0);R([Z],ze.prototype,"textureSheetAnimation",void 0);R([I],ze.prototype,"_playTime",void 0);R([I],ze.prototype,"_firstNewElement",void 0);R([I],ze.prototype,"_firstActiveElement",void 0);R([I],ze.prototype,"_firstFreeElement",void 0);R([I],ze.prototype,"_firstRetiredElement",void 0);R([I],ze.prototype,"_primitive",void 0);R([I],ze.prototype,"_vertexBufferBindings",void 0);R([I],ze.prototype,"_subPrimitive",void 0);R([I],ze.prototype,"_renderer",void 0);R([I],ze.prototype,"_isPlaying",void 0);R([I],ze.prototype,"_instanceBufferResized",void 0);R([I],ze.prototype,"_waitProcessRetiredElementCount",void 0);R([I],ze.prototype,"_instanceVertexBufferBinding",void 0);R([I],ze.prototype,"_instanceVertices",void 0);var $d=function(n){W(s,n);function s(t){var e;e=n.call(this,t,ne.find("particle-shader"))||this;var r=e.shaderData;return r.setColor(ke._baseColorProp,new j(1,1,1,1)),e.isTransparent=!0,e}var i=s.prototype;return i.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},q(s,[{key:"baseColor",get:function(){return this.shaderData.getColor(ke._baseColorProp)},set:function(e){var r=this.shaderData.getColor(ke._baseColorProp);e!==r&&r.copyFrom(e)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(ke._baseTextureProp)},set:function(e){this.shaderData.setTexture(ke._baseTextureProp,e),e?this.shaderData.enableMacro(ke._baseTextureMacro):this.shaderData.disableMacro(ke._baseTextureMacro)}}]),s}(ke),Bc=function(s,i){this.time=s,this.count=i};R([Z],Bc.prototype,"count",void 0);var ei=function(){function n(){this.enabled=!0,this.randomDirectionAmount=0}var s=n.prototype;return s._generatePositionAndDirection=function(t,e,r,a){throw new Error("BaseShape: must override it.")},n}(),Pr=function(){function n(){}return n.randomPointUnitArcCircle=function(i,t,e){var r=e.random()*i;t.x=Math.cos(r),t.y=Math.sin(r)},n.randomPointInsideUnitArcCircle=function(i,t,e){n.randomPointUnitArcCircle(i,t,e);var r=Math.sqrt(e.random());t.x=t.x*r,t.y=t.y*r},n.randomPointUnitCircle=function(i,t){var e=t.random()*Math.PI*2;i.x=Math.cos(e),i.y=Math.sin(e)},n.randomPointInsideUnitCircle=function(i,t){n.randomPointUnitCircle(i,t);var e=Math.sqrt(t.random());i.x=i.x*e,i.y=i.y*e},n._randomPointUnitSphere=function(i,t){var e=t.random()*2-1,r=t.random()*Math.PI*2,a=Math.sqrt(1-e*e);i.x=a*Math.cos(r),i.y=a*Math.sin(r),i.z=e},n._randomPointInsideUnitSphere=function(i,t){n._randomPointUnitSphere(i,t);var e=Math.pow(t.random(),1/3);i.x=i.x*e,i.y=i.y*e,i.z=i.z*e},n._randomPointInsideHalfUnitBox=function(i,t){t===void 0&&(t=null),i.x=t.random()-.5,i.y=t.random()-.5,i.z=t.random()-.5},n}(),In;(function(n){n[n.Box=0]="Box",n[n.Circle=1]="Circle",n[n.Cone=2]="Cone",n[n.Hemisphere=3]="Hemisphere",n[n.Sphere=4]="Sphere"})(In||(In={}));var ts=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.shapeType=In.Box,t.size=new w(1,1,1),t}var i=s.prototype;return i._generatePositionAndDirection=function(e,r,a,o){Pr._randomPointInsideHalfUnitBox(a,e),a.multiply(this.size);var l=s._tempVector30;l.set(0,0,-1),Pr._randomPointUnitSphere(o,e),w.lerp(l,o,this.randomDirectionAmount,o)},s}(ei);(function(){ts._tempVector30=new w})();R([Z],ts.prototype,"size",void 0);var _a;(function(n){n[n.Random=0]="Random",n[n.Loop=1]="Loop"})(_a||(_a={}));var Dc=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.shapeType=In.Circle,t.radius=1,t.arc=360,t.arcMode=_a.Random,t.arcSpeed=1,t}var i=s.prototype;return i._generatePositionAndDirection=function(e,r,a,o){var l=s._tempPositionPoint;switch(this.arcMode){case _a.Loop:var c=r*this.arcSpeed*(360/this.arc)%1,_=k.degreeToRadian(this.arc*c);l.set(Math.cos(_),Math.sin(_)),l.scale(e.random());break;case _a.Random:Pr.randomPointInsideUnitArcCircle(k.degreeToRadian(this.arc),l,e);break}a.set(l.x,l.y,0),a.scale(this.radius),Pr._randomPointUnitSphere(o,e),w.lerp(a,o,this.randomDirectionAmount,o)},s}(ei);(function(){Dc._tempPositionPoint=new $})();var ti=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.shapeType=In.Cone,t.angle=25,t.radius=1,t.length=5,t.emitType=0,t}var i=s.prototype;return i._generatePositionAndDirection=function(e,r,a,o){var l=s._tempVector20,c=k.degreeToRadian(this.angle),_=Math.sin(c),u=Math.cos(c);switch(this.emitType){case 0:Pr.randomPointInsideUnitCircle(l,e),a.set(l.x*this.radius,l.y*this.radius,0);var d=s._tempVector21;Pr.randomPointInsideUnitCircle(d,e),$.lerp(l,d,this.randomDirectionAmount,d),o.set(d.x*_,d.y*_,-u);break;case 1:Pr.randomPointInsideUnitCircle(l,e),a.set(l.x*this.radius,l.y*this.radius,0),o.set(l.x*_,l.y*_,-u),o.normalize();var h=s._tempVector30;w.scale(o,this.length*e.random(),h),a.add(h);var f=s._tempVector31;Pr._randomPointUnitSphere(f,e),w.lerp(o,f,this.randomDirectionAmount,o);break}},s}(ei);(function(){ti._tempVector20=new $})();(function(){ti._tempVector21=new $})();(function(){ti._tempVector30=new w})();(function(){ti._tempVector31=new w})();var Eo;(function(n){n[n.Base=0]="Base",n[n.Volume=1]="Volume"})(Eo||(Eo={}));var eh=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.shapeType=In.Hemisphere,t.radius=1,t}var i=s.prototype;return i._generatePositionAndDirection=function(e,r,a,o){Pr._randomPointInsideUnitSphere(a,e),a.scale(this.radius);var l=a.z;l>0&&(a.z=-l),Pr._randomPointUnitSphere(o,e),w.lerp(a,o,this.randomDirectionAmount,o)},s}(ei),th=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.shapeType=In.Sphere,t.radius=1,t}var i=s.prototype;return i._generatePositionAndDirection=function(e,r,a,o){Pr._randomPointInsideUnitSphere(a,e),a.scale(this.radius),Pr._randomPointUnitSphere(o,e),w.lerp(a,o,this.randomDirectionAmount,o)},s}(ei),rh=`#define GLSLIFY 1
varying vec2 v_uv;uniform sampler2D u_texture;void main(void){gl_FragColor=texture2D(u_texture,v_uv);}`,nh=`#define GLSLIFY 1
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;uniform mat4 camera_ProjMat;uniform mat4 camera_ViewMat;void main(){gl_Position=camera_ProjMat*camera_ViewMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`;ne.create("trail",nh,rh);var Lc=function(n){W(s,n);function s(i){var t;t=n.call(this,i,ne.find("trail"))||this;var e=t.renderState.blendState.targetBlendState;return e.enabled=!0,e.sourceColorBlendFactor=e.sourceAlphaBlendFactor=Ae.SourceAlpha,e.destinationColorBlendFactor=e.destinationAlphaBlendFactor=Ae.One,t.renderState.depthState.writeEnabled=!1,t}return s}(Mr),Ds=new w,ah=function(n){W(s,n);function s(t,e){var r;r=n.call(this,t)||this,r._stroke=e.stroke||.2,r._minSeg=e.minSeg||.02,r._lifetime=e.lifetime||1e3,r._maxPointNum=r._lifetime/1e3*t.engine.targetFrameRate,r._points=[],r._pointStates=[],r._strapPoints=[];for(var a=0;a<r._maxPointNum;a++)r._points.push(new w),r._pointStates.push(r._lifetime),r._strapPoints.push(new w),r._strapPoints.push(new w);r._curPointNum=0;var o=e.material||new Lc(r.engine);return r.setMaterial(o),r.setTexture(e.texture),r._initGeometry(),r}var i=s.prototype;return i.update=function(e){for(var r=0,a=0,o=0;o<this._curPointNum;o++)this._pointStates[o]-=e,this._pointStates[o]<0?r++:r>0&&(a=o-r,this._pointStates[a]=this._pointStates[o],this._points[a].copyFrom(this._points[o]));this._curPointNum-=r;var l=!0;if(this._curPointNum===this._maxPointNum)l=!1;else if(this._curPointNum>0){var c=this._points[this._points.length-1];w.distance(this.entity.transform.worldPosition,c)<this._minSeg&&(l=!1)}l&&(this._pointStates[this._curPointNum]=this._lifetime,this._points[this._curPointNum].copyFrom(this.entity.transform.worldPosition),this._curPointNum++)},i.setTexture=function(e){e&&this.getMaterial().shaderData.setTexture("u_texture",e)},i._render=function(e){this._updateStrapVertices(e.camera,this._points),this._updateStrapCoords(),this._vertexBuffer.setData(this._vertices),n.prototype._render.call(this,e)},i._initGeometry=function(){var e=new Wo(this._entity.engine),r=20,a=this._maxPointNum*2,o=a*r,l=new Float32Array(o),c=[new Me("POSITION",0,ee.Vector3,0),new Me("TEXCOORD_0",12,ee.Vector2,0)],_=new ir(this.engine,o*4,tt.Dynamic);e.setVertexBufferBinding(_,r),e.setVertexElements(c),e.addSubMesh(0,a,kr.TriangleStrip),this._vertexBuffer=_,this._vertexStride=r,this._vertices=l,this.mesh=e},i._updateStrapVertices=function(e,r){var a=e.viewMatrix,o=a.elements,l=new w(o[0],o[4],o[8]),c=new w(o[1],o[5],o[9]),_=new w(o[2],o[6],o[10]),u=this._stroke;c.scale(u);var d=new w,h=new w,f=new ye;w.transformByQuat(l,f,l),w.transformByQuat(c,f,c);var v=new w,p=new w,g=new w;l.normalize();for(var y=this._vertices,m=0;m<this._maxPointNum;m++){if(m<this._curPointNum){var x=r[m];m===this._curPointNum-1&&m!==0?w.subtract(x,r[m-1],g):w.subtract(r[m+1],x,g),this._projectOnPlane(g,_,g),g.normalize();var S=Math.acos(w.dot(l,g));w.cross(l,g,p),w.dot(p,_)<=0&&(S=Math.PI*2-S),ye.rotationAxisAngle(_,S,f),w.transformByQuat(c,f,v),w.add(x,v,d),w.subtract(x,v,h)}var b=m*2*this._vertexStride/4,A=(m*2+1)*this._vertexStride/4;y[b]=d.x,y[b+1]=d.y,y[b+2]=d.z,y[A]=h.x,y[A+1]=h.y,y[A+2]=h.z}},i._updateStrapCoords=function(){if(this._prePointsNum!==this._curPointNum){this._prePointsNum=this._curPointNum;for(var e=this._curPointNum,r=1/e,a=this._vertices,o=0;o<e;o++){var l=1-o*r,c=o*2*this._vertexStride/4,_=(o*2+1)*this._vertexStride/4;a[c]=0,a[c+1]=l,a[_]=1,a[_+1]=l}}},i._projectOnVector=function(e,r,a){var o=r.clone();w.normalize(o,o);var l=w.dot(e,o);a.x=o.x*l,a.y=o.y*l,a.z=o.z*l},i._projectOnPlane=function(e,r,a){this._projectOnVector(e,r,Ds),w.subtract(e,Ds,a)},s}(Rt),Vc=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.probeLayer=mn.Everything,t.width=1024,t.height=1024,t.antiAliasing=1,t._isCube=!1,t}var i=s.prototype;return i.onTextureChange=function(e){},i.onBeginRender=function(e){!this.enabled||(this._camera=e,this._oriCameraCullingMask=e.cullingMask,e.cullingMask=this.probeLayer,(!this._activeRenderTarget||this._activeRenderTarget.width!==this.width||this._activeRenderTarget.height!==this.height||this._activeRenderTarget.antiAliasing!==this.antiAliasing)&&(this._renderTarget=new ea(this.engine,this.width,this.height,this._isCube?new tr(this.engine,this.width):new bt(this.engine,this.width,this.height),ka.Depth,this.antiAliasing),this._renderTargetSwap=new ea(this.engine,this.width,this.height,this._isCube?new tr(this.engine,this.width):new bt(this.engine,this.width,this.height),ka.Depth,this.antiAliasing),this._activeRenderTarget=this._renderTarget),this._oriCameraRenderTarget=e.renderTarget,e.renderTarget=this._activeRenderTarget)},i.onEndRender=function(e){!this.enabled||(this.onTextureChange&&this.onTextureChange(this._texture),this._activeRenderTarget=this._activeRenderTarget===this._renderTarget?this._renderTargetSwap:this._renderTarget)},i._reset=function(){!this.enabled||(this._camera.renderTarget=this._oriCameraRenderTarget,this._camera.cullingMask=this._oriCameraCullingMask)},q(s,[{key:"_texture",get:function(){var e;return(e=this._activeRenderTarget)==null?void 0:e.getColorTexture()}}]),s}(Jt),Ls=new w,Gn=new w,Hn=new w,ih=function(n){W(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.position=new w(0,0,0),t._isCube=!0,t.oriViewMatrix=new J,t}var i=s.prototype;return i.onBeginRender=function(e){if(!!this.enabled){n.prototype.onBeginRender.call(this,e),this._storeCamera(e);for(var r=0;r<6;r++)this._setCamera(r,e),e.render(Dr.PositiveX+r);this._restoreCamera(e),n.prototype._reset.call(this)}},i._storeCamera=function(e){this.oriViewMatrix.copyFrom(e.viewMatrix),this._oriFieldOfView=e.fieldOfView},i._restoreCamera=function(e){e.viewMatrix.copyFrom(this.oriViewMatrix),e.fieldOfView=this._oriFieldOfView},i._setCamera=function(e,r){switch(e){case 0:Gn.set(0,-1,0),Hn.set(1,0,0);break;case 1:Gn.set(0,-1,0),Hn.set(-1,0,0);break;case 2:Gn.set(0,0,1),Hn.set(0,1,0);break;case 3:Gn.set(0,0,-1),Hn.set(0,-1,0);break;case 4:Gn.set(0,-1,0),Hn.set(0,0,1);break;case 5:Gn.set(0,-1,0),Hn.set(0,0,-1);break}w.add(this.position,Hn,Ls),J.lookAt(this.position,Ls,Gn,r.viewMatrix),r.fieldOfView=90},s}(Vc);const Vs=Object.freeze(Object.defineProperty({__proto__:null,AmbientLight:Lr,get AnimationArrayCurve(){return Li},get AnimationBoolCurve(){return Vi},AnimationClip:Ko,AnimationClipCurveBinding:Mc,get AnimationColorCurve(){return Ni},AnimationCurve:pr,AnimationEvent:to,get AnimationFloatArrayCurve(){return Xa},get AnimationFloatCurve(){return Ii},get AnimationQuaternionCurve(){return xa},get AnimationRectCurve(){return Co},get AnimationRefCurve(){return zi},get AnimationStringCurve(){return Ui},get AnimationVector2Curve(){return Fi},get AnimationVector3Curve(){return ja},get AnimationVector4Curve(){return Oi},Animator:nn,get AnimatorConditionMode(){return Ao},AnimatorController:Zo,AnimatorControllerLayer:$o,get AnimatorCullingMode(){return qa},get AnimatorLayerBlendingMode(){return Ya},AnimatorLayerMask:Jd,AnimatorState:Pc,AnimatorStateMachine:es,AnimatorStateTransition:Jo,AssetPromise:Be,get AssetType(){return Fe},Background:wc,get BackgroundMode(){return $r},get BackgroundTextureFillMode(){return Dn},BaseMaterial:ke,Basic2DBatcher:Or,BasicRenderPipeline:Rc,get BlendFactor(){return Ae},get BlendMode(){return qn},get BlendOperation(){return Wt},BlendShape:Ho,BlendShapeFrame:fc,BlendState:Ki,BlinnPhongMaterial:Ka,BoolUpdateFlag:Qi,BoxColliderShape:qo,BoxShape:ts,Buffer:ir,get BufferBindFlag(){return Nt},BufferMesh:Wo,get BufferUsage(){return tt},BufferUtil:Ti,Burst:Bc,get Camera(){return Ne},get CameraClearFlags(){return Lt},get CameraType(){return Wa},Canvas:Ac,CapsuleColliderShape:Ja,CharacterController:Yu,CircleShape:Dc,CloneManager:Br,get Collider(){return Ft},ColliderShape:or,get ColliderShapeUpAxis(){return Kn},get CollisionDetectionMode(){return mo},ColorOverLifetimeModule:gr,get ColorSpace(){return dr},get ColorWriteMask(){return Er},get CompareFunction(){return Te},Component:Vt,get ConeEmitType(){return Eo},ConeShape:ti,ContentRestorer:Rr,get ControllerCollisionFlag(){return xo},get ControllerNonWalkableMode(){return Pi},CubeProbe:ih,get CullMode(){return Xt},CurveKey:Yr,get DataType(){return Ue},get DependentMode(){return Ur},DepthState:uc,get DepthTextureMode(){return Ha},get DiffuseMode(){return ta},DirectLight:bn,get Downsampling(){return ya},DynamicCollider:Kt,get DynamicColliderConstraints(){return yo},EmissionModule:zn,Engine:yn,EngineObject:tn,Entity:Qr,EventDispatcher:Uo,FixedJoint:Ku,get FogMode(){return Bi},Font:pa,get FontStyle(){return Bn},get GLCapabilityType(){return Q},GradientAlphaKey:Gi,GradientColorKey:ki,HemisphereShape:eh,HingeJoint:Ta,HitResult:xc,IndexBufferBinding:Ua,get IndexFormat(){return Et},InputManager:Cc,get InterpolationType(){return At},get Joint(){return Gr},JointLimits:Zu,JointMotor:$u,Keyframe:Gt,get Keys(){return Ie},get Layer(){return mn},Light:Za,Loader:De,Logger:ve,get MSAASamples(){return Di},MainModule:Le,Material:Mr,Mesh:Go,MeshRenderer:Rt,get MeshTopology(){return kr},ModelMesh:ct,get OverflowMode(){return Zn},PBRBaseMaterial:Wr,PBRMaterial:Jr,PBRSpecularMaterial:na,ParticleCompositeCurve:He,ParticleCompositeGradient:ia,ParticleCurve:Jn,get ParticleCurveMode(){return fe},ParticleGenerator:ze,ParticleGradient:Nn,get ParticleGradientMode(){return $t},ParticleMaterial:$d,get ParticleRenderMode(){return Ar},ParticleRenderer:Ot,get ParticleScaleMode(){return jr},get ParticleShapeArcMode(){return _a},get ParticleShapeType(){return In},get ParticleSimulationSpace(){return pn},get ParticleStopMode(){return ba},PhysicsMaterial:bc,get PhysicsMaterialCombineMode(){return Ga},PhysicsScene:Qt,get PipelineStage(){return jt},PlaneColliderShape:ed,get Platform(){return Ht},PointLight:Cn,Pointer:yc,get PointerButton(){return er},get PointerPhase(){return _r},Primitive:ko,PrimitiveMesh:it,Probe:Vc,RasterState:dc,ReferResource:rn,get RenderBufferDepthFormat(){return ka},get RenderFace(){return hn},RenderQueue:un,get RenderQueueType(){return mt},RenderState:en,get RenderStateDataKey(){return re},RenderTarget:ea,RenderTargetBlendState:_c,get Renderer(){return be},ResourceManager:ga,RotationOverLifetimeModule:rt,Scene:$a,SceneManager:mc,Script:Jt,get SetDataOptions(){return gn},Shader:ne,ShaderData:Hr,ShaderFactory:_n,ShaderLib:La,ShaderMacro:ie,ShaderMacroCollection:ar,ShaderPass:gt,ShaderProperty:L,get ShaderPropertyType(){return kt},ShaderTagKey:vn,get ShadowCascadesMode(){return Sr},get ShadowResolution(){return Ln},get ShadowType(){return xn},SizeOverLifetimeModule:Bt,Skin:vc,SkinnedMeshRenderer:Pt,Sky:ma,SkyBoxMaterial:Ra,SkyProceduralMaterial:En,SphereColliderShape:Yo,SphereShape:th,SpotLight:vr,SpringJoint:Ju,Sprite:Ei,SpriteAtlas:sc,get SpriteDrawMode(){return br},SpriteMask:It,get SpriteMaskInteraction(){return ht},get SpriteMaskLayer(){return ha},SpriteRenderer:Ct,get SpriteTileMode(){return Oa},StateMachineScript:So,StaticCollider:Qu,get StencilOperation(){return Xe},StencilState:hc,SubMesh:Zi,SubShader:Si,get SunMode(){return wo},SystemInfo:Zr,get TextHorizontalAlignment(){return Xn},TextRenderer:st,TextUtils:hr,get TextVerticalAlignment(){return jn},Texture:Kr,Texture2D:bt,Texture2DArray:Xo,get TextureCoordinate(){return Vn},TextureCube:tr,get TextureCubeFace(){return Dr},get TextureDepthCompareFunction(){return Cr},get TextureFilterMode(){return ot},get TextureFormat(){return G},TextureSheetAnimationModule:sr,get TextureUsage(){return va},get TextureWrapMode(){return yt},Time:Yi,TrailMaterial:Lc,TrailRenderer:ah,Transform:me,UnlitMaterial:gc,Utils:We,VelocityOverLifetimeModule:lt,get VertexAttribute(){return X},VertexBufferBinding:$n,VertexElement:Me,get VertexElementFormat(){return ee},get WrapMode(){return Qa},XRManager:Sc,assignmentClone:Pe,deepClone:Z,dependentComponents:An,ignoreClone:I,request:aa,resourceLoader:Qe,shallowClone:zo},Symbol.toStringTag,{value:"Module"}));var _e;(function(n){n[n.RGBA_ASTC_4X4_KHR=37808]="RGBA_ASTC_4X4_KHR",n[n.RGBA_ASTC_5X4_KHR=37809]="RGBA_ASTC_5X4_KHR",n[n.RGBA_ASTC_5X5_KHR=37810]="RGBA_ASTC_5X5_KHR",n[n.RGBA_ASTC_6X5_KHR=37811]="RGBA_ASTC_6X5_KHR",n[n.RGBA_ASTC_6X6_KHR=37812]="RGBA_ASTC_6X6_KHR",n[n.RGBA_ASTC_8X5_KHR=37813]="RGBA_ASTC_8X5_KHR",n[n.RGBA_ASTC_8X6_KHR=37814]="RGBA_ASTC_8X6_KHR",n[n.RGBA_ASTC_8X8_KHR=37815]="RGBA_ASTC_8X8_KHR",n[n.RGBA_ASTC_10X5_KHR=37816]="RGBA_ASTC_10X5_KHR",n[n.RGBA_ASTC_10X6_KHR=37817]="RGBA_ASTC_10X6_KHR",n[n.RGBA_ASTC_10X8_KHR=37818]="RGBA_ASTC_10X8_KHR",n[n.RGBA_ASTC_10X10_KHR=37819]="RGBA_ASTC_10X10_KHR",n[n.RGBA_ASTC_12X10_KHR=37820]="RGBA_ASTC_12X10_KHR",n[n.RGBA_ASTC_12X12_KHR=37821]="RGBA_ASTC_12X12_KHR",n[n.SRGB8_ALPHA8_ASTC_4X4_KHR=37840]="SRGB8_ALPHA8_ASTC_4X4_KHR",n[n.SRGB8_ALPHA8_ASTC_5X4_KHR=37841]="SRGB8_ALPHA8_ASTC_5X4_KHR",n[n.SRGB8_ALPHA8_ASTC_5X5_KHR=37842]="SRGB8_ALPHA8_ASTC_5X5_KHR",n[n.SRGB8_ALPHA8_ASTC_6X5_KHR=37843]="SRGB8_ALPHA8_ASTC_6X5_KHR",n[n.SRGB8_ALPHA8_ASTC_6X6_KHR=37844]="SRGB8_ALPHA8_ASTC_6X6_KHR",n[n.SRGB8_ALPHA8_ASTC_8X5_KHR=37845]="SRGB8_ALPHA8_ASTC_8X5_KHR",n[n.SRGB8_ALPHA8_ASTC_8X6_KHR=37846]="SRGB8_ALPHA8_ASTC_8X6_KHR",n[n.SRGB8_ALPHA8_ASTC_8X8_KHR=37847]="SRGB8_ALPHA8_ASTC_8X8_KHR",n[n.SRGB8_ALPHA8_ASTC_10X5_KHR=37848]="SRGB8_ALPHA8_ASTC_10X5_KHR",n[n.SRGB8_ALPHA8_ASTC_10X6_KHR=37849]="SRGB8_ALPHA8_ASTC_10X6_KHR",n[n.SRGB8_ALPHA8_ASTC_10X8_KHR=37850]="SRGB8_ALPHA8_ASTC_10X8_KHR",n[n.SRGB8_ALPHA8_ASTC_10X10_KHR=37851]="SRGB8_ALPHA8_ASTC_10X10_KHR",n[n.SRGB8_ALPHA8_ASTC_12X10_KHR=37852]="SRGB8_ALPHA8_ASTC_12X10_KHR",n[n.SRGB8_ALPHA8_ASTC_12X12_KHR=37853]="SRGB8_ALPHA8_ASTC_12X12_KHR",n[n.RGB_ETC1_WEBGL=36196]="RGB_ETC1_WEBGL",n[n.R11_EAC=37488]="R11_EAC",n[n.SIGNED_R11_EAC=37489]="SIGNED_R11_EAC",n[n.RG11_EAC=37490]="RG11_EAC",n[n.SIGNED_RG11_EAC=37491]="SIGNED_RG11_EAC",n[n.RGB8_ETC2=37492]="RGB8_ETC2",n[n.SRGB8_ETC2=37493]="SRGB8_ETC2",n[n.RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="RGB8_PUNCHTHROUGH_ALPHA1_ETC2",n[n.SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",n[n.RGBA8_ETC2_EAC=37496]="RGBA8_ETC2_EAC",n[n.SRGB8_ALPHA8_ETC2_EAC=37497]="SRGB8_ALPHA8_ETC2_EAC",n[n.RGB_PVRTC_4BPPV1_IMG=35840]="RGB_PVRTC_4BPPV1_IMG",n[n.RGB_PVRTC_2BPPV1_IMG=35841]="RGB_PVRTC_2BPPV1_IMG",n[n.RGBA_PVRTC_4BPPV1_IMG=35842]="RGBA_PVRTC_4BPPV1_IMG",n[n.RGBA_PVRTC_2BPPV1_IMG=35843]="RGBA_PVRTC_2BPPV1_IMG",n[n.RGB_S3TC_DXT1_EXT=33776]="RGB_S3TC_DXT1_EXT",n[n.RGBA_S3TC_DXT1_EXT=33777]="RGBA_S3TC_DXT1_EXT",n[n.RGBA_S3TC_DXT3_EXT=33778]="RGBA_S3TC_DXT3_EXT",n[n.RGBA_S3TC_DXT5_EXT=33779]="RGBA_S3TC_DXT5_EXT",n[n.RGBA_BPTC_UNORM_EXT=36492]="RGBA_BPTC_UNORM_EXT",n[n.SRGB_ALPHA_BPTC_UNORM_EXT=36493]="SRGB_ALPHA_BPTC_UNORM_EXT",n[n.RGB_BPTC_SIGNED_FLOAT_EXT=36494]="RGB_BPTC_SIGNED_FLOAT_EXT",n[n.RGB_BPTC_UNSIGNED_FLOAT_EXT=36495]="RGB_BPTC_UNSIGNED_FLOAT_EXT"})(_e||(_e={}));function Ns(n,s){for(var i=0;i<s.length;i++){var t=s[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function ri(n,s,i){return s&&Ns(n.prototype,s),i&&Ns(n,i),n}function To(n,s){return To=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},To(n,s)}function ni(n,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(s&&s.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),s&&To(n,s)}function ur(n,s){return s!=null&&typeof Symbol<"u"&&s[Symbol.hasInstance]?!!s[Symbol.hasInstance](n):n instanceof s}var oh=function(n){ni(s,n);function s(t){var e;e=n.call(this)||this,e._scale=new $;var r=t.width,a=t.height;return e._webCanvas=t,e.width=r,e.height=a,e}var i=s.prototype;return i.resizeByClientSize=function(e){e===void 0&&(e=window.devicePixelRatio);var r=this._webCanvas;if(typeof OffscreenCanvas>"u"||!ur(r,OffscreenCanvas)){var a=r.clientWidth*e,o=r.clientHeight*e;this.width=a,this.height=o}},i.setScale=function(e,r){this._scale.set(e,r),this.scale=this._scale},i._onWidthChanged=function(e){this._webCanvas.width=e},i._onHeightChange=function(e){this._webCanvas.height=e},ri(s,[{key:"scale",get:function(){var e=this._webCanvas;return(typeof OffscreenCanvas>"u"||!ur(e,OffscreenCanvas))&&this._scale.set(e.clientWidth*devicePixelRatio/e.width,e.clientHeight*devicePixelRatio/e.height),this._scale},set:function(e){var r=this._webCanvas;(typeof OffscreenCanvas>"u"||!ur(r,OffscreenCanvas))&&(r.style.transformOrigin="left top",r.style.transform="scale("+e.x+", "+e.y+")")}}]),s}(Ac),Af=function(n){ni(s,n);function s(){return n.apply(this,arguments)}return s.create=function(t){var e=t.canvas,r=new oh(typeof e=="string"?document.getElementById(e):e),a=new ph(t.graphicDeviceOptions),o=new s(r,a,t),l=o._initialize(t);return l.then(function(){return o.sceneManager.addScene(new $a(o,"DefaultScene")),o})},ri(s,[{key:"canvas",get:function(){return this._canvas}}]),s}(yn);function Hi(){return Hi=Object.assign||function(s){for(var i=1;i<arguments.length;i++){var t=arguments[i];for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(s[e]=t[e])}return s},Hi.apply(this,arguments)}var sh=function(){function n(i,t,e,r,a){r===void 0&&(r=tt.Static);var o=i.gl,l=o.createBuffer(),c=this._getGLBufferUsage(o,r),_=t===Nt.VertexBuffer?o.ARRAY_BUFFER:o.ELEMENT_ARRAY_BUFFER;this._gl=o,this._glBuffer=l,this._glBufferUsage=c,this._glBindTarget=_,this._isWebGL2=i.isWebGL2,this.bind(),a?o.bufferData(_,a,c):o.bufferData(_,e,c),o.bindBuffer(_,null)}var s=n.prototype;return s.bind=function(){this._gl.bindBuffer(this._glBindTarget,this._glBuffer)},s.setData=function(t,e,r,a,o,l){var c=this._gl,_=this._glBindTarget;this.bind(),l===gn.Discard&&c.bufferData(_,t,this._glBufferUsage);var u=e.BYTES_PER_ELEMENT||1,d=o?u*o:e.byteLength;if(a!==0||d<e.byteLength){var h=e.byteOffset!==void 0;if(this._isWebGL2&&h)c.bufferSubData(_,r,e,a,d/u);else{var f=new Uint8Array(h?e.buffer:e,a*u,d);c.bufferSubData(_,r,f)}}else c.bufferSubData(_,r,e);c.bindBuffer(_,null)},s.getData=function(t,e,r,a){if(this._isWebGL2){var o=this._gl;this.bind(),o.getBufferSubData(this._glBindTarget,e,t,r,a)}else throw"Buffer is write-only on WebGL1.0 platforms."},s.destroy=function(){this._gl.deleteBuffer(this._glBuffer),this._gl=null,this._glBuffer=null},s._getGLBufferUsage=function(t,e){switch(e){case tt.Static:return t.STATIC_DRAW;case tt.Dynamic:return t.DYNAMIC_DRAW;case tt.Stream:return t.STREAM_DRAW}},n}(),lh=function(){function n(i){this._rhi=i,this.capabilityList=new Map,this._init(),this._compatibleAllInterface()}var s=n.prototype;return s.canIUse=function(t){return this.capabilityList.get(t)},s.canIUseCompressedTextureInternalFormat=function(t){var e=_e.RGBA_ASTC_4X4_KHR,r=_e.RGBA_ASTC_12X12_KHR,a=_e.SRGB8_ALPHA8_ASTC_4X4_KHR,o=_e.SRGB8_ALPHA8_ASTC_12X12_KHR,l=_e.RGB_ETC1_WEBGL,c=_e.R11_EAC,_=_e.SRGB8_ALPHA8_ETC2_EAC,u=_e.RGB_PVRTC_4BPPV1_IMG,d=_e.RGBA_PVRTC_2BPPV1_IMG,h=_e.RGB_S3TC_DXT1_EXT,f=_e.RGBA_S3TC_DXT5_EXT,v=_e.RGBA_BPTC_UNORM_EXT,p=_e.RGB_BPTC_UNSIGNED_FLOAT_EXT;return t>=e&&r<=r||t>=a&&t<=o?this.canIUse(Q.astc):t===l?this.canIUse(Q.etc1):t>=c&&t<=_?this.canIUse(Q.etc):t>=u&&t<=d?this.canIUse(Q.pvrtc):t>=h&&t<=f?this.canIUse(Q.s3tc):t>=v&&t<=p?this.canIUse(Q.bptc):!1},s._init=function(){var t=this.capabilityList,e=this.rhi.isWebGL2,r=this.rhi.requireExtension.bind(this.rhi),a=Q.shaderVertexID,o=Q.standardDerivatives,l=Q.shaderTextureLod,c=Q.elementIndexUint,_=Q.depthTexture,u=Q.vertexArrayObject,d=Q.instancedArrays,h=Q.multipleSample,f=Q.drawBuffers,v=Q.blendMinMax,p=Q.astc,g=Q.astc_webkit,y=Q.etc,m=Q.etc_webkit,x=Q.etc1,S=Q.etc1_webkit,b=Q.pvrtc,A=Q.pvrtc_webkit,C=Q.s3tc,E=Q.s3tc_webkit,T=Q.bptc,B=Q.textureFloat,M=Q.textureHalfFloat,P=Q.textureFloatLinear,V=Q.textureHalfFloatLinear,N=Q.WEBGL_colorBufferFloat,F=Q.colorBufferFloat,O=Q.colorBufferHalfFloat,D=Q.textureFilterAnisotropic,z=Q.fragDepth;t.set(a,e),t.set(o,e||!!r(o)),t.set(l,e||!!r(l)),t.set(c,e||!!r(c)),t.set(_,e||!!r(_)),t.set(u,e||!!r(u)),t.set(d,e||!!r(d)),t.set(h,e),t.set(f,e||!!r(f)),t.set(v,e||!!r(v)),t.set(B,e||!!r(B)),t.set(M,e||!!r(M)),t.set(P,!!r(P)),t.set(V,e||!!r(V)),t.set(F,e&&!!r(F)||!!r(N)),t.set(O,e&&!!r(F)||!!r(O)),t.set(D,!!r(D)),t.set(z,e||!!r(z)),t.set(p,!!(r(p)||r(g))),t.set(y,!!(r(y)||r(m))),t.set(x,!!(r(x)||r(S))),t.set(b,!!(r(b)||r(A))),t.set(C,!!(r(C)||r(E))),t.set(T,!!r(T))},s._compatibleInterface=function(t,e){var r=this.rhi,a=r.gl,o=null;if(o=r.requireExtension(t))for(var l in e){var c,_=e[l],u=o[_];(c=u)!=null&&c.bind?a[l]=u.bind(o):a[l]=u}},s._compatibleAllInterface=function(){var t=Q.depthTexture,e=Q.vertexArrayObject,r=Q.instancedArrays,a=Q.drawBuffers,o=Q.textureFilterAnisotropic,l=Q.textureHalfFloat,c=Q.colorBufferHalfFloat,_=Q.WEBGL_colorBufferFloat,u=Q.blendMinMax,d=this.rhi.isWebGL2;if(!d){this._compatibleInterface(u,{MIN:"MIN_EXT",MAX:"MAX_EXT"}),this._compatibleInterface(t,{UNSIGNED_INT_24_8:"UNSIGNED_INT_24_8_WEBGL"}),this._compatibleInterface(e,{createVertexArray:"createVertexArrayOES",deleteVertexArray:"deleteVertexArrayOES",isVertexArray:"isVertexArrayOES",bindVertexArray:"bindVertexArrayOES"}),this._compatibleInterface(r,{drawArraysInstanced:"drawArraysInstancedANGLE",drawElementsInstanced:"drawElementsInstancedANGLE",vertexAttribDivisor:"vertexAttribDivisorANGLE"}),this._compatibleInterface(a,{MAX_DRAW_BUFFERS:"MAX_DRAW_BUFFERS_WEBGL"});var h={};if(this.canIUse(Q.drawBuffers)){for(var f=this.maxDrawBuffers,v=0;v<f;v++)v!=0&&(h["COLOR_ATTACHMENT"+v]="COLOR_ATTACHMENT"+v+"_WEBGL"),h["DRAW_BUFFER"+v]="DRAW_BUFFER"+v+"_WEBGL";this._compatibleInterface(a,Hi({drawBuffers:"drawBuffersWEBGL"},h))}this._compatibleInterface(l,{HALF_FLOAT:"HALF_FLOAT_OES"}),this._compatibleInterface(c,{RGBA16F:"RBGA16F_EXT"}),this._compatibleInterface(_,{RGBA32F:"RBGA32F_EXT"})}this._compatibleInterface(o,{TEXTURE_MAX_ANISOTROPY_EXT:"TEXTURE_MAX_ANISOTROPY_EXT"})},ri(n,[{key:"maxTextureSize",get:function(){return this.rhi.renderStates.getParameter(this.rhi.gl.MAX_TEXTURE_SIZE)}},{key:"canUseFloatTextureBlendShape",get:function(){return this.canIUse(Q.shaderVertexID)&&this.canIUse(Q.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}},{key:"canIUseMoreJoints",get:function(){return this.canIUse(Q.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}},{key:"maxDrawBuffers",get:function(){return this._maxDrawBuffers||(this.canIUse(Q.drawBuffers)?this._maxDrawBuffers=this._rhi.gl.getParameter(this._rhi.gl.MAX_DRAW_BUFFERS):this._maxDrawBuffers=1),this._maxDrawBuffers}},{key:"maxAnisoLevel",get:function(){if(!this._maxAnisoLevel){var t=this._rhi.requireExtension(Q.textureFilterAnisotropic);this._maxAnisoLevel=t?this._rhi.gl.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1}return this._maxAnisoLevel}},{key:"maxAntiAliasing",get:function(){if(!this._maxAntiAliasing){var t=this._rhi.gl,e=this.canIUse(Q.multipleSample);this._maxAntiAliasing=e?t.getParameter(t.MAX_SAMPLES):1}return this._maxAntiAliasing}},{key:"rhi",get:function(){return this._rhi}}]),n}(),ch=function(){function n(i){this.rhi=i,this._requireResult={}}var s=n.prototype;return s.requireExtension=function(t){return this._requireResult[t]!==void 0?this._requireResult[t]:(this._requireResult[t]=this.rhi.gl.getExtension(t),this._requireResult[t])},n}(),_h=function(){function n(i,t){this._attribLocArray=[],this._vaoMap=new Map,this._primitive=t,this._canUseInstancedArrays=i.canIUse(Q.instancedArrays),this._isSupportVAO=i.canIUse(Q.vertexArrayObject),this._gl=i.gl}var s=n.prototype;return s.draw=function(t,e){var r=this._gl,a=this._primitive,o=this._isSupportVAO&&a.enableVAO;if(o){a._bufferStructChanged&&this._clearVAO(),this._vaoMap.has(t.id)||this._registerVAO(t);var l=this._vaoMap.get(t.id);r.bindVertexArray(l)}else this._bindBufferAndAttrib(t);var c=a.indexBufferBinding,_=a.instanceCount,u=a._glIndexType,d=a._glIndexByteCount,h=e.topology,f=e.start,v=e.count;if(_)if(this._canUseInstancedArrays)if(c)if(o)r.drawElementsInstanced(h,v,u,f*d,_);else{var g=c.buffer._platformBuffer._glBuffer;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,g),r.drawElementsInstanced(h,v,u,f*d,_),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)}else r.drawArraysInstanced(h,f,v,_);else ve.error("ANGLE_instanced_arrays extension is not supported");else if(c)if(o)r.drawElements(h,v,u,f*d);else{var p=c.buffer._platformBuffer._glBuffer;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,p),r.drawElements(h,v,u,f*d),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)}else r.drawArrays(h,f,v);o?r.bindVertexArray(null):this._disableAttrib()},s.destroy=function(){this._isSupportVAO&&this._clearVAO()},s._bindBufferAndAttrib=function(t){var e=this._gl,r=this._primitive,a=r.vertexBufferBindings;this._attribLocArray.length=0;var o=t.attributeLocation,l=r._vertexElementMap,c,_;for(var u in o){var d=o[u];if(d!==-1){var h=l[u];if(h){var f=a[h.bindingIndex],v=f.buffer,p=f.stride;c=v._platformBuffer._glBuffer,_!==c&&(_=c,e.bindBuffer(e.ARRAY_BUFFER,c)),e.enableVertexAttribArray(d);var g=h._formatMetaInfo;e.vertexAttribPointer(d,g.size,g.type,g.normalized,p,h.offset),this._canUseInstancedArrays&&e.vertexAttribDivisor(d,h.instanceStepRate),this._attribLocArray.push(d)}else ve.warn("vertex attribute not found: "+u)}}e.bindBuffer(e.ARRAY_BUFFER,null)},s._disableAttrib=function(){for(var t=this._gl,e=0,r=this._attribLocArray.length;e<r;e++)t.disableVertexAttribArray(this._attribLocArray[e])},s._registerVAO=function(t){var e=this._gl,r=e.createVertexArray();e.bindVertexArray(r);var a=this._primitive.indexBufferBinding;a&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a.buffer._platformBuffer._glBuffer),this._bindBufferAndAttrib(t),e.bindVertexArray(null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),this._disableAttrib(),this._vaoMap.set(t.id,r)},s._clearVAO=function(){var t=this._gl;this._vaoMap.forEach(function(e){t.deleteVertexArray(e)}),this._vaoMap.clear()},n}(),uh=function(){function n(i){this._parameters={},this._gl=i,this._parameters={},this._parameters[i.MAX_COMBINED_TEXTURE_IMAGE_UNITS]=i.getParameter(i.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this._parameters[i.MAX_VERTEX_UNIFORM_VECTORS]=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this._parameters[i.MAX_VERTEX_ATTRIBS]=i.getParameter(i.MAX_VERTEX_ATTRIBS),this._parameters[i.MAX_VERTEX_TEXTURE_IMAGE_UNITS]=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._parameters[i.MAX_TEXTURE_SIZE]=i.getParameter(i.MAX_TEXTURE_SIZE),i.blendFuncSeparate(i.ONE,i.ZERO,i.ONE,i.ZERO),i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD),i.colorMask(!0,!0,!0,!0),i.blendColor(0,0,0,0),i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),i.enable(i.DEPTH_TEST),i.depthFunc(i.LESS),i.depthMask(!0),i.disable(i.STENCIL_TEST),i.stencilFuncSeparate(i.FRONT,i.ALWAYS,0,255),i.stencilFuncSeparate(i.BACK,i.ALWAYS,0,255),i.stencilOpSeparate(i.FRONT,i.KEEP,i.KEEP,i.KEEP),i.stencilOpSeparate(i.BACK,i.KEEP,i.KEEP,i.KEEP),i.stencilMask(255),i.enable(i.CULL_FACE),i.cullFace(i.BACK),i.disable(i.POLYGON_OFFSET_FILL),i.polygonOffset(0,0)}var s=n.prototype;return s.getParameter=function(t){return this._parameters[t]},n}(),Tt=function(){function n(i,t,e){this._texture=t,this._rhi=i,this._gl=i.gl,this._isWebGL2=i.isWebGL2,this._target=e,this._glTexture=this._gl.createTexture()}var s=n.prototype;return s.destroy=function(){this._gl.deleteTexture(this._glTexture),this._texture=null,this._glTexture=null,this._formatDetail=null},s.setUseDepthCompareMode=function(t){var e=this._gl;e.texParameteri(this._target,e.TEXTURE_COMPARE_MODE,t?e.COMPARE_REF_TO_TEXTURE:e.NONE)},s.generateMipmaps=function(){(this._texture.width!==1||this._texture.height!==1)&&(this._bind(),this._gl.generateMipmap(this._target))},s._bind=function(){this._rhi.bindTexture(this)},s._init=function(t){var e=this._gl,r=this._isWebGL2,a=this._formatDetail,o=a.internalFormat,l=a.baseFormat,c=a.dataType,_=this._texture,u=_.mipmapCount,d=_.width,h=_.height,f=_.usage,v=_._isDepthTexture;if(this._bind(),r&&!(l===e.LUMINANCE_ALPHA||l===e.ALPHA)&&f!==va.Dynamic)e.texStorage2D(this._target,u,o,d,h);else if(t)for(var m=0;m<u;m++)for(var x=Math.max(1,d>>m),S=0;S<6;S++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+S,m,o,x,x,0,l,c,null);else if(v)e.texImage2D(this._target,0,o,d,h,0,l,c,null);else for(var p=0;p<u;p++){var g=Math.max(1,d>>p),y=Math.max(1,h>>p);e.texImage2D(this._target,p,o,g,y,0,l,c,null)}},s._getPixelBuffer=function(t,e,r,a,o,l,c){var _=this._gl,u=this._formatDetail,d=u.baseFormat,h=u.dataType;_.bindFramebuffer(_.FRAMEBUFFER,this._getReadFrameBuffer()),l>0&&!this._isWebGL2&&(l=0,ve.error("mipLevel only take effect in WebGL2.0")),t!=null?_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_CUBE_MAP_POSITIVE_X+t,this._glTexture,l):_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,this._glTexture,l),_.readPixels(e,r,a,o,d,h,c),_.bindFramebuffer(_.FRAMEBUFFER,null)},s._setWrapMode=function(t,e){var r=this._gl,a=this._isWebGL2,o=this._target,l=this._texture,c=l.width,_=l.height;switch(!a&&t!==yt.Clamp&&(!n._isPowerOf2(c)||!n._isPowerOf2(_))&&(ve.warn("non-power-2 texture is not supported for REPEAT or MIRRORED_REPEAT in WebGL1,and has automatically downgraded to CLAMP_TO_EDGE"),t=yt.Clamp),t){case yt.Clamp:r.texParameteri(o,e,r.CLAMP_TO_EDGE);break;case yt.Repeat:r.texParameteri(o,e,r.REPEAT);break;case yt.Mirror:r.texParameteri(o,e,r.MIRRORED_REPEAT);break}},s._getReadFrameBuffer=function(){var t=this._rhi._readFrameBuffer;return t||(this._rhi._readFrameBuffer=t=this._gl.createFramebuffer()),t},n._isPowerOf2=function(t){return(t&t-1)===0},n._getFormatDetail=function(t,e,r){switch(t){case G.R8G8B8:return{internalFormat:r?e.RGB8:e.RGB,baseFormat:e.RGB,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case G.R8G8B8A8:return{internalFormat:r?e.RGBA8:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case G.R4G4B4A4:return{internalFormat:r?e.RGBA4:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case G.R5G5B5A1:return{internalFormat:r?e.RGB5_A1:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case G.R5G6B5:return{internalFormat:r?e.RGB565:e.RGB,baseFormat:e.RGB,dataType:e.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case G.Alpha8:return{internalFormat:e.ALPHA,baseFormat:e.ALPHA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case G.LuminanceAlpha:return{internalFormat:e.LUMINANCE_ALPHA,baseFormat:e.LUMINANCE_ALPHA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case G.R16G16B16A16:return{internalFormat:r?e.RGBA16F:e.RGBA,baseFormat:e.RGBA,dataType:e.HALF_FLOAT,isCompressed:!1};case G.R32G32B32A32:return{internalFormat:r?e.RGBA32F:e.RGBA,baseFormat:e.RGBA,dataType:e.FLOAT,isCompressed:!1};case G.R32G32B32A32_UInt:return{internalFormat:r?e.RGBA32UI:e.NONE,baseFormat:e.RGBA_INTEGER,dataType:e.UNSIGNED_INT,isCompressed:!1};case G.BC1:return{internalFormat:_e.RGB_S3TC_DXT1_EXT,isCompressed:!0};case G.BC3:return{internalFormat:_e.RGBA_S3TC_DXT5_EXT,isCompressed:!0};case G.BC7:return{internalFormat:_e.RGBA_BPTC_UNORM_EXT,isCompressed:!0};case G.ETC1_RGB:return{internalFormat:_e.RGB_ETC1_WEBGL,isCompressed:!0};case G.ETC2_RGB:return{internalFormat:_e.RGB8_ETC2,isCompressed:!0};case G.ETC2_RGBA5:return{internalFormat:_e.RGB8_PUNCHTHROUGH_ALPHA1_ETC2,isCompressed:!0};case G.ETC2_RGBA8:return{internalFormat:_e.RGBA8_ETC2_EAC,isCompressed:!0};case G.PVRTC_RGB2:return{internalFormat:_e.RGB_PVRTC_2BPPV1_IMG,isCompressed:!0};case G.PVRTC_RGBA2:return{internalFormat:_e.RGBA_PVRTC_2BPPV1_IMG,isCompressed:!0};case G.PVRTC_RGB4:return{internalFormat:_e.RGB_PVRTC_4BPPV1_IMG,isCompressed:!0};case G.PVRTC_RGBA4:return{internalFormat:_e.RGBA_PVRTC_4BPPV1_IMG,isCompressed:!0};case G.ASTC_4x4:return{internalFormat:_e.RGBA_ASTC_4X4_KHR,isCompressed:!0};case G.ASTC_5x5:return{internalFormat:_e.RGBA_ASTC_5X5_KHR,isCompressed:!0};case G.ASTC_6x6:return{internalFormat:_e.RGBA_ASTC_6X6_KHR,isCompressed:!0};case G.ASTC_8x8:return{internalFormat:_e.RGBA_ASTC_8X8_KHR,isCompressed:!0};case G.ASTC_10x10:return{internalFormat:_e.RGBA_ASTC_10X10_KHR,isCompressed:!0};case G.ASTC_12x12:return{internalFormat:_e.RGBA_ASTC_12X12_KHR,isCompressed:!0};case G.Depth:return{internalFormat:r?e.DEPTH_COMPONENT32F:e.DEPTH_COMPONENT,baseFormat:e.DEPTH_COMPONENT,dataType:r?e.FLOAT:e.UNSIGNED_SHORT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case G.DepthStencil:return{internalFormat:r?e.DEPTH32F_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:r?e.FLOAT_32_UNSIGNED_INT_24_8_REV:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case G.Depth16:return{internalFormat:r?e.DEPTH_COMPONENT16:e.DEPTH_COMPONENT,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_SHORT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case G.Depth24Stencil8:return{internalFormat:r?e.DEPTH24_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case G.Depth24:return{internalFormat:e.DEPTH_COMPONENT24,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_INT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case G.Depth32:return{internalFormat:e.DEPTH_COMPONENT32F,baseFormat:e.DEPTH_COMPONENT,dataType:e.FLOAT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case G.Depth32Stencil8:return{internalFormat:e.DEPTH32F_STENCIL8,baseFormat:e.DEPTH_STENCIL,dataType:e.FLOAT_32_UNSIGNED_INT_24_8_REV,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};default:throw new Error("this TextureFormat is not supported in Galacean Engine: "+t)}},n._getRenderBufferDepthFormatDetail=function(t,e,r){switch(t){case G.Depth:return{internalFormat:r?e.DEPTH_COMPONENT32F:e.DEPTH_COMPONENT16,baseFormat:e.DEPTH_COMPONENT,dataType:r?e.FLOAT:e.UNSIGNED_SHORT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case G.DepthStencil:return{internalFormat:r?e.DEPTH32F_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:r?e.FLOAT_32_UNSIGNED_INT_24_8_REV:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case G.Stencil:return{internalFormat:e.STENCIL_INDEX8,baseFormat:e.STENCIL_ATTACHMENT,dataType:e.UNSIGNED_BYTE,isCompressed:!1,attachment:e.STENCIL_ATTACHMENT};case G.Depth16:return{internalFormat:e.DEPTH_COMPONENT16,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_SHORT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case G.Depth24Stencil8:return{internalFormat:r?e.DEPTH24_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case G.Depth24:return{internalFormat:e.DEPTH_COMPONENT24,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_INT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case G.Depth32:return{internalFormat:e.DEPTH_COMPONENT32F,baseFormat:e.DEPTH_COMPONENT,dataType:e.FLOAT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case G.Depth32Stencil8:return{internalFormat:e.DEPTH32F_STENCIL8,baseFormat:e.DEPTH_STENCIL,dataType:e.FLOAT_32_UNSIGNED_INT_24_8_REV,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};default:throw new Error("this TextureFormat is not supported in Galacean Engine: "+t)}},n._supportTextureFormat=function(t,e){switch(t){case G.R16G16B16A16:if(!e.canIUse(Q.textureHalfFloat))return!1;break;case G.R32G32B32A32:if(!e.canIUse(Q.textureFloat))return!1;break;case G.Depth16:case G.Depth24Stencil8:case G.Depth:case G.DepthStencil:if(!e.canIUse(Q.depthTexture))return!1;break;case G.R32G32B32A32_UInt:case G.Depth24:case G.Depth32:case G.Depth32Stencil8:return e.isWebGL2}return!0},n._supportRenderBufferColorFormat=function(t,e){var r=!0;switch(t){case G.R16G16B16A16:(!e.canIUse(Q.colorBufferHalfFloat)||!e.canIUse(Q.textureHalfFloat))&&(r=!1);break;case G.R32G32B32A32:(!e.canIUse(Q.colorBufferFloat)||!e.canIUse(Q.textureFloat))&&(r=!1);break}return r},n._supportRenderBufferDepthFormat=function(t,e){if(!e.isWebGL2)switch(t){case G.Depth24:case G.Depth32:case G.Depth32Stencil8:return!1}return!0},ri(n,[{key:"wrapModeU",set:function(t){this._bind(),this._setWrapMode(t,this._gl.TEXTURE_WRAP_S)}},{key:"wrapModeV",set:function(t){this._bind(),this._setWrapMode(t,this._gl.TEXTURE_WRAP_T)}},{key:"filterMode",set:function(t){var e=this._gl,r=this._target,a=this._texture._mipmap;switch(this._bind(),t){case ot.Point:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(r,e.TEXTURE_MIN_FILTER,a?e.NEAREST_MIPMAP_NEAREST:e.NEAREST);break;case ot.Bilinear:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(r,e.TEXTURE_MIN_FILTER,a?e.LINEAR_MIPMAP_NEAREST:e.LINEAR);break;case ot.Trilinear:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(r,e.TEXTURE_MIN_FILTER,a?e.LINEAR_MIPMAP_LINEAR:e.LINEAR);break}}},{key:"anisoLevel",set:function(t){var e=this._gl;this._bind(),e.texParameterf(this._target,e.TEXTURE_MAX_ANISOTROPY_EXT,t)}},{key:"depthCompareFunction",set:function(t){this._bind();var e=this._gl;switch(t){case Cr.Never:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.NEVER);break;case Cr.Less:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.LESS);break;case Cr.Equal:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.EQUAL);break;case Cr.LessEqual:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.LEQUAL);break;case Cr.Greater:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.GREATER);break;case Cr.NotEqual:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.NOTEQUAL);break;case Cr.GreaterEqual:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.GEQUAL);break;case Cr.Always:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.ALWAYS);break}}}]),n}(),dh=function(){function n(i,t){this._MSAAColorRenderBuffers=[],this._curMipLevel=0,this._curFaceIndex=void 0,this._gl=i.gl,this._isWebGL2=i.isWebGL2,this._target=t;for(var e=t._colorTextures,r=t._depth,a=t.width,o=t.height,l=ur(r,Kr),c=0,_=e.length;c<_;c++){var u=e[c]._format;if(!Tt._supportRenderBufferColorFormat(u,i))throw new Error("TextureFormat is not supported:"+G[u]+" in RenderTarget")}if(!l&&!Tt._supportRenderBufferDepthFormat(r,i))throw new Error("TextureFormat is not supported:"+G[r]+" in RenderTarget");if(e.length>1&&!i.canIUse(Q.drawBuffers))throw new Error("MRT is not supported");if(e.some(function(h){return h.width!==a||h.height!==o}))throw new Error("ColorTexture's size must as same as RenderTarget");if(l&&(r.width!==a||r.height!==o))throw new Error("DepthTexture's size must as same as RenderTarget");if(e.length>1&&e.some(function(h){return ur(h,tr)}))throw new Error("MRT+Cube+[,MSAA] is not supported");var d=i.capability.maxAntiAliasing;t.antiAliasing>d&&(ve.warn("MSAA antiAliasing exceeds the limit and is automatically downgraded to:"+d),t._antiAliasing=d),this._frameBuffer=this._gl.createFramebuffer(),this._bindMainFBO(),t.antiAliasing>1&&(this._MSAAFrameBuffer=this._gl.createFramebuffer(),this._bindMSAAFBO())}var s=n.prototype;return s.activeRenderTarget=function(t,e){var r=this,a=r._gl,o=r._target;a.bindFramebuffer(a.FRAMEBUFFER,this._frameBuffer);var l=t!==this._curMipLevel,c=e!==this._curFaceIndex,_=o.getColorTexture(0);if(_){var u=ur(_,tr);(l||u&&c)&&a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,u?a.TEXTURE_CUBE_MAP_POSITIVE_X+e:a.TEXTURE_2D,_._platformTexture._glTexture,t)}var d=o.depthTexture;if(d){var h=ur(d,tr);if(l||h){var f=d._platformTexture;a.framebufferTexture2D(a.FRAMEBUFFER,f._formatDetail.attachment,h?a.TEXTURE_CUBE_MAP_POSITIVE_X+e:a.TEXTURE_2D,f._glTexture,t)}}else if(l){var v=Tt._getRenderBufferDepthFormatDetail(o._depth,a,this._isWebGL2).internalFormat;a.bindRenderbuffer(a.RENDERBUFFER,this._depthRenderBuffer),a.renderbufferStorage(a.RENDERBUFFER,v,o.width>>t,o.height>>t)}this._curMipLevel=t,this._curFaceIndex=e,this._MSAAFrameBuffer&&a.bindFramebuffer(a.FRAMEBUFFER,this._MSAAFrameBuffer)},s.blitRenderTarget=function(){if(!!this._MSAAFrameBuffer){var t=this._gl,e=t.COLOR_BUFFER_BIT|(this._target.depthTexture?t.DEPTH_BUFFER_BIT:0),r=this._target,a=r.colorTextureCount,o=r.width,l=r.height;t.bindFramebuffer(t.READ_FRAMEBUFFER,this._MSAAFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this._frameBuffer);for(var c=0;c<a;c++){var _=t.COLOR_ATTACHMENT0+c;this._blitDrawBuffers[c]=_,t.readBuffer(_),t.drawBuffers(this._blitDrawBuffers),t.blitFramebuffer(0,0,o,l,0,0,o,l,e,t.NEAREST),this._blitDrawBuffers[c]=t.NONE}t.bindFramebuffer(t.FRAMEBUFFER,null)}},s.destroy=function(){var t=this._gl;this._frameBuffer&&t.deleteFramebuffer(this._frameBuffer),this._depthRenderBuffer&&t.deleteRenderbuffer(this._depthRenderBuffer),this._MSAAFrameBuffer&&t.deleteFramebuffer(this._MSAAFrameBuffer),this._MSAADepthRenderBuffer&&t.deleteRenderbuffer(this._MSAADepthRenderBuffer);for(var e=0;e<this._MSAAColorRenderBuffers.length;e++)t.deleteRenderbuffer(this._MSAAColorRenderBuffers[e]);this._frameBuffer=null,this._depthRenderBuffer=null,this._MSAAFrameBuffer=null,this._MSAAColorRenderBuffers.length=0,this._MSAADepthRenderBuffer=null},s._bindMainFBO=function(){var t=this._gl,e=this._isWebGL2,r=this._target,a=r._depth,o=r.colorTextureCount,l=r.width,c=r.height,_=new Array(o);t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer);for(var u=0;u<o;u++){var d=this._target.getColorTexture(u),h=t.COLOR_ATTACHMENT0+u;_[u]=h,ur(d,tr)||t.framebufferTexture2D(t.FRAMEBUFFER,h,t.TEXTURE_2D,d._platformTexture._glTexture,0)}if(o>1&&t.drawBuffers(_),this._oriDrawBuffers=_,a!==null){if(ur(a,Kr)&&!ur(a,tr)){var f=a._platformTexture;t.framebufferTexture2D(t.FRAMEBUFFER,f._formatDetail.attachment,t.TEXTURE_2D,f._glTexture,0)}else if(this._target.antiAliasing<=1){var v=Tt._getRenderBufferDepthFormatDetail(a,t,e),p=v.internalFormat,g=v.attachment,y=t.createRenderbuffer();this._depthRenderBuffer=y,t.bindRenderbuffer(t.RENDERBUFFER,y),t.renderbufferStorage(t.RENDERBUFFER,p,l,c),t.framebufferRenderbuffer(t.FRAMEBUFFER,g,t.RENDERBUFFER,y)}}t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},s._bindMSAAFBO=function(){var t=this._gl,e=this._isWebGL2,r=t.createRenderbuffer(),a=this._target,o=a._depth,l=a.colorTextureCount,c=a.antiAliasing,_=a.width,u=a.height;this._blitDrawBuffers=new Array(l),this._MSAADepthRenderBuffer=r,t.bindFramebuffer(t.FRAMEBUFFER,this._MSAAFrameBuffer);for(var d=0;d<l;d++){var h=t.createRenderbuffer();this._MSAAColorRenderBuffers[d]=h,this._blitDrawBuffers[d]=t.NONE,t.bindRenderbuffer(t.RENDERBUFFER,h),t.renderbufferStorageMultisample(t.RENDERBUFFER,c,this._target.getColorTexture(d)._platformTexture._formatDetail.internalFormat,_,u),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+d,t.RENDERBUFFER,h)}if(t.drawBuffers(this._oriDrawBuffers),o!==null){var f=ur(o,Kr)?o._platformTexture._formatDetail:Tt._getRenderBufferDepthFormatDetail(o,t,e),v=f.internalFormat,p=f.attachment;t.bindRenderbuffer(t.RENDERBUFFER,r),t.renderbufferStorageMultisample(t.RENDERBUFFER,c,v,_,u),t.framebufferRenderbuffer(t.FRAMEBUFFER,p,t.RENDERBUFFER,r)}this._checkFrameBuffer(),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},s._checkFrameBuffer=function(){var t=this._gl,e=this._isWebGL2,r=t.checkFramebufferStatus(t.FRAMEBUFFER);switch(r){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete");case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment");case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error(" Height and width of the attachment are not the same.");case t.FRAMEBUFFER_UNSUPPORTED:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer")}if(e&&r===t.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE)throw new Error("The values of gl.RENDERBUFFER_SAMPLES are different among attached renderbuffers, or are non-zero if the attached images are a mix of renderbuffers and textures.")},n}(),hh=function(n){ni(s,n);function s(t,e){var r;r=n.call(this,t,e,t.gl.TEXTURE_2D)||this,r._compressedMipFilled=0;var a=e.format,o=e._mipmap,l=e.width,c=e.height,_=r._isWebGL2;if(!Tt._supportTextureFormat(a,t))throw new Error("Texture format is not supported:"+G[a]);return o&&!_&&(!Tt._isPowerOf2(l)||!Tt._isPowerOf2(c))&&(ve.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),e._mipmap=!1,e._mipmapCount=e._getMipmapCount()),r._formatDetail=Tt._getFormatDetail(a,r._gl,_),r._formatDetail.isCompressed&&!_||r._init(!1),r}var i=s.prototype;return i.setPixelBuffer=function(e,r,a,o,l,c){r===void 0&&(r=0);var _=this._gl,u=this._isWebGL2,d=this._formatDetail,h=d.internalFormat,f=d.baseFormat,v=d.dataType,p=d.isCompressed,g=Math.max(1,this._texture.width>>r),y=Math.max(1,this._texture.height>>r);if(l=l||g-a,c=c||y-o,this._bind(),_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,0),_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),p){var m=1<<r;u||this._compressedMipFilled&m?_.compressedTexSubImage2D(this._target,r,a,o,l,c,h,e):(_.compressedTexImage2D(this._target,r,h,l,c,0,e),this._compressedMipFilled|=m)}else _.texSubImage2D(this._target,r,a,o,l,c,f,v,e)},i.setImageSource=function(e,r,a,o,l,c){var _=this._gl,u=this._formatDetail,d=u.internalFormat,h=u.baseFormat,f=u.dataType;this._bind(),_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,+a),_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+o),this._texture.usage===va.Dynamic?_.texImage2D(this._target,r,d,h,f,e):_.texSubImage2D(this._target,r,l||0,c||0,h,f,e)},i.getPixelBuffer=function(e,r,a,o,l,c){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");n.prototype._getPixelBuffer.call(this,null,e,r,a,o,l,c)},s}(Tt),fh=function(n){ni(s,n);function s(t,e){var r;r=n.call(this,t,e,t.gl.TEXTURE_2D_ARRAY)||this;var a=e.format,o=e.width,l=e.height,c=e.length,_=e.mipmapCount;if(!r._isWebGL2)throw new Error("Texture2D Array is not supported in WebGL1.0");if(!Tt._supportTextureFormat(a,t))throw new Error("Texture format is not supported:"+G[a]);return r._bind(),r._formatDetail=Tt._getFormatDetail(a,r._gl,!0),r._gl.texStorage3D(r._target,_,r._formatDetail.internalFormat,o,l,c),r}var i=s.prototype;return i.setPixelBuffer=function(e,r,a,o,l,c,_,u){var d=this,h=d._target,f=d._gl,v=this._formatDetail,p=v.internalFormat,g=v.baseFormat,y=v.dataType,m=v.isCompressed;c=c||Math.max(1,this._texture.width>>a)-o,_=_||Math.max(1,this._texture.height>>a)-l,u=u||this._texture.length,this._bind(),f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,0),f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),m?f.compressedTexSubImage3D(h,a,o,l,e,c,_,u,p,r):f.texSubImage3D(h,a,o,l,e,c,_,u,g,y,r)},i.setImageSource=function(e,r,a,o,l,c,_){var u=this._gl,d=this._formatDetail,h=d.baseFormat,f=d.dataType;this._bind(),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,+o),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+l);var v,p;u.texSubImage3D(this._target,a,c,_,e,(v=r.width)!=null?v:r.codedWidth,(p=r.height)!=null?p:r.codedHeight,1,h,f,r)},i.getPixelBuffer=function(e,r,a,o,l,c,_){var u=this,d=u._gl,h=u._formatDetail;if(h.isCompressed)throw new Error("Unable to read compressed texture");d.bindFramebuffer(d.FRAMEBUFFER,this._getReadFrameBuffer()),d.framebufferTextureLayer(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,this._glTexture,c,e),d.readPixels(r,a,o,l,h.baseFormat,h.dataType,_),d.bindFramebuffer(d.FRAMEBUFFER,null)},s}(Tt),vh=function(n){ni(s,n);function s(t,e){var r;r=n.call(this,t,e,t.gl.TEXTURE_CUBE_MAP)||this,r._compressedFaceFilled=[0,0,0,0,0,0];var a=e.format,o=e._mipmap,l=e.width,c=r._isWebGL2;if(!Tt._supportTextureFormat(a,t))throw new Error("Texture format is not supported:"+G[a]);return o&&!c&&!Tt._isPowerOf2(l)&&(ve.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),e._mipmap=!1,e._mipmapCount=e._getMipmapCount()),r._formatDetail=Tt._getFormatDetail(a,r._gl,c),r._formatDetail.isCompressed&&!c||r._init(!0),r}var i=s.prototype;return i.setPixelBuffer=function(e,r,a,o,l,c,_){var u=this._gl,d=this._isWebGL2,h=this._formatDetail,f=h.internalFormat,v=h.baseFormat,p=h.dataType,g=h.isCompressed,y=Math.max(1,this._texture.width>>a);if(c=c||y-o,_=_||y-l,this._bind(),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,0),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),g){var m=1<<a;d||this._compressedFaceFilled[e]&m?u.compressedTexSubImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+e,a,o,l,c,_,f,r):(u.compressedTexImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+e,a,f,c,_,0,r),this._compressedFaceFilled[e]|=m)}else u.texSubImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+e,a,o,l,c,_,v,p,r)},i.setImageSource=function(e,r,a,o,l,c,_){var u=this._gl,d=this._formatDetail,h=d.baseFormat,f=d.dataType;this._bind(),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,+o),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+l),u.texSubImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+e,a,c||0,_||0,h,f,r)},i.getPixelBuffer=function(e,r,a,o,l,c,_){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");n.prototype._getPixelBuffer.call(this,e,r,a,o,l,c,_)},s}(Tt),Is;(function(n){n[n.Auto=0]="Auto",n[n.WebGL2=1]="WebGL2",n[n.WebGL1=2]="WebGL1"})(Is||(Is={}));var ph=function(){function n(i){i===void 0&&(i={}),this._readFrameBuffer=null,this._mainFrameBuffer=null,this._mainFrameWidth=0,this._mainFrameHeight=0,this._enableGlobalDepthBias=!1,this._activeTextures=new Array(32),this._lastViewport=new ae(null,null,null,null),this._lastScissor=new ae(null,null,null,null),this._lastClearColor=new j(null,null,null,null),this._scissorEnable=!1;var t=Hi({webGLMode:0,stencil:!0,_forceFlush:!1,_maxAllowSkinUniformVectorCount:256},i);if(Zr.platform===Ht.IPhone||Zr.platform===Ht.IPad){var e=Zr.operatingSystem.match(/(\d+).?(\d+)?.?(\d+)?/);if(e){var r=parseInt(e[1]),a=parseInt(e[2]);r===15&&a>=0&&a<=4&&(t._forceFlush=!0)}}this._options=t,this._onWebGLContextLost=this._onWebGLContextLost.bind(this),this._onWebGLContextRestored=this._onWebGLContextRestored.bind(this)}var s=n.prototype;return s.init=function(t,e,r){var a=this._options,o=t._webCanvas,l=a.webGLMode;this._onDeviceLost=e,this._onDeviceRestored=r,o.addEventListener("webglcontextlost",this._onWebGLContextLost,!1),o.addEventListener("webglcontextrestored",this._onWebGLContextRestored,!1),o.addEventListener("webglcontextcreationerror",this._onContextCreationError,!1),this._webCanvas=o;var c;if((l==0||l==1)&&(c=o.getContext("webgl2",a),!c&&(typeof OffscreenCanvas>"u"||!ur(o,OffscreenCanvas))&&(c=o.getContext("experimental-webgl2",a)),this._isWebGL2=!0,c&&!c.deleteQuery&&(this._isWebGL2=!1)),c||(l==0||l==2)&&(c=o.getContext("webgl",a),!c&&(typeof OffscreenCanvas>"u"||!ur(o,OffscreenCanvas))&&(c=o.getContext("experimental-webgl",a)),this._isWebGL2=!1),!c)throw new Error("Get GL Context FAILED.");this._gl=c,this._initGLState(c)},s.createPlatformPrimitive=function(t){return new _h(this,t)},s.createPlatformTexture2D=function(t){return new hh(this,t)},s.createPlatformTexture2DArray=function(t){return new fh(this,t)},s.createPlatformTextureCube=function(t){return new vh(this,t)},s.createPlatformRenderTarget=function(t){return new dh(this,t)},s.createPlatformBuffer=function(t,e,r,a){return r===void 0&&(r=tt.Static),new sh(this,t,e,r,a)},s.requireExtension=function(t){return this._extensions.requireExtension(t)},s.canIUse=function(t){return this.capability.canIUse(t)},s.canIUseCompressedTextureInternalFormat=function(t){return this.capability.canIUseCompressedTextureInternalFormat(t)},s.viewport=function(t,e,r,a){var o=this,l=o._gl,c=o._lastViewport;(t!==c.x||e!==c.y||r!==c.z||a!==c.w)&&(l.viewport(t,e,r,a),c.set(t,e,r,a))},s.scissor=function(t,e,r,a){var o=this,l=o._gl,c=o._lastScissor;if(t!==c.x||e!==c.y||r!==c.z||a!==c.w){var _=this,u=_._webCanvas;t===0&&e===0&&r===u.width&&a===u.height?this._scissorEnable&&(l.disable(l.SCISSOR_TEST),this._scissorEnable=!1):(this._scissorEnable||(l.enable(l.SCISSOR_TEST),this._scissorEnable=!0),l.scissor(t,e,r,a)),c.set(t,e,r,a)}},s.colorMask=function(t,e,r,a){this._gl.colorMask(t,e,r,a)},s.clearRenderTarget=function(t,e,r){var a=this._gl,o=t._lastRenderState,l=o.blendState.targetBlendState,c=o.depthState,_=o.stencilState,u=0;if(e&Lt.Color){u|=a.COLOR_BUFFER_BIT;var d=this._lastClearColor,h=r.r,f=r.g,v=r.b,p=r.a;r&&(h!==d.r||f!==d.g||v!==d.b||p!==d.a)&&(a.clearColor(h,f,v,p),d.set(h,f,v,p)),l.colorWriteMask!==Er.All&&(a.colorMask(!0,!0,!0,!0),l.colorWriteMask=Er.All)}e&Lt.Depth&&(u|=a.DEPTH_BUFFER_BIT,c.writeEnabled!==!0&&(a.depthMask(!0),c.writeEnabled=!0)),e&Lt.Stencil&&(u|=a.STENCIL_BUFFER_BIT,_.writeMask!==255&&(a.stencilMask(255),_.writeMask=255)),a.clear(u)},s.drawPrimitive=function(t,e,r){t?t.draw(r,e):ve.error("draw primitive failed.")},s.getMainFrameBufferWidth=function(){return this._mainFrameWidth||this._gl.drawingBufferWidth},s.getMainFrameBufferHeight=function(){return this._mainFrameHeight||this._gl.drawingBufferHeight},s.activeRenderTarget=function(t,e,r,a,o){var l,c;if(t){t._isContentLost=!1;var _=t._platformRenderTarget;_.activeRenderTarget(a,o),l=t.width>>a,c=t.height>>a}else{var u=this._gl;u.bindFramebuffer(u.FRAMEBUFFER,this._mainFrameBuffer),l=this.getMainFrameBufferWidth(),c=this.getMainFrameBufferHeight()}var d=l*e.z,h=c*e.w,f=e.x*l,v=r?e.y*c:c-e.y*c-h;this.viewport(f,v,d,h),this.scissor(f,v,d,h)},s.activeTexture=function(t){this._activeTextureID!==t&&(this._gl.activeTexture(t),this._activeTextureID=t)},s.bindTexture=function(t){var e=this._activeTextureID-this._gl.TEXTURE0;this._activeTextures[e]!==t&&(this._gl.bindTexture(t._target,t._glTexture),this._activeTextures[e]=t)},s.setGlobalDepthBias=function(t,e){var r=this._gl,a=t!==0||e!==0;a?(r.enable(r.POLYGON_OFFSET_FILL),r.polygonOffset(e,t)):r.disable(r.POLYGON_OFFSET_FILL),this._enableGlobalDepthBias=a},s.flush=function(){this._gl.flush()},s.forceLoseDevice=function(){var t=this.requireExtension(Q.WEBGL_lose_context);t.loseContext()},s.forceRestoreDevice=function(){var t=this.requireExtension(Q.WEBGL_lose_context);t.restoreContext()},s.resetState=function(){this._readFrameBuffer=null,this._enableGlobalDepthBias=!1,this._currentBindShaderProgram=null;for(var t=this._activeTextures,e=0,r=t.length;e<r;e++)t[e]=null;this._lastViewport.set(null,null,null,null),this._lastScissor.set(null,null,null,null),this._lastClearColor.set(null,null,null,null),this._scissorEnable=!1,this._initGLState(this._gl)},s._initGLState=function(t){this._activeTextureID=t.TEXTURE0,this._renderStates=new uh(t),this._extensions=new ch(this),this._capability=new lh(this),t.activeTexture(t.TEXTURE0);var e=t.getExtension("WEBGL_debug_renderer_info");e!=null&&(this._renderer=t.getParameter(e.UNMASKED_RENDERER_WEBGL))},s.destroy=function(){var t=this._webCanvas;t.removeEventListener("webglcontextcreationerror",this._onContextCreationError,!1),t.removeEventListener("webglcontextlost",this._onWebGLContextLost,!1),t.removeEventListener("webglcontextrestored",this._onWebGLContextRestored,!1)},s._onContextCreationError=function(t){console.error("WebGLRenderer: WebGL context could not be created. Reason: ",t.statusMessage)},s._onWebGLContextLost=function(t){t.preventDefault(),this._onDeviceLost()},s._onWebGLContextRestored=function(t){this._onDeviceRestored()},ri(n,[{key:"isWebGL2",get:function(){return this._isWebGL2}},{key:"renderer",get:function(){return this._renderer}},{key:"gl",get:function(){return this._gl}},{key:"renderStates",get:function(){return this._renderStates}},{key:"capability",get:function(){return this._capability}},{key:"canIUseMoreJoints",get:function(){return this.capability.canIUseMoreJoints}}]),n}();function zt(){return zt=Object.assign||function(s){for(var i=1;i<arguments.length;i++){var t=arguments[i];for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(s[e]=t[e])}return s},zt.apply(this,arguments)}function Wi(n,s){return Wi=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},Wi(n,s)}function se(n,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(s&&s.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),s&&Wi(n,s)}function de(n,s,i,t){var e=arguments.length,r=e<3?s:t===null?t=Object.getOwnPropertyDescriptor(s,i):t,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(n,s,i,t);else for(var o=n.length-1;o>=0;o--)(a=n[o])&&(r=(e<3?a(r):e>3?a(s,i,r):a(s,i))||r);return e>3&&r&&Object.defineProperty(s,i,r),r}function ro(n,s){var i={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},t,e,r,a;return a={next:o(0),throw:o(1),return:o(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function o(c){return function(_){return l([c,_])}}function l(c){if(t)throw new TypeError("Generator is already executing.");for(;a&&(a=0,c[0]&&(i=0)),i;)try{if(t=1,e&&(r=c[0]&2?e.return:c[0]?e.throw||((r=e.return)&&r.call(e),0):e.next)&&!(r=r.call(e,c[1])).done)return r;switch(e=0,r&&(c=[c[0]&2,r.value]),c[0]){case 0:case 1:r=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,e=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(r=i.trys,!(r=r.length>0&&r[r.length-1])&&(c[0]===6||c[0]===2)){i=0;continue}if(c[0]===3&&(!r||c[1]>r[0]&&c[1]<r[3])){i.label=c[1];break}if(c[0]===6&&i.label<r[1]){i.label=r[1],r=c;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(c);break}r[2]&&i.ops.pop(),i.trys.pop();continue}c=s.call(n,i)}catch(_){c=[6,_],e=0}finally{t=r=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}function Fs(n,s){for(var i=0;i<s.length;i++){var t=s[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function no(n,s,i){return s&&Fs(n.prototype,s),i&&Fs(n,i),n}var la=function(){function n(i,t,e,r){t===void 0&&(t=0),r===void 0&&(r=!0),this.data=i,this._dataView=new DataView(i.buffer,i.byteOffset+t,e??i.byteLength-t),this._littleEndian=r,this._position=0,this._baseOffset=t}var s=n.prototype;return s.nextUint8=function(){var t=this._dataView.getUint8(this._position);return this._position+=1,t},s.nextUint16=function(){var t=this._dataView.getUint16(this._position,this._littleEndian);return this._position+=2,t},s.nextUint32=function(){var t=this._dataView.getUint32(this._position,this._littleEndian);return this._position+=4,t},s.nextInt32=function(){var t=this._dataView.getInt32(this._position,this._littleEndian);return this._position+=4,t},s.nextInt32Array=function(t){var e=new Int32Array(this.data.buffer,this._position+this._dataView.byteOffset,t);return this._position+=4*t,e},s.nextFloat32=function(){var t=this._dataView.getFloat32(this._position,this._littleEndian);return this._position+=4,t},s.nextFloat32Array=function(t){var e=new Float32Array(this.data.buffer,this._position+this._dataView.byteOffset,t);return this._position+=4*t,e},s.nextUint32Array=function(t){var e=new Uint32Array(this.data.buffer,this._position+this._dataView.byteOffset,t);return this._position+=4*t,e},s.nextUint8Array=function(t){var e=new Uint8Array(this.data.buffer,this._position+this._dataView.byteOffset,t);return this._position+=t,e},s.nextUint64=function(){var t=this._dataView.getUint32(this._position,this._littleEndian),e=this._dataView.getUint32(this._position+4,this._littleEndian),r=t+Math.pow(2,32)*e;return this._position+=8,r},s.nextStr=function(){var t=this.nextUint16(),e=new Uint8Array(this.data.buffer,this._position+this._dataView.byteOffset,t);return this._position+=t,We.decodeText(e)},s.nextImageData=function(t){return new Uint8Array(this.data.buffer,this.data.byteOffset+this._position)},s.nextImagesData=function(t){for(var e=new Array(t),r=0;r<t;r++){var a=this._dataView.getUint32(this._position,this._littleEndian);e[r]=a,this._position+=4}for(var o=[],l=0;l<t;l++){var c=e[l],_=new Uint8Array(this.data.buffer,this._dataView.byteOffset+this._position,c);this._position+=c,o.push(_)}return o},s.skip=function(t){return this._position+=t,this},s.scan=function(t,e){e===void 0&&(e=0);for(var r=this._position,a=0;this._dataView.getUint8(this._position)!==e&&a<t;)a++,this._position++;return a<t&&this._position++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+r,a)},no(n,[{key:"position",get:function(){return this._position}},{key:"offset",get:function(){return this._position+this._baseOffset}}]),n}(),Nc={};function rs(n){return function(s){Nc[n]=s}}var gh=function(){function n(){this.totalLength=0,this.version=0,this.type="",this.name="",this.headerLength=0}return n.decode=function(i){var t=new DataView(i),e=t.getUint32(0,!0),r=t.getUint8(4),a=t.getUint16(5,!0),o=new Uint8Array(i,7,a),l=t.getUint16(7+a,!0),c=new Uint8Array(i,9+a,l),_=We.decodeText(c),u=We.decodeText(o),d=new n;return d.totalLength=e,d.name=_,d.type=u,d.version=r,d.headerLength=c.byteLength+o.byteLength+9,d},no(n,[{key:"dataLength",get:function(){return this.totalLength-this.headerLength}}]),n}(),Os=function(){function n(){}return n.decode=function(i,t){return new Promise(function(e){var r=new ct(i),a=t.nextStr(),o=JSON.parse(a);o.bounds&&r.bounds.copyFrom(o.bounds);var l=Math.ceil(t.offset/4)*4+t.data.byteOffset,c=t.data.buffer,_=new Float32Array(c,o.positions.start+l,(o.positions.end-o.positions.start)/4),u=_.length/3,d=Ci(_,u);if(r.setPositions(d),o.normals){var h=new Float32Array(c,o.normals.start+l,(o.normals.end-o.normals.start)/4),f=Ci(h,u);r.setNormals(f)}if(o.uvs){var v=new Float32Array(c,o.uvs.start+l,(o.uvs.end-o.uvs.start)/4);r.setUVs(Pn(v,u))}if(o.uv1){var p=new Float32Array(c,o.uv1.start+l,(o.uv1.end-o.uv1.start)/4);r.setUVs(Pn(p,u),1)}if(o.uv2){var g=new Float32Array(c,o.uv2.start+l,(o.uv2.end-o.uv2.start)/4);r.setUVs(Pn(g,u),2)}if(o.uv3){var y=new Float32Array(c,o.uv3.start+l,(o.uv3.end-o.uv3.start)/4);r.setUVs(Pn(y,u),3)}if(o.uv4){var m=new Float32Array(c,o.uv4.start+l,(o.uv4.end-o.uv4.start)/4);r.setUVs(Pn(m,u),4)}if(o.uv5){var x=new Float32Array(c,o.uv5.start+l,(o.uv5.end-o.uv5.start)/4);r.setUVs(Pn(x,u),5)}if(o.uv6){var S=new Float32Array(c,o.uv6.start+l,(o.uv6.end-o.uv6.start)/4);r.setUVs(Pn(S,u),6)}if(o.uv7){var b=new Float32Array(c,o.uv7.start+l,(o.uv7.end-o.uv7.start)/4);r.setUVs(Pn(b,u),7)}if(o.colors){var A=new Float32Array(c,o.colors.start+l,(o.colors.end-o.colors.start)/4);r.setColors(mh(A,u))}if(o.boneWeights){var C=new Float32Array(c,o.boneWeights.start+l,(o.boneWeights.end-o.boneWeights.start)/4);r.setBoneWeights(lo(C,u))}if(o.boneIndices){var E=new Float32Array(c,o.boneIndices.start+l,(o.boneIndices.end-o.boneIndices.start)/4);r.setBoneIndices(lo(E,u))}if(o.blendShapes&&o.blendShapes.forEach(function(B){var M=new Ho(B.name);B.frames.forEach(function(P){var V=new Float32Array(c,P.deltaPosition.start+l,(P.deltaPosition.end-P.deltaPosition.start)/4),N=V.length/3,F=Ci(V,N);if(P.deltaNormals){var O=new Float32Array(c,P.deltaNormals.start+l,(P.deltaNormals.end-P.deltaNormals.start)/4);Ci(O,N)}if(P.deltaTangents){var D=new Float32Array(c,P.deltaTangents.start+l,(P.deltaTangents.end-P.deltaTangents.start)/4);lo(D,N)}M.addFrame(P.weight,F)}),r.addBlendShape(M)}),o.indices){var T=null;o.indices.type===0?T=new Uint16Array(c,o.indices.start+l,(o.indices.end-o.indices.start)/2):T=new Uint32Array(c,o.indices.start+l,(o.indices.end-o.indices.start)/4),r.setIndices(T)}o.subMeshes.forEach(function(B){return r.addSubMesh(B)}),r.uploadData(!1),e(r)})},n}();Os=de([rs("Mesh")],Os);function mh(n,s){for(var i=new Array(s),t=0;t<s;t++)i[t]=new j(n[t*4],n[t*4+1],n[t*4+2],n[t*4+3]);return i}function lo(n,s){for(var i=new Array(s),t=0;t<s;t++)i[t]=new ae(n[t*4],n[t*4+1],n[t*4+2],n[t*4+3]);return i}function Ci(n,s){for(var i=new Array(s),t=0;t<s;t++)i[t]=new w(n[t*3],n[t*3+1],n[t*3+2]);return i}function Pn(n,s){for(var i=new Array(s),t=0;t<s;t++)i[t]=new $(n[t*2],n[t*2+1]);return i}var zs=function(){function n(){}return n.decode=function(i,t){return new Promise(function(e,r){var a=t.nextStr(),o=!!t.nextUint8(),l=t.nextUint8(),c=t.nextUint8(),_=t.nextUint8(),u=t.nextUint8(),d=t.nextUint8(),h=t.nextUint16(),f=t.nextUint16(),v=t.nextUint8(),p=t.nextUint8(),g=t.nextImagesData(p),y=new bt(i,h,f,d,o);if(y.filterMode=l,y.anisoLevel=c,y.wrapModeU=_,y.wrapModeV=u,v){var m=g[0];if(y.setPixelBuffer(m),o){y.generateMipmaps();for(var x=1;x<p;x++){var S=g[x];y.setPixelBuffer(S,x)}}i.resourceManager._objectPool[a]=y,e(y)}else{var b=new window.Blob([g[0]]),A=new Image;A.onload=function(){y.setImageSource(A);var C=0,E=function(){C++,C>=p&&e(y)};if(E(),o){var T=function(M){var P=new window.Blob([g[M]]),V=new Image;V.onload=function(){y.setImageSource(V,M),E()},V.src=URL.createObjectURL(P)};y.generateMipmaps();for(var B=1;B<p;B++)T(B)}},A.src=URL.createObjectURL(b)}})},n}();zs=de([rs("Texture2D")],zs);function yh(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Ai(n,s,i){return yh()?Ai=Reflect.construct:Ai=function(e,r,a){var o=[null];o.push.apply(o,r);var l=Function.bind.apply(e,o),c=new l;return a&&Wi(c,a.prototype),c},Ai.apply(null,arguments)}var ns=function(){function n(i){this._context=i}var s=n.prototype;return s.parseEntity=function(t){return this._getEntityByConfig(t).then(function(e){var r;e.isActive=(r=t.isActive)!=null?r:!0;var a=t.position,o=t.rotation,l=t.scale;a&&e.transform.position.copyFrom(a),o&&e.transform.rotation.copyFrom(o),l&&e.transform.scale.copyFrom(l);var c;return e.layer=(c=t.layer)!=null?c:e.layer,e})},s.parseClassObject=function(t){var e=this,r=De.getClass(t.class),a,o=(a=t.constructParams)!=null?a:[];return Promise.all(o.map(function(l){return e.parseBasicType(l)})).then(function(l){return Ai(r,[].concat(l))}).then(function(l){return e.parsePropsAndMethods(l,t)})},s.parsePropsAndMethods=function(t,e){var r=[];if(e.methods)for(var a in e.methods)for(var o=e.methods[a],l=0,c=o.length;l<c;l++)r.push(this.parseMethod(t,a,o[l]));if(e.props){var _=this,u=function(h){var f=e.props[h],v=_.parseBasicType(f,t[h]).then(function(p){return t[h]=p});r.push(v)};for(var d in e.props)u(d)}return Promise.all(r).then(function(){var h=n.customParseComponentHandles[t.constructor.name];return h?h(t,e):t})},s.parseMethod=function(t,e,r){var a=this;return Promise.all(r.map(function(o){return a.parseBasicType(o)})).then(function(o){var l;return(l=t)[e].apply(l,[].concat(o))})},s.parseBasicType=function(t,e){var r=this;if(Array.isArray(t))return Promise.all(t.map(function(_){return r.parseBasicType(_)}));if(typeof t=="object"&&t!=null){if(n._isClass(t))return this.parseClassObject(t);if(n._isAssetRef(t))return this._context.resourceManager.getResourceByRef(t);if(n._isEntityRef(t))return Promise.resolve(this._context.entityMap.get(t.entityId));if(e){var a=this,o=function(_){if(_==="methods"){var u=t[_];for(var d in u)for(var h=u[d],f=0,v=h.length;f<v;f++){var p=h[f],g=a.parseMethod(e,d,p);l.push(g)}}else l.push(a.parseBasicType(t[_],e[_]).then(function(y){return e[_]=y}))},l=[];for(var c in t)o(c);return Promise.all(l).then(function(){return e})}}return Promise.resolve(t)},s._getEntityByConfig=function(t){var e=t.assetRefId,r=this._context.engine;if(e)return r.resourceManager.getResourceByRef({refId:e,key:t.key,isClone:t.isClone}).then(function(o){return o.name=t.name,o});var a=new Qr(r,t.name);return Promise.resolve(a)},n.registerCustomParseComponent=function(t,e){this.customParseComponentHandles[t]=e},n._isClass=function(t){return t.class!=null},n._isAssetRef=function(t){return t.refId!=null},n._isEntityRef=function(t){return t.entityId!=null},n}();(function(){ns.customParseComponentHandles=new Map})();var Ic=function(){function n(i,t,e){this.originalData=i,this.engine=t,this.target=e,this.entityMap=new Map,this.components=new Map,this.assets=new Map,this.entityConfigMap=new Map,this.rootIds=[],this.strippedIds=[],this.resourceManager=t.resourceManager}var s=n.prototype;return s.destroy=function(){this.entityMap.clear(),this.components.clear(),this.assets.clear(),this.entityConfigMap.clear(),this.rootIds.length=0},n}();function Us(n,s){(s==null||s>n.length)&&(s=n.length);for(var i=0,t=new Array(s);i<s;i++)t[i]=n[i];return t}function xh(n,s){if(!!n){if(typeof n=="string")return Us(n,s);var i=Object.prototype.toString.call(n).slice(8,-1);if(i==="Object"&&n.constructor&&(i=n.constructor.name),i==="Map"||i==="Set")return Array.from(i);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return Us(n,s)}}function ua(n,s){var i=typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(i)return(i=i.call(n)).next.bind(i);if(Array.isArray(n)||(i=xh(n))||s&&n&&typeof n.length=="number"){i&&(n=i);var t=0;return function(){return t>=n.length?{done:!0}:{done:!1,value:n[t++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var bh=function(){function n(i){var t=this;this.context=i,this.prefabContextMap=new WeakMap,this.prefabPromiseMap=new Map,this._engine=this.context.engine,this._organizeEntities=this._organizeEntities.bind(this),this._parseComponents=this._parseComponents.bind(this),this._parsePrefabModification=this._parsePrefabModification.bind(this),this._parsePrefabRemovedEntities=this._parsePrefabRemovedEntities.bind(this),this._parsePrefabRemovedComponents=this._parsePrefabRemovedComponents.bind(this),this._clearAndResolve=this._clearAndResolve.bind(this),this.promise=new Promise(function(e,r){t._reject=r,t._resolve=e}),this._reflectionParser=new ns(i)}var s=n.prototype;return s.start=function(){this._parseEntities().then(this._organizeEntities).then(this._parseComponents).then(this._parsePrefabModification).then(this._parsePrefabRemovedEntities).then(this._parsePrefabRemovedComponents).then(this._clearAndResolve).then(this._resolve).catch(this._reject)},s._parseEntities=function(){var t=this,e=this.context.originalData.entities,r=this.context.entityConfigMap,a=this.context.entityMap,o=this._engine,l=e.map(function(c){var _,u=(_=c.strippedId)!=null?_:c.id;return c.id=u,r.set(u,c),t._getEntityByConfig(c,o)});return Promise.all(l).then(function(c){for(var _=0,u=c.length;_<u;_++)a.set(e[_].id,c[_]);return c})},s._parseComponents=function(){for(var t=this.context.originalData.entities,e=this.context.entityMap,r=this.context.components,a=[],o=0,l=t.length;o<l;o++)for(var c=t[o],_=e.get(c.id),u=0;u<c.components.length;u++){var d=c.components[u],h=d.refId?d.refId:d.class,f=_.addComponent(De.getClass(h));r.set(d.id,f);var v=this._reflectionParser.parsePropsAndMethods(f,d);a.push(v)}return Promise.all(a)},s._parsePrefabModification=function(){for(var t=function(_,u){var d,h=r[_],f=h.id,v=h.modifications;if((d=v)!=null&&d.length){var p,g=a.get(f);(p=o).push.apply(p,[].concat(v.map(function(y){var m=y.target,x=y.props,S=y.methods,b=m.entityId,A=m.componentId,C=e.prefabContextMap.get(g),E=C.entityMap.get(b),T=C.components.get(A);if(T)return e._reflectionParser.parsePropsAndMethods(T,{props:x,methods:S});if(E)return Promise.resolve(e._applyEntityData(E,x))})))}},e=this,r=this.context.originalData.entities,a=this.context.entityMap,o=[],l=0,c=r.length;l<c;l++)t(l);return Promise.all(o)},s._parsePrefabRemovedEntities=function(){for(var t=function(_,u){var d,h=r[_],f=h.id,v=h.removedEntities;if((d=v)!=null&&d.length){var p,g=a.get(f);(p=o).push.apply(p,[].concat(v.map(function(y){var m=y.entityId,x=e.prefabContextMap.get(g),S=x.entityMap.get(m);S&&S.destroy()})))}},e=this,r=this.context.originalData.entities,a=this.context.entityMap,o=[],l=0,c=r.length;l<c;l++)t(l);return Promise.all(o)},s._parsePrefabRemovedComponents=function(){for(var t=function(_,u){var d,h=r[_],f=h.id,v=h.removedComponents;if((d=v)!=null&&d.length){var p,g=a.get(f);(p=o).concat.apply(p,[].concat(v.map(function(y){var m=y.componentId,x=e.prefabContextMap.get(g),S=x.components.get(m);S&&S.destroy()})))}},e=this,r=this.context.originalData.entities,a=this.context.entityMap,o=[],l=0,c=r.length;l<c;l++)t(l);return Promise.all(o)},s._clearAndResolve=function(){var t=this.context.target;return t},s._organizeEntities=function(){for(var t=this.context,e=t.rootIds,r=t.strippedIds,a=e.concat(r),o=ua(a),l;!(l=o()).done;){var c=l.value;this._parseChildren(c)}for(var _=0;_<e.length;_++)this.handleRootEntity(e[_])},s._getEntityByConfig=function(t,e){var r=this,a;return t.assetRefId?a=this._parseGLTF(t,e):t.strippedId?a=this._parseStrippedEntity(t):a=this._parseEntity(t,e),a.then(function(o){return r._applyEntityData(o,t)})},s._parseEntity=function(t,e){var r=new Qr(e,t.name);return t.parent||this.context.rootIds.push(t.id),Promise.resolve(r)},s._parseGLTF=function(t,e){var r=this,a=t.assetRefId,o=new Ic(null,e);return e.resourceManager.getResourceByRef({refId:a}).then(function(l){var c=l.instantiateSceneRoot();t.parent||r.context.rootIds.push(t.id),r._traverseAddEntityToMap(c,o,""),r.prefabContextMap.set(c,o);var _=r.prefabPromiseMap.get(t.id);return _&&_.forEach(function(u){u.resolve(o)}),c})},s._parseStrippedEntity=function(t){var e=this;return this.context.strippedIds.push(t.id),new Promise(function(r,a){var o,l=(o=e.prefabPromiseMap.get(t.prefabInstanceId))!=null?o:[];l.push({resolve:r,reject:a}),e.prefabPromiseMap.set(t.prefabInstanceId,l)}).then(function(r){var a=t.prefabSource.entityId;return r.entityMap.get(a)})},s._parseChildren=function(t){var e=this.context,r=e.entityConfigMap,a=e.entityMap,o=r.get(t).children;if(o&&o.length>0)for(var l=a.get(t),c=0;c<o.length;c++){var _=o[c],u=a.get(_);l.addChild(u),this._parseChildren(_)}},s._applyEntityData=function(t,e){e===void 0&&(e={});var r;t.isActive=(r=e.isActive)!=null?r:t.isActive;var a;t.name=(a=e.name)!=null?a:t.name;var o=e.position,l=e.rotation,c=e.scale,_=e.layer;return o&&t.transform.position.copyFrom(o),l&&t.transform.rotation.copyFrom(l),c&&t.transform.scale.copyFrom(c),_&&(t.layer=_),t},s._traverseAddEntityToMap=function(t,e,r){var a=e.entityMap,o=e.components,l={},c={};a.set(r,t),t._components.forEach(function(f){var v=De.getClassName(f.constructor);l[v]||(l[v]=t.getComponents(f.constructor,[]),c[v]=0),o.set(r+":"+v+"/"+c[v]++,f)});for(var _=0,u=t.children.length;_<u;_++){var d=t.children[_],h=r?r+"/"+_:""+_;this._traverseAddEntityToMap(d,e,h)}},n}(),ks;(function(n){n[n.Float=0]="Float",n[n.FloatArray=1]="FloatArray",n[n.Vector2=2]="Vector2",n[n.Vector3=3]="Vector3",n[n.Vector4=4]="Vector4",n[n.Quaternion=5]="Quaternion",n[n.Color=6]="Color",n[n.Array=7]="Array",n[n.Boolean=8]="Boolean",n[n.Rect=9]="Rect",n[n.ReferResource=10]="ReferResource"})(ks||(ks={}));var Gs=function(){function n(){}return n.decode=function(i,t){return new Promise(function(e){for(var r=t.nextStr(),a=new Ko(r),o=t.nextUint16(),l=0;l<o;++l){var c=new to;c.time=t.nextFloat32(),c.functionName=t.nextStr(),c.parameter=JSON.parse(t.nextStr()).val,a.addEvent(c)}for(var _=t.nextUint16(),u=0;u<_;++u){var d=t.nextStr(),h=t.nextStr(),f=De.getClass(h),v=t.nextStr(),p=t.nextStr(),g=void 0,y=t.nextUint8(),m=t.nextUint16(),x=t.nextStr();switch(x){case"AnimationFloatCurve":{g=new Ii,g.interpolation=y;for(var S=0;S<m;++S){var b=new Gt;b.time=t.nextFloat32(),b.value=t.nextFloat32(),b.inTangent=t.nextFloat32(),b.outTangent=t.nextFloat32(),g.addKey(b)}break}case"AnimationArrayCurve":{g=new Li,g.interpolation=y;for(var A=0;A<m;++A){var C=new Gt;C.time=t.nextFloat32();var E=t.nextUint16();C.value=Array.from(t.nextFloat32Array(E)),C.inTangent=Array.from(t.nextFloat32Array(E)),C.outTangent=Array.from(t.nextFloat32Array(E)),g.addKey(C)}break}case"AnimationFloatArrayCurve":{g=new Xa,g.interpolation=y;for(var T=0;T<m;++T){var B=new Gt;B.time=t.nextFloat32();var M=t.nextUint16();B.value=t.nextFloat32Array(M),B.inTangent=Array.from(t.nextFloat32Array(M)),B.outTangent=Array.from(t.nextFloat32Array(M)),g.addKey(B)}break}case"AnimationVector2Curve":{g=new Fi,g.interpolation=y;for(var P=0;P<m;++P){var V=new Gt;V.time=t.nextFloat32(),V.value=new $(t.nextFloat32(),t.nextFloat32()),V.inTangent=new $(t.nextFloat32(),t.nextFloat32()),V.outTangent=new $(t.nextFloat32(),t.nextFloat32()),g.addKey(V)}break}case"AnimationVector3Curve":{g=new ja,g.interpolation=y;for(var N=0;N<m;++N){var F=new Gt;F.time=t.nextFloat32(),F.value=new w(t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),F.inTangent=new w(t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),F.outTangent=new w(t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),g.addKey(F)}break}case"AnimationVector4Curve":{g=new Oi,g.interpolation=y;var O=new Gt;O.time=t.nextFloat32(),O.value=new ae(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),O.inTangent=new ae(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),O.outTangent=new ae(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),g.addKey(O);break}case"AnimationColorCurve":{g=new Ni,g.interpolation=y;for(var D=0;D<m;++D){var z=new Gt;z.time=t.nextFloat32(),z.value=new j(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),z.inTangent=new ae(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),z.outTangent=new ae(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),g.addKey(z)}break}case"AnimationQuaternionCurve":{g=new xa,g.interpolation=y;for(var U=0;U<m;++U){var Y=new Gt;Y.time=t.nextFloat32(),Y.value=new ye(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),Y.inTangent=new ae(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),Y.outTangent=new ae(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),g.addKey(Y)}break}case"AnimationRefCurve":{g=new zi,g.interpolation=y;for(var K=0;K<m;++K){var H=new Gt;H.time=t.nextFloat32();var te=t.nextStr();te?H.value=JSON.parse(te):H.value=null,g.addKey(H)}break}case"AnimationBoolCurve":{g=new Vi,g.interpolation=y;for(var we=0;we<m;++we){var pe=new Gt;pe.time=t.nextFloat32(),pe.value=t.nextUint8()===1,g.addKey(pe)}break}case"AnimationStringCurve":{g=new Ui,g.interpolation=y;for(var oe=0;oe<m;++oe){var Ee=new Gt;Ee.time=t.nextFloat32(),Ee.value=t.nextStr(),g.addKey(Ee)}break}}a.addCurveBinding(d,f,v,p,g)}e(a)})},n}();Gs=de([rs("AnimationClip")],Gs);var Ro;(function(n){n.Sky="Sky",n.Custom="Custom"})(Ro||(Ro={}));var Ch=function(n){se(s,n);function s(i,t,e){var r;return r=n.call(this,i,t,e)||this,r.originalData=i,r.engine=t,r.scene=e,r}return s}(Ic),Sh=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.handleRootEntity=function(e){var r=this.context,a=r.target,o=r.entityMap;a.addRootEntity(o.get(e))},s.parse=function(e,r){var a=new $a(e),o=new Ch(r,e,a),l=new s(o);return l.start(),l.promise},s}(bh),Hs=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Be(function(o,l){a.request(e.url,{type:"arraybuffer"}).then(function(c){ao(c,r.engine).then(function(_){o(_)})}).catch(l)})},s}(De);Hs=de([Qe("Mesh",["prefab"],!0)],Hs);var Ws=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Be(function(o,l){a.request(e.url,{type:"arraybuffer"}).then(function(c){ao(c,r.engine).then(function(_){o(_)})}).catch(l)})},s}(De);Ws=de([Qe("EditorTexture2D",["prefab"],!0)],Ws);function ao(n,s){var i=gh.decode(n),t=new la(new Uint8Array(n),i.headerLength,i.dataLength);return Nc[i.type].decode(s,t).then(function(e){return e.name=i.name,e})}var Xs=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Be(function(o,l){a.request(e.url,zt({},e,{type:"arraybuffer"})).then(function(c){return ao(c,r.engine).then(function(_){var u=_.curveBindings.map(function(d){var h=d.curve,f=h.keys.map(function(v){return a._parseKeyframeValue(v,r).then(function(p){v.value=p})});return Promise.all(f)});return Promise.all(u).then(function(){o(_)})}).catch(l)}).catch(l)})},i._parseKeyframeValue=function(e,r){var a,o=e.value;return typeof o=="object"&&((a=o)==null?void 0:a.refId)?new Promise(function(l){r.getResourceByRef(o).then(function(c){e.value=c,l(e.value)})}):Promise.resolve(e.value)},s}(De);Xs=de([Qe(Fe.AnimationClip,["ani"])],Xs);var js=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Be(function(o,l){a.request(e.url,zt({},e,{type:"json"})).then(function(c){var _=new Zo,u=c.layers,d=[];u.forEach(function(h,f){var v=h.name,p=h.blendingMode,g=h.weight,y=h.stateMachine,m=new $o(v);if(m.blendingMode=p,m.weight=g,y){var x=y.states,S=m.stateMachine=new es;x.forEach(function(b,A){var C,E=b.name,T=b.speed,B=b.wrapMode,M=b.clipStartNormalizedTime,P=b.clipEndNormalizedTime,V=b.isDefaultState,N=b.clip,F=b.scripts,O=S.addState(E);V&&(S.defaultState=O),O.speed=T,O.wrapMode=B,O.clipStartTime=M,O.clipEndTime=P;var D=JSON.parse(F);(C=D)==null||C.forEach(function(z){O.addStateMachineScript(De.getClass(z))}),N&&d.push(new Promise(function(z){r.getResourceByRef(N).then(function(U){z({layerIndex:f,stateIndex:A,clip:U})})}))}),x.forEach(function(b){var A=b.name,C=b.transitions;C.forEach(function(E){var T=E.targetStateName,B=E.duration,M=E.offset,P=E.exitTime,V=S.findStateByName(A),N=S.findStateByName(T),F=new Jo;F.destinationState=N,F.duration=B,F.exitTime=P,F.offset=M,V.addTransition(F)})})}_.addLayer(m)}),Promise.all(d).then(function(h){h.forEach(function(f){var v=f.layerIndex,p=f.stateIndex,g=f.clip;_.layers[v].stateMachine.states[p].clip=g}),o(_)})}).catch(l)})},s}(De);js=de([Qe(Fe.AnimatorController,["json"],!1)],js);function Ah(n){return/^data:(.+?);base64,/.test(n)}var qs=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e){var r=e.url;return Ah(r)?new Be(function(a){var o=r.slice(13+RegExp.$1.length),l=Uint8Array.from(atob(o),function(c){return c.charCodeAt(0)});a(l.buffer)}):this.request(r,zt({},e,{type:"arraybuffer"}))},s}(De);qs=de([Qe(Fe.Buffer,["bin","r3bin"],!1)],qs);var Ys=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Be(function(o,l){a.request(e.url,{type:"arraybuffer"}).then(function(c){var _,u=new Float32Array(c,0,27),d=27*4,h=(_=new Uint16Array(c,d,1))==null?void 0:_[0],f=r.engine,v=new tr(f,h);v.filterMode=ot.Trilinear;for(var p=v.mipmapCount,g=d+2,y=0;y<p;y++)for(var m=h>>y,x=0;x<6;x++){var S=m*m*4,b=new Uint8Array(c,g,S);g+=S,v.setPixelBuffer(Dr.PositiveX+x,b,y)}var A=new Lr(f),C=new Kc;A.diffuseMode=ta.SphericalHarmonics,C.copyFromArray(u),A.diffuseSphericalHarmonics=C,A.specularTexture=v,A.specularTextureDecodeRGBM=!0,o(A)}).catch(function(c){l(c)})})},s}(De);Ys=de([Qe(Fe.Env,["env"])],Ys);function Qs(n,s,i,t,e,r,a){try{var o=n[r](a),l=o.value}catch(c){i(c);return}o.done?s(l):Promise.resolve(l).then(t,e)}function io(n){return function(){var s=this,i=arguments;return new Promise(function(t,e){var r=n.apply(s,i);function a(l){Qs(r,t,e,a,o,"next",l)}function o(l){Qs(r,t,e,a,o,"throw",l)}a(void 0)})}}var Ks=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Be(function(o,l){a.request(e.url,{type:"json"}).then(function(c){var _=c.fontName,u=c.fontUrl;if(u)a._registerFont(_,u).then(function(){var h=new pa(r.engine,_);o(h)}).catch(function(h){l("load font "+u+" fail")});else{var d=new pa(r.engine,_);o(d)}}).catch(function(c){l(c)})})},i._registerFont=function(e,r){return io(function(){var a;return ro(this,function(o){switch(o.label){case 0:return a=new FontFace(e,"url("+r+")"),[4,a.load()];case 1:return o.sent(),document.fonts.add(a),[2]}})})()},s}(De);Ks=de([Qe(Fe.Font,["font"],!1)],Ks);var wh=function(n){se(s,n);function s(t,e){var r;return r=n.call(this,t)||this,r.url=e,r}var i=s.prototype;return i.instantiateSceneRoot=function(e){var r=e===void 0?this._defaultSceneRoot:this._sceneRoots[e];return r.clone()},i._onDestroy=function(){n.prototype._onDestroy.call(this);var e=this,r=e.textures,a=e.materials,o=e.meshes;if(r&&this._disassociationSuperResource(r),a&&this._disassociationSuperResource(a),o)for(var l=0,c=o.length;l<c;l++)this._disassociationSuperResource(o[l])},i._disassociationSuperResource=function(e){for(var r=0,a=e.length;r<a;r++)e[r]._disassociationSuperResource(this)},no(s,[{key:"extensionsData",get:function(){return this._extensionsData}},{key:"sceneRoots",get:function(){return this._sceneRoots}},{key:"defaultSceneRoot",get:function(){return this._defaultSceneRoot}}]),s}(rn),ut;(function(n){n[n.BYTE=5120]="BYTE",n[n.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",n[n.SHORT=5122]="SHORT",n[n.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",n[n.UNSIGNED_INT=5125]="UNSIGNED_INT",n[n.FLOAT=5126]="FLOAT"})(ut||(ut={}));var cn;(function(n){n.SCALAR="SCALAR",n.VEC2="VEC2",n.VEC3="VEC3",n.VEC4="VEC4",n.MAT2="MAT2",n.MAT3="MAT3",n.MAT4="MAT4"})(cn||(cn={}));var Fr;(function(n){n.TRANSLATION="translation",n.ROTATION="rotation",n.SCALE="scale",n.WEIGHTS="weights"})(Fr||(Fr={}));var ca;(function(n){n.Linear="LINEAR",n.Step="STEP",n.CubicSpine="CUBICSPLINE"})(ca||(ca={}));var Xi;(function(n){n.PERSPECTIVE="perspective",n.ORTHOGRAPHIC="orthographic"})(Xi||(Xi={}));var Js;(function(n){n.JPEG="image/jpeg",n.PNG="image/png"})(Js||(Js={}));var Va;(function(n){n.OPAQUE="OPAQUE",n.MASK="MASK",n.BLEND="BLEND"})(Va||(Va={}));var Mo;(function(n){n[n.NEAREST=9728]="NEAREST",n[n.LINEAR=9729]="LINEAR"})(Mo||(Mo={}));var ji;(function(n){n[n.NEAREST=9728]="NEAREST",n[n.LINEAR=9729]="LINEAR",n[n.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",n[n.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",n[n.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",n[n.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(ji||(ji={}));var Na;(function(n){n[n.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",n[n.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",n[n.REPEAT=10497]="REPEAT"})(Na||(Na={}));var as=function(){function n(i,t,e){var r=this;this.glTFResource=i,this.resourceManager=t,this.params=e,this.accessorBufferCache={},this._resourceCache=new Map,this._progress={taskDetail:{},taskComplete:{loaded:0,total:0}},this._onTaskDetail=function(a,o,l){var c,_,u=(c=r._progress.taskDetail)[_=a]||(c[_]={});u.loaded=o,u.total=l,r._setTaskDetailProgress(a,o,l)},this.contentRestorer=new Vh(i)}var s=n.prototype;return s.get=function(t,e){var r=this,a=n._parsers[t];if(!a)return Promise.resolve(null);var o=this._resourceCache,l=t===0||t===1,c=l||e===void 0?""+t:t+":"+e,_=o.get(c);if(_)return _;if(l)_=a.parse(this);else{var u=this.glTF[Eh[t]];u&&(e===void 0||u[e])?e===void 0?_=t===8?u.map(function(d,h){return r.get(t,h)}):Promise.all(u.map(function(d,h){return r.get(t,h)})):(_=a.parse(this,e),this._handleSubAsset(_,t,e)):_=Promise.resolve(null)}return o.set(c,_),_},s.parse=function(){var t=this,e=this.get(0).then(function(r){return t.glTF=r,Promise.all([t.get(1),t.get(5),t.get(6),t.get(7),t.get(9),t.get(10),t.get(2)]).then(function(){var a=t.glTFResource;return(a.skins||a.animations)&&t._createAnimator(t,a.animations),t.resourceManager.addContentRestorer(t.contentRestorer),a})});return this._addTaskCompletePromise(e),e},s._addTaskCompletePromise=function(t){var e=this,r=this._progress.taskComplete;r.total+=1,t.then(function(){e._setTaskCompleteProgress(++r.loaded,r.total)})},s._createAnimator=function(t,e){var r=t.glTFResource.defaultSceneRoot,a=r.addComponent(nn),o=new Zo,l=new $o("layer"),c=new es;if(o.addLayer(l),a.animatorController=o,l.stateMachine=c,e)for(var _=0;_<e.length;_++){var u=e[_],d=u.name,h=c.makeUniqueStateName(d);h!==d&&console.warn("AnimatorState name is existed, name: "+d+" reset to "+h);var f=c.addState(h);f.clip=u}},s._handleSubAsset=function(t,e,r){var a=this,o=Th[e];if(!!o)if(e===8){var l,c;((l=this.glTFResource)[c=o]||(l[c]=[]))[r]=t}else{var _=this.glTFResource.url;t.then(function(u){var d,h;if(((d=a.glTFResource)[h=o]||(d[h]=[]))[r]=u,e===7)for(var f=0,v=u.length;f<v;f++){var p=u[f];a.resourceManager._onSubAssetSuccess(_+"?q="+o+"["+r+"]["+f+"]",p)}else{a.resourceManager._onSubAssetSuccess(_+"?q="+o+"["+r+"]",u);var g;e===2&&((g=a.glTF.scene)!=null?g:0)===r&&a.resourceManager._onSubAssetSuccess(""+_+"?q=defaultSceneRoot",u)}})}},n.addParser=function(t,e){this._parsers[t]=e},n}();(function(){as._parsers={}})();var co=function(s,i,t){this.data=s,this.interleaved=i,this.stride=t,this.vertexBindingInfos={}},xe;(function(n){n[n.Schema=0]="Schema",n[n.Validator=1]="Validator",n[n.Scene=2]="Scene",n[n.Buffer=3]="Buffer",n[n.BufferView=4]="BufferView",n[n.Texture=5]="Texture",n[n.Material=6]="Material",n[n.Mesh=7]="Mesh",n[n.Entity=8]="Entity",n[n.Skin=9]="Skin",n[n.Animation=10]="Animation"})(xe||(xe={}));var Ir,Eh=(Ir={},Ir[2]="scenes",Ir[3]="buffers",Ir[5]="textures",Ir[6]="materials",Ir[7]="meshes",Ir[8]="nodes",Ir[9]="skins",Ir[10]="animations",Ir[4]="bufferViews",Ir),ln,Th=(ln={},ln[2]="_sceneRoots",ln[5]="textures",ln[6]="materials",ln[7]="meshes",ln[8]="entities",ln[9]="skins",ln[10]="animations",ln);function Xr(n){return function(s){var i=new s;as.addParser(n,i)}}var et=function(){function n(){}return n.floatBufferToVector2Array=function(i){for(var t=i.length,e=new Array(t/2),r=0;r<t;r+=2)e[r/2]=new $(i[r],i[r+1]);return e},n.floatBufferToVector3Array=function(i){for(var t=i.length,e=new Array(t/3),r=0;r<t;r+=3)e[r/3]=new w(i[r],i[r+1],i[r+2]);return e},n.floatBufferToVector4Array=function(i){for(var t=i.length,e=new Array(t/4),r=0;r<t;r+=4)e[r/4]=new ae(i[r],i[r+1],i[r+2],i[r+3]);return e},n.floatBufferToColorArray=function(i,t){var e=i.length,r=new Array(e/(t?3:4));if(t)for(var a=0;a<e;a+=3)r[a/3]=new j(i[a],i[a+1],i[a+2],1);else for(var o=0;o<e;o+=4)r[o/4]=new j(i[o],i[o+1],i[o+2],i[o+3]);return r},n.getAccessorTypeSize=function(i){switch(i){case cn.SCALAR:return 1;case cn.VEC2:return 2;case cn.VEC3:return 3;case cn.VEC4:return 4;case cn.MAT2:return 4;case cn.MAT3:return 9;case cn.MAT4:return 16}},n.getComponentType=function(i){switch(i){case ut.BYTE:return Int8Array;case ut.UNSIGNED_BYTE:return Uint8Array;case ut.SHORT:return Int16Array;case ut.UNSIGNED_SHORT:return Uint16Array;case ut.UNSIGNED_INT:return Uint32Array;case ut.FLOAT:return Float32Array}},n.getNormalizedComponentScale=function(i){switch(i){case ut.BYTE:return 1/127;case ut.UNSIGNED_BYTE:return 1/255;case ut.SHORT:return 1/32767;case ut.UNSIGNED_SHORT:return 1/65535;default:throw new Error("Galacean.GLTFLoader: Unsupported normalized accessor component type.")}},n.getAccessorBuffer=function(i,t,e){var r=e.componentType,a=n.getComponentType(r),o=n.getAccessorTypeSize(e.type),l=a.BYTES_PER_ELEMENT,c=o*l,_=e.count,u;if(e.bufferView!==void 0){var d=e.bufferView,h=t[d];u=i.get(xe.BufferView,e.bufferView).then(function(g){var y=h.buffer,m,x=(m=g.byteOffset)!=null?m:0,S,b=(S=e.byteOffset)!=null?S:0,A=h.byteStride,C;if(A!==void 0&&A!==c){var E=Math.floor(b/A),T=d+":"+r+":"+E+":"+_,B=i.accessorBufferCache;if(C=B[T],!C){var M=x+E*A,P=_*(A/l),V=new a(g.buffer,M,P);B[T]=C=new co(V,!0,A),C.restoreInfo=new _o(new Da(y,a,M,P))}}else{var N=x+b,F=_*o,O=new a(g.buffer,N,F);C=new co(O,!1,c),C.restoreInfo=new _o(new Da(y,a,N,F))}return C})}else{var f=_*o,v=new a(f),p=new co(v,!1,c);p.restoreInfo=new _o(new Da(void 0,a,void 0,f)),u=Promise.resolve(p)}return e.sparse?u.then(function(g){return n.processingSparseData(i,e,g).then(function(){return g})}):u},n.bufferToVector3Array=function(i,t,e,r,a){for(var o=t/i.BYTES_PER_ELEMENT,l=i.length/e,c=new Array(e),_=r?n.getNormalizedComponentScale(a):1,u=0;u<e;u++){var d=o+u*l;c[u]=new w(i[d]*_,i[d+1]*_,i[d+2]*_)}return c},n.getBufferViewData=function(i,t){var e=i.byteOffset,r=e===void 0?0:e,a=t[i.buffer];return a.slice(r,r+i.byteLength)},n.processingSparseData=function(i,t,e){var r=e.restoreInfo,a=i.glTF.bufferViews,o=n.getAccessorTypeSize(t.type),l=n.getComponentType(t.componentType),c=e.data.slice(),_=t.sparse,u=_.count,d=_.indices,h=_.values,f=a[d.bufferView],v=a[h.bufferView];return Promise.all([i.get(xe.BufferView,d.bufferView),i.get(xe.BufferView,h.bufferView)]).then(function(p){var g=p[0],y=p[1],m,x,S=((m=d.byteOffset)!=null?m:0)+((x=g.byteOffset)!=null?x:0),b=g.byteLength,A,C,E=((A=h.byteOffset)!=null?A:0)+((C=y.byteOffset)!=null?C:0),T=y.byteLength;r.typeSize=o,r.sparseCount=u;var B=n.getComponentType(d.componentType),M=b/B.BYTES_PER_ELEMENT,P=new B(g.buffer,S,M);r.sparseIndices=new Da(f.buffer,B,S,M);var V=T/l.BYTES_PER_ELEMENT,N=new l(y.buffer,E,V);r.sparseValues=new Da(v.buffer,l,E,V);for(var F=0;F<u;F++)for(var O=P[F],D=0;D<o;D++)c[O*o+D]=N[F*o+D];e.data=c})},n.getIndexFormat=function(i){switch(i){case ut.UNSIGNED_BYTE:return Et.UInt8;case ut.UNSIGNED_SHORT:return Et.UInt16;case ut.UNSIGNED_INT:return Et.UInt32}},n.getElementFormat=function(i,t,e){if(e===void 0&&(e=!1),i==ut.FLOAT)switch(t){case 1:return ee.Float;case 2:return ee.Vector2;case 3:return ee.Vector3;case 4:return ee.Vector4}if(i==ut.SHORT)switch(t){case 2:return e?ee.NormalizedShort2:ee.Short2;case 3:case 4:return e?ee.NormalizedShort4:ee.Short4}if(i==ut.UNSIGNED_SHORT)switch(t){case 2:return e?ee.NormalizedUShort2:ee.UShort2;case 3:case 4:return e?ee.NormalizedUShort4:ee.UShort4}if(i==ut.BYTE)switch(t){case 2:case 3:case 4:return e?ee.NormalizedByte4:ee.Byte4}if(i==ut.UNSIGNED_BYTE)switch(t){case 2:case 3:case 4:return e?ee.NormalizedUByte4:ee.UByte4}},n.loadImageBuffer=function(i,t){return new Promise(function(e,r){var a=new window.Blob([i],{type:t}),o=new Image;o.onerror=function(){r(new Error("Failed to load image buffer"))},o.onload=function(){requestAnimationFrame(function(){e(o),o.onload=null,o.onerror=null,o.onabort=null})},o.crossOrigin="anonymous",o.src=URL.createObjectURL(a)})},n.parseGLB=function(i,t){var e=4,r=1179937895,a=12,o={JSON:1313821514,BIN:5130562},l=new DataView(t),c={magic:l.getUint32(0,!0),version:l.getUint32(e,!0),length:l.getUint32(2*e,!0)};if(c.magic!==r)return{originBuffer:t};var _=l.getUint32(a,!0),u=l.getUint32(a+e,!0);if(u!==o.JSON)return console.error("Invalid glb chunk type. Expected 0x4E4F534A, found 0x"+u.toString(16)),null;for(var d=new Uint8Array(t,a+2*e,_),h=JSON.parse(We.decodeText(d)),f=[],v=a+2*e+_,p=i.contentRestorer.glbBufferSlices;v<c.length;){if(_=l.getUint32(v,!0),u=l.getUint32(v+e,!0),u!==o.BIN)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+u.toString(16)),null;var g=v+2*e,y=t.slice(g,g+_);f.push(y),p.push(new $(g,_)),v+=_+2*e}return{glTF:h,buffers:f}},n.parseSampler=function(i,t){var e=t.filterMode,r=t.wrapModeU,a=t.wrapModeV;e!==void 0&&(i.filterMode=e),r!==void 0&&(i.wrapModeU=r),a!==void 0&&(i.wrapModeV=a)},n.getSamplerInfo=function(i){var t=i.minFilter,e=i.magFilter,r=i.wrapS,a=i.wrapT,o={};return(t||e)&&(o.mipmap=t>=ji.NEAREST_MIPMAP_NEAREST,e===Mo.NEAREST?o.filterMode=ot.Point:t<=ji.LINEAR_MIPMAP_NEAREST?o.filterMode=ot.Bilinear:o.filterMode=ot.Trilinear),r&&(o.wrapModeU=qi._wrapMap[r]),a&&(o.wrapModeV=qi._wrapMap[a]),o},n}(),Zs;(function(n){n[n.linear=1]="linear",n[n.sRGB=2]="sRGB"})(Zs||(Zs={}));var $s;(function(n){n[n.ETC1S=163]="ETC1S",n[n.UASTC=166]="UASTC"})($s||($s={}));var Po;(function(n){n[n.None=0]="None",n[n.BasisLZ=1]="BasisLZ",n[n.Zstd=2]="Zstd",n[n.ZLib=3]="ZLib"})(Po||(Po={}));var Rh=function(){function n(i){this.vkFormat=0,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=0,this.levels=[],this.keyValue={},this.globalData=null,this.parse(i)}var s=n.prototype;return s.parse=function(t){var e=t.buffer,r=t.byteOffset,a=new la(t,12);this.vkFormat=a.nextUint32(),this.typeSize=a.nextUint32(),this.pixelWidth=a.nextUint32(),this.pixelHeight=a.nextUint32(),this.pixelDepth=a.nextUint32(),this.layerCount=a.nextUint32(),this.faceCount=a.nextUint32();var o=Math.max(1,a.nextUint32());this.supercompressionScheme=a.nextUint32();var l=a.nextUint32(),c=a.nextUint32(),_=a.nextUint32(),u=a.nextUint32(),d=a.nextUint64(),h=a.nextUint64(),f=new Array(o),v=o*3*8,p=new la(t,a.offset,v);this.levels=f;for(var g=0;g<o;g++)f[g]={levelData:new Uint8Array(e,r+p.nextUint64(),p.nextUint64()),uncompressedByteLength:p.nextUint64()};var y=new la(t,l,c),m={vendorId:y.skip(4).nextUint16(),descriptorType:y.nextUint16(),versionNumber:y.nextUint16(),descriptorBlockSize:y.nextUint16(),colorModel:y.nextUint8(),colorPrimaries:y.nextUint8(),transferFunction:y.nextUint8(),flags:y.nextUint8(),texelBlockDimension:[y.nextUint8(),y.nextUint8(),y.nextUint8(),y.nextUint8()],bytesPlane:[y.nextUint8(),y.nextUint8(),y.nextUint8(),y.nextUint8(),y.nextUint8(),y.nextUint8(),y.nextUint8(),y.nextUint8()],samples:[]};this.dataFormatDescriptor=m;for(var x=6,S=4,b=(m.descriptorBlockSize/4-x)/S,A=0;A<b;A++){var C={bitOffset:y.nextUint16(),bitLength:y.nextUint8(),channelType:y.nextUint8(),samplePosition:[y.nextUint8(),y.nextUint8(),y.nextUint8(),y.nextUint8()],sampleLower:-1/0,sampleUpper:1/0};C.channelType&64?(C.sampleLower=y.nextInt32(),C.sampleUpper=y.nextInt32()):(C.sampleLower=y.nextUint32(),C.sampleUpper=y.nextUint32()),m.samples[A]=C}for(var E=new la(t,_,u,!0);E.position<u;){var T=E.nextUint32(),B=E.scan(T),M=We.decodeText(B),P=E.nextUint8Array(T-B.byteLength-1);this.keyValue[M]=M.match(/^ktx/i)?We.decodeText(P).replace(/^(.*)\x00$/,"$1"):P;var V=T%4?4-T%4:0;E.skip(V)}if(h<=0)return this;for(var N=new la(t,d,h,!0),F=N.nextUint16(),O=N.nextUint16(),D=N.nextUint32(),z=N.nextUint32(),U=N.nextUint32(),Y=N.nextUint32(),K=new Array(o),H=0;H<o;H++)K[H]={imageFlags:N.nextUint32(),rgbSliceByteOffset:N.nextUint32(),rgbSliceByteLength:N.nextUint32(),alphaSliceByteOffset:N.nextUint32(),alphaSliceByteLength:N.nextUint32()};var te=d+N.position,we=te+D,pe=we+z,oe=pe+U,Ee=new Uint8Array(e,r+te,D),Ke=new Uint8Array(e,r+we,z),vt=new Uint8Array(e,r+pe,U),Se=new Uint8Array(e,r+oe,Y);this.globalData={endpointCount:F,selectorCount:O,imageDescs:K,endpointsData:Ee,selectorsData:Ke,tablesData:vt,extendedData:Se}},no(n,[{key:"isSRGB",get:function(){return this.dataFormatDescriptor.transferFunction===2}},{key:"isUASTC",get:function(){return this.dataFormatDescriptor.colorModel===166}}]),n}(),Ve;(function(n){n[n.ASTC=0]="ASTC",n[n.BC7=1]="BC7",n[n.BC1_BC3=2]="BC1_BC3",n[n.PVRTC=3]="PVRTC",n[n.ETC=4]="ETC",n[n.R8=5]="R8",n[n.R8G8=6]="R8G8",n[n.R8G8B8A8=7]="R8G8B8A8"})(Ve||(Ve={}));var Mh=function(){function n(i,t){i===void 0&&(i=4),this.limitedCount=i,this._workerCreator=t,this._taskQueue=[],this._workerStatus=0,this._workerItems=new Array(i)}var s=n.prototype;return s.prepareWorker=function(){for(var t=this.limitedCount,e=new Array(t),r=0;r<t;r++)e.push(this._initWorker(r));return Promise.all(e)},s.postMessage=function(t){var e=this;return new Promise(function(r,a){var o=e._getIdleWorkerId();if(o!==-1){e._workerStatus|=1<<o;var l=e._workerItems,c;Promise.resolve((c=l[o])!=null?c:e._initWorker(o)).then(function(){var _=l[o];_.resolve=r,_.reject=a,_.worker.postMessage(t)}).catch(a)}else e._taskQueue.push({resolve:r,reject:a,message:t})})},s.destroy=function(){for(var t=this._workerItems,e=0,r=t.length;e<r;e++){var a=t[e];a.worker.terminate(),a.reject=null,a.resolve=null}t.length=0,this._taskQueue.length=0,this._workerStatus=0},s._initWorker=function(t){var e=this;return Promise.resolve(this._workerCreator()).then(function(r){return r.addEventListener("message",e._onMessage.bind(e,t)),e._workerItems[t]={worker:r,resolve:null,reject:null},r})},s._getIdleWorkerId=function(){for(var t=0,e=this.limitedCount;t<e;t++)if(!(this._workerStatus&1<<t))return t;return-1},s._onMessage=function(t,e){var r=e.data.error;r?this._workerItems[t].reject(r):this._workerItems[t].resolve(e.data),this._nextTask(t)},s._nextTask=function(t){if(this._taskQueue.length){var e=this._taskQueue.shift(),r=this._workerItems[t];r.resolve=e.resolve,r.reject=e.reject,r.worker.postMessage(e.message)}else this._workerStatus^=1<<t},n}(),Fc=function(){function n(i){this.workerLimitCount=i}var s=n.prototype;return s.init=function(){return this._initPromise||(this._initPromise=this._initTranscodeWorkerPool()),this._initPromise},s.destroy=function(){this._transcodeWorkerPool.destroy()},s._createTranscodePool=function(t,e){return this._transcodeWorkerPool=new Mh(this.workerLimitCount,function(){return new Promise(function(r,a){var o=function(u){u.data.error?a(u.data.error):r(l)},l=new Worker(t),c={type:"init",transcoderWasm:e};l.addEventListener("message",o),l.postMessage(c)})}),this._transcodeWorkerPool.prepareWorker()},n}();function Ph(){var n,s=function(t){return n||(n=new Promise(function(e,r){var a={wasmBinary:t,onRuntimeInitialized:function(){return e(a)},onAbort:r};self.BASIS(a)}).then(function(e){return e.initializeBasis(),e.KTX2File})),n};self.onmessage=function(t){var e=t.data;switch(e.type){case"init":s(e.transcoderWasm).then(function(){self.postMessage("init-completed")}).catch(function(r){return self.postMessage({error:r})});break;case"transcode":s().then(function(r){var a=Bo(e.buffer,e.format,r);a.type="transcoded",self.postMessage(a)}).catch(function(r){return self.postMessage({error:r})});break}}}var Bh=function(){var s;return function(t){return s||(s=new Promise(function(e,r){var a={wasmBinary:t,onRuntimeInitialized:function(){return e(a)},onAbort:r};self.BASIS(a)}).then(function(e){return e.initializeBasis(),e.KTX2File})),s}},el=Bh();function Bo(n,s,i){var t=function(P,V){switch(P){case 2:return V?3:2;case 4:return V?1:0;case 3:return V?9:8;case 7:return 13;case 0:return 10;case 1:return 7}},e=function(P){if(P.length===1)return P[0];for(var V=0,N=0;N<P.length;N++)V+=P[N].byteLength;for(var F=new Uint8Array(V),O=0,D=0;D<P.length;D++)F.set(P[D],O),O+=P[D].byteLength;return F},r=function(){l.close(),l.delete()},a;(function(M){M[M.ETC1=0]="ETC1",M[M.ETC2=1]="ETC2",M[M.BC1=2]="BC1",M[M.BC3=3]="BC3",M[M.BC4=4]="BC4",M[M.BC5=5]="BC5",M[M.BC7=7]="BC7",M[M.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",M[M.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",M[M.ASTC_4x4=10]="ASTC_4x4",M[M.RGBA8=13]="RGBA8"})(a||(a={}));var o;(function(M){M[M.ASTC=0]="ASTC",M[M.BC7=1]="BC7",M[M.BC1_BC3=2]="BC1_BC3",M[M.PVRTC=3]="PVRTC",M[M.ETC=4]="ETC",M[M.R8=5]="R8",M[M.RG8=6]="RG8",M[M.RGBA8=7]="RGBA8"})(o||(o={}));var l=new i(new Uint8Array(n));if(!l.isValid())throw r(),new Error("Invalid or unsupported .ktx2 file");if(!l.startTranscoding())throw r(),new Error("KTX2 startTranscoding failed");for(var c=l.getWidth(),_=l.getHeight(),u=l.getLayers()||1,d=l.getLevels(),h=l.getHasAlpha(),f=l.getFaces(),v=t(s,h),p=new Array(f),g=v===2||v===3||v===7,y=0;y<f;y++){for(var m=new Array(d),x=0;x<d;x++){for(var S=new Array(u),b=void 0,A=void 0,C=0;C<u;C++){var E=l.getImageLevelInfo(x,C,y);g&&x===0&&(c!==E.width||_!==E.height)?(c=b=E.width,_=A=E.height,console.warn("KTX2 transcode to BC will resize to width: "+c+", height: "+_+". You'd better use an image whose size if multiple of 4.")):(b=E.origWidth,A=E.origHeight);var T=new Uint8Array(l.getImageTranscodedSizeInBytes(x,C,0,v)),B=l.transcodeImage(T,x,C,y,v,0,-1,-1);if(!B)throw r(),new Error("transcodeImage failed.");S[C]=T}m[x]={data:e(S),width:b,height:A}}p[y]=m}return r(),{faces:p,width:c,height:_,hasAlpha:h,faceCount:f,format:v}}var Dh=function(n){se(s,n);function s(t){return n.call(this,t)}var i=s.prototype;return i._initTranscodeWorkerPool=function(){var e=this;return Promise.all([fetch("https://mdn.alipayobjects.com/rms/afts/file/A*nG8SR6vCgXgAAAAAAAAAAAAAARQnAQ/basis_transcoder.js").then(function(r){return r.text()}),fetch("https://mdn.alipayobjects.com/rms/afts/file/A*qEUfQ7317KsAAAAAAAAAAAAAARQnAQ/basis_transcoder.wasm").then(function(r){return r.arrayBuffer()})]).then(function(r){var a=r[0],o=r[1];if(e.workerLimitCount===0)return new Promise(function(d,h){var f=document.createElement("script");f.src=URL.createObjectURL(new Blob([a],{type:"application/javascript"})),document.body.appendChild(f),f.onload=function(){el(o).then(function(){d(null)})},f.onerror=function(){h()}});var l=Ph.toString(),c=l.substring(l.indexOf("{"),l.lastIndexOf("}")+1),_=`
        `+a+`
        `+Bo.toString()+`
        `+c+`
        `,u=URL.createObjectURL(new Blob([_],{type:"application/javascript"}));return e._createTranscodePool(u,o)})},i.transcode=function(e,r){return this.workerLimitCount===0?el().then(function(a){return Bo(e,r,a)}):this._transcodeWorkerPool.postMessage({buffer:e,format:r,type:"transcode"})},s}(Fc);function Lh(){var n=function(o,l,c,_){var u=(c+3>>2)*(_+3>>2),d=u*16+65535>>16,h=o.memory,f=d+1-(h.buffer.byteLength>>16);f>0&&h.grow(f);var v=new Uint8Array(h.buffer,65536,u*16);return v.set(l),o.transcode(u)===0?v:null},s=function(o){return t=WebAssembly.instantiate(o,{env:{memory:new WebAssembly.Memory({initial:16})}}).then(function(l){return l.instance.exports}),t},i=function(o,l,c){var _=o.length,u=new Array(_),d=Promise.resolve();return l&&(r.init(),d=r._initPromise),d.then(function(){for(var h=0;h<_;h++){for(var f=o[h].length,v=new Array(f),p=0;p<f;p++){var g=o[h][p],y=g.buffer,m=g.levelHeight,x=g.levelWidth,S=g.uncompressedByteLength;l&&(y=r.decode(y.slice(),S));var b=y.byteLength/_,A=y.byteOffset,C=n(c,new Uint8Array(y.buffer,A+h*b,b),x,m);if(C)v[p]={data:C.slice(),width:x,height:m};else throw"buffer decoded error"}u[h]=v}return u})},t,e=function(){function a(){}var o=a.prototype;return o.init=function(){return this._initPromise||(this._initPromise=fetch(a.WasmModuleURL).then(function(c){if(c.ok)return c.arrayBuffer();throw new Error("Could not fetch the wasm component for the Zstandard decompression lib: "+c.status+" - "+c.statusText)}).then(function(c){return WebAssembly.instantiate(c,a.IMPORT_OBJECT)}).then(this._init)),this._initPromise},o._init=function(c){a.instance=c.instance,a.IMPORT_OBJECT.env.emscripten_notify_memory_growth()},o.decode=function(c,_){if(_===void 0&&(_=0),!a.instance)throw new Error("ZSTDDecoder: Await .init() before decoding.");var u=a.instance.exports,d=c.byteLength,h=u.malloc(d);a.heap.set(c,h),_=_||Number(u.ZSTD_findDecompressedSize(h,d));var f=u.malloc(_),v=u.ZSTD_decompress(f,_,h,d),p=a.heap.slice(f,f+v);return u.free(h),u.free(f),p},a}();(function(){e.IMPORT_OBJECT={env:{emscripten_notify_memory_growth:function(){e.heap=new Uint8Array(e.instance.exports.memory.buffer)}}}})(),function(){e.WasmModuleURL="https://mdn.alipayobjects.com/rms/afts/file/A*awNJR7KqIAEAAAAAAAAAAAAAARQnAQ/zstddec.wasm"}();var r=new e;self.onmessage=function(o){var l=o.data;switch(l.type){case"init":s(l.transcoderWasm).then(function(){self.postMessage("init-completed")}).catch(function(c){self.postMessage({error:c})});break;case"transcode":t.then(function(c){i(l.data,l.needZstd,c).then(function(_){self.postMessage(_)}).catch(function(_){return self.postMessage({error:_})})});break}}}var Do=function(n){se(s,n);function s(t,e){var r;return r=n.call(this,t)||this,r.type=e,r}var i=s.prototype;return i._initTranscodeWorkerPool=function(){var e=this;return fetch(s.transcoderMap[this.type]).then(function(r){return r.arrayBuffer()}).then(function(r){var a=Lh.toString(),o=URL.createObjectURL(new Blob([a.substring(a.indexOf("{")+1,a.lastIndexOf("}"))],{type:"application/javascript"}));return e._createTranscodePool(o,r)})},i.transcode=function(e){for(var r=e.supercompressionScheme===Po.Zstd,a=e.levels.length,o=e.faceCount,l={width:e.pixelWidth,height:e.pixelHeight,mipmaps:null},c={type:"transcode",format:0,needZstd:r,data:new Array(o)},_=c.data,u=0;u<o;u++){for(var d=new Array(a),h=0;h<a;h++){var f=e.levels[h],v=Math.floor(e.pixelWidth/(1<<h))||1,p=Math.floor(e.pixelHeight/(1<<h))||1,g=f.levelData.buffer,y=f.levelData.byteOffset,m=f.levelData.byteLength;d[h]={buffer:new Uint8Array(g,y,m),levelWidth:v,levelHeight:p,uncompressedByteLength:f.uncompressedByteLength}}_[u]=d}return this._transcodeWorkerPool.postMessage(c).then(function(x){return l.faces=x,l.hasAlpha=!0,l})},s}(Fc);(function(){var n;Do.transcoderMap=(n={},n[Ve.ASTC]="https://mdn.alipayobjects.com/rms/afts/file/A*0jiKRK6D1-kAAAAAAAAAAAAAARQnAQ/uastc_astc.wasm",n)})();var Ba,St=(Ba=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.initialize=function(e,r){if(r.ktx2Loader){var a=r.ktx2Loader;return a.priorityFormats&&(St._priorityFormats.etc1s=a.priorityFormats,St._priorityFormats.uastc=a.priorityFormats),a.transcoder===1?St._getKhronosTranscoder(a.workerCount).init():St._getBinomialLLCTranscoder(a.workerCount).init()}},i.load=function(e,r){var a=this;return new Be(function(o,l,c,_){a.request(e.url,{type:"arraybuffer"}).onProgress(c,_).then(function(u){return St._parseBuffer(new Uint8Array(u),r.engine,e.params).then(function(d){var h=d.engine,f=d.result,v=d.targetFormat,p=d.params;return St._createTextureByBuffer(h,f,v,p)})}).then(o).catch(l)})},s.release=function(){this._binomialLLCTranscoder&&this._binomialLLCTranscoder.destroy(),this._khronosTranscoder&&this._khronosTranscoder.destroy(),this._binomialLLCTranscoder=null,this._khronosTranscoder=null,this._isBinomialInit=!1},s._parseBuffer=function(e,r,a){var o,l=new Rh(e),c,_=(c=(o=a)==null?void 0:o.priorityFormats)!=null?c:St._priorityFormats[l.isUASTC?"uastc":"etc1s"],u=St._decideTargetFormat(r,l,_),d;if(St._isBinomialInit||!Do.transcoderMap[u]||!l.isUASTC){var h=St._getBinomialLLCTranscoder();d=h.init().then(function(){return h.transcode(e,u)})}else{var f=St._getKhronosTranscoder();d=f.init().then(function(){return f.transcode(l)})}return d.then(function(v){return{engine:r,result:v,targetFormat:u,params:l.keyValue.GalaceanTextureParams}})},s._createTextureByBuffer=function(e,r,a,o){var l=r.width,c=r.height,_=r.faces,u=_.length,d=_[0],h=d.length>1,f=this._getEngineTextureFormat(a,r),v;if(u!==6){v=new bt(e,l,c,f,h);for(var p=0;p<d.length;p++){var g=d[p].data;v.setPixelBuffer(g,p)}}else{v=new tr(e,c,f,h);for(var y=0;y<_.length;y++)for(var m=_[y],x=0;x<d.length;x++)v.setPixelBuffer(Dr.PositiveX+y,m[x].data,x)}return o&&(v.wrapModeU=o[0],v.wrapModeV=o[1],v.filterMode=o[2],v.anisoLevel=o[3]),v},s._decideTargetFormat=function(e,r,a){var o=e._hardwareRenderer,l=this._detectSupportedFormat(o,a);return l===Ve.PVRTC&&(!k.isPowerOf2(r.pixelWidth)||!k.isPowerOf2(r.pixelHeight)||r.pixelWidth!==r.pixelHeight)?(ve.warn("PVRTC image need power of 2 and width===height, downgrade to RGBA8"),Ve.R8G8B8A8):l===null?(ve.warn("Can't support any compressed texture, downgrade to RGBA8"),Ve.R8G8B8A8):l},s._detectSupportedFormat=function(e,r){for(var a=0;a<r.length;a++){var o=r[a],l=this._supportedMap[o];if(l){for(var c=0;c<l.length;c++)if(e.canIUse(l[c]))return o}else switch(r[a]){case Ve.R8G8B8A8:return o;case Ve.R8:case Ve.R8G8:if(e.isWebGL2)return o}}return null},s._getBinomialLLCTranscoder=function(e){e===void 0&&(e=4),St._isBinomialInit=!0;var r;return(r=this._binomialLLCTranscoder)!=null?r:this._binomialLLCTranscoder=new Dh(e)},s._getKhronosTranscoder=function(e){e===void 0&&(e=4);var r;return(r=this._khronosTranscoder)!=null?r:this._khronosTranscoder=new Do(e,Ve.ASTC)},s._getEngineTextureFormat=function(e,r){var a=r.hasAlpha;switch(e){case Ve.ASTC:return G.ASTC_4x4;case Ve.ETC:return a?G.ETC2_RGBA8:G.ETC2_RGB;case Ve.BC7:return G.BC7;case Ve.BC1_BC3:return a?G.BC3:G.BC1;case Ve.PVRTC:return a?G.PVRTC_RGBA4:G.PVRTC_RGB4;case Ve.R8G8B8A8:return G.R8G8B8A8}},s}(De),function(){Ba._isBinomialInit=!1}(),function(){Ba._priorityFormats={etc1s:[Ve.ETC,Ve.BC7,Ve.ASTC,Ve.BC1_BC3,Ve.PVRTC],uastc:[Ve.ASTC,Ve.BC7,Ve.ETC,Ve.BC1_BC3,Ve.PVRTC]}}(),function(){var n;Ba._supportedMap=(n={},n[Ve.ASTC]=[Q.astc],n[Ve.ETC]=[Q.etc],n[Ve.BC7]=[Q.bptc],n[Ve.BC1_BC3]=[Q.s3tc],n[Ve.PVRTC]=[Q.pvrtc,Q.pvrtc_webkit],n)}(),Ba);St=de([Qe(Fe.KTX2,["ktx2"])],St);var tl;(function(n){n[n.BinomialLLC=0]="BinomialLLC",n[n.Khronos=1]="Khronos"})(tl||(tl={}));var Vh=function(n){se(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t.bufferRequests=[],t.glbBufferSlices=[],t.bufferTextures=[],t.meshes=[],t}var i=s.prototype;return i.restoreContent=function(){var e=this;return new Be(function(r,a){Promise.all(e.bufferRequests.map(function(o){return aa(o.url,o.config)})).then(function(o){if(e.isGLB){var l=e.glbBufferSlices,c=o[0],_=l.length;o.length=_;for(var u=0;u<_;u++){var d=l[u];o[u]=c.slice(d.x,d.x+d.y)}}Be.all(e.bufferTextures.map(function(h){var f=h.bufferView,v=o[f.buffer],p,g=new Uint8Array(v,(p=f.byteOffset)!=null?p:0,f.byteLength),y=h.texture;return h.mimeType==="image/ktx2"?St._parseBuffer(g,y.engine).then(function(m){for(var x=m.result,S=x.faces,b=S[0],A=0;A<b.length;A++)y.setPixelBuffer(b[A].data,A)}):et.loadImageBuffer(g,h.mimeType).then(function(m){y.setImageSource(m),y.generateMipmaps()})})).then(function(){for(var h=ua(e.meshes),f;!(f=h()).done;){for(var v=f.value,p=v.mesh,g=ua(v.vertexBuffers),y;!(y=g()).done;){var m=y.value,x=e._getBufferData(o,m.data);m.buffer.setData(x)}if(v.indexBuffer){var S=e._getBufferData(o,v.indexBuffer);p.setIndices(S)}for(var b=ua(v.blendShapes),A;!(A=b()).done;){var C=A.value,E=C.blendShape.frames[0],T=C.position,B=e._getBufferData(o,T.buffer);if(E.deltaPositions=et.bufferToVector3Array(B,T.byteOffset,T.count,T.normalized,T.componentType),C.normal){var M=C.normal,P=e._getBufferData(o,M.buffer);E.deltaNormals=et.bufferToVector3Array(P,M.byteOffset,M.count,M.normalized,M.componentType)}if(C.tangent){var V=C.tangent,N=e._getBufferData(o,V.buffer);E.deltaTangents=et.bufferToVector3Array(N,V.byteOffset,V.count,V.normalized,V.componentType)}}p.uploadData(!0)}r(e.resource)}).catch(a)}).catch(a)})},i._getBufferData=function(e,r){var a=r.main,o;if(a){var l=e[a.bufferIndex];o=new a.TypedArray(l,a.byteOffset,a.length)}else o=new a.TypedArray(a.length);var c=r.sparseCount;if(c)for(var _=r.sparseIndices,u=e[_.bufferIndex],d=new _.TypedArray(u,_.byteOffset,_.length),h=r.sparseValues,f=e[h.bufferIndex],v=new h.TypedArray(f,h.byteOffset,h.length),p=r.typeSize,g=0;g<c;g++)for(var y=d[g],m=0;m<p;m++)o[y*p+m]=v[g*p+m];return o},s}(Rr),Oc=function(s,i){this.url=s,this.config=i},zc=function(s,i,t){this.texture=s,this.bufferView=i,this.mimeType=t},Nh=function(){this.vertexBuffers=[],this.blendShapes=[]},rl=function(s,i){this.buffer=s,this.data=i},_o=function(s,i,t,e,r){this.main=s,this.typeSize=i,this.sparseCount=t,this.sparseIndices=e,this.sparseValues=r},Da=function(s,i,t,e){this.bufferIndex=s,this.TypedArray=i,this.byteOffset=t,this.length=e},Ih=function(s,i,t,e){this.blendShape=s,this.position=i,this.normal=t,this.tangent=e},Fh=function(s,i,t,e,r){this.buffer=s,this.byteOffset=i,this.count=t,this.normalized=e,this.componentType=r},mr=function(){function n(){}var s=n.prototype;return s.createAndParse=function(t,e,r){for(var a=arguments.length,o=new Array(a>3?a-3:0),l=3;l<a;l++)o[l-3]=arguments[l];throw"Not implemented."},s.additiveParse=function(t,e,r,a){for(var o=arguments.length,l=new Array(o>4?o-4:0),c=4;c<o;c++)l[c-4]=arguments[c];throw"Not implemented."},n}(),Mt;(function(n){n[n.CreateAndParse=0]="CreateAndParse",n[n.AdditiveParse=1]="AdditiveParse"})(Mt||(Mt={}));var Oe=function(){function n(){}return n.executeExtensionsCreateAndParse=function(i,t,e){i===void 0&&(i={});for(var r=arguments.length,a=new Array(r>3?r-3:0),o=3;o<r;o++)a[o-3]=arguments[o];for(var l=null,c=Object.keys(i),_=c.length-1;_>=0;--_){var u,d=c[_],h=i[d];if(l=(u=n)._createAndParse.apply(u,[].concat(d,t,h,e,a)),l)return l}},n.executeExtensionsAdditiveAndParse=function(i,t,e,r){for(var a=arguments.length,o=new Array(a>4?a-4:0),l=4;l<a;l++)o[l-4]=arguments[l];for(var c in i){var _,u=i[c];(_=n)._additiveParse.apply(_,[].concat(c,t,e,u,r,o))}},n.hasExtensionParser=function(i){var t;return!!((t=n._extensionParsers[i])!=null&&t.length)},n.getExtensionParser=function(i,t){var e,r=n._extensionParsers[i],a=(e=r)==null?void 0:e.length;if(a)for(var o=a-1;o>=0;--o){var l=r[o];if(l._mode===t)return l}},n._addExtensionParser=function(i,t){n._extensionParsers[i]||(n._extensionParsers[i]=[]),n._extensionParsers[i].push(t)},n._createAndParse=function(i,t,e,r){for(var a=arguments.length,o=new Array(a>4?a-4:0),l=4;l<a;l++)o[l-4]=arguments[l];var c=n.getExtensionParser(i,Mt.CreateAndParse);if(c){var _;return(_=c).createAndParse.apply(_,[].concat(t,e,r,o))}},n._additiveParse=function(i,t,e,r,a){for(var o=arguments.length,l=new Array(o>5?o-5:0),c=5;c<o;c++)l[c-5]=arguments[c];var _=n.getExtensionParser(i,Mt.AdditiveParse);if(_){var u;(u=_).additiveParse.apply(u,[].concat(t,e,r,a,l))}},n}();(function(){Oe._extensionParsers={}})();function yr(n,s){return function(i){var t=new i;t._mode=s,Oe._addExtensionParser(n,t)}}var nl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e){var r=e.glTFResource,a=e.contentRestorer,o=r.url,l=a.bufferRequests,c={type:"arraybuffer"};return aa(o,c).onProgress(void 0,e._onTaskDetail).then(function(_){return l.push(new Oc(o,c)),et.parseGLB(e,_)}).then(function(_){var u;return(u=_)!=null&&u.glTF?(a.isGLB=!0,e.buffers=_.buffers,_.glTF):(a.isGLB=!1,JSON.parse(We.decodeText(new Uint8Array(_.originBuffer))))})},s}(Oe);nl=de([Xr(xe.Schema)],nl);var Lo=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){var a=e.glTF.animations[r],o=a.name,l=o===void 0?"AnimationClip"+r:o,c=Oe.executeExtensionsCreateAndParse(a.extensions,e,a)||Lo._parseStandardProperty(e,new Ko(l),a);return Promise.resolve(c).then(function(_){return Oe.executeExtensionsAdditiveAndParse(a.extensions,e,_,a),_})},s._parseStandardProperty=function(e,r,a){for(var o=function(x,S){var b=h[x],A=_[b.input],C=_[b.output],E=Promise.all([et.getAccessorBuffer(e,u,A),et.getAccessorBuffer(e,u,C)]).then(function(T){var B=T[0].data,M=T[1].data;if(C.normalized){for(var P=et.getNormalizedComponentScale(C.componentType),V=new Float32Array(M.length),N=0,F=M.length;N<F;N++)V[N]=M[N]*P;M=V}var O=M.length/B.length,D,z=(D=b.interpolation)!=null?D:ca.Linear,U;switch(z){case ca.CubicSpine:U=At.CubicSpine;break;case ca.Step:U=At.Step;break;case ca.Linear:U=At.Linear;break}B[B.length-1],v[x]={type:C.type,interpolation:U,input:B,output:M,outputSize:O}});g.push(E)},l=this,c=e.glTF,_=c.accessors,u=c.bufferViews,d=a.channels,h=a.samplers,f=h.length,v=new Array(f),p=e.get(xe.Entity),g=new Array,y=0,m=f;y<m;y++)o(y);return g.push(e.get(xe.Scene)),Promise.all(g).then(function(){for(var x=0,S=d.length;x<S;x++){for(var b=d[x],A=b.target,C=p[A.node],E="",T=C;T.parent;)E=E===""?""+T.name:T.name+"/"+E,T=T.parent;if(e.glTFResource.sceneRoots.indexOf(T)!==-1){var B=void 0,M=void 0;switch(A.path){case Fr.TRANSLATION:B=me,M="position";break;case Fr.ROTATION:B=me,M="rotationQuaternion";break;case Fr.SCALE:B=me,M="scale";break;case Fr.WEIGHTS:B=Pt,M="blendShapeWeights";break}var P=l._addCurve(A.path,b,v);if(A.path===Fr.WEIGHTS)for(var V=c.nodes[A.node].mesh,N=0,F=c.meshes[V].primitives.length;N<F;N++)r.addCurveBinding(E,B,N,M,P);else r.addCurveBinding(E,B,M,P)}}return r})},s._addCurve=function(e,r,a){var o=a[r.sampler],l=o.input,c=o.output,_=o.outputSize;switch(e){case Fr.TRANSLATION:case Fr.SCALE:{for(var u=new ja,d=u.interpolation=o.interpolation,h=0,f=0,v=l.length;f<v;f++){var p=new Gt;p.time=l[f],d===At.CubicSpine?(p.inTangent=new w(c[h++],c[h++],c[h++]),p.value=new w(c[h++],c[h++],c[h++]),p.outTangent=new w(c[h++],c[h++],c[h++])):p.value=new w(c[h++],c[h++],c[h++]),u.addKey(p)}return u}case Fr.ROTATION:{for(var g=new xa,y=g.interpolation=o.interpolation,m=0,x=0,S=l.length;x<S;x++){var b=new Gt;b.time=l[x],y===At.CubicSpine?(b.inTangent=new ae(c[m++],c[m++],c[m++],c[m++]),b.value=new ye(c[m++],c[m++],c[m++],c[m++]),b.outTangent=new ae(c[m++],c[m++],c[m++],c[m++])):b.value=new ye(c[m++],c[m++],c[m++],c[m++]),g.addKey(b)}return g}case Fr.WEIGHTS:{var A=new Xa;A.interpolation=o.interpolation;for(var C=0,E=0,T=l.length;E<T;E++){var B=new Gt;B.time=l[E],A.interpolation===At.CubicSpine?(B.inTangent=Array.from(c.subarray(C,C+_)),C+=_,B.value=c.slice(C,C+_),C+=_,B.outTangent=Array.from(c.subarray(C,C+_)),C+=_):(B.value=c.slice(C,C+_),C+=_),A.addKey(B)}return A}}},s}(Oe);Lo=de([Xr(xe.Animation)],Lo);var al=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){var a=e.glTF.buffers;return e.buffers?Promise.resolve(e.buffers[r]):this._parseSingleBuffer(e,a[r])},i._parseSingleBuffer=function(e,r){var a=e.glTFResource,o=e.contentRestorer,l=a.url,c=o.bufferRequests,_={type:"arraybuffer"},u=We.resolveAbsoluteUrl(l,r.uri);c.push(new Oc(u,_));var d=aa(u,_).onProgress(void 0,e._onTaskDetail);return e._addTaskCompletePromise(d),d},s}(Oe);al=de([Xr(xe.Buffer)],al);var il=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){var a=e.glTFResource,o=e.glTF.nodes[r],l=a.engine,c=o.matrix,_=o.translation,u=o.rotation,d=o.scale,h=o.extensions,f=new Qr(l,o.name||"_GLTF_ENTITY_"+r);f._markAsTemplate(a);var v=f.transform;if(c){var p=v.localMatrix;p.copyFromArray(c),v.localMatrix=p}else _&&v.setPosition(_[0],_[1],_[2]),u&&v.setRotationQuaternion(u[0],u[1],u[2],u[3]),d&&v.setScale(d[0],d[1],d[2]);var g=o.children;if(g)for(var y=0;y<g.length;y++){var m=g[y],x=e.get(xe.Entity,m);f.addChild(x)}return Oe.executeExtensionsAdditiveAndParse(h,e,f,o),f},s}(Oe);il=de([Xr(xe.Entity)],il);var wt=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){var a=e.glTF.materials[r],o=e.glTFResource,l=o.engine,c=Oe.executeExtensionsCreateAndParse(a.extensions,e,a);return c||(c=new Jr(l),c.name=a.name,wt._parseStandardProperty(e,c,a)),Promise.resolve(c).then(function(_){return _||(_=wt._getDefaultMaterial(l)),Oe.executeExtensionsAdditiveAndParse(a.extensions,e,_,a),_._associationSuperResource(o),_})},s._getDefaultMaterial=function(e){var r;return(r=wt)._defaultMaterial||(r._defaultMaterial=new Ka(e))},s._checkOtherTextureTransform=function(e,r){var a;(a=e.extensions)!=null&&a.KHR_texture_transform&&ve.warn(""+r+" texture always use the KHR_texture_transform of the base texture.")},s._parseStandardProperty=function(e,r,a){var o=a.pbrMetallicRoughness,l=a.normalTexture,c=a.occlusionTexture,_=a.emissiveTexture,u=a.emissiveFactor,d=a.alphaMode,h=a.alphaCutoff,f=a.doubleSided;if(o){var v=o.baseColorFactor,p=o.baseColorTexture,g=o.metallicFactor,y=o.roughnessFactor,m=o.metallicRoughnessTexture;v&&(r.baseColor=new j(j.linearToGammaSpace(v[0]),j.linearToGammaSpace(v[1]),j.linearToGammaSpace(v[2]),v[3])),p&&e.get(xe.Texture,p.index).then(function(E){r.baseTexture=E,Oe.executeExtensionsAdditiveAndParse(p.extensions,e,r,p)}),r.constructor===Jr&&(r.metallic=g??1,r.roughness=y??1,m&&(wt._checkOtherTextureTransform(m,"Roughness metallic"),e.get(xe.Texture,m.index).then(function(E){r.roughnessMetallicTexture=E})))}if(r.constructor===Jr||r.constructor===na){if(_&&(wt._checkOtherTextureTransform(_,"Emissive"),e.get(xe.Texture,_.index).then(function(E){r.emissiveTexture=E})),u&&(r.emissiveColor=new j(j.linearToGammaSpace(u[0]),j.linearToGammaSpace(u[1]),j.linearToGammaSpace(u[2]))),l){var x=l.index,S=l.scale;wt._checkOtherTextureTransform(l,"Normal"),e.get(xe.Texture,x).then(function(E){r.normalTexture=E}),S!==void 0&&(r.normalTextureIntensity=S)}if(c){var b=c.index,A=c.strength,C=c.texCoord;wt._checkOtherTextureTransform(c,"Occlusion"),e.get(xe.Texture,b).then(function(E){r.occlusionTexture=E}),A!==void 0&&(r.occlusionTextureIntensity=A),C===Vn.UV1?r.occlusionTextureCoord=Vn.UV1:C>Vn.UV1&&ve.warn("Occlusion texture uv coordinate must be UV0 or UV1.")}}switch(f?r.renderFace=hn.Double:r.renderFace=hn.Front,d){case Va.OPAQUE:r.isTransparent=!1;break;case Va.BLEND:r.isTransparent=!0;break;case Va.MASK:r.alphaCutoff=h??.5;break}},s}(Oe);wt=de([Xr(xe.Material)],wt);function Vo(n,s){return s!=null&&typeof Symbol<"u"&&s[Symbol.hasInstance]?!!s[Symbol.hasInstance](n):n instanceof s}var uo,Ia=(uo=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){for(var a=function(f,v){var p=o.primitives[f];u[f]=new Promise(function(g){var y=Oe.executeExtensionsCreateAndParse(p.extensions,e,p,o);if(y)Vo(y,ct)?(y._associationSuperResource(c),g(y)):y.then(function(S){S._associationSuperResource(c),g(S)});else{var m=new ct(_,o.name||f+"");m._associationSuperResource(c);var x=new Nh;x.mesh=m,e.contentRestorer.meshes.push(x),Ia._parseMeshFromGLTFPrimitive(e,m,x,o,p,l,e.params.keepMeshData).then(g)}})},o=e.glTF.meshes[r],l=e.glTF,c=e.glTFResource,_=c.engine,u=new Array,d=0,h=o.primitives.length;d<h;d++)a(d);return Promise.all(u)},s._parseMeshFromGLTFPrimitive=function(e,r,a,o,l,c,_){var u=function(A){var C=d[h[A]],E=et.getAccessorBuffer(e,c.bufferViews,C).then(function(T){var B=et.getAccessorTypeSize(C.type),M=C.count,P=T.data,V,N=r.instanceId,F=T.vertexBindingInfos,O=C.normalized,D=et.getElementFormat(C.componentType,B,O),z;O&&(z=et.getNormalizedComponentScale(C.componentType));var U;if(T.interleaved){var Y=C.byteOffset||0,K=T.stride;if(U=Y%K,F[N]===void 0){V=new Me(A,U,D,x);var H=T.vertexBuffer;H||(H=new ir(g,Nt.VertexBuffer,P,tt.Static,_),T.vertexBuffer=H,a.vertexBuffers.push(new rl(H,T.restoreInfo))),r.setVertexBufferBinding(H,K,x),F[N]=x++}else V=new Me(A,U,D,F[N])}else{U=0,V=new Me(A,U,D,x);var te=T.vertexBuffer;te||(te=new ir(g,Nt.VertexBuffer,P,tt.Static,_),a.vertexBuffers.push(new rl(te,T.restoreInfo))),r.setVertexBufferBinding(te,T.stride,x),F[N]=x++}if(y.push(V),A==="POSITION"){m=M;var we=r.bounds,pe=we.min,oe=we.max;if(C.min&&C.max)pe.copyFromArray(C.min),oe.copyFromArray(C.max);else{var Ee=Ia._tempVector3;pe.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),oe.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var Ke=U/P.BYTES_PER_ELEMENT,vt=P.length/M,Se=0;Se<M;Se++){var nt=Ke+Se*vt;Ee.copyFromArray(P,nt),w.min(pe,Ee,pe),w.max(oe,Ee,oe)}}O&&(pe.scale(z),oe.scale(z))}});S.push(E)},d=c.accessors,h=l.attributes,f=l.targets,v=l.indices,p=l.mode,g=r.engine,y=new Array,m,x=0,S=new Array;for(var b in h)u(b);return Promise.all(S).then(function(){if(r.setVertexElements(y),v!==void 0){var A=c.accessors[v],C=et.getAccessorBuffer(e,c.bufferViews,A).then(function(E){r.setIndices(E.data),r.addSubMesh(0,A.count,p),a.indexBuffer=E.restoreInfo});S.push(C)}else r.addSubMesh(0,m,p);return f&&S.push(Ia._createBlendShape(e,r,a,o,l,f)),Promise.all(S).then(function(){return r.uploadData(!_),r})})},s._getBlendShapeData=function(e,r,a){return et.getAccessorBuffer(e,r.bufferViews,a).then(function(o){var l=o.data,c,_=o.interleaved?((c=a.byteOffset)!=null?c:0)%o.stride:0,u=a.count,d=a.normalized,h=a.componentType,f=et.bufferToVector3Array(l,_,u,d,h),v=new Fh(o.restoreInfo,_,u,d,h);return{vertices:f,restoreInfo:v}})},s._createBlendShape=function(e,r,a,o,l,c){for(var _=this,u=function(m){var x={};g[m]=x;var S=f?f[m]:"blendShape"+m,b=l.targets[m],A=b.NORMAL,C=b.TANGENT,E=A!==void 0,T=C!==void 0,B=Promise.all([_._getBlendShapeData(e,d,h[b.POSITION]),E?_._getBlendShapeData(e,d,h[A]):null,T?_._getBlendShapeData(e,d,h[C]):null]).then(function(M){var P,V=M[0],N=M[1],F=M[2],O=new Ho(S);O.addFrame(1,V.vertices,E?N.vertices:null,T?F.vertices:null),x.blendShape=O,x.restoreInfo=new Ih(O,V.restoreInfo,E?N.restoreInfo:null,T?(P=F)==null?void 0:P.restoreInfo:null)});v.push(B)},d=e.glTF,h=d.accessors,f=o.extras?o.extras.targetNames:null,v=new Array,p=c.length,g=new Array(p),y=0;y<p;y++)u(y);return Promise.all(v).then(function(){for(var m=ua(g),x;!(x=m()).done;){var S=x.value;r.addBlendShape(S.blendShape),a.blendShapes.push(S.restoreInfo)}})},s}(Oe),function(){uo._tempVector3=new w}(),uo);Ia=de([Xr(xe.Mesh)],Ia);var ol=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){var a=e.glTF,o=a.scenes,l=a.scene,c=l===void 0?0:l,_=e.glTFResource,u=o[r],d=u.extensions,h=_.engine,f=c===r,v=u.nodes,p;if(v.length===1)p=e.get(xe.Entity,v[0]);else{p=new Qr(h,"GLTF_ROOT");for(var g=0;g<v.length;g++){var y=e.get(xe.Entity,v[g]);p.addChild(y)}}f&&(_._defaultSceneRoot=p);for(var m=new Array,x=0;x<v.length;x++)m.push(this._parseEntityComponent(e,v[x]));return Promise.all(m).then(function(){return Oe.executeExtensionsAdditiveAndParse(d,e,p,u),p})},i._parseEntityComponent=function(e,r){var a=this,o=e.glTF,l=e.glTFResource,c=o.nodes[r],_=c.camera,u=c.mesh,d=e.get(xe.Entity,r),h;return _!==void 0&&this._createCamera(l,o.cameras[_],d),u!==void 0&&(h=this._createRenderer(e,c,d)),Promise.resolve(h).then(function(){var f=[],v=c.children;if(v)for(var p=0;p<v.length;p++)f.push(a._parseEntityComponent(e,v[p]));return Promise.all(f)})},i._createCamera=function(e,r,a){var o,l=r.orthographic,c=r.perspective,_=r.type,u=a.addComponent(Ne);if(_===Xi.ORTHOGRAPHIC){var d=l.xmag,h=l.ymag,f=l.zfar,v=l.znear;u.isOrthographic=!0,v!==void 0&&(u.nearClipPlane=v),f!==void 0&&(u.farClipPlane=f),u.orthographicSize=Math.max(h??0,d??0)/2}else if(_===Xi.PERSPECTIVE){var p=c.aspectRatio,g=c.yfov,y=c.zfar,m=c.znear;p!==void 0&&(u.aspectRatio=p),g!==void 0&&(u.fieldOfView=g*180/Math.PI),y!==void 0&&(u.farClipPlane=y),m!==void 0&&(u.nearClipPlane=m)}(o=e).cameras||(o.cameras=[]),e.cameras.push(u),u.enabled=!1},i._createRenderer=function(e,r,a){for(var o=function(g){var y=h[g],m=y.material;v.push(Promise.all([e.get(xe.Mesh,_),u!==void 0&&e.get(xe.Skin,u),m!==void 0&&e.get(xe.Material,m)]).then(function(x){var S=x[0],b=x[1],A=x[2],C=S[g],E;if(A||(A=wt._getDefaultMaterial(e.glTFResource.engine)),b||f){var T=a.addComponent(Pt);T.mesh=C,b&&(T.rootBone=b._rootBone,T.bones=b._bones,l._computeLocalBounds(T,C,b._bones,b._rootBone,b.inverseBindMatrices),T.skin=b),f&&(T.blendShapeWeights=new Float32Array(f)),E=T}else E=a.addComponent(Rt),E.mesh=C;E.setMaterial(A),C.vertexElements.forEach(function(B){B.semantic==="COLOR_0"&&(E.enableVertexColor=!0)}),Oe.executeExtensionsAdditiveAndParse(y.extensions,e,E,y)}))},l=this,c=e.glTF.meshes,_=r.mesh,u=r.skin,d=c[_],h=d.primitives,f=r.weights||d.weights,v=new Array,p=0;p<h.length;p++)o(p);return Promise.all(v)},i._computeLocalBounds=function(e,r,a,o,l){var c=a.indexOf(o);if(c!==-1)nr.transform(r.bounds,l[c],e.localBounds);else{var _=new J(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),u=this._computeApproximateBindMatrix(a,l,o,_);u!==0?(J.multiplyScalar(_,1/u,_),nr.transform(r.bounds,_,e.localBounds)):e.localBounds.copyFrom(r.bounds)}},i._computeApproximateBindMatrix=function(e,r,a,o){for(var l=0,c=a.children,_=0,u=c.length;_<u;_++){var d=c[_],h=e.indexOf(d);h!==-1?(J.add(o,r[h],o),l++):l+=this._computeApproximateBindMatrix(e,r,d,o)}return l},s}(Oe);ol=de([Xr(xe.Scene)],ol);var sl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){var a=this,o=e.glTF,l=o.skins[r],c=l.inverseBindMatrices,_=l.skeleton,u=l.joints,d=l.name,h=d===void 0?"SKIN_"+r:d,f=u.length,v=new vc(h);v.inverseBindMatrices.length=f,v._bones.length=f;var p=o.accessors[c],g=et.getAccessorBuffer(e,o.bufferViews,p).then(function(y){for(var m=e.get(xe.Entity),x=y.data,S=0;S<f;S++){var b=new J;b.copyFromArray(x,S*16),v.inverseBindMatrices[S]=b;var A=m[u[S]];if(v._bones[S]=A,v.joints[S]=A.name,_!==void 0){var C=m[_];v._rootBone=C,v.skeleton=C.name}else{var E=a._findSkeletonRootBone(u,m);if(E)v._rootBone=E,v.skeleton=E.name;else throw"Failed to find skeleton root bone."}}return v});return Promise.resolve(g)},i._findSkeletonRootBone=function(e,r){for(var a={},o=ua(e),l;!(l=o()).done;){for(var c=l.value,_=new Array,u=r[c];u;)_.unshift(u),u=u.parent;a[c]=_}for(var d=null,h=0;;h++){var f=a[e[0]];if(h>=f.length)return d;for(var v=f[h],p=1,g=e.length;p<g;p++)if(f=a[e[p]],h>=f.length||v!==f[h])return d;d=v}},s}(Oe);sl=de([Xr(xe.Skin)],sl);var ho,qi=(ho=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){var a=e.glTF.textures[r],o=e.glTFResource,l=e.glTF,c=o.engine,_=o.url,u=a.sampler,d=a.source,h=d===void 0?0:d,f=a.name,v=a.extensions,p=l.images[h],g=p.uri,y=p.bufferView,m=p.mimeType,x=p.name,S=Oe.executeExtensionsCreateAndParse(v,e,a);if(!S){var b=u!==void 0,A=u!==void 0&&et.getSamplerInfo(l.samplers[u]);if(g){var C,E=g.lastIndexOf("."),T=g.substring(E+1),B=T.startsWith("ktx")?Fe.KTX:Fe.Texture2D;S=c.resourceManager.load({url:We.resolveAbsoluteUrl(_,g),type:B,params:{mipmap:(C=A)==null?void 0:C.mipmap}}).onProgress(void 0,e._onTaskDetail).then(function(P){return P.name=f||x||P.name||"texture_"+r,b&&et.parseSampler(P,A),P}),e._addTaskCompletePromise(S)}else{var M=l.bufferViews[y];S=e.get(xe.Buffer).then(function(P){var V=P[M.buffer],N=new Uint8Array(V,M.byteOffset,M.byteLength);return et.loadImageBuffer(N,m).then(function(F){var O,D=new bt(c,F.width,F.height,void 0,(O=A)==null?void 0:O.mipmap);D.setImageSource(F),D.generateMipmaps(),D.name=f||x||"texture_"+r,b&&et.parseSampler(D,A);var z=new zc(D,M,m);return e.contentRestorer.bufferTextures.push(z),D})})}}return Promise.resolve(S).then(function(P){return Oe.executeExtensionsAdditiveAndParse(v,e,P,a),P._associationSuperResource(o),P})},s}(Oe),function(){var n;ho._wrapMap=(n={},n[Na.CLAMP_TO_EDGE]=yt.Clamp,n[Na.MIRRORED_REPEAT]=yt.Mirror,n[Na.REPEAT]=yt.Repeat,n)}(),ho);qi=de([Xr(xe.Texture)],qi);var ll=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e){var r=e.glTF,a=r.asset.version,o=r.extensionsUsed,l=r.extensionsRequired,c=Number(a);if(!(c>=2&&c<3))throw"Only support glTF 2.x.";if(o){ve.info("extensionsUsed: ",o);for(var _=0;_<o.length;_++){var u=o[_];Oe.hasExtensionParser(u)||ve.warn("Extension "+u+" is not implemented, you can customize this extension in gltf.")}}if(l){ve.info("extensionsRequired: "+l);for(var d=0;d<l.length;d++){var h=l[d];Oe.hasExtensionParser(h)||ve.error("GLTF parser has not supported required extension "+h+".")}}return Promise.resolve(null)},s}(Oe);ll=de([Xr(xe.Validator)],ll);var cl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.parse=function(e,r){var a=e.glTF.bufferViews[r],o=a.extensions,l=a.byteOffset,c=l===void 0?0:l,_=a.byteLength,u=a.buffer;return o?Oe.executeExtensionsCreateAndParse(o,e,a):e.get(xe.Buffer,u).then(function(d){return new Uint8Array(d,c,_)})},s}(Oe);cl=de([Xr(xe.BufferView)],cl);var wi=function(){var n=function(p){for(var g=new Uint8Array(p.length),y=0;y<p.length;++y){var m=p.charCodeAt(y);g[y]=m>96?m-97:m>64?m-39:m+4}for(var x=0,S=0;S<p.length;++S)g[x++]=g[S]<60?o[g[S]]:(g[S]-60)*64+g[++S];return g.buffer.slice(0,x)},s=function(p,g,y,m,x,S){var b=c.exports.sbrk,A=y+3&-4,C=b(A*m),E=b(x.length),T=new Uint8Array(c.exports.memory.buffer);T.set(x,E);var B=p(C,y,m,E,x.length);if(B==0&&S&&S(C,A,m),g.set(T.subarray(C,C+y*m)),b(C-b(0)),B!=0)throw new Error("Malformed buffer data: "+B)},i=function(p){var g={object:new Worker(p),pending:0,requests:{}};return g.object.onmessage=function(y){var m=y.data;g.pending-=m.count,g.requests[m.id][m.action](m.value),delete g.requests[m.id]},g},t=function(p){for(var g="var instance; var ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(n(l))+`]), {}).then(function(result) {instance = result.instance; instance.exports.__wasm_call_ctors();});
self.onmessage = workerProcess;
function decode(fun, target, count, size, source, filter) {
        const sbrk = instance.exports.sbrk;
        const count4 = (count + 3) & ~3;
        const tp = sbrk(count4 * size);
        const sp = sbrk(source.length);
        const heap = new Uint8Array(instance.exports.memory.buffer);
        heap.set(source, sp);
        const res = fun(tp, count, size, sp, source.length);
        if (res == 0 && filter) {
          filter(tp, count4, size);
        }
        target.set(heap.subarray(tp, tp + count * size));
        sbrk(tp - sbrk(0));
        if (res != 0) {
          throw new Error("Malformed buffer data: " + res);
        }
      }
function workerProcess(event) {
        ready.then(function () {
          const data = event.data;
          try {
            const target = new Uint8Array(data.count * data.size);
            decode(instance.exports[data.mode], target, data.count, data.size, data.source, instance.exports[data.filter]);
            self.postMessage({ id: data.id, count: data.count, action: "resolve", value: target }, [target.buffer]);
          } catch (error) {
            self.postMessage({
              id: data.id,
              count: data.count,
              action: "reject",
              value: error
            });
          }
        });
      }`,y=new Blob([g],{type:"text/javascript"}),m=URL.createObjectURL(y),x=0;x<p;++x)h[x]=i(m);URL.revokeObjectURL(m)},e=function(p,g,y,m,x){for(var S=h[0],b=1;b<h.length;++b)h[b].pending<S.pending&&(S=h[b]);return new Promise(function(A,C){var E=new Uint8Array(y),T=f++;S.pending+=p,S.requests[T]={resolve:A,reject:C},S.object.postMessage({id:T,count:p,size:g,source:E,mode:m,filter:x},[E.buffer])})},r="b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:q;iekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq:P8Yqdbk;3sezu8Jjjjjbcj;eb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Radz1jjjbhwcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhDcbhqinaqae9pmeaDaeaq9RaqaDfae6Egkcsfgocl4cifcd4hxdndndndnaoc9WGgmTmbcbhPcehsawcjdfhzalhHinaraH9Rax6midnaraHaxfgl9RcK6mbczhoinawcj;cbfaogifgoc9WfhOdndndndndnaHaic9WfgAco4fRbbaAci4coG4ciGPlbedibkaO9cb83ibaOcwf9cb83ibxikaOalRblalRbbgAco4gCaCciSgCE86bbaocGfalclfaCfgORbbaAcl4ciGgCaCciSgCE86bbaocVfaOaCfgORbbaAcd4ciGgCaCciSgCE86bbaoc7faOaCfgORbbaAciGgAaAciSgAE86bbaoctfaOaAfgARbbalRbegOco4gCaCciSgCE86bbaoc91faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc4faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc93faAaCfgARbbaOciGgOaOciSgOE86bbaoc94faAaOfgARbbalRbdgOco4gCaCciSgCE86bbaoc95faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc96faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc97faAaCfgARbbaOciGgOaOciSgOE86bbaoc98faAaOfgORbbalRbiglco4gAaAciSgAE86bbaoc99faOaAfgORbbalcl4ciGgAaAciSgAE86bbaoc9:faOaAfgORbbalcd4ciGgAaAciSgAE86bbaocufaOaAfgoRbbalciGglalciSglE86bbaoalfhlxdkaOalRbwalRbbgAcl4gCaCcsSgCE86bbaocGfalcwfaCfgORbbaAcsGgAaAcsSgAE86bbaocVfaOaAfgORbbalRbegAcl4gCaCcsSgCE86bbaoc7faOaCfgORbbaAcsGgAaAcsSgAE86bbaoctfaOaAfgORbbalRbdgAcl4gCaCcsSgCE86bbaoc91faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc4faOaAfgORbbalRbigAcl4gCaCcsSgCE86bbaoc93faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc94faOaAfgORbbalRblgAcl4gCaCcsSgCE86bbaoc95faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc96faOaAfgORbbalRbvgAcl4gCaCcsSgCE86bbaoc97faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc98faOaAfgORbbalRbogAcl4gCaCcsSgCE86bbaoc99faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc9:faOaAfgORbbalRbrglcl4gAaAcsSgAE86bbaocufaOaAfgoRbbalcsGglalcsSglE86bbaoalfhlxekaOal8Pbb83bbaOcwfalcwf8Pbb83bbalczfhlkdnaiam9pmbaiczfhoaral9RcL0mekkaiam6mialTmidnakTmbawaPfRbbhOcbhoazhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkkazcefhzaPcefgPad6hsalhHaPad9hmexvkkcbhlasceGmdxikalaxad2fhCdnakTmbcbhHcehsawcjdfhminaral9Rax6mialTmdalaxfhlawaHfRbbhOcbhoamhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkamcefhmaHcefgHad6hsaHad9hmbkaChlxikcbhocehsinaral9Rax6mdalTmealaxfhlaocefgoad6hsadao9hmbkaChlxdkcbhlasceGTmekc9:hoxikabaqad2fawcjdfakad2z1jjjb8Aawawcjdfakcufad2fadz1jjjb8Aakaqfhqalmbkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;ebf8Kjjjjbaok;yzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;siliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabavcefciGaiVcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:Ohkxekcjjjj94hkkabavcdfciGaiVcetfak87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:Ohqxekcjjjj94hqkabavcufciGaiVcetfaq87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohqxekcjjjj94hqkabavciGaiVcetfaq87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2geTmbinababydbgdcwtcw91:Yadce91cjjj;8ifcjjj98G::NUdbabclfhbaecufgembkkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;LeeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiclfaeclfydbBdbaicwfaecwfydbBdbaicxfaecxfydbBdbaiczfhiaeczfheadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk;aeedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdbaicxfalBdbaicwfalBdbaiclfalBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkkkebcjwklz9Kbb",a="b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q;Aekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq;t9tqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk;h8JlHud97euo978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Rad;8qbbcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhwcbhDinaDae9pmeawaeaD9RaDawfae6Egqcsfgoc9WGgkci2hxakcethmaocl4cifcd4hPabaDad2fhscbhzdnincehHalhOcbhAdninaraO9RaP6miavcj;cbfaAak2fhCaOaPfhlcbhidnakc;ab6mbaral9Rc;Gb6mbcbhoinaCaofhidndndndndnaOaoco4fRbbgXciGPlbedibkaipxbbbbbbbbbbbbbbbbpklbxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklbalczfhlkdndndndndnaXcd4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklzxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklzalczfhlkdndndndndnaXcl4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklaxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklaalczfhlkdndndndndnaXco4Plbedibkaipxbbbbbbbbbbbbbbbbpkl8WxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalclfaYpQbfaXc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalcwfaYpQbfaXc:q:yjjbfRbbfhlxekaialpbbbpkl8Walczfhlkaoc;abfhiaocjefak0meaihoaral9Rc;Fb0mbkkdndnaiak9pmbaici4hoinaral9RcK6mdaCaifhXdndndndndnaOaico4fRbbaocoG4ciGPlbedibkaXpxbbbbbbbbbbbbbbbbpklbxikaXalpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaXalpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaXalpbbbpklbalczfhlkaocdfhoaiczfgiak6mbkkalTmbaAci6hHalhOaAcefgohAaoclSmdxekkcbhlaHceGmdkdnakTmbavcjdfazfhiavazfpbdbhYcbhXinaiavcj;cbfaXfgopblbgLcep9TaLpxeeeeeeeeeeeeeeeegQp9op9Hp9rgLaoakfpblbg8Acep9Ta8AaQp9op9Hp9rg8ApmbzeHdOiAlCvXoQrLgEaoamfpblbg3cep9Ta3aQp9op9Hp9rg3aoaxfpblbg5cep9Ta5aQp9op9Hp9rg5pmbzeHdOiAlCvXoQrLg8EpmbezHdiOAlvCXorQLgQaQpmbedibedibedibediaYp9UgYp9AdbbaiadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaEa8EpmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwKDYq8AkEx3m5P8Es8FgLa3a5pmwKDYq8AkEx3m5P8Es8Fg8ApmbezHdiOAlvCXorQLgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfhiaXczfgXak6mbkkazclfgzad6mbkasavcjdfaqad2;8qbbavavcjdfaqcufad2fad;8qbbaqaDfhDc9:hoalmexikkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;kbf8Kjjjjbaokwbz:bjjjbk;uzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:EPliuo97eue978Jjjjjbca9Rhidndnadcl9hmbdnaec98GglTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalae9pmeaiaeciGgvcdtgdVcbczad9R;8kbaiabalcdtfglad;8qbbdnavTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkalaiad;8qbbskdnaec98GgxTmbcbhvabhdinadczfglalpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oawaopmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgvax6mbkkaxae9pmbaiaeciGgvcitgdfcbcaad9R;8kbaiabaxcitfglad;8qbbdnavTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oawaopmbezHdiOAlvCXorQLp9qpklbkalaiad;8qbbkk;4wllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalae9pmbaiaeciGgvcitgofcbcaao9R;8kbaiabalcitfgwao;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkawaiao;8qbbkk:Pddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbhdabheinaeaepbbbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepkbbaeczfheadclfgdav6mbkkdnaval9pmbaialciGgdcdtgeVcbc;abae9R;8kbaiabavcdtfgvae;8qbbdnadTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepklbkavaiae;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz9Tbb",o=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]),l=Zr._detectSIMDSupported()?a:r,c,_=WebAssembly.instantiate(n(l),{}).then(function(v){c=v.instance,c.exports.__wasm_call_ctors()}),u={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},d={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},h=[],f=0;return{workerCount:4,ready:_,useWorkers:function(){t(this.workerCount)},decodeGltfBuffer:function(p,g,y,m,x){return this.workerCount>0&&h.length===0&&this.useWorkers(),h.length>0?e(p,g,y,d[m],u[x]):_.then(function(){var S=new Uint8Array(p*g);return s(c.exports[d[m]],S,p,g,y,c.exports[u[x]]),S})},release:function(){for(var p=0;p<h.length;p++)h[p].object.terminate()}}}(),_l=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.initialize=function(e,r){var a,o=(a=r.glTF)==null?void 0:a.meshOpt;return o&&(wi.workerCount=o.workerCount,wi.useWorkers()),Promise.resolve()},i.load=function(e,r){var a=e.url,o=e.params,l=new wh(r.engine,a),c=new as(l,r,zt({keepMeshData:!1},o));return new Be(function(_,u,d,h){c._setTaskCompleteProgress=d,c._setTaskDetailProgress=h,c.parse().then(_).catch(u)})},s.release=function(){wi.release()},s}(De);_l=de([Qe(Fe.GLTF,["gltf","glb"])],_l);var ge,sa=Math.PI,Fa=(ge=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Be(function(o,l){var c=r.engine;a.request(e.url,{type:"arraybuffer"}).then(function(_){for(var u=new Uint8Array(_),d=Fa._parseHeader(u),h=d.width,f=d.height,v=d.dataPosition,p=Fa._readPixels(u.subarray(v),h,f),g=f>>1,y=Fa._convertToCubemap(p,h,f,g),m=new tr(c,g),x=0;x<6;x++)m.setPixelBuffer(Dr.PositiveX+x,y[x],0);m.generateMipmaps(),o(m)}).catch(l)})},s._convertToCubemap=function(e,r,a,o){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=r*a*4)throw"ConvertPanoramaToCubemap: input size is wrong";var l=this._createCubemapData(o,this._faceRight,e,r,a),c=this._createCubemapData(o,this._faceLeft,e,r,a),_=this._createCubemapData(o,this._faceUp,e,r,a),u=this._createCubemapData(o,this._faceBottom,e,r,a),d=this._createCubemapData(o,this._faceFront,e,r,a),h=this._createCubemapData(o,this._faceBack,e,r,a);return[l,c,_,u,d,h]},s._createCubemapData=function(e,r,a,o,l){for(var c=new Uint8ClampedArray(e*e*4),_=this._tempVector3.set(0,0,0).add(r[1]).subtract(r[0]).scale(1/e),u=this._temp2Vector3.set(0,0,0).add(r[3]).subtract(r[2]).scale(1/e),d=1/e,h=0,f=0;f<e;f++){for(var v=this._temp3Vector3.set(0,0,0).add(r[0]),p=this._temp4Vector3.set(0,0,0).add(r[2]),g=0;g<e;g++){var y=this._temp5Vector3.set(0,0,0).add(p).subtract(v).scale(h).add(v);y.normalize();var m=this._calcProjectionSpherical(y,a,o,l);this._RGBEToLinear(m),this._linearToRGBM(m,5);var x=f*e*4+g*4;c[x]=m.r,c[x+1]=m.g,c[x+2]=m.b,c[x+3]=m.a,v.add(_),p.add(u)}h+=d}return c},s._calcProjectionSpherical=function(e,r,a,o){for(var l=Math.atan2(e.z,e.x),c=Math.acos(e.y);l<-sa;)l+=2*sa;for(;l>sa;)l-=2*sa;var _=l/sa,u=c/sa;_=_*.5+.5;var d=Math.round(_*a);d<0?d=0:d>=a&&(d=a-1);var h=Math.round(u*o);h<0?h=0:h>=o&&(h=o-1);var f=o-h-1,v=f*a*4+d*4,p=r[v],g=r[v+1],y=r[v+2],m=r[v+3];return new j(p,g,y,m)},s._readStringLine=function(e,r){for(var a="",o="",l=r;l<e.length-r&&(o=String.fromCharCode(e[l]),o!=`
`);l++)a+=o;return a},s._parseHeader=function(e){var r=0,a=0,o=this._readStringLine(e,0);if(o[0]!="#"||o[1]!="?")throw"Bad HDR Format.";var l=!1,c=!1,_=0;do _+=o.length+1,o=this._readStringLine(e,_),o=="FORMAT=32-bit_rle_rgbe"?c=!0:o.length==0&&(l=!0);while(!l);if(!c)throw"HDR Bad header format, unsupported FORMAT";_+=o.length+1,o=this._readStringLine(e,_);var u=/^\-Y (.*) \+X (.*)$/g,d=u.exec(o);if(!d||d.length<3)throw"HDR Bad header format, no size";if(a=parseInt(d[2]),r=parseInt(d[1]),a<8||a>32767)throw"HDR Bad header format, unsupported size";return _+=o.length+1,{height:r,width:a,dataPosition:_}},s._readPixels=function(e,r,a){for(var o=r,l=e.byteLength,c=new Uint8Array(4*r*a),_=0,u=0,d=4*o,h=new Uint8Array(4),f=new Uint8Array(d),v=a;v>0&&u<l;){if(h[0]=e[u++],h[1]=e[u++],h[2]=e[u++],h[3]=e[u++],h[0]!=2||h[1]!=2||(h[2]<<8|h[3])!=o)throw"HDR Bad header format, wrong scan line width";for(var p=0,g=void 0;p<d&&u<l;){g=e[u++];var y=g>128;if(y&&(g-=128),g===0||p+g>d)throw"HDR Bad Format, bad scanline data (run)";if(y)for(var m=e[u++],x=0;x<g;x++)f[p++]=m;else f.set(e.subarray(u,u+g),p),p+=g,u+=g}for(var S=o,b=0;b<S;b++){var A=0;c[_]=f[b+A],A+=o,c[_+1]=f[b+A],A+=o,c[_+2]=f[b+A],A+=o,c[_+3]=f[b+A],_+=4}v--}return c},s._RGBEToLinear=function(e){var r=Math.pow(2,e.a-128)/255;e.r*=r,e.g*=r,e.b*=r,e.a=1},s._linearToRGBM=function(e,r){var a=Math.max(e.r,Math.max(e.g,e.b)),o=Math.min(a/r,1);o=Math.ceil(o*255);var l=65025/(o*r);e.r*=l,e.g*=l,e.b*=l,e.a*=o},s}(De),function(){ge._rightBottomBack=new w(1,-1,-1)}(),function(){ge._rightBottomFront=new w(1,-1,1)}(),function(){ge._rightUpBack=new w(1,1,-1)}(),function(){ge._rightUpFront=new w(1,1,1)}(),function(){ge._leftBottomBack=new w(-1,-1,-1)}(),function(){ge._leftBottomFront=new w(-1,-1,1)}(),function(){ge._leftUpBack=new w(-1,1,-1)}(),function(){ge._leftUpFront=new w(-1,1,1)}(),function(){ge._faceRight=[ge._rightBottomBack,ge._rightBottomFront,ge._rightUpBack,ge._rightUpFront]}(),function(){ge._faceLeft=[ge._leftBottomFront,ge._leftBottomBack,ge._leftUpFront,ge._leftUpBack]}(),function(){ge._faceUp=[ge._leftBottomFront,ge._rightBottomFront,ge._leftBottomBack,ge._rightBottomBack]}(),function(){ge._faceBottom=[ge._leftUpBack,ge._rightUpBack,ge._leftUpFront,ge._rightUpFront]}(),function(){ge._faceFront=[ge._leftBottomBack,ge._rightBottomBack,ge._leftUpBack,ge._rightUpBack]}(),function(){ge._faceBack=[ge._rightBottomFront,ge._leftBottomFront,ge._rightUpFront,ge._leftUpFront]}(),function(){ge._tempVector3=new w}(),function(){ge._temp2Vector3=new w}(),function(){ge._temp3Vector3=new w}(),function(){ge._temp4Vector3=new w}(),function(){ge._temp5Vector3=new w}(),ge);Fa=de([Qe(Fe.HDR,["hdr"])],Fa);var ul=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e){return this.request(e.url,zt({},e,{type:"json"}))},s}(De);ul=de([Qe(Fe.JSON,["json"],!1)],ul);var Oh=12+13*4,zh=0;function Uh(n,s){for(var i=[],t=Oh+n.bytesOfKeyValueData,e=n.pixelWidth,r=n.pixelHeight,a=s?n.numberOfMipmapLevels:1,o=0;o<a;o++){var l=new Int32Array(n.buffer,t,1)[0];t+=4;for(var c=0;c<n.numberOfFaces;c++){var _=new Uint8Array(n.buffer,t,l);i.push({data:_,width:e,height:r}),t+=l,t+=3-(l+3)%4}e=Math.max(1,e*.5),r=Math.max(1,r*.5)}return i}function kh(n){if(n.byteLength>=12){var s=new Uint8Array(n,0,12);if(s[0]===171&&s[1]===75&&s[2]===84&&s[3]===88&&s[4]===32&&s[5]===49&&s[6]===49&&s[7]===187&&s[8]===13&&s[9]===10&&s[10]===26&&s[11]===10)return!0}return!1}function Gh(n){switch(n){case _e.RGB_S3TC_DXT1_EXT:return G.BC1;case _e.RGBA_S3TC_DXT5_EXT:return G.BC3;case _e.RGBA_BPTC_UNORM_EXT:return G.BC7;case _e.RGB_ETC1_WEBGL:return G.ETC1_RGB;case _e.RGB8_ETC2:return G.ETC2_RGB;case _e.RGB8_PUNCHTHROUGH_ALPHA1_ETC2:return G.ETC2_RGBA5;case _e.RGBA8_ETC2_EAC:return G.ETC2_RGBA8;case _e.RGB_PVRTC_2BPPV1_IMG:return G.PVRTC_RGB2;case _e.RGBA_PVRTC_2BPPV1_IMG:return G.PVRTC_RGBA2;case _e.RGB_PVRTC_4BPPV1_IMG:return G.PVRTC_RGB4;case _e.RGBA_PVRTC_4BPPV1_IMG:return G.PVRTC_RGBA4;case _e.RGBA_ASTC_4X4_KHR:return G.ASTC_4x4;case _e.RGBA_ASTC_5X5_KHR:return G.ASTC_5x5;case _e.RGBA_ASTC_6X6_KHR:return G.ASTC_6x6;case _e.RGBA_ASTC_8X8_KHR:return G.ASTC_8x8;case _e.RGBA_ASTC_10X10_KHR:return G.ASTC_10x10;case _e.RGBA_ASTC_12X12_KHR:return G.ASTC_12x12;default:var s=_e[n];throw new Error("this format is not supported in Galacean Engine: "+s)}}var Uc={parse:function(s,i,t,e){if(e===void 0&&(e=!1),!kh(s))throw new Error("khronosTextureContainerParser: invalid KTX file, texture missing KTX identifier");var r=Uint32Array.BYTES_PER_ELEMENT,a=new DataView(s,12,13*r),o=a.getUint32(0,!0),l=o===67305985,c={buffer:s,glType:a.getUint32(1*r,l),glTypeSize:a.getUint32(2*r,l),glFormat:a.getUint32(3*r,l),glInternalFormat:a.getUint32(4*r,l),glBaseInternalFormat:a.getUint32(5*r,l),pixelWidth:a.getUint32(6*r,l),pixelHeight:a.getUint32(7*r,l),pixelDepth:a.getUint32(8*r,l),numberOfArrayElements:a.getUint32(9*r,l),numberOfFaces:a.getUint32(10*r,l),numberOfMipmapLevels:a.getUint32(11*r,l),bytesOfKeyValueData:a.getUint32(12*r,l),loadType:zh};if(c.glType!==0)throw new Error("only compressed formats currently supported");if(c.numberOfMipmapLevels=Math.max(1,c.numberOfMipmapLevels),c.pixelHeight===0||c.pixelDepth!==0)throw new Error("only 2D textures currently supported");if(c.numberOfArrayElements!==0)throw new Error("texture arrays not currently supported");if(c.numberOfFaces!==i)throw new Error("number of faces expected"+i+", but found "+c.numberOfFaces);return t&&(c.mipmaps=Uh(c,!0)),e&&(c.engineFormat=Gh(c.glInternalFormat)),c}};function Hh(n){var s=Uc.parse(n,1,!0,!0);return{mipmaps:s.mipmaps,engineFormat:s.engineFormat,internalFormat:s.glInternalFormat,width:s.pixelWidth,height:s.pixelHeight}}function Wh(n){for(var s=[],i,t,e,r,a=0;a<n.length;a++){var o=Uc.parse(n[a],1,!0,!0);s.push(o.mipmaps),a===0&&(e=o.pixelWidth,r=o.pixelHeight,i=o.glInternalFormat,t=o.engineFormat)}return{mipmapsFaces:s,engineFormat:t,internalFormat:i,width:e,height:r}}var dl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Be(function(o,l){Promise.all(e.urls.map(function(c){return a.request(c,zt({},e,{type:"arraybuffer"}))})).then(function(c){for(var _=Wh(c),u=_.width,d=_.mipmapsFaces,h=_.engineFormat,f=d[0].length>1,v=new tr(r.engine,u,h,f),p=0;p<6;p++)for(var g=d[p].length,y=0;y<g;y++){var m=d[p][y],x=m.data,S=m.width,b=m.height;v.setPixelBuffer(Dr.PositiveX+p,x,y,0,0,S,b)}o(v)}).catch(function(c){l(c)})})},s}(De);dl=de([Qe(Fe.KTXCube,[])],dl);var hl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Be(function(o,l){a.request(e.url,zt({},e,{type:"arraybuffer"})).then(function(c){for(var _=Hh(c),u=_.width,d=_.height,h=_.mipmaps,f=_.engineFormat,v=h.length>1,p=new bt(r.engine,u,d,f,v),g=0;g<h.length;g++){var y=h[g],m=y.width,x=y.height,S=y.data;p.setPixelBuffer(S,g,0,0,m,x)}o(p)}).catch(function(c){l(c)})})},s}(De);hl=de([Qe(Fe.KTX,["ktx"])],hl);function kc(n,s,i){if(typeof i=="object")for(var t in i)kc(n[s],t,i[t]);else n[s]=i}var fl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Be(function(o,l){a.request(e.url,zt({},e,{type:"json"})).then(function(c){var _=function(T){var B=f[T],M=B.type,P=B.value;switch(M){case"Vector2":m.setVector2(T,new $(P.x,P.y));break;case"Vector3":m.setVector3(T,new w(P.x,P.y,P.z));break;case"Vector4":m.setVector4(T,new ae(P.x,P.y,P.z,P.w));break;case"Color":m.setColor(T,new j(P.r,P.g,P.b,P.a));break;case"Float":m.setFloat(T,P);break;case"Texture":y.push(r.getResourceByRef(P).then(function(V){m.setTexture(T,V)}));break;case"Boolean":m.setInt(T,P?1:0);break;case"Integer":m.setInt(T,Number(P));break}},u=r.engine,d=c.name,h=c.shader,f=c.shaderData,v=c.macros,p=c.renderState,g=new Mr(u,ne.find(h));g.name=d;var y=new Array,m=g.shaderData;for(var x in f)_(x);for(var S=0,b=v.length;S<b;S++){var A=v[S],C=A.name,E=A.value;E==null?m.enableMacro(C):m.enableMacro(C,E)}return kc(g,"renderState",p),Promise.all(y).then(function(){o(g)})}).catch(l)})},s}(De);fl=de([Qe(Fe.Material,["json"])],fl);var vl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Be(function(o,l){a.request(e.url,zt({},e,{type:"arraybuffer"})).then(function(c){return ao(c,r.engine)}).then(function(c){o(c)}).catch(l)})},s}(De);vl=de([Qe(Fe.Mesh,["mesh"])],vl);var pl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=r.engine;return this.request(e.url,zt({},e,{type:"json"})).then(function(o){switch(o.type){case"sphere":return it.createSubdivisionSurfaceSphere(a,o.sphereRadius,o.sphereStep);case"capsule":return it.createCapsule(a,o.capsuleRadius,o.capsuleHeight,o.capsuleRadialSegments,o.capsuleHeightSegments);case"cone":return it.createCone(a,o.coneRadius,o.coneHeight,o.coneRadialSegment,o.coneHeightSegment);case"cuboid":return it.createCuboid(a,o.cuboidWidth,o.cuboidHeight,o.cuboidDepth);case"cylinder":return it.createCylinder(a,o.cylinderRadiusTop,o.cylinderRadiusBottom,o.cylinderHeight,o.cylinderRadialSegment,o.cylinderHeightSegment);case"plane":return it.createPlane(a,o.planeWidth,o.planeHeight,o.planeHorizontalSegments,o.planeVerticalSegments);case"torus":return it.createTorus(a,o.torusRadius,o.torusTubeRadius,o.torusRadialSegments,o.torusTubularSegments,o.torusArc)}})},s}(De);pl=de([Qe(Fe.PrimitiveMesh,["mesh"],!1)],pl);var gl;(function(n){n.Sphere="sphere",n.Cuboid="cuboid",n.Plane="plane",n.Cylinder="cylinder",n.Torus="torus",n.Cone="cone",n.Capsule="capsule"})(gl||(gl={}));var ml=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this,o=r.engine;return new Be(function(l,c){a.request(e.url,{type:"json"}).then(function(_){return o.resourceManager.initVirtualResources(_.files),r.load({type:Fe.Scene,url:_.scene}).then(function(u){o.sceneManager.activeScene=u,l()})}).catch(c)})},s}(De);ml=de([Qe(Fe.Project,["proj"],!1)],ml);var yl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Be(function(o,l){var c=e.url;a._registerFont(c,c).then(function(){var _=new pa(r.engine,c);o(_)}).catch(function(_){l("load font "+c+" fail")})})},i._registerFont=function(e,r){return io(function(){var a;return ro(this,function(o){switch(o.label){case 0:return a=new FontFace(e,"url("+r+")"),[4,a.load()];case 1:return o.sent(),document.fonts.add(a),[2]}})})()},s}(De);yl=de([Qe(Fe.SourceFont,["ttf","otf","woff"],!1)],yl);var xl=function(n){se(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t._tempRect=new qr,t._tempVec2=new $,t._tempVec4=new ae,t}var i=s.prototype;return i.load=function(e,r){var a=this;return new Be(function(o,l,c,_,u){var d=[];u(function(){for(var f=0;f<d.length;f++)d[f].cancel()});var h=a.request(e.url,zt({},e,{type:"json"}));d.push(h),h.then(function(f){var v=function(B){var M=p[B];if(M.img){var P;d.push(r.load({url:We.resolveAbsoluteUrl(e.url,M.img),type:(P=M.type)!=null?P:Fe.Texture2D,params:{format:b,mipmap:g}}).then(function(N){y&&(N.anisoLevel=y),m!==void 0&&(N.filterMode=m),x!==void 0&&(N.wrapModeU=x),S!==void 0&&(N.wrapModeV=S);for(var F=0;F<M.sprites.length;F++)E._addSprite(a._makeSprite(C,M.sprites[F],N))}).catch(l))}else for(var V=0;V<M.sprites.length;V++)E._addSprite(a._makeSprite(C,M.sprites[V]))},p=f.atlasItems,g=f.mipmap,y=f.anisoLevel,m=f.filterMode,x=f.wrapModeU,S=f.wrapModeV,b=f.format,A=p?p.length:0,C=r.engine,E=new sc(C);if(A<0){o(E);return}d.length=0;for(var T=0;T<p.length;T++)v(T);Be.all(d).then(function(){o(E)}).catch(l)}).catch(l)})},i._makeSprite=function(e,r,a){var o=r.region,l=r.atlasRegionOffset,c=r.atlasRegion,_=r.pivot,u=r.border,d=r.width,h=r.height,f=new Ei(e,a,o?this._tempRect.set(o.x,o.y,o.w,o.h):void 0,_?this._tempVec2.set(_.x,_.y):void 0,u?this._tempVec4.set(u.x,u.y,u.z,u.w):void 0,r.name);if(a){var v=1/a.width,p=1/a.height;if(f.atlasRegion.set(c.x*v,c.y*p,c.w*v,c.h*p),l){var g=l.x,y=l.y,m=l.z,x=l.w;f.atlasRegionOffset.set(g*v,y*p,m*v,x*p)}r.atlasRotated&&(f.atlasRotated=!0)}return isNaN(d)||(f.width=d),isNaN(h)||(f.height=h),f},s}(De);xl=de([Qe(Fe.SpriteAtlas,["atlas"],!1)],xl);var bl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return this.request(e.url,zt({},e,{type:"json"})).then(function(o){return o.belongToAtlas?a._loadFromAtlas(r,o):a._loadFromTexture(r,o)})},i._loadFromAtlas=function(e,r){var a=this;return e.getResourceByRef(r.belongToAtlas).then(function(o){return o.getSprite(r.fullPath)||a._loadFromTexture(e,r)})},i._loadFromTexture=function(e,r){return r.texture?e.getResourceByRef(r.texture).then(function(a){var o=new Ei(e.engine,a,r.region,r.pivot,r.border),l=r.width,c=r.height;return isNaN(l)||(o.width=l),isNaN(c)||(o.height=c),o}):new Be(function(a){var o=new Ei(e.engine,null,r.region,r.pivot,r.border),l=r.width,c=r.height;isNaN(l)||(o.width=l),isNaN(c)||(o.height=c),a(o)})},s}(De);bl=de([Qe(Fe.Sprite,["sprite"],!1)],bl);var Xh=function(n){se(s,n);function s(t,e,r){var a;return a=n.call(this,t)||this,a.url=e,a.requestConfig=r,a}var i=s.prototype;return i.restoreContent=function(){var e=this;return aa(this.url,this.requestConfig).then(function(r){var a=e.resource;return a.setImageSource(r),a.generateMipmaps(),a})},s}(Rr),Cl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Be(function(o,l,c,_){var u=e.url,d=zt({},e,{type:"image"});a.request(u,d).onProgress(c,_).then(function(h){var f,v=(f=e.params)!=null?f:{},p=v.format,g=v.mipmap,y=v.anisoLevel,m=v.wrapModeU,x=v.wrapModeV,S=v.filterMode,b=new bt(r.engine,h.width,h.height,p,g);if(b.anisoLevel=y??b.anisoLevel,b.filterMode=S??b.filterMode,b.wrapModeU=m??b.wrapModeU,b.wrapModeV=x??b.wrapModeV,b.setImageSource(h),b.generateMipmaps(),u.indexOf("data:")!==0){var A=u.lastIndexOf("/");b.name=u.substring(A+1)}r.addContentRestorer(new Xh(b,u,d)),o(b)}).catch(function(h){l(h)})})},s}(De);Cl=de([Qe(Fe.Texture2D,["png","jpg","webp","jpeg"])],Cl);var jh=function(n){se(s,n);function s(t,e,r){var a;return a=n.call(this,t)||this,a.urls=e,a.requestConfig=r,a}var i=s.prototype;return i.restoreContent=function(){var e=this;return new Be(function(r,a){Promise.all(e.urls.map(function(o){return aa(o,e.requestConfig)})).then(function(o){for(var l=e.resource,c=0;c<6;c++)l.setImageSource(Dr.PositiveX+c,o[c],0);l.generateMipmaps(),r(l)}).catch(function(o){a(o)})})},s}(Rr),Sl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this;return new Be(function(o,l){var c=e.urls,_=zt({},e,{type:"image"});Promise.all(c.map(function(u){return a.request(u,_)})).then(function(u){var d=u[0],h=d.width,f=d.height;if(h!==f){console.error("The cube texture must have the same width and height");return}for(var v=new tr(r.engine,h),p=0;p<6;p++)v.setImageSource(Dr.PositiveX+p,u[p],0);v.generateMipmaps(),r.addContentRestorer(new jh(v,c,_)),o(v)}).catch(function(u){l(u)})})},s}(De);Sl=de([Qe(Fe.TextureCube,[""])],Sl);var Al=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.load=function(e,r){var a=this,o=r.engine;return new Be(function(l,c){a.request(e.url,{type:"json"}).then(function(_){return Sh.parse(o,_).then(function(u){var d=[],h=_.scene.ambient;if(h){var f=h.specularMode===Ro.Custom,v=h.diffuseMode===ta.SphericalHarmonics;u.ambientLight.diffuseIntensity=h.diffuseIntensity,u.ambientLight.specularIntensity=h.specularIntensity,u.ambientLight.diffuseMode=h.diffuseMode,u.ambientLight.diffuseSolidColor.copyFrom(h.diffuseSolidColor),u.ambientLight.specularTextureDecodeRGBM=!0,f&&h.customAmbientLight&&d.push(r.getResourceByRef(h.customAmbientLight).then(function(C){var E;u.ambientLight.specularTexture=(E=C)==null?void 0:E.specularTexture})),h.ambientLight&&(!f||v)&&d.push(r.getResourceByRef(h.ambientLight).then(function(C){if(!f){var E;u.ambientLight.specularTexture=(E=C)==null?void 0:E.specularTexture}if(v){var T;u.ambientLight.diffuseSphericalHarmonics=(T=C)==null?void 0:T.diffuseSphericalHarmonics}}))}var p=_.scene.background;switch(u.background.mode=p.mode,u.background.mode){case $r.SolidColor:u.background.solidColor.copyFrom(p.color);break;case $r.Sky:if(p.skyMesh&&p.skyMaterial){var g=r.getResourceByRef(p.skyMesh).then(function(C){u.background.sky.mesh=C}),y=r.getResourceByRef(p.skyMaterial).then(function(C){u.background.sky.material=C});d.push(g,y)}else ve.warn("Sky background mode requires skyMesh and skyMaterial");break;case $r.Texture:if(p.texture){var m=r.getResourceByRef(p.texture).then(function(C){u.background.texture=C});d.push(m)}break}var x=_.scene.shadow;if(x){x.castShadows!=null&&(u.castShadows=x.castShadows),x.shadowResolution!=null&&(u.shadowResolution=x.shadowResolution),x.shadowDistance!=null&&(u.shadowDistance=x.shadowDistance),x.shadowCascades!=null&&(u.shadowCascades=x.shadowCascades);var S;u.shadowTwoCascadeSplits=(S=x.shadowTwoCascadeSplits)!=null?S:u.shadowTwoCascadeSplits,x.shadowFourCascadeSplits&&u.shadowFourCascadeSplits.copyFrom(x.shadowFourCascadeSplits);var b;u.shadowFadeBorder=(b=x.shadowFadeBorder)!=null?b:u.shadowFadeBorder}var A=_.scene.fog;return A&&(A.fogMode!=null&&(u.fogMode=A.fogMode),A.fogStart!=null&&(u.fogStart=A.fogStart),A.fogEnd!=null&&(u.fogEnd=A.fogEnd),A.fogDensity!=null&&(u.fogDensity=A.fogDensity),A.fogColor!=null&&u.fogColor.copyFrom(A.fogColor)),Promise.all(d).then(function(){l(u)})})}).catch(c)})},s}(De);Al=de([Qe(Fe.Scene,["scene"],!0)],Al);ns.registerCustomParseComponent("TextRenderer",io(function(n,s){var i;return ro(this,function(t){return i=s.props,i.font||(n.font=pa.createFromOS(n.engine,i.fontFamily||"Arial")),[2,n]})}));var wl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.additiveParse=function(e,r,a){var o,l=e.glTF.extensions.KHR_lights_punctual.lights,c=l[a.light],_=c.color,u=c.intensity,d=u===void 0?1:u,h=c.type,f=c.range,v=c.spot,p=e.glTFResource,g;if(h==="directional"?g=r.addComponent(bn):h==="point"?g=r.addComponent(Cn):h==="spot"&&(g=r.addComponent(vr)),_&&g.color.set(_[0],_[1],_[2],1),g.intensity=d,f&&!Vo(g,bn)&&(g.distance=f),v&&Vo(g,vr)){var y=v.innerConeAngle,m=y===void 0?0:y,x=v.outerConeAngle,S=x===void 0?Math.PI/4:x;g.angle=m,g.penumbra=S-m}(o=p).lights||(o.lights=[]),p.lights.push(g)},s}(mr);wl=de([yr("KHR_lights_punctual",Mt.AdditiveParse)],wl);var El=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.additiveParse=function(e,r,a){var o=a.clearcoatFactor,l=o===void 0?0:o,c=a.clearcoatTexture,_=a.clearcoatRoughnessFactor,u=_===void 0?0:_,d=a.clearcoatRoughnessTexture,h=a.clearcoatNormalTexture;r.clearCoat=l,r.clearCoatRoughness=u,c&&(wt._checkOtherTextureTransform(c,"Clear coat"),e.get(xe.Texture,c.index).then(function(f){r.clearCoatTexture=f})),d&&(wt._checkOtherTextureTransform(d,"Clear coat roughness"),e.get(xe.Texture,d.index).then(function(f){r.clearCoatRoughnessTexture=f})),h&&(wt._checkOtherTextureTransform(h,"Clear coat normal"),e.get(xe.Texture,h.index).then(function(f){r.clearCoatNormalTexture=f}))},s}(mr);El=de([yr("KHR_materials_clearcoat",Mt.AdditiveParse)],El);var Tl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.additiveParse=function(e,r,a){var o=a.ior,l=o===void 0?1.5:o;r.ior=l},s}(mr);Tl=de([yr("KHR_materials_ior",Mt.AdditiveParse)],Tl);var Rl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.createAndParse=function(e,r,a){var o=e.glTFResource.engine,l=new na(o),c=r.diffuseFactor,_=r.diffuseTexture,u=r.specularFactor,d=r.glossinessFactor,h=r.specularGlossinessTexture;return c&&(l.baseColor=new j(j.linearToGammaSpace(c[0]),j.linearToGammaSpace(c[1]),j.linearToGammaSpace(c[2]),c[3])),_&&e.get(xe.Texture,_.index).then(function(f){l.baseTexture=f,Oe.executeExtensionsAdditiveAndParse(_.extensions,e,l,_)}),u&&(l.specularColor=new j(j.linearToGammaSpace(u[0]),j.linearToGammaSpace(u[1]),j.linearToGammaSpace(u[2]))),d!==void 0&&(l.glossiness=d),h&&(wt._checkOtherTextureTransform(h,"Specular glossiness"),e.get(xe.Texture,h.index).then(function(f){l.specularGlossinessTexture=f})),l.name=a.name,wt._parseStandardProperty(e,l,a),l},s}(mr);Rl=de([yr("KHR_materials_pbrSpecularGlossiness",Mt.CreateAndParse)],Rl);var Ml=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.createAndParse=function(e,r,a){var o=e.glTFResource.engine,l=new gc(o);return l.name=a.name,wt._parseStandardProperty(e,l,a),l},s}(mr);Ml=de([yr("KHR_materials_unlit",Mt.CreateAndParse)],Ml);var Pl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.additiveParse=function(e,r,a){var o=function(g){var y=f[g],m=y.material,x=y.variants;e.get(xe.Material,m).then(function(S){v.push({renderer:r,material:S,variants:x.map(function(b){return d[b].name})})})},l,c=e.glTF,_=c.extensions,u=_.KHR_materials_variants,d=u.variants,h=e.glTFResource,f=a.mappings;(l=h)._extensionsData||(l._extensionsData={});var v=[];h.extensionsData.variants=v;for(var p=0;p<f.length;p++)o(p)},s}(mr);Pl=de([yr("KHR_materials_variants",Mt.AdditiveParse)],Pl);var Bl=function(n){se(s,n);function s(){return n.apply(this,arguments)}return s}(mr);Bl=de([yr("KHR_mesh_quantization",Mt.AdditiveParse)],Bl);var Dl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.createAndParse=function(e,r,a){return io(function(){var o,l,c,_,u,d,h,f,v,p,g,y,m,x,S,b;return ro(this,function(A){return o=e.glTF,l=e.glTFResource,c=l.engine,_=l.url,u=a.sampler,d=a.name,h=r.source,f=o.images[h],v=f.uri,p=f.bufferView,g=f.mimeType,y=f.name,m=u!==void 0&&et.getSamplerInfo(o.samplers[u]),v?(x=v.lastIndexOf("."),S=c.resourceManager.load({url:We.resolveAbsoluteUrl(_,v),type:Fe.KTX2}).onProgress(void 0,e._onTaskDetail).then(function(C){return C.name||(C.name=d||y||"texture_"+x),u!==void 0&&et.parseSampler(C,m),C}),e._addTaskCompletePromise(S),[2,S]):(b=o.bufferViews[p],[2,e.get(xe.Buffer,b.buffer).then(function(C){var E=new Uint8Array(C,b.byteOffset,b.byteLength);return St._parseBuffer(E,c).then(function(T){var B=T.engine,M=T.result,P=T.targetFormat,V=T.params;return St._createTextureByBuffer(B,M,P,V)}).then(function(T){T.name=d||y||"texture_"+p,u!==void 0&&et.parseSampler(T,m);var B=new zc(T,b,g);return e.contentRestorer.bufferTextures.push(B),T})})])})})()},s}(mr);Dl=de([yr("KHR_texture_basisu",Mt.CreateAndParse)],Dl);var Ll=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.additiveParse=function(e,r,a){var o=a.offset,l=a.rotation,c=a.scale,_=a.texCoord;o&&(r.tilingOffset.z=o[0],r.tilingOffset.w=o[1]),c&&(r.tilingOffset.x=c[0],r.tilingOffset.y=c[1]),l&&ve.warn("rotation in KHR_texture_transform is not supported now"),_&&ve.warn("texCoord in KHR_texture_transform is not supported now")},s}(mr);Ll=de([yr("KHR_texture_transform",Mt.AdditiveParse)],Ll);var Vl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.createAndParse=function(e,r){var a=e.glTFResource.engine,o=a.resourceManager.getResourceByRef(r);return e._addTaskCompletePromise(o),o},s}(mr);Vl=de([yr("GALACEAN_materials_remap",Mt.CreateAndParse)],Vl);var Nl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.additiveParse=function(e,r,a){e.glTFResource.engine;var o=a.events;o.map(function(l){var c=new to;c.functionName=l.functionName,c.time=l.time,c.parameter=l.parameter,r.addEvent(c)})},s}(mr);Nl=de([yr("GALACEAN_animation_event",Mt.AdditiveParse)],Nl);var Il=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.createAndParse=function(e,r){return e.get(xe.Buffer,r.buffer).then(function(a){return wi.decodeGltfBuffer(r.count,r.byteStride,new Uint8Array(a,r.byteOffset,r.byteLength),r.mode,r.filter)})},s}(mr);Il=de([yr("EXT_meshopt_compression",Mt.CreateAndParse)],Il);var Fl=function(n){se(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.additiveParse=function(e,r,a){var o=a.anisotropyStrength,l=o===void 0?0:o,c=a.anisotropyRotation,_=c===void 0?0:c,u=a.anisotropyTexture;r.anisotropy=l,r.anisotropyRotation=_,u&&(wt._checkOtherTextureTransform(u,"Anisotropy texture"),e.get(xe.Texture,u.index).then(function(d){r.anisotropyTexture=d}))},s}(mr);Fl=de([yr("KHR_materials_anisotropy",Mt.AdditiveParse)],Fl);var qh="1.2.0-beta.3";console.log("Galacean engine version: "+qh);for(var Ol in Vs)De.registerClass(Ol,Vs[Ol]);L.getByName("u_width");L.getByName("u_min");L.getByName("u_max");L.getByName("u_boxColor");L.getByName("u_borderColor");ne.create("box",`
#include <common>
#include <common_vert>

void main() {
  gl_Position = vec4(POSITION, 1.0);
}`,`
uniform vec2 u_min;
uniform vec2 u_max;
uniform vec4 u_boxColor;
uniform vec4 u_borderColor;
uniform float u_width;

void main() {
  float vColor = step(u_min.x + u_width, gl_FragCoord.x) * step(gl_FragCoord.x, u_max.x - u_width) * step(u_min.y + u_width, gl_FragCoord.y) * step(gl_FragCoord.y, u_max.y - u_width);
  float vBorder = step(u_min.x, gl_FragCoord.x) * step(gl_FragCoord.x, u_max.x) * step(u_min.y, gl_FragCoord.y) * step(gl_FragCoord.y, u_max.y);
  gl_FragColor = u_boxColor * vColor + (1. - vColor) * vBorder * u_borderColor;
}
`);new oc;new w;new $;new w;new w;new w;new w;new w;new w;new w;new w;new w;new w;new w;new w;new J;var qe;(function(n){n[n.None=0]="None",n[n.ROTATE=1]="ROTATE",n[n.ZOOM=2]="ZOOM",n[n.PAN=4]="PAN",n[n.All=7]="All"})(qe||(qe={}));function ai(){return function(n){}}function ii(n,s,i,t){var e=arguments.length,r=e<3?s:t===null?t=Object.getOwnPropertyDescriptor(s,i):t,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(n,s,i,t);else for(var o=n.length-1;o>=0;o--)(a=n[o])&&(r=(e<3?a(r):e>3?a(s,i,r):a(s,i))||r);return e>3&&r&&Object.defineProperty(s,i,r),r}var zl=function(){function n(){}return n.onUpdateHandler=function(i){return i.isKeyHeldDown(Ie.ArrowLeft)||i.isKeyHeldDown(Ie.KeyA)||i.isKeyHeldDown(Ie.ArrowUp)||i.isKeyHeldDown(Ie.KeyW)||i.isKeyHeldDown(Ie.ArrowDown)||i.isKeyHeldDown(Ie.KeyS)||i.isKeyHeldDown(Ie.ArrowRight)||i.isKeyHeldDown(Ie.KeyD)?qe.PAN:qe.None},n.onUpdateDelta=function(i,t){var e=i.movementSpeed,r=i.input;t.x=t.y=t.z=0,(r.isKeyHeldDown(Ie.ArrowLeft)||r.isKeyHeldDown(Ie.KeyA))&&(t.x-=e),(r.isKeyHeldDown(Ie.ArrowRight)||r.isKeyHeldDown(Ie.KeyD))&&(t.x+=e),(r.isKeyHeldDown(Ie.ArrowUp)||r.isKeyHeldDown(Ie.KeyW))&&(t.z-=e),(r.isKeyHeldDown(Ie.ArrowDown)||r.isKeyHeldDown(Ie.KeyS))&&(t.z+=e)},n}();zl=ii([ai()],zl);var Ul;(function(n){n[n.Moving=0]="Moving",n[n.Distance=1]="Distance",n[n.None=2]="None"})(Ul||(Ul={}));var Ca=function(){function n(){}return n.onUpdateHandler=function(i){if(++this._frameIndex,i.pointers.length===1)if(i.isPointerHeldDown(er.Primary))this._updateType(qe.ROTATE,0);else{var t=i.pointers[0].deltaPosition;(t.x!==0||t.y!==0)&&i.isPointerUp(er.Primary)?this._updateType(qe.ROTATE,0):this._updateType(qe.None,2)}else this._updateType(qe.None,2);return this._handlerType},n.onUpdateDelta=function(i,t){var e=this,r=e._frameIndex;switch(this._deltaType){case 0:if(this._lastUsefulFrameIndex===r-1){var a=i.input.pointers[0].deltaPosition;t.x=a.x,t.y=a.y}else t.x=0,t.y=0;break}this._lastUsefulFrameIndex=r},n._updateType=function(i,t){(this._handlerType!==i||this._deltaType!==t)&&(this._handlerType=i,this._deltaType=t,this._lastUsefulFrameIndex=-1)},n}();Ca._deltaType=0;Ca._handlerType=qe.None;Ca._frameIndex=0;Ca._lastUsefulFrameIndex=-1;Ca=ii([ai()],Ca);var kl=k.zeroTolerance,is=function(){function n(i,t,e){this.radius=i,this.phi=t,this.theta=e,this._matrix=new J,this._matrixInv=new J,this.radius=i!==void 0?i:1,this.phi=t!==void 0?t:0,this.theta=e!==void 0?e:0}var s=n.prototype;return s.makeSafe=function(){var t=Math.floor(this.phi/Math.PI);return this.phi=k.clamp(this.phi,t*Math.PI+kl,(t+1)*Math.PI-kl),this},s.set=function(t,e,r){return this.radius=t,this.phi=e,this.theta=r,this},s.setYAxis=function(t){var e=n._xAxis,r=n._yAxis,a=n._zAxis;w.equals(e.set(1,0,0),r.copyFrom(t).normalize())&&e.set(0,1,0),w.cross(e,r,a),a.normalize(),w.cross(r,a,e);var o=this._matrix,l=o.elements;l[0]=e.x,l[1]=e.y,l[2]=e.z,l[4]=r.x,l[5]=r.y,l[6]=r.z,l[8]=a.x,l[9]=a.y,l[10]=a.z;var c=this._matrixInv,_=c.elements;_[0]=e.x,_[4]=e.y,_[8]=e.z,_[1]=r.x,_[5]=r.y,_[9]=r.z,_[2]=a.x,_[6]=a.y,_[10]=a.z},s.setFromVec3=function(t,e){return e===void 0&&(e=!1),t.transformNormal(this._matrixInv),this.radius=t.length(),this.radius===0?(this.theta=0,this.phi=0):e?(this.phi=2*Math.PI-Math.acos(k.clamp(t.y/this.radius,-1,1)),this.theta=Math.atan2(-t.x,-t.z)):(this.phi=Math.acos(k.clamp(t.y/this.radius,-1,1)),this.theta=Math.atan2(t.x,t.z)),this},s.setToVec3=function(t){var e=this,r=e.radius,a=e.phi,o=e.theta,l=Math.sin(a)*r;return this.phi-=Math.floor(this.phi/Math.PI/2)*Math.PI*2,t.set(l*Math.sin(o),r*Math.cos(a),l*Math.cos(o)),t.transformNormal(this._matrix),this.phi>Math.PI},n}();is._xAxis=new w;is._yAxis=new w;is._zAxis=new w;var Gl=function(){function n(){}return n.onUpdateHandler=function(i){return i.isKeyHeldDown(Ie.ArrowLeft)||i.isKeyHeldDown(Ie.ArrowRight)||i.isKeyHeldDown(Ie.ArrowUp)||i.isKeyHeldDown(Ie.ArrowDown)?qe.PAN:qe.None},n.onUpdateDelta=function(i,t){var e=i.keyPanSpeed,r=i.input;t.x=t.y=0,r.isKeyHeldDown(Ie.ArrowLeft)&&(t.x+=e),r.isKeyHeldDown(Ie.ArrowRight)&&(t.x-=e),r.isKeyHeldDown(Ie.ArrowUp)&&(t.y+=e),r.isKeyHeldDown(Ie.ArrowDown)&&(t.y-=e)},n}();Gl=ii([ai()],Gl);var Hl;(function(n){n[n.Moving=0]="Moving",n[n.Distance=1]="Distance",n[n.None=2]="None"})(Hl||(Hl={}));var ra=function(){function n(){}return n.onUpdateHandler=function(i){++this._frameIndex;var t=i.pointers;switch(t.length){case 1:if(i.isPointerHeldDown(er.Secondary))this._updateType(qe.PAN,0);else if(i.isPointerHeldDown(er.Auxiliary))this._updateType(qe.ZOOM,0);else if(i.isPointerHeldDown(er.Primary))this._updateType(qe.ROTATE,0);else{var e=i.pointers[0].deltaPosition;e.x!==0&&e.y!==0?i.isPointerUp(er.Secondary)?this._updateType(qe.PAN,0):i.isPointerUp(er.Auxiliary)?this._updateType(qe.ZOOM,0):i.isPointerUp(er.Primary)?this._updateType(qe.ROTATE,0):this._updateType(qe.None,2):this._updateType(qe.None,2)}break;case 2:this._updateType(qe.ZOOM,1);break;case 3:this._updateType(qe.PAN,0);break;default:this._updateType(qe.None,2);break}return this._handlerType},n.onUpdateDelta=function(i,t){var e=this,r=e._frameIndex;switch(this._deltaType){case 0:if(t.x=0,t.y=0,this._lastUsefulFrameIndex===r-1){for(var a=i.input.pointers,o=a.length,l=o-1;l>=0;l--){var c=a[l].deltaPosition;t.x+=c.x,t.y+=c.y}t.x/=o,t.y/=o}break;case 1:var _=i.input.pointers,u=_[0],d=_[1],h=$.distance(u.position,d.position);this._lastUsefulFrameIndex===r-1?t.set(0,this._distanceOfPointers-h,0):t.set(0,0,0),this._distanceOfPointers=h;break}this._lastUsefulFrameIndex=r},n._updateType=function(i,t){(this._handlerType!==i||this._deltaType!==t)&&(this._handlerType=i,this._deltaType=t,this._lastUsefulFrameIndex=-1)},n}();ra._deltaType=2;ra._handlerType=qe.None;ra._frameIndex=0;ra._lastUsefulFrameIndex=-1;ra._distanceOfPointers=0;ra=ii([ai()],ra);var Wl=function(){function n(){}return n.onUpdateHandler=function(i){var t=i.wheelDelta;return t.x===0&&t.y===0&&t.z===0?qe.None:qe.ZOOM},n.onUpdateDelta=function(i,t){t.copyFrom(i.input.wheelDelta)},n}();Wl=ii([ai()],Wl);function Xl(n,s){for(var i=0;i<s.length;i++){var t=s[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function Yh(n,s,i){return s&&Xl(n.prototype,s),i&&Xl(n,i),n}function No(n,s){return No=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},No(n,s)}function Qh(n,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(s&&s.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),s&&No(n,s)}function Kh(n,s,i,t){var e=arguments.length,r=e<3?s:t===null?t=Object.getOwnPropertyDescriptor(s,i):t,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(n,s,i,t);else for(var o=n.length-1;o>=0;o--)(a=n[o])&&(r=(e<3?a(r):e>3?a(s,i,r):a(s,i))||r);return e>3&&r&&Object.defineProperty(s,i,r),r}var Jh=`#define GLSLIFY 1
#include <common>
uniform vec3 u_pickColor;void main(){gl_FragColor=vec4(u_pickColor,1.0);}`,Zh=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <position_vert>
}`,$h=ne.create("framebuffer-picker-color",Zh,Jh),Sa=function(n){Qh(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t._renderersMap=[],t._frameBufferSize=new $(1024,1024),t}var i=s.prototype;return i.onAwake=function(){this._camera=this.entity.getComponent(Ne)},i.pick=function(e,r){var a=this;return new Promise(function(o,l){a._setupRenderTarget();var c=a._readPixelFromRenderTarget(e,r),_=a._getRendererByPixel(c);o(_)})},i.regionPick=function(e,r,a,o){var l=this;return new Promise(function(c,_){l._setupRenderTarget();var u=l._readPixelFromRenderTarget(e,r,a,o),d=l._getRenderersByPixel(u);c(d)})},i._checkFrameBufferSize=function(){var e=this._pickRenderTarget,r=this.engine,a=this._frameBufferSize;(!e||a.x!=e.width||a.y!=e.height)&&(e&&e.destroy(),this._pickRenderTarget=new ea(r,a.x,a.y,new bt(r,a.x,a.y,G.R8G8B8A8,!1)))},i._updateRenderersPickColor=function(e){for(var r=0,a=this._renderersMap,o=s._rootEntityRenderers,l=e.rootEntities,c=s._pickColorProperty,_=0,u=l.length;_<u;_++){l[_].getComponentsIncludeChildren(be,o);for(var d=0,h=o.length;d<h;d++){var f=o[d],v=f.shaderData,p=v.getVector3(c);p||(p=new w,v.setVector3(c,p)),this._uniqueId2Color(++r,p),a[r]=f}}},i._setupRenderTarget=function(){this._checkFrameBufferSize();var e=this._camera;this._updateRenderersPickColor(e.scene);var r=e.renderTarget,a=e.aspectRatio;e.renderTarget=this._pickRenderTarget,e.setReplacementShader($h),e.aspectRatio=a,e.render(),e.resetReplacementShader(),e.renderTarget=r,e.resetAspectRatio()},i._readPixelFromRenderTarget=function(e,r,a,o){var l,c,_,u=this._getCoordOnRenderTarget(e,r),d=arguments.length;if(d===2)l=s._pickPixel,c=_=1;else if(d===4){var h=this._getCoordOnRenderTarget(a,o);c=Math.abs(u.x-h.x),_=Math.abs(u.y-h.y),u.x=u.x<h.x?u.x:h.x,u.y=u.y<h.y?u.y:h.y,l=new Uint8Array(c*_*4)}return this._pickRenderTarget.getColorTexture().getPixelBuffer(u.x,u.y,c,_,0,l),l},i._getCoordOnRenderTarget=function(e,r){var a=this._pickRenderTarget,o=this.engine.canvas,l=this._camera.viewport,c=(l.z-l.x)*o.width,_=(l.w-l.y)*o.height;return{x:Math.floor((e-l.x)/c*(a.width-1)),y:Math.floor((r-l.y)/_*(a.height-1))}},i._getRendererByPixel=function(e){return this._renderersMap[this._color2UniqueId(e)]},i._getRenderersByPixel=function(e){var r=this,a=[],o=this._color2UniqueIds(e);return o.forEach(function(l){r._renderersMap[l]&&a.push(r._renderersMap[l])}),a},i._uniqueId2Color=function(e,r){e>=16777215&&(ve.warn("Framebuffer Picker encounter primitive's id greater than "+16777215),r.set(0,0,0)),r.set((e&255)/255,((e&65280)>>8)/255,((e&16711680)>>16)/255)},i._color2UniqueId=function(e){return e[0]|e[1]<<8|e[2]<<16},i._color2UniqueIds=function(e){s._pickIds.clear();for(var r=0;r<e.length;r+=4){var a=e[r]|e[r+1]<<8|e[r+2]<<16;s._pickIds.add(a)}return s._pickIds},Yh(s,[{key:"frameBufferSize",get:function(){return this._frameBufferSize},set:function(e){this._frameBufferSize=e}}]),s}(Jt);Sa._rootEntityRenderers=[];Sa._pickPixel=new Uint8Array(4);Sa._pickIds=new Set;Sa._pickColorProperty=L.getByName("u_pickColor");Sa=Kh([An(Ne,Ur.CheckOnly)],Sa);function jl(n,s){for(var i=0;i<s.length;i++){var t=s[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function os(n,s,i){return s&&jl(n.prototype,s),i&&jl(n,i),n}var le=function(){function n(){}return n.createCuboidWireframe=function(i,t,e,r,a,o,l){var c=i/2,_=t/2,u=e/2,d=a;r[d++].set(-c,_,-u),r[d++].set(c,_,-u),r[d++].set(c,_,u),r[d++].set(-c,_,u),r[d++].set(-c,-_,-u),r[d++].set(c,-_,-u),r[d++].set(c,-_,u),r[d++].set(-c,-_,u),r[d++].set(-c,_,-u),r[d++].set(-c,_,u),r[d++].set(-c,-_,u),r[d++].set(-c,-_,-u),r[d++].set(c,_,-u),r[d++].set(c,_,u),r[d++].set(c,-_,u),r[d++].set(c,-_,-u),r[d++].set(-c,_,u),r[d++].set(c,_,u),r[d++].set(c,-_,u),r[d++].set(-c,-_,u),r[d++].set(-c,_,-u),r[d++].set(c,_,-u),r[d++].set(c,-_,-u),r[d++].set(-c,-_,-u),o[l++]=a,o[l++]=a+1,o[l++]=a+1,o[l++]=a+2,o[l++]=a+2,o[l++]=a+3,o[l++]=a+3,o[l++]=a,o[l++]=a+4,o[l++]=a+5,o[l++]=a+5,o[l++]=a+6,o[l++]=a+6,o[l++]=a+7,o[l++]=a+7,o[l++]=a+4,o[l++]=a+8,o[l++]=a+9,o[l++]=a+9,o[l++]=a+10,o[l++]=a+10,o[l++]=a+11,o[l++]=a+11,o[l++]=a+8,o[l++]=a+12,o[l++]=a+13,o[l++]=a+13,o[l++]=a+14,o[l++]=a+14,o[l++]=a+15,o[l++]=a+15,o[l++]=a+12,o[l++]=a+16,o[l++]=a+17,o[l++]=a+17,o[l++]=a+18,o[l++]=a+18,o[l++]=a+19,o[l++]=a+19,o[l++]=a+16,o[l++]=a+20,o[l++]=a+21,o[l++]=a+21,o[l++]=a+22,o[l++]=a+22,o[l++]=a+23,o[l++]=a+23,o[l++]=a+20},n.createSphereWireframe=function(i,t,e,r,a){n._shift.set(0,0,0),n.createCircleWireframe(i,0,n._shift,t,e,r,a),n.createCircleWireframe(i,1,n._shift,t,e+n.circleVertexCount,r,a+n.circleIndexCount),n.createCircleWireframe(i,2,n._shift,t,e+n.circleVertexCount*2,r,a+n.circleIndexCount*2)},n.createConeWireframe=function(i,t,e,r,a,o){n._shift.set(0,-t,0),n.createCircleWireframe(i,1,n._shift,e,r,a,o);var l=r+n.circleVertexCount,c=l;e[c++].set(0,0,0),e[c++].set(-i,-t,0),e[c++].set(i,-t,0),e[c++].set(0,-t,i),e[c++].set(0,-t,-i),o+=n.circleIndexCount,a[o++]=l,a[o++]=l+1,a[o++]=l,a[o++]=l+2,a[o++]=l,a[o++]=l+3,a[o++]=l,a[o++]=l+4},n.createUnboundCylinderWireframe=function(i,t,e,r,a){var o=5;n._shift.set(0,0,0),n.createCircleWireframe(i,1,n._shift,t,e,r,a);var l=e+n.circleVertexCount,c=l;a+=n.circleIndexCount;for(var _=0;_<8;_++){var u=k.degreeToRadian(45*_);t[c++].set(i*Math.cos(u),0,i*Math.sin(u)),t[c++].set(i*Math.cos(u),-o,i*Math.sin(u)),r[a+_*2]=l+2*_,r[a+_*2+1]=l+2*_+1}},n.createCapsuleWireframe=function(i,t,e,r,a,o){var l=n.circleIndexCount,c=n.circleVertexCount,_=t/2;n._shift.set(0,_,0),n.createCircleWireframe(i,1,n._shift,e,r,a,o),n._shift.set(0,-_,0),n.createCircleWireframe(i,1,n._shift,e,r+c,a,o+l),n.createEllipticWireframe(i,_,2,e,r+c*2,a,o+l*2),n.createEllipticWireframe(i,_,0,e,r+c*3,a,o+l*2+n.ellipticIndexCount)},n.createCircleWireframe=function(i,t,e,r,a,o,l){for(var c=n.circleVertexCount,_=Math.PI*2,u=1/c,d=a,h=0;h<c;++h){var f=h*u,v=f*_;switch(t){case 0:r[d++].set(e.x,i*Math.cos(v)+e.y,i*Math.sin(v)+e.z);break;case 1:r[d++].set(i*Math.cos(v)+e.x,e.y,i*Math.sin(v)+e.z);break;case 2:r[d++].set(i*Math.cos(v)+e.x,i*Math.sin(v)+e.y,e.z);break}var p=h+a;h<c-1?(o[l+2*h]=p,o[l+2*h+1]=p+1):(o[l+2*h]=p,o[l+2*h+1]=a)}},n.createEllipticWireframe=function(i,t,e,r,a,o,l){for(var c=n.circleVertexCount,_=Math.PI*2,u=1/c,d=a,h=0;h<c;++h){var f=h*u,v=f*_;switch(e){case 0:r[d++].set(0,i*Math.sin(v)+t,i*Math.cos(v));break;case 1:r[d++].set(i*Math.cos(v),t,i*Math.sin(v));break;case 2:r[d++].set(i*Math.cos(v),i*Math.sin(v)+t,0);break}h==c/2&&(t=-t);var p=h+a;h<c-1?(o[l+2*h]=p,o[l+2*h+1]=p+1):(o[l+2*h]=p,o[l+2*h+1]=a)}},n.createFrustumWireframe=function(i,t,e,r,a,o,l){n._shift.set(0,0,0),n.createCircleWireframe(i,2,n._shift,r,a,o,l),n._shift.set(0,0,-t);var c=k.degreeToRadian(e),_=Math.tan(c),u=i+_*t;n.createCircleWireframe(u,2,n._shift,r,a+n.circleVertexCount,o,l+n.circleIndexCount);var d=a+2*n.circleVertexCount,h=d;r[h++].set(0,0,0),r[h++].set(0,0,-t),r[h++].set(i,0,0),r[h++].set(u,0,-t),r[h++].set(-i,0,0),r[h++].set(-u,0,-t),r[h++].set(0,i,0),r[h++].set(0,u,-t),r[h++].set(0,-i,0),r[h++].set(0,-u,-t),l+=2*n.circleIndexCount,o[l++]=d,o[l++]=d+1,o[l++]=d+2,o[l++]=d+3,o[l++]=d+4,o[l++]=d+5,o[l++]=d+6,o[l++]=d+7,o[l++]=d+8,o[l++]=d+9},n.createHemisphereWireframe=function(i,t,e,r,a,o){for(var l=n.circleVertexCount/2,c=Math.PI,_=1/l,u=r,d=0;d<l+1;d++){var h=d*_,f=h*c;switch(t){case 0:e[u++].set(i*Math.sin(f),0,i*Math.cos(f));break;case 1:e[u++].set(0,i*Math.sin(f),i*Math.cos(f));break;case 2:e[u++].set(-i*Math.cos(f),0,-i*Math.sin(f));break}var v=d+r;d<l&&(a[o+2*d]=v,a[o+2*d+1]=v+1)}o+=n.circleVertexCount;for(var p=0;p<l+1;p++){var g=p*_,y=g*c;switch(t){case 0:e[u++].set(i*Math.sin(y),i*Math.cos(y),0);break;case 1:e[u++].set(i*Math.cos(y),i*Math.sin(y),0);break;case 2:e[u++].set(0,-i*Math.cos(y),-i*Math.sin(y));break}var m=p+r+l+1;p<l&&(a[o+2*p]=m,a[o+2*p+1]=m+1)}n._shift.set(0,0,0),n.createCircleWireframe(i,t,n._shift,e,r+n.circleVertexCount+2,a,o+n.circleVertexCount)},os(n,null,[{key:"cuboidIndexCount",get:function(){return 48}},{key:"cuboidPositionCount",get:function(){return 24}},{key:"sphereIndexCount",get:function(){return n.circleIndexCount*3}},{key:"spherePositionCount",get:function(){return n.circlePositionCount*3}},{key:"coneIndexCount",get:function(){return n.circleIndexCount+8}},{key:"conePositionCount",get:function(){return n.circlePositionCount+5}},{key:"unboundCylinderIndexCount",get:function(){return n.circleIndexCount+16}},{key:"unboundCylinderPositionCount",get:function(){return n.circlePositionCount+16}},{key:"capsuleIndexCount",get:function(){return(n.circleIndexCount+n.ellipticIndexCount)*2}},{key:"capsulePositionCount",get:function(){return(n.circlePositionCount+n.ellipticPositionCount)*2}},{key:"circleIndexCount",get:function(){return n.circleVertexCount*2}},{key:"circlePositionCount",get:function(){return n.circleVertexCount}},{key:"ellipticIndexCount",get:function(){return n.circleVertexCount*2}},{key:"ellipticPositionCount",get:function(){return n.circleVertexCount}},{key:"frustumIndexCount",get:function(){return n.circleIndexCount*2+10}},{key:"frustumPositionCount",get:function(){return n.circleVertexCount*2+10}},{key:"hemisphereIndexCount",get:function(){return n.circleVertexCount*2+n.circleIndexCount}},{key:"hemispherePositionCount",get:function(){return n.circleVertexCount+2+n.circlePositionCount}}]),n}();le._shift=new w;le.circleVertexCount=40;function Io(n,s){return Io=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},Io(n,s)}function Gc(n,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(s&&s.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),s&&Io(n,s)}function Hc(n,s,i,t){var e=arguments.length,r=e<3?s:t===null?t=Object.getOwnPropertyDescriptor(s,i):t,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(n,s,i,t);else for(var o=n.length-1;o>=0;o--)(a=n[o])&&(r=(e<3?a(r):e>3?a(s,i,r):a(s,i))||r);return e>3&&r&&Object.defineProperty(s,i,r),r}L.getByName("u_lightDir");L.getByName("u_planarHeight");L.getByName("u_planarShadowColor");L.getByName("u_planarShadowFalloff");var ef=new gt(`
    attribute vec4 POSITION;
    varying vec4 color;

    uniform vec3 u_lightDir;
    uniform float u_planarHeight;
    uniform vec4 u_planarShadowColor;
    uniform float u_planarShadowFalloff;

    uniform mat4 renderer_ModelMat;
    uniform mat4 camera_VPMat;

    #ifdef RENDERER_HAS_SKIN
      attribute vec4 JOINTS_0;
      attribute vec4 WEIGHTS_0;

      #ifdef RENDERER_USE_JOINT_TEXTURE
        uniform sampler2D renderer_JointSampler;
        uniform float renderer_JointCount;
        mat4 getJointMatrix(sampler2D smp, float index) {
            float base = index / renderer_JointCount;
            float hf = 0.5 / renderer_JointCount;
            float v = base + hf;

            vec4 m0 = texture2D(smp, vec2(0.125, v ));
            vec4 m1 = texture2D(smp, vec2(0.375, v ));
            vec4 m2 = texture2D(smp, vec2(0.625, v ));
            vec4 m3 = texture2D(smp, vec2(0.875, v ));

            return mat4(m0, m1, m2, m3);
        }
      #else
          uniform mat4 renderer_JointMatrix[ RENDERER_JOINTS_NUM ];
      #endif
    #endif

    vec3 ShadowProjectPos(vec4 vertPos) {
      vec3 shadowPos;

      // get the world space coordinates of the vertex
      vec3 worldPos = (renderer_ModelMat * vertPos).xyz;
      
      // world space coordinates of the shadow (the part below the ground is unchanged)
      shadowPos.y = min(worldPos.y , u_planarHeight);
      shadowPos.xz = worldPos.xz - u_lightDir.xz * max(0.0, worldPos.y - u_planarHeight) / u_lightDir.y;

      return shadowPos;
    }

    void main() {
     vec4 position = vec4(POSITION.xyz, 1.0 );
      #ifdef RENDERER_HAS_SKIN
          #ifdef RENDERER_USE_JOINT_TEXTURE
              mat4 skinMatrix =
                  WEIGHTS_0.x * getJointMatrix(renderer_JointSampler, JOINTS_0.x ) +
                  WEIGHTS_0.y * getJointMatrix(renderer_JointSampler, JOINTS_0.y ) +
                  WEIGHTS_0.z * getJointMatrix(renderer_JointSampler, JOINTS_0.z ) +
                  WEIGHTS_0.w * getJointMatrix(renderer_JointSampler, JOINTS_0.w );
          #else
              mat4 skinMatrix =
                  WEIGHTS_0.x * renderer_JointMatrix[ int( JOINTS_0.x ) ] +
                  WEIGHTS_0.y * renderer_JointMatrix[ int( JOINTS_0.y ) ] +
                  WEIGHTS_0.z * renderer_JointMatrix[ int( JOINTS_0.z ) ] +
                  WEIGHTS_0.w * renderer_JointMatrix[ int( JOINTS_0.w ) ];
          #endif
          position = skinMatrix * position;
      #endif

      // get the shadow's world space coordinates
      vec3 shadowPos = ShadowProjectPos(position);

      // convert to clip space
      gl_Position = camera_VPMat * vec4(shadowPos, 1.0);

      // get the world coordinates of the center point
      vec3 center = vec3(renderer_ModelMat[3].x, u_planarHeight, renderer_ModelMat[3].z);
      // calculate shadow falloff
      float falloff = 0.5 - clamp(distance(shadowPos , center) * u_planarShadowFalloff, 0.0, 1.0);

      // shadow color
      color = u_planarShadowColor;
      color.a *= falloff;
    }
    `,`
    varying vec4 color;
    void main() {
       gl_FragColor = color;
    }
    `);ne.create("planarShadowShader",[ne.find("pbr").subShaders[0].passes[0],ef]);function ql(n,s){for(var i=0;i<s.length;i++){var t=s[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function tf(n,s,i){return s&&ql(n.prototype,s),i&&ql(n,i),n}function Fo(n,s){return Fo=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},Fo(n,s)}function rf(n,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(s&&s.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),s&&Fo(n,s)}L.getByName("u_far");L.getByName("u_near");L.getByName("u_primaryScale");L.getByName("u_secondaryScale");L.getByName("u_gridIntensity");L.getByName("u_axisIntensity");L.getByName("u_flipProgress");L.getByName("u_fade");ne.create("grid",`
#include <common>
#include <common_vert>
uniform mat4 camera_ViewInvMat;

varying vec3 nearPoint;
varying vec3 farPoint;

vec3 UnprojectPoint(float x, float y, float z, mat4 viewInvMat, mat4 projInvMat) {
    vec4 unprojectedPoint =  viewInvMat * projInvMat * vec4(x, y, z, 1.0);
    return unprojectedPoint.xyz / unprojectedPoint.w;
}

void main() {
    float tol = 0.0001;
    mat4 viewInvMat = camera_ViewInvMat;
    if (abs(viewInvMat[3][1]) < tol) {
        viewInvMat[3][1] = tol;
    }
    mat4 projInvMat = INVERSE_MAT(camera_ProjMat);

    nearPoint = UnprojectPoint(POSITION.x, POSITION.y, -1.0, viewInvMat, projInvMat);// unprojecting on the near plane
    farPoint = UnprojectPoint(POSITION.x, POSITION.y, 1.0, viewInvMat, projInvMat);// unprojecting on the far plane
    gl_Position = vec4(POSITION, 1.0);// using directly the clipped coordinates
}`,`
#include <transform_declare>

uniform float u_far;
uniform float u_near;
uniform float u_primaryScale;
uniform float u_secondaryScale;
uniform float u_gridIntensity;
uniform float u_axisIntensity;
uniform float u_flipProgress;
uniform float u_fade;

varying vec3 nearPoint;
varying vec3 farPoint;
  
vec4 grid(vec3 fragPos3D, float scale, float fade) {
    vec2 coord = mix(fragPos3D.xz, fragPos3D.xy, u_flipProgress) * scale;
    vec2 derivative = fwidth(coord);
    vec2 grid = abs(fract(coord - 0.5) - 0.5) / derivative;
    float line = min(grid.x, grid.y);
    float minimumz = min(derivative.y, 1.0);
    float minimumx = min(derivative.x, 1.0);
    vec4 color = vec4(u_gridIntensity, u_gridIntensity, u_gridIntensity, fade * (1.0 - min(line, 1.0)));
    // z-axis
    if (fragPos3D.x > -u_axisIntensity * minimumx && fragPos3D.x < u_axisIntensity * minimumx)
        color.z = 1.0;
    // x-axis or y-axis
    float xy = mix(fragPos3D.z, fragPos3D.y, u_flipProgress);
    if (xy > -u_axisIntensity * minimumz && xy < u_axisIntensity * minimumz)
        color.x = 1.0;
    return color;
}

float computeDepth(vec3 pos) {
    vec4 clip_space_pos = camera_ProjMat * camera_ViewMat * vec4(pos.xyz, 1.0);
    // map to 0-1
    return (clip_space_pos.z / clip_space_pos.w) * 0.5 + 0.5;
}

float computeLinearDepth(vec3 pos) {
    vec4 clip_space_pos = camera_ProjMat * camera_ViewMat * vec4(pos.xyz, 1.0);
    float clip_space_depth = clip_space_pos.z / clip_space_pos.w;
    float linearDepth = (2.0 * u_near * u_far) / (u_far + u_near - clip_space_depth * (u_far - u_near));
    return linearDepth / u_far;// normalize
}

void main() {
    float ty = -nearPoint.y / (farPoint.y - nearPoint.y);
    float tz = -nearPoint.z / (farPoint.z - nearPoint.z);
    float t = mix(ty, tz, u_flipProgress);
    vec3 fragPos3D = nearPoint + t * (farPoint - nearPoint);

    gl_FragDepth = computeDepth(fragPos3D);

    float linearDepth = computeLinearDepth(fragPos3D);
    float fading = max(0.0, (0.5 - linearDepth));

    // adding multiple resolution for the grid
    gl_FragColor = (grid(fragPos3D, u_primaryScale, u_fade) + grid(fragPos3D, u_secondaryScale, 1.0 - u_fade));
    gl_FragColor.a *= fading;
}
`);var nf=`
  attribute vec3 POSITION;
  attribute vec2 TEXCOORD_0;
  attribute vec4 COLOR_0;
  uniform mat4 renderer_MVPMat;
  
  uniform float u_time;
  uniform vec2 u_foam_speed; 
  uniform vec2 u_distorsion_speed; 
  varying vec2 waterTexCoords;
  varying vec2 normalTexCoords;
  varying vec4 v_color;
      
  void main() {
    gl_Position = renderer_MVPMat * vec4(POSITION, 1.0);
    waterTexCoords = TEXCOORD_0 + vec2(u_foam_speed.x * u_time, u_foam_speed.y * u_time);
    normalTexCoords = TEXCOORD_0 + vec2(u_distorsion_speed.x * cos(u_time), u_distorsion_speed.y * sin(u_time));
    v_color = COLOR_0; 
  }
  `,af=`
  #include <common>
  varying vec4 v_color;
  varying vec2 waterTexCoords;
  varying vec2 normalTexCoords;
  uniform sampler2D material_NormalTexture;
  uniform sampler2D u_foamTex;
  uniform vec3 u_foamColor;
  uniform vec2 u_foam_param;
  uniform float u_distorsion_amount;
  void main() {  
    vec4 normalTex = texture2D(material_NormalTexture, normalTexCoords) * 2.0 - 1.0;
    vec4 waterTex = texture2D(u_foamTex, waterTexCoords + (normalTex.rg * u_distorsion_amount));
    float alphaComp = v_color.r * waterTex.r * u_foam_param.x;
    float alpha = pow(alphaComp,2.0);
    alpha = smoothstep(0.5 - u_foam_param.y, 0.5+ u_foam_param.y, alpha);
    alpha = saturate(alpha);
    
    gl_FragColor = vec4(u_foamColor.rgb, alpha);
  }
  `;ne.create("water-ripple",nf,af);L.getByName("u_foamColor");L.getByName("u_foam_speed");L.getByName("u_foam_param");L.getByName("u_distorsion_speed");L.getByName("u_distorsion_amount");L.getByName("u_foamTex");var of=`
    attribute vec3 POSITION;
    attribute vec2 TEXCOORD_0;
    attribute vec4 COLOR_0;

    uniform mat4 renderer_MVPMat;
    
    uniform float u_time;
    uniform vec2 u_water_speed; 
    uniform vec2 u_distorsion_speed; 
    
    varying vec4 v_color;
    varying vec2 waterTexCoords;
    varying vec2 normalTexCoords;
  
    void main() {
      gl_Position = renderer_MVPMat * vec4(POSITION, 1.0);
  
      waterTexCoords = TEXCOORD_0 + vec2(u_water_speed.x * sin(u_time), u_water_speed.y * cos(u_time));
      normalTexCoords = TEXCOORD_0 + vec2(u_distorsion_speed.x * cos(u_time), u_distorsion_speed.y * sin(u_time));     
      
      v_color = COLOR_0;
    }
    `,sf=`
    #include <common>
    varying vec4 v_color;
    varying vec2 waterTexCoords;
    varying vec2 normalTexCoords;
  
    uniform sampler2D material_NormalTexture;
    uniform sampler2D u_waterTex;
    uniform sampler2D u_edgeTex;
  
    uniform vec4 u_edgeColor;
    uniform vec2 u_edgeParam;
    uniform float u_distorsion_amount;
  
    void main() {
      vec4 normalTex = texture2D(material_NormalTexture, normalTexCoords) * 2.0 - 1.0;
      vec4 waterTex = texture2D(u_waterTex, waterTexCoords + (normalTex.rg * u_distorsion_amount));
      vec4 edgeTex = texture2D(u_edgeTex, waterTexCoords + (normalTex.rg * u_distorsion_amount));
  
      float edge = pow((v_color.r + edgeTex.r) * v_color.r, 2.0);
      edge = saturate(1.0 - smoothstep(u_edgeParam.x - u_edgeParam.y, u_edgeParam.x + u_edgeParam.y, edge));
      vec4 finalCol = mix(waterTex, u_edgeColor, edge);
  
      gl_FragColor = finalCol;
    }
    `;ne.create("water",of,sf);L.getByName("u_water_speed");L.getByName("u_edgeColor");L.getByName("u_edgeParam");L.getByName("u_distorsion_amount");L.getByName("u_distorsion_speed");L.getByName("u_waterTex");L.getByName("u_edgeTex");var lf=`
    attribute vec3 POSITION;
    attribute vec2 TEXCOORD_0;
    attribute vec4 COLOR_0;
  
    uniform mat4 renderer_MVPMat;
    
    uniform float u_time;
    uniform vec2 u_water_speed; 
    uniform vec2 u_waterfall_speed; 
    uniform vec2 u_distorsion_speed; 
  
    varying vec2 waterTexCoords;
    varying vec2 waterfallTexCoords;
    varying vec2 normalTexCoords;
    varying vec4 v_color;

    void main() {
      gl_Position = renderer_MVPMat * vec4(POSITION, 1.0);
  
      waterTexCoords = TEXCOORD_0 + vec2(u_water_speed.x * u_time, u_water_speed.y * u_time);
      waterfallTexCoords = TEXCOORD_0 + vec2(u_waterfall_speed.x * u_time, u_waterfall_speed.y * u_time);
      normalTexCoords = TEXCOORD_0 + vec2(u_distorsion_speed.x * cos(u_time), u_distorsion_speed.y * sin(u_time));    
      
      v_color = COLOR_0; 
    }
    `,cf=`
    #include <common>
    varying vec4 v_color;
    varying vec2 waterTexCoords;
    varying vec2 waterfallTexCoords;
    varying vec2 normalTexCoords;
  
    uniform sampler2D material_NormalTexture;
    uniform sampler2D u_waterTex;
    uniform sampler2D u_waterfallTex;
    uniform sampler2D u_edgeNoiseTex;
  
    uniform vec4 u_edgeColor;
    uniform vec2 u_edgeParam;
    uniform float u_distorsion_amount;
  
    void main() {      
      vec4 normalTex = texture2D(material_NormalTexture, normalTexCoords) * 2.0 - 1.0;
      
      vec4 waterTex = texture2D(u_waterTex, waterTexCoords + (normalTex.rg * u_distorsion_amount));
      vec4 waterfallTex = texture2D(u_waterfallTex, waterfallTexCoords + (normalTex.rg * u_distorsion_amount));
  
      vec4 streamEdge = texture2D(u_edgeNoiseTex, waterTexCoords);
      vec4 fallEdge = texture2D(u_edgeNoiseTex, waterfallTexCoords);
  
      float edgeShape = mix(fallEdge.r, streamEdge.r, v_color.r);
      edgeShape = saturate(edgeShape * v_color.g);
      edgeShape = saturate(smoothstep(u_edgeParam.x - u_edgeParam.y, u_edgeParam.x + u_edgeParam.y, edgeShape));
  
      vec4 waterAll = mix(waterfallTex, waterTex, v_color.r);
      vec4 finalCol = mix(waterAll, u_edgeColor, edgeShape);
  
      gl_FragColor = finalCol;
    }
    `;ne.create("water-fall",lf,cf);L.getByName("u_water_speed");L.getByName("u_waterfall_speed");L.getByName("u_distorsion_speed");L.getByName("u_edgeColor");L.getByName("u_edgeParam");L.getByName("u_distorsion_amount");L.getByName("u_waterTex");L.getByName("u_waterfallTex");L.getByName("u_edgeNoiseTex");var _f=`
#define IS_METALLIC_WORKFLOW
#include <common>
#include <camera_declare>

#include <FogFragmentDeclaration>

#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>

#include <light_frag_define>
#include <pbr_frag_define>
#include <pbr_helper>

#ifdef LIGHTMAP_TEXTURE
    uniform sampler2D u_lightMapTexture;
    uniform float u_lightMapIntensity;
#endif


void main() {
    Geometry geometry;
    Material material;
    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
    
    initGeometry(geometry, gl_FrontFacing);
    initMaterial(material, geometry);
    
    addTotalDirectRadiance(geometry, material, reflectedLight);
    
    
    // IBL diffuse
    #ifdef LIGHTMAP_TEXTURE
        vec2 lightMapUV = v_uv;
        #ifdef RENDERER_HAS_UV1
            lightMapUV = v_uv1;
        #endif
        reflectedLight.indirectDiffuse += texture2D(u_lightMapTexture, lightMapUV).rgb * u_lightMapIntensity * BRDF_Diffuse_Lambert( material.diffuseColor );
    #endif
    
    // IBL specular
    vec3 radiance = getLightProbeRadiance(geometry, geometry.normal, material.roughness, int(scene_EnvMapLight.mipMapLevel), scene_EnvMapLight.specularIntensity);
    float radianceAttenuation = 1.0;
    
    #ifdef MATERIAL_CLEARCOAT
        vec3 clearCoatRadiance = getLightProbeRadiance( geometry, geometry.clearCoatNormal, material.clearCoatRoughness, int(scene_EnvMapLight.mipMapLevel), scene_EnvMapLight.specularIntensity );
    
        reflectedLight.indirectSpecular += clearCoatRadiance * material.clearCoat * envBRDFApprox(vec3( 0.04 ), material.clearCoatRoughness, geometry.clearCoatDotNV);
        radianceAttenuation -= material.clearCoat * F_Schlick(geometry.clearCoatDotNV);
    #endif
    
    reflectedLight.indirectSpecular += radianceAttenuation * radiance * envBRDFApprox(material.specularColor, material.roughness, geometry.dotNV );
    
    
    // Occlusion
    #ifdef MATERIAL_OCCLUSIONTEXTURE
        vec2 aoUV = v_uv;
        #ifdef RENDERER_HAS_UV1
            if(material_OcclusionTextureCoord == 1.0){
                aoUV = v_uv1;
            }
        #endif
        float ambientOcclusion = (texture2D(material_OcclusionTexture, aoUV).r - 1.0) * material_OcclusionIntensity + 1.0;
        reflectedLight.indirectDiffuse *= ambientOcclusion;
        #ifdef SCENE_USE_SPECULAR_ENV
            reflectedLight.indirectSpecular *= computeSpecularOcclusion(ambientOcclusion, material.roughness, geometry.dotNV);
        #endif
    #endif
        
        
    // Emissive
    vec3 emissiveRadiance = material_EmissiveColor;
    #ifdef MATERIAL_HAS_EMISSIVETEXTURE
        vec4 emissiveColor = texture2D(material_EmissiveTexture, v_uv);
        #ifndef ENGINE_IS_COLORSPACE_GAMMA
            emissiveColor = gammaToLinear(emissiveColor);
        #endif
        emissiveRadiance *= emissiveColor.rgb;
    #endif
        
    // Total
    vec3 totalRadiance =    reflectedLight.directDiffuse + 
                            reflectedLight.indirectDiffuse + 
                            reflectedLight.directSpecular + 
                            reflectedLight.indirectSpecular + 
                            emissiveRadiance;
                            
        
    gl_FragColor = vec4(totalRadiance, material.opacity);
        
    #include <FogFragment>
        
    #ifndef ENGINE_IS_COLORSPACE_GAMMA
        gl_FragColor = linearToGamma(gl_FragColor);
    #endif

}
`,uf=`
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <color_share>
#include <normal_share>
#include <worldpos_share>

#include <ShadowVertexDeclaration>
#include <FogVertexDeclaration>

void main() {

    #include <begin_position_vert>
    #include <begin_normal_vert>
    #include <blendShape_vert>
    #include <skinning_vert>
    #include <uv_vert>
    #include <color_vert>
    #include <normal_vert>
    #include <worldpos_vert>
    #include <position_vert>

    #include <ShadowVertex>
    #include <FogVertex>
}
`;ne.create("bake-pbr",uf,_f);L.getByName("u_lightMapTexture");L.getByName("u_lightMapIntensity");var Wc=function(n){rf(s,n);function s(t){var e;e=n.call(this,t,ne.find("plain-color"))||this;var r=e.shaderData;return r.enableMacro("MATERIAL_OMIT_NORMAL"),r.setColor(s._baseColorProp,new j(1,1,1,1)),e.renderState.rasterState.cullMode=Xt.Off,e}var i=s.prototype;return i.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},tf(s,[{key:"baseColor",get:function(){return this.shaderData.getColor(s._baseColorProp)},set:function(e){var r=this.shaderData.getColor(s._baseColorProp);e!==r&&r.copyFrom(e)}}]),s}(ke);ne.create("plain-color",`
#include <common>
#include <common_vert>
#include <blendShape_input>

void main() {
    #include <begin_position_vert>
    #include <blendShape_vert>
    #include <skinning_vert>
    #include <position_vert>
}
`,`
#include <common>

uniform vec4 material_BaseColor;

void main() {
     vec4 baseColor = material_BaseColor;

    #ifdef MATERIAL_IS_ALPHA_CUTOFF
        if( baseColor.a < material_AlphaCutoff ) {
            discard;
        }
    #endif

    gl_FragColor = baseColor;

     #ifndef ENGINE_IS_COLORSPACE_GAMMA
        gl_FragColor = linearToGamma(gl_FragColor);
    #endif
}
`);function fo(n,s){return s!=null&&typeof Symbol<"u"&&s[Symbol.hasInstance]?!!s[Symbol.hasInstance](n):n instanceof s}var Sn=function(n){Gc(s,n);function s(){var t;return t=n.apply(this,arguments)||this,t._cameraPositions=[new w,new w,new w,new w,new w,new w,new w,new w],t._localPositions=[],t._globalPositions=[],t._indices=null,t._indicesCount=0,t._boundsIndicesCount=0,t._wireframeRenderers=[],t._wireframeElements=[],t}var i=s.prototype;return i.clear=function(){this._wireframeRenderers.length=0,this._wireframeElements.length=0,this._localPositions.length=0,this._globalPositions.length=0,this._indicesCount=0,this._mesh.subMesh.count=0},i.addEntityWireframe=function(e,r){if(r===void 0&&(r=!0),r){var a=new Array;e.getComponentsIncludeChildren(Ne,a);for(var o=0,l=a.length;o<l;o++)this.addCameraWireframe(a[o]);var c=a.length;e.getComponentsIncludeChildren(vr,a);for(var _=c,u=a.length;_<u;_++)this.addSpotLightWireframe(a[_]);c=a.length,e.getComponentsIncludeChildren(bn,a);for(var d=c,h=a.length;d<h;d++)this.addDirectLightWireframe(a[d]);c=a.length,e.getComponentsIncludeChildren(Cn,a);for(var f=c,v=a.length;f<v;f++)this.addPointLightWireframe(a[f]);c=a.length,e.getComponentsIncludeChildren(Ft,a);for(var p=c,g=a.length;p<g;p++)this.addCollideWireframe(a[p]);c=a.length,e.getComponentsIncludeChildren(Ot,a);for(var y=c,m=a.length;y<m;y++)this.addParticleRendererEmissionShapeWireframe(a[y])}else{var x=e.getComponent(Ne);x&&this.addCameraWireframe(x);var S=e.getComponent(vr);S&&this.addSpotLightWireframe(S);var b=e.getComponent(bn);b&&this.addDirectLightWireframe(b);var A=e.getComponent(Cn);A&&this.addPointLightWireframe(A);var C=e.getComponent(Ft);C&&this.addCollideWireframe(C);var E=e.getComponent(Ot);E&&this.addParticleRendererEmissionShapeWireframe(E)}},i.addCameraWireframe=function(e){var r=e.entity.transform,a=e.projectionMatrix.clone();a.invert();var o=this._localPositions,l=o.length;this._wireframeElements.push(new xr(r,l));for(var c=s._ndcPosition,_=0;_<4;_++){var u=this._cameraPositions[_];u.copyFrom(c[_]),u.transformCoordinate(a),o.push(u)}for(var d=0;d<4;d++){var h=this._cameraPositions[d+4];h.copyFrom(c[d]),h.z=1,h.transformCoordinate(a),o.push(h)}this._growthIndexMemory(24);var f=this._indices;f[this._indicesCount++]=l,f[this._indicesCount++]=l+1,f[this._indicesCount++]=l+1,f[this._indicesCount++]=l+2,f[this._indicesCount++]=l+2,f[this._indicesCount++]=l+3,f[this._indicesCount++]=l+3,f[this._indicesCount++]=l,f[this._indicesCount++]=l,f[this._indicesCount++]=l+4,f[this._indicesCount++]=l+1,f[this._indicesCount++]=l+5,f[this._indicesCount++]=l+2,f[this._indicesCount++]=l+6,f[this._indicesCount++]=l+3,f[this._indicesCount++]=l+7,f[this._indicesCount++]=l+4,f[this._indicesCount++]=l+5,f[this._indicesCount++]=l+5,f[this._indicesCount++]=l+6,f[this._indicesCount++]=l+6,f[this._indicesCount++]=l+7,f[this._indicesCount++]=l+7,f[this._indicesCount++]=l+4},i.addSpotLightWireframe=function(e){var r=e.distance,a=Math.tan(e.angle/2)*r,o=this._localPositions.length,l=le.coneIndexCount;this._growthIndexMemory(l),this._growthPosition(le.conePositionCount);var c=this,_=c._indices,u=c._localPositions;le.createConeWireframe(a,r,u,o,_,this._indicesCount),this._indicesCount+=l,this._rotateAroundX(o),this._wireframeElements.push(new xr(e.entity.transform,o))},i.addPointLightWireframe=function(e){var r=this._localPositions.length,a=le.sphereIndexCount;this._growthIndexMemory(a),this._growthPosition(le.spherePositionCount);var o=this,l=o._indices,c=o._localPositions;le.createSphereWireframe(e.distance,c,r,l,this._indicesCount),this._indicesCount+=a,this._wireframeElements.push(new xr(e.entity.transform,r))},i.addDirectLightWireframe=function(e){var r=this._localPositions.length,a=le.unboundCylinderIndexCount;this._growthIndexMemory(a),this._growthPosition(le.unboundCylinderPositionCount);var o=this,l=o._indices,c=o._localPositions;le.createUnboundCylinderWireframe(1,c,r,l,this._indicesCount),this._indicesCount+=a,this._rotateAroundX(r),this._wireframeElements.push(new xr(e.entity.transform,r))},i.addRendererWireframe=function(e){this._boundsIndicesCount+=le.cuboidIndexCount,this._wireframeRenderers.push(e)},i.addCollideWireframe=function(e){for(var r=e.shapes,a=0,o=r.length;a<o;a++){var l=r[a];fo(l,qo)?this.addBoxColliderShapeWireframe(l):fo(l,Yo)?this.addSphereColliderShapeWireframe(l):fo(l,Ja)&&this.addCapsuleColliderShapeWireframe(l)}},i.addBoxColliderShapeWireframe=function(e){var r=e.collider.entity.transform,a=r.lossyWorldScale,o=e.position,l=e.rotation,c=e.size,_=s._tempVector,u=s._tempRotation,d=this._localPositions.length,h=le.cuboidIndexCount;this._growthIndexMemory(h),this._growthPosition(le.cuboidPositionCount);var f=this,v=f._indices,p=f._localPositions;le.createCuboidWireframe(a.x*c.x,a.y*c.y,a.z*c.z,p,d,v,this._indicesCount),ye.rotationYawPitchRoll(l.x,l.y,l.z,u),this._localRotation(d,u),w.multiply(o,a,_),this._localTranslate(d,_),this._indicesCount+=h,this._wireframeElements.push(new xr(r,d))},i.addSphereColliderShapeWireframe=function(e){var r=e.collider.entity.transform,a=r.lossyWorldScale,o=e.position,l=e.rotation,c=e.radius,_=s._tempVector,u=s._tempRotation,d=this._localPositions.length,h=le.sphereIndexCount;this._growthIndexMemory(h),this._growthPosition(le.spherePositionCount);var f=this,v=f._indices,p=f._localPositions;le.createSphereWireframe(Math.max(a.x,a.y,a.z)*c,p,d,v,this._indicesCount),ye.rotationYawPitchRoll(l.x,l.y,l.z,u),this._localRotation(d,u),w.multiply(o,a,_),this._localTranslate(d,_),this._indicesCount+=h,this._wireframeElements.push(new xr(r,d))},i.addCapsuleColliderShapeWireframe=function(e){var r=e.collider.entity.transform,a=r.lossyWorldScale,o=Math.max(a.x,a.y,a.z),l=e.radius,c=e.height,_=e.upAxis,u=e.position,d=e.rotation,h=s._tempVector,f=s._tempRotation,v=s._tempAxis,p=s._halfSqrt,g=this._localPositions.length,y=le.capsuleIndexCount;this._growthIndexMemory(y),this._growthPosition(le.capsulePositionCount);var m=this,x=m._indices,S=m._localPositions;switch(le.createCapsuleWireframe(o*l,o*c,S,g,x,this._indicesCount),_){case Kn.X:v.set(0,0,p,p);break;case Kn.Y:v.set(0,0,0,1);break;case Kn.Z:v.set(p,0,0,p)}ye.rotationYawPitchRoll(d.x,d.y,d.z,f),ye.multiply(f,v,f),this._localRotation(g,f),w.multiply(u,a,h),this._localTranslate(g,h),this._indicesCount+=y,this._wireframeElements.push(new xr(r,g))},i.addParticleRendererEmissionShapeWireframe=function(e){if(e.generator.emission.enabled){var r=e.generator.emission.shape,a=e.entity.transform;switch(r?.shapeType){case 0:this.addBoxParticleShapeWireframe(r,a);break;case 1:this.addCircleParticleShapeWireframe(r,a);break;case 2:this.addConeParticleShapeWireframe(r,a);break;case 3:this.addHemisphereParticleShapeWireframe(r,a);break;case 4:this.addSphereParticleShapeWireframe(r,a);break}}},i.addBoxParticleShapeWireframe=function(e,r){var a=e.size,o=this._localPositions.length,l=le.cuboidIndexCount;this._growthIndexMemory(l),this._growthPosition(le.cuboidPositionCount);var c=this,_=c._indices,u=c._localPositions;le.createCuboidWireframe(a.x,a.y,a.z,u,o,_,this._indicesCount),this._indicesCount+=l,this._wireframeElements.push(new xr(r,o,!1))},i.addCircleParticleShapeWireframe=function(e,r){var a=e.radius,o=this._localPositions.length,l=le.circleIndexCount;this._growthIndexMemory(l),this._growthPosition(le.circlePositionCount);var c=this,_=c._indices,u=c._localPositions;le.createCircleWireframe(a,0,new w,u,o,_,this._indicesCount),this._indicesCount+=l,this._wireframeElements.push(new xr(r,o,!1))},i.addConeParticleShapeWireframe=function(e,r){var a=e.radius,o=e.length,l=e.angle,c=this._localPositions.length,_=le.frustumIndexCount;this._growthIndexMemory(_),this._growthPosition(le.frustumPositionCount);var u=this,d=u._indices,h=u._localPositions;le.createFrustumWireframe(a,o,l,h,c,d,this._indicesCount),this._indicesCount+=_,this._wireframeElements.push(new xr(r,c,!1))},i.addHemisphereParticleShapeWireframe=function(e,r){var a=e.radius,o=this._localPositions.length,l=le.hemisphereIndexCount;this._growthIndexMemory(l),this._growthPosition(le.hemispherePositionCount);var c=this,_=c._indices,u=c._localPositions;le.createHemisphereWireframe(a,2,u,o,_,this._indicesCount),this._indicesCount+=l,this._wireframeElements.push(new xr(r,o,!1))},i.addSphereParticleShapeWireframe=function(e,r){var a=e.radius,o=this._localPositions.length,l=le.sphereIndexCount;this._growthIndexMemory(l),this._growthPosition(le.spherePositionCount);var c=this,_=c._indices,u=c._localPositions;le.createSphereWireframe(a,u,o,_,this._indicesCount),this._indicesCount+=l,this._wireframeElements.push(new xr(r,o,!1))},i.onAwake=function(){var e=this.engine,r=new ct(e),a=new Wc(e),o=this.entity.getComponent(Rt);o.castShadows=!1,o.receiveShadows=!1;var l=e._hardwareRenderer.canIUse(Q.elementIndexUint);r.addSubMesh(0,this._indicesCount,kr.Lines),o.mesh=r,o.setMaterial(a);var c=r.bounds;c.min.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),c.max.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._mesh=r,this._material=a,this._renderer=o,this._indices=l?new Uint32Array(128):new Uint16Array(128),this._supportUint32Array=l},i.onEnable=function(){this._renderer.enabled=!0},i.onDisable=function(){this._renderer.enabled=!1},i.onLateUpdate=function(e){var r=this,a=r._mesh,o=r._localPositions,l=r._globalPositions,c=r._wireframeElements,_=r._wireframeRenderers,u=r._indices,d=o.length;l.length=d;for(var h=0,f=!1,v=0,p=c.length;v<p;v++){var g=c[v],y=g.transformRanges,m=v<p-1?c[v+1].transformRanges:d;if(g.updateFlag.flag){var x=g.transform,S=s._tempMatrix;g.isScaleIgnored?J.rotationTranslation(x.worldRotationQuaternion,x.worldPosition,S):S.copyFrom(x.worldMatrix);for(var b=y;b<m;b++){var A=o[h],C=s._getPositionFromPool(h);w.transformCoordinate(A,S,C),l[h]=C,h++}g.updateFlag.flag=!1,f=!0}else h+=m-y}this._growthIndexMemory(this._boundsIndicesCount);for(var E=this._indicesCount,T=0;T<_.length;T++){var B=_[T],M=B.bounds,P=s._tempVector;M.getExtent(P);var V=l.length;le.createCuboidWireframe(P.x*2,P.y*2,P.z*2,l,V,u,E),M.getCenter(P);for(var N=V;N<l.length;N++){var F=l[N];F.add(P)}E+=le.cuboidIndexCount}(_.length>0||f)&&(a.setPositions(l),a.setIndices(this._indices),a.uploadData(!1),a.subMesh.count=E),E===0?this._renderer.setMaterial(null):this._renderer.setMaterial(this._material)},i._growthIndexMemory=function(e){var r=this._indices,a=this._indicesCount+e;if(a>r.length){var o=this._supportUint32Array?4294967295:65535;if(a>o)throw Error("The vertex count is over limit.");var l=this._supportUint32Array?new Uint32Array(a):new Uint16Array(a);l.set(r),this._indices=l}},i._growthPosition=function(e){for(var r=this._localPositions,a=0;a<e;a++)r.push(new w)},i._localTranslate=function(e,r){for(var a=this._localPositions,o=e;o<a.length;o++){var l=a[o];l.add(r)}},i._localRotation=function(e,r){for(var a=this._localPositions,o=e;o<a.length;o++){var l=a[o];w.transformByQuat(l,r,l)}},i._rotateAroundX=function(e){for(var r=this._localPositions,a=e;a<r.length;a++){var o=r[a],l=o.y,c=o.z;o.z=l,o.y=-c}},s._getPositionFromPool=function(e){var r,a=s._positionPool;return e<a.length?r=a[e]:(r=new w,s._positionPool.push(r)),r},os(s,[{key:"baseColor",get:function(){return this._material.baseColor},set:function(e){this._material.baseColor=e}}]),s}(Jt);Sn._positionPool=[];Sn._ndcPosition=[new w(-1,1,-1),new w(1,1,-1),new w(1,-1,-1),new w(-1,-1,-1)];Sn._tempMatrix=new J;Sn._tempVector=new w;Sn._tempRotation=new ye;Sn._tempAxis=new ye;Sn._halfSqrt=.70710678118655;Sn=Hc([An(Rt,Ur.CheckOnly)],Sn);var xr=function(s,i,t){t===void 0&&(t=!0),this.transform=s,this.transformRanges=i,this.isScaleIgnored=t,this.updateFlag=s.registerWorldChangeFlag()},Aa=function(n){Gc(s,n);function s(){return n.apply(this,arguments)}var i=s.prototype;return i.onAwake=function(){var e=this.engine,r=new ct(e),a=new Wc(e),o=this.entity.getComponent(Rt);o.castShadows=!1,o.receiveShadows=!1;var l=e._hardwareRenderer.canIUse(Q.elementIndexUint);r._enableVAO=!1,r.addSubMesh(0,s._indicesCount,kr.Lines),o.mesh=r,o.setMaterial(a);var c=r.bounds;c.min.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),c.max.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._mesh=r,this._material=a,this._renderer=o,s._indices=l?new Uint32Array(128):new Uint16Array(128),s._supportUint32Array=l},i.onLateUpdate=function(e){var r=this,a=r._mesh;s._positionCount>0?(a.setPositions(s._positions),a.setIndices(s._indices),a.uploadData(!1),a.subMesh.count=s._indicesCount,this._renderer.setMaterial(this._material)):this._renderer.setMaterial(null),s.flush()},s.drawLine=function(e,r){s._growthPosition(2),s._growthIndexMemory(2),s._indices[s._indicesCount++]=s._positionCount,s._indices[s._indicesCount++]=s._positionCount+1,s.matrix==null?(s._positions[s._positionCount++].copyFrom(e),s._positions[s._positionCount++].copyFrom(r)):(w.transformCoordinate(e,s.matrix,s._positions[s._positionCount++]),w.transformCoordinate(r,s.matrix,s._positions[s._positionCount++]))},s.drawRect=function(e,r,a,o){s._growthPosition(4),s._growthIndexMemory(8),s._indices[s._indicesCount++]=s._positionCount,s._indices[s._indicesCount++]=s._positionCount+1,s._indices[s._indicesCount++]=s._positionCount+2,s._indices[s._indicesCount++]=s._positionCount+1,s._indices[s._indicesCount++]=s._positionCount+2,s._indices[s._indicesCount++]=s._positionCount+3,s._indices[s._indicesCount++]=s._positionCount,s._indices[s._indicesCount++]=s._positionCount+3,s.matrix==null?(s._positions[s._positionCount++].copyFrom(e),s._positions[s._positionCount++].copyFrom(r),s._positions[s._positionCount++].copyFrom(a),s._positions[s._positionCount++].copyFrom(o)):(w.transformCoordinate(e,s.matrix,s._positions[s._positionCount++]),w.transformCoordinate(r,s.matrix,s._positions[s._positionCount++]),w.transformCoordinate(a,s.matrix,s._positions[s._positionCount++]),w.transformCoordinate(o,s.matrix,s._positions[s._positionCount++]))},s.drawSphere=function(e,r){var a=le.spherePositionCount,o=le.sphereIndexCount,l=s._positions;s._growthPosition(a),s._growthIndexMemory(o),le.createSphereWireframe(e,l,s._positionCount,s._indices,s._indicesCount);for(var c=0;c<a;c++){var _=l[s._positionCount+c];_.add(r),s.matrix!=null&&w.transformCoordinate(_,s.matrix,_)}s._positionCount+=a,s._indicesCount+=o},s.drawCuboid=function(e,r,a,o){var l=le.cuboidPositionCount,c=le.cuboidIndexCount,_=s._positions;s._growthPosition(l),s._growthIndexMemory(c),le.createCuboidWireframe(e,r,a,_,s._positionCount,s._indices,s._indicesCount);for(var u=0;u<l;u++){var d=_[s._positionCount+u];d.add(o),s.matrix!=null&&w.transformCoordinate(d,s.matrix,d)}s._positionCount+=l,s._indicesCount+=c},s.drawCapsule=function(e,r,a){var o=le.capsulePositionCount,l=le.capsuleIndexCount,c=s._positions;s._growthPosition(o),s._growthIndexMemory(l),le.createCapsuleWireframe(e,r,c,s._positionCount,s._indices,s._indicesCount);for(var _=0;_<o;_++){var u=c[s._positionCount+_];u.add(a),s.matrix!=null&&w.transformCoordinate(u,s.matrix,u)}s._positionCount+=o,s._indicesCount+=l},s.drawCircle=function(e,r,a){le._shift.set(0,0,0);var o=le.circlePositionCount,l=le.circleIndexCount,c=s._positions;s._growthPosition(o),s._growthIndexMemory(l),le.createCircleWireframe(e,r,le._shift,c,s._positionCount,s._indices,s._indicesCount);for(var _=0;_<o;_++){var u=c[s._positionCount+_];u.add(a),s.matrix!=null&&w.transformCoordinate(u,s.matrix,u)}s._positionCount+=o,s._indicesCount+=l},s.flush=function(){s._positionCount=0,s._indicesCount=0},s._growthIndexMemory=function(e){var r=s._indices,a=s._indicesCount+e;if(a>r.length){var o=s._supportUint32Array?4294967295:65535;if(a>o)throw Error("The vertex count is over limit.");var l=s._supportUint32Array?new Uint32Array(a):new Uint16Array(a);l.set(r),s._indices=l}},s._growthPosition=function(e){var r=s._positions,a=s._positionCount+e;if(a>r.length)for(var o=0,l=a-r.length;o<l;o++)r.push(new w)},os(s,[{key:"color",set:function(e){this._material.baseColor.copyFrom(e)}}]),s}(Jt);Aa._positions=[];Aa._positionCount=0;Aa._indicesCount=0;Aa.matrix=null;Aa=Hc([An(Rt,Ur.CheckOnly)],Aa);var Yl;(function(n){n[n.X=0]="X",n[n.Y=1]="Y",n[n.Z=2]="Z"})(Yl||(Yl={}));ne.create("skeleton-viewer",`
  attribute vec3 POSITION;
  attribute vec3 NORMAL;

  uniform mat4 renderer_MVPMat;
  uniform mat4 renderer_NormalMat;

  varying vec3 v_normal;

  void main(){
      gl_Position = renderer_MVPMat * vec4( POSITION , 1.0 );;
      v_normal = normalize( mat3(renderer_NormalMat) * NORMAL );
  }`,`
      uniform vec3 u_colorMin;
      uniform vec3 u_colorMax;
      varying vec3 v_normal;

      void main(){
        float ndl = dot(v_normal, vec3(0, 1, 0)) * 0.5 + 0.5;
        vec3 diffuse = mix(u_colorMin, u_colorMax, ndl);
        gl_FragColor = vec4(diffuse, 1.0);
      }
      `);var Ql;(function(n){n[n.Round=0]="Round",n[n.Butt=1]="Butt",n[n.Square=2]="Square"})(Ql||(Ql={}));var Kl;(function(n){n[n.Miter=0]="Miter",n[n.Round=1]="Round",n[n.Bevel=2]="Bevel"})(Kl||(Kl={}));function Xc(n){this.message=n}Xc.prototype=new Error;Xc.prototype.name="InvalidCharacterError";var df=`
attribute vec2 a_pos;
attribute vec2 a_normal;
attribute vec2 a_data;

uniform mat4 renderer_MVPMat;
uniform float u_width;

varying vec2 v_origin;
varying vec2 v_position;
varying float v_direction;
varying float v_part;

void main() {
    v_direction = a_data.x;
    v_part = a_data.y;
    float layer_index = 1.0;

    v_origin = a_pos;
    vec2 position = a_pos + a_normal * u_width;
    v_position = position;
    gl_Position = renderer_MVPMat * vec4(position, 0.0, 1);
}
  `,hf=`
precision highp float;

uniform vec4 u_color;
uniform int u_join;
uniform int u_cap;
uniform float u_width;

varying vec2 v_origin;
varying vec2 v_position;
varying float v_direction;
varying float v_part;

float IS_CAP = 0.0;

void main() {
    vec4 finalColor;
    if (u_cap == 0 && v_part == IS_CAP) {
      if (distance(v_position, v_origin) > u_width) {
        discard;
      }
    }
    if (u_join == 1 && v_part > 1.0) {
      if (distance(v_position, v_origin) > u_width) {
        discard;
      }
    }

    gl_FragColor = u_color;
}

  `;ne.create("line",df,hf);var ff=`
attribute vec2 a_pos;
attribute vec2 a_normal;
attribute vec2 a_data;
attribute float a_lengthsofar;

uniform mat4 renderer_MVPMat;
uniform float u_width;
uniform vec2 u_dash;

varying vec2 v_origin;
varying vec2 v_position;
varying float v_direction;
varying float v_part;
varying vec2 v_tex;

void main() {
    v_direction = a_data.x;
    v_part = a_data.y;
    float layer_index = 1.0;


    v_origin = a_pos;

    float texcoord_y = 0.0;

    texcoord_y = a_lengthsofar / (u_dash.x + u_dash.y);
    if (v_direction == 1.0) {
        v_tex = vec2(1.0, texcoord_y);
    } else {
        v_tex = vec2(0.0, texcoord_y);
    }
    vec2 position = a_pos + a_normal * u_width;
    v_position = position;
    gl_Position = renderer_MVPMat * vec4(position, 0.0, 1);
}
  `,vf=`
precision highp float;

uniform vec4 u_color;
uniform int u_join;
uniform int u_cap;
uniform float u_width;
uniform sampler2D u_texture;

varying vec2 v_origin;
varying vec2 v_position;
varying float v_direction;
varying float v_part;
varying vec2 v_tex;

float IS_CAP = 0.0;

void main() {
    vec4 finalColor;
    if (u_cap == 0 && v_part == IS_CAP) {
      if (distance(v_position, v_origin) > u_width) {
        discard;
      }
    }
    if (u_join == 1 && v_part > 1.5) {
      if (distance(v_position, v_origin) > u_width) {
        discard;
      }
    }
    vec4 textureColor = texture2D(u_texture, v_tex);
    if (textureColor.a <= 0.5) {
      gl_FragColor = vec4(u_color.rgb, 0.0);
    } else {
      gl_FragColor = u_color;
    }
}
`;ne.create("dash",ff,vf);var Jl;(function(n){n[n.Pivot=0]="Pivot",n[n.Center=1]="Center"})(Jl||(Jl={}));var Zl;(function(n){n[n.Local=0]="Local",n[n.Global=1]="Global"})(Zl||(Zl={}));var $l;(function(n){n[n.None=0]="None",n[n.AnchorDirty=1]="AnchorDirty",n[n.CoordinateDirty=2]="CoordinateDirty",n[n.All=3]="All"})($l||($l={}));new w;new J;new J;new nr;var ec;(function(n){n[n.translate=1]="translate",n[n.rotate=2]="rotate",n[n.scale=4]="scale",n[n.all=15]="all"})(ec||(ec={}));var tc;(function(n){n[n.Circle=0]="Circle",n[n.Line=1]="Line",n[n.CircleTube=2]="CircleTube"})(tc||(tc={}));new ye;new w;var rc;(function(n){n[n.x=0]="x",n[n.y=1]="y",n[n.z=2]="z",n[n.xyz=3]="xyz",n[n.xy=4]="xy",n[n.yz=5]="yz",n[n.xz=6]="xz"})(rc||(rc={}));new w(1,0,0),new w(0,1,0),new w(0,0,1),new w(1,1,1),new w(1,1,0),new w(0,1,1),new w(1,0,1);new Ge(new w(1,0,0),0),new Ge(new w(0,1,0),0),new Ge(new w(0,0,1),0),new Ge(new w(0,0,0),0),new Ge(new w(0,0,1),0),new Ge(new w(1,0,0),0),new Ge(new w(0,1,0),0);function nc(n,s){for(var i=0;i<s.length;i++){var t=s[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function pf(n,s,i){return s&&nc(n.prototype,s),i&&nc(n,i),n}function Oo(n,s){return Oo=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},Oo(n,s)}function gf(n,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(s&&s.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),s&&Oo(n,s)}function mf(n,s,i,t){var e=arguments.length,r=e<3?s:t===null?t=Object.getOwnPropertyDescriptor(s,i):t,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(n,s,i,t);else for(var o=n.length-1;o>=0;o--)(a=n[o])&&(r=(e<3?a(r):e>3?a(s,i,r):a(s,i))||r);return e>3&&r&&Object.defineProperty(s,i,r),r}var yf=`#define GLSLIFY 1
uniform vec3 material_OutlineColor;uniform sampler2D material_OutlineTexture;uniform vec2 material_TexSize;varying vec2 v_uv;float luminance(vec4 color){return 0.2125*color.r+0.7154*color.g+0.0721*color.b;}float sobel(){float Gx[9];Gx[0]=-1.0;Gx[1]=0.0;Gx[2]=1.0;Gx[3]=-2.0;Gx[4]=0.0;Gx[5]=2.0;Gx[6]=-1.0;Gx[7]=0.0;Gx[8]=1.0;float Gy[9];Gy[0]=-1.0;Gy[1]=-2.0;Gy[2]=-1.0;Gy[3]=0.0;Gy[4]=0.0;Gy[5]=0.0;Gy[6]=1.0;Gy[7]=2.0;Gy[8]=1.0;float texColor;float edgeX=0.0;float edgeY=0.0;vec2 uv[9];uv[0]=v_uv+material_TexSize.xy*vec2(-1,-1);uv[1]=v_uv+material_TexSize.xy*vec2(0,-1);uv[2]=v_uv+material_TexSize.xy*vec2(1,-1);uv[3]=v_uv+material_TexSize.xy*vec2(-1,0);uv[4]=v_uv+material_TexSize.xy*vec2(0,0);uv[5]=v_uv+material_TexSize.xy*vec2(1,0);uv[6]=v_uv+material_TexSize.xy*vec2(-1,1);uv[7]=v_uv+material_TexSize.xy*vec2(0,1);uv[8]=v_uv+material_TexSize.xy*vec2(1,1);for(int i=0;i<9;i++){texColor=luminance(texture2D(material_OutlineTexture,uv[i]));edgeX+=texColor*Gx[i];edgeY+=texColor*Gy[i];}return abs(edgeX)+abs(edgeY);}vec4 linearToGamma(vec4 linearIn){return vec4(pow(linearIn.rgb,vec3(1.0/2.2)),linearIn.a);}void main(){float sobelFactor=step(1.0,sobel());gl_FragColor=mix(vec4(0),vec4(material_OutlineColor,1.0),sobelFactor);
#ifndef ENGINE_IS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
}`,xf=`#define GLSLIFY 1
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=vec4(POSITION.xzy,1.0);gl_Position.y*=-1.0;v_uv=TEXCOORD_0;}`,bf=`#define GLSLIFY 1
uniform vec4 camera_OutlineReplaceColor;void main(){gl_FragColor=camera_OutlineReplaceColor;}`,Cf=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <position_vert>
}`,wa=function(n){gf(s,n);function s(t){var e;e=n.call(this,t)||this,e.isChildrenIncluded=!1,e._size=1,e._clearColor=new j(1,1,1,1),e._replaceColor=new j(1,0,0,1),e._outlineMainColor=new j(.95,.35,.14,1),e._outlineSubColor=new j(.16,.67,.89,1),e._layer=mn.Layer29,e._outlineEntities=[],e._subLineEntities=[],e._renderers=[],e._layerMap=[],e._cameraViewport=new ae,e._outLineViewport=new ae(0,0,1,1);var r=e.engine,a=new ke(r,ne.find("outline-postprocess-shader")),o=ne.find("outline-replace-shader"),l=e.entity.createChild("screen"),c=l.addComponent(Rt);return c.receiveShadows=!1,c.castShadows=!1,l.layer=e._layer,l.isActive=!1,c.mesh=it.createPlane(r,2,2),c.setMaterial(a),a.isTransparent=!0,e._outlineMaterial=a,e._replaceShader=o,e._screenEntity=l,e.size=e._size,e}var i=s.prototype;return i.clear=function(){this._outlineEntities.length=0},i.addEntity=function(e){this._outlineEntities.indexOf(e)===-1&&(this._outlineEntities.push(e),this.isChildrenIncluded&&this._calSublineEntites())},i.removeEntity=function(e){var r=this._outlineEntities.indexOf(e),a=this._outlineEntities.length;r>-1&&(r<a-1&&(this._outlineEntities[r]=this._outlineEntities[a-1]),this._outlineEntities.length--,this.isChildrenIncluded&&this._calSublineEntites())},i.onEndRender=function(e){var r=this._outlineEntities;!r.length||(this._renderEntity(e,this.subColor,this._subLineEntities),this._renderEntity(e,this.mainColor,r))},i.onDestroy=function(){this._renderTarget.getColorTexture().destroy(!0),this._renderTarget.destroy(),this._screenEntity.destroy(),this._outlineEntities=null,this._renderers=null,this._layerMap=null},i._renderEntity=function(e,r,a){var o=e.scene,l=e.clearFlags,c=e.cullingMask,_=e.enableFrustumCulling,u=o.background.solidColor,d=o.background.mode,h=this._renderers,f=this._layerMap;f.length=0;for(var v=a.length-1;v>=0;v--){var p=a[v];h.length=0,p.getComponents(Rt,h),h.length&&(f.push({entity:p,layer:p.layer}),p.layer=this._layer)}this._screenEntity.isActive=!1,e.renderTarget=this._renderTarget,o.background.solidColor=this._clearColor,o.background.mode=$r.SolidColor,e.cullingMask=this._layer,e.setReplacementShader(this._replaceShader),e.shaderData.setColor(s._replaceColorProp,this._replaceColor),e.render(),this._cameraViewport.copyFrom(e.viewport),this._screenEntity.isActive=!0,e.renderTarget=null,e.viewport=this._outLineViewport,e.clearFlags=Lt.None,e.enableFrustumCulling=!1,e.resetReplacementShader();for(var g=f.length-1;g>=0;g--){var y=f[g],m=y.entity,x=y.layer;m.layer=x}this._outlineMaterial.shaderData.setColor(s._outlineColorProp,r),e.render(),this._screenEntity.isActive=!1,e.clearFlags=l,e.enableFrustumCulling=_,e.cullingMask=c,e.viewport=this._cameraViewport,o.background.solidColor=u,o.background.mode=d},i._calSublineEntites=function(){var e=this;this._subLineEntities.length=0;for(var r=0;r<this._outlineEntities.length;r++)s._traverseEntity(this._outlineEntities[r],function(a){e._subLineEntities.push(a)})},s._traverseEntity=function(e,r){r(e);for(var a=e.children.length-1;a>=0;a--)this._traverseEntity(e.children[a],r)},pf(s,[{key:"layer",get:function(){return this.layer},set:function(e){this._layer=e}},{key:"mainColor",get:function(){return this._outlineMainColor},set:function(e){var r=this._outlineMainColor;e!==r&&r.copyFrom(e)}},{key:"subColor",get:function(){return this._outlineSubColor},set:function(e){var r=this._outlineSubColor;e!==r&&r.copyFrom(e)}},{key:"size",get:function(){return this._size},set:function(e){e=Math.max(1,Math.min(e,6)),this._size=e,this._renderTarget&&(this._renderTarget.getColorTexture().destroy(!0),this._renderTarget.destroy());var r=this.engine.canvas,a=r.width,o=r.height,l=a/e,c=o/e,_=new bt(this.engine,l,c),u=new ea(this.engine,l,c,_);this._outlineMaterial.shaderData.setTexture(s._outlineTextureProp,_),this._outlineMaterial.shaderData.setVector2(s._texSizeProp,new $(1/l,1/c)),_.wrapModeU=_.wrapModeV=yt.Clamp,this._renderTarget=u}}]),s}(Jt);wa._outlineColorProp=L.getByName("material_OutlineColor");wa._outlineTextureProp=L.getByName("material_OutlineTexture");wa._texSizeProp=L.getByName("material_TexSize");wa._replaceColorProp=L.getByName("camera_OutlineReplaceColor");wa=mf([An(Ne,Ur.CheckOnly)],wa);ne.create("outline-postprocess-shader",xf,yf);ne.create("outline-replace-shader",Cf,bf);new w;new ye;new $;new w;new w;new J;new w;var ac;(function(n){n[n.Wireframe=0]="Wireframe",n[n.Normal=1]="Normal",n[n.Tangent=2]="Tangent",n[n.BiTangent=3]="BiTangent"})(ac||(ac={}));var jc=`
   uniform sampler2D u_verticesSampler;
   uniform float u_verticesTextureWidth;
   uniform float u_verticesTextureHeight;
   
   uniform sampler2D u_indicesSampler;
   uniform float u_indicesTextureWidth;
   uniform float u_indicesTextureHeight;
   
   vec4 getVertexElement(float row, float col) {
        return texture2D(u_verticesSampler, vec2((col + 0.5) / u_verticesTextureWidth, (row + 0.5) / u_verticesTextureHeight));
   }
   
   vec3 getIndicesElement(float row, float col) {
        return texture2D(u_indicesSampler, vec2((col + 0.5) / u_indicesTextureWidth, (row + 0.5) / u_indicesTextureHeight )).xyz;
   }
   
   vec2 getVec2(inout vec4[ELEMENT_COUNT] rows, inout int row_index, inout int value_index) {
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float x = rows[row_index][value_index];
        
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float y = rows[row_index][value_index];
        
        return vec2(x, y);
   }
   
   vec3 getVec3(inout vec4[ELEMENT_COUNT] rows, inout int row_index, inout int value_index) {
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float x = rows[row_index][value_index];
        
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float y = rows[row_index][value_index];
        
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float z = rows[row_index][value_index];
        return vec3(x, y, z);
   }
   
   vec4 getVec4(inout vec4[ELEMENT_COUNT] rows, inout int row_index, inout int value_index) {
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float x = rows[row_index][value_index];
        
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float y = rows[row_index][value_index];
        
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float z = rows[row_index][value_index];
        
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float w = rows[row_index][value_index];
        return vec4(x, y, z, w);
   }
`,qc=`
        int row = pointIndex * ELEMENT_COUNT / int(u_verticesTextureWidth);
        int col = pointIndex * ELEMENT_COUNT % int(u_verticesTextureWidth);
        
        vec4 rows[ELEMENT_COUNT];
        for( int i = 0; i < ELEMENT_COUNT; i++ ) {
            rows[i] = getVertexElement(float(row), float(col + i));
        }
        
        vec3 POSITION = vec3(rows[0].x, rows[0].y, rows[0].z);        
        int row_index = 0;
        int value_index = 2;
#ifdef RENDERER_HAS_NORMAL 
        vec3 NORMAL = getVec3(rows, row_index, value_index);
#endif

#ifdef RENDERER_HAS_VERTEXCOLOR
        vec4 COLOR_0 = getVec4(rows, row_index, value_index);
#endif

#ifdef RENDERER_HAS_WEIGHT
        vec4 WEIGHTS_0 = getVec4(rows, row_index, value_index);
#endif

#ifdef RENDERER_HAS_JOINT
        vec4 JOINTS_0 = getVec4(rows, row_index, value_index);
#endif

#ifdef RENDERER_HAS_TANGENT
        vec4 TANGENT = getVec4(rows, row_index, value_index);
#endif

#ifdef RENDERER_HAS_UV
        vec2 TEXCOORD_0 = getVec2(rows, row_index, value_index);
#endif
`;ne.create("tbnShader",`
#include <common>
   uniform float u_lineScale;
   uniform mat4 camera_VPMat;
   uniform mat4 u_worldMatrix;
   uniform mat4 u_worldNormal;

#ifdef RENDERER_HAS_SKIN
#ifdef RENDERER_USE_JOINT_TEXTURE
    uniform sampler2D renderer_JointSampler;
    uniform float renderer_JointCount;

    mat4 getJointMatrix(sampler2D smp, float index) {
        float base = index / renderer_JointCount;
        float hf = 0.5 / renderer_JointCount;
        float v = base + hf;

        vec4 m0 = texture2D(smp, vec2(0.125, v ));
        vec4 m1 = texture2D(smp, vec2(0.375, v ));
        vec4 m2 = texture2D(smp, vec2(0.625, v ));
        vec4 m3 = texture2D(smp, vec2(0.875, v ));

        return mat4(m0, m1, m2, m3);
    }
#else
    uniform mat4 renderer_JointMatrix[ RENDERER_JOINTS_NUM ];
#endif
#endif

`+jc+`

void main() {
    int pointIndex = gl_VertexID / 2;
    `+qc+`

    #include <begin_position_vert>
    #include <begin_normal_vert>
    #include <skinning_vert>

    gl_Position = u_worldMatrix * position; 
    
#if defined(SHOW_NORMAL) && defined(RENDERER_HAS_NORMAL)
    if (gl_VertexID % 2 == 1) {
        vec3 normalW = normalize( mat3(u_worldNormal) * normal.xyz );
        gl_Position.xyz += normalize(normalW) * u_lineScale;
    }
#endif

#if defined(SHOW_TANGENT) && defined(RENDERER_HAS_TANGENT)
    if (gl_VertexID % 2 == 1) {
        vec3 tangentW = normalize( mat3(u_worldNormal) * tangent.xyz );
        gl_Position.xyz += normalize(tangentW) * u_lineScale;
    }
#endif

#if defined(SHOW_BITANGENT) && defined(RENDERER_HAS_TANGENT) && defined(RENDERER_HAS_NORMAL)
    if (gl_VertexID % 2 == 1) {
        vec3 normalW = normalize( mat3(u_worldNormal) * normal.xyz );
        vec3 tangentW = normalize( mat3(u_worldNormal) * tangent.xyz );
        vec3 bitangentW = cross( normalW, tangentW ) * tangent.w;
        gl_Position.xyz += normalize(bitangentW) * u_lineScale;
    }
#endif
    
    gl_Position = camera_VPMat * gl_Position; 
}
`,`
uniform vec4 material_BaseColor;
void main() {
    gl_FragColor = material_BaseColor;
}
`);ne.create("wireframeShader",`
#include <common>
   uniform float u_lineScale;
   uniform mat4 camera_VPMat;
   uniform mat4 u_worldMatrix;
   uniform mat4 u_worldNormal;

#ifdef RENDERER_HAS_SKIN
#ifdef RENDERER_USE_JOINT_TEXTURE
    uniform sampler2D renderer_JointSampler;
    uniform float renderer_JointCount;

    mat4 getJointMatrix(sampler2D smp, float index) {
        float base = index / renderer_JointCount;
        float hf = 0.5 / renderer_JointCount;
        float v = base + hf;

        vec4 m0 = texture2D(smp, vec2(0.125, v ));
        vec4 m1 = texture2D(smp, vec2(0.375, v ));
        vec4 m2 = texture2D(smp, vec2(0.625, v ));
        vec4 m3 = texture2D(smp, vec2(0.875, v ));

        return mat4(m0, m1, m2, m3);
    }
#else
    uniform mat4 renderer_JointMatrix[ RENDERER_JOINTS_NUM ];
#endif
#endif

`+jc+`

varying vec3 v_baryCenter;

void main() {
    int indicesIndex = gl_VertexID / 3;
    int indicesRow = indicesIndex / int(u_indicesTextureWidth);
    int indicesCol = indicesIndex % int(u_indicesTextureWidth);
    vec3 triangleIndices = getIndicesElement(float(indicesRow), float(indicesCol));
    int subIndex = gl_VertexID % 3;
    v_baryCenter = vec3(0.0);
    v_baryCenter[subIndex] = 1.0;
    
    int pointIndex = int(triangleIndices[subIndex]);
    `+qc+`

    #include <begin_position_vert>
    #include <begin_normal_vert>
    #include <skinning_vert>
    
    gl_Position = u_worldMatrix * position; 
    gl_Position = camera_VPMat * gl_Position; 
}
`,`
varying vec3 v_baryCenter;

float edgeFactor(){
    vec3 d = fwidth(v_baryCenter);
    vec3 a3 = smoothstep(vec3(0.0), d * 1.5, v_baryCenter);
    return min(min(a3.x, a3.y), a3.z);
}

uniform vec4 material_BaseColor;
void main() {
    if (gl_FrontFacing) {
        gl_FragColor = vec4(material_BaseColor.xyz, 1.0 - edgeFactor());
    } else {
        // fade back face
        gl_FragColor = vec4(material_BaseColor.xyz, (1.0 - edgeFactor()) * 0.3);
    }
}
`);ie.getByName("RENDERER_HAS_WEIGHT");ie.getByName("RENDERER_HAS_JOINT");L.getByName("u_verticesSampler");L.getByName("u_verticesTextureHeight");L.getByName("u_verticesTextureWidth");L.getByName("u_indicesSampler");L.getByName("u_indicesTextureHeight");L.getByName("u_indicesTextureWidth");L.getByName("u_lineScale");L.getByName("u_worldMatrix");L.getByName("u_worldNormal");var Sf="1.2.0-beta.3";console.log("galacean engine toolkit version: "+Sf);export{Fe as A,$r as B,Ne as C,bn as D,ve as L,Rt as M,it as P,ye as Q,Ra as S,w as V,Af as W,Jr as a,ta as b,qe as c,Gl as d,ra as e,Wl as f,is as g,Jt as h,nn as i,xn as j,mn as k,ed as l,Qu as m,qo as n,Kt as o};
